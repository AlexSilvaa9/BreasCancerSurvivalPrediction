<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.550">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Breast Cancer Survival Prediction</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="actividad3_files/libs/clipboard/clipboard.min.js"></script>
<script src="actividad3_files/libs/quarto-html/quarto.js"></script>
<script src="actividad3_files/libs/quarto-html/popper.min.js"></script>
<script src="actividad3_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="actividad3_files/libs/quarto-html/anchor.min.js"></script>
<link href="actividad3_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="actividad3_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="actividad3_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="actividad3_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="actividad3_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="actividad3_files/libs/kePrint-0.0.1/kePrint.js"></script>
<link href="actividad3_files/libs/lightable-0.0.1/lightable.css" rel="stylesheet">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Breast Cancer Survival Prediction</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div style="display:inline-block;">
<p><link href="https://cdn-icons-png.flaticon.com/128/3916/3916763.png" rel="icon"></p>
<h6 style="text-align:center" class="anchored">
<p>Alejandro Silva Rodriguez</p>
</h6>
<div style="text-align:center">
<p><a href="https://alexsilvaa9.github.io" title="Visit my Portfolio" target="_blank" class="btn btn-light" style="margin: 10px; padding: 7;"> <img src="https://cdn-icons-png.flaticon.com/512/10013/10013417.png" alt="LinkedIn" class="icon-link" width="30" height="30"> </a> <a href="https://github.com/AlexSilvaa9" title="Viisit my GitHub" target="_blank" class="btn btn-light" style="margin: 10px; padding: 7;"> <img src="https://cdn-icons-png.flaticon.com/512/25/25231.png" alt="GitHub" class="icon-link" width="25" height="25"> </a> <a href="https://www.linkedin.com/in/alejandro-silva-rodr%C3%ADguez-133293257/" title="Visit my LinkedIn" target="_blank" class="btn btn-light" style="margin: 10px; padding: 7;"> <img src="https://cdn-icons-png.flaticon.com/512/61/61109.png" alt="LinkedIn" class="icon-link" width="25" height="25"> </a></p>
</div>
</div>
<style>
  
    .fullcontent{
      background-color: rgb(226, 231, 236);
      text-align: justify;  
    }
   
    p{
    color:black;
    margin: 0;
    padding: 0;
    }
    .icon-link {
        text-aling:center;
    }

    .icon-link:hover {
        opacity: 0.4;
    }
    a {
        text-decoration: none;
    }
    a:hover {
        text-decoration: none;
    }
 
/* Hacer que los encabezados h1 y h2 sean sticky */
h1 {
  position: -webkit-sticky; 
  position: sticky;
  top: 20px;
  display:inline-block;
 

  z-index: 1000; /* Z-index para asegurar que los encabezados sean visibles */
  padding: 10px; /* Espacio interior alrededor del encabezado */
}


</style>

<script>
  window.onscroll = function() {
    scrollFunction();
  };

  function scrollFunction() {
    if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
      document.getElementById("scrollToTopContainer").style.display = "block";
    } else {
      document.getElementById("scrollToTopContainer").style.display = "none";
    }
  }

  function goToTop() {
    document.body.scrollTop = 0;
    document.documentElement.scrollTop = 0;
  }
</script>
<section id="index" class="level1 index">
<h1>Index</h1>
<ul>
<li><a href="#introduction">1. Introduction</a></li>
<li><a href="#data-cleaning">2. Data Cleaning</a></li>
<li><a href="#statistic-analysis">3. Statistic Analysis</a></li>
<li><a href="#variable-selection">4. Variable selection</a></li>
<li><a href="#models">5. Models</a></li>
<li><a href="#models-comparison">6. Models comparison</a></li>
<li><a href="#final-model">7, Final Model</a></li>
<li><a href="#deployment">8. Deployment</a></li>
<li><a href="#conclusions">9. Conclusions</a></li>
</ul>
</section>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">fig.align   =</span> <span class="st">'center'</span>, <span class="co"># how to align graphics in the final doc. 'left', 'right', 'center'</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">warning     =</span> <span class="cn">FALSE</span>)    <span class="co"># if FALSE knitr will not display any warning messages in the final document</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>The aim of this report is to develop a predictive model to estimate the survival of breast cancer patients. This feature can boost the efficiency of oncology treatments and drastically improve the wellbeing of patients. Using a dataset including both clinical and demographic data, we are going to analyze the relations between the variables in order to build a valuable predictor. On top of that, we are going to carry out a model comparison to select the most accurate one and deploy it in a Shiny app.</p>
</section>
<section id="methodology" class="level1">
<h1>Methodology</h1>
<p>This study aims to develop predictive models for breast cancer. The dataset includes 500 patients with variables such as age at diagnosis, date at diagnosis, menopausal status, type of surgery, histology, tumor size, grade, ER, PR, HER2, Ki67, IHC phenotype, lymph nodes, stage, and current status.</p>
<p>The methodology involves:</p>
<ol type="1">
<li><p><strong>Data Preprocessing:</strong> Exploratory data analysis will be conducted to understand data distributions and identify outliers. Missing data will be handled through imputation techniques.</p></li>
<li><p><strong>Model Development:</strong> Various machine learning algorithms such as logistic regression, decision trees, random forests will be employed to develop predictive models. Feature engineering and selection techniques will be utilized to improve model performance.</p></li>
<li><p><strong>Model Evaluation:</strong> The models will be evaluated using 5x2 cross-validation to ensure robustness and generalizability. Performance metrics such as AUC-ROC, precision, recall, and F1-score will be used to assess model performance.</p></li>
<li><p><strong>Variable Selection:</strong> Different variable selection methods including filtering, wrapper, and embedded methods will be explored to identify the most important predictors for the event of interest.</p></li>
<li><p><strong>Model Comparison:</strong> The performance of different models will be compared based on evaluation metrics to select the best-performing model.</p></li>
<li><p><strong>Deployment:</strong> The final selected model will be deployed in an application framework for practical use.</p></li>
</ol>
<section id="dataset-description" class="level5">
<h5 class="anchored" data-anchor-id="dataset-description">Dataset description:</h5>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create data for the table</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear los datos para la tabla</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>column <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"EDAD_DCO"</span>, <span class="st">"F.DIAG"</span>, <span class="st">"MENOP"</span>, <span class="st">"CIRUGIA"</span>, <span class="st">"HISTOLOGIA"</span>, <span class="st">"TAM"</span>, </span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>            <span class="st">"GRADO"</span>, <span class="st">"RE"</span>, <span class="st">"RP"</span>, <span class="st">"HER2"</span>, <span class="st">"KI67"</span>, <span class="st">"FENOTIPO"</span>, <span class="st">"GANGLIOS"</span>, <span class="st">"ESTADIO"</span>, <span class="st">"ESTADO_ACTUAL"</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>description <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Patient age at diagnosis in years"</span>,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"Date of diagnosis"</span>,</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"Menopausal status"</span>,</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"Surgery type"</span>,</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"Histology type"</span>,</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"Tumor size (cm)"</span>,</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"Tumor grade (1 to 3)"</span>,</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"Estrogen receptors percentage"</span>,</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"Progesterone receptors percentage"</span>,</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"Her2 expression (Positive/Negative)"</span>,</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"Ki-67 index (percentage)"</span>,</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"Phenotype determined by PAM50"</span>,</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"Number of affected lymph nodes"</span>,</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"Disease stage (from T1 to T4)"</span>,</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"Current status of the patient"</span>)</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear el dataframe</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>datos <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Column =</span> column, <span class="at">Description =</span> description)</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Generar la tabla HTML con kable y aplicar estilos con kableExtra</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>styled_table <span class="ot">&lt;-</span> datos <span class="sc">%&gt;%</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">format =</span> <span class="st">"html"</span>, <span class="at">align =</span> <span class="st">"c"</span>, <span class="at">caption =</span> <span class="st">"Dataset Description"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>, <span class="st">"condensed"</span>, <span class="st">"responsive"</span>), <span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir la tabla estilizada</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(styled_table)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<table class="table table-striped table-hover table-condensed table-responsive" style="width: auto !important; margin-left: auto; margin-right: auto;">
<caption>
Dataset Description
</caption>
<thead>
<tr>
<th style="text-align:center;">
Column
</th>
<th style="text-align:center;">
Description
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center;">
EDAD_DCO
</td>
<td style="text-align:center;">
Patient age at diagnosis in years
</td>
</tr>
<tr>
<td style="text-align:center;">
F.DIAG
</td>
<td style="text-align:center;">
Date of diagnosis
</td>
</tr>
<tr>
<td style="text-align:center;">
MENOP
</td>
<td style="text-align:center;">
Menopausal status
</td>
</tr>
<tr>
<td style="text-align:center;">
CIRUGIA
</td>
<td style="text-align:center;">
Surgery type
</td>
</tr>
<tr>
<td style="text-align:center;">
HISTOLOGIA
</td>
<td style="text-align:center;">
Histology type
</td>
</tr>
<tr>
<td style="text-align:center;">
TAM
</td>
<td style="text-align:center;">
Tumor size (cm)
</td>
</tr>
<tr>
<td style="text-align:center;">
GRADO
</td>
<td style="text-align:center;">
Tumor grade (1 to 3)
</td>
</tr>
<tr>
<td style="text-align:center;">
RE
</td>
<td style="text-align:center;">
Estrogen receptors percentage
</td>
</tr>
<tr>
<td style="text-align:center;">
RP
</td>
<td style="text-align:center;">
Progesterone receptors percentage
</td>
</tr>
<tr>
<td style="text-align:center;">
HER2
</td>
<td style="text-align:center;">
Her2 expression (Positive/Negative)
</td>
</tr>
<tr>
<td style="text-align:center;">
KI67
</td>
<td style="text-align:center;">
Ki-67 index (percentage)
</td>
</tr>
<tr>
<td style="text-align:center;">
FENOTIPO
</td>
<td style="text-align:center;">
Phenotype determined by PAM50
</td>
</tr>
<tr>
<td style="text-align:center;">
GANGLIOS
</td>
<td style="text-align:center;">
Number of affected lymph nodes
</td>
</tr>
<tr>
<td style="text-align:center;">
ESTADIO
</td>
<td style="text-align:center;">
Disease stage (from T1 to T4)
</td>
</tr>
<tr>
<td style="text-align:center;">
ESTADO_ACTUAL
</td>
<td style="text-align:center;">
Current status of the patient
</td>
</tr>
</tbody>
</table>
</div>
</section>
</section>
<section id="data-cleaning" class="level1">
<h1>Data Cleaning</h1>
<p>The first step is to import and clean the data.</p>
<p>Some of the most important data transformation are:</p>
<p><br></p>
<section id="age-at-diagnosis-stratification-edad_dco" class="level4">
<h4 class="anchored" data-anchor-id="age-at-diagnosis-stratification-edad_dco">Age at diagnosis stratification (EDAD_DCO)</h4>
<p>The age at diagnosis variable is stratified into different age cohorts to reflect distinct clinical and pathological differences observed across age groups. This detailed age stratification allows for a more accurate analysis of prognosis and treatment outcomes, highlighting the need for tailored treatment strategies based on age.</p>
<p>In a study by Jackson, E. B., Gondara, L., Speers, C.(2023) 24,469 breast cancer patients were stratified into age cohorts: &lt;35, 35–39, 40–49, 50–59, 60–69, 70–79, and ≥80. This stratification was chosen to reflect distinct clinical and pathological differences observed across age groups. Younger patients (&lt;40) typically present with more aggressive disease and require more intensive treatments, while elderly patients (≥80) often have less aggressive, hormone-sensitive cancers and receive less aggressive treatments. This detailed age stratification allowed for a more accurate analysis of prognosis and treatment outcomes, highlighting the need for tailored treatment strategies based on age.</p>
<p><br></p>
<p>This stratification is common in scientific studies and clinical practice, as it provides valuable insights into the impact of age on breast cancer prognosis and treatment outcomes. We are going to modify the stratification, setting the following age groups: 0-39, 40-49, 50-59, 60-69, 70-79, and ≥80 because of the fact that the dataset is not big enough to have a more detailed stratification.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Importamos los datos</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(<span class="st">"exam_dataset_23.xlsx"</span>, <span class="at">sheet =</span> <span class="dv">1</span>) <span class="co"># Lee la primera hoja</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>EDAD_DCO <span class="ot">&lt;-</span> <span class="fu">cut</span>(data<span class="sc">$</span>EDAD_DCO, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="cn">Inf</span>, <span class="dv">39</span>, <span class="dv">49</span>, <span class="dv">59</span>,<span class="dv">69</span>,<span class="dv">79</span>, <span class="cn">Inf</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"0-39"</span>, <span class="st">"40-49"</span>, <span class="st">"50-59"</span>, <span class="st">"60-69"</span>,<span class="st">"70-79"</span>,<span class="st">"≥80"</span>))</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>EDAD_DCO <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(data<span class="sc">$</span>EDAD_DCO)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co"># F.diag codificado por decadas solo hay dos</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">F.DIAG =</span> <span class="fu">cut</span>(<span class="fu">year</span>(F.DIAG), </span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>                      <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">2000</span>, <span class="dv">2020</span>, <span class="at">by =</span> <span class="dv">10</span>), </span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>                      <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"2000-2009"</span>, <span class="st">"2010-2019"</span>), </span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>                      <span class="at">right =</span> <span class="cn">FALSE</span>))</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>F.DIAG <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(data<span class="sc">$</span>F.DIAG)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>MENOP <span class="ot">&lt;-</span> data<span class="sc">$</span>MENOP <span class="sc">|&gt;</span> <span class="fu">as.factor</span>()</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>CIRUGIA <span class="ot">&lt;-</span> data<span class="sc">$</span>CIRUGIA <span class="sc">|&gt;</span> <span class="fu">as.factor</span>()</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>GRADO <span class="ot">&lt;-</span> data<span class="sc">$</span>GRADO <span class="sc">|&gt;</span> <span class="fu">as.factor</span>()</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>HER2 <span class="ot">&lt;-</span> data<span class="sc">$</span>HER2 <span class="sc">|&gt;</span> <span class="fu">as.factor</span>()</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>ESTADO_ACTUAL <span class="ot">&lt;-</span> data<span class="sc">$</span>ESTADO_ACTUAL <span class="sc">|&gt;</span> <span class="fu">as.factor</span>()</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>ESTADIO <span class="ot">&lt;-</span> data<span class="sc">$</span>ESTADIO <span class="sc">|&gt;</span> <span class="fu">as.factor</span>()</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>FENOTIPO <span class="ot">&lt;-</span> data<span class="sc">$</span>FENOTIPO <span class="sc">|&gt;</span> <span class="fu">as.factor</span>()</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ESTADO_ACTUAL =</span> <span class="fu">fct_recode</span>(ESTADO_ACTUAL,</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">"Exitus"</span> <span class="ot">=</span> <span class="st">"MCE"</span>,</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">"Exitus"</span> <span class="ot">=</span> <span class="st">"MSE"</span>,</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">"Exitus"</span> <span class="ot">=</span> <span class="st">"MXE"</span>,</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">"Vivo"</span> <span class="ot">=</span> <span class="st">"VCE"</span>,</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">"Vivo"</span> <span class="ot">=</span> <span class="st">"VSE"</span>))</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Reagrupar las categorías de ESTADIO en I, II, III, IV</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ESTADIO =</span> <span class="fu">case_when</span>(</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>    ESTADIO <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"I"</span>, <span class="st">"IA"</span>, <span class="st">"IB"</span>) <span class="sc">~</span> <span class="st">"I"</span>,</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>    ESTADIO <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"II"</span>, <span class="st">"IIA"</span>, <span class="st">"IIB"</span>) <span class="sc">~</span> <span class="st">"II"</span>,</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>    ESTADIO <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"III"</span>, <span class="st">"IIIA"</span>, <span class="st">"IIIB"</span>, <span class="st">"IIIC"</span>) <span class="sc">~</span> <span class="st">"III"</span>,</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>    ESTADIO <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"IV"</span>) <span class="sc">~</span> <span class="st">"IV"</span>,</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_character_</span>  <span class="co"># Para manejar cualquier otro valor o NA</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>ESTADIO <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(data<span class="sc">$</span>ESTADIO)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="number-of-affected-lymph-nodes-ganglios" class="level4">
<h4 class="anchored" data-anchor-id="number-of-affected-lymph-nodes-ganglios">Number of affected lymph nodes (GANGLIOS)</h4>
<p>The variable <strong>GANGLIOS (N)</strong> refers to the involvement of lymph nodes, indicating whether cancer has spread to them and, if so, how many are affected. Here’s the interpretation of the different <strong>N</strong> levels according to gepac (2024):</p>
<ul>
<li><strong>N0</strong>: No lymph nodes affected.</li>
<li><strong>N1</strong>: One to three lymph nodes affected.</li>
<li><strong>N2</strong>: Four to nine lymph nodes affected.</li>
<li><strong>N3</strong>: Ten or more lymph nodes affected, or affected nodes that are distant from the breast.</li>
</ul>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>GANGLIOS <span class="ot">&lt;-</span> <span class="fu">cut</span>(data<span class="sc">$</span>GANGLIOS, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="cn">Inf</span>,<span class="dv">0</span>, <span class="dv">3</span>, <span class="dv">9</span>, <span class="cn">Inf</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"N0"</span>,<span class="st">"N1"</span>, <span class="st">"N2"</span>, <span class="st">"N3"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="histology-groups-histologia" class="level4">
<h4 class="anchored" data-anchor-id="histology-groups-histologia">Histology groups (HISTOLOGIA)</h4>
<p>The histology of breast cancer refers to the type of cells that make up the tumor. The most common special histological types of breast cancer include ductal, lobular, and other types such as adenoid, colloid, medullary, mixed, mucinous, papillary, phyllodes, and tubular. Ductal carcinoma in situ (DCIS) and invasive ductal carcinoma (IDC) are the most common types of breast cancer, accounting for the majority of newly diagnosed cases. Nascimento and Otoni (2020)</p>
<p>We are going to group the histological types into three broad categories: ductal, lobular, and other types. This grouping will help simplify the analysis and interpretation of the data.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the broad categories and map existing values to these categories</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>HISTOLOGIA[data<span class="sc">$</span>HISTOLOGIA <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"DCIS"</span>, <span class="st">"DUCTAL"</span>)] <span class="ot">&lt;-</span> <span class="st">"DUCTAL"</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>HISTOLOGIA[data<span class="sc">$</span>HISTOLOGIA <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"LOBULILLAR"</span>)] <span class="ot">&lt;-</span> <span class="st">"LOBULAR"</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>HISTOLOGIA[data<span class="sc">$</span>HISTOLOGIA <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"ADENOIDE"</span>, <span class="st">"COLOIDE"</span>, <span class="st">"MEDULAR"</span>, <span class="st">"MIXTO"</span>, <span class="st">"MUCINOSO"</span>, <span class="st">"PAPILAR"</span>, <span class="st">"PHILOIDES"</span>, <span class="st">"TUBULAR"</span>)] <span class="ot">&lt;-</span> <span class="st">"OTHER"</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>HISTOLOGIA <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(data<span class="sc">$</span>HISTOLOGIA)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="data-imputation-and-normalization" class="level4">
<h4 class="anchored" data-anchor-id="data-imputation-and-normalization">Data imputation and normalization</h4>
<ul>
<li>Numeric variables normalization</li>
</ul>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Select only numeric variables</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>numeric_vars <span class="ot">&lt;-</span> <span class="fu">sapply</span>(data, is.numeric)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>numeric_data <span class="ot">&lt;-</span> data[, numeric_vars]</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Normalize the numeric variables</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>normalized_data <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">scale</span>(numeric_data))</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine normalized numeric variables with non-numeric variables</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">cbind</span>(data[, <span class="sc">!</span>numeric_vars], normalized_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ul>
<li>Numerical variables imputation by mean.</li>
</ul>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify numeric variables</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>numeric_vars <span class="ot">&lt;-</span> <span class="fu">sapply</span>(data, is.numeric)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Impute missing values in numeric variables using the mean</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (var <span class="cf">in</span> <span class="fu">names</span>(data)[numeric_vars]) {</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  mean_value <span class="ot">&lt;-</span> <span class="fu">mean</span>(data[[var]], <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="co"># Calculate the mean excluding NA values</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  data[[var]][<span class="fu">is.na</span>(data[[var]])] <span class="ot">&lt;-</span> mean_value <span class="co"># Replace NA values with the mean</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co"># View the summary of the updated data</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ul>
<li>Impute categorical variables by mode:</li>
</ul>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Función para calcular la moda de un vector</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>Mode <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(<span class="fu">unique</span>(x)) <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">unique</span>(x))</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    tbl <span class="ot">&lt;-</span> <span class="fu">table</span>(x)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">names</span>(tbl)[<span class="fu">which.max</span>(tbl)])</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtener nombres de columnas categóricas</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>columnas_categoricas <span class="ot">&lt;-</span> <span class="fu">sapply</span>(data, is.factor)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Imputación por moda para todas las columnas categóricas con valores perdidos</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>data[columnas_categoricas] <span class="ot">&lt;-</span> <span class="fu">lapply</span>(data[columnas_categoricas], <span class="cf">function</span>(x) {</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>  moda <span class="ot">&lt;-</span> <span class="fu">Mode</span>(x)</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>  x[<span class="fu">is.na</span>(x)] <span class="ot">&lt;-</span> moda</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(x)</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<div class="tabset-margin-container"></div><div class="panel-tabset" style="background-color: #f0f0f0;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true" href="">EDAD_DCO</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false" href="">F,DIAG</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" role="tab" aria-controls="tabset-1-3" aria-selected="false" href="">MENOP</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-4" role="tab" aria-controls="tabset-1-4" aria-selected="false" href="">CIRUGIA</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-5" role="tab" aria-controls="tabset-1-5" aria-selected="false" href="">HISTOLOGIA</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-6-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-6" role="tab" aria-controls="tabset-1-6" aria-selected="false" href="">GRADO</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-7-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-7" role="tab" aria-controls="tabset-1-7" aria-selected="false" href="">HER2</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-8-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-8" role="tab" aria-controls="tabset-1-8" aria-selected="false" href="">FENOTIPO</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-9-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-9" role="tab" aria-controls="tabset-1-9" aria-selected="false" href="">GANGLIOS</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-10-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-10" role="tab" aria-controls="tabset-1-10" aria-selected="false" href="">ESTADIO</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-11-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-11" role="tab" aria-controls="tabset-1-11" aria-selected="false" href="">ESTADO_ACTUAL</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-12-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-12" role="tab" aria-controls="tabset-1-12" aria-selected="false" href="">TAM</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-13-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-13" role="tab" aria-controls="tabset-1-13" aria-selected="false" href="">RE</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-14-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-14" role="tab" aria-controls="tabset-1-14" aria-selected="false" href="">RP</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-15-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-15" role="tab" aria-controls="tabset-1-15" aria-selected="false" href="">KI67</a></li></ul>
<div class="tab-content" style="background-color: #f0f0f0;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(data<span class="sc">$</span>EDAD_DCO)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> 0-39 40-49 50-59 60-69 70-79   ≥80 
   44   107   132   122    55    40 </code></pre>
</div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(data<span class="sc">$</span>F.DIAG)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>2000-2009 2010-2019 
      142       358 </code></pre>
</div>
</div>
</div>
<div id="tabset-1-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-3-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(data<span class="sc">$</span>MENOP)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>POSTMENOPAUSICA  PREMENOPAUSICA 
            320             180 </code></pre>
</div>
</div>
</div>
<div id="tabset-1-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-4-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(data<span class="sc">$</span>CIRUGIA)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>CONSERVADORA      RADICAL 
         366          134 </code></pre>
</div>
</div>
</div>
<div id="tabset-1-5" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-5-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(data<span class="sc">$</span>HISTOLOGIA)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> DUCTAL LOBULAR   OTHER 
    454      18      28 </code></pre>
</div>
</div>
</div>
<div id="tabset-1-6" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-6-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(data<span class="sc">$</span>GRADO)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  1   2   3 
 86 263 151 </code></pre>
</div>
</div>
</div>
<div id="tabset-1-7" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-7-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(data<span class="sc">$</span>HER2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  N   P 
404  96 </code></pre>
</div>
</div>
</div>
<div id="tabset-1-8" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-8-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(data<span class="sc">$</span>FENOTIPO)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>           HER2       LUMINAL A       LUMINAL B    LUMINAL HER2      LUMINAL ND 
             31             122             189              65              48 
TRIPLE NEGATIVO 
             45 </code></pre>
</div>
</div>
</div>
<div id="tabset-1-9" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-9-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(data<span class="sc">$</span>GANGLIOS)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> N0  N1  N2  N3 
321 133  31  15 </code></pre>
</div>
</div>
</div>
<div id="tabset-1-10" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-10-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(data<span class="sc">$</span>ESTADIO)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  I  II III  IV 
183 217  76  24 </code></pre>
</div>
</div>
</div>
<div id="tabset-1-11" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-11-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(data<span class="sc">$</span>ESTADO_ACTUAL)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Exitus   Vivo 
    28    472 </code></pre>
</div>
</div>
</div>
<div id="tabset-1-12" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-12-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(data<span class="sc">$</span>TAM)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
-1.2561 -0.6513 -0.1676  0.0000  0.2709  5.8191 </code></pre>
</div>
</div>
</div>
<div id="tabset-1-13" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-13-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(data<span class="sc">$</span>RE)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
-2.1636  0.0000  0.4819  0.0000  0.5655  0.6212 </code></pre>
</div>
</div>
</div>
<div id="tabset-1-14" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-14-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(data<span class="sc">$</span>RP)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
-1.3517 -1.3261  0.6959  0.0000  0.6959  1.2077 </code></pre>
</div>
</div>
</div>
<div id="tabset-1-15" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-15-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(data<span class="sc">$</span>KI67)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
-1.17307 -0.75101 -0.06037  0.00000  0.32331  2.62544 </code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="statistic-analysis" class="level1">
<h1>Statistic Analysis</h1>
<div class="tabset-margin-container"></div><div class="panel-tabset" style="background-color: #f0f0f0;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" role="tab" aria-controls="tabset-2-1" aria-selected="true" href="">Univariate Analysis</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" role="tab" aria-controls="tabset-2-2" aria-selected="false" href="">Bivariate Analysis</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-3" role="tab" aria-controls="tabset-2-3" aria-selected="false" href="">Association Analysis</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-4" role="tab" aria-controls="tabset-2-4" aria-selected="false" href="">Variable imbalance</a></li></ul>
<div class="tab-content" style="background-color: #f0f0f0;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;">
<div id="tabset-2-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-2-1-tab">
<p>We are going to analyze and visualize every variable so as to understand the behavior of our problem variables.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>columnas <span class="ot">&lt;-</span> <span class="fu">colnames</span>(data)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Aplicar la función 'analsis_univariante_automatico()' a cada columna</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>resultados_univariante <span class="ot">&lt;-</span> <span class="fu">lapply</span>(columnas, <span class="cf">function</span>(col) {</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  an <span class="ot">&lt;-</span> <span class="fu">analsis_univariante_automatico</span>(data[[col]], col)</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(an<span class="sc">$</span>tipo<span class="sc">==</span><span class="st">"factor"</span>){</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    o <span class="ot">&lt;-</span> an<span class="sc">$</span>grafica</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span> <span class="cf">if</span>(an<span class="sc">$</span>tipo<span class="sc">==</span><span class="st">"numeric"</span>){</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>    o <span class="ot">&lt;-</span> an<span class="sc">$</span>hist</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(o)</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<!-- Div para la imagen principal -->
<div id="main-image">
  <img src="images/image1.png" alt="Imagen Principal" id="displayed-image">
</div>
<!-- Div para las miniaturas -->
<div class="thumbnail-gallery">
  ::: {.cell layout-align="center"}
  <img src="images/image1.png" alt="Imagen 1" onclick="changeImage('images/image1.png')"><img src="images/image2.png" alt="Imagen 2" onclick="changeImage('images/image2.png')"><img src="images/image3.png" alt="Imagen 3" onclick="changeImage('images/image3.png')"><img src="images/image4.png" alt="Imagen 4" onclick="changeImage('images/image4.png')"><img src="images/image5.png" alt="Imagen 5" onclick="changeImage('images/image5.png')"><img src="images/image6.png" alt="Imagen 6" onclick="changeImage('images/image6.png')"><img src="images/image7.png" alt="Imagen 7" onclick="changeImage('images/image7.png')"><img src="images/image8.png" alt="Imagen 8" onclick="changeImage('images/image8.png')"><img src="images/image9.png" alt="Imagen 9" onclick="changeImage('images/image9.png')"><img src="images/image10.png" alt="Imagen 10" onclick="changeImage('images/image10.png')"><img src="images/image11.png" alt="Imagen 11" onclick="changeImage('images/image11.png')"><img src="images/image12.png" alt="Imagen 12" onclick="changeImage('images/image12.png')"><img src="images/image13.png" alt="Imagen 13" onclick="changeImage('images/image13.png')"><img src="images/image14.png" alt="Imagen 14" onclick="changeImage('images/image14.png')"><img src="images/image15.png" alt="Imagen 15" onclick="changeImage('images/image15.png')">
  :::

</div>
<!-- JavaScript para cambiar la imagen principal -->
<script>
function changeImage(imageSrc) {
  document.getElementById('displayed-image').src = imageSrc;
}
</script>
<!-- CSS para estilizar la galería -->
<style>
#main-image {
  text-align: center;
  margin-bottom: 20px;
}

#main-image img {
  width: 600px;
  height: auto;
  border: 2px solid #ddd;
  border-radius: 5px;
}

.thumbnail-gallery {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 10px;
  max-width: 100%;
  overflow-x: auto;
}

.thumbnail-gallery img {
  width: 50px; /* Reducir el tamaño de las miniaturas */
  height: auto;
  cursor: pointer;
  border: 2px solid #ddd;
  border-radius: 5px;
  transition: transform 0.2s;
}

.thumbnail-gallery img:hover {
  transform: scale(1.1);
  border-color: #aaa;
}
</style>
<p>The most notable problem is the great imbalance between categories in variables like ESTADO_ACTUAL or HISTOLOGIA.</p>
<p>There is a decrease in the frecuency of the factor with worse prognosis in some variables like GANGLIOS OR ESTADIO that added to the fact that there are a low percentage of exitus could mean that most of the patients have a good prognosis.</p>
</div>
<div id="tabset-2-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-2-tab">
<p>In this section, we are going to measure and visualize the relation of every variable with the target. This is very useful to select the most important variables for our model.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>resultados_bi_ESTADO_ACTUAL <span class="ot">&lt;-</span> <span class="fu">lapply</span>(columnas, <span class="cf">function</span>(col) {</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  an <span class="ot">&lt;-</span> <span class="fu">analisis_bivariante_automatico</span>(data<span class="sc">$</span>ESTADO_ACTUAL, data[[col]], <span class="st">"ESTADO_ACTUAL"</span>, col)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(an<span class="sc">$</span>grafica)</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Guardar las imágenes generadas en una carpeta</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="st">"images_bi"</span>)) {</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(<span class="st">"images_bi"</span>)</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(resultados_bi_ESTADO_ACTUAL)) {</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="at">filename =</span> <span class="fu">paste0</span>(<span class="st">"images_bi/image"</span>, i, <span class="st">".png"</span>), <span class="at">plot =</span> resultados_bi_ESTADO_ACTUAL[[i]])</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<!-- Div para la imagen principal -->
<div id="main-image_bi">
  <img src="images_bi/image1.png" alt="Imagen Principal" id="displayed-image_bi">
</div>
<!-- Div para las miniaturas -->
<div class="thumbnail-gallery">
  ::: {.cell layout-align="center"}
  <img src="images_bi/image1.png" alt="Imagen 1" onclick="changeImage_bi('images_bi/image1.png')"><img src="images_bi/image2.png" alt="Imagen 2" onclick="changeImage_bi('images_bi/image2.png')"><img src="images_bi/image3.png" alt="Imagen 3" onclick="changeImage_bi('images_bi/image3.png')"><img src="images_bi/image4.png" alt="Imagen 4" onclick="changeImage_bi('images_bi/image4.png')"><img src="images_bi/image5.png" alt="Imagen 5" onclick="changeImage_bi('images_bi/image5.png')"><img src="images_bi/image6.png" alt="Imagen 6" onclick="changeImage_bi('images_bi/image6.png')"><img src="images_bi/image7.png" alt="Imagen 7" onclick="changeImage_bi('images_bi/image7.png')"><img src="images_bi/image8.png" alt="Imagen 8" onclick="changeImage_bi('images_bi/image8.png')"><img src="images_bi/image9.png" alt="Imagen 9" onclick="changeImage_bi('images_bi/image9.png')"><img src="images_bi/image10.png" alt="Imagen 10" onclick="changeImage_bi('images_bi/image10.png')"><img src="images_bi/image11.png" alt="Imagen 11" onclick="changeImage_bi('images_bi/image11.png')"><img src="images_bi/image12.png" alt="Imagen 12" onclick="changeImage_bi('images_bi/image12.png')"><img src="images_bi/image13.png" alt="Imagen 13" onclick="changeImage_bi('images_bi/image13.png')"><img src="images_bi/image14.png" alt="Imagen 14" onclick="changeImage_bi('images_bi/image14.png')"><img src="images_bi/image15.png" alt="Imagen 15" onclick="changeImage_bi('images_bi/image15.png')">
  :::

</div>
<script>
function changeImage_bi(imageSrc) {
  document.getElementById('displayed-image_bi').src = imageSrc;
}
</script>
<style>
#main-image_bi {
  text-align: center;
  margin-bottom: 20px;
}

#main-image_bi img {
  width: 600px;
  height: auto;
  border: 2px solid #ddd;
  border-radius: 5px;
}
</style>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>resultados_para_tabla <span class="ot">&lt;-</span> <span class="fu">lapply</span>(columnas, <span class="cf">function</span>(col) {</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  an <span class="ot">&lt;-</span> <span class="fu">analisis_bivariante_automatico</span>(data<span class="sc">$</span>ESTADO_ACTUAL, data[[col]],<span class="st">"ESTADO_ACTUAL"</span>,col)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(an)</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>p_values_1 <span class="ot">&lt;-</span> <span class="fu">sapply</span>(resultados_para_tabla, <span class="cf">function</span>(x) x<span class="sc">$</span>test<span class="sc">$</span>p.value)</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>formatted_p_values_1 <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(p_values_1 <span class="sc">&lt;</span> <span class="fl">0.0000001</span>, <span class="fu">format</span>(p_values_1, <span class="at">scientific =</span> <span class="cn">TRUE</span>), p_values_1)</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear una tabla con los resultados</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>tabla_resultados <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">Data_Name =</span> <span class="fu">sapply</span>(resultados_para_tabla, <span class="cf">function</span>(x) x<span class="sc">$</span>test<span class="sc">$</span>data.name),</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">Estadistico =</span> <span class="fu">sapply</span>(resultados_para_tabla, <span class="cf">function</span>(x) <span class="fu">ifelse</span>(<span class="fu">is.null</span>(x<span class="sc">$</span>test<span class="sc">$</span>statistic), <span class="cn">NA</span>, x<span class="sc">$</span>test<span class="sc">$</span>statistic)),</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">Odds =</span> <span class="fu">sapply</span>(resultados_para_tabla, <span class="cf">function</span>(x) <span class="fu">ifelse</span>(<span class="fu">is.null</span>(x<span class="sc">$</span>test<span class="sc">$</span>estimate), <span class="cn">NA</span>, x<span class="sc">$</span>test<span class="sc">$</span>estimate)),</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">P_valor =</span> formatted_p_values_1,</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">Method =</span> <span class="fu">sapply</span>(resultados_para_tabla, <span class="cf">function</span>(x) x<span class="sc">$</span>test<span class="sc">$</span>method),</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">Conclusion =</span> <span class="fu">sapply</span>(resultados_para_tabla, <span class="cf">function</span>(x) x<span class="sc">$</span>conclusion)</span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Mostrar la tabla usando kable</span></span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>tabla <span class="ot">&lt;-</span> <span class="fu">kable</span>(tabla_resultados, <span class="at">format =</span> <span class="st">"html"</span>, <span class="at">align =</span> <span class="st">"ccc"</span>, <span class="at">caption =</span> <span class="st">"Tabla de Resultados"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>, <span class="at">booktabs =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="st">"striped"</span>, <span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>tabla_con_scroll <span class="ot">&lt;-</span> <span class="fu">scroll_box</span>(tabla, <span class="at">height =</span> <span class="st">"400px"</span>)</span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Mostrar la tabla</span></span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(tabla_con_scroll)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div style="border: 1px solid #ddd; padding: 0px; overflow-y: scroll; height:400px; ">
<table class="table table-striped" style="width: auto !important; margin-left: auto; margin-right: auto;">
<caption>
Tabla de Resultados
</caption>
<thead>
<tr>
<th style="text-align:center;position: sticky; top:0; background-color: #FFFFFF;">
Data_Name
</th>
<th style="text-align:center;position: sticky; top:0; background-color: #FFFFFF;">
Estadistico
</th>
<th style="text-align:center;position: sticky; top:0; background-color: #FFFFFF;">
Odds
</th>
<th style="text-align:center;position: sticky; top:0; background-color: #FFFFFF;">
P_valor
</th>
<th style="text-align:center;position: sticky; top:0; background-color: #FFFFFF;">
Method
</th>
<th style="text-align:center;position: sticky; top:0; background-color: #FFFFFF;">
Conclusion
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center;">
ESTADO_ACTUAL_EDAD_DCO
</td>
<td style="text-align:center;">
NA
</td>
<td style="text-align:center;">
NA
</td>
<td style="text-align:center;">
0.0889555222388806
</td>
<td style="text-align:center;">
Fisher’s Exact Test for Count Data with simulated p-value (based on 2000 replicates)
</td>
<td style="text-align:center;">
independientes
</td>
</tr>
<tr>
<td style="text-align:center;">
ESTADO_ACTUAL_F.DIAG
</td>
<td style="text-align:center;">
NA
</td>
<td style="text-align:center;">
39.59521
</td>
<td style="text-align:center;">
2.279638e-13
</td>
<td style="text-align:center;">
Fisher’s Exact Test for Count Data
</td>
<td style="text-align:center;">
dependientes
</td>
</tr>
<tr>
<td style="text-align:center;">
ESTADO_ACTUAL_MENOP
</td>
<td style="text-align:center;">
0.1915292
</td>
<td style="text-align:center;">
NA
</td>
<td style="text-align:center;">
0.696151924037981
</td>
<td style="text-align:center;">
Pearson’s Chi-squared test with simulated p-value (based on 2000 replicates)
</td>
<td style="text-align:center;">
independientes
</td>
</tr>
<tr>
<td style="text-align:center;">
ESTADO_ACTUAL_CIRUGIA
</td>
<td style="text-align:center;">
0.4316058
</td>
<td style="text-align:center;">
NA
</td>
<td style="text-align:center;">
0.652673663168416
</td>
<td style="text-align:center;">
Pearson’s Chi-squared test with simulated p-value (based on 2000 replicates)
</td>
<td style="text-align:center;">
independientes
</td>
</tr>
<tr>
<td style="text-align:center;">
ESTADO_ACTUAL_HISTOLOGIA
</td>
<td style="text-align:center;">
NA
</td>
<td style="text-align:center;">
NA
</td>
<td style="text-align:center;">
0.363318340829585
</td>
<td style="text-align:center;">
Fisher’s Exact Test for Count Data with simulated p-value (based on 2000 replicates)
</td>
<td style="text-align:center;">
independientes
</td>
</tr>
<tr>
<td style="text-align:center;">
ESTADO_ACTUAL_GRADO
</td>
<td style="text-align:center;">
NA
</td>
<td style="text-align:center;">
NA
</td>
<td style="text-align:center;">
0.48575712143928
</td>
<td style="text-align:center;">
Fisher’s Exact Test for Count Data with simulated p-value (based on 2000 replicates)
</td>
<td style="text-align:center;">
independientes
</td>
</tr>
<tr>
<td style="text-align:center;">
ESTADO_ACTUAL_HER2
</td>
<td style="text-align:center;">
NA
</td>
<td style="text-align:center;">
2.04240
</td>
<td style="text-align:center;">
0.325961001877915
</td>
<td style="text-align:center;">
Fisher’s Exact Test for Count Data
</td>
<td style="text-align:center;">
independientes
</td>
</tr>
<tr>
<td style="text-align:center;">
ESTADO_ACTUAL_FENOTIPO
</td>
<td style="text-align:center;">
NA
</td>
<td style="text-align:center;">
NA
</td>
<td style="text-align:center;">
0.0284857571214393
</td>
<td style="text-align:center;">
Fisher’s Exact Test for Count Data with simulated p-value (based on 2000 replicates)
</td>
<td style="text-align:center;">
dependientes
</td>
</tr>
<tr>
<td style="text-align:center;">
ESTADO_ACTUAL_GANGLIOS
</td>
<td style="text-align:center;">
NA
</td>
<td style="text-align:center;">
NA
</td>
<td style="text-align:center;">
0.101449275362319
</td>
<td style="text-align:center;">
Fisher’s Exact Test for Count Data with simulated p-value (based on 2000 replicates)
</td>
<td style="text-align:center;">
independientes
</td>
</tr>
<tr>
<td style="text-align:center;">
ESTADO_ACTUAL_ESTADIO
</td>
<td style="text-align:center;">
NA
</td>
<td style="text-align:center;">
NA
</td>
<td style="text-align:center;">
0.0484757621189405
</td>
<td style="text-align:center;">
Fisher’s Exact Test for Count Data with simulated p-value (based on 2000 replicates)
</td>
<td style="text-align:center;">
dependientes
</td>
</tr>
<tr>
<td style="text-align:center;">
ESTADO_ACTUAL_ESTADO_ACTUAL
</td>
<td style="text-align:center;">
NA
</td>
<td style="text-align:center;">
Inf
</td>
<td style="text-align:center;">
1.768063e-46
</td>
<td style="text-align:center;">
Fisher’s Exact Test for Count Data
</td>
<td style="text-align:center;">
dependientes
</td>
</tr>
<tr>
<td style="text-align:center;">
ESTADO_ACTUAL_TAM
</td>
<td style="text-align:center;">
7233.5000000
</td>
<td style="text-align:center;">
NA
</td>
<td style="text-align:center;">
0.399827277950052
</td>
<td style="text-align:center;">
Wilcoxon rank sum test with continuity correction
</td>
<td style="text-align:center;">
independientes
</td>
</tr>
<tr>
<td style="text-align:center;">
ESTADO_ACTUAL_RE
</td>
<td style="text-align:center;">
4925.0000000
</td>
<td style="text-align:center;">
NA
</td>
<td style="text-align:center;">
0.0192281698897077
</td>
<td style="text-align:center;">
Wilcoxon rank sum test with continuity correction
</td>
<td style="text-align:center;">
dependientes
</td>
</tr>
<tr>
<td style="text-align:center;">
ESTADO_ACTUAL_RP
</td>
<td style="text-align:center;">
6562.0000000
</td>
<td style="text-align:center;">
NA
</td>
<td style="text-align:center;">
0.949999736257327
</td>
<td style="text-align:center;">
Wilcoxon rank sum test with continuity correction
</td>
<td style="text-align:center;">
independientes
</td>
</tr>
<tr>
<td style="text-align:center;">
ESTADO_ACTUAL_KI67
</td>
<td style="text-align:center;">
7115.5000000
</td>
<td style="text-align:center;">
NA
</td>
<td style="text-align:center;">
0.493141766967312
</td>
<td style="text-align:center;">
Wilcoxon rank sum test with continuity correction
</td>
<td style="text-align:center;">
independientes
</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The target variable is dependent to diagnosis date, phenotype, stage and estrogen receptors. These variables are the most important for our model. This matches with the published scientific evidence.</p>
</div>
<div id="tabset-2-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-3-tab">
<p>To recollect even more information, we are going to build a association matrix where we can see p-values(meaning of association) of every variable with each others</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reshape2)</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Definir la función para calcular p-valores y generar un mapa de calor</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>generar_mapa_calor_p_valores <span class="ot">&lt;-</span> <span class="cf">function</span>(data, analisis_bivariante_automatico) {</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  num_variables <span class="ot">&lt;-</span> <span class="fu">ncol</span>(data)</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>  p_valores <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> num_variables, <span class="at">ncol =</span> num_variables)</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Función para calcular los p-valores entre dos variables</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>  calcular_p_valores <span class="ot">&lt;-</span> <span class="cf">function</span>(i, j) {</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>    an <span class="ot">&lt;-</span> <span class="fu">analisis_bivariante_automatico</span>(data[, i], data[, j], <span class="fu">colnames</span>(data)[i], <span class="fu">colnames</span>(data)[j])</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(an<span class="sc">$</span>test<span class="sc">$</span>p.value)</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular los p-valores para todas las combinaciones de variables utilizando lapply</span></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>  indices <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="dv">1</span><span class="sc">:</span>num_variables, <span class="dv">1</span><span class="sc">:</span>num_variables)</span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>  p_valores <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">unlist</span>(<span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(indices), <span class="cf">function</span>(idx) {</span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">calcular_p_valores</span>(indices[idx, <span class="dv">1</span>], indices[idx, <span class="dv">2</span>])</span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>  })), <span class="at">nrow =</span> num_variables, <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Agregar nombres de columnas y filas para identificar las variables</span></span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(p_valores) <span class="ot">&lt;-</span> <span class="fu">colnames</span>(data)</span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(p_valores) <span class="ot">&lt;-</span> <span class="fu">colnames</span>(data)</span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convertir la matriz en un data frame largo</span></span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a>  p_valores_long <span class="ot">&lt;-</span> <span class="fu">melt</span>(p_valores, <span class="at">varnames =</span> <span class="fu">c</span>(<span class="st">"Variable1"</span>, <span class="st">"Variable2"</span>), <span class="at">value.name =</span> <span class="st">"p_value"</span>)</span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Crear el mapa de calor usando ggplot2</span></span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="at">data =</span> p_valores_long, <span class="fu">aes</span>(<span class="at">x =</span> Variable1, <span class="at">y =</span> Variable2, <span class="at">fill =</span> p_value)) <span class="sc">+</span></span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_tile</span>() <span class="sc">+</span></span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_gradient</span>(<span class="at">low =</span> <span class="st">"lightblue"</span>, <span class="at">high =</span> <span class="st">"#7469B6"</span>) <span class="sc">+</span></span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Heat Map of p-values"</span>, <span class="at">x =</span> <span class="st">"Variables"</span>, <span class="at">y =</span> <span class="st">"Variables"</span>) <span class="sc">+</span></span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb42-34"><a href="#cb42-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span>
<span id="cb42-35"><a href="#cb42-35" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb42-36"><a href="#cb42-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-37"><a href="#cb42-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Ejemplo de uso con un conjunto de datos llamado 'data'</span></span>
<span id="cb42-38"><a href="#cb42-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Asegúrate de definir la función 'analisis_bivariante_automatico' antes de usar esta función</span></span>
<span id="cb42-39"><a href="#cb42-39" aria-hidden="true" tabindex="-1"></a><span class="fu">generar_mapa_calor_p_valores</span>(data, analisis_bivariante_automatico)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="actividad3_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The association results presented in the table depict the strength and significance of relationships between various variables in the study. Each value in the table represents a measure of association, such as p-values, reflecting the level of dependency or independence between pairs of variables. Upon reviewing the table, several notable associations emerge. For instance, the variables <strong>ESTADO_ACTUAL</strong> and <strong>FENOTIPO</strong> exhibit a strong association, with a p-value of 0.0000001, indicating a significant relationship between the two variables. Similarly, the variables <strong>ESTADO_ACTUAL</strong> and <strong>ESTADIO</strong> also demonstrate a significant association, with a p-value of 0.0000001, suggesting a strong relationship between disease stage and patient status. These findings provide valuable insights into the interplay between different variables and their impact on patient outcomes.</p>
</div>
<div id="tabset-2-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-4-tab">
<p>In this section, we are going to analyze the imbalance in the target variable and the effect of this imbalance on the model performance.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Supongamos que data$ESTADO_ACTUAL es la variable objetivo</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>frecuencia_clases <span class="ot">&lt;-</span> <span class="fu">table</span>(data<span class="sc">$</span>ESTADO_ACTUAL)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>porcentaje_clases <span class="ot">&lt;-</span> <span class="fu">prop.table</span>(frecuencia_clases) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear un data frame con los porcentajes</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>df_porcentaje <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(porcentaje_clases)</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(df_porcentaje) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Clase"</span>, <span class="st">"Porcentaje"</span>)</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Mostrar la tabla usando kable</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(df_porcentaje, <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Class"</span>, <span class="st">"Percentage (%)"</span>), <span class="at">caption =</span> <span class="st">"Target imbalance"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<caption>Target imbalance</caption>
<thead>
<tr class="header">
<th style="text-align: left;">Class</th>
<th style="text-align: right;">Percentage (%)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Exitus</td>
<td style="text-align: right;">5.6</td>
</tr>
<tr class="even">
<td style="text-align: left;">Vivo</td>
<td style="text-align: right;">94.4</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The fact that the target is completely unbalanced can lead to a model that is not able to predict the minority class, this is a common problem in classification models and we are going to address it in the next sections.</p>
</div>
</div>
</div>
</section>
<section id="variable-selection" class="level1">
<h1>Variable selection</h1>
<p>Variable selection is a crucial step in building predictive models, helping to identify the most relevant features for the target prediction. There are three main methods for variable selection: filter methods, wrapper methods, and embedded methods. In this section, we will explore these methods to select the most important variables for our predictive model.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset" style="background-color: #f0f0f0;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-3-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-1" role="tab" aria-controls="tabset-3-1" aria-selected="true" href="">Filter methods</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-2" role="tab" aria-controls="tabset-3-2" aria-selected="false" href="">Wrapper methods</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-3" role="tab" aria-controls="tabset-3-3" aria-selected="false" href="">Embedded methods</a></li></ul>
<div class="tab-content" style="background-color: #f0f0f0;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;">
<div id="tabset-3-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-3-1-tab">
<p>Filter methods select important variables before the learning algorithm is applied. These methods are independent of the learning algorithm and are based on intrinsic characteristics of the data, such as correlation, mutual information, or variance. We are going to use the p-value of the adecuated test to select the most important variables in terms of dependence with the target variable.</p>
<p>Here is an example of a filter with all the data, remember that we have to do this process in every fold of the cross validation to avoid data leakage.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>filter_dependency <span class="ot">&lt;-</span> <span class="cf">function</span>(data, dependent_variable, columns, <span class="at">significance_level =</span> <span class="fl">0.05</span>) {</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Realizar el análisis bivariante y obtener los resultados</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  resultados_para_tabla <span class="ot">&lt;-</span> <span class="fu">lapply</span>(columns, <span class="cf">function</span>(col) {</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">analisis_bivariante_automatico</span>(data[[dependent_variable]], data[[col]], dependent_variable, col)</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Obtener los p-values de las pruebas bivariadas</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>  p_values <span class="ot">&lt;-</span> <span class="fu">sapply</span>(resultados_para_tabla, <span class="cf">function</span>(x) x<span class="sc">$</span>test<span class="sc">$</span>p.value)</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Seleccionar las variables con p-value por debajo del umbral</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>  columnas_seleccionadas <span class="ot">&lt;-</span> columns[p_values <span class="sc">&lt;</span> significance_level]</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filtrar el conjunto de datos para incluir solo las columnas seleccionadas y la columna dependiente</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>  data_filtrada <span class="ot">&lt;-</span> data[, <span class="fu">c</span>(dependent_variable, columnas_seleccionadas)]</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Retornar el conjunto de datos filtrado</span></span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(data_filtrada)</span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>filtered_data <span class="ot">&lt;-</span> <span class="fu">filter_dependency</span>(data, <span class="st">"ESTADO_ACTUAL"</span>, columnas)</span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="st">"ESTADO_ACTUAL.1"</span> <span class="sc">%in%</span> <span class="fu">colnames</span>(filtered_data)) {</span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>    filtered_data <span class="ot">&lt;-</span> filtered_data[, <span class="sc">!</span><span class="fu">colnames</span>(filtered_data) <span class="sc">%in%</span> <span class="st">"ESTADO_ACTUAL.1"</span>, drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(filtered_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> ESTADO_ACTUAL       F.DIAG               FENOTIPO   ESTADIO  
 Exitus: 28    2000-2009:142   HER2           : 31   I  :183  
 Vivo  :472    2010-2019:358   LUMINAL A      :122   II :217  
                               LUMINAL B      :189   III: 76  
                               LUMINAL HER2   : 65   IV : 24  
                               LUMINAL ND     : 48            
                               TRIPLE NEGATIVO: 45            
       RE         
 Min.   :-2.1636  
 1st Qu.: 0.0000  
 Median : 0.4819  
 Mean   : 0.0000  
 3rd Qu.: 0.5655  
 Max.   : 0.6212  </code></pre>
</div>
</div>
</div>
<div id="tabset-3-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-2-tab">
<p>Wrapper methods use a learning algorithm to evaluate the importance of variables. In each iteration, a different subset of variables is evaluated, and the set that provides the best model performance is selected. These methods are typically more accurate than filter methods but are also more computationally expensive.</p>
<p>A common example of a wrapper method is forward selection or backward elimination. These methods test different combinations of variables and select those that improve model performance.</p>
<p>In the next sections, we will implement a wrapper method to select the best variables with brute force. Basically, we are going to iterate over all the possible combinations of variables and select the one that provides the best model performance.</p>
</div>
<div id="tabset-3-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-3-tab">
<p>Embedded methods perform variable selection during the training process of the model. These methods are specific to the learning algorithm and are built into the model. For example, decision trees and random forests have built-in feature selection capabilities based on the importance of variables in the model.</p>
<p>We are going to select the most important variables using the Random Forest algorithm, which provides a measure of variable importance based on the Mean Decrease Gini index.</p>
<p>Example of embedded method:</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>seleccionar_variables_importantes <span class="ot">&lt;-</span> <span class="cf">function</span>(data, target, <span class="at">top_n =</span> <span class="dv">10</span>, <span class="at">seed =</span> <span class="dv">123</span>) {</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Asegurarse de que el target esté en el data frame</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>target <span class="sc">%in%</span> <span class="fu">names</span>(data)) {</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"La variable objetivo no está en el conjunto de datos."</span>)</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convertir la variable target a un factor si no lo es</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.factor</span>(data[[target]])) {</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>    data[[target]] <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(data[[target]])</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Definir la fórmula del modelo</span></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>  formula <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(target, <span class="st">"~ ."</span>))</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Entrenar el modelo de Random Forest</span></span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>  modelo_rf <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(formula, <span class="at">data =</span> data, <span class="at">importance =</span> <span class="cn">TRUE</span>)</span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extraer la importancia de las variables</span></span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>  importancia <span class="ot">&lt;-</span> <span class="fu">importance</span>(modelo_rf)</span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convertir a un dataframe para facilidad de manejo</span></span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>  importancia_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(importancia)</span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a>  importancia_df<span class="sc">$</span>variable <span class="ot">&lt;-</span> <span class="fu">rownames</span>(importancia_df)</span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ordenar por la importancia de MeanDecreaseGini</span></span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a>  importancia_df <span class="ot">&lt;-</span> importancia_df[<span class="fu">order</span>(<span class="sc">-</span>importancia_df<span class="sc">$</span>MeanDecreaseGini), ]</span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Seleccionar las 'top_n' variables más importantes</span></span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a>  variables_seleccionadas <span class="ot">&lt;-</span> importancia_df<span class="sc">$</span>variable[<span class="dv">1</span><span class="sc">:</span>top_n]</span>
<span id="cb46-31"><a href="#cb46-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb46-32"><a href="#cb46-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(variables_seleccionadas)</span>
<span id="cb46-33"><a href="#cb46-33" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb46-34"><a href="#cb46-34" aria-hidden="true" tabindex="-1"></a>variables_importantes <span class="ot">&lt;-</span> <span class="fu">seleccionar_variables_importantes</span>(data, <span class="st">"ESTADO_ACTUAL"</span>, <span class="at">top_n =</span> <span class="dv">4</span>)</span>
<span id="cb46-35"><a href="#cb46-35" aria-hidden="true" tabindex="-1"></a>filtered_data <span class="ot">&lt;-</span> data[,<span class="fu">c</span>(<span class="st">"ESTADO_ACTUAL"</span>,variables_importantes)]</span>
<span id="cb46-36"><a href="#cb46-36" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(filtered_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> ESTADO_ACTUAL      TAM           EDAD_DCO         F.DIAG         KI67         
 Exitus: 28    Min.   :-1.2561   0-39 : 44   2000-2009:142   Min.   :-1.17307  
 Vivo  :472    1st Qu.:-0.6513   40-49:107   2010-2019:358   1st Qu.:-0.75101  
               Median :-0.1676   50-59:132                   Median :-0.06037  
               Mean   : 0.0000   60-69:122                   Mean   : 0.00000  
               3rd Qu.: 0.2709   70-79: 55                   3rd Qu.: 0.32331  
               Max.   : 5.8191   ≥80  : 40                   Max.   : 2.62544  </code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="models" class="level1">
<h1>Models</h1>
<p>The aim of this section is to build a predictive model to estimate the probability of metastasis. We are going to compare different models and select the one that provides the best performance based on the evaluation metrics. On top of that, we are going to compare the different variable selection methods to determine the most effective approach.</p>
<p>For each model, we will evaluate the performance using a hold-out validation and a 5x2 cross-validation to ensure the honesty of the results, it is a good compromise between computational cost and robustness of the results.</p>
<section id="first-aproach" class="level2">
<h2 class="anchored" data-anchor-id="first-aproach">First Aproach</h2>
<p>In this section we are going to build a logistic regression model using all the data aiming to see if the model is able to predict the target variable with a good accuracy.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ajustar el modelo logístico</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>modelo_primero <span class="ot">&lt;-</span> <span class="fu">glm</span>(<span class="at">formula=</span> ESTADO_ACTUAL <span class="sc">~</span> ., <span class="at">data =</span> data, <span class="at">family =</span> <span class="fu">binomial</span>(<span class="st">"logit"</span>))</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Predecir en los datos de validación</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>predicciones <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelo_primero, <span class="at">newdata =</span> data, <span class="at">type =</span> <span class="st">"response"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-4-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-1" role="tab" aria-controls="tabset-4-1" aria-selected="true" href="">Predictions</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-4-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-2" role="tab" aria-controls="tabset-4-2" aria-selected="false" href="">Roc curve and auc</a></li></ul>
<div class="tab-content">
<div id="tabset-4-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-4-1-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular las predicciones para el conjunto de test</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>clases_predichas <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predicciones<span class="sc">&gt;=</span> <span class="fl">0.8</span>, <span class="st">"Vivo"</span>, <span class="st">"Exitus"</span>)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="fu">mostrar_metricas</span>(data<span class="sc">$</span>ESTADO_ACTUAL,clases_predichas)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="actividad3_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<caption>Model Performance</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Metric</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Test</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Accuracy</td>
<td style="text-align: right;">0.9320000</td>
</tr>
<tr class="even">
<td style="text-align: left;">Precision</td>
<td style="text-align: right;">0.9802632</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Recall</td>
<td style="text-align: right;">0.9470339</td>
</tr>
<tr class="even">
<td style="text-align: left;">Specificity</td>
<td style="text-align: right;">0.6785714</td>
</tr>
<tr class="odd">
<td style="text-align: left;">F1-Score</td>
<td style="text-align: right;">0.9633621</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
</div>
<div id="tabset-4-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-4-2-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular la curva ROC y el AUC para el conjunto de test</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_roc_curve</span>(predicciones,data<span class="sc">$</span>ESTADO_ACTUAL)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="actividad3_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>At first sight the model seems to be accurate, the metrics are too optimistic though.</p>
</div>
</div>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset" style="background-color: rgb(226, 231, 236);box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-35-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-35-1" role="tab" aria-controls="tabset-35-1" aria-selected="true" href="">Logistic Regression</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-35-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-35-2" role="tab" aria-controls="tabset-35-2" aria-selected="false" href="">Neural Networks</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-35-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-35-3" role="tab" aria-controls="tabset-35-3" aria-selected="false" href="">Support Vectors Machine</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-35-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-35-4" role="tab" aria-controls="tabset-35-4" aria-selected="false" href="">Decision tree</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-35-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-35-5" role="tab" aria-controls="tabset-35-5" aria-selected="false" href="">Random Forest</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-35-6-tab" data-bs-toggle="tab" data-bs-target="#tabset-35-6" role="tab" aria-controls="tabset-35-6" aria-selected="false" href="">Naive Bayes</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-35-7-tab" data-bs-toggle="tab" data-bs-target="#tabset-35-7" role="tab" aria-controls="tabset-35-7" aria-selected="false" href="">K-Nearest Neighbors</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-35-8-tab" data-bs-toggle="tab" data-bs-target="#tabset-35-8" role="tab" aria-controls="tabset-35-8" aria-selected="false" href="">AdaBoost</a></li></ul>
<div class="tab-content" style="background-color: rgb(226, 231, 236);box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;">
<div id="tabset-35-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-35-1-tab">
<div class="tabset-margin-container"></div><div class="panel-tabset" style="background-color: #f0f0f0;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-10-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-10-1" role="tab" aria-controls="tabset-10-1" aria-selected="true" href="">Hold Out</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-10-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-10-2" role="tab" aria-controls="tabset-10-2" aria-selected="false" href="">Hold Out Oversampling</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-10-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-10-3" role="tab" aria-controls="tabset-10-3" aria-selected="false" href="">5x2 Cross Validation Filter</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-10-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-10-4" role="tab" aria-controls="tabset-10-4" aria-selected="false" href="">5x2 Cross Validation Embedded</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-10-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-10-5" role="tab" aria-controls="tabset-10-5" aria-selected="false" href="">5x2 Cross Validation Wrapper</a></li></ul>
<div class="tab-content" style="background-color: #f0f0f0;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;">
<div id="tabset-10-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-10-1-tab">
<p>In every model, we are going to over sample the training data to avoid the imbalance in the target variable, since in the last activity we corroborated the eficacy of this method.</p>
<p>We are going to build a logistic regression model using the best variables selected by the wrapper cause it is the most accurate method.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="co">#parameters to change:</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>proportion <span class="ot">&lt;-</span> <span class="fl">0.91</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Dividir el conjunto de datos en entrenamiento y test</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>indices_entrenamiento <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(data), <span class="fl">0.75</span> <span class="sc">*</span> <span class="fu">nrow</span>(data))  <span class="co"># 75% para entrenamiento</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento <span class="ot">&lt;-</span> data[indices_entrenamiento, ]</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>datos_test <span class="ot">&lt;-</span> data[<span class="sc">-</span>indices_entrenamiento, ]</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Dividir datos de entrenamiento en entrenamiento y validación</span></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>train_indices <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(datos_entrenamiento), <span class="fl">0.8</span> <span class="sc">*</span> <span class="fu">nrow</span>(datos_entrenamiento))  <span class="co"># 80% para entrenamiento</span></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento_split <span class="ot">&lt;-</span> datos_entrenamiento[train_indices, ]</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>datos_validacion <span class="ot">&lt;-</span> datos_entrenamiento[<span class="sc">-</span>train_indices, ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento_oversampled <span class="ot">&lt;-</span> <span class="fu">ROSE</span>(ESTADO_ACTUAL <span class="sc">~</span> .,<span class="at">data=</span>datos_entrenamiento_split,<span class="at">p =</span>proportion)<span class="sc">$</span>data</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Establecer la fórmula base para el modelo logístico</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>formula_base <span class="ot">&lt;-</span> <span class="fu">formula</span>(ESTADO_ACTUAL <span class="sc">~</span> <span class="dv">1</span>)  <span class="co"># Fórmula inicial sin predictoras</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtener nombres de variables predictoras</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>variables <span class="ot">&lt;-</span> <span class="fu">names</span>(datos_entrenamiento_oversampled)[<span class="sc">-</span><span class="fu">which</span>(<span class="fu">names</span>(datos_entrenamiento_oversampled) <span class="sc">==</span> <span class="st">"ESTADO_ACTUAL"</span>)]</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtener todas las combinaciones posibles de variables predictoras</span></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>combinaciones_variables <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(variables), <span class="cf">function</span>(x) <span class="fu">combn</span>(variables, x, <span class="at">simplify =</span> <span class="cn">FALSE</span>)), <span class="at">recursive =</span> <span class="cn">FALSE</span>)</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Establecer variables para almacenar el mejor modelo y su AUC</span></span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>mejor_modelo <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>mejor_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterar sobre todas las combinaciones de variables</span></span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (combinacion <span class="cf">in</span> combinaciones_variables) {</span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Construir la fórmula con las variables actuales</span></span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>  formula_actual <span class="ot">&lt;-</span> <span class="fu">reformulate</span>(combinacion, <span class="at">response =</span> <span class="st">"ESTADO_ACTUAL"</span>)</span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ajustar el modelo logístico</span></span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a>  modelo_actual <span class="ot">&lt;-</span> <span class="fu">glm</span>(formula_actual, <span class="at">data =</span> datos_entrenamiento_split, <span class="at">family =</span> <span class="fu">binomial</span>(<span class="st">"logit"</span>))</span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Predecir en los datos de validación</span></span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a>  predicciones_validacion <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelo_actual, <span class="at">newdata =</span> datos_validacion, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular el AUC para la combinación actual</span></span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true" tabindex="-1"></a>  auc_actual <span class="ot">&lt;-</span> pROC<span class="sc">::</span><span class="fu">roc</span>(datos_validacion<span class="sc">$</span>ESTADO_ACTUAL, predicciones_validacion)<span class="sc">$</span>auc</span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-30"><a href="#cb52-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Actualizar el mejor modelo si se encuentra uno con un AUC mayor</span></span>
<span id="cb52-31"><a href="#cb52-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (auc_actual <span class="sc">&gt;</span> mejor_auc) {</span>
<span id="cb52-32"><a href="#cb52-32" aria-hidden="true" tabindex="-1"></a>    mejor_auc <span class="ot">&lt;-</span> auc_actual</span>
<span id="cb52-33"><a href="#cb52-33" aria-hidden="true" tabindex="-1"></a>    mejor_modelo <span class="ot">&lt;-</span> modelo_actual</span>
<span id="cb52-34"><a href="#cb52-34" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb52-35"><a href="#cb52-35" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb52-36"><a href="#cb52-36" aria-hidden="true" tabindex="-1"></a>modelo_primero <span class="ot">&lt;-</span> mejor_modelo</span>
<span id="cb52-37"><a href="#cb52-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-38"><a href="#cb52-38" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb52-39"><a href="#cb52-39" aria-hidden="true" tabindex="-1"></a>execution_time <span class="ot">&lt;-</span> end_time <span class="sc">-</span> start_time</span>
<span id="cb52-40"><a href="#cb52-40" aria-hidden="true" tabindex="-1"></a>execution_time_p <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(execution_time, <span class="at">units =</span> <span class="st">"secs"</span>)</span>
<span id="cb52-41"><a href="#cb52-41" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(<span class="st">"modelo_primero"</span>, <span class="at">file =</span> <span class="st">"modelo_primero.RData"</span>)</span>
<span id="cb52-42"><a href="#cb52-42" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(<span class="st">"execution_time_p"</span>, <span class="at">file =</span> <span class="st">"execution_time_p.RData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"modelo_primero.RData"</span>)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"execution_time_p.RData"</span>)</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time_p, <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Execution time: 88.9083 seconds </code></pre>
</div>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-5-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-1" role="tab" aria-controls="tabset-5-1" aria-selected="true" href="">Predictions</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-5-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-2" role="tab" aria-controls="tabset-5-2" aria-selected="false" href="">Roc curve and auc</a></li></ul>
<div class="tab-content">
<div id="tabset-5-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-5-1-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular las predicciones para el conjunto de test</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>predicciones_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelo_primero, <span class="at">newdata =</span> datos_test, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>clases_predichas_test <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predicciones_test <span class="sc">&gt;=</span> <span class="fl">0.85</span>, <span class="st">"Vivo"</span>, <span class="st">"Exitus"</span>)</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a><span class="fu">mostrar_metricas</span>(datos_test<span class="sc">$</span>ESTADO_ACTUAL,clases_predichas_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="actividad3_files/figure-html/unnamed-chunk-40-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<caption>Model Performance</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Metric</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Test</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Accuracy</td>
<td style="text-align: right;">0.8240000</td>
</tr>
<tr class="even">
<td style="text-align: left;">Precision</td>
<td style="text-align: right;">0.9509804</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Recall</td>
<td style="text-align: right;">0.8508772</td>
</tr>
<tr class="even">
<td style="text-align: left;">Specificity</td>
<td style="text-align: right;">0.5454545</td>
</tr>
<tr class="odd">
<td style="text-align: left;">F1-Score</td>
<td style="text-align: right;">0.8981481</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
</div>
<div id="tabset-5-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-5-2-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular la curva ROC y el AUC para el conjunto de test</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_roc_curve</span>(predicciones_test,datos_test<span class="sc">$</span>ESTADO_ACTUAL)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="actividad3_files/figure-html/unnamed-chunk-41-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<p>The performance of the model is acceptable but it seems that it is not robust at all.</p>
</div>
<div id="tabset-10-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-10-2-tab">
<p>In every model, we are going to over sample the training data to avoid the imbalance in the target variable, since in the last activity we corroborated the eficacy of this method.</p>
<p>We are going to build a logistic regression model using the best variables selected by the wrapper cause it is the most accurate method.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="co">#parameters to change:</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>proportion <span class="ot">&lt;-</span> <span class="fl">0.95</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Dividir el conjunto de datos en entrenamiento y test</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>indices_entrenamiento <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(data), <span class="fl">0.75</span> <span class="sc">*</span> <span class="fu">nrow</span>(data))  <span class="co"># 75% para entrenamiento</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento <span class="ot">&lt;-</span> data[indices_entrenamiento, ]</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>datos_test <span class="ot">&lt;-</span> data[<span class="sc">-</span>indices_entrenamiento, ]</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Dividir datos de entrenamiento en entrenamiento y validación</span></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>train_indices <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(datos_entrenamiento), <span class="fl">0.8</span> <span class="sc">*</span> <span class="fu">nrow</span>(datos_entrenamiento))  <span class="co"># 80% para entrenamiento</span></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento_split <span class="ot">&lt;-</span> datos_entrenamiento[train_indices, ]</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>datos_validacion <span class="ot">&lt;-</span> datos_entrenamiento[<span class="sc">-</span>train_indices, ]</span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento_oversampled <span class="ot">&lt;-</span> <span class="fu">ROSE</span>(ESTADO_ACTUAL <span class="sc">~</span> .,<span class="at">data=</span>datos_entrenamiento_split,<span class="at">p =</span>proportion)<span class="sc">$</span>data</span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Establecer la fórmula base para el modelo logístico</span></span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>formula_base <span class="ot">&lt;-</span> <span class="fu">formula</span>(ESTADO_ACTUAL <span class="sc">~</span> <span class="dv">1</span>)  <span class="co"># Fórmula inicial sin predictoras</span></span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtener nombres de variables predictoras</span></span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a>variables <span class="ot">&lt;-</span> <span class="fu">names</span>(datos_entrenamiento_oversampled)[<span class="sc">-</span><span class="fu">which</span>(<span class="fu">names</span>(datos_entrenamiento_oversampled) <span class="sc">==</span> <span class="st">"ESTADO_ACTUAL"</span>)]</span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtener todas las combinaciones posibles de variables predictoras</span></span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a>combinaciones_variables <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(variables), <span class="cf">function</span>(x) <span class="fu">combn</span>(variables, x, <span class="at">simplify =</span> <span class="cn">FALSE</span>)), <span class="at">recursive =</span> <span class="cn">FALSE</span>)</span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Establecer variables para almacenar el mejor modelo y su AUC</span></span>
<span id="cb57-27"><a href="#cb57-27" aria-hidden="true" tabindex="-1"></a>mejor_modelo <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb57-28"><a href="#cb57-28" aria-hidden="true" tabindex="-1"></a>mejor_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb57-29"><a href="#cb57-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-30"><a href="#cb57-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterar sobre todas las combinaciones de variables</span></span>
<span id="cb57-31"><a href="#cb57-31" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (combinacion <span class="cf">in</span> combinaciones_variables) {</span>
<span id="cb57-32"><a href="#cb57-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Construir la fórmula con las variables actuales</span></span>
<span id="cb57-33"><a href="#cb57-33" aria-hidden="true" tabindex="-1"></a>  formula_actual <span class="ot">&lt;-</span> <span class="fu">reformulate</span>(combinacion, <span class="at">response =</span> <span class="st">"ESTADO_ACTUAL"</span>)</span>
<span id="cb57-34"><a href="#cb57-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb57-35"><a href="#cb57-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ajustar el modelo logístico</span></span>
<span id="cb57-36"><a href="#cb57-36" aria-hidden="true" tabindex="-1"></a>  modelo_actual <span class="ot">&lt;-</span> <span class="fu">glm</span>(formula_actual, <span class="at">data =</span> datos_entrenamiento_oversampled, <span class="at">family =</span> <span class="fu">binomial</span>(<span class="st">"logit"</span>))</span>
<span id="cb57-37"><a href="#cb57-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb57-38"><a href="#cb57-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Predecir en los datos de validación</span></span>
<span id="cb57-39"><a href="#cb57-39" aria-hidden="true" tabindex="-1"></a>  predicciones_validacion <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelo_actual, <span class="at">newdata =</span> datos_validacion, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb57-40"><a href="#cb57-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb57-41"><a href="#cb57-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular el AUC para la combinación actual</span></span>
<span id="cb57-42"><a href="#cb57-42" aria-hidden="true" tabindex="-1"></a>  auc_actual <span class="ot">&lt;-</span> pROC<span class="sc">::</span><span class="fu">roc</span>(datos_validacion<span class="sc">$</span>ESTADO_ACTUAL, predicciones_validacion)<span class="sc">$</span>auc</span>
<span id="cb57-43"><a href="#cb57-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb57-44"><a href="#cb57-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Actualizar el mejor modelo si se encuentra uno con un AUC mayor</span></span>
<span id="cb57-45"><a href="#cb57-45" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (auc_actual <span class="sc">&gt;</span> mejor_auc) {</span>
<span id="cb57-46"><a href="#cb57-46" aria-hidden="true" tabindex="-1"></a>    mejor_auc <span class="ot">&lt;-</span> auc_actual</span>
<span id="cb57-47"><a href="#cb57-47" aria-hidden="true" tabindex="-1"></a>    mejor_modelo <span class="ot">&lt;-</span> modelo_actual</span>
<span id="cb57-48"><a href="#cb57-48" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb57-49"><a href="#cb57-49" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb57-50"><a href="#cb57-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-51"><a href="#cb57-51" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mejor_modelo)</span>
<span id="cb57-52"><a href="#cb57-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-53"><a href="#cb57-53" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb57-54"><a href="#cb57-54" aria-hidden="true" tabindex="-1"></a>execution_time <span class="ot">&lt;-</span> end_time <span class="sc">-</span> start_time</span>
<span id="cb57-55"><a href="#cb57-55" aria-hidden="true" tabindex="-1"></a>execution_time <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(execution_time, <span class="at">units =</span> <span class="st">"secs"</span>)</span>
<span id="cb57-56"><a href="#cb57-56" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(<span class="st">"mejor_modelo"</span>, <span class="at">file =</span> <span class="st">"mejor_modelo.RData"</span>)</span>
<span id="cb57-57"><a href="#cb57-57" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(<span class="st">"execution_time"</span>, <span class="at">file =</span> <span class="st">"execution_time.RData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"mejor_modelo.RData"</span>)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"execution_time.RData"</span>)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time, <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Execution time: 102.8051 seconds </code></pre>
</div>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-6-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-6-1" role="tab" aria-controls="tabset-6-1" aria-selected="true" href="">Predictions</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-6-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-6-2" role="tab" aria-controls="tabset-6-2" aria-selected="false" href="">Roc curve and auc</a></li></ul>
<div class="tab-content">
<div id="tabset-6-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-6-1-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular las predicciones para el conjunto de test</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>predicciones_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(mejor_modelo, <span class="at">newdata =</span> datos_test, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>clases_predichas_test <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predicciones_test <span class="sc">&gt;=</span> <span class="fl">0.5</span>, <span class="st">"Vivo"</span>, <span class="st">"Exitus"</span>)</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a><span class="fu">mostrar_metricas</span>(datos_test<span class="sc">$</span>ESTADO_ACTUAL,clases_predichas_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="actividad3_files/figure-html/unnamed-chunk-44-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<caption>Model Performance</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Metric</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Test</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Accuracy</td>
<td style="text-align: right;">0.5680000</td>
</tr>
<tr class="even">
<td style="text-align: left;">Precision</td>
<td style="text-align: right;">0.8750000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Recall</td>
<td style="text-align: right;">0.6140351</td>
</tr>
<tr class="even">
<td style="text-align: left;">Specificity</td>
<td style="text-align: right;">0.0909091</td>
</tr>
<tr class="odd">
<td style="text-align: left;">F1-Score</td>
<td style="text-align: right;">0.7216495</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
</div>
<div id="tabset-6-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-6-2-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular la curva ROC y el AUC para el conjunto de test</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_roc_curve</span>(predicciones_test,datos_test<span class="sc">$</span>ESTADO_ACTUAL)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="actividad3_files/figure-html/unnamed-chunk-45-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<p>The performance of the model is acceptable but it seems that it is not robust at all.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(<span class="at">eval =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="tabset-10-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-10-3-tab">
<p>We are going to perform a 5x2 cross validation to ensure the robustness of the model. First, we create the outer folds and then we iterate over them to create the inner folds and perform the model selection process.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Configurar la validación cruzada 5x2</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>k_outer <span class="ot">&lt;-</span> <span class="dv">5</span>  <span class="co"># Número de pliegues externos</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>k_inner <span class="ot">&lt;-</span> <span class="dv">2</span>  <span class="co"># Número de pliegues internos</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>folds_outer <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(data<span class="sc">$</span>ESTADO_ACTUAL, <span class="at">k =</span> k_outer, <span class="at">list =</span> <span class="cn">FALSE</span>)  <span class="co"># Obtener índices de pliegues externos</span></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Lista para almacenar resultados</span></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>resultados_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>resultados_sensibilidad <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>resultados_accuracy <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>indices <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data)</span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Inicializar matrices para almacenar predicciones y objetivos</span></span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a>predicciones_totales <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">nrow</span>(data), <span class="at">ncol =</span> k_outer)</span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a>targets_totales <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(data))</span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterar sobre cada pliegue externo y realizar el proceso de modelado</span></span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i_outer <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k_outer) {</span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-22"><a href="#cb63-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Obtener los índices para el pliegue externo actual</span></span>
<span id="cb63-23"><a href="#cb63-23" aria-hidden="true" tabindex="-1"></a>  test_indices_outer <span class="ot">&lt;-</span> indices[folds_outer<span class="sc">==</span>i_outer]  <span class="co"># Índices correspondientes al pliegue externo de test</span></span>
<span id="cb63-24"><a href="#cb63-24" aria-hidden="true" tabindex="-1"></a>  train_indices_outer <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data), test_indices_outer)  <span class="co"># Índices correspondientes al conjunto de entrenamiento</span></span>
<span id="cb63-25"><a href="#cb63-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-26"><a href="#cb63-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Dividir datos en entrenamiento y test para el pliegue externo</span></span>
<span id="cb63-27"><a href="#cb63-27" aria-hidden="true" tabindex="-1"></a>  datos_entrenamiento_outer <span class="ot">&lt;-</span> data[train_indices_outer, ]</span>
<span id="cb63-28"><a href="#cb63-28" aria-hidden="true" tabindex="-1"></a>  datos_test_outer <span class="ot">&lt;-</span> data[test_indices_outer, ]</span>
<span id="cb63-29"><a href="#cb63-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-30"><a href="#cb63-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-31"><a href="#cb63-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Configurar la validación cruzada interna</span></span>
<span id="cb63-32"><a href="#cb63-32" aria-hidden="true" tabindex="-1"></a>  folds_inner <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(datos_entrenamiento_outer<span class="sc">$</span>ESTADO_ACTUAL, <span class="at">k =</span> k_inner, <span class="at">list =</span> <span class="cn">FALSE</span>)  <span class="co"># Obtener índices de pliegues internos</span></span>
<span id="cb63-33"><a href="#cb63-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-34"><a href="#cb63-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Almacenar predicciones y test para formar una curva ROC general</span></span>
<span id="cb63-35"><a href="#cb63-35" aria-hidden="true" tabindex="-1"></a>  predicciones_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(datos_entrenamiento_outer))</span>
<span id="cb63-36"><a href="#cb63-36" aria-hidden="true" tabindex="-1"></a>  targets_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(datos_entrenamiento_outer))</span>
<span id="cb63-37"><a href="#cb63-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-38"><a href="#cb63-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Iterar sobre cada pliegue interno para selección de modelo</span></span>
<span id="cb63-39"><a href="#cb63-39" aria-hidden="true" tabindex="-1"></a>  indices_inner <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(datos_entrenamiento_outer)</span>
<span id="cb63-40"><a href="#cb63-40" aria-hidden="true" tabindex="-1"></a>  resultados_auc_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb63-41"><a href="#cb63-41" aria-hidden="true" tabindex="-1"></a>  resultados_sensibilidad_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb63-42"><a href="#cb63-42" aria-hidden="true" tabindex="-1"></a>  resultados_accuracy_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb63-43"><a href="#cb63-43" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i_inner <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k_inner) {</span>
<span id="cb63-44"><a href="#cb63-44" aria-hidden="true" tabindex="-1"></a>    filter_data <span class="ot">&lt;-</span> <span class="fu">filter_dependency</span>(datos_entrenamiento_outer,<span class="st">"ESTADO_ACTUAL"</span>,<span class="fu">colnames</span>(datos_entrenamiento_outer),<span class="fl">0.05</span>)</span>
<span id="cb63-45"><a href="#cb63-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="st">"ESTADO_ACTUAL.1"</span> <span class="sc">%in%</span> <span class="fu">colnames</span>(filter_data)) {</span>
<span id="cb63-46"><a href="#cb63-46" aria-hidden="true" tabindex="-1"></a>      filter_data <span class="ot">&lt;-</span> filter_data[, <span class="sc">!</span><span class="fu">colnames</span>(filter_data) <span class="sc">%in%</span> <span class="st">"ESTADO_ACTUAL.1"</span>, drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb63-47"><a href="#cb63-47" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb63-48"><a href="#cb63-48" aria-hidden="true" tabindex="-1"></a>    <span class="do">###############################</span></span>
<span id="cb63-49"><a href="#cb63-49" aria-hidden="true" tabindex="-1"></a>    <span class="do">#### Aqui el filtrado##########</span></span>
<span id="cb63-50"><a href="#cb63-50" aria-hidden="true" tabindex="-1"></a>    <span class="do">###############################</span></span>
<span id="cb63-51"><a href="#cb63-51" aria-hidden="true" tabindex="-1"></a><span class="co">#con poca variables solo unaa la vez o filtrado o wrapper</span></span>
<span id="cb63-52"><a href="#cb63-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-53"><a href="#cb63-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-54"><a href="#cb63-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-55"><a href="#cb63-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Obtener los índices para el pliegue interno actual</span></span>
<span id="cb63-56"><a href="#cb63-56" aria-hidden="true" tabindex="-1"></a>    test_indices_inner <span class="ot">&lt;-</span> indices_inner[folds_inner<span class="sc">==</span>i_inner]  <span class="co"># Índices correspondientes al pliegue interno de test</span></span>
<span id="cb63-57"><a href="#cb63-57" aria-hidden="true" tabindex="-1"></a>    train_indices_inner <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(filter_data), test_indices_inner)  <span class="co"># Índices correspondientes al conjunto de entrenamiento interno</span></span>
<span id="cb63-58"><a href="#cb63-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-59"><a href="#cb63-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Dividir datos en entrenamiento y test para el pliegue interno</span></span>
<span id="cb63-60"><a href="#cb63-60" aria-hidden="true" tabindex="-1"></a>    datos_entrenamiento_inner <span class="ot">&lt;-</span> filter_data[train_indices_inner, ]</span>
<span id="cb63-61"><a href="#cb63-61" aria-hidden="true" tabindex="-1"></a>    datos_validacion <span class="ot">&lt;-</span> filter_data[test_indices_inner, ]</span>
<span id="cb63-62"><a href="#cb63-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-63"><a href="#cb63-63" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb63-64"><a href="#cb63-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aplicar oversampling en el conjunto de entrenamiento interno</span></span>
<span id="cb63-65"><a href="#cb63-65" aria-hidden="true" tabindex="-1"></a>    datos_entrenamiento_oversampled <span class="ot">&lt;-</span> <span class="fu">ROSE</span>(ESTADO_ACTUAL <span class="sc">~</span> .,</span>
<span id="cb63-66"><a href="#cb63-66" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">data =</span> datos_entrenamiento_inner,</span>
<span id="cb63-67"><a href="#cb63-67" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">p =</span> <span class="fl">0.93</span>)<span class="sc">$</span>data</span>
<span id="cb63-68"><a href="#cb63-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-69"><a href="#cb63-69" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-70"><a href="#cb63-70" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ajustar el modelo logístico</span></span>
<span id="cb63-71"><a href="#cb63-71" aria-hidden="true" tabindex="-1"></a>    modelo_actual <span class="ot">&lt;-</span> <span class="fu">glm</span>(<span class="st">"ESTADO_ACTUAL ~ ."</span>, <span class="at">data =</span> datos_entrenamiento_oversampled, <span class="at">family =</span> <span class="fu">binomial</span>(<span class="st">"logit"</span>))</span>
<span id="cb63-72"><a href="#cb63-72" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-73"><a href="#cb63-73" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-74"><a href="#cb63-74" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-75"><a href="#cb63-75" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Realizar predicciones en el conjunto de entrenamiento externo para el AUC general</span></span>
<span id="cb63-76"><a href="#cb63-76" aria-hidden="true" tabindex="-1"></a>    predicciones_auc[test_indices_inner] <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelo_actual, <span class="at">newdata =</span> datos_validacion, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb63-77"><a href="#cb63-77" aria-hidden="true" tabindex="-1"></a>    predicciones_clasificadas <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predicciones_auc[test_indices_inner] <span class="sc">&gt;=</span> <span class="fl">0.5</span>, <span class="st">"SI"</span>, <span class="st">"NO"</span>)</span>
<span id="cb63-78"><a href="#cb63-78" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-79"><a href="#cb63-79" aria-hidden="true" tabindex="-1"></a>    resultados_sensibilidad_inner[i_inner] <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_clasificadas <span class="sc">==</span> <span class="st">"SI"</span> <span class="sc">&amp;</span> datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]] <span class="sc">==</span> <span class="st">"SI"</span>) <span class="sc">/</span> <span class="fu">sum</span>(datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]] <span class="sc">==</span> <span class="st">"SI"</span>)</span>
<span id="cb63-80"><a href="#cb63-80" aria-hidden="true" tabindex="-1"></a>    resultados_accuracy_inner[i_inner] <span class="ot">&lt;-</span> <span class="fu">mean</span>(predicciones_clasificadas <span class="sc">==</span> datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]])</span>
<span id="cb63-81"><a href="#cb63-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-82"><a href="#cb63-82" aria-hidden="true" tabindex="-1"></a>    targets_auc[test_indices_inner] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(datos_validacion<span class="sc">$</span>ESTADO_ACTUAL) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb63-83"><a href="#cb63-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-84"><a href="#cb63-84" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb63-85"><a href="#cb63-85" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-86"><a href="#cb63-86" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular el AUC final para este fold externo</span></span>
<span id="cb63-87"><a href="#cb63-87" aria-hidden="true" tabindex="-1"></a>  auc_fold_externo <span class="ot">&lt;-</span> pROC<span class="sc">::</span><span class="fu">roc</span>(targets_auc, predicciones_auc)<span class="sc">$</span>auc</span>
<span id="cb63-88"><a href="#cb63-88" aria-hidden="true" tabindex="-1"></a>  accuracy_fold_externo <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_accuracy_inner)</span>
<span id="cb63-89"><a href="#cb63-89" aria-hidden="true" tabindex="-1"></a>  sensibilidad_fold_externo <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_sensibilidad_inner)</span>
<span id="cb63-90"><a href="#cb63-90" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb63-91"><a href="#cb63-91" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-92"><a href="#cb63-92" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Almacenar el AUC del fold externo actual</span></span>
<span id="cb63-93"><a href="#cb63-93" aria-hidden="true" tabindex="-1"></a>  resultados_auc[i_outer] <span class="ot">&lt;-</span> auc_fold_externo</span>
<span id="cb63-94"><a href="#cb63-94" aria-hidden="true" tabindex="-1"></a>  resultados_accuracy[i_outer] <span class="ot">&lt;-</span> accuracy_fold_externo</span>
<span id="cb63-95"><a href="#cb63-95" aria-hidden="true" tabindex="-1"></a>  resultados_sensibilidad[i_outer] <span class="ot">&lt;-</span> sensibilidad_fold_externo</span>
<span id="cb63-96"><a href="#cb63-96" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-97"><a href="#cb63-97" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Predecir en los datos de test para este pliegue externo y almacenar predicciones</span></span>
<span id="cb63-98"><a href="#cb63-98" aria-hidden="true" tabindex="-1"></a>  predicciones_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelo_actual, <span class="at">newdata =</span> datos_test_outer, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb63-99"><a href="#cb63-99" aria-hidden="true" tabindex="-1"></a>  predicciones_totales[test_indices_outer, i_outer] <span class="ot">&lt;-</span> predicciones_test</span>
<span id="cb63-100"><a href="#cb63-100" aria-hidden="true" tabindex="-1"></a>  targets_totales[test_indices_outer] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(datos_test_outer<span class="sc">$</span>ESTADO_ACTUAL) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb63-101"><a href="#cb63-101" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb63-102"><a href="#cb63-102" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb63-103"><a href="#cb63-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-104"><a href="#cb63-104" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular AUC promedio</span></span>
<span id="cb63-105"><a href="#cb63-105" aria-hidden="true" tabindex="-1"></a>auc_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_auc)</span>
<span id="cb63-106"><a href="#cb63-106" aria-hidden="true" tabindex="-1"></a>accuracy_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_accuracy)</span>
<span id="cb63-107"><a href="#cb63-107" aria-hidden="true" tabindex="-1"></a>sensibilidad_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_sensibilidad)</span>
<span id="cb63-108"><a href="#cb63-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-109"><a href="#cb63-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-110"><a href="#cb63-110" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear tabla con todas las métricas</span></span>
<span id="cb63-111"><a href="#cb63-111" aria-hidden="true" tabindex="-1"></a>tabla_metricas <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb63-112"><a href="#cb63-112" aria-hidden="true" tabindex="-1"></a>  <span class="at">Pliegue =</span> <span class="dv">1</span><span class="sc">:</span>k_outer,</span>
<span id="cb63-113"><a href="#cb63-113" aria-hidden="true" tabindex="-1"></a>  <span class="at">AUC =</span> <span class="fu">sapply</span>(resultados_auc, round, <span class="at">digits =</span> <span class="dv">3</span>),</span>
<span id="cb63-114"><a href="#cb63-114" aria-hidden="true" tabindex="-1"></a>  <span class="at">Accuracy =</span> <span class="fu">sapply</span>(resultados_accuracy, round, <span class="at">digits =</span> <span class="dv">3</span>),</span>
<span id="cb63-115"><a href="#cb63-115" aria-hidden="true" tabindex="-1"></a>  <span class="at">Recall =</span> <span class="fu">sapply</span>(resultados_sensibilidad, round, <span class="at">digits =</span> <span class="dv">3</span>)</span>
<span id="cb63-116"><a href="#cb63-116" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb63-117"><a href="#cb63-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-118"><a href="#cb63-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-119"><a href="#cb63-119" aria-hidden="true" tabindex="-1"></a><span class="co"># Agregar fila con promedio de métricas</span></span>
<span id="cb63-120"><a href="#cb63-120" aria-hidden="true" tabindex="-1"></a>tabla_metricas_logistic_filter <span class="ot">&lt;-</span> <span class="fu">rbind</span>(tabla_metricas, <span class="fu">c</span>(<span class="st">"Mean"</span>, <span class="fu">round</span>(auc_promedio,<span class="dv">3</span>), <span class="fu">round</span>(accuracy_promedio,<span class="dv">3</span>), <span class="fu">round</span>(sensibilidad_promedio,<span class="dv">3</span>)))</span>
<span id="cb63-121"><a href="#cb63-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-122"><a href="#cb63-122" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb63-123"><a href="#cb63-123" aria-hidden="true" tabindex="-1"></a>execution_time_logistic_filter <span class="ot">&lt;-</span> end_time <span class="sc">-</span> start_time</span>
<span id="cb63-124"><a href="#cb63-124" aria-hidden="true" tabindex="-1"></a>execution_time_logistic_filter <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(execution_time_logistic_filter, <span class="at">units =</span> <span class="st">"secs"</span>)</span>
<span id="cb63-125"><a href="#cb63-125" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time_logistic_filter,  <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-7-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-7-1" role="tab" aria-controls="tabset-7-1" aria-selected="true" href="">Metrics Table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-7-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-7-2" role="tab" aria-controls="tabset-7-2" aria-selected="false" href="">Metrics Plot</a></li></ul>
<div class="tab-content">
<div id="tabset-7-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-7-1-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir tabla formateada con kableExtra</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(tabla_metricas_logistic_filter, <span class="at">caption =</span> <span class="st">"Cross Validation Metrics"</span>, <span class="at">align =</span> <span class="st">"c"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="tabset-7-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-7-2-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">crear_plot_metricas_per_fold</span>(tabla_metricas_logistic_filter)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
<p>Now we have proved the instability of the model.</p>
</div>
<div id="tabset-10-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-10-4-tab">
<p>We are going to select the most important variables with a embedded method.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Configurar la validación cruzada 5x2</span></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>k_outer <span class="ot">&lt;-</span> <span class="dv">5</span>  <span class="co"># Número de pliegues externos</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>k_inner <span class="ot">&lt;-</span> <span class="dv">2</span>  <span class="co"># Número de pliegues internos</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>folds_outer <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(data<span class="sc">$</span>ESTADO_ACTUAL, <span class="at">k =</span> k_outer, <span class="at">list =</span> <span class="cn">FALSE</span>)  <span class="co"># Obtener índices de pliegues externos</span></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Lista para almacenar resultados</span></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>resultados_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>resultados_sensibilidad <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>resultados_accuracy <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>indices <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data)</span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Inicializar matrices para almacenar predicciones y objetivos</span></span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a>predicciones_totales <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">nrow</span>(data), <span class="at">ncol =</span> k_outer)</span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a>targets_totales <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(data))</span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterar sobre cada pliegue externo y realizar el proceso de modelado</span></span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i_outer <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k_outer) {</span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Obtener los índices para el pliegue externo actual</span></span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true" tabindex="-1"></a>  test_indices_outer <span class="ot">&lt;-</span> indices[folds_outer<span class="sc">==</span>i_outer]  <span class="co"># Índices correspondientes al pliegue externo de test</span></span>
<span id="cb66-24"><a href="#cb66-24" aria-hidden="true" tabindex="-1"></a>  train_indices_outer <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data), test_indices_outer)  <span class="co"># Índices correspondientes al conjunto de entrenamiento</span></span>
<span id="cb66-25"><a href="#cb66-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-26"><a href="#cb66-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Dividir datos en entrenamiento y test para el pliegue externo</span></span>
<span id="cb66-27"><a href="#cb66-27" aria-hidden="true" tabindex="-1"></a>  datos_entrenamiento_outer <span class="ot">&lt;-</span> data[train_indices_outer, ]</span>
<span id="cb66-28"><a href="#cb66-28" aria-hidden="true" tabindex="-1"></a>  datos_test_outer <span class="ot">&lt;-</span> data[test_indices_outer, ]</span>
<span id="cb66-29"><a href="#cb66-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-30"><a href="#cb66-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-31"><a href="#cb66-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Configurar la validación cruzada interna</span></span>
<span id="cb66-32"><a href="#cb66-32" aria-hidden="true" tabindex="-1"></a>  folds_inner <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(datos_entrenamiento_outer<span class="sc">$</span>ESTADO_ACTUAL, <span class="at">k =</span> k_inner, <span class="at">list =</span> <span class="cn">FALSE</span>)  <span class="co"># Obtener índices de pliegues internos</span></span>
<span id="cb66-33"><a href="#cb66-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-34"><a href="#cb66-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Almacenar predicciones y test para formar una curva ROC general</span></span>
<span id="cb66-35"><a href="#cb66-35" aria-hidden="true" tabindex="-1"></a>  predicciones_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(datos_entrenamiento_outer))</span>
<span id="cb66-36"><a href="#cb66-36" aria-hidden="true" tabindex="-1"></a>  targets_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(datos_entrenamiento_outer))</span>
<span id="cb66-37"><a href="#cb66-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-38"><a href="#cb66-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Iterar sobre cada pliegue interno para selección de modelo</span></span>
<span id="cb66-39"><a href="#cb66-39" aria-hidden="true" tabindex="-1"></a>  indices_inner <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(datos_entrenamiento_outer)</span>
<span id="cb66-40"><a href="#cb66-40" aria-hidden="true" tabindex="-1"></a>  resultados_auc_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb66-41"><a href="#cb66-41" aria-hidden="true" tabindex="-1"></a>  resultados_sensibilidad_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb66-42"><a href="#cb66-42" aria-hidden="true" tabindex="-1"></a>  resultados_accuracy_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb66-43"><a href="#cb66-43" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i_inner <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k_inner) {</span>
<span id="cb66-44"><a href="#cb66-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-45"><a href="#cb66-45" aria-hidden="true" tabindex="-1"></a>    variables_importantes <span class="ot">&lt;-</span> <span class="fu">seleccionar_variables_importantes</span>(datos_entrenamiento_outer,<span class="st">"ESTADO_ACTUAL"</span>,<span class="dv">6</span>)</span>
<span id="cb66-46"><a href="#cb66-46" aria-hidden="true" tabindex="-1"></a>    filter_data <span class="ot">&lt;-</span> datos_entrenamiento_outer[,<span class="fu">c</span>(<span class="st">"ESTADO_ACTUAL"</span>,variables_importantes)]</span>
<span id="cb66-47"><a href="#cb66-47" aria-hidden="true" tabindex="-1"></a>    <span class="do">###############################</span></span>
<span id="cb66-48"><a href="#cb66-48" aria-hidden="true" tabindex="-1"></a>    <span class="do">#### Aqui el filtrado##########</span></span>
<span id="cb66-49"><a href="#cb66-49" aria-hidden="true" tabindex="-1"></a>    <span class="do">###############################</span></span>
<span id="cb66-50"><a href="#cb66-50" aria-hidden="true" tabindex="-1"></a><span class="co">#con poca variables solo unaa la vez o filtrado o wrapper</span></span>
<span id="cb66-51"><a href="#cb66-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-52"><a href="#cb66-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-53"><a href="#cb66-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-54"><a href="#cb66-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Obtener los índices para el pliegue interno actual</span></span>
<span id="cb66-55"><a href="#cb66-55" aria-hidden="true" tabindex="-1"></a>    test_indices_inner <span class="ot">&lt;-</span> indices_inner[folds_inner<span class="sc">==</span>i_inner]  <span class="co"># Índices correspondientes al pliegue interno de test</span></span>
<span id="cb66-56"><a href="#cb66-56" aria-hidden="true" tabindex="-1"></a>    train_indices_inner <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(filter_data), test_indices_inner)  <span class="co"># Índices correspondientes al conjunto de entrenamiento interno</span></span>
<span id="cb66-57"><a href="#cb66-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-58"><a href="#cb66-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Dividir datos en entrenamiento y test para el pliegue interno</span></span>
<span id="cb66-59"><a href="#cb66-59" aria-hidden="true" tabindex="-1"></a>    datos_entrenamiento_inner <span class="ot">&lt;-</span> filter_data[train_indices_inner, ]</span>
<span id="cb66-60"><a href="#cb66-60" aria-hidden="true" tabindex="-1"></a>    datos_validacion <span class="ot">&lt;-</span> filter_data[test_indices_inner, ]</span>
<span id="cb66-61"><a href="#cb66-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-62"><a href="#cb66-62" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb66-63"><a href="#cb66-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aplicar oversampling en el conjunto de entrenamiento interno</span></span>
<span id="cb66-64"><a href="#cb66-64" aria-hidden="true" tabindex="-1"></a>    datos_entrenamiento_oversampled <span class="ot">&lt;-</span> <span class="fu">ROSE</span>(ESTADO_ACTUAL <span class="sc">~</span> .,</span>
<span id="cb66-65"><a href="#cb66-65" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">data =</span> datos_entrenamiento_inner,</span>
<span id="cb66-66"><a href="#cb66-66" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">p =</span> <span class="fl">0.28</span>)<span class="sc">$</span>data</span>
<span id="cb66-67"><a href="#cb66-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-68"><a href="#cb66-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-69"><a href="#cb66-69" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ajustar el modelo logístico</span></span>
<span id="cb66-70"><a href="#cb66-70" aria-hidden="true" tabindex="-1"></a>    modelo_actual <span class="ot">&lt;-</span> <span class="fu">glm</span>(<span class="st">"ESTADO_ACTUAL ~ ."</span>, <span class="at">data =</span> datos_entrenamiento_oversampled, <span class="at">family =</span> <span class="fu">binomial</span>(<span class="st">"logit"</span>))</span>
<span id="cb66-71"><a href="#cb66-71" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-72"><a href="#cb66-72" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Predecir y calcular el AUC en los datos de validación</span></span>
<span id="cb66-73"><a href="#cb66-73" aria-hidden="true" tabindex="-1"></a>    predicciones_validacion <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelo_actual, <span class="at">newdata =</span> datos_validacion, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb66-74"><a href="#cb66-74" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-75"><a href="#cb66-75" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calcular el AUC</span></span>
<span id="cb66-76"><a href="#cb66-76" aria-hidden="true" tabindex="-1"></a>    auc_actual <span class="ot">&lt;-</span> pROC<span class="sc">::</span><span class="fu">roc</span>(<span class="fu">as.numeric</span>(datos_validacion<span class="sc">$</span>ESTADO_ACTUAL) <span class="sc">-</span> <span class="dv">1</span>, predicciones_validacion)<span class="sc">$</span>auc</span>
<span id="cb66-77"><a href="#cb66-77" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-78"><a href="#cb66-78" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Actualizar el mejor AUC y el mejor modelo si es necesario</span></span>
<span id="cb66-79"><a href="#cb66-79" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-80"><a href="#cb66-80" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-81"><a href="#cb66-81" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Realizar predicciones en el conjunto de entrenamiento externo para el AUC general</span></span>
<span id="cb66-82"><a href="#cb66-82" aria-hidden="true" tabindex="-1"></a>    predicciones_auc[test_indices_inner] <span class="ot">&lt;-</span> <span class="fu">predict</span>(mejor_modelo_auc, <span class="at">newdata =</span> datos_validacion, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb66-83"><a href="#cb66-83" aria-hidden="true" tabindex="-1"></a>    predicciones_clasificadas <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predicciones_auc[test_indices_inner] <span class="sc">&gt;=</span> <span class="fl">0.5</span>, <span class="st">"SI"</span>, <span class="st">"NO"</span>)</span>
<span id="cb66-84"><a href="#cb66-84" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-85"><a href="#cb66-85" aria-hidden="true" tabindex="-1"></a>    resultados_sensibilidad_inner[i_inner] <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_clasificadas <span class="sc">==</span> <span class="st">"SI"</span> <span class="sc">&amp;</span> datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]] <span class="sc">==</span> <span class="st">"SI"</span>) <span class="sc">/</span> <span class="fu">sum</span>(datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]] <span class="sc">==</span> <span class="st">"SI"</span>)</span>
<span id="cb66-86"><a href="#cb66-86" aria-hidden="true" tabindex="-1"></a>    resultados_accuracy_inner[i_inner] <span class="ot">&lt;-</span> <span class="fu">mean</span>(predicciones_clasificadas <span class="sc">==</span> datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]])</span>
<span id="cb66-87"><a href="#cb66-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-88"><a href="#cb66-88" aria-hidden="true" tabindex="-1"></a>    targets_auc[test_indices_inner] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(datos_validacion<span class="sc">$</span>ESTADO_ACTUAL) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb66-89"><a href="#cb66-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-90"><a href="#cb66-90" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb66-91"><a href="#cb66-91" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-92"><a href="#cb66-92" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular el AUC final para este fold externo</span></span>
<span id="cb66-93"><a href="#cb66-93" aria-hidden="true" tabindex="-1"></a>  auc_fold_externo <span class="ot">&lt;-</span> pROC<span class="sc">::</span><span class="fu">roc</span>(targets_auc, predicciones_auc)<span class="sc">$</span>auc</span>
<span id="cb66-94"><a href="#cb66-94" aria-hidden="true" tabindex="-1"></a>  accuracy_fold_externo <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_accuracy_inner)</span>
<span id="cb66-95"><a href="#cb66-95" aria-hidden="true" tabindex="-1"></a>  sensibilidad_fold_externo <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_sensibilidad_inner)</span>
<span id="cb66-96"><a href="#cb66-96" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb66-97"><a href="#cb66-97" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-98"><a href="#cb66-98" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Almacenar el AUC del fold externo actual</span></span>
<span id="cb66-99"><a href="#cb66-99" aria-hidden="true" tabindex="-1"></a>  resultados_auc[i_outer] <span class="ot">&lt;-</span> auc_fold_externo</span>
<span id="cb66-100"><a href="#cb66-100" aria-hidden="true" tabindex="-1"></a>  resultados_accuracy[i_outer] <span class="ot">&lt;-</span> accuracy_fold_externo</span>
<span id="cb66-101"><a href="#cb66-101" aria-hidden="true" tabindex="-1"></a>  resultados_sensibilidad[i_outer] <span class="ot">&lt;-</span> sensibilidad_fold_externo</span>
<span id="cb66-102"><a href="#cb66-102" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-103"><a href="#cb66-103" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Predecir en los datos de test para este pliegue externo y almacenar predicciones</span></span>
<span id="cb66-104"><a href="#cb66-104" aria-hidden="true" tabindex="-1"></a>  predicciones_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(mejor_modelo_auc, <span class="at">newdata =</span> datos_test_outer, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb66-105"><a href="#cb66-105" aria-hidden="true" tabindex="-1"></a>  predicciones_totales[test_indices_outer, i_outer] <span class="ot">&lt;-</span> predicciones_test</span>
<span id="cb66-106"><a href="#cb66-106" aria-hidden="true" tabindex="-1"></a>  targets_totales[test_indices_outer] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(datos_test_outer<span class="sc">$</span>ESTADO_ACTUAL) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb66-107"><a href="#cb66-107" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb66-108"><a href="#cb66-108" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb66-109"><a href="#cb66-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-110"><a href="#cb66-110" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular AUC promedio</span></span>
<span id="cb66-111"><a href="#cb66-111" aria-hidden="true" tabindex="-1"></a>auc_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_auc)</span>
<span id="cb66-112"><a href="#cb66-112" aria-hidden="true" tabindex="-1"></a>accuracy_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_accuracy)</span>
<span id="cb66-113"><a href="#cb66-113" aria-hidden="true" tabindex="-1"></a>sensibilidad_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_sensibilidad)</span>
<span id="cb66-114"><a href="#cb66-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-115"><a href="#cb66-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-116"><a href="#cb66-116" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear tabla con todas las métricas</span></span>
<span id="cb66-117"><a href="#cb66-117" aria-hidden="true" tabindex="-1"></a>tabla_metricas <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb66-118"><a href="#cb66-118" aria-hidden="true" tabindex="-1"></a>  <span class="at">Pliegue =</span> <span class="dv">1</span><span class="sc">:</span>k_outer,</span>
<span id="cb66-119"><a href="#cb66-119" aria-hidden="true" tabindex="-1"></a>  <span class="at">AUC =</span> <span class="fu">sapply</span>(resultados_auc, round, <span class="at">digits =</span> <span class="dv">3</span>),</span>
<span id="cb66-120"><a href="#cb66-120" aria-hidden="true" tabindex="-1"></a>  <span class="at">Accuracy =</span> <span class="fu">sapply</span>(resultados_accuracy, round, <span class="at">digits =</span> <span class="dv">3</span>),</span>
<span id="cb66-121"><a href="#cb66-121" aria-hidden="true" tabindex="-1"></a>  <span class="at">Recall =</span> <span class="fu">sapply</span>(resultados_sensibilidad, round, <span class="at">digits =</span> <span class="dv">3</span>)</span>
<span id="cb66-122"><a href="#cb66-122" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb66-123"><a href="#cb66-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-124"><a href="#cb66-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-125"><a href="#cb66-125" aria-hidden="true" tabindex="-1"></a><span class="co"># Agregar fila con promedio de métricas</span></span>
<span id="cb66-126"><a href="#cb66-126" aria-hidden="true" tabindex="-1"></a>tabla_metricas_logistic_embeded <span class="ot">&lt;-</span> <span class="fu">rbind</span>(tabla_metricas, <span class="fu">c</span>(<span class="st">"Mean"</span>, <span class="fu">round</span>(auc_promedio,<span class="dv">3</span>), <span class="fu">round</span>(accuracy_promedio,<span class="dv">3</span>), <span class="fu">round</span>(sensibilidad_promedio,<span class="dv">3</span>)))</span>
<span id="cb66-127"><a href="#cb66-127" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(tabla_metricas_logistic_embeded, <span class="at">file =</span> <span class="st">"tabla_metricas_logistic_embeded.RData"</span>)</span>
<span id="cb66-128"><a href="#cb66-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-129"><a href="#cb66-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-130"><a href="#cb66-130" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb66-131"><a href="#cb66-131" aria-hidden="true" tabindex="-1"></a>execution_time_logistic_embeded <span class="ot">&lt;-</span> end_time <span class="sc">-</span> start_time</span>
<span id="cb66-132"><a href="#cb66-132" aria-hidden="true" tabindex="-1"></a>execution_time_logistic_embeded <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(execution_time_logistic_embeded, <span class="at">units =</span> <span class="st">"secs"</span>)</span>
<span id="cb66-133"><a href="#cb66-133" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(execution_time_logistic_embeded, <span class="at">file =</span> <span class="st">"execution_time_logistic_embeded.RData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"tabla_metricas_logistic_embeded.RData"</span>)</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"execution_time_logistic_embeded.RData"</span>)</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time_logistic_embeded,  <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-8-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-8-1" role="tab" aria-controls="tabset-8-1" aria-selected="true" href="">Metrics Table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-8-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-8-2" role="tab" aria-controls="tabset-8-2" aria-selected="false" href="">Metrics Plot</a></li></ul>
<div class="tab-content">
<div id="tabset-8-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-8-1-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir tabla formateada con kableExtra</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(tabla_metricas_logistic_embeded, <span class="at">caption =</span> <span class="st">"Cross Validation Metrics"</span>, <span class="at">align =</span> <span class="st">"c"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="tabset-8-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-8-2-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">crear_plot_metricas_per_fold</span>(tabla_metricas_logistic_embeded)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
<p>The result is worse in this case and the execution time is higher due to the time spent in the variable selection.</p>
</div>
<div id="tabset-10-5" class="tab-pane" role="tabpanel" aria-labelledby="tabset-10-5-tab">
<p>Finally, we are going to honestly measure the performance of the model with bruteforce variable selection.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Establecer la fórmula base para el modelo logístico</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>formula_base <span class="ot">&lt;-</span> <span class="fu">formula</span>(ESTADO_ACTUAL <span class="sc">~</span> <span class="dv">1</span>)  <span class="co"># Fórmula inicial sin predictoras</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtener nombres de variables predictoras</span></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>variables <span class="ot">&lt;-</span> <span class="fu">names</span>(data)[<span class="sc">-</span><span class="fu">which</span>(<span class="fu">names</span>(data) <span class="sc">==</span> <span class="st">"ESTADO_ACTUAL"</span>)]</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtener todas las combinaciones posibles de variables predictoras</span></span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>combinaciones_variables <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(variables), <span class="cf">function</span>(x) <span class="fu">combn</span>(variables, x, <span class="at">simplify =</span> <span class="cn">FALSE</span>)), <span class="at">recursive =</span> <span class="cn">FALSE</span>)</span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Configurar la validación cruzada 5x2</span></span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>k_outer <span class="ot">&lt;-</span> <span class="dv">5</span>  <span class="co"># Número de pliegues externos</span></span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a>k_inner <span class="ot">&lt;-</span> <span class="dv">2</span>  <span class="co"># Número de pliegues internos</span></span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a>folds_outer <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(data<span class="sc">$</span>ESTADO_ACTUAL, <span class="at">k =</span> k_outer, <span class="at">list =</span> <span class="cn">FALSE</span>)  <span class="co"># Obtener índices de pliegues externos</span></span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Lista para almacenar resultados</span></span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a>resultados_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a>resultados_sensibilidad <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a>resultados_accuracy <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a>indices <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data)</span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-24"><a href="#cb70-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Inicializar matrices para almacenar predicciones y objetivos</span></span>
<span id="cb70-25"><a href="#cb70-25" aria-hidden="true" tabindex="-1"></a>predicciones_totales <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">nrow</span>(data), <span class="at">ncol =</span> k_outer)</span>
<span id="cb70-26"><a href="#cb70-26" aria-hidden="true" tabindex="-1"></a>targets_totales <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(data))</span>
<span id="cb70-27"><a href="#cb70-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-28"><a href="#cb70-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterar sobre cada pliegue externo y realizar el proceso de modelado</span></span>
<span id="cb70-29"><a href="#cb70-29" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i_outer <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k_outer) {</span>
<span id="cb70-30"><a href="#cb70-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-31"><a href="#cb70-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Obtener los índices para el pliegue externo actual</span></span>
<span id="cb70-32"><a href="#cb70-32" aria-hidden="true" tabindex="-1"></a>  test_indices_outer <span class="ot">&lt;-</span> indices[folds_outer<span class="sc">==</span>i_outer]  <span class="co"># Índices correspondientes al pliegue externo de test</span></span>
<span id="cb70-33"><a href="#cb70-33" aria-hidden="true" tabindex="-1"></a>  train_indices_outer <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data), test_indices_outer)  <span class="co"># Índices correspondientes al conjunto de entrenamiento</span></span>
<span id="cb70-34"><a href="#cb70-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-35"><a href="#cb70-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Dividir datos en entrenamiento y test para el pliegue externo</span></span>
<span id="cb70-36"><a href="#cb70-36" aria-hidden="true" tabindex="-1"></a>  datos_entrenamiento_outer <span class="ot">&lt;-</span> data[train_indices_outer, ]</span>
<span id="cb70-37"><a href="#cb70-37" aria-hidden="true" tabindex="-1"></a>  datos_test_outer <span class="ot">&lt;-</span> data[test_indices_outer, ]</span>
<span id="cb70-38"><a href="#cb70-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-39"><a href="#cb70-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-40"><a href="#cb70-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Configurar la validación cruzada interna</span></span>
<span id="cb70-41"><a href="#cb70-41" aria-hidden="true" tabindex="-1"></a>  folds_inner <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(datos_entrenamiento_outer<span class="sc">$</span>ESTADO_ACTUAL, <span class="at">k =</span> k_inner, <span class="at">list =</span> <span class="cn">FALSE</span>)  <span class="co"># Obtener índices de pliegues internos</span></span>
<span id="cb70-42"><a href="#cb70-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-43"><a href="#cb70-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Almacenar predicciones y test para formar una curva ROC general</span></span>
<span id="cb70-44"><a href="#cb70-44" aria-hidden="true" tabindex="-1"></a>  predicciones_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(datos_entrenamiento_outer))</span>
<span id="cb70-45"><a href="#cb70-45" aria-hidden="true" tabindex="-1"></a>  targets_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(datos_entrenamiento_outer))</span>
<span id="cb70-46"><a href="#cb70-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-47"><a href="#cb70-47" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Iterar sobre cada pliegue interno para selección de modelo</span></span>
<span id="cb70-48"><a href="#cb70-48" aria-hidden="true" tabindex="-1"></a>  indices_inner <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(datos_entrenamiento_outer)</span>
<span id="cb70-49"><a href="#cb70-49" aria-hidden="true" tabindex="-1"></a>  resultados_auc_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb70-50"><a href="#cb70-50" aria-hidden="true" tabindex="-1"></a>  resultados_sensibilidad_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb70-51"><a href="#cb70-51" aria-hidden="true" tabindex="-1"></a>  resultados_accuracy_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb70-52"><a href="#cb70-52" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i_inner <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k_inner) {</span>
<span id="cb70-53"><a href="#cb70-53" aria-hidden="true" tabindex="-1"></a>    <span class="do">###############################</span></span>
<span id="cb70-54"><a href="#cb70-54" aria-hidden="true" tabindex="-1"></a>    <span class="do">#### Aqui el filtrado##########</span></span>
<span id="cb70-55"><a href="#cb70-55" aria-hidden="true" tabindex="-1"></a>    <span class="do">###############################</span></span>
<span id="cb70-56"><a href="#cb70-56" aria-hidden="true" tabindex="-1"></a><span class="co">#con poca variables solo unaa la vez o filtrado o wrapper</span></span>
<span id="cb70-57"><a href="#cb70-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-58"><a href="#cb70-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-59"><a href="#cb70-59" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-60"><a href="#cb70-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Obtener los índices para el pliegue interno actual</span></span>
<span id="cb70-61"><a href="#cb70-61" aria-hidden="true" tabindex="-1"></a>    test_indices_inner <span class="ot">&lt;-</span> indices_inner[folds_inner<span class="sc">==</span>i_inner]  <span class="co"># Índices correspondientes al pliegue interno de test</span></span>
<span id="cb70-62"><a href="#cb70-62" aria-hidden="true" tabindex="-1"></a>    train_indices_inner <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(datos_entrenamiento_outer), test_indices_inner)  <span class="co"># Índices correspondientes al conjunto de entrenamiento interno</span></span>
<span id="cb70-63"><a href="#cb70-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-64"><a href="#cb70-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Dividir datos en entrenamiento y test para el pliegue interno</span></span>
<span id="cb70-65"><a href="#cb70-65" aria-hidden="true" tabindex="-1"></a>    datos_entrenamiento_inner <span class="ot">&lt;-</span> datos_entrenamiento_outer[train_indices_inner, ]</span>
<span id="cb70-66"><a href="#cb70-66" aria-hidden="true" tabindex="-1"></a>    datos_validacion <span class="ot">&lt;-</span> datos_entrenamiento_outer[test_indices_inner, ]</span>
<span id="cb70-67"><a href="#cb70-67" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-68"><a href="#cb70-68" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb70-69"><a href="#cb70-69" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aplicar oversampling en el conjunto de entrenamiento interno</span></span>
<span id="cb70-70"><a href="#cb70-70" aria-hidden="true" tabindex="-1"></a>    datos_entrenamiento_oversampled <span class="ot">&lt;-</span> <span class="fu">ROSE</span>(ESTADO_ACTUAL <span class="sc">~</span> .,</span>
<span id="cb70-71"><a href="#cb70-71" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">data =</span> datos_entrenamiento_inner,</span>
<span id="cb70-72"><a href="#cb70-72" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">p =</span> <span class="fl">0.28</span>)<span class="sc">$</span>data</span>
<span id="cb70-73"><a href="#cb70-73" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-74"><a href="#cb70-74" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Inicializar variables para almacenar el mejor modelo y su métrica asociada</span></span>
<span id="cb70-75"><a href="#cb70-75" aria-hidden="true" tabindex="-1"></a>    mejor_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb70-76"><a href="#cb70-76" aria-hidden="true" tabindex="-1"></a>    mejor_modelo_auc <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb70-77"><a href="#cb70-77" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-78"><a href="#cb70-78" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Iterar sobre todas las combinaciones de variables</span></span>
<span id="cb70-79"><a href="#cb70-79" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (combinacion <span class="cf">in</span> combinaciones_variables) {</span>
<span id="cb70-80"><a href="#cb70-80" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Construir la fórmula con las variables actuales</span></span>
<span id="cb70-81"><a href="#cb70-81" aria-hidden="true" tabindex="-1"></a>      formula_actual <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(<span class="st">"ESTADO_ACTUAL"</span>, <span class="st">"~"</span>, <span class="fu">paste</span>(combinacion, <span class="at">collapse =</span> <span class="st">"+"</span>)))</span>
<span id="cb70-82"><a href="#cb70-82" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb70-83"><a href="#cb70-83" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Ajustar el modelo logístico</span></span>
<span id="cb70-84"><a href="#cb70-84" aria-hidden="true" tabindex="-1"></a>      modelo_actual <span class="ot">&lt;-</span> <span class="fu">glm</span>(formula_actual, <span class="at">data =</span> datos_entrenamiento_oversampled, <span class="at">family =</span> <span class="fu">binomial</span>(<span class="st">"logit"</span>))</span>
<span id="cb70-85"><a href="#cb70-85" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb70-86"><a href="#cb70-86" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Predecir y calcular el AUC en los datos de validación</span></span>
<span id="cb70-87"><a href="#cb70-87" aria-hidden="true" tabindex="-1"></a>      predicciones_validacion <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelo_actual, <span class="at">newdata =</span> datos_validacion, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb70-88"><a href="#cb70-88" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb70-89"><a href="#cb70-89" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Calcular el AUC</span></span>
<span id="cb70-90"><a href="#cb70-90" aria-hidden="true" tabindex="-1"></a>      auc_actual <span class="ot">&lt;-</span> pROC<span class="sc">::</span><span class="fu">roc</span>(<span class="fu">as.numeric</span>(datos_validacion<span class="sc">$</span>ESTADO_ACTUAL) <span class="sc">-</span> <span class="dv">1</span>, predicciones_validacion)<span class="sc">$</span>auc</span>
<span id="cb70-91"><a href="#cb70-91" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb70-92"><a href="#cb70-92" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Actualizar el mejor AUC y el mejor modelo si es necesario</span></span>
<span id="cb70-93"><a href="#cb70-93" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (auc_actual <span class="sc">&gt;</span> mejor_auc) {</span>
<span id="cb70-94"><a href="#cb70-94" aria-hidden="true" tabindex="-1"></a>        mejor_auc <span class="ot">&lt;-</span> auc_actual</span>
<span id="cb70-95"><a href="#cb70-95" aria-hidden="true" tabindex="-1"></a>        mejor_modelo_auc <span class="ot">&lt;-</span> modelo_actual</span>
<span id="cb70-96"><a href="#cb70-96" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb70-97"><a href="#cb70-97" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb70-98"><a href="#cb70-98" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-99"><a href="#cb70-99" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Realizar predicciones en el conjunto de entrenamiento externo para el AUC general</span></span>
<span id="cb70-100"><a href="#cb70-100" aria-hidden="true" tabindex="-1"></a>    predicciones_auc[test_indices_inner] <span class="ot">&lt;-</span> <span class="fu">predict</span>(mejor_modelo_auc, <span class="at">newdata =</span> datos_validacion, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb70-101"><a href="#cb70-101" aria-hidden="true" tabindex="-1"></a>    predicciones_clasificadas <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predicciones_auc[test_indices_inner] <span class="sc">&gt;=</span> <span class="fl">0.5</span>, <span class="st">"SI"</span>, <span class="st">"NO"</span>)</span>
<span id="cb70-102"><a href="#cb70-102" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-103"><a href="#cb70-103" aria-hidden="true" tabindex="-1"></a>    resultados_sensibilidad_inner[i_inner] <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_clasificadas <span class="sc">==</span> <span class="st">"SI"</span> <span class="sc">&amp;</span> datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]] <span class="sc">==</span> <span class="st">"SI"</span>) <span class="sc">/</span> <span class="fu">sum</span>(datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]] <span class="sc">==</span> <span class="st">"SI"</span>)</span>
<span id="cb70-104"><a href="#cb70-104" aria-hidden="true" tabindex="-1"></a>    resultados_accuracy_inner[i_inner] <span class="ot">&lt;-</span> <span class="fu">mean</span>(predicciones_clasificadas <span class="sc">==</span> datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]])</span>
<span id="cb70-105"><a href="#cb70-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-106"><a href="#cb70-106" aria-hidden="true" tabindex="-1"></a>    targets_auc[test_indices_inner] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(datos_validacion<span class="sc">$</span>ESTADO_ACTUAL) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb70-107"><a href="#cb70-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-108"><a href="#cb70-108" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb70-109"><a href="#cb70-109" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-110"><a href="#cb70-110" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular el AUC final para este fold externo</span></span>
<span id="cb70-111"><a href="#cb70-111" aria-hidden="true" tabindex="-1"></a>  auc_fold_externo <span class="ot">&lt;-</span> pROC<span class="sc">::</span><span class="fu">roc</span>(targets_auc, predicciones_auc)<span class="sc">$</span>auc</span>
<span id="cb70-112"><a href="#cb70-112" aria-hidden="true" tabindex="-1"></a>  accuracy_fold_externo <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_accuracy_inner)</span>
<span id="cb70-113"><a href="#cb70-113" aria-hidden="true" tabindex="-1"></a>  sensibilidad_fold_externo <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_sensibilidad_inner)</span>
<span id="cb70-114"><a href="#cb70-114" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb70-115"><a href="#cb70-115" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-116"><a href="#cb70-116" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Almacenar el AUC del fold externo actual</span></span>
<span id="cb70-117"><a href="#cb70-117" aria-hidden="true" tabindex="-1"></a>  resultados_auc[i_outer] <span class="ot">&lt;-</span> auc_fold_externo</span>
<span id="cb70-118"><a href="#cb70-118" aria-hidden="true" tabindex="-1"></a>  resultados_accuracy[i_outer] <span class="ot">&lt;-</span> accuracy_fold_externo</span>
<span id="cb70-119"><a href="#cb70-119" aria-hidden="true" tabindex="-1"></a>  resultados_sensibilidad[i_outer] <span class="ot">&lt;-</span> sensibilidad_fold_externo</span>
<span id="cb70-120"><a href="#cb70-120" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-121"><a href="#cb70-121" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Predecir en los datos de test para este pliegue externo y almacenar predicciones</span></span>
<span id="cb70-122"><a href="#cb70-122" aria-hidden="true" tabindex="-1"></a>  predicciones_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(mejor_modelo_auc, <span class="at">newdata =</span> datos_test_outer, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb70-123"><a href="#cb70-123" aria-hidden="true" tabindex="-1"></a>  predicciones_totales[test_indices_outer, i_outer] <span class="ot">&lt;-</span> predicciones_test</span>
<span id="cb70-124"><a href="#cb70-124" aria-hidden="true" tabindex="-1"></a>  targets_totales[test_indices_outer] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(datos_test_outer<span class="sc">$</span>ESTADO_ACTUAL) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb70-125"><a href="#cb70-125" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb70-126"><a href="#cb70-126" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb70-127"><a href="#cb70-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-128"><a href="#cb70-128" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular AUC promedio</span></span>
<span id="cb70-129"><a href="#cb70-129" aria-hidden="true" tabindex="-1"></a>auc_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_auc)</span>
<span id="cb70-130"><a href="#cb70-130" aria-hidden="true" tabindex="-1"></a>accuracy_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_accuracy)</span>
<span id="cb70-131"><a href="#cb70-131" aria-hidden="true" tabindex="-1"></a>sensibilidad_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_sensibilidad)</span>
<span id="cb70-132"><a href="#cb70-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-133"><a href="#cb70-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-134"><a href="#cb70-134" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear tabla con todas las métricas</span></span>
<span id="cb70-135"><a href="#cb70-135" aria-hidden="true" tabindex="-1"></a>tabla_metricas <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb70-136"><a href="#cb70-136" aria-hidden="true" tabindex="-1"></a>  <span class="at">Pliegue =</span> <span class="dv">1</span><span class="sc">:</span>k_outer,</span>
<span id="cb70-137"><a href="#cb70-137" aria-hidden="true" tabindex="-1"></a>  <span class="at">AUC =</span> <span class="fu">sapply</span>(resultados_auc, round, <span class="at">digits =</span> <span class="dv">3</span>),</span>
<span id="cb70-138"><a href="#cb70-138" aria-hidden="true" tabindex="-1"></a>  <span class="at">Accuracy =</span> <span class="fu">sapply</span>(resultados_accuracy, round, <span class="at">digits =</span> <span class="dv">3</span>),</span>
<span id="cb70-139"><a href="#cb70-139" aria-hidden="true" tabindex="-1"></a>  <span class="at">Recall =</span> <span class="fu">sapply</span>(resultados_sensibilidad, round, <span class="at">digits =</span> <span class="dv">3</span>)</span>
<span id="cb70-140"><a href="#cb70-140" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-141"><a href="#cb70-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-142"><a href="#cb70-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-143"><a href="#cb70-143" aria-hidden="true" tabindex="-1"></a><span class="co"># Agregar fila con promedio de métricas</span></span>
<span id="cb70-144"><a href="#cb70-144" aria-hidden="true" tabindex="-1"></a>tabla_metricas_logistic_wrapper <span class="ot">&lt;-</span> <span class="fu">rbind</span>(tabla_metricas, <span class="fu">c</span>(<span class="st">"Mean"</span>, <span class="fu">round</span>(auc_promedio,<span class="dv">3</span>), <span class="fu">round</span>(accuracy_promedio,<span class="dv">3</span>), <span class="fu">round</span>(sensibilidad_promedio,<span class="dv">3</span>)))</span>
<span id="cb70-145"><a href="#cb70-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-146"><a href="#cb70-146" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb70-147"><a href="#cb70-147" aria-hidden="true" tabindex="-1"></a>execution_time <span class="ot">&lt;-</span> end_time <span class="sc">-</span> start_time</span>
<span id="cb70-148"><a href="#cb70-148" aria-hidden="true" tabindex="-1"></a>execution_time_logistic_wrapper <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(execution_time, <span class="at">units =</span> <span class="st">"secs"</span>)</span>
<span id="cb70-149"><a href="#cb70-149" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(tabla_metricas_logistic_wrapper, <span class="at">file =</span> <span class="st">"tabla_metricas_logistic_wrapper.RData"</span>)</span>
<span id="cb70-150"><a href="#cb70-150" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(execution_time_logistic_wrapper, <span class="at">file =</span> <span class="st">"execution_time_logistic_wrapper.RData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"tabla_metricas_logistic_wrapper.RData"</span>)</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"execution_time_logistic_wrapper.RData"</span>)</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time_logistic_wrapper,  <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-9-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-9-1" role="tab" aria-controls="tabset-9-1" aria-selected="true" href="">Metrics Table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-9-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-9-2" role="tab" aria-controls="tabset-9-2" aria-selected="false" href="">Metrics Plot</a></li></ul>
<div class="tab-content">
<div id="tabset-9-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-9-1-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir tabla formateada con kableExtra</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(tabla_metricas_logistic_wrapper, <span class="at">caption =</span> <span class="st">"Cross Validation Metrics"</span>, <span class="at">align =</span> <span class="st">"c"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="tabset-9-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-9-2-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">crear_plot_metricas_per_fold</span>(tabla_metricas_logistic_wrapper)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
<p>The metrics are definetly accurate but it is too instable for a predictive model deployed in production.</p>
</div>
</div>
</div>
</div>
<div id="tabset-35-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-35-2-tab">
<div class="tabset-margin-container"></div><div class="panel-tabset" style="background-color: #f0f0f0;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-15-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-15-1" role="tab" aria-controls="tabset-15-1" aria-selected="true" href="">Hold out</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-15-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-15-2" role="tab" aria-controls="tabset-15-2" aria-selected="false" href="">5x2 Cross Validation Filter</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-15-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-15-3" role="tab" aria-controls="tabset-15-3" aria-selected="false" href="">5x2 Cross Validation Embedded</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-15-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-15-4" role="tab" aria-controls="tabset-15-4" aria-selected="false" href="">5x2 Cross Validation Wrapper</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-15-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-15-5" role="tab" aria-controls="tabset-15-5" aria-selected="false" href="">Hyperparameters Resume</a></li></ul>
<div class="tab-content" style="background-color: #f0f0f0;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;">
<div id="tabset-15-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-15-1-tab">
<p>In this section, we are going to build a neural network composed by a hidden layer leaned on nnet library.</p>
<p>After experimentation, we have noticed that hyperparameters must be hindered to avoid overfitting. High number of iterations or lots of neurons in the hidden layer tends to converge into overfitting.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Definir la fórmula para el modelo (sustituye "var_pred1 + var_pred2 + ..." con tus variables predictoras)</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>formula <span class="ot">&lt;-</span> ESTADO_ACTUAL <span class="sc">~</span> .</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Dividir el conjunto de datos en entrenamiento y test</span></span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>indices_entrenamiento <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(data), <span class="fl">0.75</span> <span class="sc">*</span> <span class="fu">nrow</span>(data))  <span class="co"># 75% para entrenamiento</span></span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento <span class="ot">&lt;-</span> data[indices_entrenamiento, ]</span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>datos_test <span class="ot">&lt;-</span> data[<span class="sc">-</span>indices_entrenamiento, ]</span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Dividir datos de entrenamiento en entrenamiento y validación</span></span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>train_indices <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(datos_entrenamiento), <span class="fl">0.8</span> <span class="sc">*</span> <span class="fu">nrow</span>(datos_entrenamiento))  <span class="co"># 80% para entrenamiento</span></span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento_split <span class="ot">&lt;-</span> datos_entrenamiento[train_indices, ]</span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a>datos_validacion <span class="ot">&lt;-</span> datos_entrenamiento[<span class="sc">-</span>train_indices, ]</span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Oversampling</span></span>
<span id="cb74-16"><a href="#cb74-16" aria-hidden="true" tabindex="-1"></a>proportion <span class="ot">&lt;-</span> <span class="fl">0.28</span></span>
<span id="cb74-17"><a href="#cb74-17" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento_oversampled <span class="ot">&lt;-</span> <span class="fu">ROSE</span>(ESTADO_ACTUAL <span class="sc">~</span> ., <span class="at">data =</span> datos_entrenamiento_split, <span class="at">p =</span> proportion)<span class="sc">$</span>data</span>
<span id="cb74-18"><a href="#cb74-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-19"><a href="#cb74-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Inicializar variables para almacenar los resultados</span></span>
<span id="cb74-20"><a href="#cb74-20" aria-hidden="true" tabindex="-1"></a>mejor_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb74-21"><a href="#cb74-21" aria-hidden="true" tabindex="-1"></a>mejor_modelo <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb74-22"><a href="#cb74-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-23"><a href="#cb74-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Definir combinaciones de hiperparámetros</span></span>
<span id="cb74-24"><a href="#cb74-24" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">size =</span> <span class="fu">c</span>(<span class="dv">15</span>), <span class="at">decay =</span> <span class="fu">c</span>(<span class="fl">0.01</span>,<span class="fl">0.5</span>,<span class="fl">0.001</span>), <span class="at">maxit =</span> <span class="fu">c</span>(<span class="dv">225</span>), <span class="at">skip =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb74-25"><a href="#cb74-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-26"><a href="#cb74-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterar sobre las combinaciones de hiperparámetros</span></span>
<span id="cb74-27"><a href="#cb74-27" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (param <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(params)) {</span>
<span id="cb74-28"><a href="#cb74-28" aria-hidden="true" tabindex="-1"></a>  size <span class="ot">&lt;-</span> params<span class="sc">$</span>size[param]</span>
<span id="cb74-29"><a href="#cb74-29" aria-hidden="true" tabindex="-1"></a>  decay <span class="ot">&lt;-</span> params<span class="sc">$</span>decay[param]</span>
<span id="cb74-30"><a href="#cb74-30" aria-hidden="true" tabindex="-1"></a>  maxit <span class="ot">&lt;-</span> params<span class="sc">$</span>maxit[param]</span>
<span id="cb74-31"><a href="#cb74-31" aria-hidden="true" tabindex="-1"></a>  skip <span class="ot">&lt;-</span> params<span class="sc">$</span>skip[param]</span>
<span id="cb74-32"><a href="#cb74-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb74-33"><a href="#cb74-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Entrenar el modelo con la combinación de hiperparámetros actual</span></span>
<span id="cb74-34"><a href="#cb74-34" aria-hidden="true" tabindex="-1"></a>  modelo <span class="ot">&lt;-</span> <span class="fu">nnet</span>(formula, <span class="at">data =</span> datos_entrenamiento_oversampled, <span class="at">size =</span> size, <span class="at">decay =</span> decay, <span class="at">maxit =</span> maxit, <span class="at">skip =</span> skip, <span class="at">trace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb74-35"><a href="#cb74-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb74-36"><a href="#cb74-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Realizar predicciones en datos de validación</span></span>
<span id="cb74-37"><a href="#cb74-37" aria-hidden="true" tabindex="-1"></a>  predicciones_validacion <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelo, <span class="at">newdata =</span> datos_validacion, <span class="at">type =</span> <span class="st">"raw"</span>)</span>
<span id="cb74-38"><a href="#cb74-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb74-39"><a href="#cb74-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular AUC para la combinación actual</span></span>
<span id="cb74-40"><a href="#cb74-40" aria-hidden="true" tabindex="-1"></a>  roc_obj <span class="ot">&lt;-</span> <span class="fu">roc</span>(<span class="fu">ifelse</span>(datos_validacion<span class="sc">$</span>ESTADO_ACTUAL <span class="sc">==</span> <span class="st">"SI"</span>, <span class="dv">1</span>, <span class="dv">0</span>), <span class="fu">ifelse</span>(predicciones_validacion <span class="sc">==</span> <span class="st">"SI"</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb74-41"><a href="#cb74-41" aria-hidden="true" tabindex="-1"></a>  auc_actual <span class="ot">&lt;-</span> <span class="fu">auc</span>(roc_obj)</span>
<span id="cb74-42"><a href="#cb74-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb74-43"><a href="#cb74-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Actualizar el mejor modelo y su AUC si se encuentra un modelo mejor</span></span>
<span id="cb74-44"><a href="#cb74-44" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (auc_actual <span class="sc">&gt;</span> mejor_auc) {</span>
<span id="cb74-45"><a href="#cb74-45" aria-hidden="true" tabindex="-1"></a>    mejor_auc <span class="ot">&lt;-</span> auc_actual</span>
<span id="cb74-46"><a href="#cb74-46" aria-hidden="true" tabindex="-1"></a>    mejor_modelo <span class="ot">&lt;-</span> modelo</span>
<span id="cb74-47"><a href="#cb74-47" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb74-48"><a href="#cb74-48" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb74-49"><a href="#cb74-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-50"><a href="#cb74-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir el mejor modelo y su AUC</span></span>
<span id="cb74-51"><a href="#cb74-51" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mejor_modelo)</span>
<span id="cb74-52"><a href="#cb74-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-53"><a href="#cb74-53" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb74-54"><a href="#cb74-54" aria-hidden="true" tabindex="-1"></a>execution_time <span class="ot">&lt;-</span> end_time <span class="sc">-</span> start_time</span>
<span id="cb74-55"><a href="#cb74-55" aria-hidden="true" tabindex="-1"></a>execution_time <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(execution_time, <span class="at">units =</span> <span class="st">"secs"</span>)</span>
<span id="cb74-56"><a href="#cb74-56" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time,  <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-11-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-11-1" role="tab" aria-controls="tabset-11-1" aria-selected="true" href="">Predictions</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-11-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-11-2" role="tab" aria-controls="tabset-11-2" aria-selected="false" href="">Roc curve and auc</a></li></ul>
<div class="tab-content">
<div id="tabset-11-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-11-1-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular las predicciones para el conjunto de test</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>predicciones_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(mejor_modelo, <span class="at">newdata =</span> datos_test, <span class="at">type =</span> <span class="st">"raw"</span>)</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>clases_predichas_test <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predicciones_test <span class="sc">&gt;=</span> <span class="fl">0.5</span>, <span class="st">"SI"</span>, <span class="st">"NO"</span>)</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a><span class="fu">mostrar_metricas</span>(datos_test<span class="sc">$</span>ESTADO_ACTUAL,clases_predichas_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="tabset-11-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-11-2-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular la curva ROC y el AUC para el conjunto de test</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_roc_curve</span>(predicciones_test,datos_test<span class="sc">$</span>ESTADO_ACTUAL)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
<p>The performance is not bad, it can be improved with a vasiable selector method though.</p>
</div>
<div id="tabset-15-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-15-2-tab">
<p>We are going to perform a 5x2 cross validation to ensure the robustness of the model. First, we create the outer folds and then we iterate over them to create the inner folds and perform the model selection process.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Establecer la fórmula base para el modelo logístico</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>formula_base <span class="ot">&lt;-</span> <span class="fu">formula</span>(ESTADO_ACTUAL <span class="sc">~</span> <span class="dv">1</span>)  <span class="co"># Fórmula inicial sin predictoras</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtener nombres de variables predictoras</span></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>variables <span class="ot">&lt;-</span> <span class="fu">names</span>(data)[<span class="sc">-</span><span class="fu">which</span>(<span class="fu">names</span>(data) <span class="sc">==</span> <span class="st">"ESTADO_ACTUAL"</span>)]</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtener todas las combinaciones posibles de variables predictoras</span></span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>combinaciones_variables <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(variables), <span class="cf">function</span>(x) <span class="fu">combn</span>(variables, x, <span class="at">simplify =</span> <span class="cn">FALSE</span>)), <span class="at">recursive =</span> <span class="cn">FALSE</span>)</span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Configurar la validación cruzada 5x2</span></span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a>k_outer <span class="ot">&lt;-</span> <span class="dv">5</span>  <span class="co"># Número de pliegues externos</span></span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a>k_inner <span class="ot">&lt;-</span> <span class="dv">2</span>  <span class="co"># Número de pliegues internos</span></span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a>folds_outer <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(data<span class="sc">$</span>ESTADO_ACTUAL, <span class="at">k =</span> k_outer, <span class="at">list =</span> <span class="cn">FALSE</span>)  <span class="co"># Obtener índices de pliegues externos</span></span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Lista para almacenar resultados</span></span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a>resultados_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true" tabindex="-1"></a>resultados_sensibilidad <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb77-20"><a href="#cb77-20" aria-hidden="true" tabindex="-1"></a>resultados_accuracy <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb77-21"><a href="#cb77-21" aria-hidden="true" tabindex="-1"></a>indices <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data)</span>
<span id="cb77-22"><a href="#cb77-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-23"><a href="#cb77-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Inicializar matrices para almacenar predicciones y objetivos</span></span>
<span id="cb77-24"><a href="#cb77-24" aria-hidden="true" tabindex="-1"></a>predicciones_totales <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">nrow</span>(data), <span class="at">ncol =</span> k_outer)</span>
<span id="cb77-25"><a href="#cb77-25" aria-hidden="true" tabindex="-1"></a>targets_totales <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(data))</span>
<span id="cb77-26"><a href="#cb77-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-27"><a href="#cb77-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterar sobre cada pliegue externo y realizar el proceso de modelado</span></span>
<span id="cb77-28"><a href="#cb77-28" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i_outer <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k_outer) {</span>
<span id="cb77-29"><a href="#cb77-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-30"><a href="#cb77-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Obtener los índices para el pliegue externo actual</span></span>
<span id="cb77-31"><a href="#cb77-31" aria-hidden="true" tabindex="-1"></a>  test_indices_outer <span class="ot">&lt;-</span> indices[folds_outer<span class="sc">==</span>i_outer]  <span class="co"># Índices correspondientes al pliegue externo de test</span></span>
<span id="cb77-32"><a href="#cb77-32" aria-hidden="true" tabindex="-1"></a>  train_indices_outer <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data), test_indices_outer)  <span class="co"># Índices correspondientes al conjunto de entrenamiento</span></span>
<span id="cb77-33"><a href="#cb77-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb77-34"><a href="#cb77-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Dividir datos en entrenamiento y test para el pliegue externo</span></span>
<span id="cb77-35"><a href="#cb77-35" aria-hidden="true" tabindex="-1"></a>  datos_entrenamiento_outer <span class="ot">&lt;-</span> data[train_indices_outer, ]</span>
<span id="cb77-36"><a href="#cb77-36" aria-hidden="true" tabindex="-1"></a>  datos_test_outer <span class="ot">&lt;-</span> data[test_indices_outer, ]</span>
<span id="cb77-37"><a href="#cb77-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb77-38"><a href="#cb77-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-39"><a href="#cb77-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Configurar la validación cruzada interna</span></span>
<span id="cb77-40"><a href="#cb77-40" aria-hidden="true" tabindex="-1"></a>  folds_inner <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(datos_entrenamiento_outer<span class="sc">$</span>ESTADO_ACTUAL, <span class="at">k =</span> k_inner, <span class="at">list =</span> <span class="cn">FALSE</span>)  <span class="co"># Obtener índices de pliegues internos</span></span>
<span id="cb77-41"><a href="#cb77-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb77-42"><a href="#cb77-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Almacenar predicciones y test para formar una curva ROC general</span></span>
<span id="cb77-43"><a href="#cb77-43" aria-hidden="true" tabindex="-1"></a>  predicciones_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(datos_entrenamiento_outer))</span>
<span id="cb77-44"><a href="#cb77-44" aria-hidden="true" tabindex="-1"></a>  targets_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(datos_entrenamiento_outer))</span>
<span id="cb77-45"><a href="#cb77-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb77-46"><a href="#cb77-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Iterar sobre cada pliegue interno para selección de modelo</span></span>
<span id="cb77-47"><a href="#cb77-47" aria-hidden="true" tabindex="-1"></a>  indices_inner <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(datos_entrenamiento_outer)</span>
<span id="cb77-48"><a href="#cb77-48" aria-hidden="true" tabindex="-1"></a>  resultados_auc_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb77-49"><a href="#cb77-49" aria-hidden="true" tabindex="-1"></a>  resultados_sensibilidad_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb77-50"><a href="#cb77-50" aria-hidden="true" tabindex="-1"></a>  resultados_accuracy_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb77-51"><a href="#cb77-51" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i_inner <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k_inner) {</span>
<span id="cb77-52"><a href="#cb77-52" aria-hidden="true" tabindex="-1"></a>    <span class="do">###############################</span></span>
<span id="cb77-53"><a href="#cb77-53" aria-hidden="true" tabindex="-1"></a>    <span class="do">#### Aqui el filtrado##########</span></span>
<span id="cb77-54"><a href="#cb77-54" aria-hidden="true" tabindex="-1"></a>    <span class="do">###############################</span></span>
<span id="cb77-55"><a href="#cb77-55" aria-hidden="true" tabindex="-1"></a>    filter_data <span class="ot">&lt;-</span> <span class="fu">filter_dependency</span>(datos_entrenamiento_outer,<span class="st">"ESTADO_ACTUAL"</span>,<span class="fu">colnames</span>(datos_entrenamiento_outer),<span class="fl">0.05</span>)</span>
<span id="cb77-56"><a href="#cb77-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="st">"ESTADO_ACTUAL.1"</span> <span class="sc">%in%</span> <span class="fu">colnames</span>(filter_data)) {</span>
<span id="cb77-57"><a href="#cb77-57" aria-hidden="true" tabindex="-1"></a>      filter_data <span class="ot">&lt;-</span> filter_data[, <span class="sc">!</span><span class="fu">colnames</span>(filter_data) <span class="sc">%in%</span> <span class="st">"ESTADO_ACTUAL.1"</span>, drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb77-58"><a href="#cb77-58" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb77-59"><a href="#cb77-59" aria-hidden="true" tabindex="-1"></a><span class="co">#con poca variables solo unaa la vez o filtrado o wrapper</span></span>
<span id="cb77-60"><a href="#cb77-60" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb77-61"><a href="#cb77-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb77-62"><a href="#cb77-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb77-63"><a href="#cb77-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Obtener los índices para el pliegue interno actual</span></span>
<span id="cb77-64"><a href="#cb77-64" aria-hidden="true" tabindex="-1"></a>    test_indices_inner <span class="ot">&lt;-</span> indices_inner[folds_inner<span class="sc">==</span>i_inner]  <span class="co"># Índices correspondientes al pliegue interno de test</span></span>
<span id="cb77-65"><a href="#cb77-65" aria-hidden="true" tabindex="-1"></a>    train_indices_inner <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(datos_entrenamiento_outer), test_indices_inner)  <span class="co"># Índices correspondientes al conjunto de entrenamiento interno</span></span>
<span id="cb77-66"><a href="#cb77-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb77-67"><a href="#cb77-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Dividir datos en entrenamiento y test para el pliegue interno</span></span>
<span id="cb77-68"><a href="#cb77-68" aria-hidden="true" tabindex="-1"></a>    datos_entrenamiento_inner <span class="ot">&lt;-</span> datos_entrenamiento_outer[train_indices_inner, ]</span>
<span id="cb77-69"><a href="#cb77-69" aria-hidden="true" tabindex="-1"></a>    datos_validacion <span class="ot">&lt;-</span> datos_entrenamiento_outer[test_indices_inner, ]</span>
<span id="cb77-70"><a href="#cb77-70" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb77-71"><a href="#cb77-71" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb77-72"><a href="#cb77-72" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aplicar oversampling en el conjunto de entrenamiento interno</span></span>
<span id="cb77-73"><a href="#cb77-73" aria-hidden="true" tabindex="-1"></a>    datos_entrenamiento_oversampled <span class="ot">&lt;-</span> <span class="fu">ROSE</span>(ESTADO_ACTUAL <span class="sc">~</span> .,</span>
<span id="cb77-74"><a href="#cb77-74" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">data =</span> datos_entrenamiento_inner,</span>
<span id="cb77-75"><a href="#cb77-75" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">p =</span> <span class="fl">0.28</span>)<span class="sc">$</span>data</span>
<span id="cb77-76"><a href="#cb77-76" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb77-77"><a href="#cb77-77" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Inicializar variables para almacenar los resultados</span></span>
<span id="cb77-78"><a href="#cb77-78" aria-hidden="true" tabindex="-1"></a>    mejor_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb77-79"><a href="#cb77-79" aria-hidden="true" tabindex="-1"></a>    mejor_modelo <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb77-80"><a href="#cb77-80" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb77-81"><a href="#cb77-81" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Definir combinaciones de hiperparámetros</span></span>
<span id="cb77-82"><a href="#cb77-82" aria-hidden="true" tabindex="-1"></a>    params <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">size =</span> <span class="fu">c</span>(<span class="dv">15</span>), <span class="at">decay =</span> <span class="fu">c</span>(<span class="fl">0.01</span>,<span class="fl">0.5</span>,<span class="fl">0.001</span>), <span class="at">maxit =</span> <span class="fu">c</span>(<span class="dv">225</span>), <span class="at">skip =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb77-83"><a href="#cb77-83" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb77-84"><a href="#cb77-84" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Iterar sobre las combinaciones de hiperparámetros</span></span>
<span id="cb77-85"><a href="#cb77-85" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (param <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(params)) {</span>
<span id="cb77-86"><a href="#cb77-86" aria-hidden="true" tabindex="-1"></a>      size <span class="ot">&lt;-</span> params<span class="sc">$</span>size[param]</span>
<span id="cb77-87"><a href="#cb77-87" aria-hidden="true" tabindex="-1"></a>      decay <span class="ot">&lt;-</span> params<span class="sc">$</span>decay[param]</span>
<span id="cb77-88"><a href="#cb77-88" aria-hidden="true" tabindex="-1"></a>      maxit <span class="ot">&lt;-</span> params<span class="sc">$</span>maxit[param]</span>
<span id="cb77-89"><a href="#cb77-89" aria-hidden="true" tabindex="-1"></a>      skip <span class="ot">&lt;-</span> params<span class="sc">$</span>skip[param]</span>
<span id="cb77-90"><a href="#cb77-90" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb77-91"><a href="#cb77-91" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Entrenar el modelo con la combinación de hiperparámetros actual</span></span>
<span id="cb77-92"><a href="#cb77-92" aria-hidden="true" tabindex="-1"></a>      modelo <span class="ot">&lt;-</span> <span class="fu">nnet</span>(formula, <span class="at">data =</span> datos_entrenamiento_oversampled, <span class="at">size =</span> size, <span class="at">decay =</span> decay, <span class="at">maxit =</span> maxit, <span class="at">skip =</span> skip, <span class="at">trace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb77-93"><a href="#cb77-93" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb77-94"><a href="#cb77-94" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Realizar predicciones en datos de validación</span></span>
<span id="cb77-95"><a href="#cb77-95" aria-hidden="true" tabindex="-1"></a>      predicciones_validacion <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelo, <span class="at">newdata =</span> datos_validacion, <span class="at">type =</span> <span class="st">"raw"</span>)</span>
<span id="cb77-96"><a href="#cb77-96" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb77-97"><a href="#cb77-97" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Calcular AUC para la combinación actual</span></span>
<span id="cb77-98"><a href="#cb77-98" aria-hidden="true" tabindex="-1"></a>      roc_obj <span class="ot">&lt;-</span> <span class="fu">roc</span>(<span class="fu">ifelse</span>(datos_validacion<span class="sc">$</span>ESTADO_ACTUAL <span class="sc">==</span> <span class="st">"SI"</span>, <span class="dv">1</span>, <span class="dv">0</span>), <span class="fu">ifelse</span>(predicciones_validacion <span class="sc">==</span> <span class="st">"SI"</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb77-99"><a href="#cb77-99" aria-hidden="true" tabindex="-1"></a>      auc_actual <span class="ot">&lt;-</span> <span class="fu">auc</span>(roc_obj)</span>
<span id="cb77-100"><a href="#cb77-100" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb77-101"><a href="#cb77-101" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Actualizar el mejor modelo y su AUC si se encuentra un modelo mejor</span></span>
<span id="cb77-102"><a href="#cb77-102" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (auc_actual <span class="sc">&gt;</span> mejor_auc) {</span>
<span id="cb77-103"><a href="#cb77-103" aria-hidden="true" tabindex="-1"></a>        mejor_auc <span class="ot">&lt;-</span> auc_actual</span>
<span id="cb77-104"><a href="#cb77-104" aria-hidden="true" tabindex="-1"></a>        mejor_modelo <span class="ot">&lt;-</span> modelo</span>
<span id="cb77-105"><a href="#cb77-105" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb77-106"><a href="#cb77-106" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb77-107"><a href="#cb77-107" aria-hidden="true" tabindex="-1"></a>    <span class="do">########################</span></span>
<span id="cb77-108"><a href="#cb77-108" aria-hidden="true" tabindex="-1"></a>    predicciones_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(mejor_modelo, <span class="at">newdata =</span> datos_validacion, <span class="at">type =</span> <span class="st">"raw"</span>)</span>
<span id="cb77-109"><a href="#cb77-109" aria-hidden="true" tabindex="-1"></a>    clases_predichas_test <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predicciones_test <span class="sc">&gt;=</span> <span class="fl">0.5</span>, <span class="st">"SI"</span>, <span class="st">"NO"</span>)</span>
<span id="cb77-110"><a href="#cb77-110" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb77-111"><a href="#cb77-111" aria-hidden="true" tabindex="-1"></a>    <span class="do">###########################</span></span>
<span id="cb77-112"><a href="#cb77-112" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Realizar predicciones en el conjunto de entrenamiento externo para el AUC general</span></span>
<span id="cb77-113"><a href="#cb77-113" aria-hidden="true" tabindex="-1"></a>    predicciones_auc[test_indices_inner] <span class="ot">&lt;-</span> <span class="fu">predict</span>(mejor_modelo_auc, <span class="at">newdata =</span> datos_validacion, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb77-114"><a href="#cb77-114" aria-hidden="true" tabindex="-1"></a>    predicciones_clasificadas <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predicciones_auc[test_indices_inner] <span class="sc">&gt;=</span> <span class="fl">0.5</span>, <span class="st">"SI"</span>, <span class="st">"NO"</span>)</span>
<span id="cb77-115"><a href="#cb77-115" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb77-116"><a href="#cb77-116" aria-hidden="true" tabindex="-1"></a>    resultados_sensibilidad_inner[i_inner] <span class="ot">&lt;-</span> <span class="fu">sum</span>(clases_predichas_test <span class="sc">==</span> <span class="st">"SI"</span> <span class="sc">&amp;</span> datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]] <span class="sc">==</span> <span class="st">"SI"</span>) <span class="sc">/</span> <span class="fu">sum</span>(datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]] <span class="sc">==</span> <span class="st">"SI"</span>)</span>
<span id="cb77-117"><a href="#cb77-117" aria-hidden="true" tabindex="-1"></a>    resultados_accuracy_inner[i_inner] <span class="ot">&lt;-</span> <span class="fu">mean</span>(clases_predichas_test <span class="sc">==</span> datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]])</span>
<span id="cb77-118"><a href="#cb77-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-119"><a href="#cb77-119" aria-hidden="true" tabindex="-1"></a>    targets_auc[test_indices_inner] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(datos_validacion<span class="sc">$</span>ESTADO_ACTUAL) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb77-120"><a href="#cb77-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-121"><a href="#cb77-121" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb77-122"><a href="#cb77-122" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb77-123"><a href="#cb77-123" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular el AUC final para este fold externo</span></span>
<span id="cb77-124"><a href="#cb77-124" aria-hidden="true" tabindex="-1"></a>  auc_fold_externo <span class="ot">&lt;-</span> pROC<span class="sc">::</span><span class="fu">roc</span>(targets_auc, predicciones_auc)<span class="sc">$</span>auc</span>
<span id="cb77-125"><a href="#cb77-125" aria-hidden="true" tabindex="-1"></a>  accuracy_fold_externo <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_accuracy_inner)</span>
<span id="cb77-126"><a href="#cb77-126" aria-hidden="true" tabindex="-1"></a>  sensibilidad_fold_externo <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_sensibilidad_inner)</span>
<span id="cb77-127"><a href="#cb77-127" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb77-128"><a href="#cb77-128" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb77-129"><a href="#cb77-129" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Almacenar el AUC del fold externo actual</span></span>
<span id="cb77-130"><a href="#cb77-130" aria-hidden="true" tabindex="-1"></a>  resultados_auc[i_outer] <span class="ot">&lt;-</span> auc_fold_externo</span>
<span id="cb77-131"><a href="#cb77-131" aria-hidden="true" tabindex="-1"></a>  resultados_accuracy[i_outer] <span class="ot">&lt;-</span> accuracy_fold_externo</span>
<span id="cb77-132"><a href="#cb77-132" aria-hidden="true" tabindex="-1"></a>  resultados_sensibilidad[i_outer] <span class="ot">&lt;-</span> sensibilidad_fold_externo</span>
<span id="cb77-133"><a href="#cb77-133" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb77-134"><a href="#cb77-134" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Predecir en los datos de test para este pliegue externo y almacenar predicciones</span></span>
<span id="cb77-135"><a href="#cb77-135" aria-hidden="true" tabindex="-1"></a>  predicciones_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(mejor_modelo_auc, <span class="at">newdata =</span> datos_test_outer, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb77-136"><a href="#cb77-136" aria-hidden="true" tabindex="-1"></a>  predicciones_totales[test_indices_outer, i_outer] <span class="ot">&lt;-</span> predicciones_test</span>
<span id="cb77-137"><a href="#cb77-137" aria-hidden="true" tabindex="-1"></a>  targets_totales[test_indices_outer] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(datos_test_outer<span class="sc">$</span>ESTADO_ACTUAL) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb77-138"><a href="#cb77-138" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb77-139"><a href="#cb77-139" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb77-140"><a href="#cb77-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-141"><a href="#cb77-141" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular AUC promedio</span></span>
<span id="cb77-142"><a href="#cb77-142" aria-hidden="true" tabindex="-1"></a>auc_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_auc)</span>
<span id="cb77-143"><a href="#cb77-143" aria-hidden="true" tabindex="-1"></a>accuracy_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_accuracy)</span>
<span id="cb77-144"><a href="#cb77-144" aria-hidden="true" tabindex="-1"></a>sensibilidad_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_sensibilidad)</span>
<span id="cb77-145"><a href="#cb77-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-146"><a href="#cb77-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-147"><a href="#cb77-147" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear tabla con todas las métricas</span></span>
<span id="cb77-148"><a href="#cb77-148" aria-hidden="true" tabindex="-1"></a>tabla_metricas <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb77-149"><a href="#cb77-149" aria-hidden="true" tabindex="-1"></a>  <span class="at">Pliegue =</span> <span class="dv">1</span><span class="sc">:</span>k_outer,</span>
<span id="cb77-150"><a href="#cb77-150" aria-hidden="true" tabindex="-1"></a>  <span class="at">AUC =</span> <span class="fu">sapply</span>(resultados_auc, round, <span class="at">digits =</span> <span class="dv">3</span>),</span>
<span id="cb77-151"><a href="#cb77-151" aria-hidden="true" tabindex="-1"></a>  <span class="at">Accuracy =</span> <span class="fu">sapply</span>(resultados_accuracy, round, <span class="at">digits =</span> <span class="dv">3</span>),</span>
<span id="cb77-152"><a href="#cb77-152" aria-hidden="true" tabindex="-1"></a>  <span class="at">Recall =</span> <span class="fu">sapply</span>(resultados_sensibilidad, round, <span class="at">digits =</span> <span class="dv">3</span>)</span>
<span id="cb77-153"><a href="#cb77-153" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb77-154"><a href="#cb77-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-155"><a href="#cb77-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-156"><a href="#cb77-156" aria-hidden="true" tabindex="-1"></a><span class="co"># Agregar fila con promedio de métricas</span></span>
<span id="cb77-157"><a href="#cb77-157" aria-hidden="true" tabindex="-1"></a>tabla_metricas_nnet_filter <span class="ot">&lt;-</span> <span class="fu">rbind</span>(tabla_metricas, <span class="fu">c</span>(<span class="st">"Mean"</span>, <span class="fu">round</span>(auc_promedio,<span class="dv">3</span>), <span class="fu">round</span>(accuracy_promedio,<span class="dv">3</span>), <span class="fu">round</span>(sensibilidad_promedio,<span class="dv">3</span>)))</span>
<span id="cb77-158"><a href="#cb77-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-159"><a href="#cb77-159" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb77-160"><a href="#cb77-160" aria-hidden="true" tabindex="-1"></a>execution_time_nnet_filter <span class="ot">&lt;-</span> end_time <span class="sc">-</span> start_time</span>
<span id="cb77-161"><a href="#cb77-161" aria-hidden="true" tabindex="-1"></a>execution_time_nnet_filter <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(execution_time_nnet_filter, <span class="at">units =</span> <span class="st">"secs"</span>)</span>
<span id="cb77-162"><a href="#cb77-162" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(tabla_metricas_nnet_filter, <span class="at">file =</span> <span class="st">"tabla_metricas_nnet_filter.RData"</span>)</span>
<span id="cb77-163"><a href="#cb77-163" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(execution_time_nnet_filter, <span class="at">file =</span> <span class="st">"execution_time_nnet_filter.RData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"tabla_metricas_nnet_filter.RData"</span>)</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"execution_time_nnet_filter.RData"</span>)</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time_nnet_filter,  <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-12-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-12-1" role="tab" aria-controls="tabset-12-1" aria-selected="true" href="">Metrics Table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-12-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-12-2" role="tab" aria-controls="tabset-12-2" aria-selected="false" href="">Metrics Plot</a></li></ul>
<div class="tab-content">
<div id="tabset-12-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-12-1-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir tabla formateada con kableExtra</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(tabla_metricas_nnet_filter, <span class="at">caption =</span> <span class="st">"Cross Validation Metrics"</span>, <span class="at">align =</span> <span class="st">"c"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="tabset-12-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-12-2-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="fu">crear_plot_metricas_per_fold</span>(tabla_metricas_nnet_filter)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
<p>The algorith is much more stable than the previous one.</p>
</div>
<div id="tabset-15-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-15-3-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Establecer la fórmula base para el modelo logístico</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>formula_base <span class="ot">&lt;-</span> <span class="fu">formula</span>(ESTADO_ACTUAL <span class="sc">~</span> <span class="dv">1</span>)  <span class="co"># Fórmula inicial sin predictoras</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtener nombres de variables predictoras</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>variables <span class="ot">&lt;-</span> <span class="fu">names</span>(data)[<span class="sc">-</span><span class="fu">which</span>(<span class="fu">names</span>(data) <span class="sc">==</span> <span class="st">"ESTADO_ACTUAL"</span>)]</span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtener todas las combinaciones posibles de variables predictoras</span></span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>combinaciones_variables <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(variables), <span class="cf">function</span>(x) <span class="fu">combn</span>(variables, x, <span class="at">simplify =</span> <span class="cn">FALSE</span>)), <span class="at">recursive =</span> <span class="cn">FALSE</span>)</span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Configurar la validación cruzada 5x2</span></span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a>k_outer <span class="ot">&lt;-</span> <span class="dv">5</span>  <span class="co"># Número de pliegues externos</span></span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a>k_inner <span class="ot">&lt;-</span> <span class="dv">2</span>  <span class="co"># Número de pliegues internos</span></span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a>folds_outer <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(data<span class="sc">$</span>ESTADO_ACTUAL, <span class="at">k =</span> k_outer, <span class="at">list =</span> <span class="cn">FALSE</span>)  <span class="co"># Obtener índices de pliegues externos</span></span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Lista para almacenar resultados</span></span>
<span id="cb81-18"><a href="#cb81-18" aria-hidden="true" tabindex="-1"></a>resultados_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb81-19"><a href="#cb81-19" aria-hidden="true" tabindex="-1"></a>resultados_sensibilidad <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb81-20"><a href="#cb81-20" aria-hidden="true" tabindex="-1"></a>resultados_accuracy <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb81-21"><a href="#cb81-21" aria-hidden="true" tabindex="-1"></a>indices <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data)</span>
<span id="cb81-22"><a href="#cb81-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-23"><a href="#cb81-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Inicializar matrices para almacenar predicciones y objetivos</span></span>
<span id="cb81-24"><a href="#cb81-24" aria-hidden="true" tabindex="-1"></a>predicciones_totales <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">nrow</span>(data), <span class="at">ncol =</span> k_outer)</span>
<span id="cb81-25"><a href="#cb81-25" aria-hidden="true" tabindex="-1"></a>targets_totales <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(data))</span>
<span id="cb81-26"><a href="#cb81-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-27"><a href="#cb81-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterar sobre cada pliegue externo y realizar el proceso de modelado</span></span>
<span id="cb81-28"><a href="#cb81-28" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i_outer <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k_outer) {</span>
<span id="cb81-29"><a href="#cb81-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-30"><a href="#cb81-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Obtener los índices para el pliegue externo actual</span></span>
<span id="cb81-31"><a href="#cb81-31" aria-hidden="true" tabindex="-1"></a>  test_indices_outer <span class="ot">&lt;-</span> indices[folds_outer<span class="sc">==</span>i_outer]  <span class="co"># Índices correspondientes al pliegue externo de test</span></span>
<span id="cb81-32"><a href="#cb81-32" aria-hidden="true" tabindex="-1"></a>  train_indices_outer <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data), test_indices_outer)  <span class="co"># Índices correspondientes al conjunto de entrenamiento</span></span>
<span id="cb81-33"><a href="#cb81-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb81-34"><a href="#cb81-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Dividir datos en entrenamiento y test para el pliegue externo</span></span>
<span id="cb81-35"><a href="#cb81-35" aria-hidden="true" tabindex="-1"></a>  datos_entrenamiento_outer <span class="ot">&lt;-</span> data[train_indices_outer, ]</span>
<span id="cb81-36"><a href="#cb81-36" aria-hidden="true" tabindex="-1"></a>  datos_test_outer <span class="ot">&lt;-</span> data[test_indices_outer, ]</span>
<span id="cb81-37"><a href="#cb81-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb81-38"><a href="#cb81-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-39"><a href="#cb81-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Configurar la validación cruzada interna</span></span>
<span id="cb81-40"><a href="#cb81-40" aria-hidden="true" tabindex="-1"></a>  folds_inner <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(datos_entrenamiento_outer<span class="sc">$</span>ESTADO_ACTUAL, <span class="at">k =</span> k_inner, <span class="at">list =</span> <span class="cn">FALSE</span>)  <span class="co"># Obtener índices de pliegues internos</span></span>
<span id="cb81-41"><a href="#cb81-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb81-42"><a href="#cb81-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Almacenar predicciones y test para formar una curva ROC general</span></span>
<span id="cb81-43"><a href="#cb81-43" aria-hidden="true" tabindex="-1"></a>  predicciones_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(datos_entrenamiento_outer))</span>
<span id="cb81-44"><a href="#cb81-44" aria-hidden="true" tabindex="-1"></a>  targets_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(datos_entrenamiento_outer))</span>
<span id="cb81-45"><a href="#cb81-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb81-46"><a href="#cb81-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Iterar sobre cada pliegue interno para selección de modelo</span></span>
<span id="cb81-47"><a href="#cb81-47" aria-hidden="true" tabindex="-1"></a>  indices_inner <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(datos_entrenamiento_outer)</span>
<span id="cb81-48"><a href="#cb81-48" aria-hidden="true" tabindex="-1"></a>  resultados_auc_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb81-49"><a href="#cb81-49" aria-hidden="true" tabindex="-1"></a>  resultados_sensibilidad_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb81-50"><a href="#cb81-50" aria-hidden="true" tabindex="-1"></a>  resultados_accuracy_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb81-51"><a href="#cb81-51" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i_inner <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k_inner) {</span>
<span id="cb81-52"><a href="#cb81-52" aria-hidden="true" tabindex="-1"></a>    <span class="do">###############################</span></span>
<span id="cb81-53"><a href="#cb81-53" aria-hidden="true" tabindex="-1"></a>    <span class="do">#### Aqui el filtrado##########</span></span>
<span id="cb81-54"><a href="#cb81-54" aria-hidden="true" tabindex="-1"></a>    <span class="do">###############################</span></span>
<span id="cb81-55"><a href="#cb81-55" aria-hidden="true" tabindex="-1"></a>      variables_importantes <span class="ot">&lt;-</span> <span class="fu">seleccionar_variables_importantes</span>(datos_entrenamiento_outer,<span class="st">"ESTADO_ACTUAL"</span>,<span class="dv">6</span>)</span>
<span id="cb81-56"><a href="#cb81-56" aria-hidden="true" tabindex="-1"></a>    filter_data <span class="ot">&lt;-</span> datos_entrenamiento_outer[,<span class="fu">c</span>(<span class="st">"ESTADO_ACTUAL"</span>,variables_importantes)]</span>
<span id="cb81-57"><a href="#cb81-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Obtener los índices para el pliegue interno actual</span></span>
<span id="cb81-58"><a href="#cb81-58" aria-hidden="true" tabindex="-1"></a>    test_indices_inner <span class="ot">&lt;-</span> indices_inner[folds_inner<span class="sc">==</span>i_inner]  <span class="co"># Índices correspondientes al pliegue interno de test</span></span>
<span id="cb81-59"><a href="#cb81-59" aria-hidden="true" tabindex="-1"></a>    train_indices_inner <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(filter_data), test_indices_inner)  <span class="co"># Índices correspondientes al conjunto de entrenamiento interno</span></span>
<span id="cb81-60"><a href="#cb81-60" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb81-61"><a href="#cb81-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Dividir datos en entrenamiento y test para el pliegue interno</span></span>
<span id="cb81-62"><a href="#cb81-62" aria-hidden="true" tabindex="-1"></a>    datos_entrenamiento_inner <span class="ot">&lt;-</span> filter_data[train_indices_inner, ]</span>
<span id="cb81-63"><a href="#cb81-63" aria-hidden="true" tabindex="-1"></a>    datos_validacion <span class="ot">&lt;-</span> filter_data[test_indices_inner, ]</span>
<span id="cb81-64"><a href="#cb81-64" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb81-65"><a href="#cb81-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aplicar oversampling en el conjunto de entrenamiento interno</span></span>
<span id="cb81-66"><a href="#cb81-66" aria-hidden="true" tabindex="-1"></a>    datos_entrenamiento_oversampled <span class="ot">&lt;-</span> <span class="fu">ROSE</span>(ESTADO_ACTUAL <span class="sc">~</span> .,</span>
<span id="cb81-67"><a href="#cb81-67" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">data =</span> datos_entrenamiento_inner,</span>
<span id="cb81-68"><a href="#cb81-68" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">p =</span> <span class="fl">0.28</span>)<span class="sc">$</span>data</span>
<span id="cb81-69"><a href="#cb81-69" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb81-70"><a href="#cb81-70" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Inicializar variables para almacenar los resultados</span></span>
<span id="cb81-71"><a href="#cb81-71" aria-hidden="true" tabindex="-1"></a>    mejor_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb81-72"><a href="#cb81-72" aria-hidden="true" tabindex="-1"></a>    mejor_modelo <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb81-73"><a href="#cb81-73" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb81-74"><a href="#cb81-74" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Definir combinaciones de hiperparámetros</span></span>
<span id="cb81-75"><a href="#cb81-75" aria-hidden="true" tabindex="-1"></a>    params <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">size =</span> <span class="fu">c</span>(<span class="dv">15</span>), <span class="at">decay =</span> <span class="fu">c</span>(<span class="fl">0.01</span>,<span class="fl">0.5</span>,<span class="fl">0.001</span>), <span class="at">maxit =</span> <span class="fu">c</span>(<span class="dv">225</span>), <span class="at">skip =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb81-76"><a href="#cb81-76" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb81-77"><a href="#cb81-77" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Iterar sobre las combinaciones de hiperparámetros</span></span>
<span id="cb81-78"><a href="#cb81-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-79"><a href="#cb81-79" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (param <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(params)) {</span>
<span id="cb81-80"><a href="#cb81-80" aria-hidden="true" tabindex="-1"></a>      size <span class="ot">&lt;-</span> params<span class="sc">$</span>size[param]</span>
<span id="cb81-81"><a href="#cb81-81" aria-hidden="true" tabindex="-1"></a>      decay <span class="ot">&lt;-</span> params<span class="sc">$</span>decay[param]</span>
<span id="cb81-82"><a href="#cb81-82" aria-hidden="true" tabindex="-1"></a>      maxit <span class="ot">&lt;-</span> params<span class="sc">$</span>maxit[param]</span>
<span id="cb81-83"><a href="#cb81-83" aria-hidden="true" tabindex="-1"></a>      skip <span class="ot">&lt;-</span> params<span class="sc">$</span>skip[param]</span>
<span id="cb81-84"><a href="#cb81-84" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb81-85"><a href="#cb81-85" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Entrenar el modelo con la combinación de hiperparámetros actual</span></span>
<span id="cb81-86"><a href="#cb81-86" aria-hidden="true" tabindex="-1"></a>      modelo <span class="ot">&lt;-</span> <span class="fu">nnet</span>(formula, <span class="at">data =</span> datos_entrenamiento_oversampled, <span class="at">size =</span> size, <span class="at">decay =</span> decay, <span class="at">maxit =</span> maxit, <span class="at">skip =</span> skip, <span class="at">trace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb81-87"><a href="#cb81-87" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb81-88"><a href="#cb81-88" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Realizar predicciones en datos de validación</span></span>
<span id="cb81-89"><a href="#cb81-89" aria-hidden="true" tabindex="-1"></a>      predicciones_validacion <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelo, <span class="at">newdata =</span> datos_validacion, <span class="at">type =</span> <span class="st">"raw"</span>)</span>
<span id="cb81-90"><a href="#cb81-90" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb81-91"><a href="#cb81-91" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Calcular AUC para la combinación actual</span></span>
<span id="cb81-92"><a href="#cb81-92" aria-hidden="true" tabindex="-1"></a>      roc_obj <span class="ot">&lt;-</span> <span class="fu">roc</span>(<span class="fu">ifelse</span>(datos_validacion<span class="sc">$</span>ESTADO_ACTUAL <span class="sc">==</span> <span class="st">"SI"</span>, <span class="dv">1</span>, <span class="dv">0</span>), <span class="fu">ifelse</span>(predicciones_validacion <span class="sc">==</span> <span class="st">"SI"</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb81-93"><a href="#cb81-93" aria-hidden="true" tabindex="-1"></a>      auc_actual <span class="ot">&lt;-</span> <span class="fu">auc</span>(roc_obj)</span>
<span id="cb81-94"><a href="#cb81-94" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb81-95"><a href="#cb81-95" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Actualizar el mejor modelo y su AUC si se encuentra un modelo mejor</span></span>
<span id="cb81-96"><a href="#cb81-96" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (auc_actual <span class="sc">&gt;</span> mejor_auc) {</span>
<span id="cb81-97"><a href="#cb81-97" aria-hidden="true" tabindex="-1"></a>        mejor_auc <span class="ot">&lt;-</span> auc_actual</span>
<span id="cb81-98"><a href="#cb81-98" aria-hidden="true" tabindex="-1"></a>        mejor_modelo <span class="ot">&lt;-</span> modelo</span>
<span id="cb81-99"><a href="#cb81-99" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb81-100"><a href="#cb81-100" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb81-101"><a href="#cb81-101" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb81-102"><a href="#cb81-102" aria-hidden="true" tabindex="-1"></a>    <span class="do">########################</span></span>
<span id="cb81-103"><a href="#cb81-103" aria-hidden="true" tabindex="-1"></a>    predicciones_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(mejor_modelo, <span class="at">newdata =</span> datos_validacion, <span class="at">type =</span> <span class="st">"raw"</span>)</span>
<span id="cb81-104"><a href="#cb81-104" aria-hidden="true" tabindex="-1"></a>    clases_predichas_test <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predicciones_test <span class="sc">&gt;=</span> <span class="fl">0.5</span>, <span class="st">"SI"</span>, <span class="st">"NO"</span>)</span>
<span id="cb81-105"><a href="#cb81-105" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb81-106"><a href="#cb81-106" aria-hidden="true" tabindex="-1"></a>    <span class="do">###########################</span></span>
<span id="cb81-107"><a href="#cb81-107" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Realizar predicciones en el conjunto de entrenamiento externo para el AUC general</span></span>
<span id="cb81-108"><a href="#cb81-108" aria-hidden="true" tabindex="-1"></a>    predicciones_auc[test_indices_inner] <span class="ot">&lt;-</span> <span class="fu">predict</span>(mejor_modelo_auc, <span class="at">newdata =</span> datos_validacion, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb81-109"><a href="#cb81-109" aria-hidden="true" tabindex="-1"></a>    predicciones_clasificadas <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predicciones_auc[test_indices_inner] <span class="sc">&gt;=</span> <span class="fl">0.5</span>, <span class="st">"SI"</span>, <span class="st">"NO"</span>)</span>
<span id="cb81-110"><a href="#cb81-110" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb81-111"><a href="#cb81-111" aria-hidden="true" tabindex="-1"></a>    resultados_sensibilidad_inner[i_inner] <span class="ot">&lt;-</span> <span class="fu">sum</span>(clases_predichas_test <span class="sc">==</span> <span class="st">"SI"</span> <span class="sc">&amp;</span> datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]] <span class="sc">==</span> <span class="st">"SI"</span>) <span class="sc">/</span> <span class="fu">sum</span>(datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]] <span class="sc">==</span> <span class="st">"SI"</span>)</span>
<span id="cb81-112"><a href="#cb81-112" aria-hidden="true" tabindex="-1"></a>    resultados_accuracy_inner[i_inner] <span class="ot">&lt;-</span> <span class="fu">mean</span>(clases_predichas_test <span class="sc">==</span> datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]])</span>
<span id="cb81-113"><a href="#cb81-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-114"><a href="#cb81-114" aria-hidden="true" tabindex="-1"></a>    targets_auc[test_indices_inner] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(datos_validacion<span class="sc">$</span>ESTADO_ACTUAL) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb81-115"><a href="#cb81-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-116"><a href="#cb81-116" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb81-117"><a href="#cb81-117" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb81-118"><a href="#cb81-118" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular el AUC final para este fold externo</span></span>
<span id="cb81-119"><a href="#cb81-119" aria-hidden="true" tabindex="-1"></a>  auc_fold_externo <span class="ot">&lt;-</span> pROC<span class="sc">::</span><span class="fu">roc</span>(targets_auc, predicciones_auc)<span class="sc">$</span>auc</span>
<span id="cb81-120"><a href="#cb81-120" aria-hidden="true" tabindex="-1"></a>  accuracy_fold_externo <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_accuracy_inner)</span>
<span id="cb81-121"><a href="#cb81-121" aria-hidden="true" tabindex="-1"></a>  sensibilidad_fold_externo <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_sensibilidad_inner)</span>
<span id="cb81-122"><a href="#cb81-122" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb81-123"><a href="#cb81-123" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb81-124"><a href="#cb81-124" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Almacenar el AUC del fold externo actual</span></span>
<span id="cb81-125"><a href="#cb81-125" aria-hidden="true" tabindex="-1"></a>  resultados_auc[i_outer] <span class="ot">&lt;-</span> auc_fold_externo</span>
<span id="cb81-126"><a href="#cb81-126" aria-hidden="true" tabindex="-1"></a>  resultados_accuracy[i_outer] <span class="ot">&lt;-</span> accuracy_fold_externo</span>
<span id="cb81-127"><a href="#cb81-127" aria-hidden="true" tabindex="-1"></a>  resultados_sensibilidad[i_outer] <span class="ot">&lt;-</span> sensibilidad_fold_externo</span>
<span id="cb81-128"><a href="#cb81-128" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb81-129"><a href="#cb81-129" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Predecir en los datos de test para este pliegue externo y almacenar predicciones</span></span>
<span id="cb81-130"><a href="#cb81-130" aria-hidden="true" tabindex="-1"></a>  predicciones_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(mejor_modelo_auc, <span class="at">newdata =</span> datos_test_outer, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb81-131"><a href="#cb81-131" aria-hidden="true" tabindex="-1"></a>  predicciones_totales[test_indices_outer, i_outer] <span class="ot">&lt;-</span> predicciones_test</span>
<span id="cb81-132"><a href="#cb81-132" aria-hidden="true" tabindex="-1"></a>  targets_totales[test_indices_outer] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(datos_test_outer<span class="sc">$</span>ESTADO_ACTUAL) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb81-133"><a href="#cb81-133" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb81-134"><a href="#cb81-134" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb81-135"><a href="#cb81-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-136"><a href="#cb81-136" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular AUC promedio</span></span>
<span id="cb81-137"><a href="#cb81-137" aria-hidden="true" tabindex="-1"></a>auc_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_auc)</span>
<span id="cb81-138"><a href="#cb81-138" aria-hidden="true" tabindex="-1"></a>accuracy_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_accuracy)</span>
<span id="cb81-139"><a href="#cb81-139" aria-hidden="true" tabindex="-1"></a>sensibilidad_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_sensibilidad)</span>
<span id="cb81-140"><a href="#cb81-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-141"><a href="#cb81-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-142"><a href="#cb81-142" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear tabla con todas las métricas</span></span>
<span id="cb81-143"><a href="#cb81-143" aria-hidden="true" tabindex="-1"></a>tabla_metricas <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb81-144"><a href="#cb81-144" aria-hidden="true" tabindex="-1"></a>  <span class="at">Pliegue =</span> <span class="dv">1</span><span class="sc">:</span>k_outer,</span>
<span id="cb81-145"><a href="#cb81-145" aria-hidden="true" tabindex="-1"></a>  <span class="at">AUC =</span> <span class="fu">sapply</span>(resultados_auc, round, <span class="at">digits =</span> <span class="dv">3</span>),</span>
<span id="cb81-146"><a href="#cb81-146" aria-hidden="true" tabindex="-1"></a>  <span class="at">Accuracy =</span> <span class="fu">sapply</span>(resultados_accuracy, round, <span class="at">digits =</span> <span class="dv">3</span>),</span>
<span id="cb81-147"><a href="#cb81-147" aria-hidden="true" tabindex="-1"></a>  <span class="at">Recall =</span> <span class="fu">sapply</span>(resultados_sensibilidad, round, <span class="at">digits =</span> <span class="dv">3</span>)</span>
<span id="cb81-148"><a href="#cb81-148" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb81-149"><a href="#cb81-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-150"><a href="#cb81-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-151"><a href="#cb81-151" aria-hidden="true" tabindex="-1"></a><span class="co"># Agregar fila con promedio de métricas</span></span>
<span id="cb81-152"><a href="#cb81-152" aria-hidden="true" tabindex="-1"></a>tabla_metricas_nnet_embeded <span class="ot">&lt;-</span> <span class="fu">rbind</span>(tabla_metricas, <span class="fu">c</span>(<span class="st">"Mean"</span>, <span class="fu">round</span>(auc_promedio,<span class="dv">3</span>), <span class="fu">round</span>(accuracy_promedio,<span class="dv">3</span>), <span class="fu">round</span>(sensibilidad_promedio,<span class="dv">3</span>)))</span>
<span id="cb81-153"><a href="#cb81-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-154"><a href="#cb81-154" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb81-155"><a href="#cb81-155" aria-hidden="true" tabindex="-1"></a>execution_time_nnet_embeded <span class="ot">&lt;-</span> end_time <span class="sc">-</span> start_time</span>
<span id="cb81-156"><a href="#cb81-156" aria-hidden="true" tabindex="-1"></a>execution_time_nnet_embeded <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(execution_time_nnet_embeded, <span class="at">units =</span> <span class="st">"secs"</span>)</span>
<span id="cb81-157"><a href="#cb81-157" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(tabla_metricas_nnet_embeded, <span class="at">file =</span> <span class="st">"tabla_metricas_nnet_embeded.RData"</span>)</span>
<span id="cb81-158"><a href="#cb81-158" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(execution_time_nnet_embeded, <span class="at">file =</span> <span class="st">"execution_time_nnet_embeded.RData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"tabla_metricas_nnet_embeded.RData"</span>)</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"execution_time_nnet_embeded.RData"</span>)</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time_nnet_embeded,  <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-13-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-13-1" role="tab" aria-controls="tabset-13-1" aria-selected="true" href="">Metrics Table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-13-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-13-2" role="tab" aria-controls="tabset-13-2" aria-selected="false" href="">Metrics Plot</a></li></ul>
<div class="tab-content">
<div id="tabset-13-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-13-1-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir tabla formateada con kableExtra</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(tabla_metricas_nnet_embeded, <span class="at">caption =</span> <span class="st">"Cross Validation Metrics"</span>, <span class="at">align =</span> <span class="st">"c"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="tabset-13-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-13-2-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="fu">crear_plot_metricas_per_fold</span>(tabla_metricas_nnet_embeded)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
<p>It seems that there are not a lot of redundant variables, so it works better with more variables.</p>
</div>
<div id="tabset-15-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-15-4-tab">
<p>Specially in this case, it is important to limit the hyperparameters due to the high computational cost of the wrapper method.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Establecer la fórmula base para el modelo logístico</span></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>formula_base <span class="ot">&lt;-</span> <span class="fu">formula</span>(ESTADO_ACTUAL <span class="sc">~</span> <span class="dv">1</span>)  <span class="co"># Fórmula inicial sin predictoras</span></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtener nombres de variables predictoras</span></span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>variables <span class="ot">&lt;-</span> <span class="fu">names</span>(data)[<span class="sc">-</span><span class="fu">which</span>(<span class="fu">names</span>(data) <span class="sc">==</span> <span class="st">"ESTADO_ACTUAL"</span>)]</span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtener todas las combinaciones posibles de variables predictoras</span></span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a>combinaciones_variables <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(variables), <span class="cf">function</span>(x) <span class="fu">combn</span>(variables, x, <span class="at">simplify =</span> <span class="cn">FALSE</span>)), <span class="at">recursive =</span> <span class="cn">FALSE</span>)</span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Configurar la validación cruzada 5x2</span></span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a>k_outer <span class="ot">&lt;-</span> <span class="dv">5</span>  <span class="co"># Número de pliegues externos</span></span>
<span id="cb85-14"><a href="#cb85-14" aria-hidden="true" tabindex="-1"></a>k_inner <span class="ot">&lt;-</span> <span class="dv">2</span>  <span class="co"># Número de pliegues internos</span></span>
<span id="cb85-15"><a href="#cb85-15" aria-hidden="true" tabindex="-1"></a>folds_outer <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(data<span class="sc">$</span>ESTADO_ACTUAL, <span class="at">k =</span> k_outer, <span class="at">list =</span> <span class="cn">FALSE</span>)  <span class="co"># Obtener índices de pliegues externos</span></span>
<span id="cb85-16"><a href="#cb85-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-17"><a href="#cb85-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Lista para almacenar resultados</span></span>
<span id="cb85-18"><a href="#cb85-18" aria-hidden="true" tabindex="-1"></a>resultados_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb85-19"><a href="#cb85-19" aria-hidden="true" tabindex="-1"></a>resultados_sensibilidad <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb85-20"><a href="#cb85-20" aria-hidden="true" tabindex="-1"></a>resultados_accuracy <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb85-21"><a href="#cb85-21" aria-hidden="true" tabindex="-1"></a>indices <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data)</span>
<span id="cb85-22"><a href="#cb85-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-23"><a href="#cb85-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Inicializar matrices para almacenar predicciones y objetivos</span></span>
<span id="cb85-24"><a href="#cb85-24" aria-hidden="true" tabindex="-1"></a>predicciones_totales <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">nrow</span>(data), <span class="at">ncol =</span> k_outer)</span>
<span id="cb85-25"><a href="#cb85-25" aria-hidden="true" tabindex="-1"></a>targets_totales <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(data))</span>
<span id="cb85-26"><a href="#cb85-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-27"><a href="#cb85-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterar sobre cada pliegue externo y realizar el proceso de modelado</span></span>
<span id="cb85-28"><a href="#cb85-28" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i_outer <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k_outer) {</span>
<span id="cb85-29"><a href="#cb85-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-30"><a href="#cb85-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Obtener los índices para el pliegue externo actual</span></span>
<span id="cb85-31"><a href="#cb85-31" aria-hidden="true" tabindex="-1"></a>  test_indices_outer <span class="ot">&lt;-</span> indices[folds_outer<span class="sc">==</span>i_outer]  <span class="co"># Índices correspondientes al pliegue externo de test</span></span>
<span id="cb85-32"><a href="#cb85-32" aria-hidden="true" tabindex="-1"></a>  train_indices_outer <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data), test_indices_outer)  <span class="co"># Índices correspondientes al conjunto de entrenamiento</span></span>
<span id="cb85-33"><a href="#cb85-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb85-34"><a href="#cb85-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Dividir datos en entrenamiento y test para el pliegue externo</span></span>
<span id="cb85-35"><a href="#cb85-35" aria-hidden="true" tabindex="-1"></a>  datos_entrenamiento_outer <span class="ot">&lt;-</span> data[train_indices_outer, ]</span>
<span id="cb85-36"><a href="#cb85-36" aria-hidden="true" tabindex="-1"></a>  datos_test_outer <span class="ot">&lt;-</span> data[test_indices_outer, ]</span>
<span id="cb85-37"><a href="#cb85-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb85-38"><a href="#cb85-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-39"><a href="#cb85-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Configurar la validación cruzada interna</span></span>
<span id="cb85-40"><a href="#cb85-40" aria-hidden="true" tabindex="-1"></a>  folds_inner <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(datos_entrenamiento_outer<span class="sc">$</span>ESTADO_ACTUAL, <span class="at">k =</span> k_inner, <span class="at">list =</span> <span class="cn">FALSE</span>)  <span class="co"># Obtener índices de pliegues internos</span></span>
<span id="cb85-41"><a href="#cb85-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb85-42"><a href="#cb85-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Almacenar predicciones y test para formar una curva ROC general</span></span>
<span id="cb85-43"><a href="#cb85-43" aria-hidden="true" tabindex="-1"></a>  predicciones_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(datos_entrenamiento_outer))</span>
<span id="cb85-44"><a href="#cb85-44" aria-hidden="true" tabindex="-1"></a>  targets_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(datos_entrenamiento_outer))</span>
<span id="cb85-45"><a href="#cb85-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb85-46"><a href="#cb85-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Iterar sobre cada pliegue interno para selección de modelo</span></span>
<span id="cb85-47"><a href="#cb85-47" aria-hidden="true" tabindex="-1"></a>  indices_inner <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(datos_entrenamiento_outer)</span>
<span id="cb85-48"><a href="#cb85-48" aria-hidden="true" tabindex="-1"></a>  resultados_auc_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb85-49"><a href="#cb85-49" aria-hidden="true" tabindex="-1"></a>  resultados_sensibilidad_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb85-50"><a href="#cb85-50" aria-hidden="true" tabindex="-1"></a>  resultados_accuracy_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb85-51"><a href="#cb85-51" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i_inner <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k_inner) {</span>
<span id="cb85-52"><a href="#cb85-52" aria-hidden="true" tabindex="-1"></a>   <span class="do">###############################</span></span>
<span id="cb85-53"><a href="#cb85-53" aria-hidden="true" tabindex="-1"></a>    <span class="do">#### Aqui el filtrado##########</span></span>
<span id="cb85-54"><a href="#cb85-54" aria-hidden="true" tabindex="-1"></a>    <span class="do">###############################</span></span>
<span id="cb85-55"><a href="#cb85-55" aria-hidden="true" tabindex="-1"></a><span class="co">#con poca variables solo unaa la vez o filtrado o wrapper</span></span>
<span id="cb85-56"><a href="#cb85-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb85-57"><a href="#cb85-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb85-58"><a href="#cb85-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb85-59"><a href="#cb85-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Obtener los índices para el pliegue interno actual</span></span>
<span id="cb85-60"><a href="#cb85-60" aria-hidden="true" tabindex="-1"></a>    test_indices_inner <span class="ot">&lt;-</span> indices_inner[folds_inner<span class="sc">==</span>i_inner]  <span class="co"># Índices correspondientes al pliegue interno de test</span></span>
<span id="cb85-61"><a href="#cb85-61" aria-hidden="true" tabindex="-1"></a>    train_indices_inner <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(datos_entrenamiento_outer), test_indices_inner)  <span class="co"># Índices correspondientes al conjunto de entrenamiento interno</span></span>
<span id="cb85-62"><a href="#cb85-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb85-63"><a href="#cb85-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Dividir datos en entrenamiento y test para el pliegue interno</span></span>
<span id="cb85-64"><a href="#cb85-64" aria-hidden="true" tabindex="-1"></a>    datos_entrenamiento_inner <span class="ot">&lt;-</span> datos_entrenamiento_outer[train_indices_inner, ]</span>
<span id="cb85-65"><a href="#cb85-65" aria-hidden="true" tabindex="-1"></a>    datos_validacion <span class="ot">&lt;-</span> datos_entrenamiento_outer[test_indices_inner, ]</span>
<span id="cb85-66"><a href="#cb85-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb85-67"><a href="#cb85-67" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb85-68"><a href="#cb85-68" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aplicar oversampling en el conjunto de entrenamiento interno</span></span>
<span id="cb85-69"><a href="#cb85-69" aria-hidden="true" tabindex="-1"></a>    datos_entrenamiento_oversampled <span class="ot">&lt;-</span> <span class="fu">ROSE</span>(ESTADO_ACTUAL <span class="sc">~</span> .,</span>
<span id="cb85-70"><a href="#cb85-70" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">data =</span> datos_entrenamiento_inner,</span>
<span id="cb85-71"><a href="#cb85-71" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">p =</span> <span class="fl">0.28</span>)<span class="sc">$</span>data</span>
<span id="cb85-72"><a href="#cb85-72" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb85-73"><a href="#cb85-73" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Inicializar variables para almacenar los resultados</span></span>
<span id="cb85-74"><a href="#cb85-74" aria-hidden="true" tabindex="-1"></a>    mejor_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb85-75"><a href="#cb85-75" aria-hidden="true" tabindex="-1"></a>    mejor_modelo <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb85-76"><a href="#cb85-76" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb85-77"><a href="#cb85-77" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Definir combinaciones de hiperparámetros</span></span>
<span id="cb85-78"><a href="#cb85-78" aria-hidden="true" tabindex="-1"></a>    params <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">size =</span> <span class="fu">c</span>(<span class="dv">15</span>), <span class="at">decay =</span> <span class="fu">c</span>(<span class="fl">0.01</span>,<span class="fl">0.5</span>,<span class="fl">0.001</span>), <span class="at">maxit =</span> <span class="fu">c</span>(<span class="dv">225</span>), <span class="at">skip =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb85-79"><a href="#cb85-79" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb85-80"><a href="#cb85-80" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (combinacion <span class="cf">in</span> combinaciones_variables) {</span>
<span id="cb85-81"><a href="#cb85-81" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Construir la fórmula con las variables actuales</span></span>
<span id="cb85-82"><a href="#cb85-82" aria-hidden="true" tabindex="-1"></a>      formula_actual <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(<span class="st">"ESTADO_ACTUAL"</span>, <span class="st">"~"</span>, <span class="fu">paste</span>(combinacion, <span class="at">collapse =</span> <span class="st">"+"</span>)))</span>
<span id="cb85-83"><a href="#cb85-83" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb85-84"><a href="#cb85-84" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Iterar sobre las combinaciones de hiperparámetros</span></span>
<span id="cb85-85"><a href="#cb85-85" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (param <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(params)) {</span>
<span id="cb85-86"><a href="#cb85-86" aria-hidden="true" tabindex="-1"></a>        size <span class="ot">&lt;-</span> params<span class="sc">$</span>size[param]</span>
<span id="cb85-87"><a href="#cb85-87" aria-hidden="true" tabindex="-1"></a>        decay <span class="ot">&lt;-</span> params<span class="sc">$</span>decay[param]</span>
<span id="cb85-88"><a href="#cb85-88" aria-hidden="true" tabindex="-1"></a>        maxit <span class="ot">&lt;-</span> params<span class="sc">$</span>maxit[param]</span>
<span id="cb85-89"><a href="#cb85-89" aria-hidden="true" tabindex="-1"></a>        skip <span class="ot">&lt;-</span> params<span class="sc">$</span>skip[param]</span>
<span id="cb85-90"><a href="#cb85-90" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb85-91"><a href="#cb85-91" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Entrenar el modelo con la combinación de hiperparámetros actual</span></span>
<span id="cb85-92"><a href="#cb85-92" aria-hidden="true" tabindex="-1"></a>        modelo <span class="ot">&lt;-</span> <span class="fu">nnet</span>(formula, <span class="at">data =</span> datos_entrenamiento_oversampled, <span class="at">size =</span> size, <span class="at">decay =</span> decay, <span class="at">maxit =</span> maxit, <span class="at">skip =</span> skip, <span class="at">trace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb85-93"><a href="#cb85-93" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb85-94"><a href="#cb85-94" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Realizar predicciones en datos de validación</span></span>
<span id="cb85-95"><a href="#cb85-95" aria-hidden="true" tabindex="-1"></a>        predicciones_validacion <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelo, <span class="at">newdata =</span> datos_validacion, <span class="at">type =</span> <span class="st">"raw"</span>)</span>
<span id="cb85-96"><a href="#cb85-96" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb85-97"><a href="#cb85-97" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calcular AUC para la combinación actual</span></span>
<span id="cb85-98"><a href="#cb85-98" aria-hidden="true" tabindex="-1"></a>        roc_obj <span class="ot">&lt;-</span> <span class="fu">roc</span>(<span class="fu">ifelse</span>(datos_validacion<span class="sc">$</span>ESTADO_ACTUAL <span class="sc">==</span> <span class="st">"SI"</span>, <span class="dv">1</span>, <span class="dv">0</span>), <span class="fu">ifelse</span>(predicciones_validacion <span class="sc">==</span> <span class="st">"SI"</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb85-99"><a href="#cb85-99" aria-hidden="true" tabindex="-1"></a>        auc_actual <span class="ot">&lt;-</span> <span class="fu">auc</span>(roc_obj)</span>
<span id="cb85-100"><a href="#cb85-100" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb85-101"><a href="#cb85-101" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Actualizar el mejor modelo y su AUC si se encuentra un modelo mejor</span></span>
<span id="cb85-102"><a href="#cb85-102" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (auc_actual <span class="sc">&gt;</span> mejor_auc) {</span>
<span id="cb85-103"><a href="#cb85-103" aria-hidden="true" tabindex="-1"></a>          mejor_auc <span class="ot">&lt;-</span> auc_actual</span>
<span id="cb85-104"><a href="#cb85-104" aria-hidden="true" tabindex="-1"></a>          mejor_modelo <span class="ot">&lt;-</span> modelo</span>
<span id="cb85-105"><a href="#cb85-105" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb85-106"><a href="#cb85-106" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb85-107"><a href="#cb85-107" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb85-108"><a href="#cb85-108" aria-hidden="true" tabindex="-1"></a>    <span class="do">########################</span></span>
<span id="cb85-109"><a href="#cb85-109" aria-hidden="true" tabindex="-1"></a>    predicciones_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(mejor_modelo, <span class="at">newdata =</span> datos_validacion, <span class="at">type =</span> <span class="st">"raw"</span>)</span>
<span id="cb85-110"><a href="#cb85-110" aria-hidden="true" tabindex="-1"></a>    clases_predichas_test <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predicciones_test <span class="sc">&gt;=</span> <span class="fl">0.5</span>, <span class="st">"SI"</span>, <span class="st">"NO"</span>)</span>
<span id="cb85-111"><a href="#cb85-111" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb85-112"><a href="#cb85-112" aria-hidden="true" tabindex="-1"></a>    <span class="do">###########################</span></span>
<span id="cb85-113"><a href="#cb85-113" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Realizar predicciones en el conjunto de entrenamiento externo para el AUC general</span></span>
<span id="cb85-114"><a href="#cb85-114" aria-hidden="true" tabindex="-1"></a>    predicciones_auc[test_indices_inner] <span class="ot">&lt;-</span> <span class="fu">predict</span>(mejor_modelo_auc, <span class="at">newdata =</span> datos_validacion, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb85-115"><a href="#cb85-115" aria-hidden="true" tabindex="-1"></a>    predicciones_clasificadas <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predicciones_auc[test_indices_inner] <span class="sc">&gt;=</span> <span class="fl">0.5</span>, <span class="st">"SI"</span>, <span class="st">"NO"</span>)</span>
<span id="cb85-116"><a href="#cb85-116" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb85-117"><a href="#cb85-117" aria-hidden="true" tabindex="-1"></a>    resultados_sensibilidad_inner[i_inner] <span class="ot">&lt;-</span> <span class="fu">sum</span>(clases_predichas_test <span class="sc">==</span> <span class="st">"SI"</span> <span class="sc">&amp;</span> datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]] <span class="sc">==</span> <span class="st">"SI"</span>) <span class="sc">/</span> <span class="fu">sum</span>(datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]] <span class="sc">==</span> <span class="st">"SI"</span>)</span>
<span id="cb85-118"><a href="#cb85-118" aria-hidden="true" tabindex="-1"></a>    resultados_accuracy_inner[i_inner] <span class="ot">&lt;-</span> <span class="fu">mean</span>(clases_predichas_test <span class="sc">==</span> datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]])</span>
<span id="cb85-119"><a href="#cb85-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-120"><a href="#cb85-120" aria-hidden="true" tabindex="-1"></a>    targets_auc[test_indices_inner] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(datos_validacion<span class="sc">$</span>ESTADO_ACTUAL) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb85-121"><a href="#cb85-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-122"><a href="#cb85-122" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb85-123"><a href="#cb85-123" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb85-124"><a href="#cb85-124" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular el AUC final para este fold externo</span></span>
<span id="cb85-125"><a href="#cb85-125" aria-hidden="true" tabindex="-1"></a>  auc_fold_externo <span class="ot">&lt;-</span> pROC<span class="sc">::</span><span class="fu">roc</span>(targets_auc, predicciones_auc)<span class="sc">$</span>auc</span>
<span id="cb85-126"><a href="#cb85-126" aria-hidden="true" tabindex="-1"></a>  accuracy_fold_externo <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_accuracy_inner)</span>
<span id="cb85-127"><a href="#cb85-127" aria-hidden="true" tabindex="-1"></a>  sensibilidad_fold_externo <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_sensibilidad_inner)</span>
<span id="cb85-128"><a href="#cb85-128" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb85-129"><a href="#cb85-129" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb85-130"><a href="#cb85-130" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Almacenar el AUC del fold externo actual</span></span>
<span id="cb85-131"><a href="#cb85-131" aria-hidden="true" tabindex="-1"></a>  resultados_auc[i_outer] <span class="ot">&lt;-</span> auc_fold_externo</span>
<span id="cb85-132"><a href="#cb85-132" aria-hidden="true" tabindex="-1"></a>  resultados_accuracy[i_outer] <span class="ot">&lt;-</span> accuracy_fold_externo</span>
<span id="cb85-133"><a href="#cb85-133" aria-hidden="true" tabindex="-1"></a>  resultados_sensibilidad[i_outer] <span class="ot">&lt;-</span> sensibilidad_fold_externo</span>
<span id="cb85-134"><a href="#cb85-134" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb85-135"><a href="#cb85-135" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Predecir en los datos de test para este pliegue externo y almacenar predicciones</span></span>
<span id="cb85-136"><a href="#cb85-136" aria-hidden="true" tabindex="-1"></a>  predicciones_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(mejor_modelo_auc, <span class="at">newdata =</span> datos_test_outer, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb85-137"><a href="#cb85-137" aria-hidden="true" tabindex="-1"></a>  predicciones_totales[test_indices_outer, i_outer] <span class="ot">&lt;-</span> predicciones_test</span>
<span id="cb85-138"><a href="#cb85-138" aria-hidden="true" tabindex="-1"></a>  targets_totales[test_indices_outer] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(datos_test_outer<span class="sc">$</span>ESTADO_ACTUAL) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb85-139"><a href="#cb85-139" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb85-140"><a href="#cb85-140" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb85-141"><a href="#cb85-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-142"><a href="#cb85-142" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular AUC promedio</span></span>
<span id="cb85-143"><a href="#cb85-143" aria-hidden="true" tabindex="-1"></a>auc_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_auc)</span>
<span id="cb85-144"><a href="#cb85-144" aria-hidden="true" tabindex="-1"></a>accuracy_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_accuracy)</span>
<span id="cb85-145"><a href="#cb85-145" aria-hidden="true" tabindex="-1"></a>sensibilidad_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_sensibilidad)</span>
<span id="cb85-146"><a href="#cb85-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-147"><a href="#cb85-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-148"><a href="#cb85-148" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear tabla con todas las métricas</span></span>
<span id="cb85-149"><a href="#cb85-149" aria-hidden="true" tabindex="-1"></a>tabla_metricas <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb85-150"><a href="#cb85-150" aria-hidden="true" tabindex="-1"></a>  <span class="at">Pliegue =</span> <span class="dv">1</span><span class="sc">:</span>k_outer,</span>
<span id="cb85-151"><a href="#cb85-151" aria-hidden="true" tabindex="-1"></a>  <span class="at">AUC =</span> <span class="fu">sapply</span>(resultados_auc, round, <span class="at">digits =</span> <span class="dv">3</span>),</span>
<span id="cb85-152"><a href="#cb85-152" aria-hidden="true" tabindex="-1"></a>  <span class="at">Accuracy =</span> <span class="fu">sapply</span>(resultados_accuracy, round, <span class="at">digits =</span> <span class="dv">3</span>),</span>
<span id="cb85-153"><a href="#cb85-153" aria-hidden="true" tabindex="-1"></a>  <span class="at">Recall =</span> <span class="fu">sapply</span>(resultados_sensibilidad, round, <span class="at">digits =</span> <span class="dv">3</span>)</span>
<span id="cb85-154"><a href="#cb85-154" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb85-155"><a href="#cb85-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-156"><a href="#cb85-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-157"><a href="#cb85-157" aria-hidden="true" tabindex="-1"></a><span class="co"># Agregar fila con promedio de métricas</span></span>
<span id="cb85-158"><a href="#cb85-158" aria-hidden="true" tabindex="-1"></a>tabla_metricas_nnet_wrapper <span class="ot">&lt;-</span> <span class="fu">rbind</span>(tabla_metricas, <span class="fu">c</span>(<span class="st">"Mean"</span>, <span class="fu">round</span>(auc_promedio,<span class="dv">3</span>), <span class="fu">round</span>(accuracy_promedio,<span class="dv">3</span>), <span class="fu">round</span>(sensibilidad_promedio,<span class="dv">3</span>)))</span>
<span id="cb85-159"><a href="#cb85-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-160"><a href="#cb85-160" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb85-161"><a href="#cb85-161" aria-hidden="true" tabindex="-1"></a>execution_time_nnet_wrapper <span class="ot">&lt;-</span> end_time <span class="sc">-</span> start_time</span>
<span id="cb85-162"><a href="#cb85-162" aria-hidden="true" tabindex="-1"></a>execution_time_nnet_wrapper <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(execution_time_nnet_wrapper, <span class="at">units =</span> <span class="st">"secs"</span>)</span>
<span id="cb85-163"><a href="#cb85-163" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(tabla_metricas_nnet_wrapper, <span class="at">file =</span> <span class="st">"tabla_metricas_nnet_wrapper.RData"</span>)</span>
<span id="cb85-164"><a href="#cb85-164" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(execution_time_nnet_wrapper, <span class="at">file =</span> <span class="st">"execution_time_nnet_wrapper.RData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"tabla_metricas_nnet_wrapper.RData"</span>)</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"execution_time_nnet_wrapper.RData"</span>)</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time_nnet_wrapper,  <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-14-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-14-1" role="tab" aria-controls="tabset-14-1" aria-selected="true" href="">Metrics Table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-14-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-14-2" role="tab" aria-controls="tabset-14-2" aria-selected="false" href="">Metrics Plot</a></li></ul>
<div class="tab-content">
<div id="tabset-14-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-14-1-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir tabla formateada con kableExtra</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(tabla_metricas_nnet_wrapper, <span class="at">caption =</span> <span class="st">"Cross Validation Metrics"</span>, <span class="at">align =</span> <span class="st">"c"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="tabset-14-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-14-2-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="fu">crear_plot_metricas_per_fold</span>(tabla_metricas_nnet_wrapper)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
<p>The performance and constancy of the model are good.</p>
</div>
<div id="tabset-15-5" class="tab-pane" role="tabpanel" aria-labelledby="tabset-15-5-tab">
<p>This is a resume of the model performance with every hyperparameters combination. The next table shows the top 10 and bottom 10 models by AUC.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Dividir el conjunto de datos en entrenamiento y test</span></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)  <span class="co"># Establecer una semilla para reproducibilidad</span></span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>indices_entrenamiento <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(data), <span class="fl">0.75</span> <span class="sc">*</span> <span class="fu">nrow</span>(data))  <span class="co"># 75% para entrenamiento</span></span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento <span class="ot">&lt;-</span> data[indices_entrenamiento, ]</span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a>datos_test <span class="ot">&lt;-</span> data[<span class="sc">-</span>indices_entrenamiento, ]</span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Dividir datos de entrenamiento en entrenamiento y validación</span></span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a>train_indices <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(datos_entrenamiento), <span class="fl">0.8</span> <span class="sc">*</span> <span class="fu">nrow</span>(datos_entrenamiento))  <span class="co"># 80% para entrenamiento</span></span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento_split <span class="ot">&lt;-</span> datos_entrenamiento[train_indices, ]</span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a>datos_validacion <span class="ot">&lt;-</span> datos_entrenamiento[<span class="sc">-</span>train_indices, ]</span>
<span id="cb89-13"><a href="#cb89-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-14"><a href="#cb89-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Oversampling</span></span>
<span id="cb89-15"><a href="#cb89-15" aria-hidden="true" tabindex="-1"></a>proportion <span class="ot">&lt;-</span> <span class="fl">0.28</span></span>
<span id="cb89-16"><a href="#cb89-16" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento_oversampled <span class="ot">&lt;-</span> <span class="fu">ROSE</span>(ESTADO_ACTUAL <span class="sc">~</span> ., <span class="at">data =</span> datos_entrenamiento_split, <span class="at">p =</span> proportion, <span class="at">seed =</span> <span class="dv">123</span>)<span class="sc">$</span>data</span>
<span id="cb89-17"><a href="#cb89-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-18"><a href="#cb89-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Inicializar variables para almacenar los resultados</span></span>
<span id="cb89-19"><a href="#cb89-19" aria-hidden="true" tabindex="-1"></a>mejor_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb89-20"><a href="#cb89-20" aria-hidden="true" tabindex="-1"></a>mejor_modelo <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb89-21"><a href="#cb89-21" aria-hidden="true" tabindex="-1"></a>resultados <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">size =</span> <span class="fu">integer</span>(), <span class="at">decay =</span> <span class="fu">numeric</span>(), <span class="at">maxit =</span> <span class="fu">integer</span>(), <span class="at">skip =</span> <span class="fu">integer</span>(), <span class="at">auc =</span> <span class="fu">numeric</span>(), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb89-22"><a href="#cb89-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-23"><a href="#cb89-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Definir combinaciones de hiperparámetros</span></span>
<span id="cb89-24"><a href="#cb89-24" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">size =</span> <span class="fu">c</span>(<span class="dv">15</span>, <span class="dv">40</span>), <span class="at">decay =</span> <span class="fu">c</span>(<span class="fl">0.01</span>, <span class="fl">0.5</span>, <span class="fl">0.001</span>), <span class="at">maxit =</span> <span class="fu">c</span>(<span class="dv">225</span>, <span class="dv">1000</span>, <span class="dv">5</span>), <span class="at">skip =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb89-25"><a href="#cb89-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-26"><a href="#cb89-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Fórmula con todas las variables predictoras</span></span>
<span id="cb89-27"><a href="#cb89-27" aria-hidden="true" tabindex="-1"></a>formula <span class="ot">&lt;-</span> ESTADO_ACTUAL <span class="sc">~</span> .</span>
<span id="cb89-28"><a href="#cb89-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-29"><a href="#cb89-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterar sobre las combinaciones de hiperparámetros</span></span>
<span id="cb89-30"><a href="#cb89-30" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (param <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(params)) {</span>
<span id="cb89-31"><a href="#cb89-31" aria-hidden="true" tabindex="-1"></a>  size <span class="ot">&lt;-</span> params<span class="sc">$</span>size[param]</span>
<span id="cb89-32"><a href="#cb89-32" aria-hidden="true" tabindex="-1"></a>  decay <span class="ot">&lt;-</span> params<span class="sc">$</span>decay[param]</span>
<span id="cb89-33"><a href="#cb89-33" aria-hidden="true" tabindex="-1"></a>  maxit <span class="ot">&lt;-</span> params<span class="sc">$</span>maxit[param]</span>
<span id="cb89-34"><a href="#cb89-34" aria-hidden="true" tabindex="-1"></a>  skip <span class="ot">&lt;-</span> params<span class="sc">$</span>skip[param]</span>
<span id="cb89-35"><a href="#cb89-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb89-36"><a href="#cb89-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Entrenar el modelo con la combinación de hiperparámetros actual</span></span>
<span id="cb89-37"><a href="#cb89-37" aria-hidden="true" tabindex="-1"></a>  modelo <span class="ot">&lt;-</span> <span class="fu">nnet</span>(formula, <span class="at">data =</span> datos_entrenamiento_oversampled, <span class="at">size =</span> size, <span class="at">decay =</span> decay, <span class="at">maxit =</span> maxit, <span class="at">skip =</span> skip, <span class="at">trace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb89-38"><a href="#cb89-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb89-39"><a href="#cb89-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Realizar predicciones en datos de prueba</span></span>
<span id="cb89-40"><a href="#cb89-40" aria-hidden="true" tabindex="-1"></a>  predicciones_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelo, <span class="at">newdata =</span> datos_test, <span class="at">type =</span> <span class="st">"raw"</span>)</span>
<span id="cb89-41"><a href="#cb89-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb89-42"><a href="#cb89-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular AUC para la combinación actual en datos de prueba</span></span>
<span id="cb89-43"><a href="#cb89-43" aria-hidden="true" tabindex="-1"></a>  roc_obj <span class="ot">&lt;-</span> <span class="fu">roc</span>(<span class="fu">ifelse</span>(datos_test<span class="sc">$</span>ESTADO_ACTUAL <span class="sc">==</span> <span class="st">"SI"</span>, <span class="dv">1</span>, <span class="dv">0</span>), predicciones_test)</span>
<span id="cb89-44"><a href="#cb89-44" aria-hidden="true" tabindex="-1"></a>  auc_actual <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">auc</span>(roc_obj))  <span class="co"># Extraer el valor numérico del AUC</span></span>
<span id="cb89-45"><a href="#cb89-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb89-46"><a href="#cb89-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Guardar los resultados en la tabla</span></span>
<span id="cb89-47"><a href="#cb89-47" aria-hidden="true" tabindex="-1"></a>  resultados <span class="ot">&lt;-</span> resultados <span class="sc">%&gt;%</span></span>
<span id="cb89-48"><a href="#cb89-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_row</span>(<span class="at">size =</span> size, <span class="at">decay =</span> decay, <span class="at">maxit =</span> maxit, <span class="at">skip =</span> skip, <span class="at">auc =</span> auc_actual)</span>
<span id="cb89-49"><a href="#cb89-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb89-50"><a href="#cb89-50" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Actualizar el mejor modelo y su AUC si se encuentra un modelo mejor</span></span>
<span id="cb89-51"><a href="#cb89-51" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (auc_actual <span class="sc">&gt;</span> mejor_auc) {</span>
<span id="cb89-52"><a href="#cb89-52" aria-hidden="true" tabindex="-1"></a>    mejor_auc <span class="ot">&lt;-</span> auc_actual</span>
<span id="cb89-53"><a href="#cb89-53" aria-hidden="true" tabindex="-1"></a>    mejor_modelo <span class="ot">&lt;-</span> modelo</span>
<span id="cb89-54"><a href="#cb89-54" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb89-55"><a href="#cb89-55" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb89-56"><a href="#cb89-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-57"><a href="#cb89-57" aria-hidden="true" tabindex="-1"></a><span class="co"># Ordenar los resultados por AUC en orden descendente</span></span>
<span id="cb89-58"><a href="#cb89-58" aria-hidden="true" tabindex="-1"></a>resultados_ordenados <span class="ot">&lt;-</span> resultados <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(<span class="fu">desc</span>(auc))</span>
<span id="cb89-59"><a href="#cb89-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-60"><a href="#cb89-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-61"><a href="#cb89-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-62"><a href="#cb89-62" aria-hidden="true" tabindex="-1"></a><span class="co"># Mostrar la tabla con los resultados de todas las combinaciones de hiperparámetros</span></span>
<span id="cb89-63"><a href="#cb89-63" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(resultados_ordenados, <span class="at">file =</span> <span class="st">"resultados_ordenados.RData"</span>)</span>
<span id="cb89-64"><a href="#cb89-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-65"><a href="#cb89-65" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb89-66"><a href="#cb89-66" aria-hidden="true" tabindex="-1"></a>execution_time <span class="ot">&lt;-</span> end_time <span class="sc">-</span> start_time</span>
<span id="cb89-67"><a href="#cb89-67" aria-hidden="true" tabindex="-1"></a>execution_time <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(execution_time, <span class="at">units =</span> <span class="st">"secs"</span>)</span>
<span id="cb89-68"><a href="#cb89-68" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(execution_time, <span class="at">file =</span> <span class="st">"execution_time_nnet.RData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cargar los datos guardados y mostrar las tablas</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"resultados_ordenados.RData"</span>)</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"execution_time_nnet.RData"</span>)</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time, <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Seleccionar los mejores 10 modelos</span></span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>mejores_10 <span class="ot">&lt;-</span> resultados_ordenados <span class="sc">%&gt;%</span> <span class="fu">head</span>(<span class="dv">10</span>)</span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Seleccionar los peores 10 modelos</span></span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a>peores_10 <span class="ot">&lt;-</span> resultados_ordenados <span class="sc">%&gt;%</span> <span class="fu">tail</span>(<span class="dv">10</span>)</span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir los mejores y peores modelos en tablas bonitas</span></span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a>mejores_10 <span class="sc">%&gt;%</span></span>
<span id="cb90-13"><a href="#cb90-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">caption =</span> <span class="st">"Top 10 Models by AUC"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb90-14"><a href="#cb90-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>, <span class="st">"condensed"</span>, <span class="st">"responsive"</span>))</span>
<span id="cb90-15"><a href="#cb90-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-16"><a href="#cb90-16" aria-hidden="true" tabindex="-1"></a>peores_10 <span class="sc">%&gt;%</span></span>
<span id="cb90-17"><a href="#cb90-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">caption =</span> <span class="st">"Bottom 10 Models by AUC"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb90-18"><a href="#cb90-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>, <span class="st">"condensed"</span>, <span class="st">"responsive"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a> <span class="co"># Instalar y cargar la librería plotly si no está instalada</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(plotly)) {</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">"plotly"</span>)</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(plotly)</span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Cargar los resultados</span></span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"resultados_ordenados.RData"</span>)</span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear la gráfica 3D con plotly</span></span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a>fig <span class="ot">&lt;-</span> <span class="fu">plot_ly</span>(</span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> resultados_ordenados,</span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> <span class="sc">~</span>size,</span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> <span class="sc">~</span>decay,</span>
<span id="cb91-15"><a href="#cb91-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">z =</span> <span class="sc">~</span>auc,</span>
<span id="cb91-16"><a href="#cb91-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">color =</span> <span class="sc">~</span><span class="fu">factor</span>(maxit),</span>
<span id="cb91-17"><a href="#cb91-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">colors =</span> <span class="fu">c</span>(<span class="st">"#3C5B6F"</span>, <span class="st">"steelblue"</span>, <span class="st">"lightblue"</span>),</span>
<span id="cb91-18"><a href="#cb91-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">symbol =</span> <span class="sc">~</span><span class="fu">factor</span>(skip),</span>
<span id="cb91-19"><a href="#cb91-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"scatter3d"</span>,</span>
<span id="cb91-20"><a href="#cb91-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">mode =</span> <span class="st">"markers"</span>,</span>
<span id="cb91-21"><a href="#cb91-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">marker =</span> <span class="fu">list</span>(<span class="at">size =</span> <span class="dv">5</span>)</span>
<span id="cb91-22"><a href="#cb91-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb91-23"><a href="#cb91-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-24"><a href="#cb91-24" aria-hidden="true" tabindex="-1"></a>fig <span class="ot">&lt;-</span> fig <span class="sc">%&gt;%</span></span>
<span id="cb91-25"><a href="#cb91-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layout</span>(</span>
<span id="cb91-26"><a href="#cb91-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"AUC for each combination of hyperparameters"</span>,</span>
<span id="cb91-27"><a href="#cb91-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">scene =</span> <span class="fu">list</span>(</span>
<span id="cb91-28"><a href="#cb91-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">xaxis =</span> <span class="fu">list</span>(<span class="at">title =</span> <span class="st">"Size"</span>),</span>
<span id="cb91-29"><a href="#cb91-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">yaxis =</span> <span class="fu">list</span>(<span class="at">title =</span> <span class="st">"Decay"</span>),</span>
<span id="cb91-30"><a href="#cb91-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">zaxis =</span> <span class="fu">list</span>(<span class="at">title =</span> <span class="st">"AUC"</span>)</span>
<span id="cb91-31"><a href="#cb91-31" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb91-32"><a href="#cb91-32" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb91-33"><a href="#cb91-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-34"><a href="#cb91-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Mostrar la gráfica</span></span>
<span id="cb91-35"><a href="#cb91-35" aria-hidden="true" tabindex="-1"></a>fig</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>It seem that the best models have a size of 15 and a decay of 0.01. The skip parameter does not seem to have a big impact on the model performance. These perrormance measuraments are extremely optimistic and do not correspond to the real performance of the model but it can help us to understand the hyperparameters impact on the model.</p>
</div>
</div>
</div>
</div>
<div id="tabset-35-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-35-3-tab">
<div class="tabset-margin-container"></div><div class="panel-tabset" style="background-color: #f0f0f0;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-18-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-18-1" role="tab" aria-controls="tabset-18-1" aria-selected="true" href="">Hold out</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-18-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-18-2" role="tab" aria-controls="tabset-18-2" aria-selected="false" href="">5x2 Cross Validation Filter</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-18-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-18-3" role="tab" aria-controls="tabset-18-3" aria-selected="false" href="">Hyperparameters Resume</a></li></ul>
<div class="tab-content" style="background-color: #f0f0f0;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;">
<div id="tabset-18-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-18-1-tab">
<p>In this section we are going to build a SVM model using different hyperparameters and evaluate it using a hold out validation.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Parámetros a cambiar:</span></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>proportion <span class="ot">&lt;-</span> <span class="fl">0.28</span></span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>sensitivity_weight <span class="ot">&lt;-</span> <span class="fl">0.8</span></span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Dividir el conjunto de datos en entrenamiento y test</span></span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)  <span class="co"># Establecer una semilla para reproducibilidad</span></span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>indices_entrenamiento <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(data), <span class="fl">0.75</span> <span class="sc">*</span> <span class="fu">nrow</span>(data))  <span class="co"># 75% para entrenamiento</span></span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento <span class="ot">&lt;-</span> data[indices_entrenamiento, ]</span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a>datos_test <span class="ot">&lt;-</span> data[<span class="sc">-</span>indices_entrenamiento, ]</span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Dividir datos de entrenamiento en entrenamiento y validación</span></span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true" tabindex="-1"></a>train_indices <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(datos_entrenamiento), <span class="fl">0.8</span> <span class="sc">*</span> <span class="fu">nrow</span>(datos_entrenamiento))  <span class="co"># 80% para entrenamiento</span></span>
<span id="cb92-15"><a href="#cb92-15" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento_split <span class="ot">&lt;-</span> datos_entrenamiento[train_indices, ]</span>
<span id="cb92-16"><a href="#cb92-16" aria-hidden="true" tabindex="-1"></a>datos_validacion <span class="ot">&lt;-</span> datos_entrenamiento[<span class="sc">-</span>train_indices, ]</span>
<span id="cb92-17"><a href="#cb92-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-18"><a href="#cb92-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Realizar oversampling</span></span>
<span id="cb92-19"><a href="#cb92-19" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento_oversampled <span class="ot">&lt;-</span> <span class="fu">ROSE</span>(ESTADO_ACTUAL <span class="sc">~</span> ., <span class="at">data =</span> datos_entrenamiento_split, <span class="at">seed =</span> <span class="dv">123</span>, <span class="at">p =</span> proportion)<span class="sc">$</span>data</span>
<span id="cb92-20"><a href="#cb92-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-21"><a href="#cb92-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Definir la fórmula para el modelo</span></span>
<span id="cb92-22"><a href="#cb92-22" aria-hidden="true" tabindex="-1"></a>formula <span class="ot">&lt;-</span> ESTADO_ACTUAL <span class="sc">~</span> .</span>
<span id="cb92-23"><a href="#cb92-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-24"><a href="#cb92-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-25"><a href="#cb92-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Inicializar variables para almacenar los resultados</span></span>
<span id="cb92-26"><a href="#cb92-26" aria-hidden="true" tabindex="-1"></a>mejor_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb92-27"><a href="#cb92-27" aria-hidden="true" tabindex="-1"></a>mejor_modelo <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb92-28"><a href="#cb92-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-29"><a href="#cb92-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Definir hiperparámetros a probar</span></span>
<span id="cb92-30"><a href="#cb92-30" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">cost =</span> <span class="fu">c</span>(<span class="dv">100</span>, <span class="dv">1000</span>, <span class="dv">10000</span>, <span class="dv">50000</span>, <span class="dv">1000000</span>),</span>
<span id="cb92-31"><a href="#cb92-31" aria-hidden="true" tabindex="-1"></a>                      <span class="at">gamma =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="dv">1</span>, <span class="dv">10</span>),</span>
<span id="cb92-32"><a href="#cb92-32" aria-hidden="true" tabindex="-1"></a>                      <span class="at">kernel =</span> <span class="fu">c</span>(<span class="st">"linear"</span>, <span class="st">"radial"</span>, <span class="st">"sigmoid"</span>))</span>
<span id="cb92-33"><a href="#cb92-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-34"><a href="#cb92-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Bucle para probar diferentes combinaciones de hiperparámetros</span></span>
<span id="cb92-35"><a href="#cb92-35" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(params)) {</span>
<span id="cb92-36"><a href="#cb92-36" aria-hidden="true" tabindex="-1"></a>  cost <span class="ot">&lt;-</span> params<span class="sc">$</span>cost[i]</span>
<span id="cb92-37"><a href="#cb92-37" aria-hidden="true" tabindex="-1"></a>  gamma <span class="ot">&lt;-</span> params<span class="sc">$</span>gamma[i]</span>
<span id="cb92-38"><a href="#cb92-38" aria-hidden="true" tabindex="-1"></a>  kernel <span class="ot">&lt;-</span> params<span class="sc">$</span>kernel[i]</span>
<span id="cb92-39"><a href="#cb92-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-40"><a href="#cb92-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Entrenar el modelo SVM con la combinación de hiperparámetros actual</span></span>
<span id="cb92-41"><a href="#cb92-41" aria-hidden="true" tabindex="-1"></a>  modelo <span class="ot">&lt;-</span> <span class="fu">svm</span>(formula, <span class="at">data =</span> datos_entrenamiento_oversampled, <span class="at">type =</span> <span class="st">"C-classification"</span>, <span class="at">kernel =</span> kernel, <span class="at">cost =</span> cost, <span class="at">gamma =</span> gamma, <span class="at">probability =</span> <span class="cn">TRUE</span>)</span>
<span id="cb92-42"><a href="#cb92-42" aria-hidden="true" tabindex="-1"></a>  <span class="do">##############################</span></span>
<span id="cb92-43"><a href="#cb92-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Realizar predicciones con probabilidades en datos de validación</span></span>
<span id="cb92-44"><a href="#cb92-44" aria-hidden="true" tabindex="-1"></a>  predicciones_validacion <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelo, <span class="at">newdata =</span> datos_validacion, <span class="at">probability =</span> <span class="cn">TRUE</span>)</span>
<span id="cb92-45"><a href="#cb92-45" aria-hidden="true" tabindex="-1"></a>  predicciones_validacion_prob <span class="ot">&lt;-</span> <span class="fu">attr</span>(predicciones_validacion, <span class="st">"probabilities"</span>)[, <span class="st">"SI"</span>]  <span class="co"># Asumiendo que "SI" es la clase positiva</span></span>
<span id="cb92-46"><a href="#cb92-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb92-47"><a href="#cb92-47" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular las predicciones finales basadas en probabilidades</span></span>
<span id="cb92-48"><a href="#cb92-48" aria-hidden="true" tabindex="-1"></a>  umbral <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb92-49"><a href="#cb92-49" aria-hidden="true" tabindex="-1"></a>  predicciones_finales <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predicciones_validacion_prob <span class="sc">&gt;=</span> umbral, <span class="st">"SI"</span>, <span class="st">"NO"</span>)</span>
<span id="cb92-50"><a href="#cb92-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb92-51"><a href="#cb92-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular la sensibilidad y la precisión</span></span>
<span id="cb92-52"><a href="#cb92-52" aria-hidden="true" tabindex="-1"></a>  TP <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_finales <span class="sc">==</span> <span class="st">"SI"</span> <span class="sc">&amp;</span> datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]] <span class="sc">==</span> <span class="st">"SI"</span>)</span>
<span id="cb92-53"><a href="#cb92-53" aria-hidden="true" tabindex="-1"></a>  FN <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_finales <span class="sc">==</span> <span class="st">"NO"</span> <span class="sc">&amp;</span> datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]] <span class="sc">==</span> <span class="st">"SI"</span>)</span>
<span id="cb92-54"><a href="#cb92-54" aria-hidden="true" tabindex="-1"></a>  FP <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_finales <span class="sc">==</span> <span class="st">"SI"</span> <span class="sc">&amp;</span> datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]] <span class="sc">==</span> <span class="st">"NO"</span>)</span>
<span id="cb92-55"><a href="#cb92-55" aria-hidden="true" tabindex="-1"></a>  TN <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_finales <span class="sc">==</span> <span class="st">"NO"</span> <span class="sc">&amp;</span> datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]] <span class="sc">==</span> <span class="st">"NO"</span>)</span>
<span id="cb92-56"><a href="#cb92-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb92-57"><a href="#cb92-57" aria-hidden="true" tabindex="-1"></a>  recall_actual <span class="ot">&lt;-</span> TP <span class="sc">/</span> (TP <span class="sc">+</span> FN)</span>
<span id="cb92-58"><a href="#cb92-58" aria-hidden="true" tabindex="-1"></a>  accuracy_actual <span class="ot">&lt;-</span> (TP <span class="sc">+</span> TN) <span class="sc">/</span> (TP <span class="sc">+</span> FN <span class="sc">+</span> FP <span class="sc">+</span> TN)</span>
<span id="cb92-59"><a href="#cb92-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb92-60"><a href="#cb92-60" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular el custom metric para la combinación actual</span></span>
<span id="cb92-61"><a href="#cb92-61" aria-hidden="true" tabindex="-1"></a>  custom_metric_actual <span class="ot">&lt;-</span> <span class="fu">compute_custom_metric</span>(recall_actual, accuracy_actual, sensitivity_weight)</span>
<span id="cb92-62"><a href="#cb92-62" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb92-63"><a href="#cb92-63" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Actualizar el mejor modelo y su rendimiento si se encuentra un modelo mejor</span></span>
<span id="cb92-64"><a href="#cb92-64" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (auc_actual <span class="sc">&gt;</span> mejor_auc) {</span>
<span id="cb92-65"><a href="#cb92-65" aria-hidden="true" tabindex="-1"></a>    mejor_auc <span class="ot">&lt;-</span> auc_actual</span>
<span id="cb92-66"><a href="#cb92-66" aria-hidden="true" tabindex="-1"></a>    mejor_modelo <span class="ot">&lt;-</span> modelo</span>
<span id="cb92-67"><a href="#cb92-67" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb92-68"><a href="#cb92-68" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb92-69"><a href="#cb92-69" aria-hidden="true" tabindex="-1"></a><span class="do">#########################33</span></span>
<span id="cb92-70"><a href="#cb92-70" aria-hidden="true" tabindex="-1"></a>mejor_modelo_svm <span class="ot">&lt;-</span> mejor_modelo</span>
<span id="cb92-71"><a href="#cb92-71" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb92-72"><a href="#cb92-72" aria-hidden="true" tabindex="-1"></a>execution_time_svm <span class="ot">&lt;-</span> end_time <span class="sc">-</span> start_time</span>
<span id="cb92-73"><a href="#cb92-73" aria-hidden="true" tabindex="-1"></a>execution_time_svm <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(execution_time_svm, <span class="at">units =</span> <span class="st">"secs"</span>)</span>
<span id="cb92-74"><a href="#cb92-74" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(mejor_modelo_svm, <span class="at">file =</span> <span class="st">"mejor_modelo_svm.RData"</span>)</span>
<span id="cb92-75"><a href="#cb92-75" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(execution_time_svm, <span class="at">file =</span> <span class="st">"execution_time_svm.RData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"mejor_modelo_svm.RData"</span>)</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"execution_time_svm.RData"</span>)</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mejor_modelo_svm)</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time_svm,  <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-16-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-16-1" role="tab" aria-controls="tabset-16-1" aria-selected="true" href="">Predictions</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-16-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-16-2" role="tab" aria-controls="tabset-16-2" aria-selected="false" href="">Roc curve and auc</a></li></ul>
<div class="tab-content">
<div id="tabset-16-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-16-1-tab">
<p>We are going to predict on test in order to get a estimation of the performance of the model.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular las predicciones para el conjunto de test</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>predicciones_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(mejor_modelo_svm, <span class="at">newdata =</span> datos_test, <span class="at">probability =</span> <span class="cn">TRUE</span>)</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>predicciones_test <span class="ot">&lt;-</span> <span class="fu">attr</span>(predicciones_test, <span class="st">"probabilities"</span>)[, <span class="st">"SI"</span>]  <span class="co"># Asumiendo que "SI" es la clase positiva</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>clases_predichas_test <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predicciones_test <span class="sc">&gt;=</span> <span class="fl">0.5</span>, <span class="st">"SI"</span>, <span class="st">"NO"</span>)</span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a><span class="fu">mostrar_metricas</span>(datos_test<span class="sc">$</span>ESTADO_ACTUAL,clases_predichas_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Even though the model has a good auc, the recall is not good enough. This is because the model is not able to detect the positive cases. This is unacceptable in a medical context, we are going to see if the metrics are robust using a 5x2 cross validation and if it is not we are going to try to improve the model with variable selection techniques.</p>
</div>
<div id="tabset-16-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-16-2-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular la curva ROC y el AUC para el conjunto de test</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_roc_curve</span>(predicciones_test,datos_test<span class="sc">$</span>ESTADO_ACTUAL)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div id="tabset-18-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-18-2-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Establecer la fórmula base para el modelo logístico</span></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>formula_base <span class="ot">&lt;-</span> <span class="fu">formula</span>(ESTADO_ACTUAL <span class="sc">~</span> <span class="dv">1</span>)  <span class="co"># Fórmula inicial sin predictoras</span></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtener nombres de variables predictoras</span></span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>variables <span class="ot">&lt;-</span> <span class="fu">names</span>(data)[<span class="sc">-</span><span class="fu">which</span>(<span class="fu">names</span>(data) <span class="sc">==</span> <span class="st">"ESTADO_ACTUAL"</span>)]</span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtener todas las combinaciones posibles de variables predictoras</span></span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a>combinaciones_variables <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(variables), <span class="cf">function</span>(x) <span class="fu">combn</span>(variables, x, <span class="at">simplify =</span> <span class="cn">FALSE</span>)), <span class="at">recursive =</span> <span class="cn">FALSE</span>)</span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Configurar la validación cruzada 5x2</span></span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a>k_outer <span class="ot">&lt;-</span> <span class="dv">5</span>  <span class="co"># Número de pliegues externos</span></span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a>k_inner <span class="ot">&lt;-</span> <span class="dv">2</span>  <span class="co"># Número de pliegues internos</span></span>
<span id="cb96-15"><a href="#cb96-15" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)  <span class="co"># Establecer semilla para reproducibilidad</span></span>
<span id="cb96-16"><a href="#cb96-16" aria-hidden="true" tabindex="-1"></a>folds_outer <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(data<span class="sc">$</span>ESTADO_ACTUAL, <span class="at">k =</span> k_outer, <span class="at">list =</span> <span class="cn">FALSE</span>)  <span class="co"># Obtener índices de pliegues externos</span></span>
<span id="cb96-17"><a href="#cb96-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-18"><a href="#cb96-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Lista para almacenar resultados</span></span>
<span id="cb96-19"><a href="#cb96-19" aria-hidden="true" tabindex="-1"></a>resultados_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb96-20"><a href="#cb96-20" aria-hidden="true" tabindex="-1"></a>resultados_sensibilidad <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb96-21"><a href="#cb96-21" aria-hidden="true" tabindex="-1"></a>resultados_accuracy <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb96-22"><a href="#cb96-22" aria-hidden="true" tabindex="-1"></a>indices <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data)</span>
<span id="cb96-23"><a href="#cb96-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-24"><a href="#cb96-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Inicializar matrices para almacenar predicciones y objetivos</span></span>
<span id="cb96-25"><a href="#cb96-25" aria-hidden="true" tabindex="-1"></a>predicciones_totales <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">nrow</span>(data), <span class="at">ncol =</span> k_outer)</span>
<span id="cb96-26"><a href="#cb96-26" aria-hidden="true" tabindex="-1"></a>targets_totales <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(data))</span>
<span id="cb96-27"><a href="#cb96-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-28"><a href="#cb96-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterar sobre cada pliegue externo y realizar el proceso de modelado</span></span>
<span id="cb96-29"><a href="#cb96-29" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i_outer <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k_outer) {</span>
<span id="cb96-30"><a href="#cb96-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-31"><a href="#cb96-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Obtener los índices para el pliegue externo actual</span></span>
<span id="cb96-32"><a href="#cb96-32" aria-hidden="true" tabindex="-1"></a>  test_indices_outer <span class="ot">&lt;-</span> indices[folds_outer<span class="sc">==</span>i_outer]  <span class="co"># Índices correspondientes al pliegue externo de test</span></span>
<span id="cb96-33"><a href="#cb96-33" aria-hidden="true" tabindex="-1"></a>  train_indices_outer <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data), test_indices_outer)  <span class="co"># Índices correspondientes al conjunto de entrenamiento</span></span>
<span id="cb96-34"><a href="#cb96-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb96-35"><a href="#cb96-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Dividir datos en entrenamiento y test para el pliegue externo</span></span>
<span id="cb96-36"><a href="#cb96-36" aria-hidden="true" tabindex="-1"></a>  datos_entrenamiento_outer <span class="ot">&lt;-</span> data[train_indices_outer, ]</span>
<span id="cb96-37"><a href="#cb96-37" aria-hidden="true" tabindex="-1"></a>  datos_test_outer <span class="ot">&lt;-</span> data[test_indices_outer, ]</span>
<span id="cb96-38"><a href="#cb96-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb96-39"><a href="#cb96-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-40"><a href="#cb96-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Configurar la validación cruzada interna</span></span>
<span id="cb96-41"><a href="#cb96-41" aria-hidden="true" tabindex="-1"></a>  folds_inner <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(datos_entrenamiento_outer<span class="sc">$</span>ESTADO_ACTUAL, <span class="at">k =</span> k_inner, <span class="at">list =</span> <span class="cn">FALSE</span>)  <span class="co"># Obtener índices de pliegues internos</span></span>
<span id="cb96-42"><a href="#cb96-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb96-43"><a href="#cb96-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Almacenar predicciones y test para formar una curva ROC general</span></span>
<span id="cb96-44"><a href="#cb96-44" aria-hidden="true" tabindex="-1"></a>  predicciones_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(datos_entrenamiento_outer))</span>
<span id="cb96-45"><a href="#cb96-45" aria-hidden="true" tabindex="-1"></a>  targets_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(datos_entrenamiento_outer))</span>
<span id="cb96-46"><a href="#cb96-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb96-47"><a href="#cb96-47" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Iterar sobre cada pliegue interno para selección de modelo</span></span>
<span id="cb96-48"><a href="#cb96-48" aria-hidden="true" tabindex="-1"></a>  indices_inner <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(datos_entrenamiento_outer)</span>
<span id="cb96-49"><a href="#cb96-49" aria-hidden="true" tabindex="-1"></a>  resultados_auc_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb96-50"><a href="#cb96-50" aria-hidden="true" tabindex="-1"></a>  resultados_sensibilidad_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb96-51"><a href="#cb96-51" aria-hidden="true" tabindex="-1"></a>  resultados_accuracy_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb96-52"><a href="#cb96-52" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i_inner <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k_inner) {</span>
<span id="cb96-53"><a href="#cb96-53" aria-hidden="true" tabindex="-1"></a>    <span class="do">###############################</span></span>
<span id="cb96-54"><a href="#cb96-54" aria-hidden="true" tabindex="-1"></a>    <span class="do">#### Aqui el filtrado##########</span></span>
<span id="cb96-55"><a href="#cb96-55" aria-hidden="true" tabindex="-1"></a>    <span class="do">###############################</span></span>
<span id="cb96-56"><a href="#cb96-56" aria-hidden="true" tabindex="-1"></a>    filter_data <span class="ot">&lt;-</span> <span class="fu">filter_dependency</span>(datos_entrenamiento_outer,<span class="st">"ESTADO_ACTUAL"</span>,<span class="fu">colnames</span>(datos_entrenamiento_outer),<span class="fl">0.05</span>)</span>
<span id="cb96-57"><a href="#cb96-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="st">"ESTADO_ACTUAL.1"</span> <span class="sc">%in%</span> <span class="fu">colnames</span>(filter_data)) {</span>
<span id="cb96-58"><a href="#cb96-58" aria-hidden="true" tabindex="-1"></a>      filter_data <span class="ot">&lt;-</span> filter_data[, <span class="sc">!</span><span class="fu">colnames</span>(filter_data) <span class="sc">%in%</span> <span class="st">"ESTADO_ACTUAL.1"</span>, drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb96-59"><a href="#cb96-59" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb96-60"><a href="#cb96-60" aria-hidden="true" tabindex="-1"></a><span class="co">#con poca variables solo unaa la vez o filtrado o wrapper</span></span>
<span id="cb96-61"><a href="#cb96-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb96-62"><a href="#cb96-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb96-63"><a href="#cb96-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb96-64"><a href="#cb96-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Obtener los índices para el pliegue interno actual</span></span>
<span id="cb96-65"><a href="#cb96-65" aria-hidden="true" tabindex="-1"></a>    test_indices_inner <span class="ot">&lt;-</span> indices_inner[folds_inner<span class="sc">==</span>i_inner]  <span class="co"># Índices correspondientes al pliegue interno de test</span></span>
<span id="cb96-66"><a href="#cb96-66" aria-hidden="true" tabindex="-1"></a>    train_indices_inner <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(filter_data), test_indices_inner)  <span class="co"># Índices correspondientes al conjunto de entrenamiento interno</span></span>
<span id="cb96-67"><a href="#cb96-67" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb96-68"><a href="#cb96-68" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Dividir datos en entrenamiento y test para el pliegue interno</span></span>
<span id="cb96-69"><a href="#cb96-69" aria-hidden="true" tabindex="-1"></a>    datos_entrenamiento_inner <span class="ot">&lt;-</span> filter_data[train_indices_inner, ]</span>
<span id="cb96-70"><a href="#cb96-70" aria-hidden="true" tabindex="-1"></a>    datos_validacion <span class="ot">&lt;-</span> filter_data[test_indices_inner, ]</span>
<span id="cb96-71"><a href="#cb96-71" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb96-72"><a href="#cb96-72" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb96-73"><a href="#cb96-73" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aplicar oversampling en el conjunto de entrenamiento interno</span></span>
<span id="cb96-74"><a href="#cb96-74" aria-hidden="true" tabindex="-1"></a>    datos_entrenamiento_oversampled <span class="ot">&lt;-</span> <span class="fu">ROSE</span>(ESTADO_ACTUAL <span class="sc">~</span> .,</span>
<span id="cb96-75"><a href="#cb96-75" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">data =</span> datos_entrenamiento_inner,</span>
<span id="cb96-76"><a href="#cb96-76" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">seed =</span> <span class="dv">123</span>,</span>
<span id="cb96-77"><a href="#cb96-77" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">p =</span> <span class="fl">0.28</span>)<span class="sc">$</span>data</span>
<span id="cb96-78"><a href="#cb96-78" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb96-79"><a href="#cb96-79" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Definir la fórmula para el modelo</span></span>
<span id="cb96-80"><a href="#cb96-80" aria-hidden="true" tabindex="-1"></a>    formula <span class="ot">&lt;-</span> ESTADO_ACTUAL <span class="sc">~</span> .</span>
<span id="cb96-81"><a href="#cb96-81" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb96-82"><a href="#cb96-82" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Definir la función para calcular el custom metric</span></span>
<span id="cb96-83"><a href="#cb96-83" aria-hidden="true" tabindex="-1"></a>    compute_custom_metric <span class="ot">&lt;-</span> <span class="cf">function</span>(recall, accuracy, <span class="at">sensitivity_weight =</span> <span class="fl">0.8</span>) {</span>
<span id="cb96-84"><a href="#cb96-84" aria-hidden="true" tabindex="-1"></a>      custom_metric <span class="ot">&lt;-</span> (sensitivity_weight <span class="sc">*</span> recall) <span class="sc">+</span> ((<span class="dv">1</span> <span class="sc">-</span> sensitivity_weight) <span class="sc">*</span> accuracy)</span>
<span id="cb96-85"><a href="#cb96-85" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(custom_metric)</span>
<span id="cb96-86"><a href="#cb96-86" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb96-87"><a href="#cb96-87" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb96-88"><a href="#cb96-88" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Inicializar variables para almacenar los resultados</span></span>
<span id="cb96-89"><a href="#cb96-89" aria-hidden="true" tabindex="-1"></a>    mejor_custom_metric <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb96-90"><a href="#cb96-90" aria-hidden="true" tabindex="-1"></a>    mejor_modelo <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb96-91"><a href="#cb96-91" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb96-92"><a href="#cb96-92" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Definir hiperparámetros a probar</span></span>
<span id="cb96-93"><a href="#cb96-93" aria-hidden="true" tabindex="-1"></a>    params <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">cost =</span> <span class="fu">c</span>(<span class="dv">100</span>, <span class="dv">1000</span>, <span class="dv">10000</span>, <span class="dv">50000</span>, <span class="dv">1000000</span>),</span>
<span id="cb96-94"><a href="#cb96-94" aria-hidden="true" tabindex="-1"></a>                          <span class="at">gamma =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="dv">1</span>, <span class="dv">10</span>),</span>
<span id="cb96-95"><a href="#cb96-95" aria-hidden="true" tabindex="-1"></a>                          <span class="at">kernel =</span> <span class="fu">c</span>(<span class="st">"linear"</span>, <span class="st">"radial"</span>, <span class="st">"sigmoid"</span>))</span>
<span id="cb96-96"><a href="#cb96-96" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb96-97"><a href="#cb96-97" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Bucle para probar diferentes combinaciones de hiperparámetros</span></span>
<span id="cb96-98"><a href="#cb96-98" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(params)) {</span>
<span id="cb96-99"><a href="#cb96-99" aria-hidden="true" tabindex="-1"></a>      cost <span class="ot">&lt;-</span> params<span class="sc">$</span>cost[i]</span>
<span id="cb96-100"><a href="#cb96-100" aria-hidden="true" tabindex="-1"></a>      gamma <span class="ot">&lt;-</span> params<span class="sc">$</span>gamma[i]</span>
<span id="cb96-101"><a href="#cb96-101" aria-hidden="true" tabindex="-1"></a>      kernel <span class="ot">&lt;-</span> params<span class="sc">$</span>kernel[i]</span>
<span id="cb96-102"><a href="#cb96-102" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb96-103"><a href="#cb96-103" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Entrenar el modelo SVM con la combinación de hiperparámetros actual</span></span>
<span id="cb96-104"><a href="#cb96-104" aria-hidden="true" tabindex="-1"></a>      modelo <span class="ot">&lt;-</span> <span class="fu">svm</span>(formula, <span class="at">data =</span> datos_entrenamiento_oversampled, <span class="at">type =</span> <span class="st">"C-classification"</span>, <span class="at">kernel =</span> kernel, <span class="at">cost =</span> cost, <span class="at">gamma =</span> gamma, <span class="at">probability =</span> <span class="cn">TRUE</span>)</span>
<span id="cb96-105"><a href="#cb96-105" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb96-106"><a href="#cb96-106" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Realizar predicciones con probabilidades en datos de validación</span></span>
<span id="cb96-107"><a href="#cb96-107" aria-hidden="true" tabindex="-1"></a>      predicciones_validacion <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelo, <span class="at">newdata =</span> datos_validacion, <span class="at">probability =</span> <span class="cn">TRUE</span>)</span>
<span id="cb96-108"><a href="#cb96-108" aria-hidden="true" tabindex="-1"></a>      predicciones_validacion_prob <span class="ot">&lt;-</span> <span class="fu">attr</span>(predicciones_validacion, <span class="st">"probabilities"</span>)[, <span class="st">"SI"</span>]  <span class="co"># Asumiendo que "SI" es la clase positiva</span></span>
<span id="cb96-109"><a href="#cb96-109" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb96-110"><a href="#cb96-110" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Calcular las predicciones finales basadas en probabilidades</span></span>
<span id="cb96-111"><a href="#cb96-111" aria-hidden="true" tabindex="-1"></a>      umbral <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb96-112"><a href="#cb96-112" aria-hidden="true" tabindex="-1"></a>      predicciones_finales <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predicciones_validacion_prob <span class="sc">&gt;=</span> umbral, <span class="st">"SI"</span>, <span class="st">"NO"</span>)</span>
<span id="cb96-113"><a href="#cb96-113" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb96-114"><a href="#cb96-114" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Calcular la sensibilidad y la precisión</span></span>
<span id="cb96-115"><a href="#cb96-115" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_finales <span class="sc">==</span> <span class="st">"SI"</span> <span class="sc">&amp;</span> datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]] <span class="sc">==</span> <span class="st">"SI"</span>)</span>
<span id="cb96-116"><a href="#cb96-116" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_finales <span class="sc">==</span> <span class="st">"NO"</span> <span class="sc">&amp;</span> datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]] <span class="sc">==</span> <span class="st">"SI"</span>)</span>
<span id="cb96-117"><a href="#cb96-117" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_finales <span class="sc">==</span> <span class="st">"SI"</span> <span class="sc">&amp;</span> datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]] <span class="sc">==</span> <span class="st">"NO"</span>)</span>
<span id="cb96-118"><a href="#cb96-118" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_finales <span class="sc">==</span> <span class="st">"NO"</span> <span class="sc">&amp;</span> datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]] <span class="sc">==</span> <span class="st">"NO"</span>)</span>
<span id="cb96-119"><a href="#cb96-119" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb96-120"><a href="#cb96-120" aria-hidden="true" tabindex="-1"></a>      recall_actual <span class="ot">&lt;-</span> TP <span class="sc">/</span> (TP <span class="sc">+</span> FN)</span>
<span id="cb96-121"><a href="#cb96-121" aria-hidden="true" tabindex="-1"></a>      accuracy_actual <span class="ot">&lt;-</span> (TP <span class="sc">+</span> TN) <span class="sc">/</span> (TP <span class="sc">+</span> FN <span class="sc">+</span> FP <span class="sc">+</span> TN)</span>
<span id="cb96-122"><a href="#cb96-122" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb96-123"><a href="#cb96-123" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Calcular el custom metric para la combinación actual</span></span>
<span id="cb96-124"><a href="#cb96-124" aria-hidden="true" tabindex="-1"></a>      custom_metric_actual <span class="ot">&lt;-</span> <span class="fu">compute_custom_metric</span>(recall_actual, accuracy_actual, sensitivity_weight)</span>
<span id="cb96-125"><a href="#cb96-125" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb96-126"><a href="#cb96-126" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Actualizar el mejor modelo y su rendimiento si se encuentra un modelo mejor</span></span>
<span id="cb96-127"><a href="#cb96-127" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (custom_metric_actual <span class="sc">&gt;</span> mejor_custom_metric) {</span>
<span id="cb96-128"><a href="#cb96-128" aria-hidden="true" tabindex="-1"></a>        mejor_custom_metric <span class="ot">&lt;-</span> custom_metric_actual</span>
<span id="cb96-129"><a href="#cb96-129" aria-hidden="true" tabindex="-1"></a>        mejor_modelo <span class="ot">&lt;-</span> modelo</span>
<span id="cb96-130"><a href="#cb96-130" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb96-131"><a href="#cb96-131" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb96-132"><a href="#cb96-132" aria-hidden="true" tabindex="-1"></a>    <span class="do">########################</span></span>
<span id="cb96-133"><a href="#cb96-133" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calcular las predicciones para el conjunto de test</span></span>
<span id="cb96-134"><a href="#cb96-134" aria-hidden="true" tabindex="-1"></a>    predicciones_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(mejor_modelo, <span class="at">newdata =</span> datos_test, <span class="at">probability =</span> <span class="cn">TRUE</span>)</span>
<span id="cb96-135"><a href="#cb96-135" aria-hidden="true" tabindex="-1"></a>    predicciones_test <span class="ot">&lt;-</span> <span class="fu">attr</span>(predicciones_test, <span class="st">"probabilities"</span>)[, <span class="st">"SI"</span>]  <span class="co"># Asumiendo que "SI" es la clase positiva</span></span>
<span id="cb96-136"><a href="#cb96-136" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb96-137"><a href="#cb96-137" aria-hidden="true" tabindex="-1"></a>    <span class="do">###########################</span></span>
<span id="cb96-138"><a href="#cb96-138" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb96-139"><a href="#cb96-139" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Realizar predicciones en el conjunto de entrenamiento externo para el AUC general</span></span>
<span id="cb96-140"><a href="#cb96-140" aria-hidden="true" tabindex="-1"></a>    predicciones_auc[test_indices_inner] <span class="ot">&lt;-</span> predicciones_test</span>
<span id="cb96-141"><a href="#cb96-141" aria-hidden="true" tabindex="-1"></a>    predicciones_clasificadas <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predicciones_auc[test_indices_inner] <span class="sc">&gt;=</span> <span class="fl">0.5</span>, <span class="st">"SI"</span>, <span class="st">"NO"</span>)</span>
<span id="cb96-142"><a href="#cb96-142" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb96-143"><a href="#cb96-143" aria-hidden="true" tabindex="-1"></a>    resultados_sensibilidad_inner[i_inner] <span class="ot">&lt;-</span> <span class="fu">sum</span>(clases_predichas_test <span class="sc">==</span> <span class="st">"SI"</span> <span class="sc">&amp;</span> datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]] <span class="sc">==</span> <span class="st">"SI"</span>) <span class="sc">/</span> <span class="fu">sum</span>(datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]] <span class="sc">==</span> <span class="st">"SI"</span>)</span>
<span id="cb96-144"><a href="#cb96-144" aria-hidden="true" tabindex="-1"></a>    resultados_accuracy_inner[i_inner] <span class="ot">&lt;-</span> <span class="fu">mean</span>(clases_predichas_test <span class="sc">==</span> datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]])</span>
<span id="cb96-145"><a href="#cb96-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-146"><a href="#cb96-146" aria-hidden="true" tabindex="-1"></a>    targets_auc[test_indices_inner] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(datos_validacion<span class="sc">$</span>ESTADO_ACTUAL) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb96-147"><a href="#cb96-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-148"><a href="#cb96-148" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb96-149"><a href="#cb96-149" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb96-150"><a href="#cb96-150" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular el AUC final para este fold externo</span></span>
<span id="cb96-151"><a href="#cb96-151" aria-hidden="true" tabindex="-1"></a>  auc_fold_externo <span class="ot">&lt;-</span> pROC<span class="sc">::</span><span class="fu">roc</span>(targets_auc, predicciones_auc)<span class="sc">$</span>auc</span>
<span id="cb96-152"><a href="#cb96-152" aria-hidden="true" tabindex="-1"></a>  accuracy_fold_externo <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_accuracy_inner)</span>
<span id="cb96-153"><a href="#cb96-153" aria-hidden="true" tabindex="-1"></a>  sensibilidad_fold_externo <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_sensibilidad_inner)</span>
<span id="cb96-154"><a href="#cb96-154" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb96-155"><a href="#cb96-155" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb96-156"><a href="#cb96-156" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Almacenar el AUC del fold externo actual</span></span>
<span id="cb96-157"><a href="#cb96-157" aria-hidden="true" tabindex="-1"></a>  resultados_auc[i_outer] <span class="ot">&lt;-</span> auc_fold_externo</span>
<span id="cb96-158"><a href="#cb96-158" aria-hidden="true" tabindex="-1"></a>  resultados_accuracy[i_outer] <span class="ot">&lt;-</span> accuracy_fold_externo</span>
<span id="cb96-159"><a href="#cb96-159" aria-hidden="true" tabindex="-1"></a>  resultados_sensibilidad[i_outer] <span class="ot">&lt;-</span> sensibilidad_fold_externo</span>
<span id="cb96-160"><a href="#cb96-160" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb96-161"><a href="#cb96-161" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Predecir en los datos de test para este pliegue externo y almacenar predicciones</span></span>
<span id="cb96-162"><a href="#cb96-162" aria-hidden="true" tabindex="-1"></a>  predicciones_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(mejor_modelo, <span class="at">newdata =</span> datos_test_outer, <span class="at">probability =</span> <span class="cn">TRUE</span>)</span>
<span id="cb96-163"><a href="#cb96-163" aria-hidden="true" tabindex="-1"></a>  predicciones_totales[test_indices_outer, i_outer] <span class="ot">&lt;-</span> predicciones_test</span>
<span id="cb96-164"><a href="#cb96-164" aria-hidden="true" tabindex="-1"></a>  targets_totales[test_indices_outer] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(datos_test_outer<span class="sc">$</span>ESTADO_ACTUAL) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb96-165"><a href="#cb96-165" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb96-166"><a href="#cb96-166" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb96-167"><a href="#cb96-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-168"><a href="#cb96-168" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular AUC promedio</span></span>
<span id="cb96-169"><a href="#cb96-169" aria-hidden="true" tabindex="-1"></a>auc_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_auc)</span>
<span id="cb96-170"><a href="#cb96-170" aria-hidden="true" tabindex="-1"></a>accuracy_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_accuracy)</span>
<span id="cb96-171"><a href="#cb96-171" aria-hidden="true" tabindex="-1"></a>sensibilidad_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_sensibilidad)</span>
<span id="cb96-172"><a href="#cb96-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-173"><a href="#cb96-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-174"><a href="#cb96-174" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear tabla con todas las métricas</span></span>
<span id="cb96-175"><a href="#cb96-175" aria-hidden="true" tabindex="-1"></a>tabla_metricas <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb96-176"><a href="#cb96-176" aria-hidden="true" tabindex="-1"></a>  <span class="at">Pliegue =</span> <span class="dv">1</span><span class="sc">:</span>k_outer,</span>
<span id="cb96-177"><a href="#cb96-177" aria-hidden="true" tabindex="-1"></a>  <span class="at">AUC =</span> <span class="fu">sapply</span>(resultados_auc, round, <span class="at">digits =</span> <span class="dv">3</span>),</span>
<span id="cb96-178"><a href="#cb96-178" aria-hidden="true" tabindex="-1"></a>  <span class="at">Accuracy =</span> <span class="fu">sapply</span>(resultados_accuracy, round, <span class="at">digits =</span> <span class="dv">3</span>),</span>
<span id="cb96-179"><a href="#cb96-179" aria-hidden="true" tabindex="-1"></a>  <span class="at">Recall =</span> <span class="fu">sapply</span>(resultados_sensibilidad, round, <span class="at">digits =</span> <span class="dv">3</span>)</span>
<span id="cb96-180"><a href="#cb96-180" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb96-181"><a href="#cb96-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-182"><a href="#cb96-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-183"><a href="#cb96-183" aria-hidden="true" tabindex="-1"></a><span class="co"># Agregar fila con promedio de métricas</span></span>
<span id="cb96-184"><a href="#cb96-184" aria-hidden="true" tabindex="-1"></a>tabla_metricas_svm_filter <span class="ot">&lt;-</span> <span class="fu">rbind</span>(tabla_metricas, <span class="fu">c</span>(<span class="st">"Mean"</span>, <span class="fu">round</span>(auc_promedio,<span class="dv">3</span>), <span class="fu">round</span>(accuracy_promedio,<span class="dv">3</span>), <span class="fu">round</span>(sensibilidad_promedio,<span class="dv">3</span>)))</span>
<span id="cb96-185"><a href="#cb96-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-186"><a href="#cb96-186" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb96-187"><a href="#cb96-187" aria-hidden="true" tabindex="-1"></a>execution_time_svm_filter <span class="ot">&lt;-</span> end_time <span class="sc">-</span> start_time</span>
<span id="cb96-188"><a href="#cb96-188" aria-hidden="true" tabindex="-1"></a>execution_time_svm_filter <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(execution_time_svm_filter, <span class="at">units =</span> <span class="st">"secs"</span>)</span>
<span id="cb96-189"><a href="#cb96-189" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(tabla_metricas_svm_filter, <span class="at">file =</span> <span class="st">"tabla_metricas_svm_filter.RData"</span>)</span>
<span id="cb96-190"><a href="#cb96-190" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(execution_time_svm_filter, <span class="at">file =</span> <span class="st">"execution_time_svm_filter.RData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"tabla_metricas_svm_filter.RData"</span>)</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"execution_time_svm_filter.RData"</span>)</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time_svm_filter,  <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-17-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-17-1" role="tab" aria-controls="tabset-17-1" aria-selected="true" href="">Metrics Table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-17-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-17-2" role="tab" aria-controls="tabset-17-2" aria-selected="false" href="">Metrics Plot</a></li></ul>
<div class="tab-content">
<div id="tabset-17-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-17-1-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir tabla formateada con kableExtra</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(tabla_metricas_svm_filter, <span class="at">caption =</span> <span class="st">"Cross Validation Metrics"</span>, <span class="at">align =</span> <span class="st">"c"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="tabset-17-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-17-2-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="fu">crear_plot_metricas_per_fold</span>(tabla_metricas_svm_filter)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
<p>As we suspected the model is not robust and the metrics are not good. To avoid unnecesary complexity we are not going to implement any variable selection technique since the model does not have a good performance.</p>
</div>
<div id="tabset-18-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-18-3-tab">
<p>This is a resume of the model performance with every hyperparameters combination. The next table shows the top 10 and bottom 10 models by AUC.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Dividir el conjunto de datos en entrenamiento y test</span></span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)  <span class="co"># Establecer una semilla para reproducibilidad</span></span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>indices_entrenamiento <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(data), <span class="fl">0.75</span> <span class="sc">*</span> <span class="fu">nrow</span>(data))  <span class="co"># 75% para entrenamiento</span></span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento <span class="ot">&lt;-</span> data[indices_entrenamiento, ]</span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a>datos_test <span class="ot">&lt;-</span> data[<span class="sc">-</span>indices_entrenamiento, ]</span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Dividir datos de entrenamiento en entrenamiento y validación</span></span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a>train_indices <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(datos_entrenamiento), <span class="fl">0.8</span> <span class="sc">*</span> <span class="fu">nrow</span>(datos_entrenamiento))  <span class="co"># 80% para entrenamiento</span></span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento_split <span class="ot">&lt;-</span> datos_entrenamiento[train_indices, ]</span>
<span id="cb100-12"><a href="#cb100-12" aria-hidden="true" tabindex="-1"></a>datos_validacion <span class="ot">&lt;-</span> datos_entrenamiento[<span class="sc">-</span>train_indices, ]</span>
<span id="cb100-13"><a href="#cb100-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-14"><a href="#cb100-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Oversampling</span></span>
<span id="cb100-15"><a href="#cb100-15" aria-hidden="true" tabindex="-1"></a>proportion <span class="ot">&lt;-</span> <span class="fl">0.28</span></span>
<span id="cb100-16"><a href="#cb100-16" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento_oversampled <span class="ot">&lt;-</span> <span class="fu">ROSE</span>(ESTADO_ACTUAL <span class="sc">~</span> ., <span class="at">data =</span> datos_entrenamiento_split, <span class="at">p =</span> proportion, <span class="at">seed =</span> <span class="dv">123</span>)<span class="sc">$</span>data</span>
<span id="cb100-17"><a href="#cb100-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-18"><a href="#cb100-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Inicializar variables para almacenar los resultados</span></span>
<span id="cb100-19"><a href="#cb100-19" aria-hidden="true" tabindex="-1"></a>mejor_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb100-20"><a href="#cb100-20" aria-hidden="true" tabindex="-1"></a>mejor_modelo <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb100-21"><a href="#cb100-21" aria-hidden="true" tabindex="-1"></a>resultados <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">kernel =</span> <span class="fu">character</span>(), <span class="at">cost =</span> <span class="fu">numeric</span>(), <span class="at">gamma =</span> <span class="fu">numeric</span>(), <span class="at">auc =</span> <span class="fu">numeric</span>(), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb100-22"><a href="#cb100-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-23"><a href="#cb100-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Definir hiperparámetros a probar</span></span>
<span id="cb100-24"><a href="#cb100-24" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">cost =</span> <span class="fu">c</span>(<span class="dv">100</span>, <span class="dv">1000</span>, <span class="dv">10000</span>, <span class="dv">50000</span>, <span class="dv">1000000</span>),</span>
<span id="cb100-25"><a href="#cb100-25" aria-hidden="true" tabindex="-1"></a>                      <span class="at">gamma =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="dv">1</span>, <span class="dv">10</span>),</span>
<span id="cb100-26"><a href="#cb100-26" aria-hidden="true" tabindex="-1"></a>                      <span class="at">kernel =</span> <span class="fu">c</span>(<span class="st">"linear"</span>, <span class="st">"radial"</span>, <span class="st">"sigmoid"</span>))</span>
<span id="cb100-27"><a href="#cb100-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-28"><a href="#cb100-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Bucle para probar diferentes combinaciones de hiperparámetros</span></span>
<span id="cb100-29"><a href="#cb100-29" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(params)) {</span>
<span id="cb100-30"><a href="#cb100-30" aria-hidden="true" tabindex="-1"></a>  cost <span class="ot">&lt;-</span> params<span class="sc">$</span>cost[i]</span>
<span id="cb100-31"><a href="#cb100-31" aria-hidden="true" tabindex="-1"></a>  gamma <span class="ot">&lt;-</span> params<span class="sc">$</span>gamma[i]</span>
<span id="cb100-32"><a href="#cb100-32" aria-hidden="true" tabindex="-1"></a>  kernel <span class="ot">&lt;-</span> params<span class="sc">$</span>kernel[i]</span>
<span id="cb100-33"><a href="#cb100-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-34"><a href="#cb100-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Entrenar el modelo SVM con la combinación de hiperparámetros actual</span></span>
<span id="cb100-35"><a href="#cb100-35" aria-hidden="true" tabindex="-1"></a>  modelo <span class="ot">&lt;-</span> <span class="fu">svm</span>(ESTADO_ACTUAL <span class="sc">~</span> ., <span class="at">data =</span> datos_entrenamiento_oversampled, <span class="at">type =</span> <span class="st">"C-classification"</span>, <span class="at">kernel =</span> kernel, <span class="at">cost =</span> cost, <span class="at">gamma =</span> gamma, <span class="at">probability =</span> <span class="cn">TRUE</span>)</span>
<span id="cb100-36"><a href="#cb100-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-37"><a href="#cb100-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Realizar predicciones en datos de prueba</span></span>
<span id="cb100-38"><a href="#cb100-38" aria-hidden="true" tabindex="-1"></a>  predicciones_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelo, <span class="at">newdata =</span> datos_test, <span class="at">probability =</span> <span class="cn">TRUE</span>)</span>
<span id="cb100-39"><a href="#cb100-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb100-40"><a href="#cb100-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular AUC para la combinación actual en datos de prueba</span></span>
<span id="cb100-41"><a href="#cb100-41" aria-hidden="true" tabindex="-1"></a>  roc_obj <span class="ot">&lt;-</span> <span class="fu">roc</span>(<span class="fu">ifelse</span>(datos_test<span class="sc">$</span>ESTADO_ACTUAL <span class="sc">==</span> <span class="st">"SI"</span>, <span class="dv">1</span>, <span class="dv">0</span>), <span class="fu">attr</span>(predicciones_test, <span class="st">"probabilities"</span>)[, <span class="dv">2</span>])</span>
<span id="cb100-42"><a href="#cb100-42" aria-hidden="true" tabindex="-1"></a>  auc_actual <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">auc</span>(roc_obj))  <span class="co"># Extraer el valor numérico del AUC</span></span>
<span id="cb100-43"><a href="#cb100-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb100-44"><a href="#cb100-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Guardar los resultados en la tabla</span></span>
<span id="cb100-45"><a href="#cb100-45" aria-hidden="true" tabindex="-1"></a>  resultados <span class="ot">&lt;-</span> resultados <span class="sc">%&gt;%</span></span>
<span id="cb100-46"><a href="#cb100-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_row</span>(<span class="at">kernel =</span> kernel, <span class="at">cost =</span> cost, <span class="at">gamma =</span> gamma, <span class="at">auc =</span> auc_actual)</span>
<span id="cb100-47"><a href="#cb100-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb100-48"><a href="#cb100-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Actualizar el mejor modelo y su AUC si se encuentra un modelo mejor</span></span>
<span id="cb100-49"><a href="#cb100-49" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (auc_actual <span class="sc">&gt;</span> mejor_auc) {</span>
<span id="cb100-50"><a href="#cb100-50" aria-hidden="true" tabindex="-1"></a>    mejor_auc <span class="ot">&lt;-</span> auc_actual</span>
<span id="cb100-51"><a href="#cb100-51" aria-hidden="true" tabindex="-1"></a>    mejor_modelo <span class="ot">&lt;-</span> modelo</span>
<span id="cb100-52"><a href="#cb100-52" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb100-53"><a href="#cb100-53" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb100-54"><a href="#cb100-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-55"><a href="#cb100-55" aria-hidden="true" tabindex="-1"></a><span class="co"># Ordenar los resultados por AUC en orden descendente</span></span>
<span id="cb100-56"><a href="#cb100-56" aria-hidden="true" tabindex="-1"></a>resultados_ordenados_svm <span class="ot">&lt;-</span> resultados <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(<span class="fu">desc</span>(auc))</span>
<span id="cb100-57"><a href="#cb100-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-58"><a href="#cb100-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-59"><a href="#cb100-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Mostrar la tabla con los resultados de todas las combinaciones de hiperparámetros</span></span>
<span id="cb100-60"><a href="#cb100-60" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(resultados_ordenados_svm, <span class="at">file =</span> <span class="st">"resultados_ordenados_svm.RData"</span>)</span>
<span id="cb100-61"><a href="#cb100-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-62"><a href="#cb100-62" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cargar los datos guardados y mostrar las tablas</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"resultados_ordenados_svm.RData"</span>)</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Seleccionar los mejores 10 modelos</span></span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>mejores_10 <span class="ot">&lt;-</span> resultados_ordenados_svm <span class="sc">%&gt;%</span> <span class="fu">head</span>(<span class="dv">10</span>)</span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Seleccionar los peores 10 modelos</span></span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>peores_10 <span class="ot">&lt;-</span> resultados_ordenados_svm <span class="sc">%&gt;%</span> <span class="fu">tail</span>(<span class="dv">10</span>)</span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir los mejores y peores modelos en tablas bonitas</span></span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a>mejores_10 <span class="sc">%&gt;%</span></span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">caption =</span> <span class="st">"Top 10 Models by AUC"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>, <span class="st">"condensed"</span>, <span class="st">"responsive"</span>))</span>
<span id="cb101-15"><a href="#cb101-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-16"><a href="#cb101-16" aria-hidden="true" tabindex="-1"></a>peores_10 <span class="sc">%&gt;%</span></span>
<span id="cb101-17"><a href="#cb101-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">caption =</span> <span class="st">"Bottom 10 Models by AUC"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb101-18"><a href="#cb101-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>, <span class="st">"condensed"</span>, <span class="st">"responsive"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>It seem that the best models have a cost of 100 and a gamma of 0.1. But the most importatnt hyperparameter is linear kernel. These performance measuraments are extremely optimistic and do not correspond to the real performance of the model but it can help us to understand the hyperparameters impact on the model. We have to ve careful with some hyperparameters that can lead to overfitting.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(plotly)</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Cargar los resultados</span></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"resultados_ordenados_svm.RData"</span>)</span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear la gráfica 3D con plotly</span></span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>fig <span class="ot">&lt;-</span> <span class="fu">plot_ly</span>(</span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> resultados_ordenados_svm,</span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> <span class="sc">~</span>cost,</span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> <span class="sc">~</span>gamma,</span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">z =</span> <span class="sc">~</span>auc,</span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">color =</span> <span class="sc">~</span>kernel,</span>
<span id="cb102-13"><a href="#cb102-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">colors =</span> <span class="fu">c</span>(<span class="st">"#3C5B6F"</span>, <span class="st">"steelblue"</span>, <span class="st">"lightblue"</span>),</span>
<span id="cb102-14"><a href="#cb102-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"scatter3d"</span>,</span>
<span id="cb102-15"><a href="#cb102-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">mode =</span> <span class="st">"markers"</span>,</span>
<span id="cb102-16"><a href="#cb102-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">marker =</span> <span class="fu">list</span>(<span class="at">size =</span> <span class="dv">5</span>)</span>
<span id="cb102-17"><a href="#cb102-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb102-18"><a href="#cb102-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-19"><a href="#cb102-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-20"><a href="#cb102-20" aria-hidden="true" tabindex="-1"></a>fig <span class="ot">&lt;-</span> fig <span class="sc">%&gt;%</span></span>
<span id="cb102-21"><a href="#cb102-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layout</span>(</span>
<span id="cb102-22"><a href="#cb102-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"AUC for every combination of hyperparameters"</span>,</span>
<span id="cb102-23"><a href="#cb102-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">scene =</span> <span class="fu">list</span>(</span>
<span id="cb102-24"><a href="#cb102-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">xaxis =</span> <span class="fu">list</span>(<span class="at">title =</span> <span class="st">"Cost"</span>, <span class="at">type =</span> <span class="st">"log"</span>),</span>
<span id="cb102-25"><a href="#cb102-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">yaxis =</span> <span class="fu">list</span>(<span class="at">title =</span> <span class="st">"Gamma"</span>, <span class="at">type =</span> <span class="st">"log"</span>),</span>
<span id="cb102-26"><a href="#cb102-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">zaxis =</span> <span class="fu">list</span>(<span class="at">title =</span> <span class="st">"AUC"</span>)</span>
<span id="cb102-27"><a href="#cb102-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb102-28"><a href="#cb102-28" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb102-29"><a href="#cb102-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-30"><a href="#cb102-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Mostrar la gráfica</span></span>
<span id="cb102-31"><a href="#cb102-31" aria-hidden="true" tabindex="-1"></a>fig</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div id="tabset-35-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-35-4-tab">
<div class="tabset-margin-container"></div><div class="panel-tabset" style="background-color: #f0f0f0;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-21-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-21-1" role="tab" aria-controls="tabset-21-1" aria-selected="true" href="">Hold out</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-21-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-21-2" role="tab" aria-controls="tabset-21-2" aria-selected="false" href="">5x2 Cross Validation Filter</a></li></ul>
<div class="tab-content" style="background-color: #f0f0f0;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;">
<div id="tabset-21-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-21-1-tab">
<p>In this section we are going to build a decision tree model using different hyperparameters like cp, minsplit and minbucket and evaluate it using a hold out validation.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Iniciar tiempo de ejecución</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Parámetros a cambiar</span></span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>proportion <span class="ot">&lt;-</span> <span class="fl">0.28</span></span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Dividir el conjunto de datos en entrenamiento y test</span></span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a>indices_entrenamiento <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(data), <span class="fl">0.75</span> <span class="sc">*</span> <span class="fu">nrow</span>(data))  <span class="co"># 75% para entrenamiento</span></span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento <span class="ot">&lt;-</span> data[indices_entrenamiento, ]</span>
<span id="cb103-10"><a href="#cb103-10" aria-hidden="true" tabindex="-1"></a>datos_test <span class="ot">&lt;-</span> data[<span class="sc">-</span>indices_entrenamiento, ]</span>
<span id="cb103-11"><a href="#cb103-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-12"><a href="#cb103-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Dividir datos de entrenamiento en entrenamiento y validación</span></span>
<span id="cb103-13"><a href="#cb103-13" aria-hidden="true" tabindex="-1"></a>train_indices <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(datos_entrenamiento), <span class="fl">0.8</span> <span class="sc">*</span> <span class="fu">nrow</span>(datos_entrenamiento))  <span class="co"># 80% para entrenamiento</span></span>
<span id="cb103-14"><a href="#cb103-14" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento_split <span class="ot">&lt;-</span> datos_entrenamiento[train_indices, ]</span>
<span id="cb103-15"><a href="#cb103-15" aria-hidden="true" tabindex="-1"></a>datos_validacion <span class="ot">&lt;-</span> datos_entrenamiento[<span class="sc">-</span>train_indices, ]</span>
<span id="cb103-16"><a href="#cb103-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-17"><a href="#cb103-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Sobremuestrear los datos de entrenamiento</span></span>
<span id="cb103-18"><a href="#cb103-18" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento_oversampled <span class="ot">&lt;-</span> <span class="fu">ROSE</span>(ESTADO_ACTUAL <span class="sc">~</span> ., <span class="at">data =</span> datos_entrenamiento_split, <span class="at">p =</span> proportion)<span class="sc">$</span>data</span>
<span id="cb103-19"><a href="#cb103-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-20"><a href="#cb103-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Definir la fórmula para el modelo</span></span>
<span id="cb103-21"><a href="#cb103-21" aria-hidden="true" tabindex="-1"></a>formula <span class="ot">&lt;-</span> ESTADO_ACTUAL <span class="sc">~</span> .</span>
<span id="cb103-22"><a href="#cb103-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-23"><a href="#cb103-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Inicializar variables para almacenar los resultados</span></span>
<span id="cb103-24"><a href="#cb103-24" aria-hidden="true" tabindex="-1"></a>mejor_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb103-25"><a href="#cb103-25" aria-hidden="true" tabindex="-1"></a>mejor_modelo <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb103-26"><a href="#cb103-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-27"><a href="#cb103-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Definir combinaciones de hiperparámetros a probar</span></span>
<span id="cb103-28"><a href="#cb103-28" aria-hidden="true" tabindex="-1"></a>param_grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">cp =</span> <span class="fu">c</span>(<span class="fl">0.01</span>, <span class="fl">0.05</span>, <span class="fl">0.1</span>), </span>
<span id="cb103-29"><a href="#cb103-29" aria-hidden="true" tabindex="-1"></a>                          <span class="at">minsplit =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">20</span>), </span>
<span id="cb103-30"><a href="#cb103-30" aria-hidden="true" tabindex="-1"></a>                          <span class="at">minbucket =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">20</span>))</span>
<span id="cb103-31"><a href="#cb103-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-32"><a href="#cb103-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Bucle para probar diferentes combinaciones de hiperparámetros</span></span>
<span id="cb103-33"><a href="#cb103-33" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (params <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(param_grid)) {</span>
<span id="cb103-34"><a href="#cb103-34" aria-hidden="true" tabindex="-1"></a>  cp <span class="ot">&lt;-</span> param_grid<span class="sc">$</span>cp[params]</span>
<span id="cb103-35"><a href="#cb103-35" aria-hidden="true" tabindex="-1"></a>  minsplit <span class="ot">&lt;-</span> param_grid<span class="sc">$</span>minsplit[params]</span>
<span id="cb103-36"><a href="#cb103-36" aria-hidden="true" tabindex="-1"></a>  minbucket <span class="ot">&lt;-</span> param_grid<span class="sc">$</span>minbucket[params]</span>
<span id="cb103-37"><a href="#cb103-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb103-38"><a href="#cb103-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Entrenar el modelo de árbol de decisión con la combinación de hiperparámetros actual</span></span>
<span id="cb103-39"><a href="#cb103-39" aria-hidden="true" tabindex="-1"></a>  modelo <span class="ot">&lt;-</span> <span class="fu">rpart</span>(formula, <span class="at">data =</span> datos_entrenamiento_oversampled, </span>
<span id="cb103-40"><a href="#cb103-40" aria-hidden="true" tabindex="-1"></a>                  <span class="at">control =</span> <span class="fu">rpart.control</span>(<span class="at">cp =</span> cp, <span class="at">minsplit =</span> minsplit, <span class="at">minbucket =</span> minbucket), </span>
<span id="cb103-41"><a href="#cb103-41" aria-hidden="true" tabindex="-1"></a>                  <span class="at">method =</span> <span class="st">"class"</span>)</span>
<span id="cb103-42"><a href="#cb103-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb103-43"><a href="#cb103-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Realizar predicciones en datos de validación</span></span>
<span id="cb103-44"><a href="#cb103-44" aria-hidden="true" tabindex="-1"></a>  prob_pred_validacion <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelo, <span class="at">newdata =</span> datos_validacion, <span class="at">type =</span> <span class="st">"prob"</span>)[,<span class="dv">2</span>]</span>
<span id="cb103-45"><a href="#cb103-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb103-46"><a href="#cb103-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular el AUC</span></span>
<span id="cb103-47"><a href="#cb103-47" aria-hidden="true" tabindex="-1"></a>  roc_obj <span class="ot">&lt;-</span> <span class="fu">roc</span>(datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]], prob_pred_validacion, <span class="at">levels =</span> <span class="fu">rev</span>(<span class="fu">levels</span>(datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]])))</span>
<span id="cb103-48"><a href="#cb103-48" aria-hidden="true" tabindex="-1"></a>  auc_actual <span class="ot">&lt;-</span> <span class="fu">auc</span>(roc_obj)</span>
<span id="cb103-49"><a href="#cb103-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb103-50"><a href="#cb103-50" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Actualizar el mejor modelo y su rendimiento si se encuentra un modelo mejor</span></span>
<span id="cb103-51"><a href="#cb103-51" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (auc_actual <span class="sc">&gt;</span> mejor_auc) {</span>
<span id="cb103-52"><a href="#cb103-52" aria-hidden="true" tabindex="-1"></a>    mejor_auc <span class="ot">&lt;-</span> auc_actual</span>
<span id="cb103-53"><a href="#cb103-53" aria-hidden="true" tabindex="-1"></a>    mejor_modelo <span class="ot">&lt;-</span> modelo</span>
<span id="cb103-54"><a href="#cb103-54" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb103-55"><a href="#cb103-55" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb103-56"><a href="#cb103-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-57"><a href="#cb103-57" aria-hidden="true" tabindex="-1"></a><span class="co"># Graficar el mejor modelo</span></span>
<span id="cb103-58"><a href="#cb103-58" aria-hidden="true" tabindex="-1"></a><span class="fu">rpart.plot</span>(mejor_modelo)</span>
<span id="cb103-59"><a href="#cb103-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-60"><a href="#cb103-60" aria-hidden="true" tabindex="-1"></a><span class="co"># Detener el tiempo de ejecución</span></span>
<span id="cb103-61"><a href="#cb103-61" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb103-62"><a href="#cb103-62" aria-hidden="true" tabindex="-1"></a>execution_time <span class="ot">&lt;-</span> end_time <span class="sc">-</span> start_time</span>
<span id="cb103-63"><a href="#cb103-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-64"><a href="#cb103-64" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir el tiempo de ejecución y el mejor AUC</span></span>
<span id="cb103-65"><a href="#cb103-65" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time,  <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-19-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-19-1" role="tab" aria-controls="tabset-19-1" aria-selected="true" href="">Predictions</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-19-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-19-2" role="tab" aria-controls="tabset-19-2" aria-selected="false" href="">Roc curve and auc</a></li></ul>
<div class="tab-content">
<div id="tabset-19-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-19-1-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular las predicciones para el conjunto de test</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>predicciones_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(mejor_modelo, <span class="at">newdata =</span> datos_test, <span class="at">probability =</span> <span class="cn">TRUE</span>)</span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>predicciones_test <span class="ot">&lt;-</span> predicciones_test[, <span class="st">"SI"</span>]  <span class="co"># Asumiendo que "SI" es la clase positiva</span></span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>clases_predichas_test <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predicciones_test <span class="sc">&gt;=</span> <span class="fl">0.5</span>, <span class="st">"SI"</span>, <span class="st">"NO"</span>)</span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a><span class="fu">mostrar_metricas</span>(datos_test<span class="sc">$</span>ESTADO_ACTUAL,clases_predichas_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="tabset-19-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-19-2-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular la curva ROC y el AUC para el conjunto de test</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_roc_curve</span>(predicciones_test,datos_test<span class="sc">$</span>ESTADO_ACTUAL)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
<p>The performance is bad compared to the previous models. We are going to see if the metrics are robust using a 5x2 cross validation.</p>
</div>
<div id="tabset-21-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-21-2-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Iniciar tiempo de ejecución</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Parámetros a cambiar</span></span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>proportion <span class="ot">&lt;-</span> <span class="fl">0.28</span></span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Configurar la validación cruzada 5x3</span></span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>k_outer <span class="ot">&lt;-</span> <span class="dv">5</span>  <span class="co"># Número de pliegues externos</span></span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a>k_inner <span class="ot">&lt;-</span> <span class="dv">3</span>  <span class="co"># Número de pliegues internos</span></span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a>folds_outer <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(data<span class="sc">$</span>ESTADO_ACTUAL, <span class="at">k =</span> k_outer, <span class="at">list =</span> <span class="cn">FALSE</span>)  <span class="co"># Obtener índices de pliegues externos</span></span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Lista para almacenar resultados</span></span>
<span id="cb106-13"><a href="#cb106-13" aria-hidden="true" tabindex="-1"></a>resultados_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb106-14"><a href="#cb106-14" aria-hidden="true" tabindex="-1"></a>resultados_accuracy <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb106-15"><a href="#cb106-15" aria-hidden="true" tabindex="-1"></a>resultados_sensibilidad <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb106-16"><a href="#cb106-16" aria-hidden="true" tabindex="-1"></a>indices <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data)</span>
<span id="cb106-17"><a href="#cb106-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-18"><a href="#cb106-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Inicializar matrices para almacenar predicciones y objetivos</span></span>
<span id="cb106-19"><a href="#cb106-19" aria-hidden="true" tabindex="-1"></a>predicciones_totales <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">nrow</span>(data), <span class="at">ncol =</span> k_outer)</span>
<span id="cb106-20"><a href="#cb106-20" aria-hidden="true" tabindex="-1"></a>targets_totales <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(data))</span>
<span id="cb106-21"><a href="#cb106-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-22"><a href="#cb106-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterar sobre cada pliegue externo y realizar el proceso de modelado</span></span>
<span id="cb106-23"><a href="#cb106-23" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i_outer <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k_outer) {</span>
<span id="cb106-24"><a href="#cb106-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-25"><a href="#cb106-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Obtener los índices para el pliegue externo actual</span></span>
<span id="cb106-26"><a href="#cb106-26" aria-hidden="true" tabindex="-1"></a>  test_indices_outer <span class="ot">&lt;-</span> indices[folds_outer <span class="sc">==</span> i_outer]  <span class="co"># Índices correspondientes al pliegue externo de test</span></span>
<span id="cb106-27"><a href="#cb106-27" aria-hidden="true" tabindex="-1"></a>  train_indices_outer <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data), test_indices_outer)  <span class="co"># Índices correspondientes al conjunto de entrenamiento</span></span>
<span id="cb106-28"><a href="#cb106-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-29"><a href="#cb106-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Dividir datos en entrenamiento y test para el pliegue externo</span></span>
<span id="cb106-30"><a href="#cb106-30" aria-hidden="true" tabindex="-1"></a>  datos_entrenamiento_outer <span class="ot">&lt;-</span> data[train_indices_outer, ]</span>
<span id="cb106-31"><a href="#cb106-31" aria-hidden="true" tabindex="-1"></a>  datos_test_outer <span class="ot">&lt;-</span> data[test_indices_outer, ]</span>
<span id="cb106-32"><a href="#cb106-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-33"><a href="#cb106-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Configurar la validación cruzada interna</span></span>
<span id="cb106-34"><a href="#cb106-34" aria-hidden="true" tabindex="-1"></a>  folds_inner <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(datos_entrenamiento_outer<span class="sc">$</span>ESTADO_ACTUAL, <span class="at">k =</span> k_inner, <span class="at">list =</span> <span class="cn">FALSE</span>)  <span class="co"># Obtener índices de pliegues internos</span></span>
<span id="cb106-35"><a href="#cb106-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-36"><a href="#cb106-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Almacenar predicciones y objetivos para el AUC general</span></span>
<span id="cb106-37"><a href="#cb106-37" aria-hidden="true" tabindex="-1"></a>  predicciones_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(datos_entrenamiento_outer))</span>
<span id="cb106-38"><a href="#cb106-38" aria-hidden="true" tabindex="-1"></a>  targets_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(datos_entrenamiento_outer))</span>
<span id="cb106-39"><a href="#cb106-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-40"><a href="#cb106-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Inicializar variables para almacenar resultados internos</span></span>
<span id="cb106-41"><a href="#cb106-41" aria-hidden="true" tabindex="-1"></a>  resultados_auc_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb106-42"><a href="#cb106-42" aria-hidden="true" tabindex="-1"></a>  resultados_accuracy_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb106-43"><a href="#cb106-43" aria-hidden="true" tabindex="-1"></a>  resultados_sensibilidad_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb106-44"><a href="#cb106-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-45"><a href="#cb106-45" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Iterar sobre cada pliegue interno para selección de modelo</span></span>
<span id="cb106-46"><a href="#cb106-46" aria-hidden="true" tabindex="-1"></a>  indices_inner <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(datos_entrenamiento_outer)</span>
<span id="cb106-47"><a href="#cb106-47" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i_inner <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k_inner) {</span>
<span id="cb106-48"><a href="#cb106-48" aria-hidden="true" tabindex="-1"></a>    <span class="do">###############################</span></span>
<span id="cb106-49"><a href="#cb106-49" aria-hidden="true" tabindex="-1"></a>    <span class="do">#### Aqui el filtrado##########</span></span>
<span id="cb106-50"><a href="#cb106-50" aria-hidden="true" tabindex="-1"></a>    filter_data <span class="ot">&lt;-</span> <span class="fu">filter_dependency</span>(datos_entrenamiento_outer,<span class="st">"ESTADO_ACTUAL"</span>,<span class="fu">colnames</span>(datos_entrenamiento_outer),<span class="fl">0.05</span>)</span>
<span id="cb106-51"><a href="#cb106-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="st">"ESTADO_ACTUAL.1"</span> <span class="sc">%in%</span> <span class="fu">colnames</span>(filter_data)) {</span>
<span id="cb106-52"><a href="#cb106-52" aria-hidden="true" tabindex="-1"></a>      filter_data <span class="ot">&lt;-</span> filter_data[, <span class="sc">!</span><span class="fu">colnames</span>(filter_data) <span class="sc">%in%</span> <span class="st">"ESTADO_ACTUAL.1"</span>, drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb106-53"><a href="#cb106-53" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb106-54"><a href="#cb106-54" aria-hidden="true" tabindex="-1"></a><span class="co">#con poca variables solo unaa la vez o filtrado o wrapper</span></span>
<span id="cb106-55"><a href="#cb106-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-56"><a href="#cb106-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-57"><a href="#cb106-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-58"><a href="#cb106-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Obtener los índices para el pliegue interno actual</span></span>
<span id="cb106-59"><a href="#cb106-59" aria-hidden="true" tabindex="-1"></a>    test_indices_inner <span class="ot">&lt;-</span> indices_inner[folds_inner<span class="sc">==</span>i_inner]  <span class="co"># Índices correspondientes al pliegue interno de test</span></span>
<span id="cb106-60"><a href="#cb106-60" aria-hidden="true" tabindex="-1"></a>    train_indices_inner <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(filter_data), test_indices_inner)  <span class="co"># Índices correspondientes al conjunto de entrenamiento interno</span></span>
<span id="cb106-61"><a href="#cb106-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-62"><a href="#cb106-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Dividir datos en entrenamiento y test para el pliegue interno</span></span>
<span id="cb106-63"><a href="#cb106-63" aria-hidden="true" tabindex="-1"></a>    datos_entrenamiento_inner <span class="ot">&lt;-</span> filter_data[train_indices_inner, ]</span>
<span id="cb106-64"><a href="#cb106-64" aria-hidden="true" tabindex="-1"></a>    datos_validacion <span class="ot">&lt;-</span> filter_data[test_indices_inner, ]</span>
<span id="cb106-65"><a href="#cb106-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-66"><a href="#cb106-66" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aplicar oversampling en el conjunto de entrenamiento interno</span></span>
<span id="cb106-67"><a href="#cb106-67" aria-hidden="true" tabindex="-1"></a>    datos_entrenamiento_oversampled <span class="ot">&lt;-</span> <span class="fu">ROSE</span>(ESTADO_ACTUAL <span class="sc">~</span> ., <span class="at">data =</span> datos_entrenamiento_inner, <span class="at">p =</span> proportion)<span class="sc">$</span>data</span>
<span id="cb106-68"><a href="#cb106-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-69"><a href="#cb106-69" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Definir la fórmula para el modelo</span></span>
<span id="cb106-70"><a href="#cb106-70" aria-hidden="true" tabindex="-1"></a>    formula <span class="ot">&lt;-</span> ESTADO_ACTUAL <span class="sc">~</span> .</span>
<span id="cb106-71"><a href="#cb106-71" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-72"><a href="#cb106-72" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Inicializar variables para almacenar el mejor modelo y su AUC</span></span>
<span id="cb106-73"><a href="#cb106-73" aria-hidden="true" tabindex="-1"></a>    mejor_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb106-74"><a href="#cb106-74" aria-hidden="true" tabindex="-1"></a>    mejor_modelo <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb106-75"><a href="#cb106-75" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-76"><a href="#cb106-76" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Definir combinaciones de hiperparámetros a probar</span></span>
<span id="cb106-77"><a href="#cb106-77" aria-hidden="true" tabindex="-1"></a>    param_grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">cp =</span> <span class="fu">c</span>(<span class="fl">0.01</span>, <span class="fl">0.05</span>, <span class="fl">0.1</span>), </span>
<span id="cb106-78"><a href="#cb106-78" aria-hidden="true" tabindex="-1"></a>                              <span class="at">minsplit =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">20</span>), </span>
<span id="cb106-79"><a href="#cb106-79" aria-hidden="true" tabindex="-1"></a>                              <span class="at">minbucket =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">20</span>))</span>
<span id="cb106-80"><a href="#cb106-80" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-81"><a href="#cb106-81" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Bucle para probar diferentes combinaciones de hiperparámetros</span></span>
<span id="cb106-82"><a href="#cb106-82" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (params <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(param_grid)) {</span>
<span id="cb106-83"><a href="#cb106-83" aria-hidden="true" tabindex="-1"></a>      cp <span class="ot">&lt;-</span> param_grid<span class="sc">$</span>cp[params]</span>
<span id="cb106-84"><a href="#cb106-84" aria-hidden="true" tabindex="-1"></a>      minsplit <span class="ot">&lt;-</span> param_grid<span class="sc">$</span>minsplit[params]</span>
<span id="cb106-85"><a href="#cb106-85" aria-hidden="true" tabindex="-1"></a>      minbucket <span class="ot">&lt;-</span> param_grid<span class="sc">$</span>minbucket[params]</span>
<span id="cb106-86"><a href="#cb106-86" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb106-87"><a href="#cb106-87" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Entrenar el modelo de árbol de decisión con la combinación de hiperparámetros actual</span></span>
<span id="cb106-88"><a href="#cb106-88" aria-hidden="true" tabindex="-1"></a>      modelo <span class="ot">&lt;-</span> <span class="fu">rpart</span>(formula, <span class="at">data =</span> datos_entrenamiento_oversampled, </span>
<span id="cb106-89"><a href="#cb106-89" aria-hidden="true" tabindex="-1"></a>                      <span class="at">control =</span> <span class="fu">rpart.control</span>(<span class="at">cp =</span> cp, <span class="at">minsplit =</span> minsplit, <span class="at">minbucket =</span> minbucket), </span>
<span id="cb106-90"><a href="#cb106-90" aria-hidden="true" tabindex="-1"></a>                      <span class="at">method =</span> <span class="st">"class"</span>)</span>
<span id="cb106-91"><a href="#cb106-91" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb106-92"><a href="#cb106-92" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Realizar predicciones con probabilidades en datos de validación</span></span>
<span id="cb106-93"><a href="#cb106-93" aria-hidden="true" tabindex="-1"></a>      predicciones_validacion_prob <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelo, <span class="at">newdata =</span> datos_validacion, <span class="at">type =</span> <span class="st">"prob"</span>)[,<span class="dv">2</span>]</span>
<span id="cb106-94"><a href="#cb106-94" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb106-95"><a href="#cb106-95" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Calcular el AUC</span></span>
<span id="cb106-96"><a href="#cb106-96" aria-hidden="true" tabindex="-1"></a>      roc_obj <span class="ot">&lt;-</span> <span class="fu">roc</span>(datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]], predicciones_validacion_prob, <span class="at">levels =</span> <span class="fu">rev</span>(<span class="fu">levels</span>(datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]])))</span>
<span id="cb106-97"><a href="#cb106-97" aria-hidden="true" tabindex="-1"></a>      auc_actual <span class="ot">&lt;-</span> <span class="fu">auc</span>(roc_obj)</span>
<span id="cb106-98"><a href="#cb106-98" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb106-99"><a href="#cb106-99" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Actualizar el mejor modelo y su rendimiento si se encuentra un modelo mejor</span></span>
<span id="cb106-100"><a href="#cb106-100" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (auc_actual <span class="sc">&gt;</span> mejor_auc) {</span>
<span id="cb106-101"><a href="#cb106-101" aria-hidden="true" tabindex="-1"></a>        mejor_auc <span class="ot">&lt;-</span> auc_actual</span>
<span id="cb106-102"><a href="#cb106-102" aria-hidden="true" tabindex="-1"></a>        mejor_modelo <span class="ot">&lt;-</span> modelo</span>
<span id="cb106-103"><a href="#cb106-103" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb106-104"><a href="#cb106-104" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb106-105"><a href="#cb106-105" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-106"><a href="#cb106-106" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calcular las predicciones para el conjunto de validación interno</span></span>
<span id="cb106-107"><a href="#cb106-107" aria-hidden="true" tabindex="-1"></a>    predicciones_validacion_prob <span class="ot">&lt;-</span> <span class="fu">predict</span>(mejor_modelo, <span class="at">newdata =</span> datos_validacion, <span class="at">type =</span> <span class="st">"prob"</span>)[,<span class="dv">2</span>]</span>
<span id="cb106-108"><a href="#cb106-108" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-109"><a href="#cb106-109" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Almacenar las predicciones y objetivos</span></span>
<span id="cb106-110"><a href="#cb106-110" aria-hidden="true" tabindex="-1"></a>    predicciones_auc[test_indices_inner] <span class="ot">&lt;-</span> predicciones_validacion_prob</span>
<span id="cb106-111"><a href="#cb106-111" aria-hidden="true" tabindex="-1"></a>    targets_auc[test_indices_inner] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(datos_validacion<span class="sc">$</span>ESTADO_ACTUAL) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb106-112"><a href="#cb106-112" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-113"><a href="#cb106-113" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calcular la sensibilidad y la precisión</span></span>
<span id="cb106-114"><a href="#cb106-114" aria-hidden="true" tabindex="-1"></a>    umbral <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb106-115"><a href="#cb106-115" aria-hidden="true" tabindex="-1"></a>    predicciones_finales <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predicciones_validacion_prob <span class="sc">&gt;=</span> umbral, <span class="st">"SI"</span>, <span class="st">"NO"</span>)</span>
<span id="cb106-116"><a href="#cb106-116" aria-hidden="true" tabindex="-1"></a>    TP <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_finales <span class="sc">==</span> <span class="st">"SI"</span> <span class="sc">&amp;</span> datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]] <span class="sc">==</span> <span class="st">"SI"</span>)</span>
<span id="cb106-117"><a href="#cb106-117" aria-hidden="true" tabindex="-1"></a>    FN <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_finales <span class="sc">==</span> <span class="st">"NO"</span> <span class="sc">&amp;</span> datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]] <span class="sc">==</span> <span class="st">"SI"</span>)</span>
<span id="cb106-118"><a href="#cb106-118" aria-hidden="true" tabindex="-1"></a>    FP <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_finales <span class="sc">==</span> <span class="st">"SI"</span> <span class="sc">&amp;</span> datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]] <span class="sc">==</span> <span class="st">"NO"</span>)</span>
<span id="cb106-119"><a href="#cb106-119" aria-hidden="true" tabindex="-1"></a>    TN <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_finales <span class="sc">==</span> <span class="st">"NO"</span> <span class="sc">&amp;</span> datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]] <span class="sc">==</span> <span class="st">"NO"</span>)</span>
<span id="cb106-120"><a href="#cb106-120" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-121"><a href="#cb106-121" aria-hidden="true" tabindex="-1"></a>    recall_actual <span class="ot">&lt;-</span> TP <span class="sc">/</span> (TP <span class="sc">+</span> FN)</span>
<span id="cb106-122"><a href="#cb106-122" aria-hidden="true" tabindex="-1"></a>    accuracy_actual <span class="ot">&lt;-</span> (TP <span class="sc">+</span> TN) <span class="sc">/</span> (TP <span class="sc">+</span> FN <span class="sc">+</span> FP <span class="sc">+</span> TN)</span>
<span id="cb106-123"><a href="#cb106-123" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-124"><a href="#cb106-124" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Almacenar resultados internos</span></span>
<span id="cb106-125"><a href="#cb106-125" aria-hidden="true" tabindex="-1"></a>    resultados_sensibilidad_inner[i_inner] <span class="ot">&lt;-</span> recall_actual</span>
<span id="cb106-126"><a href="#cb106-126" aria-hidden="true" tabindex="-1"></a>    resultados_accuracy_inner[i_inner] <span class="ot">&lt;-</span> accuracy_actual</span>
<span id="cb106-127"><a href="#cb106-127" aria-hidden="true" tabindex="-1"></a>    resultados_auc_inner[i_inner] <span class="ot">&lt;-</span> auc_actual</span>
<span id="cb106-128"><a href="#cb106-128" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-129"><a href="#cb106-129" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-130"><a href="#cb106-130" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular el AUC final para este pliegue externo</span></span>
<span id="cb106-131"><a href="#cb106-131" aria-hidden="true" tabindex="-1"></a>  auc_fold_externo <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_auc_inner)</span>
<span id="cb106-132"><a href="#cb106-132" aria-hidden="true" tabindex="-1"></a>  accuracy_fold_externo <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_accuracy_inner)</span>
<span id="cb106-133"><a href="#cb106-133" aria-hidden="true" tabindex="-1"></a>  sensibilidad_fold_externo <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_sensibilidad_inner)</span>
<span id="cb106-134"><a href="#cb106-134" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-135"><a href="#cb106-135" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Almacenar el AUC del fold externo actual</span></span>
<span id="cb106-136"><a href="#cb106-136" aria-hidden="true" tabindex="-1"></a>  resultados_auc[i_outer] <span class="ot">&lt;-</span> auc_fold_externo</span>
<span id="cb106-137"><a href="#cb106-137" aria-hidden="true" tabindex="-1"></a>  resultados_accuracy[i_outer] <span class="ot">&lt;-</span> accuracy_fold_externo</span>
<span id="cb106-138"><a href="#cb106-138" aria-hidden="true" tabindex="-1"></a>  resultados_sensibilidad[i_outer] <span class="ot">&lt;-</span> sensibilidad_fold_externo</span>
<span id="cb106-139"><a href="#cb106-139" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-140"><a href="#cb106-140" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Predecir en los datos de test para este pliegue externo y almacenar predicciones</span></span>
<span id="cb106-141"><a href="#cb106-141" aria-hidden="true" tabindex="-1"></a>  predicciones_test_outer_prob <span class="ot">&lt;-</span> <span class="fu">predict</span>(mejor_modelo, <span class="at">newdata =</span> datos_test_outer, <span class="at">type =</span> <span class="st">"prob"</span>)[,<span class="dv">2</span>]</span>
<span id="cb106-142"><a href="#cb106-142" aria-hidden="true" tabindex="-1"></a>  predicciones_totales[test_indices_outer, i_outer] <span class="ot">&lt;-</span> predicciones_test_outer_prob</span>
<span id="cb106-143"><a href="#cb106-143" aria-hidden="true" tabindex="-1"></a>  targets_totales[test_indices_outer] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(datos_test_outer<span class="sc">$</span>ESTADO_ACTUAL) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb106-144"><a href="#cb106-144" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-145"><a href="#cb106-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-146"><a href="#cb106-146" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular AUC promedio</span></span>
<span id="cb106-147"><a href="#cb106-147" aria-hidden="true" tabindex="-1"></a>auc_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_auc)</span>
<span id="cb106-148"><a href="#cb106-148" aria-hidden="true" tabindex="-1"></a>accuracy_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_accuracy)</span>
<span id="cb106-149"><a href="#cb106-149" aria-hidden="true" tabindex="-1"></a>sensibilidad_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_sensibilidad)</span>
<span id="cb106-150"><a href="#cb106-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-151"><a href="#cb106-151" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear tabla con todas las métricas</span></span>
<span id="cb106-152"><a href="#cb106-152" aria-hidden="true" tabindex="-1"></a>tabla_metricas <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb106-153"><a href="#cb106-153" aria-hidden="true" tabindex="-1"></a>  <span class="at">Pliegue =</span> <span class="dv">1</span><span class="sc">:</span>k_outer,</span>
<span id="cb106-154"><a href="#cb106-154" aria-hidden="true" tabindex="-1"></a>  <span class="at">AUC =</span> <span class="fu">sapply</span>(resultados_auc, round, <span class="at">digits =</span> <span class="dv">3</span>),</span>
<span id="cb106-155"><a href="#cb106-155" aria-hidden="true" tabindex="-1"></a>  <span class="at">Accuracy =</span> <span class="fu">sapply</span>(resultados_accuracy, round, <span class="at">digits =</span> <span class="dv">3</span>),</span>
<span id="cb106-156"><a href="#cb106-156" aria-hidden="true" tabindex="-1"></a>  <span class="at">Recall =</span> <span class="fu">sapply</span>(resultados_sensibilidad, round, <span class="at">digits =</span> <span class="dv">3</span>)</span>
<span id="cb106-157"><a href="#cb106-157" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb106-158"><a href="#cb106-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-159"><a href="#cb106-159" aria-hidden="true" tabindex="-1"></a><span class="co"># Agregar fila con promedio de métricas</span></span>
<span id="cb106-160"><a href="#cb106-160" aria-hidden="true" tabindex="-1"></a>tabla_metricas_dtree_filter <span class="ot">&lt;-</span> <span class="fu">rbind</span>(tabla_metricas, <span class="fu">c</span>(<span class="st">"Mean"</span>, <span class="fu">round</span>(auc_promedio, <span class="dv">3</span>), <span class="fu">round</span>(accuracy_promedio, <span class="dv">3</span>), <span class="fu">round</span>(sensibilidad_promedio, <span class="dv">3</span>)))</span>
<span id="cb106-161"><a href="#cb106-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-162"><a href="#cb106-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-163"><a href="#cb106-163" aria-hidden="true" tabindex="-1"></a><span class="co"># Detener el tiempo de ejecución</span></span>
<span id="cb106-164"><a href="#cb106-164" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb106-165"><a href="#cb106-165" aria-hidden="true" tabindex="-1"></a>execution_time_dtree_filter <span class="ot">&lt;-</span> end_time <span class="sc">-</span> start_time</span>
<span id="cb106-166"><a href="#cb106-166" aria-hidden="true" tabindex="-1"></a>execution_time_dtree_filter <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(execution_time_dtree_filter, <span class="at">units =</span> <span class="st">"secs"</span>)</span>
<span id="cb106-167"><a href="#cb106-167" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(tabla_metricas_dtree_filter, <span class="at">file =</span> <span class="st">"tabla_metricas_dtree_filter.RData"</span>)</span>
<span id="cb106-168"><a href="#cb106-168" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(execution_time_dtree_filter, <span class="at">file =</span> <span class="st">"execution_time_dtree_filter.RData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"tabla_metricas_dtree_filter.RData"</span>)</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"execution_time_dtree_filter.RData"</span>)</span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir el tiempo de ejecución</span></span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time_dtree_filter,  <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-20-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-20-1" role="tab" aria-controls="tabset-20-1" aria-selected="true" href="">Metrics Table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-20-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-20-2" role="tab" aria-controls="tabset-20-2" aria-selected="false" href="">Metrics Plot</a></li></ul>
<div class="tab-content">
<div id="tabset-20-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-20-1-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir tabla formateada con kableExtra</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(tabla_metricas_dtree_filter, <span class="at">caption =</span> <span class="st">"Cross Validation Metrics"</span>, <span class="at">align =</span> <span class="st">"c"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="tabset-20-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-20-2-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="fu">crear_plot_metricas_per_fold</span>(tabla_metricas_dtree_filter)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
<p>The model is instable and the performance metrics are not good. In the next section we are going to implement a random forest model to see if we can improve the performance.</p>
</div>
</div>
</div>
</div>
<div id="tabset-35-5" class="tab-pane" role="tabpanel" aria-labelledby="tabset-35-5-tab">
<div class="tabset-margin-container"></div><div class="panel-tabset" style="background-color: #f0f0f0;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-24-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-24-1" role="tab" aria-controls="tabset-24-1" aria-selected="true" href="">Hold out</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-24-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-24-2" role="tab" aria-controls="tabset-24-2" aria-selected="false" href="">5x2 Cross Validation Filter</a></li></ul>
<div class="tab-content" style="background-color: #f0f0f0;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;">
<div id="tabset-24-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-24-1-tab">
<p>The objetive of this section is to better the decision tree model using a random forest model. We are going to use the same hyperparameters as the decision tree model and evaluate it using a hold out validation. The hyperparameters are cp, minsplit and minbucket.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Parámetros a cambiar</span></span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>proportion <span class="ot">&lt;-</span> <span class="fl">0.28</span></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>sensitivity_weight <span class="ot">&lt;-</span> <span class="fl">0.8</span></span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Dividir el conjunto de datos en entrenamiento y test</span></span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)  <span class="co"># Establecer una semilla para reproducibilidad</span></span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a>indices_entrenamiento <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(data), <span class="fl">0.75</span> <span class="sc">*</span> <span class="fu">nrow</span>(data))  <span class="co"># 75% para entrenamiento</span></span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento <span class="ot">&lt;-</span> data[indices_entrenamiento, ]</span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true" tabindex="-1"></a>datos_test <span class="ot">&lt;-</span> data[<span class="sc">-</span>indices_entrenamiento, ]</span>
<span id="cb110-11"><a href="#cb110-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-12"><a href="#cb110-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Dividir datos de entrenamiento en entrenamiento y validación</span></span>
<span id="cb110-13"><a href="#cb110-13" aria-hidden="true" tabindex="-1"></a>train_indices <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(datos_entrenamiento), <span class="fl">0.8</span> <span class="sc">*</span> <span class="fu">nrow</span>(datos_entrenamiento))  <span class="co"># 80% para entrenamiento</span></span>
<span id="cb110-14"><a href="#cb110-14" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento_split <span class="ot">&lt;-</span> datos_entrenamiento[train_indices, ]</span>
<span id="cb110-15"><a href="#cb110-15" aria-hidden="true" tabindex="-1"></a>datos_validacion <span class="ot">&lt;-</span> datos_entrenamiento[<span class="sc">-</span>train_indices, ]</span>
<span id="cb110-16"><a href="#cb110-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-17"><a href="#cb110-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Realizar sobremuestreo en los datos de entrenamiento</span></span>
<span id="cb110-18"><a href="#cb110-18" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento_oversampled <span class="ot">&lt;-</span> <span class="fu">ROSE</span>(ESTADO_ACTUAL <span class="sc">~</span> ., <span class="at">data =</span> datos_entrenamiento_split, <span class="at">seed =</span> <span class="dv">123</span>, <span class="at">p =</span> proportion)<span class="sc">$</span>data</span>
<span id="cb110-19"><a href="#cb110-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-20"><a href="#cb110-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Definir la función para calcular el métrico personalizado</span></span>
<span id="cb110-21"><a href="#cb110-21" aria-hidden="true" tabindex="-1"></a>compute_custom_metric <span class="ot">&lt;-</span> <span class="cf">function</span>(recall, accuracy, <span class="at">sensitivity_weight =</span> <span class="dv">1</span>) {</span>
<span id="cb110-22"><a href="#cb110-22" aria-hidden="true" tabindex="-1"></a>  custom_metric <span class="ot">&lt;-</span> (sensitivity_weight <span class="sc">*</span> recall) <span class="sc">+</span> ((<span class="dv">1</span> <span class="sc">-</span> sensitivity_weight) <span class="sc">*</span> accuracy)</span>
<span id="cb110-23"><a href="#cb110-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(custom_metric)</span>
<span id="cb110-24"><a href="#cb110-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb110-25"><a href="#cb110-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-26"><a href="#cb110-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Definir la fórmula para el modelo</span></span>
<span id="cb110-27"><a href="#cb110-27" aria-hidden="true" tabindex="-1"></a>formula <span class="ot">&lt;-</span> ESTADO_ACTUAL <span class="sc">~</span> .</span>
<span id="cb110-28"><a href="#cb110-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-29"><a href="#cb110-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Inicializar variables para almacenar los resultados</span></span>
<span id="cb110-30"><a href="#cb110-30" aria-hidden="true" tabindex="-1"></a>mejor_custom_metric <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb110-31"><a href="#cb110-31" aria-hidden="true" tabindex="-1"></a>mejor_modelo <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb110-32"><a href="#cb110-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-33"><a href="#cb110-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Definir combinaciones de hiperparámetros a probar</span></span>
<span id="cb110-34"><a href="#cb110-34" aria-hidden="true" tabindex="-1"></a>param_grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">mtry =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>), </span>
<span id="cb110-35"><a href="#cb110-35" aria-hidden="true" tabindex="-1"></a>                          <span class="at">ntree =</span> <span class="fu">c</span>(<span class="dv">100</span>, <span class="dv">200</span>, <span class="dv">300</span>),</span>
<span id="cb110-36"><a href="#cb110-36" aria-hidden="true" tabindex="-1"></a>                          <span class="at">nodesize =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">15</span>))</span>
<span id="cb110-37"><a href="#cb110-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-38"><a href="#cb110-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Bucle para probar diferentes combinaciones de hiperparámetros</span></span>
<span id="cb110-39"><a href="#cb110-39" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (params <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(param_grid)) {</span>
<span id="cb110-40"><a href="#cb110-40" aria-hidden="true" tabindex="-1"></a>  mtry <span class="ot">&lt;-</span> param_grid<span class="sc">$</span>mtry[params]</span>
<span id="cb110-41"><a href="#cb110-41" aria-hidden="true" tabindex="-1"></a>  ntree <span class="ot">&lt;-</span> param_grid<span class="sc">$</span>ntree[params]</span>
<span id="cb110-42"><a href="#cb110-42" aria-hidden="true" tabindex="-1"></a>  nodesize <span class="ot">&lt;-</span> param_grid<span class="sc">$</span>nodesize[params]</span>
<span id="cb110-43"><a href="#cb110-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb110-44"><a href="#cb110-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Entrenar el modelo Random Forest con la combinación de hiperparámetros actual</span></span>
<span id="cb110-45"><a href="#cb110-45" aria-hidden="true" tabindex="-1"></a>  modelo <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(formula, <span class="at">data =</span> datos_entrenamiento_oversampled,</span>
<span id="cb110-46"><a href="#cb110-46" aria-hidden="true" tabindex="-1"></a>                         <span class="at">mtry =</span> mtry, <span class="at">ntree =</span> ntree, <span class="at">nodesize =</span> nodesize)</span>
<span id="cb110-47"><a href="#cb110-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb110-48"><a href="#cb110-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Realizar predicciones en datos de validación</span></span>
<span id="cb110-49"><a href="#cb110-49" aria-hidden="true" tabindex="-1"></a>  predicciones_validacion <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelo, <span class="at">newdata =</span> datos_validacion, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb110-50"><a href="#cb110-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb110-51"><a href="#cb110-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular la sensibilidad y la precisión</span></span>
<span id="cb110-52"><a href="#cb110-52" aria-hidden="true" tabindex="-1"></a>  TP <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_validacion <span class="sc">==</span> <span class="st">"SI"</span> <span class="sc">&amp;</span> datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]] <span class="sc">==</span> <span class="st">"SI"</span>)</span>
<span id="cb110-53"><a href="#cb110-53" aria-hidden="true" tabindex="-1"></a>  FN <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_validacion <span class="sc">==</span> <span class="st">"NO"</span> <span class="sc">&amp;</span> datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]] <span class="sc">==</span> <span class="st">"SI"</span>)</span>
<span id="cb110-54"><a href="#cb110-54" aria-hidden="true" tabindex="-1"></a>  FP <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_validacion <span class="sc">==</span> <span class="st">"SI"</span> <span class="sc">&amp;</span> datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]] <span class="sc">==</span> <span class="st">"NO"</span>)</span>
<span id="cb110-55"><a href="#cb110-55" aria-hidden="true" tabindex="-1"></a>  TN <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_validacion <span class="sc">==</span> <span class="st">"NO"</span> <span class="sc">&amp;</span> datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]] <span class="sc">==</span> <span class="st">"NO"</span>)</span>
<span id="cb110-56"><a href="#cb110-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb110-57"><a href="#cb110-57" aria-hidden="true" tabindex="-1"></a>  recall_actual <span class="ot">&lt;-</span> TP <span class="sc">/</span> (TP <span class="sc">+</span> FN)</span>
<span id="cb110-58"><a href="#cb110-58" aria-hidden="true" tabindex="-1"></a>  accuracy_actual <span class="ot">&lt;-</span> (TP <span class="sc">+</span> TN) <span class="sc">/</span> (TP <span class="sc">+</span> FN <span class="sc">+</span> FP <span class="sc">+</span> TN)</span>
<span id="cb110-59"><a href="#cb110-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb110-60"><a href="#cb110-60" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular el métrico personalizado para la combinación actual</span></span>
<span id="cb110-61"><a href="#cb110-61" aria-hidden="true" tabindex="-1"></a>  custom_metric_actual <span class="ot">&lt;-</span> <span class="fu">compute_custom_metric</span>(recall_actual, accuracy_actual, sensitivity_weight)</span>
<span id="cb110-62"><a href="#cb110-62" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb110-63"><a href="#cb110-63" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Actualizar el mejor modelo y su rendimiento si se encuentra un modelo mejor</span></span>
<span id="cb110-64"><a href="#cb110-64" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (custom_metric_actual <span class="sc">&gt;</span> mejor_custom_metric) {</span>
<span id="cb110-65"><a href="#cb110-65" aria-hidden="true" tabindex="-1"></a>    mejor_custom_metric <span class="ot">&lt;-</span> custom_metric_actual</span>
<span id="cb110-66"><a href="#cb110-66" aria-hidden="true" tabindex="-1"></a>    mejor_modelo <span class="ot">&lt;-</span> modelo</span>
<span id="cb110-67"><a href="#cb110-67" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb110-68"><a href="#cb110-68" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb110-69"><a href="#cb110-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-70"><a href="#cb110-70" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluar el mejor modelo en el conjunto de prueba</span></span>
<span id="cb110-71"><a href="#cb110-71" aria-hidden="true" tabindex="-1"></a>predicciones_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(mejor_modelo, <span class="at">newdata =</span> datos_test, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb110-72"><a href="#cb110-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-73"><a href="#cb110-73" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mejor_modelo)</span>
<span id="cb110-74"><a href="#cb110-74" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb110-75"><a href="#cb110-75" aria-hidden="true" tabindex="-1"></a>execution_time <span class="ot">&lt;-</span> end_time <span class="sc">-</span> start_time</span>
<span id="cb110-76"><a href="#cb110-76" aria-hidden="true" tabindex="-1"></a>execution_time <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(execution_time, <span class="at">units =</span> <span class="st">"secs"</span>)</span>
<span id="cb110-77"><a href="#cb110-77" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time,  <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-22-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-22-1" role="tab" aria-controls="tabset-22-1" aria-selected="true" href="">Predictions</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-22-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-22-2" role="tab" aria-controls="tabset-22-2" aria-selected="false" href="">Roc curve and auc</a></li></ul>
<div class="tab-content">
<div id="tabset-22-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-22-1-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular las predicciones para el conjunto de test</span></span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>predicciones_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(mejor_modelo, <span class="at">newdata =</span> datos_test, <span class="at">type =</span> <span class="st">"prob"</span>)</span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>predicciones_test <span class="ot">&lt;-</span> predicciones_test[, <span class="st">"SI"</span>]  <span class="co"># Asumiendo que "SI" es la clase positiva</span></span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>clases_predichas_test <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predicciones_test <span class="sc">&gt;=</span> <span class="fl">0.5</span>, <span class="st">"SI"</span>, <span class="st">"NO"</span>)</span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a><span class="fu">mostrar_metricas</span>(datos_test<span class="sc">$</span>ESTADO_ACTUAL,clases_predichas_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="tabset-22-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-22-2-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular la curva ROC y el AUC para el conjunto de test</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_roc_curve</span>(predicciones_test,datos_test<span class="sc">$</span>ESTADO_ACTUAL)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
<p>We obtain much better results than the decision tree model. The next step is to ensure that the model is robust using a 5x2 cross validation.</p>
</div>
<div id="tabset-24-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-24-2-tab">
<p>We are going to perform a 5x2 cross validation to ensure the robustness of the model. First, we create the outer folds and then we iterate over them to create the inner folds and perform the model selection process.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Iniciar tiempo de ejecución</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Parámetros a cambiar</span></span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>proportion <span class="ot">&lt;-</span> <span class="fl">0.28</span></span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Configurar la validación cruzada 5x3</span></span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a>k_outer <span class="ot">&lt;-</span> <span class="dv">5</span>  <span class="co"># Número de pliegues externos</span></span>
<span id="cb113-9"><a href="#cb113-9" aria-hidden="true" tabindex="-1"></a>k_inner <span class="ot">&lt;-</span> <span class="dv">3</span>  <span class="co"># Número de pliegues internos</span></span>
<span id="cb113-10"><a href="#cb113-10" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)  <span class="co"># Establecer semilla para reproducibilidad</span></span>
<span id="cb113-11"><a href="#cb113-11" aria-hidden="true" tabindex="-1"></a>folds_outer <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(data<span class="sc">$</span>ESTADO_ACTUAL, <span class="at">k =</span> k_outer, <span class="at">list =</span> <span class="cn">FALSE</span>)  <span class="co"># Obtener índices de pliegues externos</span></span>
<span id="cb113-12"><a href="#cb113-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-13"><a href="#cb113-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Lista para almacenar resultados</span></span>
<span id="cb113-14"><a href="#cb113-14" aria-hidden="true" tabindex="-1"></a>resultados_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb113-15"><a href="#cb113-15" aria-hidden="true" tabindex="-1"></a>resultados_accuracy <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb113-16"><a href="#cb113-16" aria-hidden="true" tabindex="-1"></a>resultados_sensibilidad <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb113-17"><a href="#cb113-17" aria-hidden="true" tabindex="-1"></a>indices <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data)</span>
<span id="cb113-18"><a href="#cb113-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-19"><a href="#cb113-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Inicializar matrices para almacenar predicciones y objetivos</span></span>
<span id="cb113-20"><a href="#cb113-20" aria-hidden="true" tabindex="-1"></a>predicciones_totales <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">nrow</span>(data), <span class="at">ncol =</span> k_outer)</span>
<span id="cb113-21"><a href="#cb113-21" aria-hidden="true" tabindex="-1"></a>targets_totales <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(data))</span>
<span id="cb113-22"><a href="#cb113-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-23"><a href="#cb113-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterar sobre cada pliegue externo y realizar el proceso de modelado</span></span>
<span id="cb113-24"><a href="#cb113-24" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i_outer <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k_outer) {</span>
<span id="cb113-25"><a href="#cb113-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-26"><a href="#cb113-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Obtener los índices para el pliegue externo actual</span></span>
<span id="cb113-27"><a href="#cb113-27" aria-hidden="true" tabindex="-1"></a>  test_indices_outer <span class="ot">&lt;-</span> indices[folds_outer <span class="sc">==</span> i_outer]  <span class="co"># Índices correspondientes al pliegue externo de test</span></span>
<span id="cb113-28"><a href="#cb113-28" aria-hidden="true" tabindex="-1"></a>  train_indices_outer <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data), test_indices_outer)  <span class="co"># Índices correspondientes al conjunto de entrenamiento</span></span>
<span id="cb113-29"><a href="#cb113-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-30"><a href="#cb113-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Dividir datos en entrenamiento y test para el pliegue externo</span></span>
<span id="cb113-31"><a href="#cb113-31" aria-hidden="true" tabindex="-1"></a>  datos_entrenamiento_outer <span class="ot">&lt;-</span> data[train_indices_outer, ]</span>
<span id="cb113-32"><a href="#cb113-32" aria-hidden="true" tabindex="-1"></a>  datos_test_outer <span class="ot">&lt;-</span> data[test_indices_outer, ]</span>
<span id="cb113-33"><a href="#cb113-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-34"><a href="#cb113-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Configurar la validación cruzada interna</span></span>
<span id="cb113-35"><a href="#cb113-35" aria-hidden="true" tabindex="-1"></a>  folds_inner <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(datos_entrenamiento_outer<span class="sc">$</span>ESTADO_ACTUAL, <span class="at">k =</span> k_inner, <span class="at">list =</span> <span class="cn">FALSE</span>)  <span class="co"># Obtener índices de pliegues internos</span></span>
<span id="cb113-36"><a href="#cb113-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-37"><a href="#cb113-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Almacenar predicciones y objetivos para el AUC general</span></span>
<span id="cb113-38"><a href="#cb113-38" aria-hidden="true" tabindex="-1"></a>  predicciones_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(datos_entrenamiento_outer))</span>
<span id="cb113-39"><a href="#cb113-39" aria-hidden="true" tabindex="-1"></a>  targets_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(datos_entrenamiento_outer))</span>
<span id="cb113-40"><a href="#cb113-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-41"><a href="#cb113-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Inicializar variables para almacenar resultados internos</span></span>
<span id="cb113-42"><a href="#cb113-42" aria-hidden="true" tabindex="-1"></a>  resultados_auc_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb113-43"><a href="#cb113-43" aria-hidden="true" tabindex="-1"></a>  resultados_accuracy_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb113-44"><a href="#cb113-44" aria-hidden="true" tabindex="-1"></a>  resultados_sensibilidad_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb113-45"><a href="#cb113-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-46"><a href="#cb113-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Iterar sobre cada pliegue interno para selección de modelo</span></span>
<span id="cb113-47"><a href="#cb113-47" aria-hidden="true" tabindex="-1"></a>  indices_inner <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(datos_entrenamiento_outer)</span>
<span id="cb113-48"><a href="#cb113-48" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i_inner <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k_inner) {</span>
<span id="cb113-49"><a href="#cb113-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Obtener los índices para el pliegue interno actual</span></span>
<span id="cb113-50"><a href="#cb113-50" aria-hidden="true" tabindex="-1"></a>    test_indices_inner <span class="ot">&lt;-</span> indices_inner[folds_inner <span class="sc">==</span> i_inner]  <span class="co"># Índices correspondientes al pliegue interno de test</span></span>
<span id="cb113-51"><a href="#cb113-51" aria-hidden="true" tabindex="-1"></a>    train_indices_inner <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(datos_entrenamiento_outer), test_indices_inner)  <span class="co"># Índices correspondientes al conjunto de entrenamiento interno</span></span>
<span id="cb113-52"><a href="#cb113-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb113-53"><a href="#cb113-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Dividir datos en entrenamiento y test para el pliegue interno</span></span>
<span id="cb113-54"><a href="#cb113-54" aria-hidden="true" tabindex="-1"></a>    datos_entrenamiento_inner <span class="ot">&lt;-</span> datos_entrenamiento_outer[train_indices_inner, ]</span>
<span id="cb113-55"><a href="#cb113-55" aria-hidden="true" tabindex="-1"></a>    datos_validacion <span class="ot">&lt;-</span> datos_entrenamiento_outer[test_indices_inner, ]</span>
<span id="cb113-56"><a href="#cb113-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb113-57"><a href="#cb113-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aplicar oversampling en el conjunto de entrenamiento interno</span></span>
<span id="cb113-58"><a href="#cb113-58" aria-hidden="true" tabindex="-1"></a>    datos_entrenamiento_oversampled <span class="ot">&lt;-</span> <span class="fu">ROSE</span>(ESTADO_ACTUAL <span class="sc">~</span> ., <span class="at">data =</span> datos_entrenamiento_inner, <span class="at">seed =</span> <span class="dv">123</span>, <span class="at">p =</span> proportion)<span class="sc">$</span>data</span>
<span id="cb113-59"><a href="#cb113-59" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb113-60"><a href="#cb113-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Definir la fórmula para el modelo</span></span>
<span id="cb113-61"><a href="#cb113-61" aria-hidden="true" tabindex="-1"></a>    formula <span class="ot">&lt;-</span> ESTADO_ACTUAL <span class="sc">~</span> .</span>
<span id="cb113-62"><a href="#cb113-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb113-63"><a href="#cb113-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Inicializar variables para almacenar el mejor modelo y su AUC</span></span>
<span id="cb113-64"><a href="#cb113-64" aria-hidden="true" tabindex="-1"></a>    mejor_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb113-65"><a href="#cb113-65" aria-hidden="true" tabindex="-1"></a>    mejor_modelo <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb113-66"><a href="#cb113-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb113-67"><a href="#cb113-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Definir combinaciones de hiperparámetros a probar</span></span>
<span id="cb113-68"><a href="#cb113-68" aria-hidden="true" tabindex="-1"></a>    param_grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">mtry =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>), </span>
<span id="cb113-69"><a href="#cb113-69" aria-hidden="true" tabindex="-1"></a>                              <span class="at">ntree =</span> <span class="fu">c</span>(<span class="dv">100</span>, <span class="dv">200</span>, <span class="dv">500</span>),</span>
<span id="cb113-70"><a href="#cb113-70" aria-hidden="true" tabindex="-1"></a>                              <span class="at">maxnodes =</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">15</span>, <span class="dv">20</span>))</span>
<span id="cb113-71"><a href="#cb113-71" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb113-72"><a href="#cb113-72" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Bucle para probar diferentes combinaciones de hiperparámetros</span></span>
<span id="cb113-73"><a href="#cb113-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (params <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(param_grid)) {</span>
<span id="cb113-74"><a href="#cb113-74" aria-hidden="true" tabindex="-1"></a>      mtry <span class="ot">&lt;-</span> param_grid<span class="sc">$</span>mtry[params]</span>
<span id="cb113-75"><a href="#cb113-75" aria-hidden="true" tabindex="-1"></a>      ntree <span class="ot">&lt;-</span> param_grid<span class="sc">$</span>ntree[params]</span>
<span id="cb113-76"><a href="#cb113-76" aria-hidden="true" tabindex="-1"></a>      maxnodes <span class="ot">&lt;-</span> param_grid<span class="sc">$</span>maxnodes[params]</span>
<span id="cb113-77"><a href="#cb113-77" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb113-78"><a href="#cb113-78" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Entrenar el modelo de bosque aleatorio con la combinación de hiperparámetros actual</span></span>
<span id="cb113-79"><a href="#cb113-79" aria-hidden="true" tabindex="-1"></a>      modelo <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(formula, <span class="at">data =</span> datos_entrenamiento_oversampled, </span>
<span id="cb113-80"><a href="#cb113-80" aria-hidden="true" tabindex="-1"></a>                             <span class="at">mtry =</span> mtry, <span class="at">ntree =</span> ntree, <span class="at">maxnodes =</span> maxnodes)</span>
<span id="cb113-81"><a href="#cb113-81" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb113-82"><a href="#cb113-82" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Realizar predicciones con probabilidades en datos de validación</span></span>
<span id="cb113-83"><a href="#cb113-83" aria-hidden="true" tabindex="-1"></a>      predicciones_validacion_prob <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelo, <span class="at">newdata =</span> datos_validacion, <span class="at">type =</span> <span class="st">"prob"</span>)[,<span class="dv">2</span>]</span>
<span id="cb113-84"><a href="#cb113-84" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb113-85"><a href="#cb113-85" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Calcular el AUC</span></span>
<span id="cb113-86"><a href="#cb113-86" aria-hidden="true" tabindex="-1"></a>      roc_obj <span class="ot">&lt;-</span> <span class="fu">roc</span>(datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]], predicciones_validacion_prob, <span class="at">levels =</span> <span class="fu">rev</span>(<span class="fu">levels</span>(datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]])))</span>
<span id="cb113-87"><a href="#cb113-87" aria-hidden="true" tabindex="-1"></a>      auc_actual <span class="ot">&lt;-</span> <span class="fu">auc</span>(roc_obj)</span>
<span id="cb113-88"><a href="#cb113-88" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb113-89"><a href="#cb113-89" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Actualizar el mejor modelo y su rendimiento si se encuentra un modelo mejor</span></span>
<span id="cb113-90"><a href="#cb113-90" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (auc_actual <span class="sc">&gt;</span> mejor_auc) {</span>
<span id="cb113-91"><a href="#cb113-91" aria-hidden="true" tabindex="-1"></a>        mejor_auc <span class="ot">&lt;-</span> auc_actual</span>
<span id="cb113-92"><a href="#cb113-92" aria-hidden="true" tabindex="-1"></a>        mejor_modelo <span class="ot">&lt;-</span> modelo</span>
<span id="cb113-93"><a href="#cb113-93" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb113-94"><a href="#cb113-94" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb113-95"><a href="#cb113-95" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb113-96"><a href="#cb113-96" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calcular las predicciones para el conjunto de validación interno</span></span>
<span id="cb113-97"><a href="#cb113-97" aria-hidden="true" tabindex="-1"></a>    predicciones_validacion_prob <span class="ot">&lt;-</span> <span class="fu">predict</span>(mejor_modelo, <span class="at">newdata =</span> datos_validacion, <span class="at">type =</span> <span class="st">"prob"</span>)[,<span class="dv">2</span>]</span>
<span id="cb113-98"><a href="#cb113-98" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb113-99"><a href="#cb113-99" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Almacenar las predicciones y objetivos</span></span>
<span id="cb113-100"><a href="#cb113-100" aria-hidden="true" tabindex="-1"></a>    predicciones_auc[test_indices_inner] <span class="ot">&lt;-</span> predicciones_validacion_prob</span>
<span id="cb113-101"><a href="#cb113-101" aria-hidden="true" tabindex="-1"></a>    targets_auc[test_indices_inner] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(datos_validacion<span class="sc">$</span>ESTADO_ACTUAL) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb113-102"><a href="#cb113-102" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb113-103"><a href="#cb113-103" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calcular la sensibilidad y la precisión</span></span>
<span id="cb113-104"><a href="#cb113-104" aria-hidden="true" tabindex="-1"></a>    umbral <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb113-105"><a href="#cb113-105" aria-hidden="true" tabindex="-1"></a>    predicciones_finales <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predicciones_validacion_prob <span class="sc">&gt;=</span> umbral, <span class="st">"SI"</span>, <span class="st">"NO"</span>)</span>
<span id="cb113-106"><a href="#cb113-106" aria-hidden="true" tabindex="-1"></a>    TP <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_finales <span class="sc">==</span> <span class="st">"SI"</span> <span class="sc">&amp;</span> datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]] <span class="sc">==</span> <span class="st">"SI"</span>)</span>
<span id="cb113-107"><a href="#cb113-107" aria-hidden="true" tabindex="-1"></a>    FN <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_finales <span class="sc">==</span> <span class="st">"NO"</span> <span class="sc">&amp;</span> datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]] <span class="sc">==</span> <span class="st">"SI"</span>)</span>
<span id="cb113-108"><a href="#cb113-108" aria-hidden="true" tabindex="-1"></a>    FP <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_finales <span class="sc">==</span> <span class="st">"SI"</span> <span class="sc">&amp;</span> datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]] <span class="sc">==</span> <span class="st">"NO"</span>)</span>
<span id="cb113-109"><a href="#cb113-109" aria-hidden="true" tabindex="-1"></a>    TN <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_finales <span class="sc">==</span> <span class="st">"NO"</span> <span class="sc">&amp;</span> datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]] <span class="sc">==</span> <span class="st">"NO"</span>)</span>
<span id="cb113-110"><a href="#cb113-110" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb113-111"><a href="#cb113-111" aria-hidden="true" tabindex="-1"></a>    recall_actual <span class="ot">&lt;-</span> TP <span class="sc">/</span> (TP <span class="sc">+</span> FN)</span>
<span id="cb113-112"><a href="#cb113-112" aria-hidden="true" tabindex="-1"></a>    accuracy_actual <span class="ot">&lt;-</span> (TP <span class="sc">+</span> TN) <span class="sc">/</span> (TP <span class="sc">+</span> FN <span class="sc">+</span> FP <span class="sc">+</span> TN)</span>
<span id="cb113-113"><a href="#cb113-113" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb113-114"><a href="#cb113-114" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Almacenar resultados internos</span></span>
<span id="cb113-115"><a href="#cb113-115" aria-hidden="true" tabindex="-1"></a>    resultados_sensibilidad_inner[i_inner] <span class="ot">&lt;-</span> recall_actual</span>
<span id="cb113-116"><a href="#cb113-116" aria-hidden="true" tabindex="-1"></a>    resultados_accuracy_inner[i_inner] <span class="ot">&lt;-</span> accuracy_actual</span>
<span id="cb113-117"><a href="#cb113-117" aria-hidden="true" tabindex="-1"></a>    resultados_auc_inner[i_inner] <span class="ot">&lt;-</span> auc_actual</span>
<span id="cb113-118"><a href="#cb113-118" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb113-119"><a href="#cb113-119" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-120"><a href="#cb113-120" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular el AUC final para este pliegue externo</span></span>
<span id="cb113-121"><a href="#cb113-121" aria-hidden="true" tabindex="-1"></a>  auc_fold_externo <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_auc_inner)</span>
<span id="cb113-122"><a href="#cb113-122" aria-hidden="true" tabindex="-1"></a>  accuracy_fold_externo <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_accuracy_inner)</span>
<span id="cb113-123"><a href="#cb113-123" aria-hidden="true" tabindex="-1"></a>  sensibilidad_fold_externo <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_sensibilidad_inner)</span>
<span id="cb113-124"><a href="#cb113-124" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-125"><a href="#cb113-125" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Almacenar el AUC del fold externo actual</span></span>
<span id="cb113-126"><a href="#cb113-126" aria-hidden="true" tabindex="-1"></a>  resultados_auc[i_outer] <span class="ot">&lt;-</span> auc_fold_externo</span>
<span id="cb113-127"><a href="#cb113-127" aria-hidden="true" tabindex="-1"></a>  resultados_accuracy[i_outer] <span class="ot">&lt;-</span> accuracy_fold_externo</span>
<span id="cb113-128"><a href="#cb113-128" aria-hidden="true" tabindex="-1"></a>  resultados_sensibilidad[i_outer] <span class="ot">&lt;-</span> sensibilidad_fold_externo</span>
<span id="cb113-129"><a href="#cb113-129" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-130"><a href="#cb113-130" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Predecir en los datos de test para este pliegue externo y almacenar predicciones</span></span>
<span id="cb113-131"><a href="#cb113-131" aria-hidden="true" tabindex="-1"></a>  predicciones_test_outer_prob <span class="ot">&lt;-</span> <span class="fu">predict</span>(mejor_modelo, <span class="at">newdata =</span> datos_test_outer, <span class="at">type =</span> <span class="st">"prob"</span>)[,<span class="dv">2</span>]</span>
<span id="cb113-132"><a href="#cb113-132" aria-hidden="true" tabindex="-1"></a>  predicciones_totales[test_indices_outer, i_outer] <span class="ot">&lt;-</span> predicciones_test_outer_prob</span>
<span id="cb113-133"><a href="#cb113-133" aria-hidden="true" tabindex="-1"></a>  targets_totales[test_indices_outer] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(datos_test_outer<span class="sc">$</span>ESTADO_ACTUAL) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb113-134"><a href="#cb113-134" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb113-135"><a href="#cb113-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-136"><a href="#cb113-136" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular AUC promedio</span></span>
<span id="cb113-137"><a href="#cb113-137" aria-hidden="true" tabindex="-1"></a>auc_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_auc)</span>
<span id="cb113-138"><a href="#cb113-138" aria-hidden="true" tabindex="-1"></a>accuracy_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_accuracy)</span>
<span id="cb113-139"><a href="#cb113-139" aria-hidden="true" tabindex="-1"></a>sensibilidad_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_sensibilidad)</span>
<span id="cb113-140"><a href="#cb113-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-141"><a href="#cb113-141" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear tabla con todas las métricas</span></span>
<span id="cb113-142"><a href="#cb113-142" aria-hidden="true" tabindex="-1"></a>tabla_metricas <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb113-143"><a href="#cb113-143" aria-hidden="true" tabindex="-1"></a>  <span class="at">Pliegue =</span> <span class="dv">1</span><span class="sc">:</span>k_outer,</span>
<span id="cb113-144"><a href="#cb113-144" aria-hidden="true" tabindex="-1"></a>  <span class="at">AUC =</span> <span class="fu">sapply</span>(resultados_auc, round, <span class="at">digits =</span> <span class="dv">3</span>),</span>
<span id="cb113-145"><a href="#cb113-145" aria-hidden="true" tabindex="-1"></a>  <span class="at">Accuracy =</span> <span class="fu">sapply</span>(resultados_accuracy, round, <span class="at">digits =</span> <span class="dv">3</span>),</span>
<span id="cb113-146"><a href="#cb113-146" aria-hidden="true" tabindex="-1"></a>  <span class="at">Recall =</span> <span class="fu">sapply</span>(resultados_sensibilidad, round, <span class="at">digits =</span> <span class="dv">3</span>)</span>
<span id="cb113-147"><a href="#cb113-147" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb113-148"><a href="#cb113-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-149"><a href="#cb113-149" aria-hidden="true" tabindex="-1"></a><span class="co"># Agregar fila con promedio de métricas</span></span>
<span id="cb113-150"><a href="#cb113-150" aria-hidden="true" tabindex="-1"></a>tabla_metricas_random_forest <span class="ot">&lt;-</span> <span class="fu">rbind</span>(tabla_metricas, <span class="fu">c</span>(<span class="st">"Mean"</span>, <span class="fu">round</span>(auc_promedio, <span class="dv">3</span>), <span class="fu">round</span>(accuracy_promedio, <span class="dv">3</span>), <span class="fu">round</span>(sensibilidad_promedio, <span class="dv">3</span>)))</span>
<span id="cb113-151"><a href="#cb113-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-152"><a href="#cb113-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-153"><a href="#cb113-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-154"><a href="#cb113-154" aria-hidden="true" tabindex="-1"></a><span class="co"># Detener el tiempo de ejecución</span></span>
<span id="cb113-155"><a href="#cb113-155" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb113-156"><a href="#cb113-156" aria-hidden="true" tabindex="-1"></a>execution_time_random_forest <span class="ot">&lt;-</span> end_time <span class="sc">-</span> start_time</span>
<span id="cb113-157"><a href="#cb113-157" aria-hidden="true" tabindex="-1"></a>execution_time_random_forest <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(execution_time_random_forest, <span class="at">units =</span> <span class="st">"secs"</span>)</span>
<span id="cb113-158"><a href="#cb113-158" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(tabla_metricas_random_forest, <span class="at">file =</span> <span class="st">"tabla_metricas_random_forest.RData"</span>)</span>
<span id="cb113-159"><a href="#cb113-159" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(execution_time_random_forest, <span class="at">file =</span> <span class="st">"execution_time_random_forest.RData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"tabla_metricas_random_forest.RData"</span>)</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"execution_time_random_forest.RData"</span>)</span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir el tiempo de ejecución</span></span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time_random_forest,  <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-23-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-23-1" role="tab" aria-controls="tabset-23-1" aria-selected="true" href="">Metrics Table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-23-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-23-2" role="tab" aria-controls="tabset-23-2" aria-selected="false" href="">Metrics Plot</a></li></ul>
<div class="tab-content">
<div id="tabset-23-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-23-1-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir tabla formateada con kableExtra</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(tabla_metricas_random_forest, <span class="at">caption =</span> <span class="st">"Cross Validation Metrics"</span>, <span class="at">align =</span> <span class="st">"c"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="tabset-23-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-23-2-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="fu">crear_plot_metricas_per_fold</span>(tabla_metricas_random_forest)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
<p>The model is robust and the performance metrics are good. But there there is no hope to surpass the performance of neural network so we are not going to use variable selection in the random forest model.</p>
</div>
</div>
</div>
</div>
<div id="tabset-35-6" class="tab-pane" role="tabpanel" aria-labelledby="tabset-35-6-tab">
<div class="tabset-margin-container"></div><div class="panel-tabset" style="background-color: #f0f0f0;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-28-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-28-1" role="tab" aria-controls="tabset-28-1" aria-selected="true" href="">Hold out</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-28-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-28-2" role="tab" aria-controls="tabset-28-2" aria-selected="false" href="">5x2 Cross Validation Filter</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-28-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-28-3" role="tab" aria-controls="tabset-28-3" aria-selected="false" href="">5x2 Cross Validation Wrapper</a></li></ul>
<div class="tab-content" style="background-color: #f0f0f0;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;">
<div id="tabset-28-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-28-1-tab">
<p>In this section we are going to implement a Naive Bayes model. The hyperparameters to optimize are usekernel and laplace.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Parámetros a cambiar</span></span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>proportion <span class="ot">&lt;-</span> <span class="fl">0.28</span></span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Dividir el conjunto de datos en entrenamiento y test</span></span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)  <span class="co"># Establecer una semilla para reproducibilidad</span></span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a>indices_entrenamiento <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(data), <span class="fl">0.75</span> <span class="sc">*</span> <span class="fu">nrow</span>(data))  <span class="co"># 75% para entrenamiento</span></span>
<span id="cb117-9"><a href="#cb117-9" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento <span class="ot">&lt;-</span> data[indices_entrenamiento, ]</span>
<span id="cb117-10"><a href="#cb117-10" aria-hidden="true" tabindex="-1"></a>datos_test <span class="ot">&lt;-</span> data[<span class="sc">-</span>indices_entrenamiento, ]</span>
<span id="cb117-11"><a href="#cb117-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-12"><a href="#cb117-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Dividir datos de entrenamiento en entrenamiento y validación</span></span>
<span id="cb117-13"><a href="#cb117-13" aria-hidden="true" tabindex="-1"></a>train_indices <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(datos_entrenamiento), <span class="fl">0.8</span> <span class="sc">*</span> <span class="fu">nrow</span>(datos_entrenamiento))  <span class="co"># 80% para entrenamiento</span></span>
<span id="cb117-14"><a href="#cb117-14" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento_split <span class="ot">&lt;-</span> datos_entrenamiento[train_indices, ]</span>
<span id="cb117-15"><a href="#cb117-15" aria-hidden="true" tabindex="-1"></a>datos_validacion <span class="ot">&lt;-</span> datos_entrenamiento[<span class="sc">-</span>train_indices, ]</span>
<span id="cb117-16"><a href="#cb117-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-17"><a href="#cb117-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Realizar sobremuestreo en los datos de entrenamiento</span></span>
<span id="cb117-18"><a href="#cb117-18" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento_oversampled <span class="ot">&lt;-</span> <span class="fu">ROSE</span>(ESTADO_ACTUAL <span class="sc">~</span> ., <span class="at">data =</span> datos_entrenamiento_split, <span class="at">seed =</span> <span class="dv">123</span>, <span class="at">p =</span> proportion)<span class="sc">$</span>data</span>
<span id="cb117-19"><a href="#cb117-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-20"><a href="#cb117-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Definir la fórmula para el modelo</span></span>
<span id="cb117-21"><a href="#cb117-21" aria-hidden="true" tabindex="-1"></a>formula <span class="ot">&lt;-</span> ESTADO_ACTUAL <span class="sc">~</span> .</span>
<span id="cb117-22"><a href="#cb117-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-23"><a href="#cb117-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Inicializar variables para almacenar los resultados</span></span>
<span id="cb117-24"><a href="#cb117-24" aria-hidden="true" tabindex="-1"></a>mejor_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb117-25"><a href="#cb117-25" aria-hidden="true" tabindex="-1"></a>mejor_modelo <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb117-26"><a href="#cb117-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-27"><a href="#cb117-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Definir combinaciones de hiperparámetros a probar</span></span>
<span id="cb117-28"><a href="#cb117-28" aria-hidden="true" tabindex="-1"></a>param_grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">usekernel =</span> <span class="fu">c</span>(<span class="cn">FALSE</span>, <span class="cn">TRUE</span>), </span>
<span id="cb117-29"><a href="#cb117-29" aria-hidden="true" tabindex="-1"></a>                          <span class="at">laplace =</span> <span class="fu">c</span>(<span class="cn">FALSE</span>, <span class="cn">TRUE</span>))</span>
<span id="cb117-30"><a href="#cb117-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-31"><a href="#cb117-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Bucle para probar diferentes combinaciones de hiperparámetros</span></span>
<span id="cb117-32"><a href="#cb117-32" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (params <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(param_grid)) {</span>
<span id="cb117-33"><a href="#cb117-33" aria-hidden="true" tabindex="-1"></a>  usekernel <span class="ot">&lt;-</span> param_grid<span class="sc">$</span>usekernel[params]</span>
<span id="cb117-34"><a href="#cb117-34" aria-hidden="true" tabindex="-1"></a>  laplace <span class="ot">&lt;-</span> param_grid<span class="sc">$</span>laplace[params]</span>
<span id="cb117-35"><a href="#cb117-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb117-36"><a href="#cb117-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Entrenar el modelo Naive Bayes con la combinación de hiperparámetros actual</span></span>
<span id="cb117-37"><a href="#cb117-37" aria-hidden="true" tabindex="-1"></a>  modelo <span class="ot">&lt;-</span> <span class="fu">naiveBayes</span>(formula, <span class="at">data =</span> datos_entrenamiento_oversampled, <span class="at">kernel =</span> usekernel, <span class="at">laplace =</span> laplace)</span>
<span id="cb117-38"><a href="#cb117-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb117-39"><a href="#cb117-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Realizar predicciones en datos de validación</span></span>
<span id="cb117-40"><a href="#cb117-40" aria-hidden="true" tabindex="-1"></a>  predicciones_validacion <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelo, <span class="at">newdata =</span> datos_validacion, <span class="at">type =</span> <span class="st">"raw"</span>)</span>
<span id="cb117-41"><a href="#cb117-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb117-42"><a href="#cb117-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular AUC para la combinación actual</span></span>
<span id="cb117-43"><a href="#cb117-43" aria-hidden="true" tabindex="-1"></a>  roc_obj <span class="ot">&lt;-</span> <span class="fu">roc</span>(<span class="fu">ifelse</span>(datos_validacion<span class="sc">$</span>ESTADO_ACTUAL <span class="sc">==</span> <span class="st">"SI"</span>, <span class="dv">1</span>, <span class="dv">0</span>), predicciones_validacion[, <span class="st">"SI"</span>])</span>
<span id="cb117-44"><a href="#cb117-44" aria-hidden="true" tabindex="-1"></a>  auc_actual <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">auc</span>(roc_obj))  <span class="co"># Extraer el valor numérico del AUC</span></span>
<span id="cb117-45"><a href="#cb117-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb117-46"><a href="#cb117-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Actualizar el mejor modelo y su AUC si se encuentra un modelo mejor</span></span>
<span id="cb117-47"><a href="#cb117-47" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (auc_actual <span class="sc">&gt;</span> mejor_auc) {</span>
<span id="cb117-48"><a href="#cb117-48" aria-hidden="true" tabindex="-1"></a>    mejor_auc <span class="ot">&lt;-</span> auc_actual</span>
<span id="cb117-49"><a href="#cb117-49" aria-hidden="true" tabindex="-1"></a>    mejor_modelo <span class="ot">&lt;-</span> modelo</span>
<span id="cb117-50"><a href="#cb117-50" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb117-51"><a href="#cb117-51" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb117-52"><a href="#cb117-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-53"><a href="#cb117-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Resumen del mejor modelo</span></span>
<span id="cb117-54"><a href="#cb117-54" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mejor_modelo)</span>
<span id="cb117-55"><a href="#cb117-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-56"><a href="#cb117-56" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb117-57"><a href="#cb117-57" aria-hidden="true" tabindex="-1"></a>execution_time <span class="ot">&lt;-</span> end_time <span class="sc">-</span> start_time</span>
<span id="cb117-58"><a href="#cb117-58" aria-hidden="true" tabindex="-1"></a>execution_time <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(execution_time, <span class="at">units =</span> <span class="st">"secs"</span>)</span>
<span id="cb117-59"><a href="#cb117-59" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time, <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-25-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-25-1" role="tab" aria-controls="tabset-25-1" aria-selected="true" href="">Predictions</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-25-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-25-2" role="tab" aria-controls="tabset-25-2" aria-selected="false" href="">Roc curve and auc</a></li></ul>
<div class="tab-content">
<div id="tabset-25-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-25-1-tab">
<p>We are going to predict on test in order to get a estimation of the performance of the model.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular las predicciones para el conjunto de test</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>predicciones_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(mejor_modelo, <span class="at">newdata =</span> datos_test, <span class="at">type =</span> <span class="st">"raw"</span>)</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>predicciones_test <span class="ot">&lt;-</span> predicciones_test[, <span class="st">"SI"</span>]  <span class="co"># Asumiendo que "SI" es la clase positiva</span></span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>clases_predichas_test <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predicciones_test <span class="sc">&gt;=</span> <span class="fl">0.5</span>, <span class="st">"SI"</span>, <span class="st">"NO"</span>)</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a><span class="fu">mostrar_metricas</span>(datos_test<span class="sc">$</span>ESTADO_ACTUAL,clases_predichas_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The performance of the model is definitively acceptable. The last step is to ensure that the performance measurements are robust.</p>
</div>
<div id="tabset-25-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-25-2-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular la curva ROC y el AUC para el conjunto de test</span></span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_roc_curve</span>(predicciones_test,datos_test<span class="sc">$</span>ESTADO_ACTUAL)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The model is good in first instance. The next step is to ensure that the model is robust using a 5x2 cross validation.</p>
</div>
</div>
</div>
</div>
<div id="tabset-28-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-28-2-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Iniciar tiempo de ejecución</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Parámetros a cambiar</span></span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>proportion <span class="ot">&lt;-</span> <span class="fl">0.28</span></span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Configurar la validación cruzada 5x3</span></span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>k_outer <span class="ot">&lt;-</span> <span class="dv">5</span>  <span class="co"># Número de pliegues externos</span></span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a>k_inner <span class="ot">&lt;-</span> <span class="dv">3</span>  <span class="co"># Número de pliegues internos</span></span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)  <span class="co"># Establecer semilla para reproducibilidad</span></span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a>folds_outer <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(data<span class="sc">$</span>ESTADO_ACTUAL, <span class="at">k =</span> k_outer, <span class="at">list =</span> <span class="cn">FALSE</span>)  <span class="co"># Obtener índices de pliegues externos</span></span>
<span id="cb120-12"><a href="#cb120-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-13"><a href="#cb120-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Lista para almacenar resultados</span></span>
<span id="cb120-14"><a href="#cb120-14" aria-hidden="true" tabindex="-1"></a>resultados_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb120-15"><a href="#cb120-15" aria-hidden="true" tabindex="-1"></a>resultados_accuracy <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb120-16"><a href="#cb120-16" aria-hidden="true" tabindex="-1"></a>resultados_sensibilidad <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb120-17"><a href="#cb120-17" aria-hidden="true" tabindex="-1"></a>indices <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data)</span>
<span id="cb120-18"><a href="#cb120-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-19"><a href="#cb120-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Inicializar matrices para almacenar predicciones y objetivos</span></span>
<span id="cb120-20"><a href="#cb120-20" aria-hidden="true" tabindex="-1"></a>predicciones_totales <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">nrow</span>(data), <span class="at">ncol =</span> k_outer)</span>
<span id="cb120-21"><a href="#cb120-21" aria-hidden="true" tabindex="-1"></a>targets_totales <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(data))</span>
<span id="cb120-22"><a href="#cb120-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-23"><a href="#cb120-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterar sobre cada pliegue externo y realizar el proceso de modelado</span></span>
<span id="cb120-24"><a href="#cb120-24" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i_outer <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k_outer) {</span>
<span id="cb120-25"><a href="#cb120-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-26"><a href="#cb120-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Obtener los índices para el pliegue externo actual</span></span>
<span id="cb120-27"><a href="#cb120-27" aria-hidden="true" tabindex="-1"></a>  test_indices_outer <span class="ot">&lt;-</span> indices[folds_outer <span class="sc">==</span> i_outer]  <span class="co"># Índices correspondientes al pliegue externo de test</span></span>
<span id="cb120-28"><a href="#cb120-28" aria-hidden="true" tabindex="-1"></a>  train_indices_outer <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data), test_indices_outer)  <span class="co"># Índices correspondientes al conjunto de entrenamiento</span></span>
<span id="cb120-29"><a href="#cb120-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb120-30"><a href="#cb120-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Dividir datos en entrenamiento y test para el pliegue externo</span></span>
<span id="cb120-31"><a href="#cb120-31" aria-hidden="true" tabindex="-1"></a>  datos_entrenamiento_outer <span class="ot">&lt;-</span> data[train_indices_outer, ]</span>
<span id="cb120-32"><a href="#cb120-32" aria-hidden="true" tabindex="-1"></a>  datos_test_outer <span class="ot">&lt;-</span> data[test_indices_outer, ]</span>
<span id="cb120-33"><a href="#cb120-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb120-34"><a href="#cb120-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Configurar la validación cruzada interna</span></span>
<span id="cb120-35"><a href="#cb120-35" aria-hidden="true" tabindex="-1"></a>  folds_inner <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(datos_entrenamiento_outer<span class="sc">$</span>ESTADO_ACTUAL, <span class="at">k =</span> k_inner, <span class="at">list =</span> <span class="cn">FALSE</span>)  <span class="co"># Obtener índices de pliegues internos</span></span>
<span id="cb120-36"><a href="#cb120-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb120-37"><a href="#cb120-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Almacenar predicciones y objetivos para el AUC general</span></span>
<span id="cb120-38"><a href="#cb120-38" aria-hidden="true" tabindex="-1"></a>  predicciones_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(datos_entrenamiento_outer))</span>
<span id="cb120-39"><a href="#cb120-39" aria-hidden="true" tabindex="-1"></a>  targets_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(datos_entrenamiento_outer))</span>
<span id="cb120-40"><a href="#cb120-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb120-41"><a href="#cb120-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Inicializar variables para almacenar resultados internos</span></span>
<span id="cb120-42"><a href="#cb120-42" aria-hidden="true" tabindex="-1"></a>  resultados_auc_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb120-43"><a href="#cb120-43" aria-hidden="true" tabindex="-1"></a>  resultados_accuracy_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb120-44"><a href="#cb120-44" aria-hidden="true" tabindex="-1"></a>  resultados_sensibilidad_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb120-45"><a href="#cb120-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb120-46"><a href="#cb120-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Iterar sobre cada pliegue interno para selección de modelo</span></span>
<span id="cb120-47"><a href="#cb120-47" aria-hidden="true" tabindex="-1"></a>  indices_inner <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(datos_entrenamiento_outer)</span>
<span id="cb120-48"><a href="#cb120-48" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i_inner <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k_inner) {</span>
<span id="cb120-49"><a href="#cb120-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Obtener los índices para el pliegue interno actual</span></span>
<span id="cb120-50"><a href="#cb120-50" aria-hidden="true" tabindex="-1"></a>    test_indices_inner <span class="ot">&lt;-</span> indices_inner[folds_inner <span class="sc">==</span> i_inner]  <span class="co"># Índices correspondientes al pliegue interno de test</span></span>
<span id="cb120-51"><a href="#cb120-51" aria-hidden="true" tabindex="-1"></a>    train_indices_inner <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(datos_entrenamiento_outer), test_indices_inner)  <span class="co"># Índices correspondientes al conjunto de entrenamiento interno</span></span>
<span id="cb120-52"><a href="#cb120-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb120-53"><a href="#cb120-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Dividir datos en entrenamiento y test para el pliegue interno</span></span>
<span id="cb120-54"><a href="#cb120-54" aria-hidden="true" tabindex="-1"></a>    datos_entrenamiento_inner <span class="ot">&lt;-</span> datos_entrenamiento_outer[train_indices_inner, ]</span>
<span id="cb120-55"><a href="#cb120-55" aria-hidden="true" tabindex="-1"></a>    datos_validacion <span class="ot">&lt;-</span> datos_entrenamiento_outer[test_indices_inner, ]</span>
<span id="cb120-56"><a href="#cb120-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb120-57"><a href="#cb120-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aplicar oversampling en el conjunto de entrenamiento interno</span></span>
<span id="cb120-58"><a href="#cb120-58" aria-hidden="true" tabindex="-1"></a>    datos_entrenamiento_oversampled <span class="ot">&lt;-</span> <span class="fu">ROSE</span>(ESTADO_ACTUAL <span class="sc">~</span> ., <span class="at">data =</span> datos_entrenamiento_inner, <span class="at">seed =</span> <span class="dv">123</span>, <span class="at">p =</span> proportion)<span class="sc">$</span>data</span>
<span id="cb120-59"><a href="#cb120-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (params <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(param_grid)) {</span>
<span id="cb120-60"><a href="#cb120-60" aria-hidden="true" tabindex="-1"></a>      usekernel <span class="ot">&lt;-</span> param_grid<span class="sc">$</span>usekernel[params]</span>
<span id="cb120-61"><a href="#cb120-61" aria-hidden="true" tabindex="-1"></a>      laplace <span class="ot">&lt;-</span> param_grid<span class="sc">$</span>laplace[params]</span>
<span id="cb120-62"><a href="#cb120-62" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb120-63"><a href="#cb120-63" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Entrenar el modelo Naive Bayes con la combinación de hiperparámetros actual</span></span>
<span id="cb120-64"><a href="#cb120-64" aria-hidden="true" tabindex="-1"></a>      modelo <span class="ot">&lt;-</span> <span class="fu">naiveBayes</span>(formula, <span class="at">data =</span> datos_entrenamiento_oversampled, <span class="at">kernel =</span> usekernel, <span class="at">laplace =</span> laplace)</span>
<span id="cb120-65"><a href="#cb120-65" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb120-66"><a href="#cb120-66" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Realizar predicciones en datos de validación</span></span>
<span id="cb120-67"><a href="#cb120-67" aria-hidden="true" tabindex="-1"></a>      predicciones_validacion <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelo, <span class="at">newdata =</span> datos_validacion, <span class="at">type =</span> <span class="st">"raw"</span>)</span>
<span id="cb120-68"><a href="#cb120-68" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb120-69"><a href="#cb120-69" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Calcular AUC para la combinación actual</span></span>
<span id="cb120-70"><a href="#cb120-70" aria-hidden="true" tabindex="-1"></a>      roc_obj <span class="ot">&lt;-</span> <span class="fu">roc</span>(<span class="fu">ifelse</span>(datos_validacion<span class="sc">$</span>ESTADO_ACTUAL <span class="sc">==</span> <span class="st">"SI"</span>, <span class="dv">1</span>, <span class="dv">0</span>), predicciones_validacion[, <span class="st">"SI"</span>])</span>
<span id="cb120-71"><a href="#cb120-71" aria-hidden="true" tabindex="-1"></a>      auc_actual <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">auc</span>(roc_obj))  <span class="co"># Extraer el valor numérico del AUC</span></span>
<span id="cb120-72"><a href="#cb120-72" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb120-73"><a href="#cb120-73" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Actualizar el mejor modelo y su AUC si se encuentra un modelo mejor</span></span>
<span id="cb120-74"><a href="#cb120-74" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (auc_actual <span class="sc">&gt;</span> mejor_auc) {</span>
<span id="cb120-75"><a href="#cb120-75" aria-hidden="true" tabindex="-1"></a>        mejor_auc <span class="ot">&lt;-</span> auc_actual</span>
<span id="cb120-76"><a href="#cb120-76" aria-hidden="true" tabindex="-1"></a>        mejor_modelo <span class="ot">&lt;-</span> modelo</span>
<span id="cb120-77"><a href="#cb120-77" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb120-78"><a href="#cb120-78" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb120-79"><a href="#cb120-79" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Almacenar las predicciones y objetivos</span></span>
<span id="cb120-80"><a href="#cb120-80" aria-hidden="true" tabindex="-1"></a>    predicciones_auc[test_indices_inner] <span class="ot">&lt;-</span> predicciones_validacion_prob</span>
<span id="cb120-81"><a href="#cb120-81" aria-hidden="true" tabindex="-1"></a>    targets_auc[test_indices_inner] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(datos_validacion<span class="sc">$</span>ESTADO_ACTUAL) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb120-82"><a href="#cb120-82" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb120-83"><a href="#cb120-83" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calcular la sensibilidad y la precisión</span></span>
<span id="cb120-84"><a href="#cb120-84" aria-hidden="true" tabindex="-1"></a>    umbral <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb120-85"><a href="#cb120-85" aria-hidden="true" tabindex="-1"></a>    predicciones_finales <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predicciones_validacion_prob <span class="sc">&gt;=</span> umbral, <span class="st">"SI"</span>, <span class="st">"NO"</span>)</span>
<span id="cb120-86"><a href="#cb120-86" aria-hidden="true" tabindex="-1"></a>    TP <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_finales <span class="sc">==</span> <span class="st">"SI"</span> <span class="sc">&amp;</span> datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]] <span class="sc">==</span> <span class="st">"SI"</span>)</span>
<span id="cb120-87"><a href="#cb120-87" aria-hidden="true" tabindex="-1"></a>    FN <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_finales <span class="sc">==</span> <span class="st">"NO"</span> <span class="sc">&amp;</span> datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]] <span class="sc">==</span> <span class="st">"SI"</span>)</span>
<span id="cb120-88"><a href="#cb120-88" aria-hidden="true" tabindex="-1"></a>    FP <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_finales <span class="sc">==</span> <span class="st">"SI"</span> <span class="sc">&amp;</span> datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]] <span class="sc">==</span> <span class="st">"NO"</span>)</span>
<span id="cb120-89"><a href="#cb120-89" aria-hidden="true" tabindex="-1"></a>    TN <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_finales <span class="sc">==</span> <span class="st">"NO"</span> <span class="sc">&amp;</span> datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]] <span class="sc">==</span> <span class="st">"NO"</span>)</span>
<span id="cb120-90"><a href="#cb120-90" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb120-91"><a href="#cb120-91" aria-hidden="true" tabindex="-1"></a>    recall_actual <span class="ot">&lt;-</span> TP <span class="sc">/</span> (TP <span class="sc">+</span> FN)</span>
<span id="cb120-92"><a href="#cb120-92" aria-hidden="true" tabindex="-1"></a>    accuracy_actual <span class="ot">&lt;-</span> (TP <span class="sc">+</span> TN) <span class="sc">/</span> (TP <span class="sc">+</span> FN <span class="sc">+</span> FP <span class="sc">+</span> TN)</span>
<span id="cb120-93"><a href="#cb120-93" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb120-94"><a href="#cb120-94" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Almacenar resultados internos</span></span>
<span id="cb120-95"><a href="#cb120-95" aria-hidden="true" tabindex="-1"></a>    resultados_sensibilidad_inner[i_inner] <span class="ot">&lt;-</span> recall_actual</span>
<span id="cb120-96"><a href="#cb120-96" aria-hidden="true" tabindex="-1"></a>    resultados_accuracy_inner[i_inner] <span class="ot">&lt;-</span> accuracy_actual</span>
<span id="cb120-97"><a href="#cb120-97" aria-hidden="true" tabindex="-1"></a>    resultados_auc_inner[i_inner] <span class="ot">&lt;-</span> auc_actual</span>
<span id="cb120-98"><a href="#cb120-98" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb120-99"><a href="#cb120-99" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb120-100"><a href="#cb120-100" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular el AUC final para este pliegue externo</span></span>
<span id="cb120-101"><a href="#cb120-101" aria-hidden="true" tabindex="-1"></a>  auc_fold_externo <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_auc_inner)</span>
<span id="cb120-102"><a href="#cb120-102" aria-hidden="true" tabindex="-1"></a>  accuracy_fold_externo <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_accuracy_inner)</span>
<span id="cb120-103"><a href="#cb120-103" aria-hidden="true" tabindex="-1"></a>  sensibilidad_fold_externo <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_sensibilidad_inner)</span>
<span id="cb120-104"><a href="#cb120-104" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb120-105"><a href="#cb120-105" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Almacenar el AUC del fold externo actual</span></span>
<span id="cb120-106"><a href="#cb120-106" aria-hidden="true" tabindex="-1"></a>  resultados_auc[i_outer] <span class="ot">&lt;-</span> auc_fold_externo</span>
<span id="cb120-107"><a href="#cb120-107" aria-hidden="true" tabindex="-1"></a>  resultados_accuracy[i_outer] <span class="ot">&lt;-</span> accuracy_fold_externo</span>
<span id="cb120-108"><a href="#cb120-108" aria-hidden="true" tabindex="-1"></a>  resultados_sensibilidad[i_outer] <span class="ot">&lt;-</span> sensibilidad_fold_externo</span>
<span id="cb120-109"><a href="#cb120-109" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb120-110"><a href="#cb120-110" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Predecir en los datos de test para este pliegue externo y almacenar predicciones</span></span>
<span id="cb120-111"><a href="#cb120-111" aria-hidden="true" tabindex="-1"></a>  predicciones_test_outer_prob <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelo, <span class="at">newdata =</span> datos_test_outer, <span class="at">type =</span> <span class="st">"raw"</span>)[,<span class="dv">2</span>]</span>
<span id="cb120-112"><a href="#cb120-112" aria-hidden="true" tabindex="-1"></a>  predicciones_totales[test_indices_outer, i_outer] <span class="ot">&lt;-</span> predicciones_test_outer_prob</span>
<span id="cb120-113"><a href="#cb120-113" aria-hidden="true" tabindex="-1"></a>  targets_totales[test_indices_outer] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(datos_test_outer<span class="sc">$</span>ESTADO_ACTUAL) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb120-114"><a href="#cb120-114" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb120-115"><a href="#cb120-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-116"><a href="#cb120-116" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular AUC promedio</span></span>
<span id="cb120-117"><a href="#cb120-117" aria-hidden="true" tabindex="-1"></a>auc_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_auc)</span>
<span id="cb120-118"><a href="#cb120-118" aria-hidden="true" tabindex="-1"></a>accuracy_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_accuracy)</span>
<span id="cb120-119"><a href="#cb120-119" aria-hidden="true" tabindex="-1"></a>sensibilidad_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_sensibilidad)</span>
<span id="cb120-120"><a href="#cb120-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-121"><a href="#cb120-121" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear tabla con todas las métricas</span></span>
<span id="cb120-122"><a href="#cb120-122" aria-hidden="true" tabindex="-1"></a>tabla_metricas <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb120-123"><a href="#cb120-123" aria-hidden="true" tabindex="-1"></a>  <span class="at">Pliegue =</span> <span class="dv">1</span><span class="sc">:</span>k_outer,</span>
<span id="cb120-124"><a href="#cb120-124" aria-hidden="true" tabindex="-1"></a>  <span class="at">AUC =</span> <span class="fu">sapply</span>(resultados_auc, round, <span class="at">digits =</span> <span class="dv">3</span>),</span>
<span id="cb120-125"><a href="#cb120-125" aria-hidden="true" tabindex="-1"></a>  <span class="at">Accuracy =</span> <span class="fu">sapply</span>(resultados_accuracy, round, <span class="at">digits =</span> <span class="dv">3</span>),</span>
<span id="cb120-126"><a href="#cb120-126" aria-hidden="true" tabindex="-1"></a>  <span class="at">Recall =</span> <span class="fu">sapply</span>(resultados_sensibilidad, round, <span class="at">digits =</span> <span class="dv">3</span>)</span>
<span id="cb120-127"><a href="#cb120-127" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb120-128"><a href="#cb120-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-129"><a href="#cb120-129" aria-hidden="true" tabindex="-1"></a><span class="co"># Agregar fila con promedio de métricas</span></span>
<span id="cb120-130"><a href="#cb120-130" aria-hidden="true" tabindex="-1"></a>tabla_metricas_naive <span class="ot">&lt;-</span> <span class="fu">rbind</span>(tabla_metricas, <span class="fu">c</span>(<span class="st">"Mean"</span>, <span class="fu">round</span>(auc_promedio, <span class="dv">3</span>), <span class="fu">round</span>(accuracy_promedio, <span class="dv">3</span>), <span class="fu">round</span>(sensibilidad_promedio, <span class="dv">3</span>)))</span>
<span id="cb120-131"><a href="#cb120-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-132"><a href="#cb120-132" aria-hidden="true" tabindex="-1"></a><span class="co"># Detener el tiempo de ejecución</span></span>
<span id="cb120-133"><a href="#cb120-133" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb120-134"><a href="#cb120-134" aria-hidden="true" tabindex="-1"></a>execution_time_naive <span class="ot">&lt;-</span> end_time <span class="sc">-</span> start_time</span>
<span id="cb120-135"><a href="#cb120-135" aria-hidden="true" tabindex="-1"></a>execution_time_naive <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(execution_time_naive, <span class="at">units =</span> <span class="st">"secs"</span>)</span>
<span id="cb120-136"><a href="#cb120-136" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(tabla_metricas_naive, <span class="at">file =</span> <span class="st">"tabla_metricas_naive_filter.RData"</span>)</span>
<span id="cb120-137"><a href="#cb120-137" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(execution_time_naive, <span class="at">file =</span> <span class="st">"execution_time_naive_filter.RData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"tabla_metricas_naive_filter.RData"</span>)</span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"execution_time_naive_filter.RData"</span>)</span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir el tiempo de ejecución</span></span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time_naive,  <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-26-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-26-1" role="tab" aria-controls="tabset-26-1" aria-selected="true" href="">Metrics Table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-26-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-26-2" role="tab" aria-controls="tabset-26-2" aria-selected="false" href="">Metrics Plot</a></li></ul>
<div class="tab-content">
<div id="tabset-26-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-26-1-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir tabla formateada con kableExtra</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(tabla_metricas_naive, <span class="at">caption =</span> <span class="st">"Cross Validation Metrics"</span>, <span class="at">align =</span> <span class="st">"c"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="tabset-26-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-26-2-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="fu">crear_plot_metricas_per_fold</span>(tabla_metricas_naive)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
<p>The model is one of the best so far. The performance metrics are good and the model is robust. The next step is to use a variable selection method to improve the model. We are going to use brute force wrapper to select the best variables.</p>
</div>
<div id="tabset-28-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-28-3-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Iniciar tiempo de ejecución</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Parámetros a cambiar</span></span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>proportion <span class="ot">&lt;-</span> <span class="fl">0.28</span></span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Configurar la validación cruzada 5x2</span></span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a>k_outer <span class="ot">&lt;-</span> <span class="dv">5</span>  <span class="co"># Número de pliegues externos</span></span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a>k_inner <span class="ot">&lt;-</span> <span class="dv">2</span>  <span class="co"># Número de pliegues internos</span></span>
<span id="cb124-10"><a href="#cb124-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-11"><a href="#cb124-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Lista para almacenar resultados</span></span>
<span id="cb124-12"><a href="#cb124-12" aria-hidden="true" tabindex="-1"></a>resultados_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb124-13"><a href="#cb124-13" aria-hidden="true" tabindex="-1"></a>resultados_accuracy <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb124-14"><a href="#cb124-14" aria-hidden="true" tabindex="-1"></a>resultados_sensibilidad <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb124-15"><a href="#cb124-15" aria-hidden="true" tabindex="-1"></a>indices <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data)</span>
<span id="cb124-16"><a href="#cb124-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-17"><a href="#cb124-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Inicializar matrices para almacenar predicciones y objetivos</span></span>
<span id="cb124-18"><a href="#cb124-18" aria-hidden="true" tabindex="-1"></a>predicciones_totales <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">nrow</span>(data), <span class="at">ncol =</span> k_outer)</span>
<span id="cb124-19"><a href="#cb124-19" aria-hidden="true" tabindex="-1"></a>targets_totales <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(data))</span>
<span id="cb124-20"><a href="#cb124-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-21"><a href="#cb124-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterar sobre cada pliegue externo y realizar el proceso de modelado</span></span>
<span id="cb124-22"><a href="#cb124-22" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i_outer <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k_outer) {</span>
<span id="cb124-23"><a href="#cb124-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb124-24"><a href="#cb124-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Obtener los índices para el pliegue externo actual</span></span>
<span id="cb124-25"><a href="#cb124-25" aria-hidden="true" tabindex="-1"></a>  test_indices_outer <span class="ot">&lt;-</span> indices[folds_outer <span class="sc">==</span> i_outer]  <span class="co"># Índices correspondientes al pliegue externo de test</span></span>
<span id="cb124-26"><a href="#cb124-26" aria-hidden="true" tabindex="-1"></a>  train_indices_outer <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data), test_indices_outer)  <span class="co"># Índices correspondientes al conjunto de entrenamiento</span></span>
<span id="cb124-27"><a href="#cb124-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb124-28"><a href="#cb124-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Dividir datos en entrenamiento y test para el pliegue externo</span></span>
<span id="cb124-29"><a href="#cb124-29" aria-hidden="true" tabindex="-1"></a>  datos_entrenamiento_outer <span class="ot">&lt;-</span> data[train_indices_outer, ]</span>
<span id="cb124-30"><a href="#cb124-30" aria-hidden="true" tabindex="-1"></a>  datos_test_outer <span class="ot">&lt;-</span> data[test_indices_outer, ]</span>
<span id="cb124-31"><a href="#cb124-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb124-32"><a href="#cb124-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Configurar la validación cruzada interna</span></span>
<span id="cb124-33"><a href="#cb124-33" aria-hidden="true" tabindex="-1"></a>  folds_inner <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(datos_entrenamiento_outer<span class="sc">$</span>ESTADO_ACTUAL, <span class="at">k =</span> k_inner, <span class="at">list =</span> <span class="cn">FALSE</span>)  <span class="co"># Obtener índices de pliegues internos</span></span>
<span id="cb124-34"><a href="#cb124-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb124-35"><a href="#cb124-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Almacenar predicciones y objetivos para el AUC general</span></span>
<span id="cb124-36"><a href="#cb124-36" aria-hidden="true" tabindex="-1"></a>  predicciones_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(datos_entrenamiento_outer))</span>
<span id="cb124-37"><a href="#cb124-37" aria-hidden="true" tabindex="-1"></a>  targets_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(datos_entrenamiento_outer))</span>
<span id="cb124-38"><a href="#cb124-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb124-39"><a href="#cb124-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Inicializar variables para almacenar resultados internos</span></span>
<span id="cb124-40"><a href="#cb124-40" aria-hidden="true" tabindex="-1"></a>  resultados_auc_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb124-41"><a href="#cb124-41" aria-hidden="true" tabindex="-1"></a>  resultados_accuracy_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb124-42"><a href="#cb124-42" aria-hidden="true" tabindex="-1"></a>  resultados_sensibilidad_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb124-43"><a href="#cb124-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb124-44"><a href="#cb124-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Iterar sobre cada pliegue interno para selección de modelo</span></span>
<span id="cb124-45"><a href="#cb124-45" aria-hidden="true" tabindex="-1"></a>  indices_inner <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(datos_entrenamiento_outer)</span>
<span id="cb124-46"><a href="#cb124-46" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i_inner <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k_inner) {</span>
<span id="cb124-47"><a href="#cb124-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Obtener los índices para el pliegue interno actual</span></span>
<span id="cb124-48"><a href="#cb124-48" aria-hidden="true" tabindex="-1"></a>    test_indices_inner <span class="ot">&lt;-</span> indices_inner[folds_inner <span class="sc">==</span> i_inner]  <span class="co"># Índices correspondientes al pliegue interno de test</span></span>
<span id="cb124-49"><a href="#cb124-49" aria-hidden="true" tabindex="-1"></a>    train_indices_inner <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(datos_entrenamiento_outer), test_indices_inner)  <span class="co"># Índices correspondientes al conjunto de entrenamiento interno</span></span>
<span id="cb124-50"><a href="#cb124-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb124-51"><a href="#cb124-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Dividir datos en entrenamiento y test para el pliegue interno</span></span>
<span id="cb124-52"><a href="#cb124-52" aria-hidden="true" tabindex="-1"></a>    datos_entrenamiento_inner <span class="ot">&lt;-</span> datos_entrenamiento_outer[train_indices_inner, ]</span>
<span id="cb124-53"><a href="#cb124-53" aria-hidden="true" tabindex="-1"></a>    datos_validacion <span class="ot">&lt;-</span> datos_entrenamiento_outer[test_indices_inner, ]</span>
<span id="cb124-54"><a href="#cb124-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb124-55"><a href="#cb124-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Almacenar predicciones y objetivos para el AUC interno</span></span>
<span id="cb124-56"><a href="#cb124-56" aria-hidden="true" tabindex="-1"></a>    predicciones_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(datos_validacion))</span>
<span id="cb124-57"><a href="#cb124-57" aria-hidden="true" tabindex="-1"></a>    targets_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(datos_validacion))</span>
<span id="cb124-58"><a href="#cb124-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb124-59"><a href="#cb124-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Definir todas las combinaciones de variables (sustituye esto por tus combinaciones reales)</span></span>
<span id="cb124-60"><a href="#cb124-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-61"><a href="#cb124-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Iterar sobre cada combinación de variables para selección de modelo</span></span>
<span id="cb124-62"><a href="#cb124-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (combinacion <span class="cf">in</span> combinaciones_variables) {</span>
<span id="cb124-63"><a href="#cb124-63" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb124-64"><a href="#cb124-64" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Aplicar oversampling en el conjunto de entrenamiento interno</span></span>
<span id="cb124-65"><a href="#cb124-65" aria-hidden="true" tabindex="-1"></a>      datos_entrenamiento_oversampled <span class="ot">&lt;-</span> <span class="fu">ROSE</span>(ESTADO_ACTUAL <span class="sc">~</span> ., <span class="at">data =</span> datos_entrenamiento_inner, <span class="at">p =</span> proportion)<span class="sc">$</span>data</span>
<span id="cb124-66"><a href="#cb124-66" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb124-67"><a href="#cb124-67" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Definir la fórmula para el modelo</span></span>
<span id="cb124-68"><a href="#cb124-68" aria-hidden="true" tabindex="-1"></a>      formula_actual <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(<span class="st">"ESTADO_ACTUAL"</span>, <span class="st">"~"</span>, <span class="fu">paste</span>(combinacion, <span class="at">collapse =</span> <span class="st">"+"</span>)))</span>
<span id="cb124-69"><a href="#cb124-69" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb124-70"><a href="#cb124-70" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Entrenar el modelo Naive Bayes</span></span>
<span id="cb124-71"><a href="#cb124-71" aria-hidden="true" tabindex="-1"></a>      modelo <span class="ot">&lt;-</span> <span class="fu">naiveBayes</span>(formula_actual, <span class="at">data =</span> datos_entrenamiento_oversampled)</span>
<span id="cb124-72"><a href="#cb124-72" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb124-73"><a href="#cb124-73" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Realizar predicciones con probabilidades en datos de validación</span></span>
<span id="cb124-74"><a href="#cb124-74" aria-hidden="true" tabindex="-1"></a>      predicciones_validacion_prob <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelo, <span class="at">newdata =</span> datos_validacion, <span class="at">type =</span> <span class="st">"raw"</span>)[,<span class="dv">2</span>]</span>
<span id="cb124-75"><a href="#cb124-75" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb124-76"><a href="#cb124-76" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Calcular el AUC</span></span>
<span id="cb124-77"><a href="#cb124-77" aria-hidden="true" tabindex="-1"></a>      roc_obj <span class="ot">&lt;-</span> <span class="fu">roc</span>(datos_validacion<span class="sc">$</span>ESTADO_ACTUAL, predicciones_validacion_prob, <span class="at">levels =</span> <span class="fu">rev</span>(<span class="fu">levels</span>(datos_validacion<span class="sc">$</span>ESTADO_ACTUAL)))</span>
<span id="cb124-78"><a href="#cb124-78" aria-hidden="true" tabindex="-1"></a>      auc_actual <span class="ot">&lt;-</span> <span class="fu">auc</span>(roc_obj)</span>
<span id="cb124-79"><a href="#cb124-79" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb124-80"><a href="#cb124-80" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Almacenar las predicciones y objetivos</span></span>
<span id="cb124-81"><a href="#cb124-81" aria-hidden="true" tabindex="-1"></a>      predicciones_auc[test_indices_inner] <span class="ot">&lt;-</span> predicciones_validacion_prob</span>
<span id="cb124-82"><a href="#cb124-82" aria-hidden="true" tabindex="-1"></a>      targets_auc[test_indices_inner] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(datos_validacion<span class="sc">$</span>ESTADO_ACTUAL) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb124-83"><a href="#cb124-83" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb124-84"><a href="#cb124-84" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Calcular la sensibilidad y la precisión</span></span>
<span id="cb124-85"><a href="#cb124-85" aria-hidden="true" tabindex="-1"></a>      umbral <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb124-86"><a href="#cb124-86" aria-hidden="true" tabindex="-1"></a>      predicciones_finales <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predicciones_validacion_prob <span class="sc">&gt;=</span> umbral, <span class="st">"SI"</span>, <span class="st">"NO"</span>)</span>
<span id="cb124-87"><a href="#cb124-87" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_finales <span class="sc">==</span> <span class="st">"SI"</span> <span class="sc">&amp;</span> datos_validacion<span class="sc">$</span>ESTADO_ACTUAL <span class="sc">==</span> <span class="st">"SI"</span>)</span>
<span id="cb124-88"><a href="#cb124-88" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_finales <span class="sc">==</span> <span class="st">"NO"</span> <span class="sc">&amp;</span> datos_validacion<span class="sc">$</span>ESTADO_ACTUAL <span class="sc">==</span> <span class="st">"SI"</span>)</span>
<span id="cb124-89"><a href="#cb124-89" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_finales <span class="sc">==</span> <span class="st">"SI"</span> <span class="sc">&amp;</span> datos_validacion<span class="sc">$</span>ESTADO_ACTUAL <span class="sc">==</span> <span class="st">"NO"</span>)</span>
<span id="cb124-90"><a href="#cb124-90" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_finales <span class="sc">==</span> <span class="st">"NO"</span> <span class="sc">&amp;</span> datos_validacion<span class="sc">$</span>ESTADO_ACTUAL <span class="sc">==</span> <span class="st">"NO"</span>)</span>
<span id="cb124-91"><a href="#cb124-91" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb124-92"><a href="#cb124-92" aria-hidden="true" tabindex="-1"></a>      recall_actual <span class="ot">&lt;-</span> TP <span class="sc">/</span> (TP <span class="sc">+</span> FN)</span>
<span id="cb124-93"><a href="#cb124-93" aria-hidden="true" tabindex="-1"></a>      accuracy_actual <span class="ot">&lt;-</span> (TP <span class="sc">+</span> TN) <span class="sc">/</span> (TP <span class="sc">+</span> FN <span class="sc">+</span> FP <span class="sc">+</span> TN)</span>
<span id="cb124-94"><a href="#cb124-94" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb124-95"><a href="#cb124-95" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Almacenar resultados internos</span></span>
<span id="cb124-96"><a href="#cb124-96" aria-hidden="true" tabindex="-1"></a>      resultados_sensibilidad_inner[i_inner] <span class="ot">&lt;-</span> recall_actual</span>
<span id="cb124-97"><a href="#cb124-97" aria-hidden="true" tabindex="-1"></a>      resultados_accuracy_inner[i_inner] <span class="ot">&lt;-</span> accuracy_actual</span>
<span id="cb124-98"><a href="#cb124-98" aria-hidden="true" tabindex="-1"></a>      resultados_auc_inner[i_inner] <span class="ot">&lt;-</span> auc_actual</span>
<span id="cb124-99"><a href="#cb124-99" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb124-100"><a href="#cb124-100" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb124-101"><a href="#cb124-101" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb124-102"><a href="#cb124-102" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular el AUC final para este pliegue externo</span></span>
<span id="cb124-103"><a href="#cb124-103" aria-hidden="true" tabindex="-1"></a>  auc_fold_externo <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_auc_inner)</span>
<span id="cb124-104"><a href="#cb124-104" aria-hidden="true" tabindex="-1"></a>  accuracy_fold_externo <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_accuracy_inner)</span>
<span id="cb124-105"><a href="#cb124-105" aria-hidden="true" tabindex="-1"></a>  sensibilidad_fold_externo <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_sensibilidad_inner)</span>
<span id="cb124-106"><a href="#cb124-106" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb124-107"><a href="#cb124-107" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Almacenar el AUC del fold externo actual</span></span>
<span id="cb124-108"><a href="#cb124-108" aria-hidden="true" tabindex="-1"></a>  resultados_auc[i_outer] <span class="ot">&lt;-</span> auc_fold_externo</span>
<span id="cb124-109"><a href="#cb124-109" aria-hidden="true" tabindex="-1"></a>  resultados_accuracy[i_outer] <span class="ot">&lt;-</span> accuracy_fold_externo</span>
<span id="cb124-110"><a href="#cb124-110" aria-hidden="true" tabindex="-1"></a>  resultados_sensibilidad[i_outer] <span class="ot">&lt;-</span> sensibilidad_fold_externo</span>
<span id="cb124-111"><a href="#cb124-111" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb124-112"><a href="#cb124-112" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Predecir en los datos de test para este pliegue externo y almacenar predicciones</span></span>
<span id="cb124-113"><a href="#cb124-113" aria-hidden="true" tabindex="-1"></a>  <span class="co"># (Aquí deberías hacer la predicción usando el mejor modelo encontrado en el bucle interno)</span></span>
<span id="cb124-114"><a href="#cb124-114" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb124-115"><a href="#cb124-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-116"><a href="#cb124-116" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular AUC promedio</span></span>
<span id="cb124-117"><a href="#cb124-117" aria-hidden="true" tabindex="-1"></a>auc_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_auc)</span>
<span id="cb124-118"><a href="#cb124-118" aria-hidden="true" tabindex="-1"></a>accuracy_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_accuracy)</span>
<span id="cb124-119"><a href="#cb124-119" aria-hidden="true" tabindex="-1"></a>sensibilidad_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_sensibilidad)</span>
<span id="cb124-120"><a href="#cb124-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-121"><a href="#cb124-121" aria-hidden="true" tabindex="-1"></a>tabla_metricas <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb124-122"><a href="#cb124-122" aria-hidden="true" tabindex="-1"></a>  <span class="at">Pliegue =</span> <span class="dv">1</span><span class="sc">:</span>k_outer,</span>
<span id="cb124-123"><a href="#cb124-123" aria-hidden="true" tabindex="-1"></a>  <span class="at">AUC =</span> <span class="fu">sapply</span>(resultados_auc, round, <span class="at">digits =</span> <span class="dv">3</span>),</span>
<span id="cb124-124"><a href="#cb124-124" aria-hidden="true" tabindex="-1"></a>  <span class="at">Accuracy =</span> <span class="fu">sapply</span>(resultados_accuracy, round, <span class="at">digits =</span> <span class="dv">3</span>),</span>
<span id="cb124-125"><a href="#cb124-125" aria-hidden="true" tabindex="-1"></a>  <span class="at">Recall =</span> <span class="fu">sapply</span>(resultados_sensibilidad, round, <span class="at">digits =</span> <span class="dv">3</span>)</span>
<span id="cb124-126"><a href="#cb124-126" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb124-127"><a href="#cb124-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-128"><a href="#cb124-128" aria-hidden="true" tabindex="-1"></a><span class="co"># Agregar fila con promedio de métricas</span></span>
<span id="cb124-129"><a href="#cb124-129" aria-hidden="true" tabindex="-1"></a>tabla_metricas_naive_wrapper <span class="ot">&lt;-</span> <span class="fu">rbind</span>(tabla_metricas, <span class="fu">c</span>(<span class="st">"Mean"</span>, <span class="fu">round</span>(auc_promedio, <span class="dv">3</span>), <span class="fu">round</span>(accuracy_promedio, <span class="dv">3</span>), <span class="fu">round</span>(sensibilidad_promedio, <span class="dv">3</span>)))</span>
<span id="cb124-130"><a href="#cb124-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-131"><a href="#cb124-131" aria-hidden="true" tabindex="-1"></a><span class="co"># Detener el tiempo de ejecución</span></span>
<span id="cb124-132"><a href="#cb124-132" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb124-133"><a href="#cb124-133" aria-hidden="true" tabindex="-1"></a>execution_time_naive <span class="ot">&lt;-</span> end_time <span class="sc">-</span> start_time</span>
<span id="cb124-134"><a href="#cb124-134" aria-hidden="true" tabindex="-1"></a>execution_time_naive_wrapper <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(execution_time_naive, <span class="at">units =</span> <span class="st">"secs"</span>)</span>
<span id="cb124-135"><a href="#cb124-135" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(tabla_metricas_naive_wrapper, <span class="at">file =</span> <span class="st">"tabla_metricas_naive_wrapper.RData"</span>)</span>
<span id="cb124-136"><a href="#cb124-136" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(execution_time_naive_wrapper, <span class="at">file =</span> <span class="st">"execution_time_naive_wrapper.RData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"tabla_metricas_naive_wrapper.RData"</span>)</span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"execution_time_naive_wrapper.RData"</span>)</span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir el tiempo de ejecución</span></span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time_naive_wrapper,  <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-27-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-27-1" role="tab" aria-controls="tabset-27-1" aria-selected="true" href="">Metrics Table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-27-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-27-2" role="tab" aria-controls="tabset-27-2" aria-selected="false" href="">Metrics Plot</a></li></ul>
<div class="tab-content">
<div id="tabset-27-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-27-1-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir tabla formateada con kableExtra</span></span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(tabla_metricas_naive_wrapper, <span class="at">caption =</span> <span class="st">"Cross Validation Metrics"</span>, <span class="at">align =</span> <span class="st">"c"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="tabset-27-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-27-2-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="fu">crear_plot_metricas_per_fold</span>(tabla_metricas_naive_wrapper)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
<p>The naive bayes model with wrapper variable selection is the best model so far. The performance metrics are good and the model is robust.</p>
</div>
</div>
</div>
</div>
<div id="tabset-35-7" class="tab-pane" role="tabpanel" aria-labelledby="tabset-35-7-tab">
<div class="tabset-margin-container"></div><div class="panel-tabset" style="background-color: #f0f0f0;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-31-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-31-1" role="tab" aria-controls="tabset-31-1" aria-selected="true" href="">Hold out</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-31-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-31-2" role="tab" aria-controls="tabset-31-2" aria-selected="false" href="">5x2 Cross Validation Filter</a></li></ul>
<div class="tab-content" style="background-color: #f0f0f0;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;">
<div id="tabset-31-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-31-1-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Parámetros a cambiar</span></span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>proportion <span class="ot">&lt;-</span> <span class="fl">0.28</span></span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a>sensitivity_weight <span class="ot">&lt;-</span> <span class="fl">0.8</span></span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Dividir el conjunto de datos en entrenamiento y test</span></span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a>indices_entrenamiento <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(data), <span class="fl">0.75</span> <span class="sc">*</span> <span class="fu">nrow</span>(data))  <span class="co"># 75% para entrenamiento</span></span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento <span class="ot">&lt;-</span> data[indices_entrenamiento, ]</span>
<span id="cb128-9"><a href="#cb128-9" aria-hidden="true" tabindex="-1"></a>datos_test <span class="ot">&lt;-</span> data[<span class="sc">-</span>indices_entrenamiento, ]</span>
<span id="cb128-10"><a href="#cb128-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-11"><a href="#cb128-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Dividir datos de entrenamiento en entrenamiento y validación</span></span>
<span id="cb128-12"><a href="#cb128-12" aria-hidden="true" tabindex="-1"></a>train_indices <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(datos_entrenamiento), <span class="fl">0.8</span> <span class="sc">*</span> <span class="fu">nrow</span>(datos_entrenamiento))  <span class="co"># 80% para entrenamiento</span></span>
<span id="cb128-13"><a href="#cb128-13" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento_split <span class="ot">&lt;-</span> datos_entrenamiento[train_indices, ]</span>
<span id="cb128-14"><a href="#cb128-14" aria-hidden="true" tabindex="-1"></a>datos_validacion <span class="ot">&lt;-</span> datos_entrenamiento[<span class="sc">-</span>train_indices, ]</span>
<span id="cb128-15"><a href="#cb128-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-16"><a href="#cb128-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Realizar sobremuestreo en los datos de entrenamiento</span></span>
<span id="cb128-17"><a href="#cb128-17" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento_oversampled <span class="ot">&lt;-</span> <span class="fu">ROSE</span>(ESTADO_ACTUAL <span class="sc">~</span> ., <span class="at">data =</span> datos_entrenamiento_split, <span class="at">p =</span> proportion)<span class="sc">$</span>data</span>
<span id="cb128-18"><a href="#cb128-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-19"><a href="#cb128-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-20"><a href="#cb128-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Inicializar variables para almacenar los resultados</span></span>
<span id="cb128-21"><a href="#cb128-21" aria-hidden="true" tabindex="-1"></a>mejor_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb128-22"><a href="#cb128-22" aria-hidden="true" tabindex="-1"></a>mejor_k <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb128-23"><a href="#cb128-23" aria-hidden="true" tabindex="-1"></a>mejor_l <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb128-24"><a href="#cb128-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-25"><a href="#cb128-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Codificación One-Hot Encoding para variables categóricas</span></span>
<span id="cb128-26"><a href="#cb128-26" aria-hidden="true" tabindex="-1"></a>encoded_data_entrenamiento <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">model.matrix</span>(<span class="sc">~</span>.<span class="sc">-</span><span class="dv">1</span>, datos_entrenamiento_oversampled[, <span class="sc">-</span><span class="fu">which</span>(<span class="fu">names</span>(datos_entrenamiento_oversampled) <span class="sc">==</span> <span class="st">"ESTADO_ACTUAL"</span>)]))</span>
<span id="cb128-27"><a href="#cb128-27" aria-hidden="true" tabindex="-1"></a>encoded_data_test <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">model.matrix</span>(<span class="sc">~</span>.<span class="sc">-</span><span class="dv">1</span>, datos_test[, <span class="sc">-</span><span class="fu">which</span>(<span class="fu">names</span>(datos_test) <span class="sc">==</span> <span class="st">"ESTADO_ACTUAL"</span>)]))</span>
<span id="cb128-28"><a href="#cb128-28" aria-hidden="true" tabindex="-1"></a><span class="co">#Este código realiza la codificación One-Hot Encoding para las variables categóricas en los conjuntos de datos datos_entrenamiento_oversampled y datos_test. Primero, identifica la columna que contiene la variable objetivo "ESTADO_ACTUAL" y la excluye del proceso. Luego, utiliza la función model.matrix para crear una matriz de diseño que representa las variables categóricas codificadas en forma binaria. Finalmente, convierte esta matriz en un data frame.</span></span>
<span id="cb128-29"><a href="#cb128-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-30"><a href="#cb128-30" aria-hidden="true" tabindex="-1"></a>param_grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">k =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">20</span>, <span class="at">by =</span> <span class="dv">1</span>),</span>
<span id="cb128-31"><a href="#cb128-31" aria-hidden="true" tabindex="-1"></a>                           <span class="at">l =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">10</span>, <span class="at">by =</span> <span class="dv">1</span>))</span>
<span id="cb128-32"><a href="#cb128-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-33"><a href="#cb128-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Bucle para probar diferentes combinaciones de hiperparámetros</span></span>
<span id="cb128-34"><a href="#cb128-34" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(param_grid)) {</span>
<span id="cb128-35"><a href="#cb128-35" aria-hidden="true" tabindex="-1"></a>  k <span class="ot">&lt;-</span> param_grid<span class="sc">$</span>k[i]</span>
<span id="cb128-36"><a href="#cb128-36" aria-hidden="true" tabindex="-1"></a>  l <span class="ot">&lt;-</span> param_grid<span class="sc">$</span>l[i]</span>
<span id="cb128-37"><a href="#cb128-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Realizar predicciones en datos de validación</span></span>
<span id="cb128-38"><a href="#cb128-38" aria-hidden="true" tabindex="-1"></a>  predicciones_validacion <span class="ot">&lt;-</span> <span class="fu">knn</span>(<span class="at">train =</span> encoded_data_entrenamiento, </span>
<span id="cb128-39"><a href="#cb128-39" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">test =</span> encoded_data_test, </span>
<span id="cb128-40"><a href="#cb128-40" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">cl =</span> datos_entrenamiento_oversampled<span class="sc">$</span>ESTADO_ACTUAL, </span>
<span id="cb128-41"><a href="#cb128-41" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">k =</span> k, </span>
<span id="cb128-42"><a href="#cb128-42" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">use.all =</span> <span class="cn">TRUE</span>,</span>
<span id="cb128-43"><a href="#cb128-43" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">prob =</span> <span class="cn">TRUE</span>,</span>
<span id="cb128-44"><a href="#cb128-44" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">l =</span> l)</span>
<span id="cb128-45"><a href="#cb128-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb128-46"><a href="#cb128-46" aria-hidden="true" tabindex="-1"></a>  predicciones_validacion <span class="ot">&lt;-</span> <span class="fu">attr</span>(predicciones_validacion, <span class="st">"prob"</span>)  <span class="co"># Asumiendo que "SI" es la clase positiva</span></span>
<span id="cb128-47"><a href="#cb128-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb128-48"><a href="#cb128-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular AUC para la combinación actual</span></span>
<span id="cb128-49"><a href="#cb128-49" aria-hidden="true" tabindex="-1"></a>  roc_obj <span class="ot">&lt;-</span> <span class="fu">roc</span>(<span class="fu">ifelse</span>(datos_test<span class="sc">$</span>ESTADO_ACTUAL <span class="sc">==</span> <span class="st">"SI"</span>, <span class="dv">1</span>, <span class="dv">0</span>), predicciones_validacion)</span>
<span id="cb128-50"><a href="#cb128-50" aria-hidden="true" tabindex="-1"></a>  auc_actual <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">auc</span>(roc_obj))  <span class="co"># Extraer el valor numérico del AUC</span></span>
<span id="cb128-51"><a href="#cb128-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb128-52"><a href="#cb128-52" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Actualizar el mejor modelo y su rendimiento si se encuentra un modelo mejor</span></span>
<span id="cb128-53"><a href="#cb128-53" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (auc_actual <span class="sc">&gt;</span> mejor_auc) {</span>
<span id="cb128-54"><a href="#cb128-54" aria-hidden="true" tabindex="-1"></a>    mejor_auc <span class="ot">&lt;-</span> auc_actual</span>
<span id="cb128-55"><a href="#cb128-55" aria-hidden="true" tabindex="-1"></a>    mejor_k <span class="ot">&lt;-</span> k</span>
<span id="cb128-56"><a href="#cb128-56" aria-hidden="true" tabindex="-1"></a>    mejor_l <span class="ot">&lt;-</span> l</span>
<span id="cb128-57"><a href="#cb128-57" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb128-58"><a href="#cb128-58" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb128-59"><a href="#cb128-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-60"><a href="#cb128-60" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb128-61"><a href="#cb128-61" aria-hidden="true" tabindex="-1"></a>execution_time <span class="ot">&lt;-</span> end_time <span class="sc">-</span> start_time</span>
<span id="cb128-62"><a href="#cb128-62" aria-hidden="true" tabindex="-1"></a>execution_time <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(execution_time, <span class="at">units =</span> <span class="st">"secs"</span>)</span>
<span id="cb128-63"><a href="#cb128-63" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time,  <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb128-64"><a href="#cb128-64" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Best k:"</span>, mejor_k, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb128-65"><a href="#cb128-65" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Best l:"</span>, mejor_l, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-29-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-29-1" role="tab" aria-controls="tabset-29-1" aria-selected="true" href="">Predictions</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-29-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-29-2" role="tab" aria-controls="tabset-29-2" aria-selected="false" href="">Roc curve and auc</a></li></ul>
<div class="tab-content">
<div id="tabset-29-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-29-1-tab">
<p>We are going to predict on test in order to get a estimation of the performance of the model.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ejecutar la parte del código que involucra la función knn</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>predicciones_test <span class="ot">&lt;-</span> <span class="fu">knn</span>(<span class="at">train =</span> encoded_data_entrenamiento, </span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">test =</span> encoded_data_test, </span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">cl =</span> datos_entrenamiento_oversampled<span class="sc">$</span>ESTADO_ACTUAL, </span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a>                         <span class="at">k =</span> mejor_k, </span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a>                         <span class="at">use.all =</span> <span class="cn">TRUE</span>,</span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a>                         <span class="at">prob =</span> <span class="cn">TRUE</span>)</span>
<span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a>predicciones_test <span class="ot">&lt;-</span> <span class="fu">attr</span>(predicciones_test, <span class="st">"prob"</span>)  <span class="co"># Asumiendo que "SI" es la clase positiva</span></span>
<span id="cb129-9"><a href="#cb129-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-10"><a href="#cb129-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular las predicciones para el conjunto de test</span></span>
<span id="cb129-11"><a href="#cb129-11" aria-hidden="true" tabindex="-1"></a>clases_predichas_test <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predicciones_test <span class="sc">&gt;=</span> <span class="fl">0.5</span>, <span class="st">"SI"</span>, <span class="st">"NO"</span>)</span>
<span id="cb129-12"><a href="#cb129-12" aria-hidden="true" tabindex="-1"></a><span class="fu">mostrar_metricas</span>(datos_test<span class="sc">$</span>ESTADO_ACTUAL,clases_predichas_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="tabset-29-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-29-2-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular la curva ROC y el AUC para el conjunto de test</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_roc_curve</span>(predicciones_test,datos_test<span class="sc">$</span>ESTADO_ACTUAL)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
<p>The algorithm performance is really bad for this problem.</p>
</div>
<div id="tabset-31-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-31-2-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Configurar la validación cruzada 5x2</span></span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a>k_outer <span class="ot">&lt;-</span> <span class="dv">5</span>  <span class="co"># Número de pliegues externos</span></span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a>k_inner <span class="ot">&lt;-</span> <span class="dv">2</span>  <span class="co"># Número de pliegues internos</span></span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a>folds_outer <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(data<span class="sc">$</span>ESTADO_ACTUAL, <span class="at">k =</span> k_outer, <span class="at">list =</span> <span class="cn">FALSE</span>)  <span class="co"># Obtener índices de pliegues externos</span></span>
<span id="cb131-7"><a href="#cb131-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-8"><a href="#cb131-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Lista para almacenar resultados</span></span>
<span id="cb131-9"><a href="#cb131-9" aria-hidden="true" tabindex="-1"></a>resultados_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb131-10"><a href="#cb131-10" aria-hidden="true" tabindex="-1"></a>resultados_sensibilidad <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb131-11"><a href="#cb131-11" aria-hidden="true" tabindex="-1"></a>resultados_accuracy <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb131-12"><a href="#cb131-12" aria-hidden="true" tabindex="-1"></a>indices <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data)</span>
<span id="cb131-13"><a href="#cb131-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-14"><a href="#cb131-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Inicializar matrices para almacenar predicciones y objetivos</span></span>
<span id="cb131-15"><a href="#cb131-15" aria-hidden="true" tabindex="-1"></a>predicciones_totales <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">nrow</span>(data), <span class="at">ncol =</span> k_outer)</span>
<span id="cb131-16"><a href="#cb131-16" aria-hidden="true" tabindex="-1"></a>targets_totales <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(data))</span>
<span id="cb131-17"><a href="#cb131-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-18"><a href="#cb131-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterar sobre cada pliegue externo y realizar el proceso de modelado</span></span>
<span id="cb131-19"><a href="#cb131-19" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i_outer <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k_outer) {</span>
<span id="cb131-20"><a href="#cb131-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-21"><a href="#cb131-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Obtener los índices para el pliegue externo actual</span></span>
<span id="cb131-22"><a href="#cb131-22" aria-hidden="true" tabindex="-1"></a>  test_indices_outer <span class="ot">&lt;-</span> indices[folds_outer <span class="sc">==</span> i_outer]  <span class="co"># Índices correspondientes al pliegue externo de test</span></span>
<span id="cb131-23"><a href="#cb131-23" aria-hidden="true" tabindex="-1"></a>  train_indices_outer <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data), test_indices_outer)  <span class="co"># Índices correspondientes al conjunto de entrenamiento</span></span>
<span id="cb131-24"><a href="#cb131-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb131-25"><a href="#cb131-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Dividir datos en entrenamiento y test para el pliegue externo</span></span>
<span id="cb131-26"><a href="#cb131-26" aria-hidden="true" tabindex="-1"></a>  datos_entrenamiento_outer <span class="ot">&lt;-</span> data[train_indices_outer, ]</span>
<span id="cb131-27"><a href="#cb131-27" aria-hidden="true" tabindex="-1"></a>  datos_test_outer <span class="ot">&lt;-</span> data[test_indices_outer, ]</span>
<span id="cb131-28"><a href="#cb131-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb131-29"><a href="#cb131-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-30"><a href="#cb131-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Configurar la validación cruzada interna</span></span>
<span id="cb131-31"><a href="#cb131-31" aria-hidden="true" tabindex="-1"></a>  folds_inner <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(datos_entrenamiento_outer<span class="sc">$</span>ESTADO_ACTUAL, <span class="at">k =</span> k_inner, <span class="at">list =</span> <span class="cn">FALSE</span>)  <span class="co"># Obtener índices de pliegues internos</span></span>
<span id="cb131-32"><a href="#cb131-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb131-33"><a href="#cb131-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Almacenar predicciones y test para formar una curva ROC general</span></span>
<span id="cb131-34"><a href="#cb131-34" aria-hidden="true" tabindex="-1"></a>  predicciones_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(datos_entrenamiento_outer))</span>
<span id="cb131-35"><a href="#cb131-35" aria-hidden="true" tabindex="-1"></a>  targets_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(datos_entrenamiento_outer))</span>
<span id="cb131-36"><a href="#cb131-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb131-37"><a href="#cb131-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Iterar sobre cada pliegue interno para selección de modelo</span></span>
<span id="cb131-38"><a href="#cb131-38" aria-hidden="true" tabindex="-1"></a>  indices_inner <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(datos_entrenamiento_outer)</span>
<span id="cb131-39"><a href="#cb131-39" aria-hidden="true" tabindex="-1"></a>  resultados_auc_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb131-40"><a href="#cb131-40" aria-hidden="true" tabindex="-1"></a>  resultados_sensibilidad_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb131-41"><a href="#cb131-41" aria-hidden="true" tabindex="-1"></a>  resultados_accuracy_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb131-42"><a href="#cb131-42" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i_inner <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k_inner) {</span>
<span id="cb131-43"><a href="#cb131-43" aria-hidden="true" tabindex="-1"></a>    <span class="do">###############################</span></span>
<span id="cb131-44"><a href="#cb131-44" aria-hidden="true" tabindex="-1"></a>    <span class="do">#### Aquí el filtrado #########</span></span>
<span id="cb131-45"><a href="#cb131-45" aria-hidden="true" tabindex="-1"></a>    <span class="do">###############################</span></span>
<span id="cb131-46"><a href="#cb131-46" aria-hidden="true" tabindex="-1"></a>    filter_data <span class="ot">&lt;-</span> <span class="fu">filter_dependency</span>(datos_entrenamiento_outer, <span class="st">"ESTADO_ACTUAL"</span>, <span class="fu">colnames</span>(datos_entrenamiento_outer), <span class="fl">0.05</span>)</span>
<span id="cb131-47"><a href="#cb131-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="st">"ESTADO_ACTUAL.1"</span> <span class="sc">%in%</span> <span class="fu">colnames</span>(filter_data)) {</span>
<span id="cb131-48"><a href="#cb131-48" aria-hidden="true" tabindex="-1"></a>      filter_data <span class="ot">&lt;-</span> filter_data[, <span class="sc">!</span><span class="fu">colnames</span>(filter_data) <span class="sc">%in%</span> <span class="st">"ESTADO_ACTUAL.1"</span>, drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb131-49"><a href="#cb131-49" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb131-50"><a href="#cb131-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb131-51"><a href="#cb131-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Obtener los índices para el pliegue interno actual</span></span>
<span id="cb131-52"><a href="#cb131-52" aria-hidden="true" tabindex="-1"></a>    test_indices_inner <span class="ot">&lt;-</span> indices_inner[folds_inner <span class="sc">==</span> i_inner]  <span class="co"># Índices correspondientes al pliegue interno de test</span></span>
<span id="cb131-53"><a href="#cb131-53" aria-hidden="true" tabindex="-1"></a>    train_indices_inner <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(datos_entrenamiento_outer), test_indices_inner)  <span class="co"># Índices correspondientes al conjunto de entrenamiento interno</span></span>
<span id="cb131-54"><a href="#cb131-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb131-55"><a href="#cb131-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Dividir datos en entrenamiento y test para el pliegue interno</span></span>
<span id="cb131-56"><a href="#cb131-56" aria-hidden="true" tabindex="-1"></a>    datos_entrenamiento_inner <span class="ot">&lt;-</span> datos_entrenamiento_outer[train_indices_inner, ]</span>
<span id="cb131-57"><a href="#cb131-57" aria-hidden="true" tabindex="-1"></a>    datos_validacion <span class="ot">&lt;-</span> datos_entrenamiento_outer[test_indices_inner, ]</span>
<span id="cb131-58"><a href="#cb131-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb131-59"><a href="#cb131-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aplicar oversampling en el conjunto de entrenamiento interno</span></span>
<span id="cb131-60"><a href="#cb131-60" aria-hidden="true" tabindex="-1"></a>    datos_entrenamiento_oversampled <span class="ot">&lt;-</span> <span class="fu">ROSE</span>(ESTADO_ACTUAL <span class="sc">~</span> .,</span>
<span id="cb131-61"><a href="#cb131-61" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">data =</span> datos_entrenamiento_inner,</span>
<span id="cb131-62"><a href="#cb131-62" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">p =</span> <span class="fl">0.28</span>)<span class="sc">$</span>data</span>
<span id="cb131-63"><a href="#cb131-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb131-64"><a href="#cb131-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Inicializar variables para almacenar los resultados</span></span>
<span id="cb131-65"><a href="#cb131-65" aria-hidden="true" tabindex="-1"></a>    mejor_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb131-66"><a href="#cb131-66" aria-hidden="true" tabindex="-1"></a>    mejor_k <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb131-67"><a href="#cb131-67" aria-hidden="true" tabindex="-1"></a>    mejor_l <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb131-68"><a href="#cb131-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb131-69"><a href="#cb131-69" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Codificación One-Hot Encoding para variables categóricas</span></span>
<span id="cb131-70"><a href="#cb131-70" aria-hidden="true" tabindex="-1"></a>    encoded_data_entrenamiento <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">model.matrix</span>(<span class="sc">~</span>.<span class="sc">-</span><span class="dv">1</span>, datos_entrenamiento_oversampled[, <span class="sc">-</span><span class="fu">which</span>(<span class="fu">names</span>(datos_entrenamiento_oversampled) <span class="sc">==</span> <span class="st">"ESTADO_ACTUAL"</span>)]))</span>
<span id="cb131-71"><a href="#cb131-71" aria-hidden="true" tabindex="-1"></a>    encoded_data_validacion <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">model.matrix</span>(<span class="sc">~</span>.<span class="sc">-</span><span class="dv">1</span>, datos_validacion[, <span class="sc">-</span><span class="fu">which</span>(<span class="fu">names</span>(datos_validacion) <span class="sc">==</span> <span class="st">"ESTADO_ACTUAL"</span>)]))</span>
<span id="cb131-72"><a href="#cb131-72" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb131-73"><a href="#cb131-73" aria-hidden="true" tabindex="-1"></a>    param_grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">k =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">20</span>, <span class="at">by =</span> <span class="dv">1</span>),</span>
<span id="cb131-74"><a href="#cb131-74" aria-hidden="true" tabindex="-1"></a>                               <span class="at">l =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">10</span>, <span class="at">by =</span> <span class="dv">1</span>))</span>
<span id="cb131-75"><a href="#cb131-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-76"><a href="#cb131-76" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Iterar sobre las combinaciones de hiperparámetros</span></span>
<span id="cb131-77"><a href="#cb131-77" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(param_grid)) {</span>
<span id="cb131-78"><a href="#cb131-78" aria-hidden="true" tabindex="-1"></a>      k <span class="ot">&lt;-</span> param_grid<span class="sc">$</span>k[i]</span>
<span id="cb131-79"><a href="#cb131-79" aria-hidden="true" tabindex="-1"></a>      l <span class="ot">&lt;-</span> param_grid<span class="sc">$</span>l[i]</span>
<span id="cb131-80"><a href="#cb131-80" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb131-81"><a href="#cb131-81" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Realizar predicciones en datos de validación</span></span>
<span id="cb131-82"><a href="#cb131-82" aria-hidden="true" tabindex="-1"></a>      predicciones_validacion <span class="ot">&lt;-</span> <span class="fu">knn</span>(<span class="at">train =</span> encoded_data_entrenamiento, </span>
<span id="cb131-83"><a href="#cb131-83" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">test =</span> encoded_data_validacion, </span>
<span id="cb131-84"><a href="#cb131-84" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">cl =</span> datos_entrenamiento_oversampled<span class="sc">$</span>ESTADO_ACTUAL, </span>
<span id="cb131-85"><a href="#cb131-85" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">k =</span> k, </span>
<span id="cb131-86"><a href="#cb131-86" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">use.all =</span> <span class="cn">TRUE</span>,</span>
<span id="cb131-87"><a href="#cb131-87" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">prob =</span> <span class="cn">TRUE</span>,</span>
<span id="cb131-88"><a href="#cb131-88" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">l =</span> l)</span>
<span id="cb131-89"><a href="#cb131-89" aria-hidden="true" tabindex="-1"></a>      predicciones_validacion <span class="ot">&lt;-</span> <span class="fu">attr</span>(predicciones_validacion, <span class="st">"prob"</span>)  <span class="co"># Asumiendo que "SI" es la clase positiva</span></span>
<span id="cb131-90"><a href="#cb131-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-91"><a href="#cb131-91" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Calcular AUC para la combinación actual</span></span>
<span id="cb131-92"><a href="#cb131-92" aria-hidden="true" tabindex="-1"></a>      roc_obj <span class="ot">&lt;-</span> <span class="fu">roc</span>(<span class="fu">ifelse</span>(datos_validacion<span class="sc">$</span>ESTADO_ACTUAL <span class="sc">==</span> <span class="st">"SI"</span>, <span class="dv">1</span>, <span class="dv">0</span>), predicciones_validacion)</span>
<span id="cb131-93"><a href="#cb131-93" aria-hidden="true" tabindex="-1"></a>      auc_actual <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">auc</span>(roc_obj))  <span class="co"># Extraer el valor numérico del AUC</span></span>
<span id="cb131-94"><a href="#cb131-94" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb131-95"><a href="#cb131-95" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Actualizar el mejor modelo y su rendimiento si se encuentra un modelo mejor</span></span>
<span id="cb131-96"><a href="#cb131-96" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (auc_actual <span class="sc">&gt;</span> mejor_auc) {</span>
<span id="cb131-97"><a href="#cb131-97" aria-hidden="true" tabindex="-1"></a>        mejor_auc <span class="ot">&lt;-</span> auc_actual</span>
<span id="cb131-98"><a href="#cb131-98" aria-hidden="true" tabindex="-1"></a>        mejor_k <span class="ot">&lt;-</span> k</span>
<span id="cb131-99"><a href="#cb131-99" aria-hidden="true" tabindex="-1"></a>        mejor_l <span class="ot">&lt;-</span> l</span>
<span id="cb131-100"><a href="#cb131-100" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb131-101"><a href="#cb131-101" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb131-102"><a href="#cb131-102" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb131-103"><a href="#cb131-103" aria-hidden="true" tabindex="-1"></a>    <span class="do">########################</span></span>
<span id="cb131-104"><a href="#cb131-104" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb131-105"><a href="#cb131-105" aria-hidden="true" tabindex="-1"></a>    encoded_data_test <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">model.matrix</span>(<span class="sc">~</span>.<span class="sc">-</span><span class="dv">1</span>, datos_test_outer[, <span class="sc">-</span><span class="fu">which</span>(<span class="fu">names</span>(datos_test_outer) <span class="sc">==</span> <span class="st">"ESTADO_ACTUAL"</span>)]))</span>
<span id="cb131-106"><a href="#cb131-106" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Realizar predicciones en datos de test</span></span>
<span id="cb131-107"><a href="#cb131-107" aria-hidden="true" tabindex="-1"></a>    predicciones_test <span class="ot">&lt;-</span> <span class="fu">knn</span>(<span class="at">train =</span> encoded_data_entrenamiento, </span>
<span id="cb131-108"><a href="#cb131-108" aria-hidden="true" tabindex="-1"></a>                             <span class="at">test =</span> encoded_data_test, </span>
<span id="cb131-109"><a href="#cb131-109" aria-hidden="true" tabindex="-1"></a>                             <span class="at">cl =</span> datos_entrenamiento_oversampled<span class="sc">$</span>ESTADO_ACTUAL, </span>
<span id="cb131-110"><a href="#cb131-110" aria-hidden="true" tabindex="-1"></a>                             <span class="at">k =</span> mejor_k, </span>
<span id="cb131-111"><a href="#cb131-111" aria-hidden="true" tabindex="-1"></a>                             <span class="at">use.all =</span> <span class="cn">TRUE</span>,</span>
<span id="cb131-112"><a href="#cb131-112" aria-hidden="true" tabindex="-1"></a>                             <span class="at">prob =</span> <span class="cn">TRUE</span>,</span>
<span id="cb131-113"><a href="#cb131-113" aria-hidden="true" tabindex="-1"></a>                             <span class="at">l =</span> mejor_l)</span>
<span id="cb131-114"><a href="#cb131-114" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb131-115"><a href="#cb131-115" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb131-116"><a href="#cb131-116" aria-hidden="true" tabindex="-1"></a>    predicciones_test <span class="ot">&lt;-</span> <span class="fu">attr</span>(predicciones_test, <span class="st">"prob"</span>)  <span class="co"># Asumiendo que "SI" es la clase positiva</span></span>
<span id="cb131-117"><a href="#cb131-117" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb131-118"><a href="#cb131-118" aria-hidden="true" tabindex="-1"></a>    clases_predichas_test <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predicciones_test <span class="sc">&gt;=</span> <span class="fl">0.5</span>, <span class="st">"SI"</span>, <span class="st">"NO"</span>)</span>
<span id="cb131-119"><a href="#cb131-119" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb131-120"><a href="#cb131-120" aria-hidden="true" tabindex="-1"></a>    <span class="do">###########################</span></span>
<span id="cb131-121"><a href="#cb131-121" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Realizar predicciones en el conjunto de entrenamiento externo para el AUC general</span></span>
<span id="cb131-122"><a href="#cb131-122" aria-hidden="true" tabindex="-1"></a>    predicciones_auc[test_indices_inner] <span class="ot">&lt;-</span> predicciones_test</span>
<span id="cb131-123"><a href="#cb131-123" aria-hidden="true" tabindex="-1"></a>    predicciones_clasificadas <span class="ot">&lt;-</span> clases_predichas_test</span>
<span id="cb131-124"><a href="#cb131-124" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb131-125"><a href="#cb131-125" aria-hidden="true" tabindex="-1"></a>    resultados_sensibilidad_inner[i_inner] <span class="ot">&lt;-</span> <span class="fu">sum</span>(clases_predichas_test <span class="sc">==</span> <span class="st">"SI"</span> <span class="sc">&amp;</span> datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]] <span class="sc">==</span> <span class="st">"SI"</span>) <span class="sc">/</span> <span class="fu">sum</span>(datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]] <span class="sc">==</span> <span class="st">"SI"</span>)</span>
<span id="cb131-126"><a href="#cb131-126" aria-hidden="true" tabindex="-1"></a>    resultados_accuracy_inner[i_inner] <span class="ot">&lt;-</span> <span class="fu">mean</span>(clases_predichas_test <span class="sc">==</span> datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]])</span>
<span id="cb131-127"><a href="#cb131-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-128"><a href="#cb131-128" aria-hidden="true" tabindex="-1"></a>    targets_auc[test_indices_inner] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(datos_validacion<span class="sc">$</span>ESTADO_ACTUAL) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb131-129"><a href="#cb131-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-130"><a href="#cb131-130" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb131-131"><a href="#cb131-131" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb131-132"><a href="#cb131-132" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular el AUC final para este fold externo</span></span>
<span id="cb131-133"><a href="#cb131-133" aria-hidden="true" tabindex="-1"></a>  auc_fold_externo <span class="ot">&lt;-</span> pROC<span class="sc">::</span><span class="fu">roc</span>(targets_auc, predicciones_auc)<span class="sc">$</span>auc</span>
<span id="cb131-134"><a href="#cb131-134" aria-hidden="true" tabindex="-1"></a>  accuracy_fold_externo <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_accuracy_inner)</span>
<span id="cb131-135"><a href="#cb131-135" aria-hidden="true" tabindex="-1"></a>  sensibilidad_fold_externo <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_sensibilidad_inner)</span>
<span id="cb131-136"><a href="#cb131-136" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb131-137"><a href="#cb131-137" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb131-138"><a href="#cb131-138" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Almacenar el AUC del fold externo actual</span></span>
<span id="cb131-139"><a href="#cb131-139" aria-hidden="true" tabindex="-1"></a>  resultados_auc[i_outer] <span class="ot">&lt;-</span> auc_fold_externo</span>
<span id="cb131-140"><a href="#cb131-140" aria-hidden="true" tabindex="-1"></a>  resultados_accuracy[i_outer] <span class="ot">&lt;-</span> accuracy_fold_externo</span>
<span id="cb131-141"><a href="#cb131-141" aria-hidden="true" tabindex="-1"></a>  resultados_sensibilidad[i_outer] <span class="ot">&lt;-</span> sensibilidad_fold_externo</span>
<span id="cb131-142"><a href="#cb131-142" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb131-143"><a href="#cb131-143" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Predecir en los datos de test para este pliegue externo y almacenar predicciones</span></span>
<span id="cb131-144"><a href="#cb131-144" aria-hidden="true" tabindex="-1"></a>  predicciones_test <span class="ot">&lt;-</span> <span class="fu">knn</span>(<span class="at">train =</span> encoded_data_entrenamiento, </span>
<span id="cb131-145"><a href="#cb131-145" aria-hidden="true" tabindex="-1"></a>                           <span class="at">test =</span> encoded_data_test, </span>
<span id="cb131-146"><a href="#cb131-146" aria-hidden="true" tabindex="-1"></a>                           <span class="at">cl =</span> datos_entrenamiento_oversampled<span class="sc">$</span>ESTADO_ACTUAL, </span>
<span id="cb131-147"><a href="#cb131-147" aria-hidden="true" tabindex="-1"></a>                           <span class="at">k =</span> mejor_k, </span>
<span id="cb131-148"><a href="#cb131-148" aria-hidden="true" tabindex="-1"></a>                           <span class="at">use.all =</span> <span class="cn">TRUE</span>,</span>
<span id="cb131-149"><a href="#cb131-149" aria-hidden="true" tabindex="-1"></a>                           <span class="at">prob =</span> <span class="cn">TRUE</span>,</span>
<span id="cb131-150"><a href="#cb131-150" aria-hidden="true" tabindex="-1"></a>                           <span class="at">l =</span> mejor_l)</span>
<span id="cb131-151"><a href="#cb131-151" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb131-152"><a href="#cb131-152" aria-hidden="true" tabindex="-1"></a>  predicciones_test <span class="ot">&lt;-</span> <span class="fu">attr</span>(predicciones_test, <span class="st">"prob"</span>)  <span class="co"># Asumiendo que "SI" es la clase positiva</span></span>
<span id="cb131-153"><a href="#cb131-153" aria-hidden="true" tabindex="-1"></a>  clases_predichas_test <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predicciones_test <span class="sc">&gt;=</span> <span class="fl">0.5</span>, <span class="st">"SI"</span>, <span class="st">"NO"</span>)</span>
<span id="cb131-154"><a href="#cb131-154" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb131-155"><a href="#cb131-155" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Almacenar predicciones de este fold externo</span></span>
<span id="cb131-156"><a href="#cb131-156" aria-hidden="true" tabindex="-1"></a>  predicciones_totales[test_indices_outer, i_outer] <span class="ot">&lt;-</span> predicciones_test</span>
<span id="cb131-157"><a href="#cb131-157" aria-hidden="true" tabindex="-1"></a>  targets_totales[test_indices_outer] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(datos_test_outer<span class="sc">$</span>ESTADO_ACTUAL) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb131-158"><a href="#cb131-158" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb131-159"><a href="#cb131-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-160"><a href="#cb131-160" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular AUC promedio</span></span>
<span id="cb131-161"><a href="#cb131-161" aria-hidden="true" tabindex="-1"></a>auc_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_auc)</span>
<span id="cb131-162"><a href="#cb131-162" aria-hidden="true" tabindex="-1"></a>accuracy_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_accuracy)</span>
<span id="cb131-163"><a href="#cb131-163" aria-hidden="true" tabindex="-1"></a>sensibilidad_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_sensibilidad)</span>
<span id="cb131-164"><a href="#cb131-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-165"><a href="#cb131-165" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear tabla con todas las métricas</span></span>
<span id="cb131-166"><a href="#cb131-166" aria-hidden="true" tabindex="-1"></a>tabla_metricas <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb131-167"><a href="#cb131-167" aria-hidden="true" tabindex="-1"></a>  <span class="at">Pliegue =</span> <span class="dv">1</span><span class="sc">:</span>k_outer,</span>
<span id="cb131-168"><a href="#cb131-168" aria-hidden="true" tabindex="-1"></a>  <span class="at">AUC =</span> <span class="fu">sapply</span>(resultados_auc, round, <span class="at">digits =</span> <span class="dv">3</span>),</span>
<span id="cb131-169"><a href="#cb131-169" aria-hidden="true" tabindex="-1"></a>  <span class="at">Accuracy =</span> <span class="fu">sapply</span>(resultados_accuracy, round, <span class="at">digits =</span> <span class="dv">3</span>),</span>
<span id="cb131-170"><a href="#cb131-170" aria-hidden="true" tabindex="-1"></a>  <span class="at">Recall =</span> <span class="fu">sapply</span>(resultados_sensibilidad, round, <span class="at">digits =</span> <span class="dv">3</span>)</span>
<span id="cb131-171"><a href="#cb131-171" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb131-172"><a href="#cb131-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-173"><a href="#cb131-173" aria-hidden="true" tabindex="-1"></a><span class="co"># Agregar fila con promedio de métricas</span></span>
<span id="cb131-174"><a href="#cb131-174" aria-hidden="true" tabindex="-1"></a>tabla_metricas_knn <span class="ot">&lt;-</span> <span class="fu">rbind</span>(tabla_metricas, <span class="fu">c</span>(<span class="st">"Mean"</span>, <span class="fu">round</span>(auc_promedio, <span class="dv">3</span>), <span class="fu">round</span>(accuracy_promedio, <span class="dv">3</span>), <span class="fu">round</span>(sensibilidad_promedio, <span class="dv">3</span>)))</span>
<span id="cb131-175"><a href="#cb131-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-176"><a href="#cb131-176" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb131-177"><a href="#cb131-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-178"><a href="#cb131-178" aria-hidden="true" tabindex="-1"></a>execution_time_knn <span class="ot">&lt;-</span> end_time <span class="sc">-</span> start_time</span>
<span id="cb131-179"><a href="#cb131-179" aria-hidden="true" tabindex="-1"></a>execution_time_knn <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(execution_time_knn, <span class="at">units =</span> <span class="st">"secs"</span>)</span>
<span id="cb131-180"><a href="#cb131-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-181"><a href="#cb131-181" aria-hidden="true" tabindex="-1"></a><span class="co"># Guardar resultados</span></span>
<span id="cb131-182"><a href="#cb131-182" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(tabla_metricas_knn, <span class="at">file =</span> <span class="st">"tabla_metricas_knn.RData"</span>)</span>
<span id="cb131-183"><a href="#cb131-183" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(execution_time_knn, <span class="at">file =</span> <span class="st">"execution_time_knn.RData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"tabla_metricas_knn.RData"</span>)</span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"execution_time_knn.RData"</span>)</span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir el tiempo de ejecución</span></span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time_knn,  <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-30-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-30-1" role="tab" aria-controls="tabset-30-1" aria-selected="true" href="">Metrics Table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-30-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-30-2" role="tab" aria-controls="tabset-30-2" aria-selected="false" href="">Metrics Plot</a></li></ul>
<div class="tab-content">
<div id="tabset-30-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-30-1-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir tabla formateada con kableExtra</span></span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(tabla_metricas_knn, <span class="at">caption =</span> <span class="st">"Cross Validation Metrics"</span>, <span class="at">align =</span> <span class="st">"c"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="tabset-30-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-30-2-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="fu">crear_plot_metricas_per_fold</span>(tabla_metricas_knn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
<p>The model does not have a good performance, in fact, it only predicts True Methastasis.</p>
</div>
</div>
</div>
</div>
<div id="tabset-35-8" class="tab-pane" role="tabpanel" aria-labelledby="tabset-35-8-tab">
<div class="tabset-margin-container"></div><div class="panel-tabset" style="background-color: #f0f0f0;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-34-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-34-1" role="tab" aria-controls="tabset-34-1" aria-selected="true" href="">Hold out</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-34-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-34-2" role="tab" aria-controls="tabset-34-2" aria-selected="false" href="">5x2 Cross Validation Filter</a></li></ul>
<div class="tab-content" style="background-color: #f0f0f0;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;">
<div id="tabset-34-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-34-1-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Parámetros a cambiar</span></span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a>proportion <span class="ot">&lt;-</span> <span class="fl">0.28</span></span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a>sensitivity_weight <span class="ot">&lt;-</span> <span class="fl">0.8</span></span>
<span id="cb135-5"><a href="#cb135-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-6"><a href="#cb135-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Dividir el conjunto de datos en entrenamiento y test</span></span>
<span id="cb135-7"><a href="#cb135-7" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)  <span class="co"># Establecer una semilla para reproducibilidad</span></span>
<span id="cb135-8"><a href="#cb135-8" aria-hidden="true" tabindex="-1"></a>indices_entrenamiento <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(data), <span class="fl">0.75</span> <span class="sc">*</span> <span class="fu">nrow</span>(data))  <span class="co"># 75% para entrenamiento</span></span>
<span id="cb135-9"><a href="#cb135-9" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento <span class="ot">&lt;-</span> data[indices_entrenamiento, ]</span>
<span id="cb135-10"><a href="#cb135-10" aria-hidden="true" tabindex="-1"></a>datos_test <span class="ot">&lt;-</span> data[<span class="sc">-</span>indices_entrenamiento, ]</span>
<span id="cb135-11"><a href="#cb135-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-12"><a href="#cb135-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Dividir datos de entrenamiento en entrenamiento y validación</span></span>
<span id="cb135-13"><a href="#cb135-13" aria-hidden="true" tabindex="-1"></a>train_indices <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(datos_entrenamiento), <span class="fl">0.8</span> <span class="sc">*</span> <span class="fu">nrow</span>(datos_entrenamiento))  <span class="co"># 80% para entrenamiento</span></span>
<span id="cb135-14"><a href="#cb135-14" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento_split <span class="ot">&lt;-</span> datos_entrenamiento[train_indices, ]</span>
<span id="cb135-15"><a href="#cb135-15" aria-hidden="true" tabindex="-1"></a>datos_validacion <span class="ot">&lt;-</span> datos_entrenamiento[<span class="sc">-</span>train_indices, ]</span>
<span id="cb135-16"><a href="#cb135-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-17"><a href="#cb135-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Realizar sobremuestreo en los datos de entrenamiento</span></span>
<span id="cb135-18"><a href="#cb135-18" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento_oversampled <span class="ot">&lt;-</span> <span class="fu">ROSE</span>(ESTADO_ACTUAL <span class="sc">~</span> ., <span class="at">data =</span> datos_entrenamiento_split, <span class="at">seed =</span> <span class="dv">123</span>, <span class="at">p =</span> proportion)<span class="sc">$</span>data</span>
<span id="cb135-19"><a href="#cb135-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-20"><a href="#cb135-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Definir la función para calcular el métrico personalizado</span></span>
<span id="cb135-21"><a href="#cb135-21" aria-hidden="true" tabindex="-1"></a>compute_custom_metric <span class="ot">&lt;-</span> <span class="cf">function</span>(recall, accuracy, <span class="at">sensitivity_weight =</span> <span class="dv">1</span>) {</span>
<span id="cb135-22"><a href="#cb135-22" aria-hidden="true" tabindex="-1"></a>  custom_metric <span class="ot">&lt;-</span> (sensitivity_weight <span class="sc">*</span> recall) <span class="sc">+</span> ((<span class="dv">1</span> <span class="sc">-</span> sensitivity_weight) <span class="sc">*</span> accuracy)</span>
<span id="cb135-23"><a href="#cb135-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(custom_metric)</span>
<span id="cb135-24"><a href="#cb135-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb135-25"><a href="#cb135-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-26"><a href="#cb135-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Inicializar variables para almacenar los resultados</span></span>
<span id="cb135-27"><a href="#cb135-27" aria-hidden="true" tabindex="-1"></a>mejor_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb135-28"><a href="#cb135-28" aria-hidden="true" tabindex="-1"></a>mejor_modelo <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb135-29"><a href="#cb135-29" aria-hidden="true" tabindex="-1"></a>mejores_iteraciones <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb135-30"><a href="#cb135-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-31"><a href="#cb135-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Bucle para probar diferentes combinaciones de hiperparámetros</span></span>
<span id="cb135-32"><a href="#cb135-32" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (iteraciones <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">50</span>, <span class="dv">500</span>, <span class="dv">50</span>)) {</span>
<span id="cb135-33"><a href="#cb135-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Entrenar el modelo glmboost</span></span>
<span id="cb135-34"><a href="#cb135-34" aria-hidden="true" tabindex="-1"></a>  modelo <span class="ot">&lt;-</span> <span class="fu">glmboost</span>(ESTADO_ACTUAL <span class="sc">~</span> ., <span class="at">data =</span> datos_entrenamiento_oversampled, <span class="at">family =</span> <span class="fu">Binomial</span>(), <span class="at">control =</span> <span class="fu">boost_control</span>(<span class="at">mstop =</span> iteraciones))</span>
<span id="cb135-35"><a href="#cb135-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb135-36"><a href="#cb135-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Realizar predicciones en datos de validación</span></span>
<span id="cb135-37"><a href="#cb135-37" aria-hidden="true" tabindex="-1"></a>  predicciones_validacion <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelo, <span class="at">newdata =</span> datos_validacion, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb135-38"><a href="#cb135-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb135-39"><a href="#cb135-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular el AUC</span></span>
<span id="cb135-40"><a href="#cb135-40" aria-hidden="true" tabindex="-1"></a>  pred <span class="ot">&lt;-</span> <span class="fu">prediction</span>(predicciones_validacion, datos_validacion<span class="sc">$</span>ESTADO_ACTUAL)</span>
<span id="cb135-41"><a href="#cb135-41" aria-hidden="true" tabindex="-1"></a>  perf <span class="ot">&lt;-</span> <span class="fu">performance</span>(pred, <span class="at">measure =</span> <span class="st">"auc"</span>)</span>
<span id="cb135-42"><a href="#cb135-42" aria-hidden="true" tabindex="-1"></a>  auc_actual <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(perf<span class="sc">@</span>y.values)</span>
<span id="cb135-43"><a href="#cb135-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb135-44"><a href="#cb135-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Actualizar el mejor modelo y su rendimiento si se encuentra un modelo mejor</span></span>
<span id="cb135-45"><a href="#cb135-45" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (auc_actual <span class="sc">&gt;</span> mejor_auc) {</span>
<span id="cb135-46"><a href="#cb135-46" aria-hidden="true" tabindex="-1"></a>    mejor_auc <span class="ot">&lt;-</span> auc_actual</span>
<span id="cb135-47"><a href="#cb135-47" aria-hidden="true" tabindex="-1"></a>    mejor_modelo <span class="ot">&lt;-</span> modelo</span>
<span id="cb135-48"><a href="#cb135-48" aria-hidden="true" tabindex="-1"></a>    mejores_iteraciones <span class="ot">&lt;-</span> iteraciones</span>
<span id="cb135-49"><a href="#cb135-49" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb135-50"><a href="#cb135-50" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb135-51"><a href="#cb135-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-52"><a href="#cb135-52" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mejor_modelo)</span>
<span id="cb135-53"><a href="#cb135-53" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb135-54"><a href="#cb135-54" aria-hidden="true" tabindex="-1"></a>execution_time <span class="ot">&lt;-</span> end_time <span class="sc">-</span> start_time</span>
<span id="cb135-55"><a href="#cb135-55" aria-hidden="true" tabindex="-1"></a>execution_time <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(execution_time, <span class="at">units =</span> <span class="st">"secs"</span>)</span>
<span id="cb135-56"><a href="#cb135-56" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time,  <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-32-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-32-1" role="tab" aria-controls="tabset-32-1" aria-selected="true" href="">Predictions</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-32-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-32-2" role="tab" aria-controls="tabset-32-2" aria-selected="false" href="">Roc curve and auc</a></li></ul>
<div class="tab-content">
<div id="tabset-32-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-32-1-tab">
<p>We are going to predict on test in order to get a estimation of the performance of the model.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluar el mejor modelo en el conjunto de prueba</span></span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>predicciones_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(mejor_modelo, <span class="at">newdata =</span> datos_test, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a>clases_predichas_test <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predicciones_test <span class="sc">&gt;</span> <span class="fl">0.5</span>, <span class="st">"SI"</span>, <span class="st">"NO"</span>)</span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a><span class="fu">mostrar_metricas</span>(datos_test<span class="sc">$</span>ESTADO_ACTUAL,clases_predichas_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="tabset-32-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-32-2-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_roc_curve</span>(predicciones_test,datos_test<span class="sc">$</span>ESTADO_ACTUAL)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
<p>The performance of the model is encouraging. The model has a good performance in the test set.</p>
</div>
<div id="tabset-34-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-34-2-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Configurar la validación cruzada 5x2</span></span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a>k_outer <span class="ot">&lt;-</span> <span class="dv">5</span>  <span class="co"># Número de pliegues externos</span></span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a>k_inner <span class="ot">&lt;-</span> <span class="dv">2</span>  <span class="co"># Número de pliegues internos</span></span>
<span id="cb138-6"><a href="#cb138-6" aria-hidden="true" tabindex="-1"></a>folds_outer <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(data<span class="sc">$</span>ESTADO_ACTUAL, <span class="at">k =</span> k_outer, <span class="at">list =</span> <span class="cn">FALSE</span>)  <span class="co"># Obtener índices de pliegues externos</span></span>
<span id="cb138-7"><a href="#cb138-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-8"><a href="#cb138-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Lista para almacenar resultados</span></span>
<span id="cb138-9"><a href="#cb138-9" aria-hidden="true" tabindex="-1"></a>resultados_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb138-10"><a href="#cb138-10" aria-hidden="true" tabindex="-1"></a>resultados_sensibilidad <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb138-11"><a href="#cb138-11" aria-hidden="true" tabindex="-1"></a>resultados_accuracy <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb138-12"><a href="#cb138-12" aria-hidden="true" tabindex="-1"></a>indices <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data)</span>
<span id="cb138-13"><a href="#cb138-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-14"><a href="#cb138-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Inicializar matrices para almacenar predicciones y objetivos</span></span>
<span id="cb138-15"><a href="#cb138-15" aria-hidden="true" tabindex="-1"></a>predicciones_totales <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">nrow</span>(data), <span class="at">ncol =</span> k_outer)</span>
<span id="cb138-16"><a href="#cb138-16" aria-hidden="true" tabindex="-1"></a>targets_totales <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(data))</span>
<span id="cb138-17"><a href="#cb138-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-18"><a href="#cb138-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterar sobre cada pliegue externo y realizar el proceso de modelado</span></span>
<span id="cb138-19"><a href="#cb138-19" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i_outer <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k_outer) {</span>
<span id="cb138-20"><a href="#cb138-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-21"><a href="#cb138-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Obtener los índices para el pliegue externo actual</span></span>
<span id="cb138-22"><a href="#cb138-22" aria-hidden="true" tabindex="-1"></a>  test_indices_outer <span class="ot">&lt;-</span> indices[folds_outer<span class="sc">==</span>i_outer]  <span class="co"># Índices correspondientes al pliegue externo de test</span></span>
<span id="cb138-23"><a href="#cb138-23" aria-hidden="true" tabindex="-1"></a>  train_indices_outer <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data), test_indices_outer)  <span class="co"># Índices correspondientes al conjunto de entrenamiento</span></span>
<span id="cb138-24"><a href="#cb138-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb138-25"><a href="#cb138-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Dividir datos en entrenamiento y test para el pliegue externo</span></span>
<span id="cb138-26"><a href="#cb138-26" aria-hidden="true" tabindex="-1"></a>  datos_entrenamiento_outer <span class="ot">&lt;-</span> data[train_indices_outer, ]</span>
<span id="cb138-27"><a href="#cb138-27" aria-hidden="true" tabindex="-1"></a>  datos_test_outer <span class="ot">&lt;-</span> data[test_indices_outer, ]</span>
<span id="cb138-28"><a href="#cb138-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb138-29"><a href="#cb138-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-30"><a href="#cb138-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Configurar la validación cruzada interna</span></span>
<span id="cb138-31"><a href="#cb138-31" aria-hidden="true" tabindex="-1"></a>  folds_inner <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(datos_entrenamiento_outer<span class="sc">$</span>ESTADO_ACTUAL, <span class="at">k =</span> k_inner, <span class="at">list =</span> <span class="cn">FALSE</span>)  <span class="co"># Obtener índices de pliegues internos</span></span>
<span id="cb138-32"><a href="#cb138-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb138-33"><a href="#cb138-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Almacenar predicciones y test para formar una curva ROC general</span></span>
<span id="cb138-34"><a href="#cb138-34" aria-hidden="true" tabindex="-1"></a>  predicciones_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(datos_entrenamiento_outer))</span>
<span id="cb138-35"><a href="#cb138-35" aria-hidden="true" tabindex="-1"></a>  targets_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(datos_entrenamiento_outer))</span>
<span id="cb138-36"><a href="#cb138-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb138-37"><a href="#cb138-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Iterar sobre cada pliegue interno para selección de modelo</span></span>
<span id="cb138-38"><a href="#cb138-38" aria-hidden="true" tabindex="-1"></a>  indices_inner <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(datos_entrenamiento_outer)</span>
<span id="cb138-39"><a href="#cb138-39" aria-hidden="true" tabindex="-1"></a>  resultados_auc_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb138-40"><a href="#cb138-40" aria-hidden="true" tabindex="-1"></a>  resultados_sensibilidad_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb138-41"><a href="#cb138-41" aria-hidden="true" tabindex="-1"></a>  resultados_accuracy_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb138-42"><a href="#cb138-42" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i_inner <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k_inner) {</span>
<span id="cb138-43"><a href="#cb138-43" aria-hidden="true" tabindex="-1"></a>    <span class="do">###############################</span></span>
<span id="cb138-44"><a href="#cb138-44" aria-hidden="true" tabindex="-1"></a>    <span class="do">#### Aqui el filtrado##########</span></span>
<span id="cb138-45"><a href="#cb138-45" aria-hidden="true" tabindex="-1"></a>    <span class="do">###############################</span></span>
<span id="cb138-46"><a href="#cb138-46" aria-hidden="true" tabindex="-1"></a>    filter_data <span class="ot">&lt;-</span> <span class="fu">filter_dependency</span>(datos_entrenamiento_outer,<span class="st">"ESTADO_ACTUAL"</span>,<span class="fu">colnames</span>(datos_entrenamiento_outer),<span class="fl">0.05</span>)</span>
<span id="cb138-47"><a href="#cb138-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="st">"ESTADO_ACTUAL.1"</span> <span class="sc">%in%</span> <span class="fu">colnames</span>(filter_data)) {</span>
<span id="cb138-48"><a href="#cb138-48" aria-hidden="true" tabindex="-1"></a>      filter_data <span class="ot">&lt;-</span> filter_data[, <span class="sc">!</span><span class="fu">colnames</span>(filter_data) <span class="sc">%in%</span> <span class="st">"ESTADO_ACTUAL.1"</span>, drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb138-49"><a href="#cb138-49" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb138-50"><a href="#cb138-50" aria-hidden="true" tabindex="-1"></a><span class="co">#con poca variables solo unaa la vez o filtrado o wrapper</span></span>
<span id="cb138-51"><a href="#cb138-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb138-52"><a href="#cb138-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb138-53"><a href="#cb138-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb138-54"><a href="#cb138-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Obtener los índices para el pliegue interno actual</span></span>
<span id="cb138-55"><a href="#cb138-55" aria-hidden="true" tabindex="-1"></a>    test_indices_inner <span class="ot">&lt;-</span> indices_inner[folds_inner<span class="sc">==</span>i_inner]  <span class="co"># Índices correspondientes al pliegue interno de test</span></span>
<span id="cb138-56"><a href="#cb138-56" aria-hidden="true" tabindex="-1"></a>    train_indices_inner <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(datos_entrenamiento_outer), test_indices_inner)  <span class="co"># Índices correspondientes al conjunto de entrenamiento interno</span></span>
<span id="cb138-57"><a href="#cb138-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb138-58"><a href="#cb138-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Dividir datos en entrenamiento y test para el pliegue interno</span></span>
<span id="cb138-59"><a href="#cb138-59" aria-hidden="true" tabindex="-1"></a>    datos_entrenamiento_inner <span class="ot">&lt;-</span> datos_entrenamiento_outer[train_indices_inner, ]</span>
<span id="cb138-60"><a href="#cb138-60" aria-hidden="true" tabindex="-1"></a>    datos_validacion <span class="ot">&lt;-</span> datos_entrenamiento_outer[test_indices_inner, ]</span>
<span id="cb138-61"><a href="#cb138-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb138-62"><a href="#cb138-62" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb138-63"><a href="#cb138-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aplicar oversampling en el conjunto de entrenamiento interno</span></span>
<span id="cb138-64"><a href="#cb138-64" aria-hidden="true" tabindex="-1"></a>    datos_entrenamiento_oversampled <span class="ot">&lt;-</span> <span class="fu">ROSE</span>(ESTADO_ACTUAL <span class="sc">~</span> .,</span>
<span id="cb138-65"><a href="#cb138-65" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">data =</span> datos_entrenamiento_inner,</span>
<span id="cb138-66"><a href="#cb138-66" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">p =</span> <span class="fl">0.28</span>)<span class="sc">$</span>data</span>
<span id="cb138-67"><a href="#cb138-67" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb138-68"><a href="#cb138-68" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Inicializar variables para almacenar los resultados</span></span>
<span id="cb138-69"><a href="#cb138-69" aria-hidden="true" tabindex="-1"></a>    mejor_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb138-70"><a href="#cb138-70" aria-hidden="true" tabindex="-1"></a>    mejor_modelo <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb138-71"><a href="#cb138-71" aria-hidden="true" tabindex="-1"></a>    mejores_iteraciones <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb138-72"><a href="#cb138-72" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb138-73"><a href="#cb138-73" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb138-74"><a href="#cb138-74" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Iterar sobre las combinaciones de hiperparámetros</span></span>
<span id="cb138-75"><a href="#cb138-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (iteraciones <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">50</span>, <span class="dv">500</span>, <span class="dv">50</span>)) {</span>
<span id="cb138-76"><a href="#cb138-76" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Entrenar el modelo glmboost</span></span>
<span id="cb138-77"><a href="#cb138-77" aria-hidden="true" tabindex="-1"></a>      modelo <span class="ot">&lt;-</span> <span class="fu">glmboost</span>(ESTADO_ACTUAL <span class="sc">~</span> ., <span class="at">data =</span> datos_entrenamiento_oversampled, <span class="at">family =</span> <span class="fu">Binomial</span>(), <span class="at">control =</span> <span class="fu">boost_control</span>(<span class="at">mstop =</span> iteraciones))</span>
<span id="cb138-78"><a href="#cb138-78" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb138-79"><a href="#cb138-79" aria-hidden="true" tabindex="-1"></a>      predicciones_validacion <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelo, <span class="at">newdata =</span> datos_validacion, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb138-80"><a href="#cb138-80" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb138-81"><a href="#cb138-81" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb138-82"><a href="#cb138-82" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Calcular el AUC</span></span>
<span id="cb138-83"><a href="#cb138-83" aria-hidden="true" tabindex="-1"></a>      pred <span class="ot">&lt;-</span> <span class="fu">prediction</span>(predicciones_validacion, datos_validacion<span class="sc">$</span>ESTADO_ACTUAL)</span>
<span id="cb138-84"><a href="#cb138-84" aria-hidden="true" tabindex="-1"></a>      perf <span class="ot">&lt;-</span> <span class="fu">performance</span>(pred, <span class="at">measure =</span> <span class="st">"auc"</span>)</span>
<span id="cb138-85"><a href="#cb138-85" aria-hidden="true" tabindex="-1"></a>      auc_actual <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(perf<span class="sc">@</span>y.values)</span>
<span id="cb138-86"><a href="#cb138-86" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb138-87"><a href="#cb138-87" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Actualizar el mejor modelo y su AUC si se encuentra un modelo mejor</span></span>
<span id="cb138-88"><a href="#cb138-88" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (auc_actual <span class="sc">&gt;</span> mejor_auc) {</span>
<span id="cb138-89"><a href="#cb138-89" aria-hidden="true" tabindex="-1"></a>          mejor_auc <span class="ot">&lt;-</span> auc_actual</span>
<span id="cb138-90"><a href="#cb138-90" aria-hidden="true" tabindex="-1"></a>          mejor_modelo <span class="ot">&lt;-</span> modelo</span>
<span id="cb138-91"><a href="#cb138-91" aria-hidden="true" tabindex="-1"></a>          mejores_iteraciones <span class="ot">&lt;-</span> iteraciones</span>
<span id="cb138-92"><a href="#cb138-92" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb138-93"><a href="#cb138-93" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb138-94"><a href="#cb138-94" aria-hidden="true" tabindex="-1"></a>    <span class="do">########################</span></span>
<span id="cb138-95"><a href="#cb138-95" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb138-96"><a href="#cb138-96" aria-hidden="true" tabindex="-1"></a>    predicciones_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(mejor_modelo, <span class="at">newdata =</span> datos_validacion, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb138-97"><a href="#cb138-97" aria-hidden="true" tabindex="-1"></a>    clases_predichas_test <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predicciones_test <span class="sc">&gt;=</span> <span class="fl">0.5</span>, <span class="st">"SI"</span>, <span class="st">"NO"</span>)</span>
<span id="cb138-98"><a href="#cb138-98" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb138-99"><a href="#cb138-99" aria-hidden="true" tabindex="-1"></a>    <span class="do">###########################</span></span>
<span id="cb138-100"><a href="#cb138-100" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Realizar predicciones en el conjunto de entrenamiento externo para el AUC general</span></span>
<span id="cb138-101"><a href="#cb138-101" aria-hidden="true" tabindex="-1"></a>    predicciones_auc[test_indices_inner] <span class="ot">&lt;-</span> predicciones_test</span>
<span id="cb138-102"><a href="#cb138-102" aria-hidden="true" tabindex="-1"></a>    predicciones_clasificadas <span class="ot">&lt;-</span> clases_predichas_test</span>
<span id="cb138-103"><a href="#cb138-103" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb138-104"><a href="#cb138-104" aria-hidden="true" tabindex="-1"></a>    resultados_sensibilidad_inner[i_inner] <span class="ot">&lt;-</span> <span class="fu">sum</span>(clases_predichas_test <span class="sc">==</span> <span class="st">"SI"</span> <span class="sc">&amp;</span> datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]] <span class="sc">==</span> <span class="st">"SI"</span>) <span class="sc">/</span> <span class="fu">sum</span>(datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]] <span class="sc">==</span> <span class="st">"SI"</span>)</span>
<span id="cb138-105"><a href="#cb138-105" aria-hidden="true" tabindex="-1"></a>    resultados_accuracy_inner[i_inner] <span class="ot">&lt;-</span> <span class="fu">mean</span>(clases_predichas_test <span class="sc">==</span> datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]])</span>
<span id="cb138-106"><a href="#cb138-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-107"><a href="#cb138-107" aria-hidden="true" tabindex="-1"></a>    targets_auc[test_indices_inner] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(datos_validacion<span class="sc">$</span>ESTADO_ACTUAL) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb138-108"><a href="#cb138-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-109"><a href="#cb138-109" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb138-110"><a href="#cb138-110" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb138-111"><a href="#cb138-111" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular el AUC final para este fold externo</span></span>
<span id="cb138-112"><a href="#cb138-112" aria-hidden="true" tabindex="-1"></a>  auc_fold_externo <span class="ot">&lt;-</span> pROC<span class="sc">::</span><span class="fu">roc</span>(targets_auc, predicciones_auc)<span class="sc">$</span>auc</span>
<span id="cb138-113"><a href="#cb138-113" aria-hidden="true" tabindex="-1"></a>  accuracy_fold_externo <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_accuracy_inner)</span>
<span id="cb138-114"><a href="#cb138-114" aria-hidden="true" tabindex="-1"></a>  sensibilidad_fold_externo <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_sensibilidad_inner)</span>
<span id="cb138-115"><a href="#cb138-115" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb138-116"><a href="#cb138-116" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb138-117"><a href="#cb138-117" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Almacenar el AUC del fold externo actual</span></span>
<span id="cb138-118"><a href="#cb138-118" aria-hidden="true" tabindex="-1"></a>  resultados_auc[i_outer] <span class="ot">&lt;-</span> auc_fold_externo</span>
<span id="cb138-119"><a href="#cb138-119" aria-hidden="true" tabindex="-1"></a>  resultados_accuracy[i_outer] <span class="ot">&lt;-</span> accuracy_fold_externo</span>
<span id="cb138-120"><a href="#cb138-120" aria-hidden="true" tabindex="-1"></a>  resultados_sensibilidad[i_outer] <span class="ot">&lt;-</span> sensibilidad_fold_externo</span>
<span id="cb138-121"><a href="#cb138-121" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb138-122"><a href="#cb138-122" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Predecir en los datos de test para este pliegue externo y almacenar predicciones</span></span>
<span id="cb138-123"><a href="#cb138-123" aria-hidden="true" tabindex="-1"></a>  predicciones_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(mejor_modelo, <span class="at">newdata =</span> datos_test_outer, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb138-124"><a href="#cb138-124" aria-hidden="true" tabindex="-1"></a>  predicciones_totales[test_indices_outer, i_outer] <span class="ot">&lt;-</span> predicciones_test</span>
<span id="cb138-125"><a href="#cb138-125" aria-hidden="true" tabindex="-1"></a>  targets_totales[test_indices_outer] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(datos_test_outer<span class="sc">$</span>ESTADO_ACTUAL) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb138-126"><a href="#cb138-126" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb138-127"><a href="#cb138-127" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb138-128"><a href="#cb138-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-129"><a href="#cb138-129" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular AUC promedio</span></span>
<span id="cb138-130"><a href="#cb138-130" aria-hidden="true" tabindex="-1"></a>auc_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_auc)</span>
<span id="cb138-131"><a href="#cb138-131" aria-hidden="true" tabindex="-1"></a>accuracy_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_accuracy)</span>
<span id="cb138-132"><a href="#cb138-132" aria-hidden="true" tabindex="-1"></a>sensibilidad_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_sensibilidad)</span>
<span id="cb138-133"><a href="#cb138-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-134"><a href="#cb138-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-135"><a href="#cb138-135" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear tabla con todas las métricas</span></span>
<span id="cb138-136"><a href="#cb138-136" aria-hidden="true" tabindex="-1"></a>tabla_metricas <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb138-137"><a href="#cb138-137" aria-hidden="true" tabindex="-1"></a>  <span class="at">Pliegue =</span> <span class="dv">1</span><span class="sc">:</span>k_outer,</span>
<span id="cb138-138"><a href="#cb138-138" aria-hidden="true" tabindex="-1"></a>  <span class="at">AUC =</span> <span class="fu">sapply</span>(resultados_auc, round, <span class="at">digits =</span> <span class="dv">3</span>),</span>
<span id="cb138-139"><a href="#cb138-139" aria-hidden="true" tabindex="-1"></a>  <span class="at">Accuracy =</span> <span class="fu">sapply</span>(resultados_accuracy, round, <span class="at">digits =</span> <span class="dv">3</span>),</span>
<span id="cb138-140"><a href="#cb138-140" aria-hidden="true" tabindex="-1"></a>  <span class="at">Recall =</span> <span class="fu">sapply</span>(resultados_sensibilidad, round, <span class="at">digits =</span> <span class="dv">3</span>)</span>
<span id="cb138-141"><a href="#cb138-141" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb138-142"><a href="#cb138-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-143"><a href="#cb138-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-144"><a href="#cb138-144" aria-hidden="true" tabindex="-1"></a><span class="co"># Agregar fila con promedio de métricas</span></span>
<span id="cb138-145"><a href="#cb138-145" aria-hidden="true" tabindex="-1"></a>tabla_metricas_ada <span class="ot">&lt;-</span> <span class="fu">rbind</span>(tabla_metricas, <span class="fu">c</span>(<span class="st">"Mean"</span>, <span class="fu">round</span>(auc_promedio,<span class="dv">3</span>), <span class="fu">round</span>(accuracy_promedio,<span class="dv">3</span>), <span class="fu">round</span>(sensibilidad_promedio,<span class="dv">3</span>)))</span>
<span id="cb138-146"><a href="#cb138-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-147"><a href="#cb138-147" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb138-148"><a href="#cb138-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-149"><a href="#cb138-149" aria-hidden="true" tabindex="-1"></a>execution_time_ada <span class="ot">&lt;-</span> end_time <span class="sc">-</span> start_time</span>
<span id="cb138-150"><a href="#cb138-150" aria-hidden="true" tabindex="-1"></a>execution_time_ada <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(execution_time_ada, <span class="at">units =</span> <span class="st">"secs"</span>)</span>
<span id="cb138-151"><a href="#cb138-151" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(tabla_metricas_ada, <span class="at">file =</span> <span class="st">"tabla_metricas_ada_filter.RData"</span>)</span>
<span id="cb138-152"><a href="#cb138-152" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(execution_time_ada, <span class="at">file =</span> <span class="st">"execution_time_ada_filter.RData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"tabla_metricas_ada_filter.RData"</span>)</span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"execution_time_ada_filter.RData"</span>)</span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir el tiempo de ejecución</span></span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time_ada,  <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-33-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-33-1" role="tab" aria-controls="tabset-33-1" aria-selected="true" href="">Metrics Table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-33-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-33-2" role="tab" aria-controls="tabset-33-2" aria-selected="false" href="">Metrics Plot</a></li></ul>
<div class="tab-content">
<div id="tabset-33-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-33-1-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir tabla formateada con kableExtra</span></span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(tabla_metricas_ada, <span class="at">caption =</span> <span class="st">"Cross Validation Metrics"</span>, <span class="at">align =</span> <span class="st">"c"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="tabset-33-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-33-2-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="fu">crear_plot_metricas_per_fold</span>(tabla_metricas_ada)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
<p>The performance is good but not the best and it is so instable.</p>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="models-comparison" class="level1">
<h1>Models Comparison</h1>
<div class="tabset-margin-container"></div><div class="panel-tabset" style="background-color: #f0f0f0;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-36-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-36-1" role="tab" aria-controls="tabset-36-1" aria-selected="true" href="">Metrics Comparison</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-36-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-36-2" role="tab" aria-controls="tabset-36-2" aria-selected="false" href="">Execution Time Comparison</a></li></ul>
<div class="tab-content" style="background-color: #f0f0f0;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;">
<div id="tabset-36-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-36-1-tab">
<p>For the comparison of the models, we are going to plot the metrics of each model in a bar plot. Specifically, we are going to compare the AUC, Accuracy, and Recall metrics of the best variables selected for each model.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a>crear_comparacion_metricas <span class="ot">&lt;-</span> <span class="cf">function</span>(lista_tablas_metricas, nombres_tablas) {</span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Verificar que la longitud de la lista de tablas y los nombres coincida</span></span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(lista_tablas_metricas) <span class="sc">!=</span> <span class="fu">length</span>(nombres_tablas)) {</span>
<span id="cb142-6"><a href="#cb142-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"La cantidad de tablas y de nombres debe ser la misma."</span>)</span>
<span id="cb142-7"><a href="#cb142-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb142-8"><a href="#cb142-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-9"><a href="#cb142-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Añadir una columna con el nombre del modelo a cada tabla y combinarlas</span></span>
<span id="cb142-10"><a href="#cb142-10" aria-hidden="true" tabindex="-1"></a>  lista_tablas_metricas <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">seq_along</span>(lista_tablas_metricas), <span class="cf">function</span>(i) {</span>
<span id="cb142-11"><a href="#cb142-11" aria-hidden="true" tabindex="-1"></a>    tabla <span class="ot">&lt;-</span> lista_tablas_metricas[[i]]</span>
<span id="cb142-12"><a href="#cb142-12" aria-hidden="true" tabindex="-1"></a>    tabla <span class="ot">&lt;-</span> tabla <span class="sc">%&gt;%</span></span>
<span id="cb142-13"><a href="#cb142-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(Pliegue <span class="sc">!=</span> <span class="st">"Mean"</span>) <span class="sc">%&gt;%</span>  <span class="co"># Filtrar las filas de medias si no deseas incluirlas</span></span>
<span id="cb142-14"><a href="#cb142-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">Modelo =</span> nombres_tablas[i])</span>
<span id="cb142-15"><a href="#cb142-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convertir las columnas de métricas a numéricas</span></span>
<span id="cb142-16"><a href="#cb142-16" aria-hidden="true" tabindex="-1"></a>    tabla <span class="ot">&lt;-</span> tabla <span class="sc">%&gt;%</span></span>
<span id="cb142-17"><a href="#cb142-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(AUC, Accuracy, Recall), as.numeric))</span>
<span id="cb142-18"><a href="#cb142-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(tabla)</span>
<span id="cb142-19"><a href="#cb142-19" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb142-20"><a href="#cb142-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-21"><a href="#cb142-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Combinar todas las tablas en una sola</span></span>
<span id="cb142-22"><a href="#cb142-22" aria-hidden="true" tabindex="-1"></a>  tabla_metricas_combinada <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(lista_tablas_metricas)</span>
<span id="cb142-23"><a href="#cb142-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-24"><a href="#cb142-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Transformar la tabla a un formato largo</span></span>
<span id="cb142-25"><a href="#cb142-25" aria-hidden="true" tabindex="-1"></a>  tabla_metricas_long <span class="ot">&lt;-</span> <span class="fu">pivot_longer</span>(tabla_metricas_combinada, </span>
<span id="cb142-26"><a href="#cb142-26" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">cols =</span> <span class="fu">c</span>(AUC, Accuracy, Recall), </span>
<span id="cb142-27"><a href="#cb142-27" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">names_to =</span> <span class="st">"Metrica"</span>, </span>
<span id="cb142-28"><a href="#cb142-28" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">values_to =</span> <span class="st">"Valor"</span>)</span>
<span id="cb142-29"><a href="#cb142-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-30"><a href="#cb142-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Crear el gráfico</span></span>
<span id="cb142-31"><a href="#cb142-31" aria-hidden="true" tabindex="-1"></a>  plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(tabla_metricas_long, <span class="fu">aes</span>(<span class="at">x =</span> Modelo, <span class="at">y =</span> Valor, <span class="at">fill =</span> Metrica)) <span class="sc">+</span></span>
<span id="cb142-32"><a href="#cb142-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">position =</span> <span class="st">"dodge"</span>) <span class="sc">+</span></span>
<span id="cb142-33"><a href="#cb142-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Metrics comparison between models"</span>, <span class="at">x =</span> <span class="st">"Model"</span>, <span class="at">y =</span> <span class="st">"Value"</span>) <span class="sc">+</span></span>
<span id="cb142-34"><a href="#cb142-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb142-35"><a href="#cb142-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"AUC"</span> <span class="ot">=</span> <span class="st">"steelblue"</span>, <span class="st">"Accuracy"</span> <span class="ot">=</span> <span class="st">"lightblue"</span>, <span class="st">"Recall"</span> <span class="ot">=</span> <span class="st">"#3C5B6F"</span>), <span class="at">name =</span> <span class="st">"Metric"</span>) <span class="sc">+</span></span>
<span id="cb142-36"><a href="#cb142-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">color =</span> <span class="fu">rgb</span>(<span class="dv">226</span>, <span class="dv">231</span>, <span class="dv">236</span>, <span class="at">maxColorValue =</span> <span class="dv">255</span>), <span class="at">size =</span> <span class="fl">1.5</span>)) <span class="sc">+</span></span>
<span id="cb142-37"><a href="#cb142-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>))  <span class="co"># Ajustar el eje y de 0 a 1 y sin espacio adicional</span></span>
<span id="cb142-38"><a href="#cb142-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-39"><a href="#cb142-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(plot)</span>
<span id="cb142-40"><a href="#cb142-40" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb142-41"><a href="#cb142-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-42"><a href="#cb142-42" aria-hidden="true" tabindex="-1"></a>lista_tablas_metricas <span class="ot">&lt;-</span> <span class="fu">list</span>(tabla_metricas_logistic_wrapper, tabla_metricas_nnet_wrapper,tabla_metricas_svm_filter,tabla_metricas_dtree_filter,tabla_metricas_random_forest,tabla_metricas_naive_wrapper,tabla_metricas_ada,tabla_metricas_knn)</span>
<span id="cb142-43"><a href="#cb142-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-44"><a href="#cb142-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Nombres de las tablas</span></span>
<span id="cb142-45"><a href="#cb142-45" aria-hidden="true" tabindex="-1"></a>nombres_tablas <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Logistic"</span>, <span class="st">"NN"</span>,<span class="st">"SVM"</span>, <span class="st">"D.Tree"</span>, <span class="st">"R.Forest"</span>, <span class="st">"N.Bayes"</span>,<span class="st">"AdaBoost"</span>,<span class="st">"KNN"</span>)</span>
<span id="cb142-46"><a href="#cb142-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-47"><a href="#cb142-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Llamar a la función</span></span>
<span id="cb142-48"><a href="#cb142-48" aria-hidden="true" tabindex="-1"></a>plot <span class="ot">&lt;-</span> <span class="fu">crear_comparacion_metricas</span>(lista_tablas_metricas, nombres_tablas)</span>
<span id="cb142-49"><a href="#cb142-49" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(plot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="tabset-36-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-36-2-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear el vector de tiempos de entrenamiento</span></span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>modelos_tiempos <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">Logistic =</span> execution_time_logistic_wrapper, </span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a>                     <span class="at">Neural_Network =</span> execution_time_nnet_wrapper,</span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">Decision_Tree =</span> execution_time_dtree_filter,</span>
<span id="cb143-5"><a href="#cb143-5" aria-hidden="true" tabindex="-1"></a>                     <span class="at">Random_Forest =</span> execution_time_random_forest,</span>
<span id="cb143-6"><a href="#cb143-6" aria-hidden="true" tabindex="-1"></a>                     <span class="at">Naive_Bayes =</span> execution_time_naive_wrapper,</span>
<span id="cb143-7"><a href="#cb143-7" aria-hidden="true" tabindex="-1"></a>                     <span class="at">SVM =</span> execution_time_svm_filter,</span>
<span id="cb143-8"><a href="#cb143-8" aria-hidden="true" tabindex="-1"></a>                     <span class="at">AdaBoost =</span> execution_time_ada,</span>
<span id="cb143-9"><a href="#cb143-9" aria-hidden="true" tabindex="-1"></a>                     <span class="at">KNN =</span> execution_time_knn)</span>
<span id="cb143-10"><a href="#cb143-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-11"><a href="#cb143-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-12"><a href="#cb143-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Definir la función para comparar tiempos de entrenamiento</span></span>
<span id="cb143-13"><a href="#cb143-13" aria-hidden="true" tabindex="-1"></a>comparar_tiempos_entrenamiento <span class="ot">&lt;-</span> <span class="cf">function</span>(modelos_tiempos) {</span>
<span id="cb143-14"><a href="#cb143-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Verificar que los tiempos estén en un vector numérico</span></span>
<span id="cb143-15"><a href="#cb143-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.numeric</span>(modelos_tiempos)) {</span>
<span id="cb143-16"><a href="#cb143-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Los tiempos de entrenamiento deben ser un vector numérico."</span>)</span>
<span id="cb143-17"><a href="#cb143-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb143-18"><a href="#cb143-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb143-19"><a href="#cb143-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Crear un dataframe con los nombres de los modelos y sus tiempos de entrenamiento</span></span>
<span id="cb143-20"><a href="#cb143-20" aria-hidden="true" tabindex="-1"></a>  modelos_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb143-21"><a href="#cb143-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">modelo =</span> <span class="fu">names</span>(modelos_tiempos),</span>
<span id="cb143-22"><a href="#cb143-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">tiempo =</span> modelos_tiempos</span>
<span id="cb143-23"><a href="#cb143-23" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb143-24"><a href="#cb143-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb143-25"><a href="#cb143-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ordenar el dataframe por tiempo de entrenamiento</span></span>
<span id="cb143-26"><a href="#cb143-26" aria-hidden="true" tabindex="-1"></a>  modelos_df <span class="ot">&lt;-</span> modelos_df[<span class="fu">order</span>(modelos_df<span class="sc">$</span>tiempo, <span class="at">decreasing =</span> <span class="cn">TRUE</span>), ]</span>
<span id="cb143-27"><a href="#cb143-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb143-28"><a href="#cb143-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Crear el gráfico de barras con etiquetas de texto dentro de cada barra</span></span>
<span id="cb143-29"><a href="#cb143-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(modelos_df, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(modelo, tiempo), <span class="at">y =</span> tiempo, <span class="at">fill =</span> tiempo)) <span class="sc">+</span></span>
<span id="cb143-30"><a href="#cb143-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb143-31"><a href="#cb143-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">round</span>(tiempo, <span class="dv">1</span>)), <span class="at">hjust =</span> <span class="fl">1.2</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span> <span class="co"># Ajustar etiquetas dentro de las barras</span></span>
<span id="cb143-32"><a href="#cb143-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_flip</span>() <span class="sc">+</span> <span class="co"># Girar el gráfico para que los modelos se vean en el eje y</span></span>
<span id="cb143-33"><a href="#cb143-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_gradientn</span>(<span class="at">colors =</span> <span class="fu">c</span>(<span class="st">"lightblue"</span>, <span class="st">"steelblue"</span>, <span class="st">"#3C5B6F"</span>,<span class="st">"purple"</span>)) <span class="sc">+</span> <span class="co"># Gradiente de azul a rojo pasando por naranja</span></span>
<span id="cb143-34"><a href="#cb143-34" aria-hidden="true" tabindex="-1"></a>        <span class="fu">labs</span>(</span>
<span id="cb143-35"><a href="#cb143-35" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Execution Time Comparison between Models"</span>,</span>
<span id="cb143-36"><a href="#cb143-36" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Models"</span>,</span>
<span id="cb143-37"><a href="#cb143-37" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Execution time (seconds)"</span></span>
<span id="cb143-38"><a href="#cb143-38" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb143-39"><a href="#cb143-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb143-40"><a href="#cb143-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)) <span class="sc">+</span><span class="co"># Centrar el título</span></span>
<span id="cb143-41"><a href="#cb143-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">color =</span> <span class="fu">rgb</span>(<span class="dv">226</span>, <span class="dv">231</span>, <span class="dv">236</span>, <span class="at">maxColorValue =</span> <span class="dv">255</span>), <span class="at">size =</span> <span class="fl">1.5</span>)) </span>
<span id="cb143-42"><a href="#cb143-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-43"><a href="#cb143-43" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb143-44"><a href="#cb143-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-45"><a href="#cb143-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Usar la función para comparar los tiempos de entrenamiento</span></span>
<span id="cb143-46"><a href="#cb143-46" aria-hidden="true" tabindex="-1"></a><span class="fu">comparar_tiempos_entrenamiento</span>(modelos_tiempos)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
<p>Results show that the best model for this problem is the naive bayes model. It has high AUC, accuracy and recall. Also, it is very stable regarding the hyperparameters. We can trust that the performance of the model is going to be very similar in the future.</p>
</section>
<section id="final-model" class="level1">
<h1>Final Model</h1>
<p>The objetive of this section is to find the best hyperparameters and variable combiantion for the naive bayes model. The hyperparameter that we are going to tune is the Laplace smoothing, a technique used to avoid zero probabilities in the model. We are not going to tune the usekernel hyperparameter because our variables are not normally distributed(the function of usekernel is to asume that the variables are normally distributed or not).</p>
<div class="tabset-margin-container"></div><div class="panel-tabset" style="background-color: #f0f0f0;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-37-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-37-1" role="tab" aria-controls="tabset-37-1" aria-selected="true" href="">Best Hyperparameters</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-37-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-37-2" role="tab" aria-controls="tabset-37-2" aria-selected="false" href="">Visualization</a></li></ul>
<div class="tab-content" style="background-color: #f0f0f0;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;">
<div id="tabset-37-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-37-1-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Dividir el conjunto de datos en entrenamiento y test</span></span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a>indices_entrenamiento <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(data), <span class="fl">0.75</span> <span class="sc">*</span> <span class="fu">nrow</span>(data))  <span class="co"># 75% para entrenamiento</span></span>
<span id="cb144-5"><a href="#cb144-5" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento <span class="ot">&lt;-</span> data[indices_entrenamiento, ]</span>
<span id="cb144-6"><a href="#cb144-6" aria-hidden="true" tabindex="-1"></a>datos_test <span class="ot">&lt;-</span> data[<span class="sc">-</span>indices_entrenamiento, ]</span>
<span id="cb144-7"><a href="#cb144-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-8"><a href="#cb144-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Dividir datos de entrenamiento en entrenamiento y validación</span></span>
<span id="cb144-9"><a href="#cb144-9" aria-hidden="true" tabindex="-1"></a>train_indices <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(datos_entrenamiento), <span class="fl">0.8</span> <span class="sc">*</span> <span class="fu">nrow</span>(datos_entrenamiento))  <span class="co"># 80% para entrenamiento</span></span>
<span id="cb144-10"><a href="#cb144-10" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento_split <span class="ot">&lt;-</span> datos_entrenamiento[train_indices, ]</span>
<span id="cb144-11"><a href="#cb144-11" aria-hidden="true" tabindex="-1"></a>datos_validacion <span class="ot">&lt;-</span> datos_entrenamiento[<span class="sc">-</span>train_indices, ]</span>
<span id="cb144-12"><a href="#cb144-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-13"><a href="#cb144-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Oversampling</span></span>
<span id="cb144-14"><a href="#cb144-14" aria-hidden="true" tabindex="-1"></a>proportion <span class="ot">&lt;-</span> <span class="fl">0.28</span></span>
<span id="cb144-15"><a href="#cb144-15" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento_oversampled <span class="ot">&lt;-</span> <span class="fu">ROSE</span>(ESTADO_ACTUAL <span class="sc">~</span> ., <span class="at">data =</span> datos_entrenamiento_split, <span class="at">p =</span> proportion)<span class="sc">$</span>data</span>
<span id="cb144-16"><a href="#cb144-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-17"><a href="#cb144-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Inicializar variables para almacenar los resultados</span></span>
<span id="cb144-18"><a href="#cb144-18" aria-hidden="true" tabindex="-1"></a>mejor_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb144-19"><a href="#cb144-19" aria-hidden="true" tabindex="-1"></a>mejor_modelo <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb144-20"><a href="#cb144-20" aria-hidden="true" tabindex="-1"></a>resultados <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">fL =</span> <span class="fu">numeric</span>(), <span class="at">auc =</span> <span class="fu">numeric</span>(), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb144-21"><a href="#cb144-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-22"><a href="#cb144-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Definir hiperparámetros a probar</span></span>
<span id="cb144-23"><a href="#cb144-23" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">fL =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>))</span>
<span id="cb144-24"><a href="#cb144-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-25"><a href="#cb144-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Bucle para probar diferentes combinaciones de hiperparámetros</span></span>
<span id="cb144-26"><a href="#cb144-26" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(params)) {</span>
<span id="cb144-27"><a href="#cb144-27" aria-hidden="true" tabindex="-1"></a>  fL <span class="ot">&lt;-</span> params<span class="sc">$</span>fL[i]</span>
<span id="cb144-28"><a href="#cb144-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-29"><a href="#cb144-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-30"><a href="#cb144-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Entrenar el modelo Naive Bayes con la combinación de hiperparámetros actual</span></span>
<span id="cb144-31"><a href="#cb144-31" aria-hidden="true" tabindex="-1"></a>  modelo <span class="ot">&lt;-</span> <span class="fu">naiveBayes</span>(ESTADO_ACTUAL <span class="sc">~</span> ., <span class="at">data =</span> datos_entrenamiento_oversampled, <span class="at">fL =</span> fL)</span>
<span id="cb144-32"><a href="#cb144-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-33"><a href="#cb144-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Realizar predicciones en datos de prueba</span></span>
<span id="cb144-34"><a href="#cb144-34" aria-hidden="true" tabindex="-1"></a>  predicciones_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelo, <span class="at">newdata =</span> datos_test, <span class="at">type =</span> <span class="st">"raw"</span>)</span>
<span id="cb144-35"><a href="#cb144-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-36"><a href="#cb144-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular AUC para la combinación actual en datos de prueba</span></span>
<span id="cb144-37"><a href="#cb144-37" aria-hidden="true" tabindex="-1"></a>  roc_obj <span class="ot">&lt;-</span> <span class="fu">roc</span>(<span class="fu">ifelse</span>(datos_test<span class="sc">$</span>ESTADO_ACTUAL <span class="sc">==</span> <span class="st">"SI"</span>, <span class="dv">1</span>, <span class="dv">0</span>), predicciones_test[, <span class="dv">2</span>])</span>
<span id="cb144-38"><a href="#cb144-38" aria-hidden="true" tabindex="-1"></a>  auc_actual <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">auc</span>(roc_obj))  <span class="co"># Extraer el valor numérico del AUC</span></span>
<span id="cb144-39"><a href="#cb144-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-40"><a href="#cb144-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Guardar los resultados en la tabla</span></span>
<span id="cb144-41"><a href="#cb144-41" aria-hidden="true" tabindex="-1"></a>  resultados <span class="ot">&lt;-</span> resultados <span class="sc">%&gt;%</span></span>
<span id="cb144-42"><a href="#cb144-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_row</span>(<span class="at">fL =</span> fL, <span class="at">auc =</span> auc_actual)</span>
<span id="cb144-43"><a href="#cb144-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-44"><a href="#cb144-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Actualizar el mejor modelo y su AUC si se encuentra un modelo mejor</span></span>
<span id="cb144-45"><a href="#cb144-45" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (auc_actual <span class="sc">&gt;</span> mejor_auc) {</span>
<span id="cb144-46"><a href="#cb144-46" aria-hidden="true" tabindex="-1"></a>    mejor_auc <span class="ot">&lt;-</span> auc_actual</span>
<span id="cb144-47"><a href="#cb144-47" aria-hidden="true" tabindex="-1"></a>    mejor_modelo <span class="ot">&lt;-</span> modelo</span>
<span id="cb144-48"><a href="#cb144-48" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb144-49"><a href="#cb144-49" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb144-50"><a href="#cb144-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-51"><a href="#cb144-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Ordenar los resultados por AUC en orden descendente</span></span>
<span id="cb144-52"><a href="#cb144-52" aria-hidden="true" tabindex="-1"></a>resultados_ordenados_nb <span class="ot">&lt;-</span> resultados <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(<span class="fu">desc</span>(auc))</span>
<span id="cb144-53"><a href="#cb144-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-54"><a href="#cb144-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Mostrar la tabla con los resultados de todas las combinaciones de hiperparámetros</span></span>
<span id="cb144-55"><a href="#cb144-55" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(resultados_ordenados_nb, <span class="at">file =</span> <span class="st">"resultados_ordenados_nb.RData"</span>)</span>
<span id="cb144-56"><a href="#cb144-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-57"><a href="#cb144-57" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb144-58"><a href="#cb144-58" aria-hidden="true" tabindex="-1"></a><span class="co"># Cargar los datos guardados y mostrar las tablas</span></span>
<span id="cb144-59"><a href="#cb144-59" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"resultados_ordenados_nb.RData"</span>)</span>
<span id="cb144-60"><a href="#cb144-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-61"><a href="#cb144-61" aria-hidden="true" tabindex="-1"></a><span class="co"># Seleccionar los mejores 10 modelos</span></span>
<span id="cb144-62"><a href="#cb144-62" aria-hidden="true" tabindex="-1"></a>mejores_10 <span class="ot">&lt;-</span> resultados_ordenados_nb <span class="sc">%&gt;%</span> <span class="fu">head</span>(<span class="dv">10</span>)</span>
<span id="cb144-63"><a href="#cb144-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-64"><a href="#cb144-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-65"><a href="#cb144-65" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir los mejores y peores modelos en tablas bonitas</span></span>
<span id="cb144-66"><a href="#cb144-66" aria-hidden="true" tabindex="-1"></a>mejores_10 <span class="sc">%&gt;%</span></span>
<span id="cb144-67"><a href="#cb144-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">caption =</span> <span class="st">"Top 10 Models by AUC"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb144-68"><a href="#cb144-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>, <span class="st">"condensed"</span>, <span class="st">"responsive"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="tabset-37-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-37-2-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mejores_10, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(fL), <span class="at">y =</span> auc)) <span class="sc">+</span></span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">fill =</span> <span class="st">"#3C5B6F"</span>) <span class="sc">+</span></span>
<span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"AUC for each Laplace smoothing value"</span>,</span>
<span id="cb145-4"><a href="#cb145-4" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"fL"</span>,</span>
<span id="cb145-5"><a href="#cb145-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"AUC"</span>) <span class="sc">+</span></span>
<span id="cb145-6"><a href="#cb145-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="dv">1</span>) <span class="sc">+</span>             <span class="co"># Establecer el límite del eje y</span></span>
<span id="cb145-7"><a href="#cb145-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
<p>There is no difference between the hyperparameters because Laplace smoothing is only necessary when the data is very sparse.</p>
<section id="variable-selection-for-the-final-model" class="level2">
<h2 class="anchored" data-anchor-id="variable-selection-for-the-final-model">Variable Selection for the Final Model</h2>
<p>The objetive of this section is to find the best variables for the final model. We are going to obtain the performance of every combination of variables in a repeated hold out and then we are going to select variables that are more frequent in the combinations with high AUC(threshold of 0.75).</p>
<div class="tabset-margin-container"></div><div class="panel-tabset" style="background-color: #f0f0f0;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-38-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-38-1" role="tab" aria-controls="tabset-38-1" aria-selected="true" href="">Variables cominations and auc</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-38-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-38-2" role="tab" aria-controls="tabset-38-2" aria-selected="false" href="">Variable frequency in better combinations</a></li></ul>
<div class="tab-content" style="background-color: #f0f0f0;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;">
<div id="tabset-38-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-38-1-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Definir el número de repeticiones para el repeated holdout</span></span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a>n_repeats <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-6"><a href="#cb146-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear particiones de datos</span></span>
<span id="cb146-7"><a href="#cb146-7" aria-hidden="true" tabindex="-1"></a>index <span class="ot">&lt;-</span> <span class="fu">createDataPartition</span>(data<span class="sc">$</span>ESTADO_ACTUAL, <span class="at">times =</span> n_repeats, <span class="at">p =</span> <span class="fl">0.75</span>, <span class="at">list =</span> <span class="cn">TRUE</span>)</span>
<span id="cb146-8"><a href="#cb146-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-9"><a href="#cb146-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Inicializar variables para almacenar los resultados</span></span>
<span id="cb146-10"><a href="#cb146-10" aria-hidden="true" tabindex="-1"></a>resultados <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Variables =</span> <span class="fu">character</span>(), <span class="at">auc =</span> <span class="fu">numeric</span>(), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb146-11"><a href="#cb146-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-12"><a href="#cb146-12" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb146-13"><a href="#cb146-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-14"><a href="#cb146-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (r <span class="cf">in</span> <span class="fu">seq_along</span>(index)) {</span>
<span id="cb146-15"><a href="#cb146-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Obtener índices de entrenamiento y prueba para esta repetición</span></span>
<span id="cb146-16"><a href="#cb146-16" aria-hidden="true" tabindex="-1"></a>  train_indices <span class="ot">&lt;-</span> <span class="fu">unlist</span>(index[<span class="sc">-</span>r])</span>
<span id="cb146-17"><a href="#cb146-17" aria-hidden="true" tabindex="-1"></a>  test_indices <span class="ot">&lt;-</span> index[[r]]</span>
<span id="cb146-18"><a href="#cb146-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-19"><a href="#cb146-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Dividir el conjunto de datos en entrenamiento y test</span></span>
<span id="cb146-20"><a href="#cb146-20" aria-hidden="true" tabindex="-1"></a>  datos_entrenamiento <span class="ot">&lt;-</span> data[train_indices, ]</span>
<span id="cb146-21"><a href="#cb146-21" aria-hidden="true" tabindex="-1"></a>  datos_test <span class="ot">&lt;-</span> data[test_indices, ]</span>
<span id="cb146-22"><a href="#cb146-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-23"><a href="#cb146-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Oversampling</span></span>
<span id="cb146-24"><a href="#cb146-24" aria-hidden="true" tabindex="-1"></a>  proportion <span class="ot">&lt;-</span> <span class="fl">0.28</span></span>
<span id="cb146-25"><a href="#cb146-25" aria-hidden="true" tabindex="-1"></a>  datos_entrenamiento_oversampled <span class="ot">&lt;-</span> <span class="fu">ROSE</span>(ESTADO_ACTUAL <span class="sc">~</span> ., <span class="at">data =</span> datos_entrenamiento, <span class="at">p =</span> proportion)<span class="sc">$</span>data</span>
<span id="cb146-26"><a href="#cb146-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-27"><a href="#cb146-27" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (comb <span class="cf">in</span> combinaciones_variables) {</span>
<span id="cb146-28"><a href="#cb146-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Entrenar el modelo Naive Bayes con la combinación de variables actual</span></span>
<span id="cb146-29"><a href="#cb146-29" aria-hidden="true" tabindex="-1"></a>    modelo <span class="ot">&lt;-</span> <span class="fu">naiveBayes</span>(ESTADO_ACTUAL <span class="sc">~</span> ., <span class="at">data =</span> datos_entrenamiento_oversampled[, <span class="fu">c</span>(comb, <span class="st">"ESTADO_ACTUAL"</span>)])</span>
<span id="cb146-30"><a href="#cb146-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-31"><a href="#cb146-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Realizar predicciones en datos de prueba</span></span>
<span id="cb146-32"><a href="#cb146-32" aria-hidden="true" tabindex="-1"></a>    predicciones_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelo, <span class="at">newdata =</span> datos_test, <span class="at">type =</span> <span class="st">"raw"</span>)</span>
<span id="cb146-33"><a href="#cb146-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-34"><a href="#cb146-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calcular AUC para la combinación actual en datos de prueba</span></span>
<span id="cb146-35"><a href="#cb146-35" aria-hidden="true" tabindex="-1"></a>    roc_obj <span class="ot">&lt;-</span> <span class="fu">roc</span>(<span class="fu">ifelse</span>(datos_test<span class="sc">$</span>ESTADO_ACTUAL <span class="sc">==</span> <span class="st">"SI"</span>, <span class="dv">1</span>, <span class="dv">0</span>), predicciones_test[, <span class="dv">2</span>])</span>
<span id="cb146-36"><a href="#cb146-36" aria-hidden="true" tabindex="-1"></a>    auc_actual <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">auc</span>(roc_obj))  <span class="co"># Extraer el valor numérico del AUC</span></span>
<span id="cb146-37"><a href="#cb146-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-38"><a href="#cb146-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convertir la combinación en una cadena única</span></span>
<span id="cb146-39"><a href="#cb146-39" aria-hidden="true" tabindex="-1"></a>    comb_str <span class="ot">&lt;-</span> <span class="fu">paste</span>(comb, <span class="at">collapse =</span> <span class="st">","</span>)</span>
<span id="cb146-40"><a href="#cb146-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-41"><a href="#cb146-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Guardar los resultados en la tabla</span></span>
<span id="cb146-42"><a href="#cb146-42" aria-hidden="true" tabindex="-1"></a>    resultados <span class="ot">&lt;-</span> resultados <span class="sc">%&gt;%</span></span>
<span id="cb146-43"><a href="#cb146-43" aria-hidden="true" tabindex="-1"></a>      <span class="fu">add_row</span>(<span class="at">Variables =</span> comb_str, <span class="at">auc =</span> auc_actual)</span>
<span id="cb146-44"><a href="#cb146-44" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb146-45"><a href="#cb146-45" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb146-46"><a href="#cb146-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-47"><a href="#cb146-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular el AUC promedio para cada combinación de variables</span></span>
<span id="cb146-48"><a href="#cb146-48" aria-hidden="true" tabindex="-1"></a>resultados_promedio <span class="ot">&lt;-</span> resultados <span class="sc">%&gt;%</span></span>
<span id="cb146-49"><a href="#cb146-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Variables) <span class="sc">%&gt;%</span></span>
<span id="cb146-50"><a href="#cb146-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">auc_promedio =</span> <span class="fu">mean</span>(auc))</span>
<span id="cb146-51"><a href="#cb146-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-52"><a href="#cb146-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Ordenar los resultados por AUC promedio en orden descendente</span></span>
<span id="cb146-53"><a href="#cb146-53" aria-hidden="true" tabindex="-1"></a>resultados_ordenados_variables <span class="ot">&lt;-</span> resultados_promedio <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(<span class="fu">desc</span>(auc_promedio))</span>
<span id="cb146-54"><a href="#cb146-54" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(resultados_ordenados_variables, <span class="at">file =</span> <span class="st">"resultados_ordenados_variables.RData"</span>)</span>
<span id="cb146-55"><a href="#cb146-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-56"><a href="#cb146-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-57"><a href="#cb146-57" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb146-58"><a href="#cb146-58" aria-hidden="true" tabindex="-1"></a>execution_time <span class="ot">&lt;-</span> end_time <span class="sc">-</span> start_time</span>
<span id="cb146-59"><a href="#cb146-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-60"><a href="#cb146-60" aria-hidden="true" tabindex="-1"></a>execution_time_30 <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(execution_time, <span class="at">units =</span> <span class="st">"secs"</span>)</span>
<span id="cb146-61"><a href="#cb146-61" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(execution_time_30, <span class="at">file =</span> <span class="st">"execution_time_30.RData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"resultados_ordenados_variables.RData"</span>)</span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"execution_time_30.RData"</span>)</span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-4"><a href="#cb147-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-5"><a href="#cb147-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Mostrar la tabla con los resultados de todas las combinaciones de variables</span></span>
<span id="cb147-6"><a href="#cb147-6" aria-hidden="true" tabindex="-1"></a>tabla <span class="ot">&lt;-</span> <span class="fu">kable</span>(resultados_ordenados_variables, <span class="at">format =</span> <span class="st">"html"</span>, <span class="at">align =</span> <span class="st">"ccc"</span>, <span class="at">caption =</span> <span class="st">"Tabla de Resultados"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>, <span class="at">booktabs =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb147-7"><a href="#cb147-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="st">"striped"</span>)</span>
<span id="cb147-8"><a href="#cb147-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-9"><a href="#cb147-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Mostrar la tabla con scroll</span></span>
<span id="cb147-10"><a href="#cb147-10" aria-hidden="true" tabindex="-1"></a>tabla_con_scroll <span class="ot">&lt;-</span> <span class="fu">scroll_box</span>(tabla, <span class="at">width =</span> <span class="st">"100%"</span>, <span class="at">height =</span> <span class="st">"400px"</span>)</span>
<span id="cb147-11"><a href="#cb147-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-12"><a href="#cb147-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Mostrar la tabla</span></span>
<span id="cb147-13"><a href="#cb147-13" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(tabla_con_scroll)</span>
<span id="cb147-14"><a href="#cb147-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-15"><a href="#cb147-15" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="tabset-38-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-38-2-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Definir el umbral para el AUC</span></span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a>umbral_auc <span class="ot">&lt;-</span> <span class="fl">0.75</span></span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Filtrar combinaciones con AUC mayor que el umbral</span></span>
<span id="cb148-5"><a href="#cb148-5" aria-hidden="true" tabindex="-1"></a>combinaciones_altas <span class="ot">&lt;-</span> resultados_ordenados_variables[resultados_ordenados_variables<span class="sc">$</span>auc_promedio <span class="sc">&gt;</span> umbral_auc, ]</span>
<span id="cb148-6"><a href="#cb148-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-7"><a href="#cb148-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear un vector para almacenar las variables individuales</span></span>
<span id="cb148-8"><a href="#cb148-8" aria-hidden="true" tabindex="-1"></a>variables_individuales <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">strsplit</span>(combinaciones_altas<span class="sc">$</span>Variables, <span class="st">","</span>))</span>
<span id="cb148-9"><a href="#cb148-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-10"><a href="#cb148-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular la frecuencia de cada variable</span></span>
<span id="cb148-11"><a href="#cb148-11" aria-hidden="true" tabindex="-1"></a>frecuencia_variables <span class="ot">&lt;-</span> <span class="fu">table</span>(variables_individuales)</span>
<span id="cb148-12"><a href="#cb148-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-13"><a href="#cb148-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear la tabla de frecuencia de variables</span></span>
<span id="cb148-14"><a href="#cb148-14" aria-hidden="true" tabindex="-1"></a>tabla_frecuencia_variables <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Variable =</span> <span class="fu">names</span>(frecuencia_variables), <span class="at">Frecuencia =</span> <span class="fu">as.numeric</span>(frecuencia_variables))</span>
<span id="cb148-15"><a href="#cb148-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-16"><a href="#cb148-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Ordenar la tabla por frecuencia en orden descendente</span></span>
<span id="cb148-17"><a href="#cb148-17" aria-hidden="true" tabindex="-1"></a>tabla_frecuencia_variables <span class="ot">&lt;-</span> tabla_frecuencia_variables[<span class="fu">order</span>(<span class="sc">-</span>tabla_frecuencia_variables<span class="sc">$</span>Frecuencia), ]</span>
<span id="cb148-18"><a href="#cb148-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-19"><a href="#cb148-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Mostrar la tabla de frecuencia de variables</span></span>
<span id="cb148-20"><a href="#cb148-20" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(tabla_frecuencia_variables, <span class="at">format =</span> <span class="st">"html"</span>, <span class="at">align =</span> <span class="st">"ccc"</span>, <span class="at">caption =</span> <span class="st">"Variable Frequency in Best Combinations"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>, <span class="at">booktabs =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb148-21"><a href="#cb148-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="st">"striped"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
<p>The variables that are more frequent in the best combinations are ESTADO_ACTUAL, REst, Fenotipo, Grado and Edad. We are going to use these variables for the final model.</p>
</section>
<section id="final-model-1" class="level2">
<h2 class="anchored" data-anchor-id="final-model-1">Final model</h2>
<p>Final model summary:</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Modelo para producción</span></span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a>datafinal <span class="ot">&lt;-</span> data[<span class="fu">c</span>(<span class="st">"ESTADO_ACTUAL"</span>, <span class="st">"REst"</span>, <span class="st">"Fenotipo"</span>, <span class="st">"Grado"</span>, <span class="st">"Edad"</span>)]</span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a>modelo_final <span class="ot">&lt;-</span> <span class="fu">naiveBayes</span>(ESTADO_ACTUAL <span class="sc">~</span> ., <span class="at">data =</span> datafinal)</span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(modelo_final, <span class="at">file =</span> <span class="st">"modelo_final.RData"</span>)</span>
<span id="cb149-5"><a href="#cb149-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(modelo_final)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="cross-validation-comparation" class="level2">
<h2 class="anchored" data-anchor-id="cross-validation-comparation">Cross validation comparation</h2>
<p>The objetive of this section is to validate the final model with a cross validation. We are going to compare different numbers of folds in the cross validation to see how this can affect the performance of the model.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset" style="background-color: #f0f0f0;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-43-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-43-1" role="tab" aria-controls="tabset-43-1" aria-selected="true" href="">5x2 Cross Validation</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-43-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-43-2" role="tab" aria-controls="tabset-43-2" aria-selected="false" href="">10x2 Cross Validation</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-43-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-43-3" role="tab" aria-controls="tabset-43-3" aria-selected="false" href="">10x5 Cross Validation</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-43-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-43-4" role="tab" aria-controls="tabset-43-4" aria-selected="false" href="">20x10 Cross Validation</a></li></ul>
<div class="tab-content" style="background-color: #f0f0f0;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;">
<div id="tabset-43-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-43-1-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Iniciar tiempo de ejecución</span></span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Parámetros a cambiar</span></span>
<span id="cb150-5"><a href="#cb150-5" aria-hidden="true" tabindex="-1"></a>proportion <span class="ot">&lt;-</span> <span class="fl">0.28</span></span>
<span id="cb150-6"><a href="#cb150-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-7"><a href="#cb150-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Configurar la validación cruzada 5x2</span></span>
<span id="cb150-8"><a href="#cb150-8" aria-hidden="true" tabindex="-1"></a>k_outer <span class="ot">&lt;-</span> <span class="dv">5</span>  <span class="co"># Número de pliegues externos</span></span>
<span id="cb150-9"><a href="#cb150-9" aria-hidden="true" tabindex="-1"></a>k_inner <span class="ot">&lt;-</span> <span class="dv">2</span>  <span class="co"># Número de pliegues internos</span></span>
<span id="cb150-10"><a href="#cb150-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-11"><a href="#cb150-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Lista para almacenar resultados</span></span>
<span id="cb150-12"><a href="#cb150-12" aria-hidden="true" tabindex="-1"></a>resultados_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb150-13"><a href="#cb150-13" aria-hidden="true" tabindex="-1"></a>resultados_accuracy <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb150-14"><a href="#cb150-14" aria-hidden="true" tabindex="-1"></a>resultados_sensibilidad <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb150-15"><a href="#cb150-15" aria-hidden="true" tabindex="-1"></a>indices <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data)</span>
<span id="cb150-16"><a href="#cb150-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-17"><a href="#cb150-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Inicializar matrices para almacenar predicciones y objetivos</span></span>
<span id="cb150-18"><a href="#cb150-18" aria-hidden="true" tabindex="-1"></a>predicciones_totales <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">nrow</span>(data), <span class="at">ncol =</span> k_outer)</span>
<span id="cb150-19"><a href="#cb150-19" aria-hidden="true" tabindex="-1"></a>targets_totales <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(data))</span>
<span id="cb150-20"><a href="#cb150-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-21"><a href="#cb150-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterar sobre cada pliegue externo y realizar el proceso de modelado</span></span>
<span id="cb150-22"><a href="#cb150-22" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i_outer <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k_outer) {</span>
<span id="cb150-23"><a href="#cb150-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-24"><a href="#cb150-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Obtener los índices para el pliegue externo actual</span></span>
<span id="cb150-25"><a href="#cb150-25" aria-hidden="true" tabindex="-1"></a>  test_indices_outer <span class="ot">&lt;-</span> indices[folds_outer <span class="sc">==</span> i_outer]  <span class="co"># Índices correspondientes al pliegue externo de test</span></span>
<span id="cb150-26"><a href="#cb150-26" aria-hidden="true" tabindex="-1"></a>  train_indices_outer <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data), test_indices_outer)  <span class="co"># Índices correspondientes al conjunto de entrenamiento</span></span>
<span id="cb150-27"><a href="#cb150-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-28"><a href="#cb150-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Dividir datos en entrenamiento y test para el pliegue externo</span></span>
<span id="cb150-29"><a href="#cb150-29" aria-hidden="true" tabindex="-1"></a>  datos_entrenamiento_outer <span class="ot">&lt;-</span> datafinal[train_indices_outer, ]</span>
<span id="cb150-30"><a href="#cb150-30" aria-hidden="true" tabindex="-1"></a>  datos_test_outer <span class="ot">&lt;-</span> datafinal[test_indices_outer, ]</span>
<span id="cb150-31"><a href="#cb150-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-32"><a href="#cb150-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Configurar la validación cruzada interna</span></span>
<span id="cb150-33"><a href="#cb150-33" aria-hidden="true" tabindex="-1"></a>  folds_inner <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(datos_entrenamiento_outer<span class="sc">$</span>ESTADO_ACTUAL, <span class="at">k =</span> k_inner, <span class="at">list =</span> <span class="cn">FALSE</span>)  <span class="co"># Obtener índices de pliegues internos</span></span>
<span id="cb150-34"><a href="#cb150-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-35"><a href="#cb150-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Almacenar predicciones y objetivos para el AUC general</span></span>
<span id="cb150-36"><a href="#cb150-36" aria-hidden="true" tabindex="-1"></a>  predicciones_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(datos_entrenamiento_outer))</span>
<span id="cb150-37"><a href="#cb150-37" aria-hidden="true" tabindex="-1"></a>  targets_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(datos_entrenamiento_outer))</span>
<span id="cb150-38"><a href="#cb150-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-39"><a href="#cb150-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Inicializar variables para almacenar resultados internos</span></span>
<span id="cb150-40"><a href="#cb150-40" aria-hidden="true" tabindex="-1"></a>  resultados_auc_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb150-41"><a href="#cb150-41" aria-hidden="true" tabindex="-1"></a>  resultados_accuracy_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb150-42"><a href="#cb150-42" aria-hidden="true" tabindex="-1"></a>  resultados_sensibilidad_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb150-43"><a href="#cb150-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-44"><a href="#cb150-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Iterar sobre cada pliegue interno para selección de modelo</span></span>
<span id="cb150-45"><a href="#cb150-45" aria-hidden="true" tabindex="-1"></a>  indices_inner <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(datos_entrenamiento_outer)</span>
<span id="cb150-46"><a href="#cb150-46" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i_inner <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k_inner) {</span>
<span id="cb150-47"><a href="#cb150-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Obtener los índices para el pliegue interno actual</span></span>
<span id="cb150-48"><a href="#cb150-48" aria-hidden="true" tabindex="-1"></a>    test_indices_inner <span class="ot">&lt;-</span> indices_inner[folds_inner <span class="sc">==</span> i_inner]  <span class="co"># Índices correspondientes al pliegue interno de test</span></span>
<span id="cb150-49"><a href="#cb150-49" aria-hidden="true" tabindex="-1"></a>    train_indices_inner <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(datos_entrenamiento_outer), test_indices_inner)  <span class="co"># Índices correspondientes al conjunto de entrenamiento interno</span></span>
<span id="cb150-50"><a href="#cb150-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb150-51"><a href="#cb150-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Dividir datos en entrenamiento y test para el pliegue interno</span></span>
<span id="cb150-52"><a href="#cb150-52" aria-hidden="true" tabindex="-1"></a>    datos_entrenamiento_inner <span class="ot">&lt;-</span> datos_entrenamiento_outer[train_indices_inner, ]</span>
<span id="cb150-53"><a href="#cb150-53" aria-hidden="true" tabindex="-1"></a>    datos_validacion <span class="ot">&lt;-</span> datos_entrenamiento_outer[test_indices_inner, ]</span>
<span id="cb150-54"><a href="#cb150-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb150-55"><a href="#cb150-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Almacenar predicciones y objetivos para el AUC interno</span></span>
<span id="cb150-56"><a href="#cb150-56" aria-hidden="true" tabindex="-1"></a>    predicciones_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(datos_validacion))</span>
<span id="cb150-57"><a href="#cb150-57" aria-hidden="true" tabindex="-1"></a>    targets_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(datos_validacion))</span>
<span id="cb150-58"><a href="#cb150-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb150-59"><a href="#cb150-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Definir todas las combinaciones de variables (sustituye esto por tus combinaciones reales)</span></span>
<span id="cb150-60"><a href="#cb150-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-61"><a href="#cb150-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb150-62"><a href="#cb150-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb150-63"><a href="#cb150-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aplicar oversampling en el conjunto de entrenamiento interno</span></span>
<span id="cb150-64"><a href="#cb150-64" aria-hidden="true" tabindex="-1"></a>    datos_entrenamiento_oversampled <span class="ot">&lt;-</span> <span class="fu">ROSE</span>(ESTADO_ACTUAL <span class="sc">~</span> ., <span class="at">data =</span> datos_entrenamiento_inner, <span class="at">p =</span> proportion)<span class="sc">$</span>data</span>
<span id="cb150-65"><a href="#cb150-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb150-66"><a href="#cb150-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb150-67"><a href="#cb150-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Entrenar el modelo Naive Bayes</span></span>
<span id="cb150-68"><a href="#cb150-68" aria-hidden="true" tabindex="-1"></a>    modelo <span class="ot">&lt;-</span> <span class="fu">naiveBayes</span>(ESTADO_ACTUAL <span class="sc">~</span> ., <span class="at">data =</span> datos_entrenamiento_oversampled)</span>
<span id="cb150-69"><a href="#cb150-69" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb150-70"><a href="#cb150-70" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Realizar predicciones con probabilidades en datos de validación</span></span>
<span id="cb150-71"><a href="#cb150-71" aria-hidden="true" tabindex="-1"></a>    predicciones_validacion_prob <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelo, <span class="at">newdata =</span> datos_validacion, <span class="at">type =</span> <span class="st">"raw"</span>)[,<span class="dv">2</span>]</span>
<span id="cb150-72"><a href="#cb150-72" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb150-73"><a href="#cb150-73" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calcular el AUC</span></span>
<span id="cb150-74"><a href="#cb150-74" aria-hidden="true" tabindex="-1"></a>    roc_obj <span class="ot">&lt;-</span> <span class="fu">roc</span>(datos_validacion<span class="sc">$</span>ESTADO_ACTUAL, predicciones_validacion_prob, <span class="at">levels =</span> <span class="fu">rev</span>(<span class="fu">levels</span>(datos_validacion<span class="sc">$</span>ESTADO_ACTUAL)))</span>
<span id="cb150-75"><a href="#cb150-75" aria-hidden="true" tabindex="-1"></a>    auc_actual <span class="ot">&lt;-</span> <span class="fu">auc</span>(roc_obj)</span>
<span id="cb150-76"><a href="#cb150-76" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb150-77"><a href="#cb150-77" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Almacenar las predicciones y objetivos</span></span>
<span id="cb150-78"><a href="#cb150-78" aria-hidden="true" tabindex="-1"></a>    predicciones_auc[test_indices_inner] <span class="ot">&lt;-</span> predicciones_validacion_prob</span>
<span id="cb150-79"><a href="#cb150-79" aria-hidden="true" tabindex="-1"></a>    targets_auc[test_indices_inner] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(datos_validacion<span class="sc">$</span>ESTADO_ACTUAL) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb150-80"><a href="#cb150-80" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb150-81"><a href="#cb150-81" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calcular la sensibilidad y la precisión</span></span>
<span id="cb150-82"><a href="#cb150-82" aria-hidden="true" tabindex="-1"></a>    umbral <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb150-83"><a href="#cb150-83" aria-hidden="true" tabindex="-1"></a>    predicciones_finales <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predicciones_validacion_prob <span class="sc">&gt;=</span> umbral, <span class="st">"SI"</span>, <span class="st">"NO"</span>)</span>
<span id="cb150-84"><a href="#cb150-84" aria-hidden="true" tabindex="-1"></a>    TP <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_finales <span class="sc">==</span> <span class="st">"SI"</span> <span class="sc">&amp;</span> datos_validacion<span class="sc">$</span>ESTADO_ACTUAL <span class="sc">==</span> <span class="st">"SI"</span>)</span>
<span id="cb150-85"><a href="#cb150-85" aria-hidden="true" tabindex="-1"></a>    FN <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_finales <span class="sc">==</span> <span class="st">"NO"</span> <span class="sc">&amp;</span> datos_validacion<span class="sc">$</span>ESTADO_ACTUAL <span class="sc">==</span> <span class="st">"SI"</span>)</span>
<span id="cb150-86"><a href="#cb150-86" aria-hidden="true" tabindex="-1"></a>    FP <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_finales <span class="sc">==</span> <span class="st">"SI"</span> <span class="sc">&amp;</span> datos_validacion<span class="sc">$</span>ESTADO_ACTUAL <span class="sc">==</span> <span class="st">"NO"</span>)</span>
<span id="cb150-87"><a href="#cb150-87" aria-hidden="true" tabindex="-1"></a>    TN <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_finales <span class="sc">==</span> <span class="st">"NO"</span> <span class="sc">&amp;</span> datos_validacion<span class="sc">$</span>ESTADO_ACTUAL <span class="sc">==</span> <span class="st">"NO"</span>)</span>
<span id="cb150-88"><a href="#cb150-88" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb150-89"><a href="#cb150-89" aria-hidden="true" tabindex="-1"></a>    recall_actual <span class="ot">&lt;-</span> TP <span class="sc">/</span> (TP <span class="sc">+</span> FN)</span>
<span id="cb150-90"><a href="#cb150-90" aria-hidden="true" tabindex="-1"></a>    accuracy_actual <span class="ot">&lt;-</span> (TP <span class="sc">+</span> TN) <span class="sc">/</span> (TP <span class="sc">+</span> FN <span class="sc">+</span> FP <span class="sc">+</span> TN)</span>
<span id="cb150-91"><a href="#cb150-91" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb150-92"><a href="#cb150-92" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Almacenar resultados internos</span></span>
<span id="cb150-93"><a href="#cb150-93" aria-hidden="true" tabindex="-1"></a>    resultados_sensibilidad_inner[i_inner] <span class="ot">&lt;-</span> recall_actual</span>
<span id="cb150-94"><a href="#cb150-94" aria-hidden="true" tabindex="-1"></a>    resultados_accuracy_inner[i_inner] <span class="ot">&lt;-</span> accuracy_actual</span>
<span id="cb150-95"><a href="#cb150-95" aria-hidden="true" tabindex="-1"></a>    resultados_auc_inner[i_inner] <span class="ot">&lt;-</span> auc_actual</span>
<span id="cb150-96"><a href="#cb150-96" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-97"><a href="#cb150-97" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb150-98"><a href="#cb150-98" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-99"><a href="#cb150-99" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular el AUC final para este pliegue externo</span></span>
<span id="cb150-100"><a href="#cb150-100" aria-hidden="true" tabindex="-1"></a>  auc_fold_externo <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_auc_inner)</span>
<span id="cb150-101"><a href="#cb150-101" aria-hidden="true" tabindex="-1"></a>  accuracy_fold_externo <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_accuracy_inner)</span>
<span id="cb150-102"><a href="#cb150-102" aria-hidden="true" tabindex="-1"></a>  sensibilidad_fold_externo <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_sensibilidad_inner)</span>
<span id="cb150-103"><a href="#cb150-103" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-104"><a href="#cb150-104" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Almacenar el AUC del fold externo actual</span></span>
<span id="cb150-105"><a href="#cb150-105" aria-hidden="true" tabindex="-1"></a>  resultados_auc[i_outer] <span class="ot">&lt;-</span> auc_fold_externo</span>
<span id="cb150-106"><a href="#cb150-106" aria-hidden="true" tabindex="-1"></a>  resultados_accuracy[i_outer] <span class="ot">&lt;-</span> accuracy_fold_externo</span>
<span id="cb150-107"><a href="#cb150-107" aria-hidden="true" tabindex="-1"></a>  resultados_sensibilidad[i_outer] <span class="ot">&lt;-</span> sensibilidad_fold_externo</span>
<span id="cb150-108"><a href="#cb150-108" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-109"><a href="#cb150-109" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Predecir en los datos de test para este pliegue externo y almacenar predicciones</span></span>
<span id="cb150-110"><a href="#cb150-110" aria-hidden="true" tabindex="-1"></a>  <span class="co"># (Aquí deberías hacer la predicción usando el mejor modelo encontrado en el bucle interno)</span></span>
<span id="cb150-111"><a href="#cb150-111" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb150-112"><a href="#cb150-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-113"><a href="#cb150-113" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular AUC promedio</span></span>
<span id="cb150-114"><a href="#cb150-114" aria-hidden="true" tabindex="-1"></a>auc_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_auc)</span>
<span id="cb150-115"><a href="#cb150-115" aria-hidden="true" tabindex="-1"></a>accuracy_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_accuracy)</span>
<span id="cb150-116"><a href="#cb150-116" aria-hidden="true" tabindex="-1"></a>sensibilidad_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_sensibilidad)</span>
<span id="cb150-117"><a href="#cb150-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-118"><a href="#cb150-118" aria-hidden="true" tabindex="-1"></a>tabla_metricas <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb150-119"><a href="#cb150-119" aria-hidden="true" tabindex="-1"></a>  <span class="at">Pliegue =</span> <span class="dv">1</span><span class="sc">:</span>k_outer,</span>
<span id="cb150-120"><a href="#cb150-120" aria-hidden="true" tabindex="-1"></a>  <span class="at">AUC =</span> <span class="fu">sapply</span>(resultados_auc, round, <span class="at">digits =</span> <span class="dv">3</span>),</span>
<span id="cb150-121"><a href="#cb150-121" aria-hidden="true" tabindex="-1"></a>  <span class="at">Accuracy =</span> <span class="fu">sapply</span>(resultados_accuracy, round, <span class="at">digits =</span> <span class="dv">3</span>),</span>
<span id="cb150-122"><a href="#cb150-122" aria-hidden="true" tabindex="-1"></a>  <span class="at">Recall =</span> <span class="fu">sapply</span>(resultados_sensibilidad, round, <span class="at">digits =</span> <span class="dv">3</span>)</span>
<span id="cb150-123"><a href="#cb150-123" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb150-124"><a href="#cb150-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-125"><a href="#cb150-125" aria-hidden="true" tabindex="-1"></a><span class="co"># Agregar fila con promedio de métricas</span></span>
<span id="cb150-126"><a href="#cb150-126" aria-hidden="true" tabindex="-1"></a>tabla_metricas_naive_52 <span class="ot">&lt;-</span> <span class="fu">rbind</span>(tabla_metricas, <span class="fu">c</span>(<span class="st">"Mean"</span>, <span class="fu">round</span>(auc_promedio, <span class="dv">3</span>), <span class="fu">round</span>(accuracy_promedio, <span class="dv">3</span>), <span class="fu">round</span>(sensibilidad_promedio, <span class="dv">3</span>)))</span>
<span id="cb150-127"><a href="#cb150-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-128"><a href="#cb150-128" aria-hidden="true" tabindex="-1"></a><span class="co"># Detener el tiempo de ejecución</span></span>
<span id="cb150-129"><a href="#cb150-129" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb150-130"><a href="#cb150-130" aria-hidden="true" tabindex="-1"></a>execution_time_naive <span class="ot">&lt;-</span> end_time <span class="sc">-</span> start_time</span>
<span id="cb150-131"><a href="#cb150-131" aria-hidden="true" tabindex="-1"></a>execution_time_naive52 <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(execution_time_naive, <span class="at">units =</span> <span class="st">"secs"</span>)</span>
<span id="cb150-132"><a href="#cb150-132" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(tabla_metricas_naive_52, <span class="at">file =</span> <span class="st">"tabla_metricas_naive_52.RData"</span>)</span>
<span id="cb150-133"><a href="#cb150-133" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(execution_time_naive52, <span class="at">file =</span> <span class="st">"execution_time_naive_filter52.RData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"tabla_metricas_naive_52.RData"</span>)</span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"execution_time_naive_filter52.RData"</span>)</span>
<span id="cb151-3"><a href="#cb151-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir el tiempo de ejecución</span></span>
<span id="cb151-4"><a href="#cb151-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-5"><a href="#cb151-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time_naive52,  <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-39-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-39-1" role="tab" aria-controls="tabset-39-1" aria-selected="true" href="">Metrics Table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-39-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-39-2" role="tab" aria-controls="tabset-39-2" aria-selected="false" href="">Metrics Plot</a></li></ul>
<div class="tab-content">
<div id="tabset-39-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-39-1-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir tabla formateada con kableExtra</span></span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(tabla_metricas_naive_52, <span class="at">caption =</span> <span class="st">"Cross Validation Metrics"</span>, <span class="at">align =</span> <span class="st">"c"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="tabset-39-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-39-2-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="fu">crear_plot_metricas_per_fold</span>(tabla_metricas_naive_52)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div id="tabset-43-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-43-2-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Iniciar tiempo de ejecución</span></span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-4"><a href="#cb154-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Parámetros a cambiar</span></span>
<span id="cb154-5"><a href="#cb154-5" aria-hidden="true" tabindex="-1"></a>proportion <span class="ot">&lt;-</span> <span class="fl">0.28</span></span>
<span id="cb154-6"><a href="#cb154-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-7"><a href="#cb154-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Configurar la validación cruzada 5x2</span></span>
<span id="cb154-8"><a href="#cb154-8" aria-hidden="true" tabindex="-1"></a>k_outer <span class="ot">&lt;-</span> <span class="dv">10</span>  <span class="co"># Número de pliegues externos</span></span>
<span id="cb154-9"><a href="#cb154-9" aria-hidden="true" tabindex="-1"></a>k_inner <span class="ot">&lt;-</span> <span class="dv">2</span>  <span class="co"># Número de pliegues internos</span></span>
<span id="cb154-10"><a href="#cb154-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-11"><a href="#cb154-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Lista para almacenar resultados</span></span>
<span id="cb154-12"><a href="#cb154-12" aria-hidden="true" tabindex="-1"></a>resultados_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb154-13"><a href="#cb154-13" aria-hidden="true" tabindex="-1"></a>resultados_accuracy <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb154-14"><a href="#cb154-14" aria-hidden="true" tabindex="-1"></a>resultados_sensibilidad <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb154-15"><a href="#cb154-15" aria-hidden="true" tabindex="-1"></a>indices <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data)</span>
<span id="cb154-16"><a href="#cb154-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-17"><a href="#cb154-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Inicializar matrices para almacenar predicciones y objetivos</span></span>
<span id="cb154-18"><a href="#cb154-18" aria-hidden="true" tabindex="-1"></a>predicciones_totales <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">nrow</span>(data), <span class="at">ncol =</span> k_outer)</span>
<span id="cb154-19"><a href="#cb154-19" aria-hidden="true" tabindex="-1"></a>targets_totales <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(data))</span>
<span id="cb154-20"><a href="#cb154-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-21"><a href="#cb154-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterar sobre cada pliegue externo y realizar el proceso de modelado</span></span>
<span id="cb154-22"><a href="#cb154-22" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i_outer <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k_outer) {</span>
<span id="cb154-23"><a href="#cb154-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-24"><a href="#cb154-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Obtener los índices para el pliegue externo actual</span></span>
<span id="cb154-25"><a href="#cb154-25" aria-hidden="true" tabindex="-1"></a>  test_indices_outer <span class="ot">&lt;-</span> indices[folds_outer <span class="sc">==</span> i_outer]  <span class="co"># Índices correspondientes al pliegue externo de test</span></span>
<span id="cb154-26"><a href="#cb154-26" aria-hidden="true" tabindex="-1"></a>  train_indices_outer <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data), test_indices_outer)  <span class="co"># Índices correspondientes al conjunto de entrenamiento</span></span>
<span id="cb154-27"><a href="#cb154-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-28"><a href="#cb154-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Dividir datos en entrenamiento y test para el pliegue externo</span></span>
<span id="cb154-29"><a href="#cb154-29" aria-hidden="true" tabindex="-1"></a>  datos_entrenamiento_outer <span class="ot">&lt;-</span> datafinal[train_indices_outer, ]</span>
<span id="cb154-30"><a href="#cb154-30" aria-hidden="true" tabindex="-1"></a>  datos_test_outer <span class="ot">&lt;-</span> datafinal[test_indices_outer, ]</span>
<span id="cb154-31"><a href="#cb154-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-32"><a href="#cb154-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Configurar la validación cruzada interna</span></span>
<span id="cb154-33"><a href="#cb154-33" aria-hidden="true" tabindex="-1"></a>  folds_inner <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(datos_entrenamiento_outer<span class="sc">$</span>ESTADO_ACTUAL, <span class="at">k =</span> k_inner, <span class="at">list =</span> <span class="cn">FALSE</span>)  <span class="co"># Obtener índices de pliegues internos</span></span>
<span id="cb154-34"><a href="#cb154-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-35"><a href="#cb154-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Almacenar predicciones y objetivos para el AUC general</span></span>
<span id="cb154-36"><a href="#cb154-36" aria-hidden="true" tabindex="-1"></a>  predicciones_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(datos_entrenamiento_outer))</span>
<span id="cb154-37"><a href="#cb154-37" aria-hidden="true" tabindex="-1"></a>  targets_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(datos_entrenamiento_outer))</span>
<span id="cb154-38"><a href="#cb154-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-39"><a href="#cb154-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Inicializar variables para almacenar resultados internos</span></span>
<span id="cb154-40"><a href="#cb154-40" aria-hidden="true" tabindex="-1"></a>  resultados_auc_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb154-41"><a href="#cb154-41" aria-hidden="true" tabindex="-1"></a>  resultados_accuracy_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb154-42"><a href="#cb154-42" aria-hidden="true" tabindex="-1"></a>  resultados_sensibilidad_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb154-43"><a href="#cb154-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-44"><a href="#cb154-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Iterar sobre cada pliegue interno para selección de modelo</span></span>
<span id="cb154-45"><a href="#cb154-45" aria-hidden="true" tabindex="-1"></a>  indices_inner <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(datos_entrenamiento_outer)</span>
<span id="cb154-46"><a href="#cb154-46" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i_inner <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k_inner) {</span>
<span id="cb154-47"><a href="#cb154-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Obtener los índices para el pliegue interno actual</span></span>
<span id="cb154-48"><a href="#cb154-48" aria-hidden="true" tabindex="-1"></a>    test_indices_inner <span class="ot">&lt;-</span> indices_inner[folds_inner <span class="sc">==</span> i_inner]  <span class="co"># Índices correspondientes al pliegue interno de test</span></span>
<span id="cb154-49"><a href="#cb154-49" aria-hidden="true" tabindex="-1"></a>    train_indices_inner <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(datos_entrenamiento_outer), test_indices_inner)  <span class="co"># Índices correspondientes al conjunto de entrenamiento interno</span></span>
<span id="cb154-50"><a href="#cb154-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb154-51"><a href="#cb154-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Dividir datos en entrenamiento y test para el pliegue interno</span></span>
<span id="cb154-52"><a href="#cb154-52" aria-hidden="true" tabindex="-1"></a>    datos_entrenamiento_inner <span class="ot">&lt;-</span> datos_entrenamiento_outer[train_indices_inner, ]</span>
<span id="cb154-53"><a href="#cb154-53" aria-hidden="true" tabindex="-1"></a>    datos_validacion <span class="ot">&lt;-</span> datos_entrenamiento_outer[test_indices_inner, ]</span>
<span id="cb154-54"><a href="#cb154-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb154-55"><a href="#cb154-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Almacenar predicciones y objetivos para el AUC interno</span></span>
<span id="cb154-56"><a href="#cb154-56" aria-hidden="true" tabindex="-1"></a>    predicciones_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(datos_validacion))</span>
<span id="cb154-57"><a href="#cb154-57" aria-hidden="true" tabindex="-1"></a>    targets_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(datos_validacion))</span>
<span id="cb154-58"><a href="#cb154-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb154-59"><a href="#cb154-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Definir todas las combinaciones de variables (sustituye esto por tus combinaciones reales)</span></span>
<span id="cb154-60"><a href="#cb154-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-61"><a href="#cb154-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb154-62"><a href="#cb154-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb154-63"><a href="#cb154-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aplicar oversampling en el conjunto de entrenamiento interno</span></span>
<span id="cb154-64"><a href="#cb154-64" aria-hidden="true" tabindex="-1"></a>    datos_entrenamiento_oversampled <span class="ot">&lt;-</span> <span class="fu">ROSE</span>(ESTADO_ACTUAL <span class="sc">~</span> ., <span class="at">data =</span> datos_entrenamiento_inner, <span class="at">p =</span> proportion)<span class="sc">$</span>data</span>
<span id="cb154-65"><a href="#cb154-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb154-66"><a href="#cb154-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb154-67"><a href="#cb154-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Entrenar el modelo Naive Bayes</span></span>
<span id="cb154-68"><a href="#cb154-68" aria-hidden="true" tabindex="-1"></a>    modelo <span class="ot">&lt;-</span> <span class="fu">naiveBayes</span>(ESTADO_ACTUAL <span class="sc">~</span> ., <span class="at">data =</span> datos_entrenamiento_oversampled)</span>
<span id="cb154-69"><a href="#cb154-69" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb154-70"><a href="#cb154-70" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Realizar predicciones con probabilidades en datos de validación</span></span>
<span id="cb154-71"><a href="#cb154-71" aria-hidden="true" tabindex="-1"></a>    predicciones_validacion_prob <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelo, <span class="at">newdata =</span> datos_validacion, <span class="at">type =</span> <span class="st">"raw"</span>)[,<span class="dv">2</span>]</span>
<span id="cb154-72"><a href="#cb154-72" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb154-73"><a href="#cb154-73" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calcular el AUC</span></span>
<span id="cb154-74"><a href="#cb154-74" aria-hidden="true" tabindex="-1"></a>    roc_obj <span class="ot">&lt;-</span> <span class="fu">roc</span>(datos_validacion<span class="sc">$</span>ESTADO_ACTUAL, predicciones_validacion_prob, <span class="at">levels =</span> <span class="fu">rev</span>(<span class="fu">levels</span>(datos_validacion<span class="sc">$</span>ESTADO_ACTUAL)))</span>
<span id="cb154-75"><a href="#cb154-75" aria-hidden="true" tabindex="-1"></a>    auc_actual <span class="ot">&lt;-</span> <span class="fu">auc</span>(roc_obj)</span>
<span id="cb154-76"><a href="#cb154-76" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb154-77"><a href="#cb154-77" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Almacenar las predicciones y objetivos</span></span>
<span id="cb154-78"><a href="#cb154-78" aria-hidden="true" tabindex="-1"></a>    predicciones_auc[test_indices_inner] <span class="ot">&lt;-</span> predicciones_validacion_prob</span>
<span id="cb154-79"><a href="#cb154-79" aria-hidden="true" tabindex="-1"></a>    targets_auc[test_indices_inner] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(datos_validacion<span class="sc">$</span>ESTADO_ACTUAL) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb154-80"><a href="#cb154-80" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb154-81"><a href="#cb154-81" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calcular la sensibilidad y la precisión</span></span>
<span id="cb154-82"><a href="#cb154-82" aria-hidden="true" tabindex="-1"></a>    umbral <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb154-83"><a href="#cb154-83" aria-hidden="true" tabindex="-1"></a>    predicciones_finales <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predicciones_validacion_prob <span class="sc">&gt;=</span> umbral, <span class="st">"SI"</span>, <span class="st">"NO"</span>)</span>
<span id="cb154-84"><a href="#cb154-84" aria-hidden="true" tabindex="-1"></a>    TP <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_finales <span class="sc">==</span> <span class="st">"SI"</span> <span class="sc">&amp;</span> datos_validacion<span class="sc">$</span>ESTADO_ACTUAL <span class="sc">==</span> <span class="st">"SI"</span>)</span>
<span id="cb154-85"><a href="#cb154-85" aria-hidden="true" tabindex="-1"></a>    FN <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_finales <span class="sc">==</span> <span class="st">"NO"</span> <span class="sc">&amp;</span> datos_validacion<span class="sc">$</span>ESTADO_ACTUAL <span class="sc">==</span> <span class="st">"SI"</span>)</span>
<span id="cb154-86"><a href="#cb154-86" aria-hidden="true" tabindex="-1"></a>    FP <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_finales <span class="sc">==</span> <span class="st">"SI"</span> <span class="sc">&amp;</span> datos_validacion<span class="sc">$</span>ESTADO_ACTUAL <span class="sc">==</span> <span class="st">"NO"</span>)</span>
<span id="cb154-87"><a href="#cb154-87" aria-hidden="true" tabindex="-1"></a>    TN <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_finales <span class="sc">==</span> <span class="st">"NO"</span> <span class="sc">&amp;</span> datos_validacion<span class="sc">$</span>ESTADO_ACTUAL <span class="sc">==</span> <span class="st">"NO"</span>)</span>
<span id="cb154-88"><a href="#cb154-88" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb154-89"><a href="#cb154-89" aria-hidden="true" tabindex="-1"></a>    recall_actual <span class="ot">&lt;-</span> TP <span class="sc">/</span> (TP <span class="sc">+</span> FN)</span>
<span id="cb154-90"><a href="#cb154-90" aria-hidden="true" tabindex="-1"></a>    accuracy_actual <span class="ot">&lt;-</span> (TP <span class="sc">+</span> TN) <span class="sc">/</span> (TP <span class="sc">+</span> FN <span class="sc">+</span> FP <span class="sc">+</span> TN)</span>
<span id="cb154-91"><a href="#cb154-91" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb154-92"><a href="#cb154-92" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Almacenar resultados internos</span></span>
<span id="cb154-93"><a href="#cb154-93" aria-hidden="true" tabindex="-1"></a>    resultados_sensibilidad_inner[i_inner] <span class="ot">&lt;-</span> recall_actual</span>
<span id="cb154-94"><a href="#cb154-94" aria-hidden="true" tabindex="-1"></a>    resultados_accuracy_inner[i_inner] <span class="ot">&lt;-</span> accuracy_actual</span>
<span id="cb154-95"><a href="#cb154-95" aria-hidden="true" tabindex="-1"></a>    resultados_auc_inner[i_inner] <span class="ot">&lt;-</span> auc_actual</span>
<span id="cb154-96"><a href="#cb154-96" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-97"><a href="#cb154-97" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb154-98"><a href="#cb154-98" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-99"><a href="#cb154-99" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular el AUC final para este pliegue externo</span></span>
<span id="cb154-100"><a href="#cb154-100" aria-hidden="true" tabindex="-1"></a>  auc_fold_externo <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_auc_inner)</span>
<span id="cb154-101"><a href="#cb154-101" aria-hidden="true" tabindex="-1"></a>  accuracy_fold_externo <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_accuracy_inner)</span>
<span id="cb154-102"><a href="#cb154-102" aria-hidden="true" tabindex="-1"></a>  sensibilidad_fold_externo <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_sensibilidad_inner)</span>
<span id="cb154-103"><a href="#cb154-103" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-104"><a href="#cb154-104" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Almacenar el AUC del fold externo actual</span></span>
<span id="cb154-105"><a href="#cb154-105" aria-hidden="true" tabindex="-1"></a>  resultados_auc[i_outer] <span class="ot">&lt;-</span> auc_fold_externo</span>
<span id="cb154-106"><a href="#cb154-106" aria-hidden="true" tabindex="-1"></a>  resultados_accuracy[i_outer] <span class="ot">&lt;-</span> accuracy_fold_externo</span>
<span id="cb154-107"><a href="#cb154-107" aria-hidden="true" tabindex="-1"></a>  resultados_sensibilidad[i_outer] <span class="ot">&lt;-</span> sensibilidad_fold_externo</span>
<span id="cb154-108"><a href="#cb154-108" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-109"><a href="#cb154-109" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Predecir en los datos de test para este pliegue externo y almacenar predicciones</span></span>
<span id="cb154-110"><a href="#cb154-110" aria-hidden="true" tabindex="-1"></a>  <span class="co"># (Aquí deberías hacer la predicción usando el mejor modelo encontrado en el bucle interno)</span></span>
<span id="cb154-111"><a href="#cb154-111" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb154-112"><a href="#cb154-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-113"><a href="#cb154-113" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular AUC promedio</span></span>
<span id="cb154-114"><a href="#cb154-114" aria-hidden="true" tabindex="-1"></a>auc_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_auc)</span>
<span id="cb154-115"><a href="#cb154-115" aria-hidden="true" tabindex="-1"></a>accuracy_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_accuracy)</span>
<span id="cb154-116"><a href="#cb154-116" aria-hidden="true" tabindex="-1"></a>sensibilidad_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_sensibilidad)</span>
<span id="cb154-117"><a href="#cb154-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-118"><a href="#cb154-118" aria-hidden="true" tabindex="-1"></a>tabla_metricas <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb154-119"><a href="#cb154-119" aria-hidden="true" tabindex="-1"></a>  <span class="at">Pliegue =</span> <span class="dv">1</span><span class="sc">:</span>k_outer,</span>
<span id="cb154-120"><a href="#cb154-120" aria-hidden="true" tabindex="-1"></a>  <span class="at">AUC =</span> <span class="fu">sapply</span>(resultados_auc, round, <span class="at">digits =</span> <span class="dv">3</span>),</span>
<span id="cb154-121"><a href="#cb154-121" aria-hidden="true" tabindex="-1"></a>  <span class="at">Accuracy =</span> <span class="fu">sapply</span>(resultados_accuracy, round, <span class="at">digits =</span> <span class="dv">3</span>),</span>
<span id="cb154-122"><a href="#cb154-122" aria-hidden="true" tabindex="-1"></a>  <span class="at">Recall =</span> <span class="fu">sapply</span>(resultados_sensibilidad, round, <span class="at">digits =</span> <span class="dv">3</span>)</span>
<span id="cb154-123"><a href="#cb154-123" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb154-124"><a href="#cb154-124" aria-hidden="true" tabindex="-1"></a><span class="co"># Agregar fila con promedio de métricas</span></span>
<span id="cb154-125"><a href="#cb154-125" aria-hidden="true" tabindex="-1"></a>tabla_metricas_naive12 <span class="ot">&lt;-</span> <span class="fu">rbind</span>(tabla_metricas, <span class="fu">c</span>(<span class="st">"Mean"</span>, <span class="fu">round</span>(auc_promedio, <span class="dv">3</span>), <span class="fu">round</span>(accuracy_promedio, <span class="dv">3</span>), <span class="fu">round</span>(sensibilidad_promedio, <span class="dv">3</span>)))</span>
<span id="cb154-126"><a href="#cb154-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-127"><a href="#cb154-127" aria-hidden="true" tabindex="-1"></a><span class="co"># Detener el tiempo de ejecución</span></span>
<span id="cb154-128"><a href="#cb154-128" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb154-129"><a href="#cb154-129" aria-hidden="true" tabindex="-1"></a>execution_time_naive <span class="ot">&lt;-</span> end_time <span class="sc">-</span> start_time</span>
<span id="cb154-130"><a href="#cb154-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-131"><a href="#cb154-131" aria-hidden="true" tabindex="-1"></a>execution_time_naive12 <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(execution_time_naive, <span class="at">units =</span> <span class="st">"secs"</span>)</span>
<span id="cb154-132"><a href="#cb154-132" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(tabla_metricas_naive12, <span class="at">file =</span> <span class="st">"tabla_metricas_naive_filter12.RData"</span>)</span>
<span id="cb154-133"><a href="#cb154-133" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(execution_time_naive12, <span class="at">file =</span> <span class="st">"execution_time_naive_filter12.RData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"tabla_metricas_naive_filter12.RData"</span>)</span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"execution_time_naive_filter12.RData"</span>)</span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir el tiempo de ejecución</span></span>
<span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time_naive12,  <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-40-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-40-1" role="tab" aria-controls="tabset-40-1" aria-selected="true" href="">Metrics Table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-40-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-40-2" role="tab" aria-controls="tabset-40-2" aria-selected="false" href="">Metrics Plot</a></li></ul>
<div class="tab-content">
<div id="tabset-40-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-40-1-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir tabla formateada con kableExtra</span></span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(tabla_metricas_naive12, <span class="at">caption =</span> <span class="st">"Cross Validation Metrics"</span>, <span class="at">align =</span> <span class="st">"c"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="tabset-40-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-40-2-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb157"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="fu">crear_plot_metricas_per_fold</span>(tabla_metricas_naive12)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div id="tabset-43-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-43-3-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Iniciar tiempo de ejecución</span></span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb158-3"><a href="#cb158-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-4"><a href="#cb158-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Parámetros a cambiar</span></span>
<span id="cb158-5"><a href="#cb158-5" aria-hidden="true" tabindex="-1"></a>proportion <span class="ot">&lt;-</span> <span class="fl">0.28</span></span>
<span id="cb158-6"><a href="#cb158-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-7"><a href="#cb158-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Configurar la validación cruzada 5x2</span></span>
<span id="cb158-8"><a href="#cb158-8" aria-hidden="true" tabindex="-1"></a>k_outer <span class="ot">&lt;-</span> <span class="dv">10</span>  <span class="co"># Número de pliegues externos</span></span>
<span id="cb158-9"><a href="#cb158-9" aria-hidden="true" tabindex="-1"></a>k_inner <span class="ot">&lt;-</span> <span class="dv">5</span>  <span class="co"># Número de pliegues internos</span></span>
<span id="cb158-10"><a href="#cb158-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-11"><a href="#cb158-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Lista para almacenar resultados</span></span>
<span id="cb158-12"><a href="#cb158-12" aria-hidden="true" tabindex="-1"></a>resultados_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb158-13"><a href="#cb158-13" aria-hidden="true" tabindex="-1"></a>resultados_accuracy <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb158-14"><a href="#cb158-14" aria-hidden="true" tabindex="-1"></a>resultados_sensibilidad <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb158-15"><a href="#cb158-15" aria-hidden="true" tabindex="-1"></a>indices <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data)</span>
<span id="cb158-16"><a href="#cb158-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-17"><a href="#cb158-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Inicializar matrices para almacenar predicciones y objetivos</span></span>
<span id="cb158-18"><a href="#cb158-18" aria-hidden="true" tabindex="-1"></a>predicciones_totales <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">nrow</span>(data), <span class="at">ncol =</span> k_outer)</span>
<span id="cb158-19"><a href="#cb158-19" aria-hidden="true" tabindex="-1"></a>targets_totales <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(data))</span>
<span id="cb158-20"><a href="#cb158-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-21"><a href="#cb158-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterar sobre cada pliegue externo y realizar el proceso de modelado</span></span>
<span id="cb158-22"><a href="#cb158-22" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i_outer <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k_outer) {</span>
<span id="cb158-23"><a href="#cb158-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb158-24"><a href="#cb158-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Obtener los índices para el pliegue externo actual</span></span>
<span id="cb158-25"><a href="#cb158-25" aria-hidden="true" tabindex="-1"></a>  test_indices_outer <span class="ot">&lt;-</span> indices[folds_outer <span class="sc">==</span> i_outer]  <span class="co"># Índices correspondientes al pliegue externo de test</span></span>
<span id="cb158-26"><a href="#cb158-26" aria-hidden="true" tabindex="-1"></a>  train_indices_outer <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data), test_indices_outer)  <span class="co"># Índices correspondientes al conjunto de entrenamiento</span></span>
<span id="cb158-27"><a href="#cb158-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb158-28"><a href="#cb158-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Dividir datos en entrenamiento y test para el pliegue externo</span></span>
<span id="cb158-29"><a href="#cb158-29" aria-hidden="true" tabindex="-1"></a>  datos_entrenamiento_outer <span class="ot">&lt;-</span> datafinal[train_indices_outer, ]</span>
<span id="cb158-30"><a href="#cb158-30" aria-hidden="true" tabindex="-1"></a>  datos_test_outer <span class="ot">&lt;-</span> datafinal[test_indices_outer, ]</span>
<span id="cb158-31"><a href="#cb158-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb158-32"><a href="#cb158-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Configurar la validación cruzada interna</span></span>
<span id="cb158-33"><a href="#cb158-33" aria-hidden="true" tabindex="-1"></a>  folds_inner <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(datos_entrenamiento_outer<span class="sc">$</span>ESTADO_ACTUAL, <span class="at">k =</span> k_inner, <span class="at">list =</span> <span class="cn">FALSE</span>)  <span class="co"># Obtener índices de pliegues internos</span></span>
<span id="cb158-34"><a href="#cb158-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb158-35"><a href="#cb158-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Almacenar predicciones y objetivos para el AUC general</span></span>
<span id="cb158-36"><a href="#cb158-36" aria-hidden="true" tabindex="-1"></a>  predicciones_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(datos_entrenamiento_outer))</span>
<span id="cb158-37"><a href="#cb158-37" aria-hidden="true" tabindex="-1"></a>  targets_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(datos_entrenamiento_outer))</span>
<span id="cb158-38"><a href="#cb158-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb158-39"><a href="#cb158-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Inicializar variables para almacenar resultados internos</span></span>
<span id="cb158-40"><a href="#cb158-40" aria-hidden="true" tabindex="-1"></a>  resultados_auc_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb158-41"><a href="#cb158-41" aria-hidden="true" tabindex="-1"></a>  resultados_accuracy_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb158-42"><a href="#cb158-42" aria-hidden="true" tabindex="-1"></a>  resultados_sensibilidad_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb158-43"><a href="#cb158-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb158-44"><a href="#cb158-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Iterar sobre cada pliegue interno para selección de modelo</span></span>
<span id="cb158-45"><a href="#cb158-45" aria-hidden="true" tabindex="-1"></a>  indices_inner <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(datos_entrenamiento_outer)</span>
<span id="cb158-46"><a href="#cb158-46" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i_inner <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k_inner) {</span>
<span id="cb158-47"><a href="#cb158-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Obtener los índices para el pliegue interno actual</span></span>
<span id="cb158-48"><a href="#cb158-48" aria-hidden="true" tabindex="-1"></a>    test_indices_inner <span class="ot">&lt;-</span> indices_inner[folds_inner <span class="sc">==</span> i_inner]  <span class="co"># Índices correspondientes al pliegue interno de test</span></span>
<span id="cb158-49"><a href="#cb158-49" aria-hidden="true" tabindex="-1"></a>    train_indices_inner <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(datos_entrenamiento_outer), test_indices_inner)  <span class="co"># Índices correspondientes al conjunto de entrenamiento interno</span></span>
<span id="cb158-50"><a href="#cb158-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb158-51"><a href="#cb158-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Dividir datos en entrenamiento y test para el pliegue interno</span></span>
<span id="cb158-52"><a href="#cb158-52" aria-hidden="true" tabindex="-1"></a>    datos_entrenamiento_inner <span class="ot">&lt;-</span> datos_entrenamiento_outer[train_indices_inner, ]</span>
<span id="cb158-53"><a href="#cb158-53" aria-hidden="true" tabindex="-1"></a>    datos_validacion <span class="ot">&lt;-</span> datos_entrenamiento_outer[test_indices_inner, ]</span>
<span id="cb158-54"><a href="#cb158-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb158-55"><a href="#cb158-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Almacenar predicciones y objetivos para el AUC interno</span></span>
<span id="cb158-56"><a href="#cb158-56" aria-hidden="true" tabindex="-1"></a>    predicciones_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(datos_validacion))</span>
<span id="cb158-57"><a href="#cb158-57" aria-hidden="true" tabindex="-1"></a>    targets_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(datos_validacion))</span>
<span id="cb158-58"><a href="#cb158-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb158-59"><a href="#cb158-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Definir todas las combinaciones de variables (sustituye esto por tus combinaciones reales)</span></span>
<span id="cb158-60"><a href="#cb158-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-61"><a href="#cb158-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb158-62"><a href="#cb158-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb158-63"><a href="#cb158-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aplicar oversampling en el conjunto de entrenamiento interno</span></span>
<span id="cb158-64"><a href="#cb158-64" aria-hidden="true" tabindex="-1"></a>    datos_entrenamiento_oversampled <span class="ot">&lt;-</span> <span class="fu">ROSE</span>(ESTADO_ACTUAL <span class="sc">~</span> ., <span class="at">data =</span> datos_entrenamiento_inner, <span class="at">p =</span> proportion)<span class="sc">$</span>data</span>
<span id="cb158-65"><a href="#cb158-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb158-66"><a href="#cb158-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb158-67"><a href="#cb158-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Entrenar el modelo Naive Bayes</span></span>
<span id="cb158-68"><a href="#cb158-68" aria-hidden="true" tabindex="-1"></a>    modelo <span class="ot">&lt;-</span> <span class="fu">naiveBayes</span>(ESTADO_ACTUAL <span class="sc">~</span> ., <span class="at">data =</span> datos_entrenamiento_oversampled)</span>
<span id="cb158-69"><a href="#cb158-69" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb158-70"><a href="#cb158-70" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Realizar predicciones con probabilidades en datos de validación</span></span>
<span id="cb158-71"><a href="#cb158-71" aria-hidden="true" tabindex="-1"></a>    predicciones_validacion_prob <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelo, <span class="at">newdata =</span> datos_validacion, <span class="at">type =</span> <span class="st">"raw"</span>)[,<span class="dv">2</span>]</span>
<span id="cb158-72"><a href="#cb158-72" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb158-73"><a href="#cb158-73" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calcular el AUC</span></span>
<span id="cb158-74"><a href="#cb158-74" aria-hidden="true" tabindex="-1"></a>    roc_obj <span class="ot">&lt;-</span> <span class="fu">roc</span>(datos_validacion<span class="sc">$</span>ESTADO_ACTUAL, predicciones_validacion_prob, <span class="at">levels =</span> <span class="fu">rev</span>(<span class="fu">levels</span>(datos_validacion<span class="sc">$</span>ESTADO_ACTUAL)))</span>
<span id="cb158-75"><a href="#cb158-75" aria-hidden="true" tabindex="-1"></a>    auc_actual <span class="ot">&lt;-</span> <span class="fu">auc</span>(roc_obj)</span>
<span id="cb158-76"><a href="#cb158-76" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb158-77"><a href="#cb158-77" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Almacenar las predicciones y objetivos</span></span>
<span id="cb158-78"><a href="#cb158-78" aria-hidden="true" tabindex="-1"></a>    predicciones_auc[test_indices_inner] <span class="ot">&lt;-</span> predicciones_validacion_prob</span>
<span id="cb158-79"><a href="#cb158-79" aria-hidden="true" tabindex="-1"></a>    targets_auc[test_indices_inner] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(datos_validacion<span class="sc">$</span>ESTADO_ACTUAL) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb158-80"><a href="#cb158-80" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb158-81"><a href="#cb158-81" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calcular la sensibilidad y la precisión</span></span>
<span id="cb158-82"><a href="#cb158-82" aria-hidden="true" tabindex="-1"></a>    umbral <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb158-83"><a href="#cb158-83" aria-hidden="true" tabindex="-1"></a>    predicciones_finales <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predicciones_validacion_prob <span class="sc">&gt;=</span> umbral, <span class="st">"SI"</span>, <span class="st">"NO"</span>)</span>
<span id="cb158-84"><a href="#cb158-84" aria-hidden="true" tabindex="-1"></a>    TP <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_finales <span class="sc">==</span> <span class="st">"SI"</span> <span class="sc">&amp;</span> datos_validacion<span class="sc">$</span>ESTADO_ACTUAL <span class="sc">==</span> <span class="st">"SI"</span>)</span>
<span id="cb158-85"><a href="#cb158-85" aria-hidden="true" tabindex="-1"></a>    FN <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_finales <span class="sc">==</span> <span class="st">"NO"</span> <span class="sc">&amp;</span> datos_validacion<span class="sc">$</span>ESTADO_ACTUAL <span class="sc">==</span> <span class="st">"SI"</span>)</span>
<span id="cb158-86"><a href="#cb158-86" aria-hidden="true" tabindex="-1"></a>    FP <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_finales <span class="sc">==</span> <span class="st">"SI"</span> <span class="sc">&amp;</span> datos_validacion<span class="sc">$</span>ESTADO_ACTUAL <span class="sc">==</span> <span class="st">"NO"</span>)</span>
<span id="cb158-87"><a href="#cb158-87" aria-hidden="true" tabindex="-1"></a>    TN <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_finales <span class="sc">==</span> <span class="st">"NO"</span> <span class="sc">&amp;</span> datos_validacion<span class="sc">$</span>ESTADO_ACTUAL <span class="sc">==</span> <span class="st">"NO"</span>)</span>
<span id="cb158-88"><a href="#cb158-88" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb158-89"><a href="#cb158-89" aria-hidden="true" tabindex="-1"></a>    recall_actual <span class="ot">&lt;-</span> TP <span class="sc">/</span> (TP <span class="sc">+</span> FN)</span>
<span id="cb158-90"><a href="#cb158-90" aria-hidden="true" tabindex="-1"></a>    accuracy_actual <span class="ot">&lt;-</span> (TP <span class="sc">+</span> TN) <span class="sc">/</span> (TP <span class="sc">+</span> FN <span class="sc">+</span> FP <span class="sc">+</span> TN)</span>
<span id="cb158-91"><a href="#cb158-91" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb158-92"><a href="#cb158-92" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Almacenar resultados internos</span></span>
<span id="cb158-93"><a href="#cb158-93" aria-hidden="true" tabindex="-1"></a>    resultados_sensibilidad_inner[i_inner] <span class="ot">&lt;-</span> recall_actual</span>
<span id="cb158-94"><a href="#cb158-94" aria-hidden="true" tabindex="-1"></a>    resultados_accuracy_inner[i_inner] <span class="ot">&lt;-</span> accuracy_actual</span>
<span id="cb158-95"><a href="#cb158-95" aria-hidden="true" tabindex="-1"></a>    resultados_auc_inner[i_inner] <span class="ot">&lt;-</span> auc_actual</span>
<span id="cb158-96"><a href="#cb158-96" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb158-97"><a href="#cb158-97" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb158-98"><a href="#cb158-98" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb158-99"><a href="#cb158-99" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular el AUC final para este pliegue externo</span></span>
<span id="cb158-100"><a href="#cb158-100" aria-hidden="true" tabindex="-1"></a>  auc_fold_externo <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_auc_inner)</span>
<span id="cb158-101"><a href="#cb158-101" aria-hidden="true" tabindex="-1"></a>  accuracy_fold_externo <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_accuracy_inner)</span>
<span id="cb158-102"><a href="#cb158-102" aria-hidden="true" tabindex="-1"></a>  sensibilidad_fold_externo <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_sensibilidad_inner)</span>
<span id="cb158-103"><a href="#cb158-103" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb158-104"><a href="#cb158-104" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Almacenar el AUC del fold externo actual</span></span>
<span id="cb158-105"><a href="#cb158-105" aria-hidden="true" tabindex="-1"></a>  resultados_auc[i_outer] <span class="ot">&lt;-</span> auc_fold_externo</span>
<span id="cb158-106"><a href="#cb158-106" aria-hidden="true" tabindex="-1"></a>  resultados_accuracy[i_outer] <span class="ot">&lt;-</span> accuracy_fold_externo</span>
<span id="cb158-107"><a href="#cb158-107" aria-hidden="true" tabindex="-1"></a>  resultados_sensibilidad[i_outer] <span class="ot">&lt;-</span> sensibilidad_fold_externo</span>
<span id="cb158-108"><a href="#cb158-108" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb158-109"><a href="#cb158-109" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Predecir en los datos de test para este pliegue externo y almacenar predicciones</span></span>
<span id="cb158-110"><a href="#cb158-110" aria-hidden="true" tabindex="-1"></a>  <span class="co"># (Aquí deberías hacer la predicción usando el mejor modelo encontrado en el bucle interno)</span></span>
<span id="cb158-111"><a href="#cb158-111" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb158-112"><a href="#cb158-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-113"><a href="#cb158-113" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular AUC promedio</span></span>
<span id="cb158-114"><a href="#cb158-114" aria-hidden="true" tabindex="-1"></a>auc_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_auc)</span>
<span id="cb158-115"><a href="#cb158-115" aria-hidden="true" tabindex="-1"></a>accuracy_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_accuracy)</span>
<span id="cb158-116"><a href="#cb158-116" aria-hidden="true" tabindex="-1"></a>sensibilidad_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_sensibilidad)</span>
<span id="cb158-117"><a href="#cb158-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-118"><a href="#cb158-118" aria-hidden="true" tabindex="-1"></a>tabla_metricas <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb158-119"><a href="#cb158-119" aria-hidden="true" tabindex="-1"></a>  <span class="at">Pliegue =</span> <span class="dv">1</span><span class="sc">:</span>k_outer,</span>
<span id="cb158-120"><a href="#cb158-120" aria-hidden="true" tabindex="-1"></a>  <span class="at">AUC =</span> <span class="fu">sapply</span>(resultados_auc, round, <span class="at">digits =</span> <span class="dv">3</span>),</span>
<span id="cb158-121"><a href="#cb158-121" aria-hidden="true" tabindex="-1"></a>  <span class="at">Accuracy =</span> <span class="fu">sapply</span>(resultados_accuracy, round, <span class="at">digits =</span> <span class="dv">3</span>),</span>
<span id="cb158-122"><a href="#cb158-122" aria-hidden="true" tabindex="-1"></a>  <span class="at">Recall =</span> <span class="fu">sapply</span>(resultados_sensibilidad, round, <span class="at">digits =</span> <span class="dv">3</span>)</span>
<span id="cb158-123"><a href="#cb158-123" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb158-124"><a href="#cb158-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-125"><a href="#cb158-125" aria-hidden="true" tabindex="-1"></a><span class="co"># Agregar fila con promedio de métricas</span></span>
<span id="cb158-126"><a href="#cb158-126" aria-hidden="true" tabindex="-1"></a>tabla_metricas_naive15 <span class="ot">&lt;-</span> <span class="fu">rbind</span>(tabla_metricas, <span class="fu">c</span>(<span class="st">"Mean"</span>, <span class="fu">round</span>(auc_promedio, <span class="dv">3</span>), <span class="fu">round</span>(accuracy_promedio, <span class="dv">3</span>), <span class="fu">round</span>(sensibilidad_promedio, <span class="dv">3</span>)))</span>
<span id="cb158-127"><a href="#cb158-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-128"><a href="#cb158-128" aria-hidden="true" tabindex="-1"></a><span class="co"># Detener el tiempo de ejecución</span></span>
<span id="cb158-129"><a href="#cb158-129" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb158-130"><a href="#cb158-130" aria-hidden="true" tabindex="-1"></a>execution_time_naive <span class="ot">&lt;-</span> end_time <span class="sc">-</span> start_time</span>
<span id="cb158-131"><a href="#cb158-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-132"><a href="#cb158-132" aria-hidden="true" tabindex="-1"></a>execution_time_naive15 <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(execution_time_naive, <span class="at">units =</span> <span class="st">"secs"</span>)</span>
<span id="cb158-133"><a href="#cb158-133" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(tabla_metricas_naive15, <span class="at">file =</span> <span class="st">"tabla_metricas_naive_filter15.RData"</span>)</span>
<span id="cb158-134"><a href="#cb158-134" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(execution_time_naive15, <span class="at">file =</span> <span class="st">"execution_time_naive_filter15.RData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb159"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"tabla_metricas_naive_filter15.RData"</span>)</span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"execution_time_naive_filter15.RData"</span>)</span>
<span id="cb159-3"><a href="#cb159-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir el tiempo de ejecución</span></span>
<span id="cb159-4"><a href="#cb159-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time_naive15,  <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-41-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-41-1" role="tab" aria-controls="tabset-41-1" aria-selected="true" href="">Metrics Table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-41-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-41-2" role="tab" aria-controls="tabset-41-2" aria-selected="false" href="">Metrics Plot</a></li></ul>
<div class="tab-content">
<div id="tabset-41-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-41-1-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir tabla formateada con kableExtra</span></span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(tabla_metricas_naive15, <span class="at">caption =</span> <span class="st">"Cross Validation Metrics"</span>, <span class="at">align =</span> <span class="st">"c"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="tabset-41-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-41-2-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb161"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="fu">crear_plot_metricas_per_fold</span>(tabla_metricas_naive15)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div id="tabset-43-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-43-4-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Iniciar tiempo de ejecución</span></span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb162-3"><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-4"><a href="#cb162-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Parámetros a cambiar</span></span>
<span id="cb162-5"><a href="#cb162-5" aria-hidden="true" tabindex="-1"></a>proportion <span class="ot">&lt;-</span> <span class="fl">0.28</span></span>
<span id="cb162-6"><a href="#cb162-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-7"><a href="#cb162-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Configurar la validación cruzada 5x2</span></span>
<span id="cb162-8"><a href="#cb162-8" aria-hidden="true" tabindex="-1"></a>k_outer <span class="ot">&lt;-</span> <span class="dv">20</span>  <span class="co"># Número de pliegues externos</span></span>
<span id="cb162-9"><a href="#cb162-9" aria-hidden="true" tabindex="-1"></a>k_inner <span class="ot">&lt;-</span> <span class="dv">10</span>  <span class="co"># Número de pliegues internos</span></span>
<span id="cb162-10"><a href="#cb162-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-11"><a href="#cb162-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Lista para almacenar resultados</span></span>
<span id="cb162-12"><a href="#cb162-12" aria-hidden="true" tabindex="-1"></a>resultados_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb162-13"><a href="#cb162-13" aria-hidden="true" tabindex="-1"></a>resultados_accuracy <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb162-14"><a href="#cb162-14" aria-hidden="true" tabindex="-1"></a>resultados_sensibilidad <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_outer)</span>
<span id="cb162-15"><a href="#cb162-15" aria-hidden="true" tabindex="-1"></a>indices <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data)</span>
<span id="cb162-16"><a href="#cb162-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-17"><a href="#cb162-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Inicializar matrices para almacenar predicciones y objetivos</span></span>
<span id="cb162-18"><a href="#cb162-18" aria-hidden="true" tabindex="-1"></a>predicciones_totales <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">nrow</span>(data), <span class="at">ncol =</span> k_outer)</span>
<span id="cb162-19"><a href="#cb162-19" aria-hidden="true" tabindex="-1"></a>targets_totales <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(data))</span>
<span id="cb162-20"><a href="#cb162-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-21"><a href="#cb162-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterar sobre cada pliegue externo y realizar el proceso de modelado</span></span>
<span id="cb162-22"><a href="#cb162-22" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i_outer <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k_outer) {</span>
<span id="cb162-23"><a href="#cb162-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb162-24"><a href="#cb162-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Obtener los índices para el pliegue externo actual</span></span>
<span id="cb162-25"><a href="#cb162-25" aria-hidden="true" tabindex="-1"></a>  test_indices_outer <span class="ot">&lt;-</span> indices[folds_outer <span class="sc">==</span> i_outer]  <span class="co"># Índices correspondientes al pliegue externo de test</span></span>
<span id="cb162-26"><a href="#cb162-26" aria-hidden="true" tabindex="-1"></a>  train_indices_outer <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data), test_indices_outer)  <span class="co"># Índices correspondientes al conjunto de entrenamiento</span></span>
<span id="cb162-27"><a href="#cb162-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb162-28"><a href="#cb162-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Dividir datos en entrenamiento y test para el pliegue externo</span></span>
<span id="cb162-29"><a href="#cb162-29" aria-hidden="true" tabindex="-1"></a>  datos_entrenamiento_outer <span class="ot">&lt;-</span> datafinal[train_indices_outer, ]</span>
<span id="cb162-30"><a href="#cb162-30" aria-hidden="true" tabindex="-1"></a>  datos_test_outer <span class="ot">&lt;-</span> datafinal[test_indices_outer, ]</span>
<span id="cb162-31"><a href="#cb162-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb162-32"><a href="#cb162-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Configurar la validación cruzada interna</span></span>
<span id="cb162-33"><a href="#cb162-33" aria-hidden="true" tabindex="-1"></a>  folds_inner <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(datos_entrenamiento_outer<span class="sc">$</span>ESTADO_ACTUAL, <span class="at">k =</span> k_inner, <span class="at">list =</span> <span class="cn">FALSE</span>)  <span class="co"># Obtener índices de pliegues internos</span></span>
<span id="cb162-34"><a href="#cb162-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb162-35"><a href="#cb162-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Almacenar predicciones y objetivos para el AUC general</span></span>
<span id="cb162-36"><a href="#cb162-36" aria-hidden="true" tabindex="-1"></a>  predicciones_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(datos_entrenamiento_outer))</span>
<span id="cb162-37"><a href="#cb162-37" aria-hidden="true" tabindex="-1"></a>  targets_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(datos_entrenamiento_outer))</span>
<span id="cb162-38"><a href="#cb162-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb162-39"><a href="#cb162-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Inicializar variables para almacenar resultados internos</span></span>
<span id="cb162-40"><a href="#cb162-40" aria-hidden="true" tabindex="-1"></a>  resultados_auc_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb162-41"><a href="#cb162-41" aria-hidden="true" tabindex="-1"></a>  resultados_accuracy_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb162-42"><a href="#cb162-42" aria-hidden="true" tabindex="-1"></a>  resultados_sensibilidad_inner <span class="ot">&lt;-</span> <span class="fu">numeric</span>(k_inner)</span>
<span id="cb162-43"><a href="#cb162-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb162-44"><a href="#cb162-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Iterar sobre cada pliegue interno para selección de modelo</span></span>
<span id="cb162-45"><a href="#cb162-45" aria-hidden="true" tabindex="-1"></a>  indices_inner <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(datos_entrenamiento_outer)</span>
<span id="cb162-46"><a href="#cb162-46" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i_inner <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k_inner) {</span>
<span id="cb162-47"><a href="#cb162-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Obtener los índices para el pliegue interno actual</span></span>
<span id="cb162-48"><a href="#cb162-48" aria-hidden="true" tabindex="-1"></a>    test_indices_inner <span class="ot">&lt;-</span> indices_inner[folds_inner <span class="sc">==</span> i_inner]  <span class="co"># Índices correspondientes al pliegue interno de test</span></span>
<span id="cb162-49"><a href="#cb162-49" aria-hidden="true" tabindex="-1"></a>    train_indices_inner <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(datos_entrenamiento_outer), test_indices_inner)  <span class="co"># Índices correspondientes al conjunto de entrenamiento interno</span></span>
<span id="cb162-50"><a href="#cb162-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb162-51"><a href="#cb162-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Dividir datos en entrenamiento y test para el pliegue interno</span></span>
<span id="cb162-52"><a href="#cb162-52" aria-hidden="true" tabindex="-1"></a>    datos_entrenamiento_inner <span class="ot">&lt;-</span> datos_entrenamiento_outer[train_indices_inner, ]</span>
<span id="cb162-53"><a href="#cb162-53" aria-hidden="true" tabindex="-1"></a>    datos_validacion <span class="ot">&lt;-</span> datos_entrenamiento_outer[test_indices_inner, ]</span>
<span id="cb162-54"><a href="#cb162-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb162-55"><a href="#cb162-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Almacenar predicciones y objetivos para el AUC interno</span></span>
<span id="cb162-56"><a href="#cb162-56" aria-hidden="true" tabindex="-1"></a>    predicciones_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(datos_validacion))</span>
<span id="cb162-57"><a href="#cb162-57" aria-hidden="true" tabindex="-1"></a>    targets_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(datos_validacion))</span>
<span id="cb162-58"><a href="#cb162-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb162-59"><a href="#cb162-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Definir todas las combinaciones de variables (sustituye esto por tus combinaciones reales)</span></span>
<span id="cb162-60"><a href="#cb162-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-61"><a href="#cb162-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb162-62"><a href="#cb162-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb162-63"><a href="#cb162-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aplicar oversampling en el conjunto de entrenamiento interno</span></span>
<span id="cb162-64"><a href="#cb162-64" aria-hidden="true" tabindex="-1"></a>    datos_entrenamiento_oversampled <span class="ot">&lt;-</span> <span class="fu">ROSE</span>(ESTADO_ACTUAL <span class="sc">~</span> ., <span class="at">data =</span> datos_entrenamiento_inner, <span class="at">p =</span> proportion)<span class="sc">$</span>data</span>
<span id="cb162-65"><a href="#cb162-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb162-66"><a href="#cb162-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb162-67"><a href="#cb162-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Entrenar el modelo Naive Bayes</span></span>
<span id="cb162-68"><a href="#cb162-68" aria-hidden="true" tabindex="-1"></a>    modelo <span class="ot">&lt;-</span> <span class="fu">naiveBayes</span>(ESTADO_ACTUAL <span class="sc">~</span> ., <span class="at">data =</span> datos_entrenamiento_oversampled)</span>
<span id="cb162-69"><a href="#cb162-69" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb162-70"><a href="#cb162-70" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Realizar predicciones con probabilidades en datos de validación</span></span>
<span id="cb162-71"><a href="#cb162-71" aria-hidden="true" tabindex="-1"></a>    predicciones_validacion_prob <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelo, <span class="at">newdata =</span> datos_validacion, <span class="at">type =</span> <span class="st">"raw"</span>)[,<span class="dv">2</span>]</span>
<span id="cb162-72"><a href="#cb162-72" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb162-73"><a href="#cb162-73" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calcular el AUC</span></span>
<span id="cb162-74"><a href="#cb162-74" aria-hidden="true" tabindex="-1"></a>    roc_obj <span class="ot">&lt;-</span> <span class="fu">roc</span>(datos_validacion<span class="sc">$</span>ESTADO_ACTUAL, predicciones_validacion_prob, <span class="at">levels =</span> <span class="fu">rev</span>(<span class="fu">levels</span>(datos_validacion<span class="sc">$</span>ESTADO_ACTUAL)))</span>
<span id="cb162-75"><a href="#cb162-75" aria-hidden="true" tabindex="-1"></a>    auc_actual <span class="ot">&lt;-</span> <span class="fu">auc</span>(roc_obj)</span>
<span id="cb162-76"><a href="#cb162-76" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb162-77"><a href="#cb162-77" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Almacenar las predicciones y objetivos</span></span>
<span id="cb162-78"><a href="#cb162-78" aria-hidden="true" tabindex="-1"></a>    predicciones_auc[test_indices_inner] <span class="ot">&lt;-</span> predicciones_validacion_prob</span>
<span id="cb162-79"><a href="#cb162-79" aria-hidden="true" tabindex="-1"></a>    targets_auc[test_indices_inner] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(datos_validacion<span class="sc">$</span>ESTADO_ACTUAL) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb162-80"><a href="#cb162-80" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb162-81"><a href="#cb162-81" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calcular la sensibilidad y la precisión</span></span>
<span id="cb162-82"><a href="#cb162-82" aria-hidden="true" tabindex="-1"></a>    umbral <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb162-83"><a href="#cb162-83" aria-hidden="true" tabindex="-1"></a>    predicciones_finales <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predicciones_validacion_prob <span class="sc">&gt;=</span> umbral, <span class="st">"SI"</span>, <span class="st">"NO"</span>)</span>
<span id="cb162-84"><a href="#cb162-84" aria-hidden="true" tabindex="-1"></a>    TP <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_finales <span class="sc">==</span> <span class="st">"SI"</span> <span class="sc">&amp;</span> datos_validacion<span class="sc">$</span>ESTADO_ACTUAL <span class="sc">==</span> <span class="st">"SI"</span>)</span>
<span id="cb162-85"><a href="#cb162-85" aria-hidden="true" tabindex="-1"></a>    FN <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_finales <span class="sc">==</span> <span class="st">"NO"</span> <span class="sc">&amp;</span> datos_validacion<span class="sc">$</span>ESTADO_ACTUAL <span class="sc">==</span> <span class="st">"SI"</span>)</span>
<span id="cb162-86"><a href="#cb162-86" aria-hidden="true" tabindex="-1"></a>    FP <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_finales <span class="sc">==</span> <span class="st">"SI"</span> <span class="sc">&amp;</span> datos_validacion<span class="sc">$</span>ESTADO_ACTUAL <span class="sc">==</span> <span class="st">"NO"</span>)</span>
<span id="cb162-87"><a href="#cb162-87" aria-hidden="true" tabindex="-1"></a>    TN <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_finales <span class="sc">==</span> <span class="st">"NO"</span> <span class="sc">&amp;</span> datos_validacion<span class="sc">$</span>ESTADO_ACTUAL <span class="sc">==</span> <span class="st">"NO"</span>)</span>
<span id="cb162-88"><a href="#cb162-88" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb162-89"><a href="#cb162-89" aria-hidden="true" tabindex="-1"></a>    recall_actual <span class="ot">&lt;-</span> TP <span class="sc">/</span> (TP <span class="sc">+</span> FN)</span>
<span id="cb162-90"><a href="#cb162-90" aria-hidden="true" tabindex="-1"></a>    accuracy_actual <span class="ot">&lt;-</span> (TP <span class="sc">+</span> TN) <span class="sc">/</span> (TP <span class="sc">+</span> FN <span class="sc">+</span> FP <span class="sc">+</span> TN)</span>
<span id="cb162-91"><a href="#cb162-91" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb162-92"><a href="#cb162-92" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Almacenar resultados internos</span></span>
<span id="cb162-93"><a href="#cb162-93" aria-hidden="true" tabindex="-1"></a>    resultados_sensibilidad_inner[i_inner] <span class="ot">&lt;-</span> recall_actual</span>
<span id="cb162-94"><a href="#cb162-94" aria-hidden="true" tabindex="-1"></a>    resultados_accuracy_inner[i_inner] <span class="ot">&lt;-</span> accuracy_actual</span>
<span id="cb162-95"><a href="#cb162-95" aria-hidden="true" tabindex="-1"></a>    resultados_auc_inner[i_inner] <span class="ot">&lt;-</span> auc_actual</span>
<span id="cb162-96"><a href="#cb162-96" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb162-97"><a href="#cb162-97" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb162-98"><a href="#cb162-98" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb162-99"><a href="#cb162-99" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular el AUC final para este pliegue externo</span></span>
<span id="cb162-100"><a href="#cb162-100" aria-hidden="true" tabindex="-1"></a>  auc_fold_externo <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_auc_inner)</span>
<span id="cb162-101"><a href="#cb162-101" aria-hidden="true" tabindex="-1"></a>  accuracy_fold_externo <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_accuracy_inner)</span>
<span id="cb162-102"><a href="#cb162-102" aria-hidden="true" tabindex="-1"></a>  sensibilidad_fold_externo <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_sensibilidad_inner)</span>
<span id="cb162-103"><a href="#cb162-103" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb162-104"><a href="#cb162-104" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Almacenar el AUC del fold externo actual</span></span>
<span id="cb162-105"><a href="#cb162-105" aria-hidden="true" tabindex="-1"></a>  resultados_auc[i_outer] <span class="ot">&lt;-</span> auc_fold_externo</span>
<span id="cb162-106"><a href="#cb162-106" aria-hidden="true" tabindex="-1"></a>  resultados_accuracy[i_outer] <span class="ot">&lt;-</span> accuracy_fold_externo</span>
<span id="cb162-107"><a href="#cb162-107" aria-hidden="true" tabindex="-1"></a>  resultados_sensibilidad[i_outer] <span class="ot">&lt;-</span> sensibilidad_fold_externo</span>
<span id="cb162-108"><a href="#cb162-108" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb162-109"><a href="#cb162-109" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Predecir en los datos de test para este pliegue externo y almacenar predicciones</span></span>
<span id="cb162-110"><a href="#cb162-110" aria-hidden="true" tabindex="-1"></a>  <span class="co"># (Aquí deberías hacer la predicción usando el mejor modelo encontrado en el bucle interno)</span></span>
<span id="cb162-111"><a href="#cb162-111" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb162-112"><a href="#cb162-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-113"><a href="#cb162-113" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular AUC promedio</span></span>
<span id="cb162-114"><a href="#cb162-114" aria-hidden="true" tabindex="-1"></a>auc_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_auc)</span>
<span id="cb162-115"><a href="#cb162-115" aria-hidden="true" tabindex="-1"></a>accuracy_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_accuracy)</span>
<span id="cb162-116"><a href="#cb162-116" aria-hidden="true" tabindex="-1"></a>sensibilidad_promedio <span class="ot">&lt;-</span> <span class="fu">mean</span>(resultados_sensibilidad)</span>
<span id="cb162-117"><a href="#cb162-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-118"><a href="#cb162-118" aria-hidden="true" tabindex="-1"></a>tabla_metricas <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb162-119"><a href="#cb162-119" aria-hidden="true" tabindex="-1"></a>  <span class="at">Pliegue =</span> <span class="dv">1</span><span class="sc">:</span>k_outer,</span>
<span id="cb162-120"><a href="#cb162-120" aria-hidden="true" tabindex="-1"></a>  <span class="at">AUC =</span> <span class="fu">sapply</span>(resultados_auc, round, <span class="at">digits =</span> <span class="dv">3</span>),</span>
<span id="cb162-121"><a href="#cb162-121" aria-hidden="true" tabindex="-1"></a>  <span class="at">Accuracy =</span> <span class="fu">sapply</span>(resultados_accuracy, round, <span class="at">digits =</span> <span class="dv">3</span>),</span>
<span id="cb162-122"><a href="#cb162-122" aria-hidden="true" tabindex="-1"></a>  <span class="at">Recall =</span> <span class="fu">sapply</span>(resultados_sensibilidad, round, <span class="at">digits =</span> <span class="dv">3</span>)</span>
<span id="cb162-123"><a href="#cb162-123" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb162-124"><a href="#cb162-124" aria-hidden="true" tabindex="-1"></a><span class="co"># Agregar fila con promedio de métricas</span></span>
<span id="cb162-125"><a href="#cb162-125" aria-hidden="true" tabindex="-1"></a>tabla_metricas_naive21 <span class="ot">&lt;-</span> <span class="fu">rbind</span>(tabla_metricas, <span class="fu">c</span>(<span class="st">"Mean"</span>, <span class="fu">round</span>(auc_promedio, <span class="dv">3</span>), <span class="fu">round</span>(accuracy_promedio, <span class="dv">3</span>), <span class="fu">round</span>(sensibilidad_promedio, <span class="dv">3</span>)))</span>
<span id="cb162-126"><a href="#cb162-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-127"><a href="#cb162-127" aria-hidden="true" tabindex="-1"></a><span class="co"># Detener el tiempo de ejecución</span></span>
<span id="cb162-128"><a href="#cb162-128" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb162-129"><a href="#cb162-129" aria-hidden="true" tabindex="-1"></a>execution_time_naive <span class="ot">&lt;-</span> end_time <span class="sc">-</span> start_time</span>
<span id="cb162-130"><a href="#cb162-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-131"><a href="#cb162-131" aria-hidden="true" tabindex="-1"></a>execution_time_naive21 <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(execution_time_naive, <span class="at">units =</span> <span class="st">"secs"</span>)</span>
<span id="cb162-132"><a href="#cb162-132" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(tabla_metricas_naive21, <span class="at">file =</span> <span class="st">"tabla_metricas_naive_filter21.RData"</span>)</span>
<span id="cb162-133"><a href="#cb162-133" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(execution_time_naive21, <span class="at">file =</span> <span class="st">"execution_time_naive_filter21.RData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"tabla_metricas_naive_filter21.RData"</span>)</span>
<span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"execution_time_naive_filter21.RData"</span>)</span>
<span id="cb163-3"><a href="#cb163-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir el tiempo de ejecución</span></span>
<span id="cb163-4"><a href="#cb163-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time_naive21,  <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-42-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-42-1" role="tab" aria-controls="tabset-42-1" aria-selected="true" href="">Metrics Table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-42-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-42-2" role="tab" aria-controls="tabset-42-2" aria-selected="false" href="">Metrics Plot</a></li></ul>
<div class="tab-content">
<div id="tabset-42-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-42-1-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb164"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir tabla formateada con kableExtra</span></span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(tabla_metricas_naive21, <span class="at">caption =</span> <span class="st">"Cross Validation Metrics"</span>, <span class="at">align =</span> <span class="st">"c"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb164-3"><a href="#cb164-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="tabset-42-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-42-2-tab">
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb165"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="fu">crear_plot_metricas_per_fold</span>(tabla_metricas_naive21)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<p>The model performance is more stable with a higher number of inner folds. On top of that, if we increase the number of outer folds, the model performance is more consistent. However, the execution time increases significantly with a higher number of folds.</p>
</section>
</section>
<section id="deployment" class="level1">
<h1>Deployment</h1>
<p>In this section, we will deploy the model using the Shiny framework.</p>
<p>Source code of the Shiny app:</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb166"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(shiny)</span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(e1071)</span>
<span id="cb166-3"><a href="#cb166-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(shinyjs)</span>
<span id="cb166-4"><a href="#cb166-4" aria-hidden="true" tabindex="-1"></a><span class="co">#| </span></span>
<span id="cb166-5"><a href="#cb166-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the trained Naive Bayes model</span></span>
<span id="cb166-6"><a href="#cb166-6" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"modelo_final.RData"</span>)</span>
<span id="cb166-7"><a href="#cb166-7" aria-hidden="true" tabindex="-1"></a>modelo <span class="ot">&lt;-</span> modelo_final</span>
<span id="cb166-8"><a href="#cb166-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-9"><a href="#cb166-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Definir niveles para cada variable</span></span>
<span id="cb166-10"><a href="#cb166-10" aria-hidden="true" tabindex="-1"></a>niveles_edad <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"0-30"</span>, <span class="st">"31-40"</span>, <span class="st">"41-50"</span>, <span class="st">"51-60"</span>, <span class="st">"61-70"</span>, <span class="st">"+70"</span>)</span>
<span id="cb166-11"><a href="#cb166-11" aria-hidden="true" tabindex="-1"></a>niveles_rest <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"N"</span>, <span class="st">"P"</span>)</span>
<span id="cb166-12"><a href="#cb166-12" aria-hidden="true" tabindex="-1"></a>niveles_grado <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"1"</span>, <span class="st">"2"</span>, <span class="st">"3"</span>)</span>
<span id="cb166-13"><a href="#cb166-13" aria-hidden="true" tabindex="-1"></a>niveles_fenotipo <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Basal"</span>, <span class="st">"Her2"</span>, <span class="st">"LumA"</span>, <span class="st">"LumB"</span>, <span class="st">"Normal"</span>)</span>
<span id="cb166-14"><a href="#cb166-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-15"><a href="#cb166-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the UI with a modern theme</span></span>
<span id="cb166-16"><a href="#cb166-16" aria-hidden="true" tabindex="-1"></a>ui <span class="ot">&lt;-</span> <span class="fu">fluidPage</span>(</span>
<span id="cb166-17"><a href="#cb166-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">includeCSS</span>(<span class="st">"bootstrap.css"</span>), <span class="co"># Apply a modern theme</span></span>
<span id="cb166-18"><a href="#cb166-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">useShinyjs</span>(), <span class="co"># Include shinyjs for JavaScript manipulation</span></span>
<span id="cb166-19"><a href="#cb166-19" aria-hidden="true" tabindex="-1"></a>  tags<span class="sc">$</span><span class="fu">head</span>(</span>
<span id="cb166-20"><a href="#cb166-20" aria-hidden="true" tabindex="-1"></a>    tags<span class="sc">$</span><span class="fu">style</span>(</span>
<span id="cb166-21"><a href="#cb166-21" aria-hidden="true" tabindex="-1"></a>      <span class="fu">HTML</span>(<span class="st">"</span></span>
<span id="cb166-22"><a href="#cb166-22" aria-hidden="true" tabindex="-1"></a><span class="st">            .prediction-text {</span></span>
<span id="cb166-23"><a href="#cb166-23" aria-hidden="true" tabindex="-1"></a><span class="st">              font-size: 15px;</span></span>
<span id="cb166-24"><a href="#cb166-24" aria-hidden="true" tabindex="-1"></a><span class="st">            }</span></span>
<span id="cb166-25"><a href="#cb166-25" aria-hidden="true" tabindex="-1"></a><span class="st">          "</span>)</span>
<span id="cb166-26"><a href="#cb166-26" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb166-27"><a href="#cb166-27" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb166-28"><a href="#cb166-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">div</span>(<span class="at">style =</span> <span class="st">"padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 30px;"</span>,</span>
<span id="cb166-29"><a href="#cb166-29" aria-hidden="true" tabindex="-1"></a>      tags<span class="sc">$</span><span class="fu">h1</span>(<span class="st">"Breast Cancer Prediction App"</span>, <span class="at">style =</span> <span class="st">"font-size: 30px;"</span>)),</span>
<span id="cb166-30"><a href="#cb166-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb166-31"><a href="#cb166-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">div</span>(<span class="at">class =</span> <span class="st">"container"</span>,</span>
<span id="cb166-32"><a href="#cb166-32" aria-hidden="true" tabindex="-1"></a>      <span class="fu">h3</span>(<span class="st">"Enter the variables:"</span>),</span>
<span id="cb166-33"><a href="#cb166-33" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fluidRow</span>(</span>
<span id="cb166-34"><a href="#cb166-34" aria-hidden="true" tabindex="-1"></a>        <span class="fu">column</span>(<span class="dv">6</span>, <span class="fu">selectInput</span>(<span class="st">"input_edad"</span>, <span class="st">"Age:"</span>, <span class="at">choices =</span> niveles_edad, <span class="at">selected =</span> <span class="st">"0-30"</span>)),</span>
<span id="cb166-35"><a href="#cb166-35" aria-hidden="true" tabindex="-1"></a>        <span class="fu">column</span>(<span class="dv">6</span>, <span class="fu">selectInput</span>(<span class="st">"input_rest"</span>, <span class="st">"REst:"</span>, <span class="at">choices =</span> niveles_rest, <span class="at">selected =</span> <span class="st">"N"</span>))</span>
<span id="cb166-36"><a href="#cb166-36" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb166-37"><a href="#cb166-37" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fluidRow</span>(</span>
<span id="cb166-38"><a href="#cb166-38" aria-hidden="true" tabindex="-1"></a>        <span class="fu">column</span>(<span class="dv">6</span>, <span class="fu">selectInput</span>(<span class="st">"input_grado"</span>, <span class="st">"Grade:"</span>, <span class="at">choices =</span> niveles_grado, <span class="at">selected =</span> <span class="st">"1"</span>)),</span>
<span id="cb166-39"><a href="#cb166-39" aria-hidden="true" tabindex="-1"></a>        <span class="fu">column</span>(<span class="dv">6</span>, <span class="fu">selectInput</span>(<span class="st">"input_fenotipo"</span>, <span class="st">"Phenotype:"</span>, <span class="at">choices =</span> niveles_fenotipo, <span class="at">selected =</span> <span class="st">"Basal"</span>))</span>
<span id="cb166-40"><a href="#cb166-40" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb166-41"><a href="#cb166-41" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fluidRow</span>(</span>
<span id="cb166-42"><a href="#cb166-42" aria-hidden="true" tabindex="-1"></a>        <span class="fu">column</span>(<span class="dv">6</span>, <span class="fu">actionButton</span>(<span class="st">"submit_button"</span>, <span class="st">"Make Prediction"</span>, <span class="at">class =</span> <span class="st">"btn-primary"</span>)),</span>
<span id="cb166-43"><a href="#cb166-43" aria-hidden="true" tabindex="-1"></a>        <span class="fu">column</span>(<span class="dv">6</span>, <span class="fu">actionButton</span>(<span class="st">"help_button"</span>, <span class="st">"Need help with oncological variables?"</span>, <span class="at">class =</span> <span class="st">"btn-info"</span>))</span>
<span id="cb166-44"><a href="#cb166-44" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb166-45"><a href="#cb166-45" aria-hidden="true" tabindex="-1"></a>      <span class="fu">div</span>(<span class="at">style =</span> <span class="st">"height: 20px;"</span>), <span class="co"># Add space below buttons</span></span>
<span id="cb166-46"><a href="#cb166-46" aria-hidden="true" tabindex="-1"></a>      <span class="fu">div</span>(<span class="at">style =</span> <span class="st">"border-bottom: 2px solid #ccc; margin-bottom: 20px;"</span>), <span class="co"># Border for separation</span></span>
<span id="cb166-47"><a href="#cb166-47" aria-hidden="true" tabindex="-1"></a>      <span class="fu">div</span>(<span class="at">id =</span> <span class="st">"resultado_container"</span>, <span class="at">style =</span> <span class="st">"display: none;"</span>,</span>
<span id="cb166-48"><a href="#cb166-48" aria-hidden="true" tabindex="-1"></a>          <span class="fu">h3</span>(<span class="st">"Prediction Result:"</span>),</span>
<span id="cb166-49"><a href="#cb166-49" aria-hidden="true" tabindex="-1"></a>          <span class="fu">div</span>(<span class="at">class =</span> <span class="st">"alert alert-dismissible alert-light prediction-text"</span>,</span>
<span id="cb166-50"><a href="#cb166-50" aria-hidden="true" tabindex="-1"></a>              <span class="fu">strong</span>(<span class="st">"Prediction: "</span>), </span>
<span id="cb166-51"><a href="#cb166-51" aria-hidden="true" tabindex="-1"></a>              <span class="fu">textOutput</span>(<span class="st">"resultado_prediccion"</span>)</span>
<span id="cb166-52"><a href="#cb166-52" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb166-53"><a href="#cb166-53" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb166-54"><a href="#cb166-54" aria-hidden="true" tabindex="-1"></a>      <span class="fu">br</span>(),</span>
<span id="cb166-55"><a href="#cb166-55" aria-hidden="true" tabindex="-1"></a>      <span class="fu">div</span>(<span class="at">id =</span> <span class="st">"help_container"</span>, <span class="at">style =</span> <span class="st">"display: none;"</span>,</span>
<span id="cb166-56"><a href="#cb166-56" aria-hidden="true" tabindex="-1"></a>          <span class="fu">div</span>(<span class="at">class =</span> <span class="st">"alert alert-dismissible alert-info"</span>,</span>
<span id="cb166-57"><a href="#cb166-57" aria-hidden="true" tabindex="-1"></a>              <span class="fu">strong</span>(<span class="st">"Help: "</span>), </span>
<span id="cb166-58"><a href="#cb166-58" aria-hidden="true" tabindex="-1"></a>              <span class="st">"This alert provides information about the oncological variables used in the prediction:"</span>,</span>
<span id="cb166-59"><a href="#cb166-59" aria-hidden="true" tabindex="-1"></a>              <span class="fu">br</span>(),</span>
<span id="cb166-60"><a href="#cb166-60" aria-hidden="true" tabindex="-1"></a>              <span class="fu">p</span>(<span class="st">"- Age: The age of the patient."</span>),</span>
<span id="cb166-61"><a href="#cb166-61" aria-hidden="true" tabindex="-1"></a>              <span class="fu">p</span>(<span class="st">"- REst: Hormone receptor status (N: Negative, P: Positive)."</span>),</span>
<span id="cb166-62"><a href="#cb166-62" aria-hidden="true" tabindex="-1"></a>              <span class="fu">p</span>(<span class="st">"- Grade: Histological grade of the tumor (1, 2, or 3)."</span>),</span>
<span id="cb166-63"><a href="#cb166-63" aria-hidden="true" tabindex="-1"></a>              <span class="fu">p</span>(<span class="st">"- Phenotype: Tumor phenotype (Basal, Her2, LumA, LumB, or Normal)."</span>),</span>
<span id="cb166-64"><a href="#cb166-64" aria-hidden="true" tabindex="-1"></a>              <span class="fu">br</span>(),</span>
<span id="cb166-65"><a href="#cb166-65" aria-hidden="true" tabindex="-1"></a>              <span class="st">"It's important to note that this prediction is based on statistical modeling and should not replace personalized medical advice. Please consult with your healthcare provider for any concerns or questions regarding breast cancer diagnosis or treatment."</span>,</span>
<span id="cb166-66"><a href="#cb166-66" aria-hidden="true" tabindex="-1"></a>              tags<span class="sc">$</span><span class="fu">button</span>(<span class="at">type =</span> <span class="st">"button"</span>, <span class="at">class =</span> <span class="st">"btn-close"</span>, <span class="at">onclick =</span> <span class="st">"shinyjs.hide('help_container');"</span>)</span>
<span id="cb166-67"><a href="#cb166-67" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb166-68"><a href="#cb166-68" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb166-69"><a href="#cb166-69" aria-hidden="true" tabindex="-1"></a>      <span class="fu">br</span>(),</span>
<span id="cb166-70"><a href="#cb166-70" aria-hidden="true" tabindex="-1"></a>      <span class="fu">div</span>(<span class="at">id =</span> <span class="st">"progress_container"</span>, <span class="at">style =</span> <span class="st">"display: none;"</span>,</span>
<span id="cb166-71"><a href="#cb166-71" aria-hidden="true" tabindex="-1"></a>          <span class="fu">div</span>(<span class="at">class =</span> <span class="st">"progress"</span>,</span>
<span id="cb166-72"><a href="#cb166-72" aria-hidden="true" tabindex="-1"></a>              <span class="fu">div</span>(<span class="at">class =</span> <span class="st">"progress-bar"</span>, <span class="at">role =</span> <span class="st">"progressbar"</span>, </span>
<span id="cb166-73"><a href="#cb166-73" aria-hidden="true" tabindex="-1"></a>                  <span class="at">style =</span> <span class="st">"width: 0%;"</span>, <span class="at">aria_valuenow =</span> <span class="st">"0"</span>, <span class="at">aria_valuemin =</span> <span class="st">"0"</span>, <span class="at">aria_valuemax =</span> <span class="st">"100"</span>)</span>
<span id="cb166-74"><a href="#cb166-74" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb166-75"><a href="#cb166-75" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb166-76"><a href="#cb166-76" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb166-77"><a href="#cb166-77" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb166-78"><a href="#cb166-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-79"><a href="#cb166-79" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the server logic</span></span>
<span id="cb166-80"><a href="#cb166-80" aria-hidden="true" tabindex="-1"></a>server <span class="ot">&lt;-</span> <span class="cf">function</span>(input, output, session) {</span>
<span id="cb166-81"><a href="#cb166-81" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Perform prediction when the button is clicked</span></span>
<span id="cb166-82"><a href="#cb166-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">observeEvent</span>(input<span class="sc">$</span>submit_button, {</span>
<span id="cb166-83"><a href="#cb166-83" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Collect user input data</span></span>
<span id="cb166-84"><a href="#cb166-84" aria-hidden="true" tabindex="-1"></a>    datos_usuario <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb166-85"><a href="#cb166-85" aria-hidden="true" tabindex="-1"></a>      <span class="at">Edad =</span> <span class="fu">factor</span>(input<span class="sc">$</span>input_edad, <span class="at">levels =</span> niveles_edad),</span>
<span id="cb166-86"><a href="#cb166-86" aria-hidden="true" tabindex="-1"></a>      <span class="at">REst =</span> <span class="fu">factor</span>(input<span class="sc">$</span>input_rest, <span class="at">levels =</span> niveles_rest),</span>
<span id="cb166-87"><a href="#cb166-87" aria-hidden="true" tabindex="-1"></a>      <span class="at">Grado =</span> <span class="fu">factor</span>(input<span class="sc">$</span>input_grado, <span class="at">levels =</span> niveles_grado),</span>
<span id="cb166-88"><a href="#cb166-88" aria-hidden="true" tabindex="-1"></a>      <span class="at">Fenotipo =</span> <span class="fu">factor</span>(input<span class="sc">$</span>input_fenotipo, <span class="at">levels =</span> niveles_fenotipo)</span>
<span id="cb166-89"><a href="#cb166-89" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb166-90"><a href="#cb166-90" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb166-91"><a href="#cb166-91" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Show progress bar</span></span>
<span id="cb166-92"><a href="#cb166-92" aria-hidden="true" tabindex="-1"></a>    shinyjs<span class="sc">::</span><span class="fu">show</span>(<span class="st">"progress_container"</span>)</span>
<span id="cb166-93"><a href="#cb166-93" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb166-94"><a href="#cb166-94" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update the progress bar</span></span>
<span id="cb166-95"><a href="#cb166-95" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">100</span>, <span class="at">by =</span> <span class="dv">25</span>)) {</span>
<span id="cb166-96"><a href="#cb166-96" aria-hidden="true" tabindex="-1"></a>      shinyjs<span class="sc">::</span><span class="fu">runjs</span>(<span class="fu">paste0</span>(<span class="st">"$('.progress-bar').css('width', '"</span>, i, <span class="st">"%').attr('aria-valuenow', '"</span>, i, <span class="st">"');"</span>))</span>
<span id="cb166-97"><a href="#cb166-97" aria-hidden="true" tabindex="-1"></a>      <span class="fu">Sys.sleep</span>(<span class="fl">0.25</span>)  <span class="co"># Shortened to 0.25 seconds to match 1 second total duration</span></span>
<span id="cb166-98"><a href="#cb166-98" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb166-99"><a href="#cb166-99" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb166-100"><a href="#cb166-100" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Perform prediction using the loaded model</span></span>
<span id="cb166-101"><a href="#cb166-101" aria-hidden="true" tabindex="-1"></a>    prediccion <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelo, <span class="at">newdata =</span> datos_usuario, <span class="at">type =</span> <span class="st">"raw"</span>)</span>
<span id="cb166-102"><a href="#cb166-102" aria-hidden="true" tabindex="-1"></a>    probabilidad <span class="ot">&lt;-</span> prediccion[<span class="dv">2</span>]</span>
<span id="cb166-103"><a href="#cb166-103" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb166-104"><a href="#cb166-104" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Display the prediction to the user</span></span>
<span id="cb166-105"><a href="#cb166-105" aria-hidden="true" tabindex="-1"></a>    output<span class="sc">$</span>resultado_prediccion <span class="ot">&lt;-</span> <span class="fu">renderText</span>({</span>
<span id="cb166-106"><a href="#cb166-106" aria-hidden="true" tabindex="-1"></a>      <span class="fu">paste</span>(<span class="st">"The probability that the result is 'YES' is:"</span>, <span class="fu">round</span>(probabilidad, <span class="dv">2</span>))</span>
<span id="cb166-107"><a href="#cb166-107" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb166-108"><a href="#cb166-108" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb166-109"><a href="#cb166-109" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Hide the progress bar after completing the prediction</span></span>
<span id="cb166-110"><a href="#cb166-110" aria-hidden="true" tabindex="-1"></a>    shinyjs<span class="sc">::</span><span class="fu">hide</span>(<span class="st">"progress_container"</span>)</span>
<span id="cb166-111"><a href="#cb166-111" aria-hidden="true" tabindex="-1"></a>    shinyjs<span class="sc">::</span><span class="fu">show</span>(<span class="st">"resultado_container"</span>)</span>
<span id="cb166-112"><a href="#cb166-112" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb166-113"><a href="#cb166-113" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb166-114"><a href="#cb166-114" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Display help alert if requested</span></span>
<span id="cb166-115"><a href="#cb166-115" aria-hidden="true" tabindex="-1"></a>  <span class="fu">observeEvent</span>(input<span class="sc">$</span>help_button, {</span>
<span id="cb166-116"><a href="#cb166-116" aria-hidden="true" tabindex="-1"></a>    shinyjs<span class="sc">::</span><span class="fu">show</span>(<span class="st">"help_container"</span>)</span>
<span id="cb166-117"><a href="#cb166-117" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb166-118"><a href="#cb166-118" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb166-119"><a href="#cb166-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-120"><a href="#cb166-120" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the Shiny app</span></span>
<span id="cb166-121"><a href="#cb166-121" aria-hidden="true" tabindex="-1"></a><span class="fu">shinyApp</span>(ui, server)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>To deploy the app we are going to use the rsconnect package. First, we have to set our account information and deploy the app using the following code:</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb167"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a><span class="co">#subir la app</span></span>
<span id="cb167-2"><a href="#cb167-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rsconnect)</span>
<span id="cb167-3"><a href="#cb167-3" aria-hidden="true" tabindex="-1"></a>rsconnect<span class="sc">::</span><span class="fu">setAccountInfo</span>(<span class="at">name=</span><span class="st">'nombre_de_usuario'</span>, <span class="at">token=</span><span class="st">'TU_TOKEN'</span>, <span class="at">secret=</span><span class="st">'TU_SECRET'</span>)</span>
<span id="cb167-4"><a href="#cb167-4" aria-hidden="true" tabindex="-1"></a>rsconnect<span class="sc">::</span><span class="fu">deployApp</span>(<span class="st">'ruta_de_la_app'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<style>
 .iframe-container {
            width: 80%;
            margin: auto;
            border: 1px solid #555;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            position: relative;
            background-color: #3b3b3b;
        }

        .iframe-tab {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 8px;
            background-color: #4a4a4a;
            border-bottom: 1px solid #555;
        }

        .iframe-tab-buttons {
            display: flex;
            align-items: center;
        }

        .iframe-tab-buttons button {
            width: 20px;
            height: 20px;
            margin-left: 4px;
            background-color: #666;
            border: none;
            border-radius: 2px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: not-allowed; /* Indica que no son funcionales */
            position: relative;
        }

        .iframe-tab-buttons button span {
            display: block;
            background-color: #ccc;
        }

        .iframe-tab-buttons button.minimize span {
            width: 12px;
            height: 2px;
        }

        .iframe-tab-buttons button.maximize span {
            width: 10px;
            height: 10px;
            border: 2px solid #ccc;
            box-sizing: border-box;
        }

        .iframe-tab-buttons button.close span {
            width: 12px;
            height: 12px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .iframe-tab-buttons button.close span:before,
        .iframe-tab-buttons button.close span:after {
            content: '';
            position: absolute;
            width: 6px;
            height: 2px;
            background-color: #ccc;
        }

        .iframe-tab-buttons button.close span:before {
            transform: rotate(45deg);
        }

        .iframe-tab-buttons button.close span:after {
            transform: rotate(-45deg);
        }

        .iframe-content {
            width: 100%;
            height: 500px; /* Ajusta la altura según tus necesidades */
            border: none;
            display: block;
        }
   
</style>
<div class="iframe-container">
        <div class="iframe-tab">
            <div class="iframe-tab-buttons">
                <button class="minimize" title="Minimizar"><span></span></button>
                <button class="maximize" title="Maximizar"><span></span></button>
                <button class="close" title="Cerrar"><span></span></button>
            </div>
        </div>
        <iframe src="https://g9bjvd-alex0silva.shinyapps.io/cancerapp/" class="iframe-content"></iframe>
    </div>

</section>
<section id="conclusions" class="level1">
<h1>Conclusions</h1>
<p>In this project, we have compared the performance of many machine learning algorithms for predicting methastasis in breast cancer. We have adapted the validation process and the hyperparameters selection to our computational resources.</p>
<p><br></p>
<p>In the variable selection process, we have found that the most performant technique is the wrapper method, but it is computationally expensive. The filter method is less computationally expensive, but it does not have in concern the interaction between variables. Embedded methods are a good compromise between the two previous methods but are not as performant as the wrapper method.</p>
<p><br></p>
<p>The final model uses the Naive Bayes algorithm. The model achieved an AUC of 0.75 in the cross-validation process. The model is deployed in a Shiny app that allows users to predict the probability of methastasis in breast cancer based on four variables: age, hormone receptor status, histological grade, and tumor phenotype.</p>
<p><br></p>
<p>The next step is to carry out a external validation of the model. This process will allow us to evaluate the model’s performance in new data.</p>
</section>
<section id="references" class="level1">
<h1>References</h1>
<ul>
<li><p>Renan Gomes do Nascimento, Kaléu Mormino Otoni. (2020).Histological and molecular classification of breast cancer: what do we know?</p></li>
<li><p>Predict breast cancer (2024). URL: https://breast.predict.cam/tool</p></li>
<li><p>Gepac. Etapas y grado histológico(2024) URL:http://ascama.gepac.es/informacion-medica/etapas-y-grado-histologico/</p></li>
<li><p>Jackson, E. B., Gondara, L., Speers, C., Diocee, R., Nichol, A. M., Lohrisch, C., &amp; Gelmon, K. A. (2023). Does age affect outcome with breast cancer?</p></li>
</ul>
<div id="scrollToTopContainer" style="position: fixed; bottom: 20px; right: 20px; display: none;">
  <button onclick="goToTop()" id="btnScrollToTop" type="button" class="btn btn-primary btn-lg">
    ↑
  </button>
</div>
<p>importante quitar cellnoseq de los statistic analisis</p>
<!-- -->

</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb168" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb168-2"><a href="#cb168-2" aria-hidden="true" tabindex="-1"></a><span class="an">editor:</span><span class="co"> </span></span>
<span id="cb168-3"><a href="#cb168-3" aria-hidden="true" tabindex="-1"></a><span class="co">  markdown: </span></span>
<span id="cb168-4"><a href="#cb168-4" aria-hidden="true" tabindex="-1"></a><span class="co">      wrap: sentence</span></span>
<span id="cb168-5"><a href="#cb168-5" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> Breast Cancer Survival Prediction</span></span>
<span id="cb168-6"><a href="#cb168-6" aria-hidden="true" tabindex="-1"></a><span class="an">code-fold:</span><span class="co"> true</span></span>
<span id="cb168-7"><a href="#cb168-7" aria-hidden="true" tabindex="-1"></a><span class="an">code-tools:</span><span class="co"> true</span></span>
<span id="cb168-8"><a href="#cb168-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-9"><a href="#cb168-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-10"><a href="#cb168-10" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb168-11"><a href="#cb168-11" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb168-12"><a href="#cb168-12" aria-hidden="true" tabindex="-1"></a><span class="co">    theme: morph</span></span>
<span id="cb168-13"><a href="#cb168-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-14"><a href="#cb168-14" aria-hidden="true" tabindex="-1"></a><span class="an">warning:</span><span class="co"> false</span></span>
<span id="cb168-15"><a href="#cb168-15" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb168-16"><a href="#cb168-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-17"><a href="#cb168-17" aria-hidden="true" tabindex="-1"></a>::: {style="display:inline-block;"}</span>
<span id="cb168-18"><a href="#cb168-18" aria-hidden="true" tabindex="-1"></a>&lt;link href="https://cdn-icons-png.flaticon.com/128/3916/3916763.png" rel="icon"&gt;</span>
<span id="cb168-19"><a href="#cb168-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-20"><a href="#cb168-20" aria-hidden="true" tabindex="-1"></a>&lt;h6 style="text-align:center"&gt;</span>
<span id="cb168-21"><a href="#cb168-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-22"><a href="#cb168-22" aria-hidden="true" tabindex="-1"></a>Alejandro Silva Rodriguez</span>
<span id="cb168-23"><a href="#cb168-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-24"><a href="#cb168-24" aria-hidden="true" tabindex="-1"></a>&lt;/h6&gt;</span>
<span id="cb168-25"><a href="#cb168-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-26"><a href="#cb168-26" aria-hidden="true" tabindex="-1"></a>::: {style="text-align:center"}</span>
<span id="cb168-27"><a href="#cb168-27" aria-hidden="true" tabindex="-1"></a>&lt;a href="https://alexsilvaa9.github.io" title="Visit my Portfolio" target="_blank" class="btn btn-light" style="margin: 10px; padding: 7;"&gt; &lt;img src="https://cdn-icons-png.flaticon.com/512/10013/10013417.png" alt="LinkedIn" class="icon-link" width="30" height="30"/&gt; &lt;/a&gt; &lt;a href="https://github.com/AlexSilvaa9" title="Viisit my GitHub" target="_blank" class="btn btn-light" style="margin: 10px; padding: 7;"&gt; &lt;img src="https://cdn-icons-png.flaticon.com/512/25/25231.png" alt="GitHub" class="icon-link" width="25" height="25"/&gt; &lt;/a&gt; &lt;a href="https://www.linkedin.com/in/alejandro-silva-rodr%C3%ADguez-133293257/" title="Visit my LinkedIn" target="_blank"class="btn btn-light" style="margin: 10px; padding: 7;"&gt; &lt;img src="https://cdn-icons-png.flaticon.com/512/61/61109.png" alt="LinkedIn" class="icon-link" width="25" height="25"/&gt; &lt;/a&gt;</span>
<span id="cb168-28"><a href="#cb168-28" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb168-29"><a href="#cb168-29" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb168-30"><a href="#cb168-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-31"><a href="#cb168-31" aria-hidden="true" tabindex="-1"></a><span class="in">```{=html}</span></span>
<span id="cb168-32"><a href="#cb168-32" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;style&gt;</span></span>
<span id="cb168-33"><a href="#cb168-33" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-34"><a href="#cb168-34" aria-hidden="true" tabindex="-1"></a><span class="in">    .fullcontent{</span></span>
<span id="cb168-35"><a href="#cb168-35" aria-hidden="true" tabindex="-1"></a><span class="in">      background-color: rgb(226, 231, 236);</span></span>
<span id="cb168-36"><a href="#cb168-36" aria-hidden="true" tabindex="-1"></a><span class="in">      text-align: justify;  </span></span>
<span id="cb168-37"><a href="#cb168-37" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb168-38"><a href="#cb168-38" aria-hidden="true" tabindex="-1"></a><span class="in">   </span></span>
<span id="cb168-39"><a href="#cb168-39" aria-hidden="true" tabindex="-1"></a><span class="in">    p{</span></span>
<span id="cb168-40"><a href="#cb168-40" aria-hidden="true" tabindex="-1"></a><span class="in">    color:black;</span></span>
<span id="cb168-41"><a href="#cb168-41" aria-hidden="true" tabindex="-1"></a><span class="in">    margin: 0;</span></span>
<span id="cb168-42"><a href="#cb168-42" aria-hidden="true" tabindex="-1"></a><span class="in">    padding: 0;</span></span>
<span id="cb168-43"><a href="#cb168-43" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb168-44"><a href="#cb168-44" aria-hidden="true" tabindex="-1"></a><span class="in">    .icon-link {</span></span>
<span id="cb168-45"><a href="#cb168-45" aria-hidden="true" tabindex="-1"></a><span class="in">        text-aling:center;</span></span>
<span id="cb168-46"><a href="#cb168-46" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb168-47"><a href="#cb168-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-48"><a href="#cb168-48" aria-hidden="true" tabindex="-1"></a><span class="in">    .icon-link:hover {</span></span>
<span id="cb168-49"><a href="#cb168-49" aria-hidden="true" tabindex="-1"></a><span class="in">        opacity: 0.4;</span></span>
<span id="cb168-50"><a href="#cb168-50" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb168-51"><a href="#cb168-51" aria-hidden="true" tabindex="-1"></a><span class="in">    a {</span></span>
<span id="cb168-52"><a href="#cb168-52" aria-hidden="true" tabindex="-1"></a><span class="in">        text-decoration: none;</span></span>
<span id="cb168-53"><a href="#cb168-53" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb168-54"><a href="#cb168-54" aria-hidden="true" tabindex="-1"></a><span class="in">    a:hover {</span></span>
<span id="cb168-55"><a href="#cb168-55" aria-hidden="true" tabindex="-1"></a><span class="in">        text-decoration: none;</span></span>
<span id="cb168-56"><a href="#cb168-56" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb168-57"><a href="#cb168-57" aria-hidden="true" tabindex="-1"></a><span class="in"> </span></span>
<span id="cb168-58"><a href="#cb168-58" aria-hidden="true" tabindex="-1"></a><span class="in">/* Hacer que los encabezados h1 y h2 sean sticky */</span></span>
<span id="cb168-59"><a href="#cb168-59" aria-hidden="true" tabindex="-1"></a><span class="in">h1 {</span></span>
<span id="cb168-60"><a href="#cb168-60" aria-hidden="true" tabindex="-1"></a><span class="in">  position: -webkit-sticky; </span></span>
<span id="cb168-61"><a href="#cb168-61" aria-hidden="true" tabindex="-1"></a><span class="in">  position: sticky;</span></span>
<span id="cb168-62"><a href="#cb168-62" aria-hidden="true" tabindex="-1"></a><span class="in">  top: 20px;</span></span>
<span id="cb168-63"><a href="#cb168-63" aria-hidden="true" tabindex="-1"></a><span class="in">  display:inline-block;</span></span>
<span id="cb168-64"><a href="#cb168-64" aria-hidden="true" tabindex="-1"></a><span class="in"> </span></span>
<span id="cb168-65"><a href="#cb168-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-66"><a href="#cb168-66" aria-hidden="true" tabindex="-1"></a><span class="in">  z-index: 1000; /* Z-index para asegurar que los encabezados sean visibles */</span></span>
<span id="cb168-67"><a href="#cb168-67" aria-hidden="true" tabindex="-1"></a><span class="in">  padding: 10px; /* Espacio interior alrededor del encabezado */</span></span>
<span id="cb168-68"><a href="#cb168-68" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb168-69"><a href="#cb168-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-70"><a href="#cb168-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-71"><a href="#cb168-71" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;/style&gt;</span></span>
<span id="cb168-72"><a href="#cb168-72" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-73"><a href="#cb168-73" aria-hidden="true" tabindex="-1"></a><span class="in">```{=html}</span></span>
<span id="cb168-74"><a href="#cb168-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-75"><a href="#cb168-75" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;script&gt;</span></span>
<span id="cb168-76"><a href="#cb168-76" aria-hidden="true" tabindex="-1"></a><span class="in">  window.onscroll = function() {</span></span>
<span id="cb168-77"><a href="#cb168-77" aria-hidden="true" tabindex="-1"></a><span class="in">    scrollFunction();</span></span>
<span id="cb168-78"><a href="#cb168-78" aria-hidden="true" tabindex="-1"></a><span class="in">  };</span></span>
<span id="cb168-79"><a href="#cb168-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-80"><a href="#cb168-80" aria-hidden="true" tabindex="-1"></a><span class="in">  function scrollFunction() {</span></span>
<span id="cb168-81"><a href="#cb168-81" aria-hidden="true" tabindex="-1"></a><span class="in">    if (document.body.scrollTop &gt; 20 || document.documentElement.scrollTop &gt; 20) {</span></span>
<span id="cb168-82"><a href="#cb168-82" aria-hidden="true" tabindex="-1"></a><span class="in">      document.getElementById("scrollToTopContainer").style.display = "block";</span></span>
<span id="cb168-83"><a href="#cb168-83" aria-hidden="true" tabindex="-1"></a><span class="in">    } else {</span></span>
<span id="cb168-84"><a href="#cb168-84" aria-hidden="true" tabindex="-1"></a><span class="in">      document.getElementById("scrollToTopContainer").style.display = "none";</span></span>
<span id="cb168-85"><a href="#cb168-85" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb168-86"><a href="#cb168-86" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb168-87"><a href="#cb168-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-88"><a href="#cb168-88" aria-hidden="true" tabindex="-1"></a><span class="in">  function goToTop() {</span></span>
<span id="cb168-89"><a href="#cb168-89" aria-hidden="true" tabindex="-1"></a><span class="in">    document.body.scrollTop = 0;</span></span>
<span id="cb168-90"><a href="#cb168-90" aria-hidden="true" tabindex="-1"></a><span class="in">    document.documentElement.scrollTop = 0;</span></span>
<span id="cb168-91"><a href="#cb168-91" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb168-92"><a href="#cb168-92" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;/script&gt;</span></span>
<span id="cb168-93"><a href="#cb168-93" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-94"><a href="#cb168-94" aria-hidden="true" tabindex="-1"></a>::: index</span>
<span id="cb168-95"><a href="#cb168-95" aria-hidden="true" tabindex="-1"></a><span class="fu"># Index</span></span>
<span id="cb168-96"><a href="#cb168-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-97"><a href="#cb168-97" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">1. Introduction</span><span class="co">](#introduction)</span></span>
<span id="cb168-98"><a href="#cb168-98" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">2. Data Cleaning</span><span class="co">](#data-cleaning)</span></span>
<span id="cb168-99"><a href="#cb168-99" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">3. Statistic Analysis</span><span class="co">](#statistic-analysis)</span></span>
<span id="cb168-100"><a href="#cb168-100" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">4. Variable selection</span><span class="co">](#variable-selection)</span></span>
<span id="cb168-101"><a href="#cb168-101" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">5. Models</span><span class="co">](#models)</span></span>
<span id="cb168-102"><a href="#cb168-102" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">6. Models comparison</span><span class="co">](#models-comparison)</span></span>
<span id="cb168-103"><a href="#cb168-103" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">7, Final Model</span><span class="co">](#final-model)</span></span>
<span id="cb168-104"><a href="#cb168-104" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">8. Deployment</span><span class="co">](#deployment)</span></span>
<span id="cb168-105"><a href="#cb168-105" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">9. Conclusions</span><span class="co">](#conclusions)</span></span>
<span id="cb168-106"><a href="#cb168-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-107"><a href="#cb168-107" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb168-108"><a href="#cb168-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-109"><a href="#cb168-109" aria-hidden="true" tabindex="-1"></a><span class="in">```{r global.options, include = TRUE}</span></span>
<span id="cb168-110"><a href="#cb168-110" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::opts_chunk$set(</span></span>
<span id="cb168-111"><a href="#cb168-111" aria-hidden="true" tabindex="-1"></a><span class="in">    fig.align   = 'center', # how to align graphics in the final doc. 'left', 'right', 'center'</span></span>
<span id="cb168-112"><a href="#cb168-112" aria-hidden="true" tabindex="-1"></a><span class="in">    warning     = FALSE)    # if FALSE knitr will not display any warning messages in the final document</span></span>
<span id="cb168-113"><a href="#cb168-113" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-114"><a href="#cb168-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-115"><a href="#cb168-115" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo=FALSE,warning=FALSE,results='hide'}</span></span>
<span id="cb168-116"><a href="#cb168-116" aria-hidden="true" tabindex="-1"></a><span class="in">library(readxl)</span></span>
<span id="cb168-117"><a href="#cb168-117" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggplot2)</span></span>
<span id="cb168-118"><a href="#cb168-118" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidyverse)</span></span>
<span id="cb168-119"><a href="#cb168-119" aria-hidden="true" tabindex="-1"></a><span class="in">library(dplyr)</span></span>
<span id="cb168-120"><a href="#cb168-120" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggthemes)</span></span>
<span id="cb168-121"><a href="#cb168-121" aria-hidden="true" tabindex="-1"></a><span class="in">library(gridExtra)</span></span>
<span id="cb168-122"><a href="#cb168-122" aria-hidden="true" tabindex="-1"></a><span class="in">source("../analisis_automatico.R")</span></span>
<span id="cb168-123"><a href="#cb168-123" aria-hidden="true" tabindex="-1"></a><span class="in">library(kableExtra)</span></span>
<span id="cb168-124"><a href="#cb168-124" aria-hidden="true" tabindex="-1"></a><span class="in">library(broom)</span></span>
<span id="cb168-125"><a href="#cb168-125" aria-hidden="true" tabindex="-1"></a><span class="in">library(MASS)</span></span>
<span id="cb168-126"><a href="#cb168-126" aria-hidden="true" tabindex="-1"></a><span class="in">library(reshape2)</span></span>
<span id="cb168-127"><a href="#cb168-127" aria-hidden="true" tabindex="-1"></a><span class="in">library(ROCR)</span></span>
<span id="cb168-128"><a href="#cb168-128" aria-hidden="true" tabindex="-1"></a><span class="in">library(caret)</span></span>
<span id="cb168-129"><a href="#cb168-129" aria-hidden="true" tabindex="-1"></a><span class="in">library(purrr)</span></span>
<span id="cb168-130"><a href="#cb168-130" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidyr)</span></span>
<span id="cb168-131"><a href="#cb168-131" aria-hidden="true" tabindex="-1"></a><span class="in">library(e1071)</span></span>
<span id="cb168-132"><a href="#cb168-132" aria-hidden="true" tabindex="-1"></a><span class="in">library(nnet)</span></span>
<span id="cb168-133"><a href="#cb168-133" aria-hidden="true" tabindex="-1"></a><span class="in">library(pROC)</span></span>
<span id="cb168-134"><a href="#cb168-134" aria-hidden="true" tabindex="-1"></a><span class="in">library(rpart)</span></span>
<span id="cb168-135"><a href="#cb168-135" aria-hidden="true" tabindex="-1"></a><span class="in">library(rpart.plot)</span></span>
<span id="cb168-136"><a href="#cb168-136" aria-hidden="true" tabindex="-1"></a><span class="in">library(class)</span></span>
<span id="cb168-137"><a href="#cb168-137" aria-hidden="true" tabindex="-1"></a><span class="in">library(knitr)</span></span>
<span id="cb168-138"><a href="#cb168-138" aria-hidden="true" tabindex="-1"></a><span class="in">library(dplyr)</span></span>
<span id="cb168-139"><a href="#cb168-139" aria-hidden="true" tabindex="-1"></a><span class="in">library(ROSE)</span></span>
<span id="cb168-140"><a href="#cb168-140" aria-hidden="true" tabindex="-1"></a><span class="in">library(randomForest)</span></span>
<span id="cb168-141"><a href="#cb168-141" aria-hidden="true" tabindex="-1"></a><span class="in">library(mboost)</span></span>
<span id="cb168-142"><a href="#cb168-142" aria-hidden="true" tabindex="-1"></a><span class="in">library(mice)</span></span>
<span id="cb168-143"><a href="#cb168-143" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-144"><a href="#cb168-144" aria-hidden="true" tabindex="-1"></a><span class="fu"># Introduction {#introduction}</span></span>
<span id="cb168-145"><a href="#cb168-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-146"><a href="#cb168-146" aria-hidden="true" tabindex="-1"></a>The aim of this report is to develop a predictive model to estimate the survival of breast cancer patients. </span>
<span id="cb168-147"><a href="#cb168-147" aria-hidden="true" tabindex="-1"></a>This feature can boost the efficiency of oncology treatments and drastically improve the wellbeing of patients.</span>
<span id="cb168-148"><a href="#cb168-148" aria-hidden="true" tabindex="-1"></a>Using a dataset including both clinical and demographic data, we are going to analyze the relations between the variables in order to build a valuable predictor.</span>
<span id="cb168-149"><a href="#cb168-149" aria-hidden="true" tabindex="-1"></a>On top of that, we are going to carry out a model comparison to select the most accurate one and deploy it in a Shiny app.</span>
<span id="cb168-150"><a href="#cb168-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-151"><a href="#cb168-151" aria-hidden="true" tabindex="-1"></a><span class="fu"># Methodology</span></span>
<span id="cb168-152"><a href="#cb168-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-153"><a href="#cb168-153" aria-hidden="true" tabindex="-1"></a>This study aims to develop predictive models for breast cancer. The dataset includes 500 patients with variables such as age at diagnosis, date at diagnosis, menopausal status, type of surgery, histology, tumor size, grade, ER, PR, HER2, Ki67, IHC phenotype, lymph nodes, stage, and current status.</span>
<span id="cb168-154"><a href="#cb168-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-155"><a href="#cb168-155" aria-hidden="true" tabindex="-1"></a>The methodology involves:</span>
<span id="cb168-156"><a href="#cb168-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-157"><a href="#cb168-157" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Data Preprocessing:** Exploratory data analysis will be conducted to understand data distributions and identify outliers. Missing data will be handled through imputation techniques.</span>
<span id="cb168-158"><a href="#cb168-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-159"><a href="#cb168-159" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Model Development:** Various machine learning algorithms such as logistic regression, decision trees, random forests will be employed to develop predictive models. Feature engineering and selection techniques will be utilized to improve model performance.</span>
<span id="cb168-160"><a href="#cb168-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-161"><a href="#cb168-161" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Model Evaluation:** The models will be evaluated using 5x2 cross-validation to ensure robustness and generalizability. Performance metrics such as AUC-ROC, precision, recall, and F1-score will be used to assess model performance.</span>
<span id="cb168-162"><a href="#cb168-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-163"><a href="#cb168-163" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Variable Selection:** Different variable selection methods including filtering, wrapper, and embedded methods will be explored to identify the most important predictors for the event of interest.</span>
<span id="cb168-164"><a href="#cb168-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-165"><a href="#cb168-165" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**Model Comparison:** The performance of different models will be compared based on evaluation metrics to select the best-performing model.</span>
<span id="cb168-166"><a href="#cb168-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-167"><a href="#cb168-167" aria-hidden="true" tabindex="-1"></a><span class="ss">6. </span>**Deployment:** The final selected model will be deployed in an application framework for practical use.</span>
<span id="cb168-168"><a href="#cb168-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-169"><a href="#cb168-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-170"><a href="#cb168-170" aria-hidden="true" tabindex="-1"></a><span class="fu">##### Dataset description:</span></span>
<span id="cb168-171"><a href="#cb168-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-172"><a href="#cb168-172" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,results='asis'}</span></span>
<span id="cb168-173"><a href="#cb168-173" aria-hidden="true" tabindex="-1"></a><span class="in"># Create data for the table</span></span>
<span id="cb168-174"><a href="#cb168-174" aria-hidden="true" tabindex="-1"></a><span class="in"># Crear los datos para la tabla</span></span>
<span id="cb168-175"><a href="#cb168-175" aria-hidden="true" tabindex="-1"></a><span class="in">column &lt;- c("EDAD_DCO", "F.DIAG", "MENOP", "CIRUGIA", "HISTOLOGIA", "TAM", </span></span>
<span id="cb168-176"><a href="#cb168-176" aria-hidden="true" tabindex="-1"></a><span class="in">            "GRADO", "RE", "RP", "HER2", "KI67", "FENOTIPO", "GANGLIOS", "ESTADIO", "ESTADO_ACTUAL")</span></span>
<span id="cb168-177"><a href="#cb168-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-178"><a href="#cb168-178" aria-hidden="true" tabindex="-1"></a><span class="in">description &lt;- c("Patient age at diagnosis in years",</span></span>
<span id="cb168-179"><a href="#cb168-179" aria-hidden="true" tabindex="-1"></a><span class="in">                 "Date of diagnosis",</span></span>
<span id="cb168-180"><a href="#cb168-180" aria-hidden="true" tabindex="-1"></a><span class="in">                 "Menopausal status",</span></span>
<span id="cb168-181"><a href="#cb168-181" aria-hidden="true" tabindex="-1"></a><span class="in">                 "Surgery type",</span></span>
<span id="cb168-182"><a href="#cb168-182" aria-hidden="true" tabindex="-1"></a><span class="in">                 "Histology type",</span></span>
<span id="cb168-183"><a href="#cb168-183" aria-hidden="true" tabindex="-1"></a><span class="in">                 "Tumor size (cm)",</span></span>
<span id="cb168-184"><a href="#cb168-184" aria-hidden="true" tabindex="-1"></a><span class="in">                 "Tumor grade (1 to 3)",</span></span>
<span id="cb168-185"><a href="#cb168-185" aria-hidden="true" tabindex="-1"></a><span class="in">                 "Estrogen receptors percentage",</span></span>
<span id="cb168-186"><a href="#cb168-186" aria-hidden="true" tabindex="-1"></a><span class="in">                 "Progesterone receptors percentage",</span></span>
<span id="cb168-187"><a href="#cb168-187" aria-hidden="true" tabindex="-1"></a><span class="in">                 "Her2 expression (Positive/Negative)",</span></span>
<span id="cb168-188"><a href="#cb168-188" aria-hidden="true" tabindex="-1"></a><span class="in">                 "Ki-67 index (percentage)",</span></span>
<span id="cb168-189"><a href="#cb168-189" aria-hidden="true" tabindex="-1"></a><span class="in">                 "Phenotype determined by PAM50",</span></span>
<span id="cb168-190"><a href="#cb168-190" aria-hidden="true" tabindex="-1"></a><span class="in">                 "Number of affected lymph nodes",</span></span>
<span id="cb168-191"><a href="#cb168-191" aria-hidden="true" tabindex="-1"></a><span class="in">                 "Disease stage (from T1 to T4)",</span></span>
<span id="cb168-192"><a href="#cb168-192" aria-hidden="true" tabindex="-1"></a><span class="in">                 "Current status of the patient")</span></span>
<span id="cb168-193"><a href="#cb168-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-194"><a href="#cb168-194" aria-hidden="true" tabindex="-1"></a><span class="in"># Crear el dataframe</span></span>
<span id="cb168-195"><a href="#cb168-195" aria-hidden="true" tabindex="-1"></a><span class="in">datos &lt;- data.frame(Column = column, Description = description)</span></span>
<span id="cb168-196"><a href="#cb168-196" aria-hidden="true" tabindex="-1"></a><span class="in"># Generar la tabla HTML con kable y aplicar estilos con kableExtra</span></span>
<span id="cb168-197"><a href="#cb168-197" aria-hidden="true" tabindex="-1"></a><span class="in">styled_table &lt;- datos %&gt;%</span></span>
<span id="cb168-198"><a href="#cb168-198" aria-hidden="true" tabindex="-1"></a><span class="in">  kable(format = "html", align = "c", caption = "Dataset Description") %&gt;%</span></span>
<span id="cb168-199"><a href="#cb168-199" aria-hidden="true" tabindex="-1"></a><span class="in">  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = FALSE)</span></span>
<span id="cb168-200"><a href="#cb168-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-201"><a href="#cb168-201" aria-hidden="true" tabindex="-1"></a><span class="in"># Imprimir la tabla estilizada</span></span>
<span id="cb168-202"><a href="#cb168-202" aria-hidden="true" tabindex="-1"></a><span class="in">print(styled_table)</span></span>
<span id="cb168-203"><a href="#cb168-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-204"><a href="#cb168-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-205"><a href="#cb168-205" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-206"><a href="#cb168-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-207"><a href="#cb168-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-208"><a href="#cb168-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-209"><a href="#cb168-209" aria-hidden="true" tabindex="-1"></a><span class="fu"># Data Cleaning {#data-cleaning}</span></span>
<span id="cb168-210"><a href="#cb168-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-211"><a href="#cb168-211" aria-hidden="true" tabindex="-1"></a>The first step is to import and clean the data.</span>
<span id="cb168-212"><a href="#cb168-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-213"><a href="#cb168-213" aria-hidden="true" tabindex="-1"></a>Some of the most important data transformation are:</span>
<span id="cb168-214"><a href="#cb168-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-215"><a href="#cb168-215" aria-hidden="true" tabindex="-1"></a>&lt;br&gt;</span>
<span id="cb168-216"><a href="#cb168-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-217"><a href="#cb168-217" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Age at diagnosis stratification (EDAD_DCO)</span></span>
<span id="cb168-218"><a href="#cb168-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-219"><a href="#cb168-219" aria-hidden="true" tabindex="-1"></a>The age at diagnosis variable is stratified into different age cohorts to reflect distinct clinical and pathological differences observed across age groups. This detailed age stratification allows for a more accurate analysis of prognosis and treatment outcomes, highlighting the need for tailored treatment strategies based on age.</span>
<span id="cb168-220"><a href="#cb168-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-221"><a href="#cb168-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-222"><a href="#cb168-222" aria-hidden="true" tabindex="-1"></a>In a study by Jackson, E. B., Gondara, L., Speers, C.(2023) 24,469 breast cancer patients were stratified into age cohorts: &lt;35, 35–39, 40–49, 50–59, 60–69, 70–79, and ≥80. This stratification was chosen to reflect distinct clinical and pathological differences observed across age groups. Younger patients (&lt;40) typically present with more aggressive disease and require more intensive treatments, while elderly patients (≥80) often have less aggressive, hormone-sensitive cancers and receive less aggressive treatments. This detailed age stratification allowed for a more accurate analysis of prognosis and treatment outcomes, highlighting the need for tailored treatment strategies based on age.</span>
<span id="cb168-223"><a href="#cb168-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-224"><a href="#cb168-224" aria-hidden="true" tabindex="-1"></a>&lt;br&gt;</span>
<span id="cb168-225"><a href="#cb168-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-226"><a href="#cb168-226" aria-hidden="true" tabindex="-1"></a>This stratification is common in scientific studies and clinical practice, as it provides valuable insights into the impact of age on breast cancer prognosis and treatment outcomes. We are going to modify the stratification, setting the following age groups: 0-39, 40-49, 50-59, 60-69, 70-79, and ≥80 because of the fact that the dataset is not big enough to have a more detailed stratification.</span>
<span id="cb168-227"><a href="#cb168-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-230"><a href="#cb168-230" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-231"><a href="#cb168-231" aria-hidden="true" tabindex="-1"></a><span class="co">#Importamos los datos</span></span>
<span id="cb168-232"><a href="#cb168-232" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(<span class="st">"exam_dataset_23.xlsx"</span>, <span class="at">sheet =</span> <span class="dv">1</span>) <span class="co"># Lee la primera hoja</span></span>
<span id="cb168-233"><a href="#cb168-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-234"><a href="#cb168-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-235"><a href="#cb168-235" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>EDAD_DCO <span class="ot">&lt;-</span> <span class="fu">cut</span>(data<span class="sc">$</span>EDAD_DCO, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="cn">Inf</span>, <span class="dv">39</span>, <span class="dv">49</span>, <span class="dv">59</span>,<span class="dv">69</span>,<span class="dv">79</span>, <span class="cn">Inf</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"0-39"</span>, <span class="st">"40-49"</span>, <span class="st">"50-59"</span>, <span class="st">"60-69"</span>,<span class="st">"70-79"</span>,<span class="st">"≥80"</span>))</span>
<span id="cb168-236"><a href="#cb168-236" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>EDAD_DCO <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(data<span class="sc">$</span>EDAD_DCO)</span>
<span id="cb168-237"><a href="#cb168-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-238"><a href="#cb168-238" aria-hidden="true" tabindex="-1"></a><span class="co"># F.diag codificado por decadas solo hay dos</span></span>
<span id="cb168-239"><a href="#cb168-239" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb168-240"><a href="#cb168-240" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">F.DIAG =</span> <span class="fu">cut</span>(<span class="fu">year</span>(F.DIAG), </span>
<span id="cb168-241"><a href="#cb168-241" aria-hidden="true" tabindex="-1"></a>                      <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">2000</span>, <span class="dv">2020</span>, <span class="at">by =</span> <span class="dv">10</span>), </span>
<span id="cb168-242"><a href="#cb168-242" aria-hidden="true" tabindex="-1"></a>                      <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"2000-2009"</span>, <span class="st">"2010-2019"</span>), </span>
<span id="cb168-243"><a href="#cb168-243" aria-hidden="true" tabindex="-1"></a>                      <span class="at">right =</span> <span class="cn">FALSE</span>))</span>
<span id="cb168-244"><a href="#cb168-244" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>F.DIAG <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(data<span class="sc">$</span>F.DIAG)</span>
<span id="cb168-245"><a href="#cb168-245" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>MENOP <span class="ot">&lt;-</span> data<span class="sc">$</span>MENOP <span class="sc">|&gt;</span> <span class="fu">as.factor</span>()</span>
<span id="cb168-246"><a href="#cb168-246" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>CIRUGIA <span class="ot">&lt;-</span> data<span class="sc">$</span>CIRUGIA <span class="sc">|&gt;</span> <span class="fu">as.factor</span>()</span>
<span id="cb168-247"><a href="#cb168-247" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>GRADO <span class="ot">&lt;-</span> data<span class="sc">$</span>GRADO <span class="sc">|&gt;</span> <span class="fu">as.factor</span>()</span>
<span id="cb168-248"><a href="#cb168-248" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>HER2 <span class="ot">&lt;-</span> data<span class="sc">$</span>HER2 <span class="sc">|&gt;</span> <span class="fu">as.factor</span>()</span>
<span id="cb168-249"><a href="#cb168-249" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>ESTADO_ACTUAL <span class="ot">&lt;-</span> data<span class="sc">$</span>ESTADO_ACTUAL <span class="sc">|&gt;</span> <span class="fu">as.factor</span>()</span>
<span id="cb168-250"><a href="#cb168-250" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>ESTADIO <span class="ot">&lt;-</span> data<span class="sc">$</span>ESTADIO <span class="sc">|&gt;</span> <span class="fu">as.factor</span>()</span>
<span id="cb168-251"><a href="#cb168-251" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>FENOTIPO <span class="ot">&lt;-</span> data<span class="sc">$</span>FENOTIPO <span class="sc">|&gt;</span> <span class="fu">as.factor</span>()</span>
<span id="cb168-252"><a href="#cb168-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-253"><a href="#cb168-253" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb168-254"><a href="#cb168-254" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ESTADO_ACTUAL =</span> <span class="fu">fct_recode</span>(ESTADO_ACTUAL,</span>
<span id="cb168-255"><a href="#cb168-255" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">"Exitus"</span> <span class="ot">=</span> <span class="st">"MCE"</span>,</span>
<span id="cb168-256"><a href="#cb168-256" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">"Exitus"</span> <span class="ot">=</span> <span class="st">"MSE"</span>,</span>
<span id="cb168-257"><a href="#cb168-257" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">"Exitus"</span> <span class="ot">=</span> <span class="st">"MXE"</span>,</span>
<span id="cb168-258"><a href="#cb168-258" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">"Vivo"</span> <span class="ot">=</span> <span class="st">"VCE"</span>,</span>
<span id="cb168-259"><a href="#cb168-259" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">"Vivo"</span> <span class="ot">=</span> <span class="st">"VSE"</span>))</span>
<span id="cb168-260"><a href="#cb168-260" aria-hidden="true" tabindex="-1"></a><span class="co"># Reagrupar las categorías de ESTADIO en I, II, III, IV</span></span>
<span id="cb168-261"><a href="#cb168-261" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb168-262"><a href="#cb168-262" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ESTADIO =</span> <span class="fu">case_when</span>(</span>
<span id="cb168-263"><a href="#cb168-263" aria-hidden="true" tabindex="-1"></a>    ESTADIO <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"I"</span>, <span class="st">"IA"</span>, <span class="st">"IB"</span>) <span class="sc">~</span> <span class="st">"I"</span>,</span>
<span id="cb168-264"><a href="#cb168-264" aria-hidden="true" tabindex="-1"></a>    ESTADIO <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"II"</span>, <span class="st">"IIA"</span>, <span class="st">"IIB"</span>) <span class="sc">~</span> <span class="st">"II"</span>,</span>
<span id="cb168-265"><a href="#cb168-265" aria-hidden="true" tabindex="-1"></a>    ESTADIO <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"III"</span>, <span class="st">"IIIA"</span>, <span class="st">"IIIB"</span>, <span class="st">"IIIC"</span>) <span class="sc">~</span> <span class="st">"III"</span>,</span>
<span id="cb168-266"><a href="#cb168-266" aria-hidden="true" tabindex="-1"></a>    ESTADIO <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"IV"</span>) <span class="sc">~</span> <span class="st">"IV"</span>,</span>
<span id="cb168-267"><a href="#cb168-267" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_character_</span>  <span class="co"># Para manejar cualquier otro valor o NA</span></span>
<span id="cb168-268"><a href="#cb168-268" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb168-269"><a href="#cb168-269" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>ESTADIO <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(data<span class="sc">$</span>ESTADIO)</span>
<span id="cb168-270"><a href="#cb168-270" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-271"><a href="#cb168-271" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Number of affected lymph nodes (GANGLIOS)</span></span>
<span id="cb168-272"><a href="#cb168-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-273"><a href="#cb168-273" aria-hidden="true" tabindex="-1"></a>The variable **GANGLIOS (N)** refers to the involvement of lymph nodes, indicating whether cancer has spread to them and, if so, how many are affected. Here's the interpretation of the different **N** levels according to gepac (2024):</span>
<span id="cb168-274"><a href="#cb168-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-275"><a href="#cb168-275" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**N0**: No lymph nodes affected.</span>
<span id="cb168-276"><a href="#cb168-276" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**N1**: One to three lymph nodes affected.</span>
<span id="cb168-277"><a href="#cb168-277" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**N2**: Four to nine lymph nodes affected.</span>
<span id="cb168-278"><a href="#cb168-278" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**N3**: Ten or more lymph nodes affected, or affected nodes that are distant from the breast.</span>
<span id="cb168-279"><a href="#cb168-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-280"><a href="#cb168-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-283"><a href="#cb168-283" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-284"><a href="#cb168-284" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>GANGLIOS <span class="ot">&lt;-</span> <span class="fu">cut</span>(data<span class="sc">$</span>GANGLIOS, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="cn">Inf</span>,<span class="dv">0</span>, <span class="dv">3</span>, <span class="dv">9</span>, <span class="cn">Inf</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"N0"</span>,<span class="st">"N1"</span>, <span class="st">"N2"</span>, <span class="st">"N3"</span>))</span>
<span id="cb168-285"><a href="#cb168-285" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-286"><a href="#cb168-286" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Histology groups (HISTOLOGIA)</span></span>
<span id="cb168-287"><a href="#cb168-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-288"><a href="#cb168-288" aria-hidden="true" tabindex="-1"></a>The histology of breast cancer refers to the type of cells that make up the tumor. The most common special histological types of breast cancer include ductal, lobular, and other types such as adenoid, colloid, medullary, mixed, mucinous, papillary, phyllodes, and tubular. Ductal carcinoma in situ (DCIS) and invasive ductal carcinoma (IDC) are the most common types of breast cancer, accounting for the majority of newly diagnosed cases. Nascimento and Otoni (2020)</span>
<span id="cb168-289"><a href="#cb168-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-290"><a href="#cb168-290" aria-hidden="true" tabindex="-1"></a>We are going to group the histological types into three broad categories: ductal, lobular, and other types. This grouping will help simplify the analysis and interpretation of the data.</span>
<span id="cb168-291"><a href="#cb168-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-292"><a href="#cb168-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-293"><a href="#cb168-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-296"><a href="#cb168-296" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-297"><a href="#cb168-297" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the broad categories and map existing values to these categories</span></span>
<span id="cb168-298"><a href="#cb168-298" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>HISTOLOGIA[data<span class="sc">$</span>HISTOLOGIA <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"DCIS"</span>, <span class="st">"DUCTAL"</span>)] <span class="ot">&lt;-</span> <span class="st">"DUCTAL"</span></span>
<span id="cb168-299"><a href="#cb168-299" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>HISTOLOGIA[data<span class="sc">$</span>HISTOLOGIA <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"LOBULILLAR"</span>)] <span class="ot">&lt;-</span> <span class="st">"LOBULAR"</span></span>
<span id="cb168-300"><a href="#cb168-300" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>HISTOLOGIA[data<span class="sc">$</span>HISTOLOGIA <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"ADENOIDE"</span>, <span class="st">"COLOIDE"</span>, <span class="st">"MEDULAR"</span>, <span class="st">"MIXTO"</span>, <span class="st">"MUCINOSO"</span>, <span class="st">"PAPILAR"</span>, <span class="st">"PHILOIDES"</span>, <span class="st">"TUBULAR"</span>)] <span class="ot">&lt;-</span> <span class="st">"OTHER"</span></span>
<span id="cb168-301"><a href="#cb168-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-302"><a href="#cb168-302" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>HISTOLOGIA <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(data<span class="sc">$</span>HISTOLOGIA)</span>
<span id="cb168-303"><a href="#cb168-303" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-304"><a href="#cb168-304" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Data imputation and normalization</span></span>
<span id="cb168-305"><a href="#cb168-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-306"><a href="#cb168-306" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Numeric variables normalization</span>
<span id="cb168-309"><a href="#cb168-309" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-310"><a href="#cb168-310" aria-hidden="true" tabindex="-1"></a><span class="co"># Select only numeric variables</span></span>
<span id="cb168-311"><a href="#cb168-311" aria-hidden="true" tabindex="-1"></a>numeric_vars <span class="ot">&lt;-</span> <span class="fu">sapply</span>(data, is.numeric)</span>
<span id="cb168-312"><a href="#cb168-312" aria-hidden="true" tabindex="-1"></a>numeric_data <span class="ot">&lt;-</span> data[, numeric_vars]</span>
<span id="cb168-313"><a href="#cb168-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-314"><a href="#cb168-314" aria-hidden="true" tabindex="-1"></a><span class="co"># Normalize the numeric variables</span></span>
<span id="cb168-315"><a href="#cb168-315" aria-hidden="true" tabindex="-1"></a>normalized_data <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">scale</span>(numeric_data))</span>
<span id="cb168-316"><a href="#cb168-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-317"><a href="#cb168-317" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine normalized numeric variables with non-numeric variables</span></span>
<span id="cb168-318"><a href="#cb168-318" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">cbind</span>(data[, <span class="sc">!</span>numeric_vars], normalized_data)</span>
<span id="cb168-319"><a href="#cb168-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-320"><a href="#cb168-320" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-321"><a href="#cb168-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-322"><a href="#cb168-322" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Numerical variables imputation by mean.</span>
<span id="cb168-325"><a href="#cb168-325" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-326"><a href="#cb168-326" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify numeric variables</span></span>
<span id="cb168-327"><a href="#cb168-327" aria-hidden="true" tabindex="-1"></a>numeric_vars <span class="ot">&lt;-</span> <span class="fu">sapply</span>(data, is.numeric)</span>
<span id="cb168-328"><a href="#cb168-328" aria-hidden="true" tabindex="-1"></a><span class="co"># Impute missing values in numeric variables using the mean</span></span>
<span id="cb168-329"><a href="#cb168-329" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (var <span class="cf">in</span> <span class="fu">names</span>(data)[numeric_vars]) {</span>
<span id="cb168-330"><a href="#cb168-330" aria-hidden="true" tabindex="-1"></a>  mean_value <span class="ot">&lt;-</span> <span class="fu">mean</span>(data[[var]], <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="co"># Calculate the mean excluding NA values</span></span>
<span id="cb168-331"><a href="#cb168-331" aria-hidden="true" tabindex="-1"></a>  data[[var]][<span class="fu">is.na</span>(data[[var]])] <span class="ot">&lt;-</span> mean_value <span class="co"># Replace NA values with the mean</span></span>
<span id="cb168-332"><a href="#cb168-332" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb168-333"><a href="#cb168-333" aria-hidden="true" tabindex="-1"></a><span class="co"># View the summary of the updated data</span></span>
<span id="cb168-334"><a href="#cb168-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-335"><a href="#cb168-335" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-336"><a href="#cb168-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-337"><a href="#cb168-337" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Impute categorical variables by mode:</span>
<span id="cb168-338"><a href="#cb168-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-341"><a href="#cb168-341" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-342"><a href="#cb168-342" aria-hidden="true" tabindex="-1"></a><span class="co"># Función para calcular la moda de un vector</span></span>
<span id="cb168-343"><a href="#cb168-343" aria-hidden="true" tabindex="-1"></a>Mode <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb168-344"><a href="#cb168-344" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(<span class="fu">unique</span>(x)) <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb168-345"><a href="#cb168-345" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">unique</span>(x))</span>
<span id="cb168-346"><a href="#cb168-346" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb168-347"><a href="#cb168-347" aria-hidden="true" tabindex="-1"></a>    tbl <span class="ot">&lt;-</span> <span class="fu">table</span>(x)</span>
<span id="cb168-348"><a href="#cb168-348" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">names</span>(tbl)[<span class="fu">which.max</span>(tbl)])</span>
<span id="cb168-349"><a href="#cb168-349" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb168-350"><a href="#cb168-350" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb168-351"><a href="#cb168-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-352"><a href="#cb168-352" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtener nombres de columnas categóricas</span></span>
<span id="cb168-353"><a href="#cb168-353" aria-hidden="true" tabindex="-1"></a>columnas_categoricas <span class="ot">&lt;-</span> <span class="fu">sapply</span>(data, is.factor)</span>
<span id="cb168-354"><a href="#cb168-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-355"><a href="#cb168-355" aria-hidden="true" tabindex="-1"></a><span class="co"># Imputación por moda para todas las columnas categóricas con valores perdidos</span></span>
<span id="cb168-356"><a href="#cb168-356" aria-hidden="true" tabindex="-1"></a>data[columnas_categoricas] <span class="ot">&lt;-</span> <span class="fu">lapply</span>(data[columnas_categoricas], <span class="cf">function</span>(x) {</span>
<span id="cb168-357"><a href="#cb168-357" aria-hidden="true" tabindex="-1"></a>  moda <span class="ot">&lt;-</span> <span class="fu">Mode</span>(x)</span>
<span id="cb168-358"><a href="#cb168-358" aria-hidden="true" tabindex="-1"></a>  x[<span class="fu">is.na</span>(x)] <span class="ot">&lt;-</span> moda</span>
<span id="cb168-359"><a href="#cb168-359" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(x)</span>
<span id="cb168-360"><a href="#cb168-360" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb168-361"><a href="#cb168-361" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-362"><a href="#cb168-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-363"><a href="#cb168-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-364"><a href="#cb168-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-365"><a href="#cb168-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-366"><a href="#cb168-366" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary </span></span>
<span id="cb168-367"><a href="#cb168-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-368"><a href="#cb168-368" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset style="background-color: #f0f0f0;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;"}</span>
<span id="cb168-369"><a href="#cb168-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-370"><a href="#cb168-370" aria-hidden="true" tabindex="-1"></a>Claro, aquí tienes el código para cada una de las variables que mencionaste:</span>
<span id="cb168-373"><a href="#cb168-373" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-374"><a href="#cb168-374" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-375"><a href="#cb168-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-376"><a href="#cb168-376" aria-hidden="true" tabindex="-1"></a><span class="fu">### EDAD_DCO</span></span>
<span id="cb168-377"><a href="#cb168-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-380"><a href="#cb168-380" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-381"><a href="#cb168-381" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(data<span class="sc">$</span>EDAD_DCO)</span>
<span id="cb168-382"><a href="#cb168-382" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-383"><a href="#cb168-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-384"><a href="#cb168-384" aria-hidden="true" tabindex="-1"></a><span class="fu">### F,DIAG</span></span>
<span id="cb168-385"><a href="#cb168-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-388"><a href="#cb168-388" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-389"><a href="#cb168-389" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(data<span class="sc">$</span>F.DIAG)</span>
<span id="cb168-390"><a href="#cb168-390" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-391"><a href="#cb168-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-392"><a href="#cb168-392" aria-hidden="true" tabindex="-1"></a><span class="fu">### MENOP</span></span>
<span id="cb168-393"><a href="#cb168-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-396"><a href="#cb168-396" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-397"><a href="#cb168-397" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(data<span class="sc">$</span>MENOP)</span>
<span id="cb168-398"><a href="#cb168-398" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-399"><a href="#cb168-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-400"><a href="#cb168-400" aria-hidden="true" tabindex="-1"></a><span class="fu">### CIRUGIA</span></span>
<span id="cb168-401"><a href="#cb168-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-404"><a href="#cb168-404" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-405"><a href="#cb168-405" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(data<span class="sc">$</span>CIRUGIA)</span>
<span id="cb168-406"><a href="#cb168-406" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-407"><a href="#cb168-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-408"><a href="#cb168-408" aria-hidden="true" tabindex="-1"></a><span class="fu">### HISTOLOGIA</span></span>
<span id="cb168-409"><a href="#cb168-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-412"><a href="#cb168-412" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-413"><a href="#cb168-413" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(data<span class="sc">$</span>HISTOLOGIA)</span>
<span id="cb168-414"><a href="#cb168-414" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-415"><a href="#cb168-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-416"><a href="#cb168-416" aria-hidden="true" tabindex="-1"></a><span class="fu">### GRADO</span></span>
<span id="cb168-417"><a href="#cb168-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-420"><a href="#cb168-420" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-421"><a href="#cb168-421" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(data<span class="sc">$</span>GRADO)</span>
<span id="cb168-422"><a href="#cb168-422" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-423"><a href="#cb168-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-424"><a href="#cb168-424" aria-hidden="true" tabindex="-1"></a><span class="fu">### HER2</span></span>
<span id="cb168-425"><a href="#cb168-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-428"><a href="#cb168-428" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-429"><a href="#cb168-429" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(data<span class="sc">$</span>HER2)</span>
<span id="cb168-430"><a href="#cb168-430" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-431"><a href="#cb168-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-432"><a href="#cb168-432" aria-hidden="true" tabindex="-1"></a><span class="fu">### FENOTIPO</span></span>
<span id="cb168-433"><a href="#cb168-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-436"><a href="#cb168-436" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-437"><a href="#cb168-437" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(data<span class="sc">$</span>FENOTIPO)</span>
<span id="cb168-438"><a href="#cb168-438" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-439"><a href="#cb168-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-440"><a href="#cb168-440" aria-hidden="true" tabindex="-1"></a><span class="fu">### GANGLIOS</span></span>
<span id="cb168-441"><a href="#cb168-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-444"><a href="#cb168-444" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-445"><a href="#cb168-445" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(data<span class="sc">$</span>GANGLIOS)</span>
<span id="cb168-446"><a href="#cb168-446" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-447"><a href="#cb168-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-448"><a href="#cb168-448" aria-hidden="true" tabindex="-1"></a><span class="fu">### ESTADIO</span></span>
<span id="cb168-449"><a href="#cb168-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-452"><a href="#cb168-452" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-453"><a href="#cb168-453" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(data<span class="sc">$</span>ESTADIO)</span>
<span id="cb168-454"><a href="#cb168-454" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-455"><a href="#cb168-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-456"><a href="#cb168-456" aria-hidden="true" tabindex="-1"></a><span class="fu">### ESTADO_ACTUAL</span></span>
<span id="cb168-457"><a href="#cb168-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-460"><a href="#cb168-460" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-461"><a href="#cb168-461" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(data<span class="sc">$</span>ESTADO_ACTUAL)</span>
<span id="cb168-462"><a href="#cb168-462" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-463"><a href="#cb168-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-464"><a href="#cb168-464" aria-hidden="true" tabindex="-1"></a><span class="fu">### TAM</span></span>
<span id="cb168-465"><a href="#cb168-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-468"><a href="#cb168-468" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-469"><a href="#cb168-469" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(data<span class="sc">$</span>TAM)</span>
<span id="cb168-470"><a href="#cb168-470" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-471"><a href="#cb168-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-472"><a href="#cb168-472" aria-hidden="true" tabindex="-1"></a><span class="fu">### RE</span></span>
<span id="cb168-473"><a href="#cb168-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-476"><a href="#cb168-476" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-477"><a href="#cb168-477" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(data<span class="sc">$</span>RE)</span>
<span id="cb168-478"><a href="#cb168-478" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-479"><a href="#cb168-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-480"><a href="#cb168-480" aria-hidden="true" tabindex="-1"></a><span class="fu">### RP</span></span>
<span id="cb168-481"><a href="#cb168-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-484"><a href="#cb168-484" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-485"><a href="#cb168-485" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(data<span class="sc">$</span>RP)</span>
<span id="cb168-486"><a href="#cb168-486" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-487"><a href="#cb168-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-488"><a href="#cb168-488" aria-hidden="true" tabindex="-1"></a><span class="fu">### KI67</span></span>
<span id="cb168-489"><a href="#cb168-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-492"><a href="#cb168-492" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-493"><a href="#cb168-493" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(data<span class="sc">$</span>KI67)</span>
<span id="cb168-494"><a href="#cb168-494" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-495"><a href="#cb168-495" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb168-496"><a href="#cb168-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-497"><a href="#cb168-497" aria-hidden="true" tabindex="-1"></a><span class="fu"># Statistic Analysis {#statistic-analysis}</span></span>
<span id="cb168-498"><a href="#cb168-498" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset style="background-color: #f0f0f0;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;"}</span>
<span id="cb168-499"><a href="#cb168-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-500"><a href="#cb168-500" aria-hidden="true" tabindex="-1"></a><span class="fu">## Univariate Analysis {#univariate-analysis}</span></span>
<span id="cb168-501"><a href="#cb168-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-502"><a href="#cb168-502" aria-hidden="true" tabindex="-1"></a>We are going to analyze and visualize every variable so as to understand the behavior of our problem variables.</span>
<span id="cb168-503"><a href="#cb168-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-504"><a href="#cb168-504" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, warning=FALSE,results='hide'}</span></span>
<span id="cb168-505"><a href="#cb168-505" aria-hidden="true" tabindex="-1"></a><span class="in">columnas &lt;- colnames(data)</span></span>
<span id="cb168-506"><a href="#cb168-506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-507"><a href="#cb168-507" aria-hidden="true" tabindex="-1"></a><span class="in"># Aplicar la función 'analsis_univariante_automatico()' a cada columna</span></span>
<span id="cb168-508"><a href="#cb168-508" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_univariante &lt;- lapply(columnas, function(col) {</span></span>
<span id="cb168-509"><a href="#cb168-509" aria-hidden="true" tabindex="-1"></a><span class="in">  an &lt;- analsis_univariante_automatico(data[[col]], col)</span></span>
<span id="cb168-510"><a href="#cb168-510" aria-hidden="true" tabindex="-1"></a><span class="in">  if(an$tipo=="factor"){</span></span>
<span id="cb168-511"><a href="#cb168-511" aria-hidden="true" tabindex="-1"></a><span class="in">    o &lt;- an$grafica</span></span>
<span id="cb168-512"><a href="#cb168-512" aria-hidden="true" tabindex="-1"></a><span class="in">  }else if(an$tipo=="numeric"){</span></span>
<span id="cb168-513"><a href="#cb168-513" aria-hidden="true" tabindex="-1"></a><span class="in">    o &lt;- an$hist</span></span>
<span id="cb168-514"><a href="#cb168-514" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb168-515"><a href="#cb168-515" aria-hidden="true" tabindex="-1"></a><span class="in">  return(o)</span></span>
<span id="cb168-516"><a href="#cb168-516" aria-hidden="true" tabindex="-1"></a><span class="in">})</span></span>
<span id="cb168-517"><a href="#cb168-517" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-518"><a href="#cb168-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-519"><a href="#cb168-519" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setup, include=FALSE}</span></span>
<span id="cb168-520"><a href="#cb168-520" aria-hidden="true" tabindex="-1"></a><span class="in">library(gridExtra)</span></span>
<span id="cb168-521"><a href="#cb168-521" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggplot2)</span></span>
<span id="cb168-522"><a href="#cb168-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-523"><a href="#cb168-523" aria-hidden="true" tabindex="-1"></a><span class="in"># Crear una carpeta para guardar las imágenes si no existe</span></span>
<span id="cb168-524"><a href="#cb168-524" aria-hidden="true" tabindex="-1"></a><span class="in">if (!dir.exists("images")) {</span></span>
<span id="cb168-525"><a href="#cb168-525" aria-hidden="true" tabindex="-1"></a><span class="in">  dir.create("images")</span></span>
<span id="cb168-526"><a href="#cb168-526" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb168-527"><a href="#cb168-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-528"><a href="#cb168-528" aria-hidden="true" tabindex="-1"></a><span class="in"># Suponiendo que 'data' es tu data frame, que ya has cargado anteriormente</span></span>
<span id="cb168-529"><a href="#cb168-529" aria-hidden="true" tabindex="-1"></a><span class="in"># Ejemplo:</span></span>
<span id="cb168-530"><a href="#cb168-530" aria-hidden="true" tabindex="-1"></a><span class="in"># data &lt;- mtcars</span></span>
<span id="cb168-531"><a href="#cb168-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-532"><a href="#cb168-532" aria-hidden="true" tabindex="-1"></a><span class="in"># Supongamos que 'analsis_univariante_automatico' es una función definida previamente</span></span>
<span id="cb168-533"><a href="#cb168-533" aria-hidden="true" tabindex="-1"></a><span class="in"># y que toma una columna de datos y su nombre como argumentos</span></span>
<span id="cb168-534"><a href="#cb168-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-535"><a href="#cb168-535" aria-hidden="true" tabindex="-1"></a><span class="in"># columnas &lt;- colnames(data)</span></span>
<span id="cb168-536"><a href="#cb168-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-537"><a href="#cb168-537" aria-hidden="true" tabindex="-1"></a><span class="in"># Aplicar la función 'analsis_univariante_automatico()' a cada columna</span></span>
<span id="cb168-538"><a href="#cb168-538" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_univariante &lt;- lapply(columnas, function(col) {</span></span>
<span id="cb168-539"><a href="#cb168-539" aria-hidden="true" tabindex="-1"></a><span class="in">  an &lt;- analsis_univariante_automatico(data[[col]], col)</span></span>
<span id="cb168-540"><a href="#cb168-540" aria-hidden="true" tabindex="-1"></a><span class="in">  if(an$tipo == "factor"){</span></span>
<span id="cb168-541"><a href="#cb168-541" aria-hidden="true" tabindex="-1"></a><span class="in">    o &lt;- an$grafica</span></span>
<span id="cb168-542"><a href="#cb168-542" aria-hidden="true" tabindex="-1"></a><span class="in">  } else if(an$tipo == "numeric"){</span></span>
<span id="cb168-543"><a href="#cb168-543" aria-hidden="true" tabindex="-1"></a><span class="in">    o &lt;- an$hist</span></span>
<span id="cb168-544"><a href="#cb168-544" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb168-545"><a href="#cb168-545" aria-hidden="true" tabindex="-1"></a><span class="in">  return(o)</span></span>
<span id="cb168-546"><a href="#cb168-546" aria-hidden="true" tabindex="-1"></a><span class="in">})</span></span>
<span id="cb168-547"><a href="#cb168-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-548"><a href="#cb168-548" aria-hidden="true" tabindex="-1"></a><span class="in"># Si hay más de una imagen, guardarlas con nombres diferentes</span></span>
<span id="cb168-549"><a href="#cb168-549" aria-hidden="true" tabindex="-1"></a><span class="in">for (i in 1:length(resultados_univariante)) {</span></span>
<span id="cb168-550"><a href="#cb168-550" aria-hidden="true" tabindex="-1"></a><span class="in">  ggsave(filename = paste0("images/image", i, ".png"), plot = resultados_univariante[[i]])</span></span>
<span id="cb168-551"><a href="#cb168-551" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb168-552"><a href="#cb168-552" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-553"><a href="#cb168-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-554"><a href="#cb168-554" aria-hidden="true" tabindex="-1"></a><span class="in">```{=html}</span></span>
<span id="cb168-555"><a href="#cb168-555" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;!-- Div para la imagen principal --&gt;</span></span>
<span id="cb168-556"><a href="#cb168-556" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;div id="main-image"&gt;</span></span>
<span id="cb168-557"><a href="#cb168-557" aria-hidden="true" tabindex="-1"></a><span class="in">  &lt;img src="images/image1.png" alt="Imagen Principal" id="displayed-image"&gt;</span></span>
<span id="cb168-558"><a href="#cb168-558" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;/div&gt;</span></span>
<span id="cb168-559"><a href="#cb168-559" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;!-- Div para las miniaturas --&gt;</span></span>
<span id="cb168-560"><a href="#cb168-560" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;div class="thumbnail-gallery"&gt;</span></span>
<span id="cb168-561"><a href="#cb168-561" aria-hidden="true" tabindex="-1"></a><span class="in">  ```{r, results='asis', echo=FALSE}</span></span>
<span id="cb168-562"><a href="#cb168-562" aria-hidden="true" tabindex="-1"></a><span class="in">  for (i in 1:length(resultados_univariante)) {</span></span>
<span id="cb168-563"><a href="#cb168-563" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf('&lt;img src="images/image%d.png" alt="Imagen %d" onclick="changeImage(\'images/image%d.png\')"&gt;', i, i, i))</span></span>
<span id="cb168-564"><a href="#cb168-564" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb168-565"><a href="#cb168-565" aria-hidden="true" tabindex="-1"></a><span class="in">  ```</span></span>
<span id="cb168-566"><a href="#cb168-566" aria-hidden="true" tabindex="-1"></a>&lt;/div&gt;</span>
<span id="cb168-567"><a href="#cb168-567" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- JavaScript para cambiar la imagen principal --&gt;</span></span>
<span id="cb168-568"><a href="#cb168-568" aria-hidden="true" tabindex="-1"></a>&lt;script&gt;</span>
<span id="cb168-569"><a href="#cb168-569" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">changeImage</span>(imageSrc) {</span>
<span id="cb168-570"><a href="#cb168-570" aria-hidden="true" tabindex="-1"></a>  <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">'displayed-image'</span>)<span class="op">.</span><span class="at">src</span> <span class="op">=</span> imageSrc<span class="op">;</span></span>
<span id="cb168-571"><a href="#cb168-571" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb168-572"><a href="#cb168-572" aria-hidden="true" tabindex="-1"></a>&lt;/script&gt;</span>
<span id="cb168-573"><a href="#cb168-573" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- CSS para estilizar la galería --&gt;</span></span>
<span id="cb168-574"><a href="#cb168-574" aria-hidden="true" tabindex="-1"></a>&lt;style&gt;</span>
<span id="cb168-575"><a href="#cb168-575" aria-hidden="true" tabindex="-1"></a><span class="pp">#main-image</span> {</span>
<span id="cb168-576"><a href="#cb168-576" aria-hidden="true" tabindex="-1"></a>  <span class="kw">text-align</span><span class="ch">:</span> <span class="dv">center</span><span class="op">;</span></span>
<span id="cb168-577"><a href="#cb168-577" aria-hidden="true" tabindex="-1"></a>  <span class="kw">margin-bottom</span><span class="ch">:</span> <span class="dv">20</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb168-578"><a href="#cb168-578" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb168-579"><a href="#cb168-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-580"><a href="#cb168-580" aria-hidden="true" tabindex="-1"></a><span class="pp">#main-image</span> img {</span>
<span id="cb168-581"><a href="#cb168-581" aria-hidden="true" tabindex="-1"></a>  <span class="kw">width</span><span class="ch">:</span> <span class="dv">600</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb168-582"><a href="#cb168-582" aria-hidden="true" tabindex="-1"></a>  <span class="kw">height</span><span class="ch">:</span> <span class="bu">auto</span><span class="op">;</span></span>
<span id="cb168-583"><a href="#cb168-583" aria-hidden="true" tabindex="-1"></a>  <span class="kw">border</span><span class="ch">:</span> <span class="dv">2</span><span class="dt">px</span> <span class="dv">solid</span> <span class="cn">#ddd</span><span class="op">;</span></span>
<span id="cb168-584"><a href="#cb168-584" aria-hidden="true" tabindex="-1"></a>  <span class="kw">border-radius</span><span class="ch">:</span> <span class="dv">5</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb168-585"><a href="#cb168-585" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb168-586"><a href="#cb168-586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-587"><a href="#cb168-587" aria-hidden="true" tabindex="-1"></a><span class="fu">.thumbnail-gallery</span> {</span>
<span id="cb168-588"><a href="#cb168-588" aria-hidden="true" tabindex="-1"></a>  <span class="kw">display</span><span class="ch">:</span> <span class="dv">flex</span><span class="op">;</span></span>
<span id="cb168-589"><a href="#cb168-589" aria-hidden="true" tabindex="-1"></a>  <span class="kw">flex-wrap</span><span class="ch">:</span> <span class="dv">wrap</span><span class="op">;</span></span>
<span id="cb168-590"><a href="#cb168-590" aria-hidden="true" tabindex="-1"></a>  <span class="kw">justify-content</span><span class="ch">:</span> <span class="dv">center</span><span class="op">;</span></span>
<span id="cb168-591"><a href="#cb168-591" aria-hidden="true" tabindex="-1"></a>  <span class="kw">gap</span><span class="ch">:</span> <span class="dv">10</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb168-592"><a href="#cb168-592" aria-hidden="true" tabindex="-1"></a>  <span class="kw">max-width</span><span class="ch">:</span> <span class="dv">100</span><span class="dt">%</span><span class="op">;</span></span>
<span id="cb168-593"><a href="#cb168-593" aria-hidden="true" tabindex="-1"></a>  <span class="kw">overflow-x</span><span class="ch">:</span> <span class="bu">auto</span><span class="op">;</span></span>
<span id="cb168-594"><a href="#cb168-594" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb168-595"><a href="#cb168-595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-596"><a href="#cb168-596" aria-hidden="true" tabindex="-1"></a><span class="fu">.thumbnail-gallery</span> img {</span>
<span id="cb168-597"><a href="#cb168-597" aria-hidden="true" tabindex="-1"></a>  <span class="kw">width</span><span class="ch">:</span> <span class="dv">50</span><span class="dt">px</span><span class="op">;</span> <span class="co">/* Reducir el tamaño de las miniaturas */</span></span>
<span id="cb168-598"><a href="#cb168-598" aria-hidden="true" tabindex="-1"></a>  <span class="kw">height</span><span class="ch">:</span> <span class="bu">auto</span><span class="op">;</span></span>
<span id="cb168-599"><a href="#cb168-599" aria-hidden="true" tabindex="-1"></a>  <span class="kw">cursor</span><span class="ch">:</span> <span class="dv">pointer</span><span class="op">;</span></span>
<span id="cb168-600"><a href="#cb168-600" aria-hidden="true" tabindex="-1"></a>  <span class="kw">border</span><span class="ch">:</span> <span class="dv">2</span><span class="dt">px</span> <span class="dv">solid</span> <span class="cn">#ddd</span><span class="op">;</span></span>
<span id="cb168-601"><a href="#cb168-601" aria-hidden="true" tabindex="-1"></a>  <span class="kw">border-radius</span><span class="ch">:</span> <span class="dv">5</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb168-602"><a href="#cb168-602" aria-hidden="true" tabindex="-1"></a>  <span class="kw">transition</span><span class="ch">:</span> <span class="dv">transform 0.2</span><span class="dt">s</span><span class="op">;</span></span>
<span id="cb168-603"><a href="#cb168-603" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb168-604"><a href="#cb168-604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-605"><a href="#cb168-605" aria-hidden="true" tabindex="-1"></a><span class="fu">.thumbnail-gallery</span> img<span class="in">:hover</span> {</span>
<span id="cb168-606"><a href="#cb168-606" aria-hidden="true" tabindex="-1"></a>  <span class="kw">transform</span><span class="ch">:</span> <span class="fu">scale(</span><span class="dv">1.1</span><span class="fu">)</span><span class="op">;</span></span>
<span id="cb168-607"><a href="#cb168-607" aria-hidden="true" tabindex="-1"></a>  <span class="kw">border-color</span><span class="ch">:</span> <span class="cn">#aaa</span><span class="op">;</span></span>
<span id="cb168-608"><a href="#cb168-608" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb168-609"><a href="#cb168-609" aria-hidden="true" tabindex="-1"></a>&lt;/style&gt;</span>
<span id="cb168-610"><a href="#cb168-610" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-611"><a href="#cb168-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-612"><a href="#cb168-612" aria-hidden="true" tabindex="-1"></a><span class="in">The most notable problem is the great imbalance between categories in variables like ESTADO_ACTUAL or HISTOLOGIA.</span></span>
<span id="cb168-613"><a href="#cb168-613" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-614"><a href="#cb168-614" aria-hidden="true" tabindex="-1"></a><span class="in">There is a decrease in the frecuency of the factor with worse prognosis in some variables like GANGLIOS OR ESTADIO that added to the fact that there are a low percentage of exitus could mean that most of the patients have a good prognosis.</span></span>
<span id="cb168-615"><a href="#cb168-615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-616"><a href="#cb168-616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-617"><a href="#cb168-617" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-618"><a href="#cb168-618" aria-hidden="true" tabindex="-1"></a><span class="in">## Bivariate Analysis {#bivariate-analysis}</span></span>
<span id="cb168-619"><a href="#cb168-619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-620"><a href="#cb168-620" aria-hidden="true" tabindex="-1"></a><span class="in">In this section, we are going to measure and visualize the relation of every variable with the target.</span></span>
<span id="cb168-621"><a href="#cb168-621" aria-hidden="true" tabindex="-1"></a><span class="in">This is very useful to select the most important variables for our model.</span></span>
<span id="cb168-622"><a href="#cb168-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-623"><a href="#cb168-623" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=FALSE,results='asis'}</span></span>
<span id="cb168-624"><a href="#cb168-624" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_bi_ESTADO_ACTUAL &lt;- lapply(columnas, function(col) {</span></span>
<span id="cb168-625"><a href="#cb168-625" aria-hidden="true" tabindex="-1"></a><span class="in">  an &lt;- analisis_bivariante_automatico(data$ESTADO_ACTUAL, data[[col]], "ESTADO_ACTUAL", col)</span></span>
<span id="cb168-626"><a href="#cb168-626" aria-hidden="true" tabindex="-1"></a><span class="in">  return(an$grafica)</span></span>
<span id="cb168-627"><a href="#cb168-627" aria-hidden="true" tabindex="-1"></a><span class="in">})</span></span>
<span id="cb168-628"><a href="#cb168-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-629"><a href="#cb168-629" aria-hidden="true" tabindex="-1"></a><span class="in"># Guardar las imágenes generadas en una carpeta</span></span>
<span id="cb168-630"><a href="#cb168-630" aria-hidden="true" tabindex="-1"></a><span class="in">if (!dir.exists("images_bi")) {</span></span>
<span id="cb168-631"><a href="#cb168-631" aria-hidden="true" tabindex="-1"></a><span class="in">  dir.create("images_bi")</span></span>
<span id="cb168-632"><a href="#cb168-632" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb168-633"><a href="#cb168-633" aria-hidden="true" tabindex="-1"></a><span class="in">for (i in 1:length(resultados_bi_ESTADO_ACTUAL)) {</span></span>
<span id="cb168-634"><a href="#cb168-634" aria-hidden="true" tabindex="-1"></a><span class="in">  ggsave(filename = paste0("images_bi/image", i, ".png"), plot = resultados_bi_ESTADO_ACTUAL[[i]])</span></span>
<span id="cb168-635"><a href="#cb168-635" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb168-636"><a href="#cb168-636" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-637"><a href="#cb168-637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-638"><a href="#cb168-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-639"><a href="#cb168-639" aria-hidden="true" tabindex="-1"></a><span class="in">```{=html}</span></span>
<span id="cb168-640"><a href="#cb168-640" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;!-- Div para la imagen principal --&gt;</span></span>
<span id="cb168-641"><a href="#cb168-641" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;div id="main-image_bi"&gt;</span></span>
<span id="cb168-642"><a href="#cb168-642" aria-hidden="true" tabindex="-1"></a><span class="in">  &lt;img src="images_bi/image1.png" alt="Imagen Principal" id="displayed-image_bi"&gt;</span></span>
<span id="cb168-643"><a href="#cb168-643" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;/div&gt;</span></span>
<span id="cb168-644"><a href="#cb168-644" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;!-- Div para las miniaturas --&gt;</span></span>
<span id="cb168-645"><a href="#cb168-645" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;div class="thumbnail-gallery"&gt;</span></span>
<span id="cb168-646"><a href="#cb168-646" aria-hidden="true" tabindex="-1"></a><span class="in">  ```{r, results='asis', echo=FALSE}</span></span>
<span id="cb168-647"><a href="#cb168-647" aria-hidden="true" tabindex="-1"></a><span class="in">  for (i in 1:length(resultados_bi_ESTADO_ACTUAL)) {</span></span>
<span id="cb168-648"><a href="#cb168-648" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf('&lt;img src="images_bi/image%d.png" alt="Imagen %d" onclick="changeImage_bi(\'images_bi/image%d.png\')"&gt;', i, i, i))</span></span>
<span id="cb168-649"><a href="#cb168-649" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb168-650"><a href="#cb168-650" aria-hidden="true" tabindex="-1"></a><span class="in">  ```</span></span>
<span id="cb168-651"><a href="#cb168-651" aria-hidden="true" tabindex="-1"></a>&lt;/div&gt;</span>
<span id="cb168-652"><a href="#cb168-652" aria-hidden="true" tabindex="-1"></a>&lt;script&gt;</span>
<span id="cb168-653"><a href="#cb168-653" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">changeImage_bi</span>(imageSrc) {</span>
<span id="cb168-654"><a href="#cb168-654" aria-hidden="true" tabindex="-1"></a>  <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">'displayed-image_bi'</span>)<span class="op">.</span><span class="at">src</span> <span class="op">=</span> imageSrc<span class="op">;</span></span>
<span id="cb168-655"><a href="#cb168-655" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb168-656"><a href="#cb168-656" aria-hidden="true" tabindex="-1"></a>&lt;/script&gt;</span>
<span id="cb168-657"><a href="#cb168-657" aria-hidden="true" tabindex="-1"></a>&lt;style&gt;</span>
<span id="cb168-658"><a href="#cb168-658" aria-hidden="true" tabindex="-1"></a><span class="pp">#main-image_bi</span> {</span>
<span id="cb168-659"><a href="#cb168-659" aria-hidden="true" tabindex="-1"></a>  <span class="kw">text-align</span><span class="ch">:</span> <span class="dv">center</span><span class="op">;</span></span>
<span id="cb168-660"><a href="#cb168-660" aria-hidden="true" tabindex="-1"></a>  <span class="kw">margin-bottom</span><span class="ch">:</span> <span class="dv">20</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb168-661"><a href="#cb168-661" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb168-662"><a href="#cb168-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-663"><a href="#cb168-663" aria-hidden="true" tabindex="-1"></a><span class="pp">#main-image_bi</span> img {</span>
<span id="cb168-664"><a href="#cb168-664" aria-hidden="true" tabindex="-1"></a>  <span class="kw">width</span><span class="ch">:</span> <span class="dv">600</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb168-665"><a href="#cb168-665" aria-hidden="true" tabindex="-1"></a>  <span class="kw">height</span><span class="ch">:</span> <span class="bu">auto</span><span class="op">;</span></span>
<span id="cb168-666"><a href="#cb168-666" aria-hidden="true" tabindex="-1"></a>  <span class="kw">border</span><span class="ch">:</span> <span class="dv">2</span><span class="dt">px</span> <span class="dv">solid</span> <span class="cn">#ddd</span><span class="op">;</span></span>
<span id="cb168-667"><a href="#cb168-667" aria-hidden="true" tabindex="-1"></a>  <span class="kw">border-radius</span><span class="ch">:</span> <span class="dv">5</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb168-668"><a href="#cb168-668" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb168-669"><a href="#cb168-669" aria-hidden="true" tabindex="-1"></a>&lt;/style&gt;</span>
<span id="cb168-670"><a href="#cb168-670" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-671"><a href="#cb168-671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-672"><a href="#cb168-672" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=FALSE,results='asis'}</span></span>
<span id="cb168-673"><a href="#cb168-673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-674"><a href="#cb168-674" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-675"><a href="#cb168-675" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-676"><a href="#cb168-676" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-677"><a href="#cb168-677" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_para_tabla &lt;- lapply(columnas, function(col) {</span></span>
<span id="cb168-678"><a href="#cb168-678" aria-hidden="true" tabindex="-1"></a><span class="in">  an &lt;- analisis_bivariante_automatico(data$ESTADO_ACTUAL, data[[col]],"ESTADO_ACTUAL",col)</span></span>
<span id="cb168-679"><a href="#cb168-679" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-680"><a href="#cb168-680" aria-hidden="true" tabindex="-1"></a><span class="in">  return(an)</span></span>
<span id="cb168-681"><a href="#cb168-681" aria-hidden="true" tabindex="-1"></a><span class="in">  })</span></span>
<span id="cb168-682"><a href="#cb168-682" aria-hidden="true" tabindex="-1"></a><span class="in">p_values_1 &lt;- sapply(resultados_para_tabla, function(x) x$test$p.value)</span></span>
<span id="cb168-683"><a href="#cb168-683" aria-hidden="true" tabindex="-1"></a><span class="in">formatted_p_values_1 &lt;- ifelse(p_values_1 &lt; 0.0000001, format(p_values_1, scientific = TRUE), p_values_1)</span></span>
<span id="cb168-684"><a href="#cb168-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-685"><a href="#cb168-685" aria-hidden="true" tabindex="-1"></a><span class="in"># Crear una tabla con los resultados</span></span>
<span id="cb168-686"><a href="#cb168-686" aria-hidden="true" tabindex="-1"></a><span class="in">tabla_resultados &lt;- data.frame(</span></span>
<span id="cb168-687"><a href="#cb168-687" aria-hidden="true" tabindex="-1"></a><span class="in">  Data_Name = sapply(resultados_para_tabla, function(x) x$test$data.name),</span></span>
<span id="cb168-688"><a href="#cb168-688" aria-hidden="true" tabindex="-1"></a><span class="in">  Estadistico = sapply(resultados_para_tabla, function(x) ifelse(is.null(x$test$statistic), NA, x$test$statistic)),</span></span>
<span id="cb168-689"><a href="#cb168-689" aria-hidden="true" tabindex="-1"></a><span class="in">  Odds = sapply(resultados_para_tabla, function(x) ifelse(is.null(x$test$estimate), NA, x$test$estimate)),</span></span>
<span id="cb168-690"><a href="#cb168-690" aria-hidden="true" tabindex="-1"></a><span class="in">  P_valor = formatted_p_values_1,</span></span>
<span id="cb168-691"><a href="#cb168-691" aria-hidden="true" tabindex="-1"></a><span class="in">  Method = sapply(resultados_para_tabla, function(x) x$test$method),</span></span>
<span id="cb168-692"><a href="#cb168-692" aria-hidden="true" tabindex="-1"></a><span class="in">  Conclusion = sapply(resultados_para_tabla, function(x) x$conclusion)</span></span>
<span id="cb168-693"><a href="#cb168-693" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb168-694"><a href="#cb168-694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-695"><a href="#cb168-695" aria-hidden="true" tabindex="-1"></a><span class="in"># Mostrar la tabla usando kable</span></span>
<span id="cb168-696"><a href="#cb168-696" aria-hidden="true" tabindex="-1"></a><span class="in">tabla &lt;- kable(tabla_resultados, format = "html", align = "ccc", caption = "Tabla de Resultados", row.names = FALSE, booktabs = TRUE) %&gt;%</span></span>
<span id="cb168-697"><a href="#cb168-697" aria-hidden="true" tabindex="-1"></a><span class="in">  kable_styling(bootstrap_options = "striped", full_width = FALSE)</span></span>
<span id="cb168-698"><a href="#cb168-698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-699"><a href="#cb168-699" aria-hidden="true" tabindex="-1"></a><span class="in">tabla_con_scroll &lt;- scroll_box(tabla, height = "400px")</span></span>
<span id="cb168-700"><a href="#cb168-700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-701"><a href="#cb168-701" aria-hidden="true" tabindex="-1"></a><span class="in"># Mostrar la tabla</span></span>
<span id="cb168-702"><a href="#cb168-702" aria-hidden="true" tabindex="-1"></a><span class="in">print(tabla_con_scroll)</span></span>
<span id="cb168-703"><a href="#cb168-703" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-704"><a href="#cb168-704" aria-hidden="true" tabindex="-1"></a>The target variable is dependent to diagnosis date, phenotype, stage and estrogen receptors. These variables are the most important for our model.</span>
<span id="cb168-705"><a href="#cb168-705" aria-hidden="true" tabindex="-1"></a>This matches with the published scientific evidence.</span>
<span id="cb168-706"><a href="#cb168-706" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-707"><a href="#cb168-707" aria-hidden="true" tabindex="-1"></a><span class="fu">## Association Analysis {#association-analysis}</span></span>
<span id="cb168-708"><a href="#cb168-708" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-709"><a href="#cb168-709" aria-hidden="true" tabindex="-1"></a>To recollect even more information, we are going to build a association matrix where we can see p-values(meaning of association) of every variable with each others</span>
<span id="cb168-710"><a href="#cb168-710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-713"><a href="#cb168-713" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-714"><a href="#cb168-714" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb168-715"><a href="#cb168-715" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reshape2)</span>
<span id="cb168-716"><a href="#cb168-716" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-717"><a href="#cb168-717" aria-hidden="true" tabindex="-1"></a><span class="co"># Definir la función para calcular p-valores y generar un mapa de calor</span></span>
<span id="cb168-718"><a href="#cb168-718" aria-hidden="true" tabindex="-1"></a>generar_mapa_calor_p_valores <span class="ot">&lt;-</span> <span class="cf">function</span>(data, analisis_bivariante_automatico) {</span>
<span id="cb168-719"><a href="#cb168-719" aria-hidden="true" tabindex="-1"></a>  num_variables <span class="ot">&lt;-</span> <span class="fu">ncol</span>(data)</span>
<span id="cb168-720"><a href="#cb168-720" aria-hidden="true" tabindex="-1"></a>  p_valores <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> num_variables, <span class="at">ncol =</span> num_variables)</span>
<span id="cb168-721"><a href="#cb168-721" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-722"><a href="#cb168-722" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Función para calcular los p-valores entre dos variables</span></span>
<span id="cb168-723"><a href="#cb168-723" aria-hidden="true" tabindex="-1"></a>  calcular_p_valores <span class="ot">&lt;-</span> <span class="cf">function</span>(i, j) {</span>
<span id="cb168-724"><a href="#cb168-724" aria-hidden="true" tabindex="-1"></a>    an <span class="ot">&lt;-</span> <span class="fu">analisis_bivariante_automatico</span>(data[, i], data[, j], <span class="fu">colnames</span>(data)[i], <span class="fu">colnames</span>(data)[j])</span>
<span id="cb168-725"><a href="#cb168-725" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(an<span class="sc">$</span>test<span class="sc">$</span>p.value)</span>
<span id="cb168-726"><a href="#cb168-726" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb168-727"><a href="#cb168-727" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-728"><a href="#cb168-728" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular los p-valores para todas las combinaciones de variables utilizando lapply</span></span>
<span id="cb168-729"><a href="#cb168-729" aria-hidden="true" tabindex="-1"></a>  indices <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="dv">1</span><span class="sc">:</span>num_variables, <span class="dv">1</span><span class="sc">:</span>num_variables)</span>
<span id="cb168-730"><a href="#cb168-730" aria-hidden="true" tabindex="-1"></a>  p_valores <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">unlist</span>(<span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(indices), <span class="cf">function</span>(idx) {</span>
<span id="cb168-731"><a href="#cb168-731" aria-hidden="true" tabindex="-1"></a>    <span class="fu">calcular_p_valores</span>(indices[idx, <span class="dv">1</span>], indices[idx, <span class="dv">2</span>])</span>
<span id="cb168-732"><a href="#cb168-732" aria-hidden="true" tabindex="-1"></a>  })), <span class="at">nrow =</span> num_variables, <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb168-733"><a href="#cb168-733" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-734"><a href="#cb168-734" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Agregar nombres de columnas y filas para identificar las variables</span></span>
<span id="cb168-735"><a href="#cb168-735" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(p_valores) <span class="ot">&lt;-</span> <span class="fu">colnames</span>(data)</span>
<span id="cb168-736"><a href="#cb168-736" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(p_valores) <span class="ot">&lt;-</span> <span class="fu">colnames</span>(data)</span>
<span id="cb168-737"><a href="#cb168-737" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-738"><a href="#cb168-738" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convertir la matriz en un data frame largo</span></span>
<span id="cb168-739"><a href="#cb168-739" aria-hidden="true" tabindex="-1"></a>  p_valores_long <span class="ot">&lt;-</span> <span class="fu">melt</span>(p_valores, <span class="at">varnames =</span> <span class="fu">c</span>(<span class="st">"Variable1"</span>, <span class="st">"Variable2"</span>), <span class="at">value.name =</span> <span class="st">"p_value"</span>)</span>
<span id="cb168-740"><a href="#cb168-740" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-741"><a href="#cb168-741" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Crear el mapa de calor usando ggplot2</span></span>
<span id="cb168-742"><a href="#cb168-742" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="at">data =</span> p_valores_long, <span class="fu">aes</span>(<span class="at">x =</span> Variable1, <span class="at">y =</span> Variable2, <span class="at">fill =</span> p_value)) <span class="sc">+</span></span>
<span id="cb168-743"><a href="#cb168-743" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_tile</span>() <span class="sc">+</span></span>
<span id="cb168-744"><a href="#cb168-744" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_gradient</span>(<span class="at">low =</span> <span class="st">"lightblue"</span>, <span class="at">high =</span> <span class="st">"#7469B6"</span>) <span class="sc">+</span></span>
<span id="cb168-745"><a href="#cb168-745" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Heat Map of p-values"</span>, <span class="at">x =</span> <span class="st">"Variables"</span>, <span class="at">y =</span> <span class="st">"Variables"</span>) <span class="sc">+</span></span>
<span id="cb168-746"><a href="#cb168-746" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb168-747"><a href="#cb168-747" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span>
<span id="cb168-748"><a href="#cb168-748" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb168-749"><a href="#cb168-749" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-750"><a href="#cb168-750" aria-hidden="true" tabindex="-1"></a><span class="co"># Ejemplo de uso con un conjunto de datos llamado 'data'</span></span>
<span id="cb168-751"><a href="#cb168-751" aria-hidden="true" tabindex="-1"></a><span class="co"># Asegúrate de definir la función 'analisis_bivariante_automatico' antes de usar esta función</span></span>
<span id="cb168-752"><a href="#cb168-752" aria-hidden="true" tabindex="-1"></a><span class="fu">generar_mapa_calor_p_valores</span>(data, analisis_bivariante_automatico)</span>
<span id="cb168-753"><a href="#cb168-753" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-754"><a href="#cb168-754" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-755"><a href="#cb168-755" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-756"><a href="#cb168-756" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-757"><a href="#cb168-757" aria-hidden="true" tabindex="-1"></a>The association results presented in the table depict the strength and significance of relationships between various variables in the study.</span>
<span id="cb168-758"><a href="#cb168-758" aria-hidden="true" tabindex="-1"></a>Each value in the table represents a measure of association, such as p-values, reflecting the level of dependency or independence between pairs of variables.</span>
<span id="cb168-759"><a href="#cb168-759" aria-hidden="true" tabindex="-1"></a>Upon reviewing the table, several notable associations emerge. For instance, the variables **ESTADO_ACTUAL** and **FENOTIPO** exhibit a strong association, with a p-value of 0.0000001, indicating a significant relationship between the two variables. Similarly, the variables **ESTADO_ACTUAL** and **ESTADIO** also demonstrate a significant association, with a p-value of 0.0000001, suggesting a strong relationship between disease stage and patient status. These findings provide valuable insights into the interplay between different variables and their impact on patient outcomes.</span>
<span id="cb168-760"><a href="#cb168-760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-761"><a href="#cb168-761" aria-hidden="true" tabindex="-1"></a><span class="fu">## Variable imbalance {#variable-unbalance}</span></span>
<span id="cb168-762"><a href="#cb168-762" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-763"><a href="#cb168-763" aria-hidden="true" tabindex="-1"></a>In this section, we are going to analyze the imbalance in the target variable and the effect of this imbalance on the model performance.</span>
<span id="cb168-764"><a href="#cb168-764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-767"><a href="#cb168-767" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-768"><a href="#cb168-768" aria-hidden="true" tabindex="-1"></a><span class="co"># Supongamos que data$ESTADO_ACTUAL es la variable objetivo</span></span>
<span id="cb168-769"><a href="#cb168-769" aria-hidden="true" tabindex="-1"></a>frecuencia_clases <span class="ot">&lt;-</span> <span class="fu">table</span>(data<span class="sc">$</span>ESTADO_ACTUAL)</span>
<span id="cb168-770"><a href="#cb168-770" aria-hidden="true" tabindex="-1"></a>porcentaje_clases <span class="ot">&lt;-</span> <span class="fu">prop.table</span>(frecuencia_clases) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb168-771"><a href="#cb168-771" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-772"><a href="#cb168-772" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear un data frame con los porcentajes</span></span>
<span id="cb168-773"><a href="#cb168-773" aria-hidden="true" tabindex="-1"></a>df_porcentaje <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(porcentaje_clases)</span>
<span id="cb168-774"><a href="#cb168-774" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(df_porcentaje) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Clase"</span>, <span class="st">"Porcentaje"</span>)</span>
<span id="cb168-775"><a href="#cb168-775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-776"><a href="#cb168-776" aria-hidden="true" tabindex="-1"></a><span class="co"># Mostrar la tabla usando kable</span></span>
<span id="cb168-777"><a href="#cb168-777" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(df_porcentaje, <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Class"</span>, <span class="st">"Percentage (%)"</span>), <span class="at">caption =</span> <span class="st">"Target imbalance"</span>)</span>
<span id="cb168-778"><a href="#cb168-778" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-779"><a href="#cb168-779" aria-hidden="true" tabindex="-1"></a>The fact that the target is completely unbalanced can lead to a model that is not able to predict the minority class, this is a common problem in classification models and we are going to address it in the next sections.</span>
<span id="cb168-780"><a href="#cb168-780" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb168-781"><a href="#cb168-781" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-782"><a href="#cb168-782" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-783"><a href="#cb168-783" aria-hidden="true" tabindex="-1"></a><span class="fu"># Variable selection {#variable-selection}</span></span>
<span id="cb168-784"><a href="#cb168-784" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-785"><a href="#cb168-785" aria-hidden="true" tabindex="-1"></a>Variable selection is a crucial step in building predictive models, helping to identify the most relevant features for the target prediction. There are three main methods for variable selection: filter methods, wrapper methods, and embedded methods. In this section, we will explore these methods to select the most important variables for our predictive model.</span>
<span id="cb168-786"><a href="#cb168-786" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-787"><a href="#cb168-787" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset style="background-color: #f0f0f0;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;"}</span>
<span id="cb168-788"><a href="#cb168-788" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-789"><a href="#cb168-789" aria-hidden="true" tabindex="-1"></a><span class="fu">## Filter methods {#filter-methods}</span></span>
<span id="cb168-790"><a href="#cb168-790" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-791"><a href="#cb168-791" aria-hidden="true" tabindex="-1"></a>Filter methods select important variables before the learning algorithm is applied. These methods are independent of the learning algorithm and are based on intrinsic characteristics of the data, such as correlation, mutual information, or variance. We are going to use the p-value of the adecuated test to select the most important variables in terms of dependence with the target variable.</span>
<span id="cb168-792"><a href="#cb168-792" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-793"><a href="#cb168-793" aria-hidden="true" tabindex="-1"></a>Here is an example of a filter with all the data, remember that we have to do this process in every fold of the cross validation to avoid data leakage.</span>
<span id="cb168-796"><a href="#cb168-796" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-797"><a href="#cb168-797" aria-hidden="true" tabindex="-1"></a>filter_dependency <span class="ot">&lt;-</span> <span class="cf">function</span>(data, dependent_variable, columns, <span class="at">significance_level =</span> <span class="fl">0.05</span>) {</span>
<span id="cb168-798"><a href="#cb168-798" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Realizar el análisis bivariante y obtener los resultados</span></span>
<span id="cb168-799"><a href="#cb168-799" aria-hidden="true" tabindex="-1"></a>  resultados_para_tabla <span class="ot">&lt;-</span> <span class="fu">lapply</span>(columns, <span class="cf">function</span>(col) {</span>
<span id="cb168-800"><a href="#cb168-800" aria-hidden="true" tabindex="-1"></a>    <span class="fu">analisis_bivariante_automatico</span>(data[[dependent_variable]], data[[col]], dependent_variable, col)</span>
<span id="cb168-801"><a href="#cb168-801" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb168-802"><a href="#cb168-802" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-803"><a href="#cb168-803" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Obtener los p-values de las pruebas bivariadas</span></span>
<span id="cb168-804"><a href="#cb168-804" aria-hidden="true" tabindex="-1"></a>  p_values <span class="ot">&lt;-</span> <span class="fu">sapply</span>(resultados_para_tabla, <span class="cf">function</span>(x) x<span class="sc">$</span>test<span class="sc">$</span>p.value)</span>
<span id="cb168-805"><a href="#cb168-805" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-806"><a href="#cb168-806" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Seleccionar las variables con p-value por debajo del umbral</span></span>
<span id="cb168-807"><a href="#cb168-807" aria-hidden="true" tabindex="-1"></a>  columnas_seleccionadas <span class="ot">&lt;-</span> columns[p_values <span class="sc">&lt;</span> significance_level]</span>
<span id="cb168-808"><a href="#cb168-808" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-809"><a href="#cb168-809" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filtrar el conjunto de datos para incluir solo las columnas seleccionadas y la columna dependiente</span></span>
<span id="cb168-810"><a href="#cb168-810" aria-hidden="true" tabindex="-1"></a>  data_filtrada <span class="ot">&lt;-</span> data[, <span class="fu">c</span>(dependent_variable, columnas_seleccionadas)]</span>
<span id="cb168-811"><a href="#cb168-811" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-812"><a href="#cb168-812" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Retornar el conjunto de datos filtrado</span></span>
<span id="cb168-813"><a href="#cb168-813" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(data_filtrada)</span>
<span id="cb168-814"><a href="#cb168-814" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb168-815"><a href="#cb168-815" aria-hidden="true" tabindex="-1"></a>filtered_data <span class="ot">&lt;-</span> <span class="fu">filter_dependency</span>(data, <span class="st">"ESTADO_ACTUAL"</span>, columnas)</span>
<span id="cb168-816"><a href="#cb168-816" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="st">"ESTADO_ACTUAL.1"</span> <span class="sc">%in%</span> <span class="fu">colnames</span>(filtered_data)) {</span>
<span id="cb168-817"><a href="#cb168-817" aria-hidden="true" tabindex="-1"></a>    filtered_data <span class="ot">&lt;-</span> filtered_data[, <span class="sc">!</span><span class="fu">colnames</span>(filtered_data) <span class="sc">%in%</span> <span class="st">"ESTADO_ACTUAL.1"</span>, drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb168-818"><a href="#cb168-818" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb168-819"><a href="#cb168-819" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(filtered_data)</span>
<span id="cb168-820"><a href="#cb168-820" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-821"><a href="#cb168-821" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-822"><a href="#cb168-822" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-823"><a href="#cb168-823" aria-hidden="true" tabindex="-1"></a><span class="fu">## Wrapper methods {#wrapper-methods}</span></span>
<span id="cb168-824"><a href="#cb168-824" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-825"><a href="#cb168-825" aria-hidden="true" tabindex="-1"></a>Wrapper methods use a learning algorithm to evaluate the importance of variables. In each iteration, a different subset of variables is evaluated, and the set that provides the best model performance is selected. These methods are typically more accurate than filter methods but are also more computationally expensive.</span>
<span id="cb168-826"><a href="#cb168-826" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-827"><a href="#cb168-827" aria-hidden="true" tabindex="-1"></a>A common example of a wrapper method is forward selection or backward elimination. These methods test different combinations of variables and select those that improve model performance.</span>
<span id="cb168-828"><a href="#cb168-828" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-829"><a href="#cb168-829" aria-hidden="true" tabindex="-1"></a>In the next sections, we will implement a wrapper method to select the best variables with brute force. Basically, we are going to iterate over all the possible combinations of variables and select the one that provides the best model performance.</span>
<span id="cb168-830"><a href="#cb168-830" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-831"><a href="#cb168-831" aria-hidden="true" tabindex="-1"></a><span class="fu">## Embedded methods {#embedded-methods}</span></span>
<span id="cb168-832"><a href="#cb168-832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-833"><a href="#cb168-833" aria-hidden="true" tabindex="-1"></a>Embedded methods perform variable selection during the training process of the model. These methods are specific to the learning algorithm and are built into the model. For example, decision trees and random forests have built-in feature selection capabilities based on the importance of variables in the model.</span>
<span id="cb168-834"><a href="#cb168-834" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-835"><a href="#cb168-835" aria-hidden="true" tabindex="-1"></a>We are going to select the most important variables using the Random Forest algorithm, which provides a measure of variable importance based on the Mean Decrease Gini index.</span>
<span id="cb168-836"><a href="#cb168-836" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-837"><a href="#cb168-837" aria-hidden="true" tabindex="-1"></a>Example of embedded method:</span>
<span id="cb168-838"><a href="#cb168-838" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-841"><a href="#cb168-841" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-842"><a href="#cb168-842" aria-hidden="true" tabindex="-1"></a>seleccionar_variables_importantes <span class="ot">&lt;-</span> <span class="cf">function</span>(data, target, <span class="at">top_n =</span> <span class="dv">10</span>, <span class="at">seed =</span> <span class="dv">123</span>) {</span>
<span id="cb168-843"><a href="#cb168-843" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Asegurarse de que el target esté en el data frame</span></span>
<span id="cb168-844"><a href="#cb168-844" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>target <span class="sc">%in%</span> <span class="fu">names</span>(data)) {</span>
<span id="cb168-845"><a href="#cb168-845" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"La variable objetivo no está en el conjunto de datos."</span>)</span>
<span id="cb168-846"><a href="#cb168-846" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb168-847"><a href="#cb168-847" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-848"><a href="#cb168-848" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convertir la variable target a un factor si no lo es</span></span>
<span id="cb168-849"><a href="#cb168-849" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.factor</span>(data[[target]])) {</span>
<span id="cb168-850"><a href="#cb168-850" aria-hidden="true" tabindex="-1"></a>    data[[target]] <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(data[[target]])</span>
<span id="cb168-851"><a href="#cb168-851" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb168-852"><a href="#cb168-852" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-853"><a href="#cb168-853" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Definir la fórmula del modelo</span></span>
<span id="cb168-854"><a href="#cb168-854" aria-hidden="true" tabindex="-1"></a>  formula <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(target, <span class="st">"~ ."</span>))</span>
<span id="cb168-855"><a href="#cb168-855" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-856"><a href="#cb168-856" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Entrenar el modelo de Random Forest</span></span>
<span id="cb168-857"><a href="#cb168-857" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb168-858"><a href="#cb168-858" aria-hidden="true" tabindex="-1"></a>  modelo_rf <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(formula, <span class="at">data =</span> data, <span class="at">importance =</span> <span class="cn">TRUE</span>)</span>
<span id="cb168-859"><a href="#cb168-859" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-860"><a href="#cb168-860" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extraer la importancia de las variables</span></span>
<span id="cb168-861"><a href="#cb168-861" aria-hidden="true" tabindex="-1"></a>  importancia <span class="ot">&lt;-</span> <span class="fu">importance</span>(modelo_rf)</span>
<span id="cb168-862"><a href="#cb168-862" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-863"><a href="#cb168-863" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convertir a un dataframe para facilidad de manejo</span></span>
<span id="cb168-864"><a href="#cb168-864" aria-hidden="true" tabindex="-1"></a>  importancia_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(importancia)</span>
<span id="cb168-865"><a href="#cb168-865" aria-hidden="true" tabindex="-1"></a>  importancia_df<span class="sc">$</span>variable <span class="ot">&lt;-</span> <span class="fu">rownames</span>(importancia_df)</span>
<span id="cb168-866"><a href="#cb168-866" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-867"><a href="#cb168-867" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ordenar por la importancia de MeanDecreaseGini</span></span>
<span id="cb168-868"><a href="#cb168-868" aria-hidden="true" tabindex="-1"></a>  importancia_df <span class="ot">&lt;-</span> importancia_df[<span class="fu">order</span>(<span class="sc">-</span>importancia_df<span class="sc">$</span>MeanDecreaseGini), ]</span>
<span id="cb168-869"><a href="#cb168-869" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-870"><a href="#cb168-870" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Seleccionar las 'top_n' variables más importantes</span></span>
<span id="cb168-871"><a href="#cb168-871" aria-hidden="true" tabindex="-1"></a>  variables_seleccionadas <span class="ot">&lt;-</span> importancia_df<span class="sc">$</span>variable[<span class="dv">1</span><span class="sc">:</span>top_n]</span>
<span id="cb168-872"><a href="#cb168-872" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-873"><a href="#cb168-873" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(variables_seleccionadas)</span>
<span id="cb168-874"><a href="#cb168-874" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb168-875"><a href="#cb168-875" aria-hidden="true" tabindex="-1"></a>variables_importantes <span class="ot">&lt;-</span> <span class="fu">seleccionar_variables_importantes</span>(data, <span class="st">"ESTADO_ACTUAL"</span>, <span class="at">top_n =</span> <span class="dv">4</span>)</span>
<span id="cb168-876"><a href="#cb168-876" aria-hidden="true" tabindex="-1"></a>filtered_data <span class="ot">&lt;-</span> data[,<span class="fu">c</span>(<span class="st">"ESTADO_ACTUAL"</span>,variables_importantes)]</span>
<span id="cb168-877"><a href="#cb168-877" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(filtered_data)</span>
<span id="cb168-878"><a href="#cb168-878" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-879"><a href="#cb168-879" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-880"><a href="#cb168-880" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb168-881"><a href="#cb168-881" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-882"><a href="#cb168-882" aria-hidden="true" tabindex="-1"></a><span class="fu"># Models</span></span>
<span id="cb168-883"><a href="#cb168-883" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-884"><a href="#cb168-884" aria-hidden="true" tabindex="-1"></a>The aim of this section is to build a predictive model to estimate the probability of metastasis. We are going to compare different models and select the one that provides the best performance based on the evaluation metrics. On top of that, we are going to compare the different variable selection methods to determine the most effective approach. </span>
<span id="cb168-885"><a href="#cb168-885" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-886"><a href="#cb168-886" aria-hidden="true" tabindex="-1"></a>For each model, we will evaluate the performance using a hold-out validation and a 5x2 cross-validation to ensure the honesty of the results, it is a good compromise between computational cost and robustness of the results.</span>
<span id="cb168-887"><a href="#cb168-887" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-888"><a href="#cb168-888" aria-hidden="true" tabindex="-1"></a><span class="fu">## First Aproach</span></span>
<span id="cb168-889"><a href="#cb168-889" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-890"><a href="#cb168-890" aria-hidden="true" tabindex="-1"></a>In this section we are going to build a logistic regression model using all the data aiming to see if the model is able to predict the target variable with a good accuracy.</span>
<span id="cb168-891"><a href="#cb168-891" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-894"><a href="#cb168-894" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-895"><a href="#cb168-895" aria-hidden="true" tabindex="-1"></a><span class="co"># Ajustar el modelo logístico</span></span>
<span id="cb168-896"><a href="#cb168-896" aria-hidden="true" tabindex="-1"></a>modelo_primero <span class="ot">&lt;-</span> <span class="fu">glm</span>(<span class="at">formula=</span> ESTADO_ACTUAL <span class="sc">~</span> ., <span class="at">data =</span> data, <span class="at">family =</span> <span class="fu">binomial</span>(<span class="st">"logit"</span>))</span>
<span id="cb168-897"><a href="#cb168-897" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-898"><a href="#cb168-898" aria-hidden="true" tabindex="-1"></a><span class="co"># Predecir en los datos de validación</span></span>
<span id="cb168-899"><a href="#cb168-899" aria-hidden="true" tabindex="-1"></a>predicciones <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelo_primero, <span class="at">newdata =</span> data, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb168-900"><a href="#cb168-900" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-901"><a href="#cb168-901" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb168-902"><a href="#cb168-902" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-903"><a href="#cb168-903" aria-hidden="true" tabindex="-1"></a><span class="fu">### Predictions</span></span>
<span id="cb168-904"><a href="#cb168-904" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-907"><a href="#cb168-907" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-908"><a href="#cb168-908" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular las predicciones para el conjunto de test</span></span>
<span id="cb168-909"><a href="#cb168-909" aria-hidden="true" tabindex="-1"></a>clases_predichas <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predicciones<span class="sc">&gt;=</span> <span class="fl">0.8</span>, <span class="st">"Vivo"</span>, <span class="st">"Exitus"</span>)</span>
<span id="cb168-910"><a href="#cb168-910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-911"><a href="#cb168-911" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-912"><a href="#cb168-912" aria-hidden="true" tabindex="-1"></a><span class="fu">mostrar_metricas</span>(data<span class="sc">$</span>ESTADO_ACTUAL,clases_predichas)</span>
<span id="cb168-913"><a href="#cb168-913" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-914"><a href="#cb168-914" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-915"><a href="#cb168-915" aria-hidden="true" tabindex="-1"></a><span class="fu">### Roc curve and auc</span></span>
<span id="cb168-916"><a href="#cb168-916" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-919"><a href="#cb168-919" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-920"><a href="#cb168-920" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular la curva ROC y el AUC para el conjunto de test</span></span>
<span id="cb168-921"><a href="#cb168-921" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_roc_curve</span>(predicciones,data<span class="sc">$</span>ESTADO_ACTUAL)</span>
<span id="cb168-922"><a href="#cb168-922" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-923"><a href="#cb168-923" aria-hidden="true" tabindex="-1"></a>At first sight the model seems to be accurate, the metrics are too optimistic though.</span>
<span id="cb168-924"><a href="#cb168-924" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb168-925"><a href="#cb168-925" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-926"><a href="#cb168-926" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset style="background-color: rgb(226, 231, 236);box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;"}</span>
<span id="cb168-927"><a href="#cb168-927" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-928"><a href="#cb168-928" aria-hidden="true" tabindex="-1"></a><span class="fu"># Logistic Regression {#logistic-regression}</span></span>
<span id="cb168-929"><a href="#cb168-929" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-930"><a href="#cb168-930" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset style="background-color: #f0f0f0;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;"}</span>
<span id="cb168-931"><a href="#cb168-931" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-932"><a href="#cb168-932" aria-hidden="true" tabindex="-1"></a><span class="fu">## Hold Out {#hold-out}</span></span>
<span id="cb168-933"><a href="#cb168-933" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-934"><a href="#cb168-934" aria-hidden="true" tabindex="-1"></a>In every model, we are going to over sample the training data to avoid the imbalance in the target variable, since in the last activity we corroborated the eficacy of this method.</span>
<span id="cb168-935"><a href="#cb168-935" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-936"><a href="#cb168-936" aria-hidden="true" tabindex="-1"></a>We are going to build a logistic regression model using the best variables selected by the wrapper cause it is the most accurate method.</span>
<span id="cb168-937"><a href="#cb168-937" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-938"><a href="#cb168-938" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,message=FALSE, warning=FALSE}</span></span>
<span id="cb168-939"><a href="#cb168-939" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-940"><a href="#cb168-940" aria-hidden="true" tabindex="-1"></a><span class="in">start_time &lt;- Sys.time()</span></span>
<span id="cb168-941"><a href="#cb168-941" aria-hidden="true" tabindex="-1"></a><span class="in">#parameters to change:</span></span>
<span id="cb168-942"><a href="#cb168-942" aria-hidden="true" tabindex="-1"></a><span class="in">proportion &lt;- 0.91</span></span>
<span id="cb168-943"><a href="#cb168-943" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-944"><a href="#cb168-944" aria-hidden="true" tabindex="-1"></a><span class="in"># Dividir el conjunto de datos en entrenamiento y test</span></span>
<span id="cb168-945"><a href="#cb168-945" aria-hidden="true" tabindex="-1"></a><span class="in">indices_entrenamiento &lt;- sample(nrow(data), 0.75 * nrow(data))  # 75% para entrenamiento</span></span>
<span id="cb168-946"><a href="#cb168-946" aria-hidden="true" tabindex="-1"></a><span class="in">datos_entrenamiento &lt;- data[indices_entrenamiento, ]</span></span>
<span id="cb168-947"><a href="#cb168-947" aria-hidden="true" tabindex="-1"></a><span class="in">datos_test &lt;- data[-indices_entrenamiento, ]</span></span>
<span id="cb168-948"><a href="#cb168-948" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-949"><a href="#cb168-949" aria-hidden="true" tabindex="-1"></a><span class="in"># Dividir datos de entrenamiento en entrenamiento y validación</span></span>
<span id="cb168-950"><a href="#cb168-950" aria-hidden="true" tabindex="-1"></a><span class="in">train_indices &lt;- sample(nrow(datos_entrenamiento), 0.8 * nrow(datos_entrenamiento))  # 80% para entrenamiento</span></span>
<span id="cb168-951"><a href="#cb168-951" aria-hidden="true" tabindex="-1"></a><span class="in">datos_entrenamiento_split &lt;- datos_entrenamiento[train_indices, ]</span></span>
<span id="cb168-952"><a href="#cb168-952" aria-hidden="true" tabindex="-1"></a><span class="in">datos_validacion &lt;- datos_entrenamiento[-train_indices, ]</span></span>
<span id="cb168-953"><a href="#cb168-953" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-954"><a href="#cb168-954" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-955"><a href="#cb168-955" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,eval=FALSE}</span></span>
<span id="cb168-956"><a href="#cb168-956" aria-hidden="true" tabindex="-1"></a><span class="in">datos_entrenamiento_oversampled &lt;- ROSE(ESTADO_ACTUAL ~ .,data=datos_entrenamiento_split,p =proportion)$data</span></span>
<span id="cb168-957"><a href="#cb168-957" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-958"><a href="#cb168-958" aria-hidden="true" tabindex="-1"></a><span class="in"># Establecer la fórmula base para el modelo logístico</span></span>
<span id="cb168-959"><a href="#cb168-959" aria-hidden="true" tabindex="-1"></a><span class="in">formula_base &lt;- formula(ESTADO_ACTUAL ~ 1)  # Fórmula inicial sin predictoras</span></span>
<span id="cb168-960"><a href="#cb168-960" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-961"><a href="#cb168-961" aria-hidden="true" tabindex="-1"></a><span class="in"># Obtener nombres de variables predictoras</span></span>
<span id="cb168-962"><a href="#cb168-962" aria-hidden="true" tabindex="-1"></a><span class="in">variables &lt;- names(datos_entrenamiento_oversampled)[-which(names(datos_entrenamiento_oversampled) == "ESTADO_ACTUAL")]</span></span>
<span id="cb168-963"><a href="#cb168-963" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-964"><a href="#cb168-964" aria-hidden="true" tabindex="-1"></a><span class="in"># Obtener todas las combinaciones posibles de variables predictoras</span></span>
<span id="cb168-965"><a href="#cb168-965" aria-hidden="true" tabindex="-1"></a><span class="in">combinaciones_variables &lt;- unlist(lapply(1:length(variables), function(x) combn(variables, x, simplify = FALSE)), recursive = FALSE)</span></span>
<span id="cb168-966"><a href="#cb168-966" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-967"><a href="#cb168-967" aria-hidden="true" tabindex="-1"></a><span class="in"># Establecer variables para almacenar el mejor modelo y su AUC</span></span>
<span id="cb168-968"><a href="#cb168-968" aria-hidden="true" tabindex="-1"></a><span class="in">mejor_modelo &lt;- NULL</span></span>
<span id="cb168-969"><a href="#cb168-969" aria-hidden="true" tabindex="-1"></a><span class="in">mejor_auc &lt;- 0</span></span>
<span id="cb168-970"><a href="#cb168-970" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-971"><a href="#cb168-971" aria-hidden="true" tabindex="-1"></a><span class="in"># Iterar sobre todas las combinaciones de variables</span></span>
<span id="cb168-972"><a href="#cb168-972" aria-hidden="true" tabindex="-1"></a><span class="in">for (combinacion in combinaciones_variables) {</span></span>
<span id="cb168-973"><a href="#cb168-973" aria-hidden="true" tabindex="-1"></a><span class="in">  # Construir la fórmula con las variables actuales</span></span>
<span id="cb168-974"><a href="#cb168-974" aria-hidden="true" tabindex="-1"></a><span class="in">  formula_actual &lt;- reformulate(combinacion, response = "ESTADO_ACTUAL")</span></span>
<span id="cb168-975"><a href="#cb168-975" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-976"><a href="#cb168-976" aria-hidden="true" tabindex="-1"></a><span class="in">  # Ajustar el modelo logístico</span></span>
<span id="cb168-977"><a href="#cb168-977" aria-hidden="true" tabindex="-1"></a><span class="in">  modelo_actual &lt;- glm(formula_actual, data = datos_entrenamiento_split, family = binomial("logit"))</span></span>
<span id="cb168-978"><a href="#cb168-978" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-979"><a href="#cb168-979" aria-hidden="true" tabindex="-1"></a><span class="in">  # Predecir en los datos de validación</span></span>
<span id="cb168-980"><a href="#cb168-980" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_validacion &lt;- predict(modelo_actual, newdata = datos_validacion, type = "response")</span></span>
<span id="cb168-981"><a href="#cb168-981" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-982"><a href="#cb168-982" aria-hidden="true" tabindex="-1"></a><span class="in">  # Calcular el AUC para la combinación actual</span></span>
<span id="cb168-983"><a href="#cb168-983" aria-hidden="true" tabindex="-1"></a><span class="in">  auc_actual &lt;- pROC::roc(datos_validacion$ESTADO_ACTUAL, predicciones_validacion)$auc</span></span>
<span id="cb168-984"><a href="#cb168-984" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-985"><a href="#cb168-985" aria-hidden="true" tabindex="-1"></a><span class="in">  # Actualizar el mejor modelo si se encuentra uno con un AUC mayor</span></span>
<span id="cb168-986"><a href="#cb168-986" aria-hidden="true" tabindex="-1"></a><span class="in">  if (auc_actual &gt; mejor_auc) {</span></span>
<span id="cb168-987"><a href="#cb168-987" aria-hidden="true" tabindex="-1"></a><span class="in">    mejor_auc &lt;- auc_actual</span></span>
<span id="cb168-988"><a href="#cb168-988" aria-hidden="true" tabindex="-1"></a><span class="in">    mejor_modelo &lt;- modelo_actual</span></span>
<span id="cb168-989"><a href="#cb168-989" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb168-990"><a href="#cb168-990" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb168-991"><a href="#cb168-991" aria-hidden="true" tabindex="-1"></a><span class="in">modelo_primero &lt;- mejor_modelo</span></span>
<span id="cb168-992"><a href="#cb168-992" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-993"><a href="#cb168-993" aria-hidden="true" tabindex="-1"></a><span class="in">end_time &lt;- Sys.time()</span></span>
<span id="cb168-994"><a href="#cb168-994" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time &lt;- end_time - start_time</span></span>
<span id="cb168-995"><a href="#cb168-995" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time_p &lt;- as.numeric(execution_time, units = "secs")</span></span>
<span id="cb168-996"><a href="#cb168-996" aria-hidden="true" tabindex="-1"></a><span class="in">save("modelo_primero", file = "modelo_primero.RData")</span></span>
<span id="cb168-997"><a href="#cb168-997" aria-hidden="true" tabindex="-1"></a><span class="in">save("execution_time_p", file = "execution_time_p.RData")</span></span>
<span id="cb168-998"><a href="#cb168-998" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-999"><a href="#cb168-999" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1002"><a href="#cb168-1002" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-1003"><a href="#cb168-1003" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"modelo_primero.RData"</span>)</span>
<span id="cb168-1004"><a href="#cb168-1004" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"execution_time_p.RData"</span>)</span>
<span id="cb168-1005"><a href="#cb168-1005" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time_p, <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb168-1006"><a href="#cb168-1006" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1007"><a href="#cb168-1007" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1008"><a href="#cb168-1008" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-1009"><a href="#cb168-1009" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1010"><a href="#cb168-1010" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb168-1011"><a href="#cb168-1011" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1012"><a href="#cb168-1012" aria-hidden="true" tabindex="-1"></a><span class="fu">### Predictions</span></span>
<span id="cb168-1013"><a href="#cb168-1013" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1016"><a href="#cb168-1016" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-1017"><a href="#cb168-1017" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular las predicciones para el conjunto de test</span></span>
<span id="cb168-1018"><a href="#cb168-1018" aria-hidden="true" tabindex="-1"></a>predicciones_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelo_primero, <span class="at">newdata =</span> datos_test, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb168-1019"><a href="#cb168-1019" aria-hidden="true" tabindex="-1"></a>clases_predichas_test <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predicciones_test <span class="sc">&gt;=</span> <span class="fl">0.85</span>, <span class="st">"Vivo"</span>, <span class="st">"Exitus"</span>)</span>
<span id="cb168-1020"><a href="#cb168-1020" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1021"><a href="#cb168-1021" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1022"><a href="#cb168-1022" aria-hidden="true" tabindex="-1"></a><span class="fu">mostrar_metricas</span>(datos_test<span class="sc">$</span>ESTADO_ACTUAL,clases_predichas_test)</span>
<span id="cb168-1023"><a href="#cb168-1023" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-1024"><a href="#cb168-1024" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1025"><a href="#cb168-1025" aria-hidden="true" tabindex="-1"></a><span class="fu">### Roc curve and auc</span></span>
<span id="cb168-1026"><a href="#cb168-1026" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1029"><a href="#cb168-1029" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-1030"><a href="#cb168-1030" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular la curva ROC y el AUC para el conjunto de test</span></span>
<span id="cb168-1031"><a href="#cb168-1031" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_roc_curve</span>(predicciones_test,datos_test<span class="sc">$</span>ESTADO_ACTUAL)</span>
<span id="cb168-1032"><a href="#cb168-1032" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-1033"><a href="#cb168-1033" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb168-1034"><a href="#cb168-1034" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1035"><a href="#cb168-1035" aria-hidden="true" tabindex="-1"></a>The performance of the model is acceptable but it seems that it is not robust at all.</span>
<span id="cb168-1036"><a href="#cb168-1036" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1037"><a href="#cb168-1037" aria-hidden="true" tabindex="-1"></a><span class="fu">## Hold Out Oversampling {#hold-out}</span></span>
<span id="cb168-1038"><a href="#cb168-1038" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1039"><a href="#cb168-1039" aria-hidden="true" tabindex="-1"></a>In every model, we are going to over sample the training data to avoid the imbalance in the target variable, since in the last activity we corroborated the eficacy of this method.</span>
<span id="cb168-1040"><a href="#cb168-1040" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1041"><a href="#cb168-1041" aria-hidden="true" tabindex="-1"></a>We are going to build a logistic regression model using the best variables selected by the wrapper cause it is the most accurate method.</span>
<span id="cb168-1042"><a href="#cb168-1042" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1043"><a href="#cb168-1043" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,message=FALSE, warning=FALSE,eval=FALSE}</span></span>
<span id="cb168-1044"><a href="#cb168-1044" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1045"><a href="#cb168-1045" aria-hidden="true" tabindex="-1"></a><span class="in">start_time &lt;- Sys.time()</span></span>
<span id="cb168-1046"><a href="#cb168-1046" aria-hidden="true" tabindex="-1"></a><span class="in">#parameters to change:</span></span>
<span id="cb168-1047"><a href="#cb168-1047" aria-hidden="true" tabindex="-1"></a><span class="in">proportion &lt;- 0.95</span></span>
<span id="cb168-1048"><a href="#cb168-1048" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1049"><a href="#cb168-1049" aria-hidden="true" tabindex="-1"></a><span class="in"># Dividir el conjunto de datos en entrenamiento y test</span></span>
<span id="cb168-1050"><a href="#cb168-1050" aria-hidden="true" tabindex="-1"></a><span class="in">indices_entrenamiento &lt;- sample(nrow(data), 0.75 * nrow(data))  # 75% para entrenamiento</span></span>
<span id="cb168-1051"><a href="#cb168-1051" aria-hidden="true" tabindex="-1"></a><span class="in">datos_entrenamiento &lt;- data[indices_entrenamiento, ]</span></span>
<span id="cb168-1052"><a href="#cb168-1052" aria-hidden="true" tabindex="-1"></a><span class="in">datos_test &lt;- data[-indices_entrenamiento, ]</span></span>
<span id="cb168-1053"><a href="#cb168-1053" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1054"><a href="#cb168-1054" aria-hidden="true" tabindex="-1"></a><span class="in"># Dividir datos de entrenamiento en entrenamiento y validación</span></span>
<span id="cb168-1055"><a href="#cb168-1055" aria-hidden="true" tabindex="-1"></a><span class="in">train_indices &lt;- sample(nrow(datos_entrenamiento), 0.8 * nrow(datos_entrenamiento))  # 80% para entrenamiento</span></span>
<span id="cb168-1056"><a href="#cb168-1056" aria-hidden="true" tabindex="-1"></a><span class="in">datos_entrenamiento_split &lt;- datos_entrenamiento[train_indices, ]</span></span>
<span id="cb168-1057"><a href="#cb168-1057" aria-hidden="true" tabindex="-1"></a><span class="in">datos_validacion &lt;- datos_entrenamiento[-train_indices, ]</span></span>
<span id="cb168-1058"><a href="#cb168-1058" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1059"><a href="#cb168-1059" aria-hidden="true" tabindex="-1"></a><span class="in">datos_entrenamiento_oversampled &lt;- ROSE(ESTADO_ACTUAL ~ .,data=datos_entrenamiento_split,p =proportion)$data</span></span>
<span id="cb168-1060"><a href="#cb168-1060" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1061"><a href="#cb168-1061" aria-hidden="true" tabindex="-1"></a><span class="in"># Establecer la fórmula base para el modelo logístico</span></span>
<span id="cb168-1062"><a href="#cb168-1062" aria-hidden="true" tabindex="-1"></a><span class="in">formula_base &lt;- formula(ESTADO_ACTUAL ~ 1)  # Fórmula inicial sin predictoras</span></span>
<span id="cb168-1063"><a href="#cb168-1063" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1064"><a href="#cb168-1064" aria-hidden="true" tabindex="-1"></a><span class="in"># Obtener nombres de variables predictoras</span></span>
<span id="cb168-1065"><a href="#cb168-1065" aria-hidden="true" tabindex="-1"></a><span class="in">variables &lt;- names(datos_entrenamiento_oversampled)[-which(names(datos_entrenamiento_oversampled) == "ESTADO_ACTUAL")]</span></span>
<span id="cb168-1066"><a href="#cb168-1066" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1067"><a href="#cb168-1067" aria-hidden="true" tabindex="-1"></a><span class="in"># Obtener todas las combinaciones posibles de variables predictoras</span></span>
<span id="cb168-1068"><a href="#cb168-1068" aria-hidden="true" tabindex="-1"></a><span class="in">combinaciones_variables &lt;- unlist(lapply(1:length(variables), function(x) combn(variables, x, simplify = FALSE)), recursive = FALSE)</span></span>
<span id="cb168-1069"><a href="#cb168-1069" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1070"><a href="#cb168-1070" aria-hidden="true" tabindex="-1"></a><span class="in"># Establecer variables para almacenar el mejor modelo y su AUC</span></span>
<span id="cb168-1071"><a href="#cb168-1071" aria-hidden="true" tabindex="-1"></a><span class="in">mejor_modelo &lt;- NULL</span></span>
<span id="cb168-1072"><a href="#cb168-1072" aria-hidden="true" tabindex="-1"></a><span class="in">mejor_auc &lt;- 0</span></span>
<span id="cb168-1073"><a href="#cb168-1073" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1074"><a href="#cb168-1074" aria-hidden="true" tabindex="-1"></a><span class="in"># Iterar sobre todas las combinaciones de variables</span></span>
<span id="cb168-1075"><a href="#cb168-1075" aria-hidden="true" tabindex="-1"></a><span class="in">for (combinacion in combinaciones_variables) {</span></span>
<span id="cb168-1076"><a href="#cb168-1076" aria-hidden="true" tabindex="-1"></a><span class="in">  # Construir la fórmula con las variables actuales</span></span>
<span id="cb168-1077"><a href="#cb168-1077" aria-hidden="true" tabindex="-1"></a><span class="in">  formula_actual &lt;- reformulate(combinacion, response = "ESTADO_ACTUAL")</span></span>
<span id="cb168-1078"><a href="#cb168-1078" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-1079"><a href="#cb168-1079" aria-hidden="true" tabindex="-1"></a><span class="in">  # Ajustar el modelo logístico</span></span>
<span id="cb168-1080"><a href="#cb168-1080" aria-hidden="true" tabindex="-1"></a><span class="in">  modelo_actual &lt;- glm(formula_actual, data = datos_entrenamiento_oversampled, family = binomial("logit"))</span></span>
<span id="cb168-1081"><a href="#cb168-1081" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-1082"><a href="#cb168-1082" aria-hidden="true" tabindex="-1"></a><span class="in">  # Predecir en los datos de validación</span></span>
<span id="cb168-1083"><a href="#cb168-1083" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_validacion &lt;- predict(modelo_actual, newdata = datos_validacion, type = "response")</span></span>
<span id="cb168-1084"><a href="#cb168-1084" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-1085"><a href="#cb168-1085" aria-hidden="true" tabindex="-1"></a><span class="in">  # Calcular el AUC para la combinación actual</span></span>
<span id="cb168-1086"><a href="#cb168-1086" aria-hidden="true" tabindex="-1"></a><span class="in">  auc_actual &lt;- pROC::roc(datos_validacion$ESTADO_ACTUAL, predicciones_validacion)$auc</span></span>
<span id="cb168-1087"><a href="#cb168-1087" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-1088"><a href="#cb168-1088" aria-hidden="true" tabindex="-1"></a><span class="in">  # Actualizar el mejor modelo si se encuentra uno con un AUC mayor</span></span>
<span id="cb168-1089"><a href="#cb168-1089" aria-hidden="true" tabindex="-1"></a><span class="in">  if (auc_actual &gt; mejor_auc) {</span></span>
<span id="cb168-1090"><a href="#cb168-1090" aria-hidden="true" tabindex="-1"></a><span class="in">    mejor_auc &lt;- auc_actual</span></span>
<span id="cb168-1091"><a href="#cb168-1091" aria-hidden="true" tabindex="-1"></a><span class="in">    mejor_modelo &lt;- modelo_actual</span></span>
<span id="cb168-1092"><a href="#cb168-1092" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb168-1093"><a href="#cb168-1093" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb168-1094"><a href="#cb168-1094" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1095"><a href="#cb168-1095" aria-hidden="true" tabindex="-1"></a><span class="in">summary(mejor_modelo)</span></span>
<span id="cb168-1096"><a href="#cb168-1096" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1097"><a href="#cb168-1097" aria-hidden="true" tabindex="-1"></a><span class="in">end_time &lt;- Sys.time()</span></span>
<span id="cb168-1098"><a href="#cb168-1098" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time &lt;- end_time - start_time</span></span>
<span id="cb168-1099"><a href="#cb168-1099" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time &lt;- as.numeric(execution_time, units = "secs")</span></span>
<span id="cb168-1100"><a href="#cb168-1100" aria-hidden="true" tabindex="-1"></a><span class="in">save("mejor_modelo", file = "mejor_modelo.RData")</span></span>
<span id="cb168-1101"><a href="#cb168-1101" aria-hidden="true" tabindex="-1"></a><span class="in">save("execution_time", file = "execution_time.RData")</span></span>
<span id="cb168-1102"><a href="#cb168-1102" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-1103"><a href="#cb168-1103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1106"><a href="#cb168-1106" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-1107"><a href="#cb168-1107" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"mejor_modelo.RData"</span>)</span>
<span id="cb168-1108"><a href="#cb168-1108" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"execution_time.RData"</span>)</span>
<span id="cb168-1109"><a href="#cb168-1109" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time, <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb168-1110"><a href="#cb168-1110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1111"><a href="#cb168-1111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1112"><a href="#cb168-1112" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-1113"><a href="#cb168-1113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1114"><a href="#cb168-1114" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb168-1115"><a href="#cb168-1115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1116"><a href="#cb168-1116" aria-hidden="true" tabindex="-1"></a><span class="fu">### Predictions</span></span>
<span id="cb168-1117"><a href="#cb168-1117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1120"><a href="#cb168-1120" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-1121"><a href="#cb168-1121" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular las predicciones para el conjunto de test</span></span>
<span id="cb168-1122"><a href="#cb168-1122" aria-hidden="true" tabindex="-1"></a>predicciones_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(mejor_modelo, <span class="at">newdata =</span> datos_test, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb168-1123"><a href="#cb168-1123" aria-hidden="true" tabindex="-1"></a>clases_predichas_test <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predicciones_test <span class="sc">&gt;=</span> <span class="fl">0.5</span>, <span class="st">"Vivo"</span>, <span class="st">"Exitus"</span>)</span>
<span id="cb168-1124"><a href="#cb168-1124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1125"><a href="#cb168-1125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1126"><a href="#cb168-1126" aria-hidden="true" tabindex="-1"></a><span class="fu">mostrar_metricas</span>(datos_test<span class="sc">$</span>ESTADO_ACTUAL,clases_predichas_test)</span>
<span id="cb168-1127"><a href="#cb168-1127" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-1128"><a href="#cb168-1128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1129"><a href="#cb168-1129" aria-hidden="true" tabindex="-1"></a><span class="fu">### Roc curve and auc</span></span>
<span id="cb168-1130"><a href="#cb168-1130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1133"><a href="#cb168-1133" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-1134"><a href="#cb168-1134" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular la curva ROC y el AUC para el conjunto de test</span></span>
<span id="cb168-1135"><a href="#cb168-1135" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_roc_curve</span>(predicciones_test,datos_test<span class="sc">$</span>ESTADO_ACTUAL)</span>
<span id="cb168-1136"><a href="#cb168-1136" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-1137"><a href="#cb168-1137" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb168-1138"><a href="#cb168-1138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1139"><a href="#cb168-1139" aria-hidden="true" tabindex="-1"></a>The performance of the model is acceptable but it seems that it is not robust at all.</span>
<span id="cb168-1142"><a href="#cb168-1142" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-1143"><a href="#cb168-1143" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(<span class="at">eval =</span> <span class="cn">FALSE</span>)</span>
<span id="cb168-1144"><a href="#cb168-1144" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-1145"><a href="#cb168-1145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1146"><a href="#cb168-1146" aria-hidden="true" tabindex="-1"></a><span class="fu">## 5x2 Cross Validation Filter </span></span>
<span id="cb168-1147"><a href="#cb168-1147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1148"><a href="#cb168-1148" aria-hidden="true" tabindex="-1"></a>We are going to perform a 5x2 cross validation to ensure the robustness of the model.</span>
<span id="cb168-1149"><a href="#cb168-1149" aria-hidden="true" tabindex="-1"></a>First, we create the outer folds and then we iterate over them to create the inner folds and perform the model selection process.</span>
<span id="cb168-1150"><a href="#cb168-1150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1151"><a href="#cb168-1151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1152"><a href="#cb168-1152" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=FALSE,message=FALSE}</span></span>
<span id="cb168-1153"><a href="#cb168-1153" aria-hidden="true" tabindex="-1"></a><span class="in">start_time &lt;- Sys.time()</span></span>
<span id="cb168-1154"><a href="#cb168-1154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1155"><a href="#cb168-1155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1156"><a href="#cb168-1156" aria-hidden="true" tabindex="-1"></a><span class="in"># Configurar la validación cruzada 5x2</span></span>
<span id="cb168-1157"><a href="#cb168-1157" aria-hidden="true" tabindex="-1"></a><span class="in">k_outer &lt;- 5  # Número de pliegues externos</span></span>
<span id="cb168-1158"><a href="#cb168-1158" aria-hidden="true" tabindex="-1"></a><span class="in">k_inner &lt;- 2  # Número de pliegues internos</span></span>
<span id="cb168-1159"><a href="#cb168-1159" aria-hidden="true" tabindex="-1"></a><span class="in">folds_outer &lt;- createFolds(data$ESTADO_ACTUAL, k = k_outer, list = FALSE)  # Obtener índices de pliegues externos</span></span>
<span id="cb168-1160"><a href="#cb168-1160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1161"><a href="#cb168-1161" aria-hidden="true" tabindex="-1"></a><span class="in"># Lista para almacenar resultados</span></span>
<span id="cb168-1162"><a href="#cb168-1162" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_auc &lt;- numeric(k_outer)</span></span>
<span id="cb168-1163"><a href="#cb168-1163" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_sensibilidad &lt;- numeric(k_outer)</span></span>
<span id="cb168-1164"><a href="#cb168-1164" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_accuracy &lt;- numeric(k_outer)</span></span>
<span id="cb168-1165"><a href="#cb168-1165" aria-hidden="true" tabindex="-1"></a><span class="in">indices &lt;- 1:nrow(data)</span></span>
<span id="cb168-1166"><a href="#cb168-1166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1167"><a href="#cb168-1167" aria-hidden="true" tabindex="-1"></a><span class="in"># Inicializar matrices para almacenar predicciones y objetivos</span></span>
<span id="cb168-1168"><a href="#cb168-1168" aria-hidden="true" tabindex="-1"></a><span class="in">predicciones_totales &lt;- matrix(NA, nrow = nrow(data), ncol = k_outer)</span></span>
<span id="cb168-1169"><a href="#cb168-1169" aria-hidden="true" tabindex="-1"></a><span class="in">targets_totales &lt;- numeric(nrow(data))</span></span>
<span id="cb168-1170"><a href="#cb168-1170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1171"><a href="#cb168-1171" aria-hidden="true" tabindex="-1"></a><span class="in"># Iterar sobre cada pliegue externo y realizar el proceso de modelado</span></span>
<span id="cb168-1172"><a href="#cb168-1172" aria-hidden="true" tabindex="-1"></a><span class="in">for (i_outer in 1:k_outer) {</span></span>
<span id="cb168-1173"><a href="#cb168-1173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1174"><a href="#cb168-1174" aria-hidden="true" tabindex="-1"></a><span class="in">  # Obtener los índices para el pliegue externo actual</span></span>
<span id="cb168-1175"><a href="#cb168-1175" aria-hidden="true" tabindex="-1"></a><span class="in">  test_indices_outer &lt;- indices[folds_outer==i_outer]  # Índices correspondientes al pliegue externo de test</span></span>
<span id="cb168-1176"><a href="#cb168-1176" aria-hidden="true" tabindex="-1"></a><span class="in">  train_indices_outer &lt;- setdiff(1:nrow(data), test_indices_outer)  # Índices correspondientes al conjunto de entrenamiento</span></span>
<span id="cb168-1177"><a href="#cb168-1177" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-1178"><a href="#cb168-1178" aria-hidden="true" tabindex="-1"></a><span class="in">  # Dividir datos en entrenamiento y test para el pliegue externo</span></span>
<span id="cb168-1179"><a href="#cb168-1179" aria-hidden="true" tabindex="-1"></a><span class="in">  datos_entrenamiento_outer &lt;- data[train_indices_outer, ]</span></span>
<span id="cb168-1180"><a href="#cb168-1180" aria-hidden="true" tabindex="-1"></a><span class="in">  datos_test_outer &lt;- data[test_indices_outer, ]</span></span>
<span id="cb168-1181"><a href="#cb168-1181" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-1182"><a href="#cb168-1182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1183"><a href="#cb168-1183" aria-hidden="true" tabindex="-1"></a><span class="in">  # Configurar la validación cruzada interna</span></span>
<span id="cb168-1184"><a href="#cb168-1184" aria-hidden="true" tabindex="-1"></a><span class="in">  folds_inner &lt;- createFolds(datos_entrenamiento_outer$ESTADO_ACTUAL, k = k_inner, list = FALSE)  # Obtener índices de pliegues internos</span></span>
<span id="cb168-1185"><a href="#cb168-1185" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-1186"><a href="#cb168-1186" aria-hidden="true" tabindex="-1"></a><span class="in">  # Almacenar predicciones y test para formar una curva ROC general</span></span>
<span id="cb168-1187"><a href="#cb168-1187" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_auc &lt;- numeric(nrow(datos_entrenamiento_outer))</span></span>
<span id="cb168-1188"><a href="#cb168-1188" aria-hidden="true" tabindex="-1"></a><span class="in">  targets_auc &lt;- numeric(nrow(datos_entrenamiento_outer))</span></span>
<span id="cb168-1189"><a href="#cb168-1189" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-1190"><a href="#cb168-1190" aria-hidden="true" tabindex="-1"></a><span class="in">  # Iterar sobre cada pliegue interno para selección de modelo</span></span>
<span id="cb168-1191"><a href="#cb168-1191" aria-hidden="true" tabindex="-1"></a><span class="in">  indices_inner &lt;- 1:nrow(datos_entrenamiento_outer)</span></span>
<span id="cb168-1192"><a href="#cb168-1192" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_auc_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-1193"><a href="#cb168-1193" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_sensibilidad_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-1194"><a href="#cb168-1194" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_accuracy_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-1195"><a href="#cb168-1195" aria-hidden="true" tabindex="-1"></a><span class="in">  for (i_inner in 1:k_inner) {</span></span>
<span id="cb168-1196"><a href="#cb168-1196" aria-hidden="true" tabindex="-1"></a><span class="in">    filter_data &lt;- filter_dependency(datos_entrenamiento_outer,"ESTADO_ACTUAL",colnames(datos_entrenamiento_outer),0.05)</span></span>
<span id="cb168-1197"><a href="#cb168-1197" aria-hidden="true" tabindex="-1"></a><span class="in">    if ("ESTADO_ACTUAL.1" %in% colnames(filter_data)) {</span></span>
<span id="cb168-1198"><a href="#cb168-1198" aria-hidden="true" tabindex="-1"></a><span class="in">      filter_data &lt;- filter_data[, !colnames(filter_data) %in% "ESTADO_ACTUAL.1", drop = FALSE]</span></span>
<span id="cb168-1199"><a href="#cb168-1199" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb168-1200"><a href="#cb168-1200" aria-hidden="true" tabindex="-1"></a><span class="in">    ###############################</span></span>
<span id="cb168-1201"><a href="#cb168-1201" aria-hidden="true" tabindex="-1"></a><span class="in">    #### Aqui el filtrado##########</span></span>
<span id="cb168-1202"><a href="#cb168-1202" aria-hidden="true" tabindex="-1"></a><span class="in">    ###############################</span></span>
<span id="cb168-1203"><a href="#cb168-1203" aria-hidden="true" tabindex="-1"></a><span class="in">#con poca variables solo unaa la vez o filtrado o wrapper</span></span>
<span id="cb168-1204"><a href="#cb168-1204" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-1205"><a href="#cb168-1205" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-1206"><a href="#cb168-1206" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-1207"><a href="#cb168-1207" aria-hidden="true" tabindex="-1"></a><span class="in">    # Obtener los índices para el pliegue interno actual</span></span>
<span id="cb168-1208"><a href="#cb168-1208" aria-hidden="true" tabindex="-1"></a><span class="in">    test_indices_inner &lt;- indices_inner[folds_inner==i_inner]  # Índices correspondientes al pliegue interno de test</span></span>
<span id="cb168-1209"><a href="#cb168-1209" aria-hidden="true" tabindex="-1"></a><span class="in">    train_indices_inner &lt;- setdiff(1:nrow(filter_data), test_indices_inner)  # Índices correspondientes al conjunto de entrenamiento interno</span></span>
<span id="cb168-1210"><a href="#cb168-1210" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-1211"><a href="#cb168-1211" aria-hidden="true" tabindex="-1"></a><span class="in">    # Dividir datos en entrenamiento y test para el pliegue interno</span></span>
<span id="cb168-1212"><a href="#cb168-1212" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_entrenamiento_inner &lt;- filter_data[train_indices_inner, ]</span></span>
<span id="cb168-1213"><a href="#cb168-1213" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_validacion &lt;- filter_data[test_indices_inner, ]</span></span>
<span id="cb168-1214"><a href="#cb168-1214" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-1215"><a href="#cb168-1215" aria-hidden="true" tabindex="-1"></a><span class="in"> </span></span>
<span id="cb168-1216"><a href="#cb168-1216" aria-hidden="true" tabindex="-1"></a><span class="in">    # Aplicar oversampling en el conjunto de entrenamiento interno</span></span>
<span id="cb168-1217"><a href="#cb168-1217" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_entrenamiento_oversampled &lt;- ROSE(ESTADO_ACTUAL ~ .,</span></span>
<span id="cb168-1218"><a href="#cb168-1218" aria-hidden="true" tabindex="-1"></a><span class="in">                                            data = datos_entrenamiento_inner,</span></span>
<span id="cb168-1219"><a href="#cb168-1219" aria-hidden="true" tabindex="-1"></a><span class="in">                                            p = 0.93)$data</span></span>
<span id="cb168-1220"><a href="#cb168-1220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1221"><a href="#cb168-1221" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-1222"><a href="#cb168-1222" aria-hidden="true" tabindex="-1"></a><span class="in">    # Ajustar el modelo logístico</span></span>
<span id="cb168-1223"><a href="#cb168-1223" aria-hidden="true" tabindex="-1"></a><span class="in">    modelo_actual &lt;- glm("ESTADO_ACTUAL ~ .", data = datos_entrenamiento_oversampled, family = binomial("logit"))</span></span>
<span id="cb168-1224"><a href="#cb168-1224" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-1225"><a href="#cb168-1225" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-1226"><a href="#cb168-1226" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-1227"><a href="#cb168-1227" aria-hidden="true" tabindex="-1"></a><span class="in">    # Realizar predicciones en el conjunto de entrenamiento externo para el AUC general</span></span>
<span id="cb168-1228"><a href="#cb168-1228" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_auc[test_indices_inner] &lt;- predict(modelo_actual, newdata = datos_validacion, type = "response")</span></span>
<span id="cb168-1229"><a href="#cb168-1229" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_clasificadas &lt;- ifelse(predicciones_auc[test_indices_inner] &gt;= 0.5, "SI", "NO")</span></span>
<span id="cb168-1230"><a href="#cb168-1230" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-1231"><a href="#cb168-1231" aria-hidden="true" tabindex="-1"></a><span class="in">    resultados_sensibilidad_inner[i_inner] &lt;- sum(predicciones_clasificadas == "SI" &amp; datos_validacion[["ESTADO_ACTUAL"]] == "SI") / sum(datos_validacion[["ESTADO_ACTUAL"]] == "SI")</span></span>
<span id="cb168-1232"><a href="#cb168-1232" aria-hidden="true" tabindex="-1"></a><span class="in">    resultados_accuracy_inner[i_inner] &lt;- mean(predicciones_clasificadas == datos_validacion[["ESTADO_ACTUAL"]])</span></span>
<span id="cb168-1233"><a href="#cb168-1233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1234"><a href="#cb168-1234" aria-hidden="true" tabindex="-1"></a><span class="in">    targets_auc[test_indices_inner] &lt;- as.numeric(datos_validacion$ESTADO_ACTUAL) - 1</span></span>
<span id="cb168-1235"><a href="#cb168-1235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1236"><a href="#cb168-1236" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb168-1237"><a href="#cb168-1237" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-1238"><a href="#cb168-1238" aria-hidden="true" tabindex="-1"></a><span class="in">  # Calcular el AUC final para este fold externo</span></span>
<span id="cb168-1239"><a href="#cb168-1239" aria-hidden="true" tabindex="-1"></a><span class="in">  auc_fold_externo &lt;- pROC::roc(targets_auc, predicciones_auc)$auc</span></span>
<span id="cb168-1240"><a href="#cb168-1240" aria-hidden="true" tabindex="-1"></a><span class="in">  accuracy_fold_externo &lt;- mean(resultados_accuracy_inner)</span></span>
<span id="cb168-1241"><a href="#cb168-1241" aria-hidden="true" tabindex="-1"></a><span class="in">  sensibilidad_fold_externo &lt;- mean(resultados_sensibilidad_inner)</span></span>
<span id="cb168-1242"><a href="#cb168-1242" aria-hidden="true" tabindex="-1"></a><span class="in"> </span></span>
<span id="cb168-1243"><a href="#cb168-1243" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-1244"><a href="#cb168-1244" aria-hidden="true" tabindex="-1"></a><span class="in">  # Almacenar el AUC del fold externo actual</span></span>
<span id="cb168-1245"><a href="#cb168-1245" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_auc[i_outer] &lt;- auc_fold_externo</span></span>
<span id="cb168-1246"><a href="#cb168-1246" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_accuracy[i_outer] &lt;- accuracy_fold_externo</span></span>
<span id="cb168-1247"><a href="#cb168-1247" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_sensibilidad[i_outer] &lt;- sensibilidad_fold_externo</span></span>
<span id="cb168-1248"><a href="#cb168-1248" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-1249"><a href="#cb168-1249" aria-hidden="true" tabindex="-1"></a><span class="in">  # Predecir en los datos de test para este pliegue externo y almacenar predicciones</span></span>
<span id="cb168-1250"><a href="#cb168-1250" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_test &lt;- predict(modelo_actual, newdata = datos_test_outer, type = "response")</span></span>
<span id="cb168-1251"><a href="#cb168-1251" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_totales[test_indices_outer, i_outer] &lt;- predicciones_test</span></span>
<span id="cb168-1252"><a href="#cb168-1252" aria-hidden="true" tabindex="-1"></a><span class="in">  targets_totales[test_indices_outer] &lt;- as.numeric(datos_test_outer$ESTADO_ACTUAL) - 1</span></span>
<span id="cb168-1253"><a href="#cb168-1253" aria-hidden="true" tabindex="-1"></a><span class="in"> </span></span>
<span id="cb168-1254"><a href="#cb168-1254" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb168-1255"><a href="#cb168-1255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1256"><a href="#cb168-1256" aria-hidden="true" tabindex="-1"></a><span class="in"># Calcular AUC promedio</span></span>
<span id="cb168-1257"><a href="#cb168-1257" aria-hidden="true" tabindex="-1"></a><span class="in">auc_promedio &lt;- mean(resultados_auc)</span></span>
<span id="cb168-1258"><a href="#cb168-1258" aria-hidden="true" tabindex="-1"></a><span class="in">accuracy_promedio &lt;- mean(resultados_accuracy)</span></span>
<span id="cb168-1259"><a href="#cb168-1259" aria-hidden="true" tabindex="-1"></a><span class="in">sensibilidad_promedio &lt;- mean(resultados_sensibilidad)</span></span>
<span id="cb168-1260"><a href="#cb168-1260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1261"><a href="#cb168-1261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1262"><a href="#cb168-1262" aria-hidden="true" tabindex="-1"></a><span class="in"># Crear tabla con todas las métricas</span></span>
<span id="cb168-1263"><a href="#cb168-1263" aria-hidden="true" tabindex="-1"></a><span class="in">tabla_metricas &lt;- data.frame(</span></span>
<span id="cb168-1264"><a href="#cb168-1264" aria-hidden="true" tabindex="-1"></a><span class="in">  Pliegue = 1:k_outer,</span></span>
<span id="cb168-1265"><a href="#cb168-1265" aria-hidden="true" tabindex="-1"></a><span class="in">  AUC = sapply(resultados_auc, round, digits = 3),</span></span>
<span id="cb168-1266"><a href="#cb168-1266" aria-hidden="true" tabindex="-1"></a><span class="in">  Accuracy = sapply(resultados_accuracy, round, digits = 3),</span></span>
<span id="cb168-1267"><a href="#cb168-1267" aria-hidden="true" tabindex="-1"></a><span class="in">  Recall = sapply(resultados_sensibilidad, round, digits = 3)</span></span>
<span id="cb168-1268"><a href="#cb168-1268" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb168-1269"><a href="#cb168-1269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1270"><a href="#cb168-1270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1271"><a href="#cb168-1271" aria-hidden="true" tabindex="-1"></a><span class="in"># Agregar fila con promedio de métricas</span></span>
<span id="cb168-1272"><a href="#cb168-1272" aria-hidden="true" tabindex="-1"></a><span class="in">tabla_metricas_logistic_filter &lt;- rbind(tabla_metricas, c("Mean", round(auc_promedio,3), round(accuracy_promedio,3), round(sensibilidad_promedio,3)))</span></span>
<span id="cb168-1273"><a href="#cb168-1273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1274"><a href="#cb168-1274" aria-hidden="true" tabindex="-1"></a><span class="in">end_time &lt;- Sys.time()</span></span>
<span id="cb168-1275"><a href="#cb168-1275" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time_logistic_filter &lt;- end_time - start_time</span></span>
<span id="cb168-1276"><a href="#cb168-1276" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time_logistic_filter &lt;- as.numeric(execution_time_logistic_filter, units = "secs")</span></span>
<span id="cb168-1277"><a href="#cb168-1277" aria-hidden="true" tabindex="-1"></a><span class="in">cat("Execution time:", execution_time_logistic_filter,  "seconds \n")</span></span>
<span id="cb168-1278"><a href="#cb168-1278" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-1279"><a href="#cb168-1279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1280"><a href="#cb168-1280" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb168-1281"><a href="#cb168-1281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1282"><a href="#cb168-1282" aria-hidden="true" tabindex="-1"></a><span class="fu"># Metrics Table</span></span>
<span id="cb168-1285"><a href="#cb168-1285" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-1286"><a href="#cb168-1286" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir tabla formateada con kableExtra</span></span>
<span id="cb168-1287"><a href="#cb168-1287" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(tabla_metricas_logistic_filter, <span class="at">caption =</span> <span class="st">"Cross Validation Metrics"</span>, <span class="at">align =</span> <span class="st">"c"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb168-1288"><a href="#cb168-1288" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb168-1289"><a href="#cb168-1289" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-1290"><a href="#cb168-1290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1291"><a href="#cb168-1291" aria-hidden="true" tabindex="-1"></a><span class="fu"># Metrics Plot</span></span>
<span id="cb168-1294"><a href="#cb168-1294" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-1295"><a href="#cb168-1295" aria-hidden="true" tabindex="-1"></a><span class="fu">crear_plot_metricas_per_fold</span>(tabla_metricas_logistic_filter)</span>
<span id="cb168-1296"><a href="#cb168-1296" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-1297"><a href="#cb168-1297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1298"><a href="#cb168-1298" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb168-1299"><a href="#cb168-1299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1300"><a href="#cb168-1300" aria-hidden="true" tabindex="-1"></a>Now we have proved the instability of the model. </span>
<span id="cb168-1301"><a href="#cb168-1301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1302"><a href="#cb168-1302" aria-hidden="true" tabindex="-1"></a><span class="fu">## 5x2 Cross Validation Embedded </span></span>
<span id="cb168-1303"><a href="#cb168-1303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1304"><a href="#cb168-1304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1305"><a href="#cb168-1305" aria-hidden="true" tabindex="-1"></a>We are going to select the most important variables with a embedded method.</span>
<span id="cb168-1306"><a href="#cb168-1306" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=FALSE,message=FALSE,eval=FALSE}</span></span>
<span id="cb168-1307"><a href="#cb168-1307" aria-hidden="true" tabindex="-1"></a><span class="in">start_time &lt;- Sys.time()</span></span>
<span id="cb168-1308"><a href="#cb168-1308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1309"><a href="#cb168-1309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1310"><a href="#cb168-1310" aria-hidden="true" tabindex="-1"></a><span class="in"># Configurar la validación cruzada 5x2</span></span>
<span id="cb168-1311"><a href="#cb168-1311" aria-hidden="true" tabindex="-1"></a><span class="in">k_outer &lt;- 5  # Número de pliegues externos</span></span>
<span id="cb168-1312"><a href="#cb168-1312" aria-hidden="true" tabindex="-1"></a><span class="in">k_inner &lt;- 2  # Número de pliegues internos</span></span>
<span id="cb168-1313"><a href="#cb168-1313" aria-hidden="true" tabindex="-1"></a><span class="in">folds_outer &lt;- createFolds(data$ESTADO_ACTUAL, k = k_outer, list = FALSE)  # Obtener índices de pliegues externos</span></span>
<span id="cb168-1314"><a href="#cb168-1314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1315"><a href="#cb168-1315" aria-hidden="true" tabindex="-1"></a><span class="in"># Lista para almacenar resultados</span></span>
<span id="cb168-1316"><a href="#cb168-1316" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_auc &lt;- numeric(k_outer)</span></span>
<span id="cb168-1317"><a href="#cb168-1317" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_sensibilidad &lt;- numeric(k_outer)</span></span>
<span id="cb168-1318"><a href="#cb168-1318" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_accuracy &lt;- numeric(k_outer)</span></span>
<span id="cb168-1319"><a href="#cb168-1319" aria-hidden="true" tabindex="-1"></a><span class="in">indices &lt;- 1:nrow(data)</span></span>
<span id="cb168-1320"><a href="#cb168-1320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1321"><a href="#cb168-1321" aria-hidden="true" tabindex="-1"></a><span class="in"># Inicializar matrices para almacenar predicciones y objetivos</span></span>
<span id="cb168-1322"><a href="#cb168-1322" aria-hidden="true" tabindex="-1"></a><span class="in">predicciones_totales &lt;- matrix(NA, nrow = nrow(data), ncol = k_outer)</span></span>
<span id="cb168-1323"><a href="#cb168-1323" aria-hidden="true" tabindex="-1"></a><span class="in">targets_totales &lt;- numeric(nrow(data))</span></span>
<span id="cb168-1324"><a href="#cb168-1324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1325"><a href="#cb168-1325" aria-hidden="true" tabindex="-1"></a><span class="in"># Iterar sobre cada pliegue externo y realizar el proceso de modelado</span></span>
<span id="cb168-1326"><a href="#cb168-1326" aria-hidden="true" tabindex="-1"></a><span class="in">for (i_outer in 1:k_outer) {</span></span>
<span id="cb168-1327"><a href="#cb168-1327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1328"><a href="#cb168-1328" aria-hidden="true" tabindex="-1"></a><span class="in">  # Obtener los índices para el pliegue externo actual</span></span>
<span id="cb168-1329"><a href="#cb168-1329" aria-hidden="true" tabindex="-1"></a><span class="in">  test_indices_outer &lt;- indices[folds_outer==i_outer]  # Índices correspondientes al pliegue externo de test</span></span>
<span id="cb168-1330"><a href="#cb168-1330" aria-hidden="true" tabindex="-1"></a><span class="in">  train_indices_outer &lt;- setdiff(1:nrow(data), test_indices_outer)  # Índices correspondientes al conjunto de entrenamiento</span></span>
<span id="cb168-1331"><a href="#cb168-1331" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-1332"><a href="#cb168-1332" aria-hidden="true" tabindex="-1"></a><span class="in">  # Dividir datos en entrenamiento y test para el pliegue externo</span></span>
<span id="cb168-1333"><a href="#cb168-1333" aria-hidden="true" tabindex="-1"></a><span class="in">  datos_entrenamiento_outer &lt;- data[train_indices_outer, ]</span></span>
<span id="cb168-1334"><a href="#cb168-1334" aria-hidden="true" tabindex="-1"></a><span class="in">  datos_test_outer &lt;- data[test_indices_outer, ]</span></span>
<span id="cb168-1335"><a href="#cb168-1335" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-1336"><a href="#cb168-1336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1337"><a href="#cb168-1337" aria-hidden="true" tabindex="-1"></a><span class="in">  # Configurar la validación cruzada interna</span></span>
<span id="cb168-1338"><a href="#cb168-1338" aria-hidden="true" tabindex="-1"></a><span class="in">  folds_inner &lt;- createFolds(datos_entrenamiento_outer$ESTADO_ACTUAL, k = k_inner, list = FALSE)  # Obtener índices de pliegues internos</span></span>
<span id="cb168-1339"><a href="#cb168-1339" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-1340"><a href="#cb168-1340" aria-hidden="true" tabindex="-1"></a><span class="in">  # Almacenar predicciones y test para formar una curva ROC general</span></span>
<span id="cb168-1341"><a href="#cb168-1341" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_auc &lt;- numeric(nrow(datos_entrenamiento_outer))</span></span>
<span id="cb168-1342"><a href="#cb168-1342" aria-hidden="true" tabindex="-1"></a><span class="in">  targets_auc &lt;- numeric(nrow(datos_entrenamiento_outer))</span></span>
<span id="cb168-1343"><a href="#cb168-1343" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-1344"><a href="#cb168-1344" aria-hidden="true" tabindex="-1"></a><span class="in">  # Iterar sobre cada pliegue interno para selección de modelo</span></span>
<span id="cb168-1345"><a href="#cb168-1345" aria-hidden="true" tabindex="-1"></a><span class="in">  indices_inner &lt;- 1:nrow(datos_entrenamiento_outer)</span></span>
<span id="cb168-1346"><a href="#cb168-1346" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_auc_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-1347"><a href="#cb168-1347" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_sensibilidad_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-1348"><a href="#cb168-1348" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_accuracy_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-1349"><a href="#cb168-1349" aria-hidden="true" tabindex="-1"></a><span class="in">  for (i_inner in 1:k_inner) {</span></span>
<span id="cb168-1350"><a href="#cb168-1350" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-1351"><a href="#cb168-1351" aria-hidden="true" tabindex="-1"></a><span class="in">    variables_importantes &lt;- seleccionar_variables_importantes(datos_entrenamiento_outer,"ESTADO_ACTUAL",6)</span></span>
<span id="cb168-1352"><a href="#cb168-1352" aria-hidden="true" tabindex="-1"></a><span class="in">    filter_data &lt;- datos_entrenamiento_outer[,c("ESTADO_ACTUAL",variables_importantes)]</span></span>
<span id="cb168-1353"><a href="#cb168-1353" aria-hidden="true" tabindex="-1"></a><span class="in">    ###############################</span></span>
<span id="cb168-1354"><a href="#cb168-1354" aria-hidden="true" tabindex="-1"></a><span class="in">    #### Aqui el filtrado##########</span></span>
<span id="cb168-1355"><a href="#cb168-1355" aria-hidden="true" tabindex="-1"></a><span class="in">    ###############################</span></span>
<span id="cb168-1356"><a href="#cb168-1356" aria-hidden="true" tabindex="-1"></a><span class="in">#con poca variables solo unaa la vez o filtrado o wrapper</span></span>
<span id="cb168-1357"><a href="#cb168-1357" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-1358"><a href="#cb168-1358" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-1359"><a href="#cb168-1359" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-1360"><a href="#cb168-1360" aria-hidden="true" tabindex="-1"></a><span class="in">    # Obtener los índices para el pliegue interno actual</span></span>
<span id="cb168-1361"><a href="#cb168-1361" aria-hidden="true" tabindex="-1"></a><span class="in">    test_indices_inner &lt;- indices_inner[folds_inner==i_inner]  # Índices correspondientes al pliegue interno de test</span></span>
<span id="cb168-1362"><a href="#cb168-1362" aria-hidden="true" tabindex="-1"></a><span class="in">    train_indices_inner &lt;- setdiff(1:nrow(filter_data), test_indices_inner)  # Índices correspondientes al conjunto de entrenamiento interno</span></span>
<span id="cb168-1363"><a href="#cb168-1363" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-1364"><a href="#cb168-1364" aria-hidden="true" tabindex="-1"></a><span class="in">    # Dividir datos en entrenamiento y test para el pliegue interno</span></span>
<span id="cb168-1365"><a href="#cb168-1365" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_entrenamiento_inner &lt;- filter_data[train_indices_inner, ]</span></span>
<span id="cb168-1366"><a href="#cb168-1366" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_validacion &lt;- filter_data[test_indices_inner, ]</span></span>
<span id="cb168-1367"><a href="#cb168-1367" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-1368"><a href="#cb168-1368" aria-hidden="true" tabindex="-1"></a><span class="in"> </span></span>
<span id="cb168-1369"><a href="#cb168-1369" aria-hidden="true" tabindex="-1"></a><span class="in">    # Aplicar oversampling en el conjunto de entrenamiento interno</span></span>
<span id="cb168-1370"><a href="#cb168-1370" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_entrenamiento_oversampled &lt;- ROSE(ESTADO_ACTUAL ~ .,</span></span>
<span id="cb168-1371"><a href="#cb168-1371" aria-hidden="true" tabindex="-1"></a><span class="in">                                            data = datos_entrenamiento_inner,</span></span>
<span id="cb168-1372"><a href="#cb168-1372" aria-hidden="true" tabindex="-1"></a><span class="in">                                            p = 0.28)$data</span></span>
<span id="cb168-1373"><a href="#cb168-1373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1374"><a href="#cb168-1374" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-1375"><a href="#cb168-1375" aria-hidden="true" tabindex="-1"></a><span class="in">    # Ajustar el modelo logístico</span></span>
<span id="cb168-1376"><a href="#cb168-1376" aria-hidden="true" tabindex="-1"></a><span class="in">    modelo_actual &lt;- glm("ESTADO_ACTUAL ~ .", data = datos_entrenamiento_oversampled, family = binomial("logit"))</span></span>
<span id="cb168-1377"><a href="#cb168-1377" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-1378"><a href="#cb168-1378" aria-hidden="true" tabindex="-1"></a><span class="in">    # Predecir y calcular el AUC en los datos de validación</span></span>
<span id="cb168-1379"><a href="#cb168-1379" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_validacion &lt;- predict(modelo_actual, newdata = datos_validacion, type = "response")</span></span>
<span id="cb168-1380"><a href="#cb168-1380" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-1381"><a href="#cb168-1381" aria-hidden="true" tabindex="-1"></a><span class="in">    # Calcular el AUC</span></span>
<span id="cb168-1382"><a href="#cb168-1382" aria-hidden="true" tabindex="-1"></a><span class="in">    auc_actual &lt;- pROC::roc(as.numeric(datos_validacion$ESTADO_ACTUAL) - 1, predicciones_validacion)$auc</span></span>
<span id="cb168-1383"><a href="#cb168-1383" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-1384"><a href="#cb168-1384" aria-hidden="true" tabindex="-1"></a><span class="in">    # Actualizar el mejor AUC y el mejor modelo si es necesario</span></span>
<span id="cb168-1385"><a href="#cb168-1385" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-1386"><a href="#cb168-1386" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-1387"><a href="#cb168-1387" aria-hidden="true" tabindex="-1"></a><span class="in">    # Realizar predicciones en el conjunto de entrenamiento externo para el AUC general</span></span>
<span id="cb168-1388"><a href="#cb168-1388" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_auc[test_indices_inner] &lt;- predict(mejor_modelo_auc, newdata = datos_validacion, type = "response")</span></span>
<span id="cb168-1389"><a href="#cb168-1389" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_clasificadas &lt;- ifelse(predicciones_auc[test_indices_inner] &gt;= 0.5, "SI", "NO")</span></span>
<span id="cb168-1390"><a href="#cb168-1390" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-1391"><a href="#cb168-1391" aria-hidden="true" tabindex="-1"></a><span class="in">    resultados_sensibilidad_inner[i_inner] &lt;- sum(predicciones_clasificadas == "SI" &amp; datos_validacion[["ESTADO_ACTUAL"]] == "SI") / sum(datos_validacion[["ESTADO_ACTUAL"]] == "SI")</span></span>
<span id="cb168-1392"><a href="#cb168-1392" aria-hidden="true" tabindex="-1"></a><span class="in">    resultados_accuracy_inner[i_inner] &lt;- mean(predicciones_clasificadas == datos_validacion[["ESTADO_ACTUAL"]])</span></span>
<span id="cb168-1393"><a href="#cb168-1393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1394"><a href="#cb168-1394" aria-hidden="true" tabindex="-1"></a><span class="in">    targets_auc[test_indices_inner] &lt;- as.numeric(datos_validacion$ESTADO_ACTUAL) - 1</span></span>
<span id="cb168-1395"><a href="#cb168-1395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1396"><a href="#cb168-1396" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb168-1397"><a href="#cb168-1397" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-1398"><a href="#cb168-1398" aria-hidden="true" tabindex="-1"></a><span class="in">  # Calcular el AUC final para este fold externo</span></span>
<span id="cb168-1399"><a href="#cb168-1399" aria-hidden="true" tabindex="-1"></a><span class="in">  auc_fold_externo &lt;- pROC::roc(targets_auc, predicciones_auc)$auc</span></span>
<span id="cb168-1400"><a href="#cb168-1400" aria-hidden="true" tabindex="-1"></a><span class="in">  accuracy_fold_externo &lt;- mean(resultados_accuracy_inner)</span></span>
<span id="cb168-1401"><a href="#cb168-1401" aria-hidden="true" tabindex="-1"></a><span class="in">  sensibilidad_fold_externo &lt;- mean(resultados_sensibilidad_inner)</span></span>
<span id="cb168-1402"><a href="#cb168-1402" aria-hidden="true" tabindex="-1"></a><span class="in"> </span></span>
<span id="cb168-1403"><a href="#cb168-1403" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-1404"><a href="#cb168-1404" aria-hidden="true" tabindex="-1"></a><span class="in">  # Almacenar el AUC del fold externo actual</span></span>
<span id="cb168-1405"><a href="#cb168-1405" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_auc[i_outer] &lt;- auc_fold_externo</span></span>
<span id="cb168-1406"><a href="#cb168-1406" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_accuracy[i_outer] &lt;- accuracy_fold_externo</span></span>
<span id="cb168-1407"><a href="#cb168-1407" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_sensibilidad[i_outer] &lt;- sensibilidad_fold_externo</span></span>
<span id="cb168-1408"><a href="#cb168-1408" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-1409"><a href="#cb168-1409" aria-hidden="true" tabindex="-1"></a><span class="in">  # Predecir en los datos de test para este pliegue externo y almacenar predicciones</span></span>
<span id="cb168-1410"><a href="#cb168-1410" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_test &lt;- predict(mejor_modelo_auc, newdata = datos_test_outer, type = "response")</span></span>
<span id="cb168-1411"><a href="#cb168-1411" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_totales[test_indices_outer, i_outer] &lt;- predicciones_test</span></span>
<span id="cb168-1412"><a href="#cb168-1412" aria-hidden="true" tabindex="-1"></a><span class="in">  targets_totales[test_indices_outer] &lt;- as.numeric(datos_test_outer$ESTADO_ACTUAL) - 1</span></span>
<span id="cb168-1413"><a href="#cb168-1413" aria-hidden="true" tabindex="-1"></a><span class="in"> </span></span>
<span id="cb168-1414"><a href="#cb168-1414" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb168-1415"><a href="#cb168-1415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1416"><a href="#cb168-1416" aria-hidden="true" tabindex="-1"></a><span class="in"># Calcular AUC promedio</span></span>
<span id="cb168-1417"><a href="#cb168-1417" aria-hidden="true" tabindex="-1"></a><span class="in">auc_promedio &lt;- mean(resultados_auc)</span></span>
<span id="cb168-1418"><a href="#cb168-1418" aria-hidden="true" tabindex="-1"></a><span class="in">accuracy_promedio &lt;- mean(resultados_accuracy)</span></span>
<span id="cb168-1419"><a href="#cb168-1419" aria-hidden="true" tabindex="-1"></a><span class="in">sensibilidad_promedio &lt;- mean(resultados_sensibilidad)</span></span>
<span id="cb168-1420"><a href="#cb168-1420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1421"><a href="#cb168-1421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1422"><a href="#cb168-1422" aria-hidden="true" tabindex="-1"></a><span class="in"># Crear tabla con todas las métricas</span></span>
<span id="cb168-1423"><a href="#cb168-1423" aria-hidden="true" tabindex="-1"></a><span class="in">tabla_metricas &lt;- data.frame(</span></span>
<span id="cb168-1424"><a href="#cb168-1424" aria-hidden="true" tabindex="-1"></a><span class="in">  Pliegue = 1:k_outer,</span></span>
<span id="cb168-1425"><a href="#cb168-1425" aria-hidden="true" tabindex="-1"></a><span class="in">  AUC = sapply(resultados_auc, round, digits = 3),</span></span>
<span id="cb168-1426"><a href="#cb168-1426" aria-hidden="true" tabindex="-1"></a><span class="in">  Accuracy = sapply(resultados_accuracy, round, digits = 3),</span></span>
<span id="cb168-1427"><a href="#cb168-1427" aria-hidden="true" tabindex="-1"></a><span class="in">  Recall = sapply(resultados_sensibilidad, round, digits = 3)</span></span>
<span id="cb168-1428"><a href="#cb168-1428" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb168-1429"><a href="#cb168-1429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1430"><a href="#cb168-1430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1431"><a href="#cb168-1431" aria-hidden="true" tabindex="-1"></a><span class="in"># Agregar fila con promedio de métricas</span></span>
<span id="cb168-1432"><a href="#cb168-1432" aria-hidden="true" tabindex="-1"></a><span class="in">tabla_metricas_logistic_embeded &lt;- rbind(tabla_metricas, c("Mean", round(auc_promedio,3), round(accuracy_promedio,3), round(sensibilidad_promedio,3)))</span></span>
<span id="cb168-1433"><a href="#cb168-1433" aria-hidden="true" tabindex="-1"></a><span class="in">save(tabla_metricas_logistic_embeded, file = "tabla_metricas_logistic_embeded.RData")</span></span>
<span id="cb168-1434"><a href="#cb168-1434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1435"><a href="#cb168-1435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1436"><a href="#cb168-1436" aria-hidden="true" tabindex="-1"></a><span class="in">end_time &lt;- Sys.time()</span></span>
<span id="cb168-1437"><a href="#cb168-1437" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time_logistic_embeded &lt;- end_time - start_time</span></span>
<span id="cb168-1438"><a href="#cb168-1438" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time_logistic_embeded &lt;- as.numeric(execution_time_logistic_embeded, units = "secs")</span></span>
<span id="cb168-1439"><a href="#cb168-1439" aria-hidden="true" tabindex="-1"></a><span class="in">save(execution_time_logistic_embeded, file = "execution_time_logistic_embeded.RData")</span></span>
<span id="cb168-1440"><a href="#cb168-1440" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-1441"><a href="#cb168-1441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1444"><a href="#cb168-1444" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-1445"><a href="#cb168-1445" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"tabla_metricas_logistic_embeded.RData"</span>)</span>
<span id="cb168-1446"><a href="#cb168-1446" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"execution_time_logistic_embeded.RData"</span>)</span>
<span id="cb168-1447"><a href="#cb168-1447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1448"><a href="#cb168-1448" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time_logistic_embeded,  <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb168-1449"><a href="#cb168-1449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1450"><a href="#cb168-1450" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-1451"><a href="#cb168-1451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1452"><a href="#cb168-1452" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb168-1453"><a href="#cb168-1453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1454"><a href="#cb168-1454" aria-hidden="true" tabindex="-1"></a><span class="fu"># Metrics Table</span></span>
<span id="cb168-1457"><a href="#cb168-1457" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-1458"><a href="#cb168-1458" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir tabla formateada con kableExtra</span></span>
<span id="cb168-1459"><a href="#cb168-1459" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(tabla_metricas_logistic_embeded, <span class="at">caption =</span> <span class="st">"Cross Validation Metrics"</span>, <span class="at">align =</span> <span class="st">"c"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb168-1460"><a href="#cb168-1460" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb168-1461"><a href="#cb168-1461" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-1462"><a href="#cb168-1462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1463"><a href="#cb168-1463" aria-hidden="true" tabindex="-1"></a><span class="fu"># Metrics Plot</span></span>
<span id="cb168-1466"><a href="#cb168-1466" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-1467"><a href="#cb168-1467" aria-hidden="true" tabindex="-1"></a><span class="fu">crear_plot_metricas_per_fold</span>(tabla_metricas_logistic_embeded)</span>
<span id="cb168-1468"><a href="#cb168-1468" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-1469"><a href="#cb168-1469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1470"><a href="#cb168-1470" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb168-1471"><a href="#cb168-1471" aria-hidden="true" tabindex="-1"></a>The result is worse in this case and the execution time is higher due to the time spent in the variable selection.</span>
<span id="cb168-1472"><a href="#cb168-1472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1473"><a href="#cb168-1473" aria-hidden="true" tabindex="-1"></a><span class="fu">## 5x2 Cross Validation Wrapper</span></span>
<span id="cb168-1474"><a href="#cb168-1474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1475"><a href="#cb168-1475" aria-hidden="true" tabindex="-1"></a>Finally, we are going to honestly measure the performance of the model with bruteforce variable selection.</span>
<span id="cb168-1476"><a href="#cb168-1476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1477"><a href="#cb168-1477" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=FALSE,message=FALSE,eval=FALSE}</span></span>
<span id="cb168-1478"><a href="#cb168-1478" aria-hidden="true" tabindex="-1"></a><span class="in">start_time &lt;- Sys.time()</span></span>
<span id="cb168-1479"><a href="#cb168-1479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1480"><a href="#cb168-1480" aria-hidden="true" tabindex="-1"></a><span class="in"># Establecer la fórmula base para el modelo logístico</span></span>
<span id="cb168-1481"><a href="#cb168-1481" aria-hidden="true" tabindex="-1"></a><span class="in">formula_base &lt;- formula(ESTADO_ACTUAL ~ 1)  # Fórmula inicial sin predictoras</span></span>
<span id="cb168-1482"><a href="#cb168-1482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1483"><a href="#cb168-1483" aria-hidden="true" tabindex="-1"></a><span class="in"># Obtener nombres de variables predictoras</span></span>
<span id="cb168-1484"><a href="#cb168-1484" aria-hidden="true" tabindex="-1"></a><span class="in">variables &lt;- names(data)[-which(names(data) == "ESTADO_ACTUAL")]</span></span>
<span id="cb168-1485"><a href="#cb168-1485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1486"><a href="#cb168-1486" aria-hidden="true" tabindex="-1"></a><span class="in"># Obtener todas las combinaciones posibles de variables predictoras</span></span>
<span id="cb168-1487"><a href="#cb168-1487" aria-hidden="true" tabindex="-1"></a><span class="in">combinaciones_variables &lt;- unlist(lapply(1:length(variables), function(x) combn(variables, x, simplify = FALSE)), recursive = FALSE)</span></span>
<span id="cb168-1488"><a href="#cb168-1488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1489"><a href="#cb168-1489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1490"><a href="#cb168-1490" aria-hidden="true" tabindex="-1"></a><span class="in"># Configurar la validación cruzada 5x2</span></span>
<span id="cb168-1491"><a href="#cb168-1491" aria-hidden="true" tabindex="-1"></a><span class="in">k_outer &lt;- 5  # Número de pliegues externos</span></span>
<span id="cb168-1492"><a href="#cb168-1492" aria-hidden="true" tabindex="-1"></a><span class="in">k_inner &lt;- 2  # Número de pliegues internos</span></span>
<span id="cb168-1493"><a href="#cb168-1493" aria-hidden="true" tabindex="-1"></a><span class="in">folds_outer &lt;- createFolds(data$ESTADO_ACTUAL, k = k_outer, list = FALSE)  # Obtener índices de pliegues externos</span></span>
<span id="cb168-1494"><a href="#cb168-1494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1495"><a href="#cb168-1495" aria-hidden="true" tabindex="-1"></a><span class="in"># Lista para almacenar resultados</span></span>
<span id="cb168-1496"><a href="#cb168-1496" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_auc &lt;- numeric(k_outer)</span></span>
<span id="cb168-1497"><a href="#cb168-1497" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_sensibilidad &lt;- numeric(k_outer)</span></span>
<span id="cb168-1498"><a href="#cb168-1498" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_accuracy &lt;- numeric(k_outer)</span></span>
<span id="cb168-1499"><a href="#cb168-1499" aria-hidden="true" tabindex="-1"></a><span class="in">indices &lt;- 1:nrow(data)</span></span>
<span id="cb168-1500"><a href="#cb168-1500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1501"><a href="#cb168-1501" aria-hidden="true" tabindex="-1"></a><span class="in"># Inicializar matrices para almacenar predicciones y objetivos</span></span>
<span id="cb168-1502"><a href="#cb168-1502" aria-hidden="true" tabindex="-1"></a><span class="in">predicciones_totales &lt;- matrix(NA, nrow = nrow(data), ncol = k_outer)</span></span>
<span id="cb168-1503"><a href="#cb168-1503" aria-hidden="true" tabindex="-1"></a><span class="in">targets_totales &lt;- numeric(nrow(data))</span></span>
<span id="cb168-1504"><a href="#cb168-1504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1505"><a href="#cb168-1505" aria-hidden="true" tabindex="-1"></a><span class="in"># Iterar sobre cada pliegue externo y realizar el proceso de modelado</span></span>
<span id="cb168-1506"><a href="#cb168-1506" aria-hidden="true" tabindex="-1"></a><span class="in">for (i_outer in 1:k_outer) {</span></span>
<span id="cb168-1507"><a href="#cb168-1507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1508"><a href="#cb168-1508" aria-hidden="true" tabindex="-1"></a><span class="in">  # Obtener los índices para el pliegue externo actual</span></span>
<span id="cb168-1509"><a href="#cb168-1509" aria-hidden="true" tabindex="-1"></a><span class="in">  test_indices_outer &lt;- indices[folds_outer==i_outer]  # Índices correspondientes al pliegue externo de test</span></span>
<span id="cb168-1510"><a href="#cb168-1510" aria-hidden="true" tabindex="-1"></a><span class="in">  train_indices_outer &lt;- setdiff(1:nrow(data), test_indices_outer)  # Índices correspondientes al conjunto de entrenamiento</span></span>
<span id="cb168-1511"><a href="#cb168-1511" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-1512"><a href="#cb168-1512" aria-hidden="true" tabindex="-1"></a><span class="in">  # Dividir datos en entrenamiento y test para el pliegue externo</span></span>
<span id="cb168-1513"><a href="#cb168-1513" aria-hidden="true" tabindex="-1"></a><span class="in">  datos_entrenamiento_outer &lt;- data[train_indices_outer, ]</span></span>
<span id="cb168-1514"><a href="#cb168-1514" aria-hidden="true" tabindex="-1"></a><span class="in">  datos_test_outer &lt;- data[test_indices_outer, ]</span></span>
<span id="cb168-1515"><a href="#cb168-1515" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-1516"><a href="#cb168-1516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1517"><a href="#cb168-1517" aria-hidden="true" tabindex="-1"></a><span class="in">  # Configurar la validación cruzada interna</span></span>
<span id="cb168-1518"><a href="#cb168-1518" aria-hidden="true" tabindex="-1"></a><span class="in">  folds_inner &lt;- createFolds(datos_entrenamiento_outer$ESTADO_ACTUAL, k = k_inner, list = FALSE)  # Obtener índices de pliegues internos</span></span>
<span id="cb168-1519"><a href="#cb168-1519" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-1520"><a href="#cb168-1520" aria-hidden="true" tabindex="-1"></a><span class="in">  # Almacenar predicciones y test para formar una curva ROC general</span></span>
<span id="cb168-1521"><a href="#cb168-1521" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_auc &lt;- numeric(nrow(datos_entrenamiento_outer))</span></span>
<span id="cb168-1522"><a href="#cb168-1522" aria-hidden="true" tabindex="-1"></a><span class="in">  targets_auc &lt;- numeric(nrow(datos_entrenamiento_outer))</span></span>
<span id="cb168-1523"><a href="#cb168-1523" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-1524"><a href="#cb168-1524" aria-hidden="true" tabindex="-1"></a><span class="in">  # Iterar sobre cada pliegue interno para selección de modelo</span></span>
<span id="cb168-1525"><a href="#cb168-1525" aria-hidden="true" tabindex="-1"></a><span class="in">  indices_inner &lt;- 1:nrow(datos_entrenamiento_outer)</span></span>
<span id="cb168-1526"><a href="#cb168-1526" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_auc_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-1527"><a href="#cb168-1527" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_sensibilidad_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-1528"><a href="#cb168-1528" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_accuracy_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-1529"><a href="#cb168-1529" aria-hidden="true" tabindex="-1"></a><span class="in">  for (i_inner in 1:k_inner) {</span></span>
<span id="cb168-1530"><a href="#cb168-1530" aria-hidden="true" tabindex="-1"></a><span class="in">    ###############################</span></span>
<span id="cb168-1531"><a href="#cb168-1531" aria-hidden="true" tabindex="-1"></a><span class="in">    #### Aqui el filtrado##########</span></span>
<span id="cb168-1532"><a href="#cb168-1532" aria-hidden="true" tabindex="-1"></a><span class="in">    ###############################</span></span>
<span id="cb168-1533"><a href="#cb168-1533" aria-hidden="true" tabindex="-1"></a><span class="in">#con poca variables solo unaa la vez o filtrado o wrapper</span></span>
<span id="cb168-1534"><a href="#cb168-1534" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-1535"><a href="#cb168-1535" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-1536"><a href="#cb168-1536" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-1537"><a href="#cb168-1537" aria-hidden="true" tabindex="-1"></a><span class="in">    # Obtener los índices para el pliegue interno actual</span></span>
<span id="cb168-1538"><a href="#cb168-1538" aria-hidden="true" tabindex="-1"></a><span class="in">    test_indices_inner &lt;- indices_inner[folds_inner==i_inner]  # Índices correspondientes al pliegue interno de test</span></span>
<span id="cb168-1539"><a href="#cb168-1539" aria-hidden="true" tabindex="-1"></a><span class="in">    train_indices_inner &lt;- setdiff(1:nrow(datos_entrenamiento_outer), test_indices_inner)  # Índices correspondientes al conjunto de entrenamiento interno</span></span>
<span id="cb168-1540"><a href="#cb168-1540" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-1541"><a href="#cb168-1541" aria-hidden="true" tabindex="-1"></a><span class="in">    # Dividir datos en entrenamiento y test para el pliegue interno</span></span>
<span id="cb168-1542"><a href="#cb168-1542" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_entrenamiento_inner &lt;- datos_entrenamiento_outer[train_indices_inner, ]</span></span>
<span id="cb168-1543"><a href="#cb168-1543" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_validacion &lt;- datos_entrenamiento_outer[test_indices_inner, ]</span></span>
<span id="cb168-1544"><a href="#cb168-1544" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-1545"><a href="#cb168-1545" aria-hidden="true" tabindex="-1"></a><span class="in"> </span></span>
<span id="cb168-1546"><a href="#cb168-1546" aria-hidden="true" tabindex="-1"></a><span class="in">    # Aplicar oversampling en el conjunto de entrenamiento interno</span></span>
<span id="cb168-1547"><a href="#cb168-1547" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_entrenamiento_oversampled &lt;- ROSE(ESTADO_ACTUAL ~ .,</span></span>
<span id="cb168-1548"><a href="#cb168-1548" aria-hidden="true" tabindex="-1"></a><span class="in">                                            data = datos_entrenamiento_inner,</span></span>
<span id="cb168-1549"><a href="#cb168-1549" aria-hidden="true" tabindex="-1"></a><span class="in">                                            p = 0.28)$data</span></span>
<span id="cb168-1550"><a href="#cb168-1550" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-1551"><a href="#cb168-1551" aria-hidden="true" tabindex="-1"></a><span class="in">    # Inicializar variables para almacenar el mejor modelo y su métrica asociada</span></span>
<span id="cb168-1552"><a href="#cb168-1552" aria-hidden="true" tabindex="-1"></a><span class="in">    mejor_auc &lt;- 0</span></span>
<span id="cb168-1553"><a href="#cb168-1553" aria-hidden="true" tabindex="-1"></a><span class="in">    mejor_modelo_auc &lt;- NULL</span></span>
<span id="cb168-1554"><a href="#cb168-1554" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-1555"><a href="#cb168-1555" aria-hidden="true" tabindex="-1"></a><span class="in">    # Iterar sobre todas las combinaciones de variables</span></span>
<span id="cb168-1556"><a href="#cb168-1556" aria-hidden="true" tabindex="-1"></a><span class="in">    for (combinacion in combinaciones_variables) {</span></span>
<span id="cb168-1557"><a href="#cb168-1557" aria-hidden="true" tabindex="-1"></a><span class="in">      # Construir la fórmula con las variables actuales</span></span>
<span id="cb168-1558"><a href="#cb168-1558" aria-hidden="true" tabindex="-1"></a><span class="in">      formula_actual &lt;- as.formula(paste("ESTADO_ACTUAL", "~", paste(combinacion, collapse = "+")))</span></span>
<span id="cb168-1559"><a href="#cb168-1559" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb168-1560"><a href="#cb168-1560" aria-hidden="true" tabindex="-1"></a><span class="in">      # Ajustar el modelo logístico</span></span>
<span id="cb168-1561"><a href="#cb168-1561" aria-hidden="true" tabindex="-1"></a><span class="in">      modelo_actual &lt;- glm(formula_actual, data = datos_entrenamiento_oversampled, family = binomial("logit"))</span></span>
<span id="cb168-1562"><a href="#cb168-1562" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb168-1563"><a href="#cb168-1563" aria-hidden="true" tabindex="-1"></a><span class="in">      # Predecir y calcular el AUC en los datos de validación</span></span>
<span id="cb168-1564"><a href="#cb168-1564" aria-hidden="true" tabindex="-1"></a><span class="in">      predicciones_validacion &lt;- predict(modelo_actual, newdata = datos_validacion, type = "response")</span></span>
<span id="cb168-1565"><a href="#cb168-1565" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb168-1566"><a href="#cb168-1566" aria-hidden="true" tabindex="-1"></a><span class="in">      # Calcular el AUC</span></span>
<span id="cb168-1567"><a href="#cb168-1567" aria-hidden="true" tabindex="-1"></a><span class="in">      auc_actual &lt;- pROC::roc(as.numeric(datos_validacion$ESTADO_ACTUAL) - 1, predicciones_validacion)$auc</span></span>
<span id="cb168-1568"><a href="#cb168-1568" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb168-1569"><a href="#cb168-1569" aria-hidden="true" tabindex="-1"></a><span class="in">      # Actualizar el mejor AUC y el mejor modelo si es necesario</span></span>
<span id="cb168-1570"><a href="#cb168-1570" aria-hidden="true" tabindex="-1"></a><span class="in">      if (auc_actual &gt; mejor_auc) {</span></span>
<span id="cb168-1571"><a href="#cb168-1571" aria-hidden="true" tabindex="-1"></a><span class="in">        mejor_auc &lt;- auc_actual</span></span>
<span id="cb168-1572"><a href="#cb168-1572" aria-hidden="true" tabindex="-1"></a><span class="in">        mejor_modelo_auc &lt;- modelo_actual</span></span>
<span id="cb168-1573"><a href="#cb168-1573" aria-hidden="true" tabindex="-1"></a><span class="in">      }</span></span>
<span id="cb168-1574"><a href="#cb168-1574" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb168-1575"><a href="#cb168-1575" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-1576"><a href="#cb168-1576" aria-hidden="true" tabindex="-1"></a><span class="in">    # Realizar predicciones en el conjunto de entrenamiento externo para el AUC general</span></span>
<span id="cb168-1577"><a href="#cb168-1577" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_auc[test_indices_inner] &lt;- predict(mejor_modelo_auc, newdata = datos_validacion, type = "response")</span></span>
<span id="cb168-1578"><a href="#cb168-1578" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_clasificadas &lt;- ifelse(predicciones_auc[test_indices_inner] &gt;= 0.5, "SI", "NO")</span></span>
<span id="cb168-1579"><a href="#cb168-1579" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-1580"><a href="#cb168-1580" aria-hidden="true" tabindex="-1"></a><span class="in">    resultados_sensibilidad_inner[i_inner] &lt;- sum(predicciones_clasificadas == "SI" &amp; datos_validacion[["ESTADO_ACTUAL"]] == "SI") / sum(datos_validacion[["ESTADO_ACTUAL"]] == "SI")</span></span>
<span id="cb168-1581"><a href="#cb168-1581" aria-hidden="true" tabindex="-1"></a><span class="in">    resultados_accuracy_inner[i_inner] &lt;- mean(predicciones_clasificadas == datos_validacion[["ESTADO_ACTUAL"]])</span></span>
<span id="cb168-1582"><a href="#cb168-1582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1583"><a href="#cb168-1583" aria-hidden="true" tabindex="-1"></a><span class="in">    targets_auc[test_indices_inner] &lt;- as.numeric(datos_validacion$ESTADO_ACTUAL) - 1</span></span>
<span id="cb168-1584"><a href="#cb168-1584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1585"><a href="#cb168-1585" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb168-1586"><a href="#cb168-1586" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-1587"><a href="#cb168-1587" aria-hidden="true" tabindex="-1"></a><span class="in">  # Calcular el AUC final para este fold externo</span></span>
<span id="cb168-1588"><a href="#cb168-1588" aria-hidden="true" tabindex="-1"></a><span class="in">  auc_fold_externo &lt;- pROC::roc(targets_auc, predicciones_auc)$auc</span></span>
<span id="cb168-1589"><a href="#cb168-1589" aria-hidden="true" tabindex="-1"></a><span class="in">  accuracy_fold_externo &lt;- mean(resultados_accuracy_inner)</span></span>
<span id="cb168-1590"><a href="#cb168-1590" aria-hidden="true" tabindex="-1"></a><span class="in">  sensibilidad_fold_externo &lt;- mean(resultados_sensibilidad_inner)</span></span>
<span id="cb168-1591"><a href="#cb168-1591" aria-hidden="true" tabindex="-1"></a><span class="in"> </span></span>
<span id="cb168-1592"><a href="#cb168-1592" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-1593"><a href="#cb168-1593" aria-hidden="true" tabindex="-1"></a><span class="in">  # Almacenar el AUC del fold externo actual</span></span>
<span id="cb168-1594"><a href="#cb168-1594" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_auc[i_outer] &lt;- auc_fold_externo</span></span>
<span id="cb168-1595"><a href="#cb168-1595" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_accuracy[i_outer] &lt;- accuracy_fold_externo</span></span>
<span id="cb168-1596"><a href="#cb168-1596" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_sensibilidad[i_outer] &lt;- sensibilidad_fold_externo</span></span>
<span id="cb168-1597"><a href="#cb168-1597" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-1598"><a href="#cb168-1598" aria-hidden="true" tabindex="-1"></a><span class="in">  # Predecir en los datos de test para este pliegue externo y almacenar predicciones</span></span>
<span id="cb168-1599"><a href="#cb168-1599" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_test &lt;- predict(mejor_modelo_auc, newdata = datos_test_outer, type = "response")</span></span>
<span id="cb168-1600"><a href="#cb168-1600" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_totales[test_indices_outer, i_outer] &lt;- predicciones_test</span></span>
<span id="cb168-1601"><a href="#cb168-1601" aria-hidden="true" tabindex="-1"></a><span class="in">  targets_totales[test_indices_outer] &lt;- as.numeric(datos_test_outer$ESTADO_ACTUAL) - 1</span></span>
<span id="cb168-1602"><a href="#cb168-1602" aria-hidden="true" tabindex="-1"></a><span class="in"> </span></span>
<span id="cb168-1603"><a href="#cb168-1603" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb168-1604"><a href="#cb168-1604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1605"><a href="#cb168-1605" aria-hidden="true" tabindex="-1"></a><span class="in"># Calcular AUC promedio</span></span>
<span id="cb168-1606"><a href="#cb168-1606" aria-hidden="true" tabindex="-1"></a><span class="in">auc_promedio &lt;- mean(resultados_auc)</span></span>
<span id="cb168-1607"><a href="#cb168-1607" aria-hidden="true" tabindex="-1"></a><span class="in">accuracy_promedio &lt;- mean(resultados_accuracy)</span></span>
<span id="cb168-1608"><a href="#cb168-1608" aria-hidden="true" tabindex="-1"></a><span class="in">sensibilidad_promedio &lt;- mean(resultados_sensibilidad)</span></span>
<span id="cb168-1609"><a href="#cb168-1609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1610"><a href="#cb168-1610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1611"><a href="#cb168-1611" aria-hidden="true" tabindex="-1"></a><span class="in"># Crear tabla con todas las métricas</span></span>
<span id="cb168-1612"><a href="#cb168-1612" aria-hidden="true" tabindex="-1"></a><span class="in">tabla_metricas &lt;- data.frame(</span></span>
<span id="cb168-1613"><a href="#cb168-1613" aria-hidden="true" tabindex="-1"></a><span class="in">  Pliegue = 1:k_outer,</span></span>
<span id="cb168-1614"><a href="#cb168-1614" aria-hidden="true" tabindex="-1"></a><span class="in">  AUC = sapply(resultados_auc, round, digits = 3),</span></span>
<span id="cb168-1615"><a href="#cb168-1615" aria-hidden="true" tabindex="-1"></a><span class="in">  Accuracy = sapply(resultados_accuracy, round, digits = 3),</span></span>
<span id="cb168-1616"><a href="#cb168-1616" aria-hidden="true" tabindex="-1"></a><span class="in">  Recall = sapply(resultados_sensibilidad, round, digits = 3)</span></span>
<span id="cb168-1617"><a href="#cb168-1617" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb168-1618"><a href="#cb168-1618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1619"><a href="#cb168-1619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1620"><a href="#cb168-1620" aria-hidden="true" tabindex="-1"></a><span class="in"># Agregar fila con promedio de métricas</span></span>
<span id="cb168-1621"><a href="#cb168-1621" aria-hidden="true" tabindex="-1"></a><span class="in">tabla_metricas_logistic_wrapper &lt;- rbind(tabla_metricas, c("Mean", round(auc_promedio,3), round(accuracy_promedio,3), round(sensibilidad_promedio,3)))</span></span>
<span id="cb168-1622"><a href="#cb168-1622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1623"><a href="#cb168-1623" aria-hidden="true" tabindex="-1"></a><span class="in">end_time &lt;- Sys.time()</span></span>
<span id="cb168-1624"><a href="#cb168-1624" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time &lt;- end_time - start_time</span></span>
<span id="cb168-1625"><a href="#cb168-1625" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time_logistic_wrapper &lt;- as.numeric(execution_time, units = "secs")</span></span>
<span id="cb168-1626"><a href="#cb168-1626" aria-hidden="true" tabindex="-1"></a><span class="in">save(tabla_metricas_logistic_wrapper, file = "tabla_metricas_logistic_wrapper.RData")</span></span>
<span id="cb168-1627"><a href="#cb168-1627" aria-hidden="true" tabindex="-1"></a><span class="in">save(execution_time_logistic_wrapper, file = "execution_time_logistic_wrapper.RData")</span></span>
<span id="cb168-1628"><a href="#cb168-1628" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-1629"><a href="#cb168-1629" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1632"><a href="#cb168-1632" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-1633"><a href="#cb168-1633" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"tabla_metricas_logistic_wrapper.RData"</span>)</span>
<span id="cb168-1634"><a href="#cb168-1634" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"execution_time_logistic_wrapper.RData"</span>)</span>
<span id="cb168-1635"><a href="#cb168-1635" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time_logistic_wrapper,  <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb168-1636"><a href="#cb168-1636" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-1637"><a href="#cb168-1637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1638"><a href="#cb168-1638" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb168-1639"><a href="#cb168-1639" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1640"><a href="#cb168-1640" aria-hidden="true" tabindex="-1"></a><span class="fu"># Metrics Table</span></span>
<span id="cb168-1643"><a href="#cb168-1643" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-1644"><a href="#cb168-1644" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir tabla formateada con kableExtra</span></span>
<span id="cb168-1645"><a href="#cb168-1645" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(tabla_metricas_logistic_wrapper, <span class="at">caption =</span> <span class="st">"Cross Validation Metrics"</span>, <span class="at">align =</span> <span class="st">"c"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb168-1646"><a href="#cb168-1646" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb168-1647"><a href="#cb168-1647" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-1648"><a href="#cb168-1648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1649"><a href="#cb168-1649" aria-hidden="true" tabindex="-1"></a><span class="fu"># Metrics Plot</span></span>
<span id="cb168-1652"><a href="#cb168-1652" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-1653"><a href="#cb168-1653" aria-hidden="true" tabindex="-1"></a><span class="fu">crear_plot_metricas_per_fold</span>(tabla_metricas_logistic_wrapper)</span>
<span id="cb168-1654"><a href="#cb168-1654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1655"><a href="#cb168-1655" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-1656"><a href="#cb168-1656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1657"><a href="#cb168-1657" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb168-1658"><a href="#cb168-1658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1659"><a href="#cb168-1659" aria-hidden="true" tabindex="-1"></a>The metrics are definetly accurate but it is too instable for a predictive model deployed in production.</span>
<span id="cb168-1660"><a href="#cb168-1660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1661"><a href="#cb168-1661" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb168-1662"><a href="#cb168-1662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1663"><a href="#cb168-1663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1664"><a href="#cb168-1664" aria-hidden="true" tabindex="-1"></a><span class="fu"># Neural Networks {#neural-networks}</span></span>
<span id="cb168-1665"><a href="#cb168-1665" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1666"><a href="#cb168-1666" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset style="background-color: #f0f0f0;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;"}</span>
<span id="cb168-1667"><a href="#cb168-1667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1668"><a href="#cb168-1668" aria-hidden="true" tabindex="-1"></a><span class="fu">## Hold out</span></span>
<span id="cb168-1669"><a href="#cb168-1669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1670"><a href="#cb168-1670" aria-hidden="true" tabindex="-1"></a>In this section, we are going to build a neural network composed by a hidden layer leaned on nnet library.</span>
<span id="cb168-1671"><a href="#cb168-1671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1672"><a href="#cb168-1672" aria-hidden="true" tabindex="-1"></a>After experimentation, we have noticed that hyperparameters must be hindered to avoid overfitting. High number of iterations or lots of neurons in the hidden layer tends to converge into overfitting.</span>
<span id="cb168-1673"><a href="#cb168-1673" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=FALSE,message=FALSE}</span></span>
<span id="cb168-1674"><a href="#cb168-1674" aria-hidden="true" tabindex="-1"></a><span class="in">start_time &lt;- Sys.time()</span></span>
<span id="cb168-1675"><a href="#cb168-1675" aria-hidden="true" tabindex="-1"></a><span class="in"># Definir la fórmula para el modelo (sustituye "var_pred1 + var_pred2 + ..." con tus variables predictoras)</span></span>
<span id="cb168-1676"><a href="#cb168-1676" aria-hidden="true" tabindex="-1"></a><span class="in">formula &lt;- ESTADO_ACTUAL ~ .</span></span>
<span id="cb168-1677"><a href="#cb168-1677" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1678"><a href="#cb168-1678" aria-hidden="true" tabindex="-1"></a><span class="in"># Dividir el conjunto de datos en entrenamiento y test</span></span>
<span id="cb168-1679"><a href="#cb168-1679" aria-hidden="true" tabindex="-1"></a><span class="in">indices_entrenamiento &lt;- sample(nrow(data), 0.75 * nrow(data))  # 75% para entrenamiento</span></span>
<span id="cb168-1680"><a href="#cb168-1680" aria-hidden="true" tabindex="-1"></a><span class="in">datos_entrenamiento &lt;- data[indices_entrenamiento, ]</span></span>
<span id="cb168-1681"><a href="#cb168-1681" aria-hidden="true" tabindex="-1"></a><span class="in">datos_test &lt;- data[-indices_entrenamiento, ]</span></span>
<span id="cb168-1682"><a href="#cb168-1682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1683"><a href="#cb168-1683" aria-hidden="true" tabindex="-1"></a><span class="in"># Dividir datos de entrenamiento en entrenamiento y validación</span></span>
<span id="cb168-1684"><a href="#cb168-1684" aria-hidden="true" tabindex="-1"></a><span class="in">train_indices &lt;- sample(nrow(datos_entrenamiento), 0.8 * nrow(datos_entrenamiento))  # 80% para entrenamiento</span></span>
<span id="cb168-1685"><a href="#cb168-1685" aria-hidden="true" tabindex="-1"></a><span class="in">datos_entrenamiento_split &lt;- datos_entrenamiento[train_indices, ]</span></span>
<span id="cb168-1686"><a href="#cb168-1686" aria-hidden="true" tabindex="-1"></a><span class="in">datos_validacion &lt;- datos_entrenamiento[-train_indices, ]</span></span>
<span id="cb168-1687"><a href="#cb168-1687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1688"><a href="#cb168-1688" aria-hidden="true" tabindex="-1"></a><span class="in"># Oversampling</span></span>
<span id="cb168-1689"><a href="#cb168-1689" aria-hidden="true" tabindex="-1"></a><span class="in">proportion &lt;- 0.28</span></span>
<span id="cb168-1690"><a href="#cb168-1690" aria-hidden="true" tabindex="-1"></a><span class="in">datos_entrenamiento_oversampled &lt;- ROSE(ESTADO_ACTUAL ~ ., data = datos_entrenamiento_split, p = proportion)$data</span></span>
<span id="cb168-1691"><a href="#cb168-1691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1692"><a href="#cb168-1692" aria-hidden="true" tabindex="-1"></a><span class="in"># Inicializar variables para almacenar los resultados</span></span>
<span id="cb168-1693"><a href="#cb168-1693" aria-hidden="true" tabindex="-1"></a><span class="in">mejor_auc &lt;- 0</span></span>
<span id="cb168-1694"><a href="#cb168-1694" aria-hidden="true" tabindex="-1"></a><span class="in">mejor_modelo &lt;- NULL</span></span>
<span id="cb168-1695"><a href="#cb168-1695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1696"><a href="#cb168-1696" aria-hidden="true" tabindex="-1"></a><span class="in"># Definir combinaciones de hiperparámetros</span></span>
<span id="cb168-1697"><a href="#cb168-1697" aria-hidden="true" tabindex="-1"></a><span class="in">params &lt;- expand.grid(size = c(15), decay = c(0.01,0.5,0.001), maxit = c(225), skip = c(0, 1, 2))</span></span>
<span id="cb168-1698"><a href="#cb168-1698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1699"><a href="#cb168-1699" aria-hidden="true" tabindex="-1"></a><span class="in"># Iterar sobre las combinaciones de hiperparámetros</span></span>
<span id="cb168-1700"><a href="#cb168-1700" aria-hidden="true" tabindex="-1"></a><span class="in">for (param in 1:nrow(params)) {</span></span>
<span id="cb168-1701"><a href="#cb168-1701" aria-hidden="true" tabindex="-1"></a><span class="in">  size &lt;- params$size[param]</span></span>
<span id="cb168-1702"><a href="#cb168-1702" aria-hidden="true" tabindex="-1"></a><span class="in">  decay &lt;- params$decay[param]</span></span>
<span id="cb168-1703"><a href="#cb168-1703" aria-hidden="true" tabindex="-1"></a><span class="in">  maxit &lt;- params$maxit[param]</span></span>
<span id="cb168-1704"><a href="#cb168-1704" aria-hidden="true" tabindex="-1"></a><span class="in">  skip &lt;- params$skip[param]</span></span>
<span id="cb168-1705"><a href="#cb168-1705" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-1706"><a href="#cb168-1706" aria-hidden="true" tabindex="-1"></a><span class="in">  # Entrenar el modelo con la combinación de hiperparámetros actual</span></span>
<span id="cb168-1707"><a href="#cb168-1707" aria-hidden="true" tabindex="-1"></a><span class="in">  modelo &lt;- nnet(formula, data = datos_entrenamiento_oversampled, size = size, decay = decay, maxit = maxit, skip = skip, trace = FALSE)</span></span>
<span id="cb168-1708"><a href="#cb168-1708" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-1709"><a href="#cb168-1709" aria-hidden="true" tabindex="-1"></a><span class="in">  # Realizar predicciones en datos de validación</span></span>
<span id="cb168-1710"><a href="#cb168-1710" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_validacion &lt;- predict(modelo, newdata = datos_validacion, type = "raw")</span></span>
<span id="cb168-1711"><a href="#cb168-1711" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-1712"><a href="#cb168-1712" aria-hidden="true" tabindex="-1"></a><span class="in">  # Calcular AUC para la combinación actual</span></span>
<span id="cb168-1713"><a href="#cb168-1713" aria-hidden="true" tabindex="-1"></a><span class="in">  roc_obj &lt;- roc(ifelse(datos_validacion$ESTADO_ACTUAL == "SI", 1, 0), ifelse(predicciones_validacion == "SI", 1, 0))</span></span>
<span id="cb168-1714"><a href="#cb168-1714" aria-hidden="true" tabindex="-1"></a><span class="in">  auc_actual &lt;- auc(roc_obj)</span></span>
<span id="cb168-1715"><a href="#cb168-1715" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-1716"><a href="#cb168-1716" aria-hidden="true" tabindex="-1"></a><span class="in">  # Actualizar el mejor modelo y su AUC si se encuentra un modelo mejor</span></span>
<span id="cb168-1717"><a href="#cb168-1717" aria-hidden="true" tabindex="-1"></a><span class="in">  if (auc_actual &gt; mejor_auc) {</span></span>
<span id="cb168-1718"><a href="#cb168-1718" aria-hidden="true" tabindex="-1"></a><span class="in">    mejor_auc &lt;- auc_actual</span></span>
<span id="cb168-1719"><a href="#cb168-1719" aria-hidden="true" tabindex="-1"></a><span class="in">    mejor_modelo &lt;- modelo</span></span>
<span id="cb168-1720"><a href="#cb168-1720" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb168-1721"><a href="#cb168-1721" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb168-1722"><a href="#cb168-1722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1723"><a href="#cb168-1723" aria-hidden="true" tabindex="-1"></a><span class="in"># Imprimir el mejor modelo y su AUC</span></span>
<span id="cb168-1724"><a href="#cb168-1724" aria-hidden="true" tabindex="-1"></a><span class="in">print(mejor_modelo)</span></span>
<span id="cb168-1725"><a href="#cb168-1725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1726"><a href="#cb168-1726" aria-hidden="true" tabindex="-1"></a><span class="in">end_time &lt;- Sys.time()</span></span>
<span id="cb168-1727"><a href="#cb168-1727" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time &lt;- end_time - start_time</span></span>
<span id="cb168-1728"><a href="#cb168-1728" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time &lt;- as.numeric(execution_time, units = "secs")</span></span>
<span id="cb168-1729"><a href="#cb168-1729" aria-hidden="true" tabindex="-1"></a><span class="in">cat("Execution time:", execution_time,  "seconds \n")</span></span>
<span id="cb168-1730"><a href="#cb168-1730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1731"><a href="#cb168-1731" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-1732"><a href="#cb168-1732" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb168-1733"><a href="#cb168-1733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1734"><a href="#cb168-1734" aria-hidden="true" tabindex="-1"></a><span class="fu">### Predictions</span></span>
<span id="cb168-1735"><a href="#cb168-1735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1736"><a href="#cb168-1736" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1739"><a href="#cb168-1739" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-1740"><a href="#cb168-1740" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular las predicciones para el conjunto de test</span></span>
<span id="cb168-1741"><a href="#cb168-1741" aria-hidden="true" tabindex="-1"></a>predicciones_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(mejor_modelo, <span class="at">newdata =</span> datos_test, <span class="at">type =</span> <span class="st">"raw"</span>)</span>
<span id="cb168-1742"><a href="#cb168-1742" aria-hidden="true" tabindex="-1"></a>clases_predichas_test <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predicciones_test <span class="sc">&gt;=</span> <span class="fl">0.5</span>, <span class="st">"SI"</span>, <span class="st">"NO"</span>)</span>
<span id="cb168-1743"><a href="#cb168-1743" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1744"><a href="#cb168-1744" aria-hidden="true" tabindex="-1"></a><span class="fu">mostrar_metricas</span>(datos_test<span class="sc">$</span>ESTADO_ACTUAL,clases_predichas_test)</span>
<span id="cb168-1745"><a href="#cb168-1745" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1746"><a href="#cb168-1746" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-1747"><a href="#cb168-1747" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1748"><a href="#cb168-1748" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1749"><a href="#cb168-1749" aria-hidden="true" tabindex="-1"></a><span class="fu">### Roc curve and auc</span></span>
<span id="cb168-1750"><a href="#cb168-1750" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1753"><a href="#cb168-1753" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-1754"><a href="#cb168-1754" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular la curva ROC y el AUC para el conjunto de test</span></span>
<span id="cb168-1755"><a href="#cb168-1755" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_roc_curve</span>(predicciones_test,datos_test<span class="sc">$</span>ESTADO_ACTUAL)</span>
<span id="cb168-1756"><a href="#cb168-1756" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1757"><a href="#cb168-1757" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-1758"><a href="#cb168-1758" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb168-1759"><a href="#cb168-1759" aria-hidden="true" tabindex="-1"></a>The performance is not bad, it can be improved with a vasiable selector method though.</span>
<span id="cb168-1760"><a href="#cb168-1760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1761"><a href="#cb168-1761" aria-hidden="true" tabindex="-1"></a><span class="fu">## 5x2 Cross Validation Filter</span></span>
<span id="cb168-1762"><a href="#cb168-1762" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1763"><a href="#cb168-1763" aria-hidden="true" tabindex="-1"></a>We are going to perform a 5x2 cross validation to ensure the robustness of the model.</span>
<span id="cb168-1764"><a href="#cb168-1764" aria-hidden="true" tabindex="-1"></a>First, we create the outer folds and then we iterate over them to create the inner folds and perform the model selection process.</span>
<span id="cb168-1765"><a href="#cb168-1765" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1766"><a href="#cb168-1766" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1767"><a href="#cb168-1767" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=FALSE,message=FALSE,eval=FALSE}</span></span>
<span id="cb168-1768"><a href="#cb168-1768" aria-hidden="true" tabindex="-1"></a><span class="in">start_time &lt;- Sys.time()</span></span>
<span id="cb168-1769"><a href="#cb168-1769" aria-hidden="true" tabindex="-1"></a><span class="in"># Establecer la fórmula base para el modelo logístico</span></span>
<span id="cb168-1770"><a href="#cb168-1770" aria-hidden="true" tabindex="-1"></a><span class="in">formula_base &lt;- formula(ESTADO_ACTUAL ~ 1)  # Fórmula inicial sin predictoras</span></span>
<span id="cb168-1771"><a href="#cb168-1771" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1772"><a href="#cb168-1772" aria-hidden="true" tabindex="-1"></a><span class="in"># Obtener nombres de variables predictoras</span></span>
<span id="cb168-1773"><a href="#cb168-1773" aria-hidden="true" tabindex="-1"></a><span class="in">variables &lt;- names(data)[-which(names(data) == "ESTADO_ACTUAL")]</span></span>
<span id="cb168-1774"><a href="#cb168-1774" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1775"><a href="#cb168-1775" aria-hidden="true" tabindex="-1"></a><span class="in"># Obtener todas las combinaciones posibles de variables predictoras</span></span>
<span id="cb168-1776"><a href="#cb168-1776" aria-hidden="true" tabindex="-1"></a><span class="in">combinaciones_variables &lt;- unlist(lapply(1:length(variables), function(x) combn(variables, x, simplify = FALSE)), recursive = FALSE)</span></span>
<span id="cb168-1777"><a href="#cb168-1777" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1778"><a href="#cb168-1778" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1779"><a href="#cb168-1779" aria-hidden="true" tabindex="-1"></a><span class="in"># Configurar la validación cruzada 5x2</span></span>
<span id="cb168-1780"><a href="#cb168-1780" aria-hidden="true" tabindex="-1"></a><span class="in">k_outer &lt;- 5  # Número de pliegues externos</span></span>
<span id="cb168-1781"><a href="#cb168-1781" aria-hidden="true" tabindex="-1"></a><span class="in">k_inner &lt;- 2  # Número de pliegues internos</span></span>
<span id="cb168-1782"><a href="#cb168-1782" aria-hidden="true" tabindex="-1"></a><span class="in">folds_outer &lt;- createFolds(data$ESTADO_ACTUAL, k = k_outer, list = FALSE)  # Obtener índices de pliegues externos</span></span>
<span id="cb168-1783"><a href="#cb168-1783" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1784"><a href="#cb168-1784" aria-hidden="true" tabindex="-1"></a><span class="in"># Lista para almacenar resultados</span></span>
<span id="cb168-1785"><a href="#cb168-1785" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_auc &lt;- numeric(k_outer)</span></span>
<span id="cb168-1786"><a href="#cb168-1786" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_sensibilidad &lt;- numeric(k_outer)</span></span>
<span id="cb168-1787"><a href="#cb168-1787" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_accuracy &lt;- numeric(k_outer)</span></span>
<span id="cb168-1788"><a href="#cb168-1788" aria-hidden="true" tabindex="-1"></a><span class="in">indices &lt;- 1:nrow(data)</span></span>
<span id="cb168-1789"><a href="#cb168-1789" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1790"><a href="#cb168-1790" aria-hidden="true" tabindex="-1"></a><span class="in"># Inicializar matrices para almacenar predicciones y objetivos</span></span>
<span id="cb168-1791"><a href="#cb168-1791" aria-hidden="true" tabindex="-1"></a><span class="in">predicciones_totales &lt;- matrix(NA, nrow = nrow(data), ncol = k_outer)</span></span>
<span id="cb168-1792"><a href="#cb168-1792" aria-hidden="true" tabindex="-1"></a><span class="in">targets_totales &lt;- numeric(nrow(data))</span></span>
<span id="cb168-1793"><a href="#cb168-1793" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1794"><a href="#cb168-1794" aria-hidden="true" tabindex="-1"></a><span class="in"># Iterar sobre cada pliegue externo y realizar el proceso de modelado</span></span>
<span id="cb168-1795"><a href="#cb168-1795" aria-hidden="true" tabindex="-1"></a><span class="in">for (i_outer in 1:k_outer) {</span></span>
<span id="cb168-1796"><a href="#cb168-1796" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1797"><a href="#cb168-1797" aria-hidden="true" tabindex="-1"></a><span class="in">  # Obtener los índices para el pliegue externo actual</span></span>
<span id="cb168-1798"><a href="#cb168-1798" aria-hidden="true" tabindex="-1"></a><span class="in">  test_indices_outer &lt;- indices[folds_outer==i_outer]  # Índices correspondientes al pliegue externo de test</span></span>
<span id="cb168-1799"><a href="#cb168-1799" aria-hidden="true" tabindex="-1"></a><span class="in">  train_indices_outer &lt;- setdiff(1:nrow(data), test_indices_outer)  # Índices correspondientes al conjunto de entrenamiento</span></span>
<span id="cb168-1800"><a href="#cb168-1800" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-1801"><a href="#cb168-1801" aria-hidden="true" tabindex="-1"></a><span class="in">  # Dividir datos en entrenamiento y test para el pliegue externo</span></span>
<span id="cb168-1802"><a href="#cb168-1802" aria-hidden="true" tabindex="-1"></a><span class="in">  datos_entrenamiento_outer &lt;- data[train_indices_outer, ]</span></span>
<span id="cb168-1803"><a href="#cb168-1803" aria-hidden="true" tabindex="-1"></a><span class="in">  datos_test_outer &lt;- data[test_indices_outer, ]</span></span>
<span id="cb168-1804"><a href="#cb168-1804" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-1805"><a href="#cb168-1805" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1806"><a href="#cb168-1806" aria-hidden="true" tabindex="-1"></a><span class="in">  # Configurar la validación cruzada interna</span></span>
<span id="cb168-1807"><a href="#cb168-1807" aria-hidden="true" tabindex="-1"></a><span class="in">  folds_inner &lt;- createFolds(datos_entrenamiento_outer$ESTADO_ACTUAL, k = k_inner, list = FALSE)  # Obtener índices de pliegues internos</span></span>
<span id="cb168-1808"><a href="#cb168-1808" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-1809"><a href="#cb168-1809" aria-hidden="true" tabindex="-1"></a><span class="in">  # Almacenar predicciones y test para formar una curva ROC general</span></span>
<span id="cb168-1810"><a href="#cb168-1810" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_auc &lt;- numeric(nrow(datos_entrenamiento_outer))</span></span>
<span id="cb168-1811"><a href="#cb168-1811" aria-hidden="true" tabindex="-1"></a><span class="in">  targets_auc &lt;- numeric(nrow(datos_entrenamiento_outer))</span></span>
<span id="cb168-1812"><a href="#cb168-1812" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-1813"><a href="#cb168-1813" aria-hidden="true" tabindex="-1"></a><span class="in">  # Iterar sobre cada pliegue interno para selección de modelo</span></span>
<span id="cb168-1814"><a href="#cb168-1814" aria-hidden="true" tabindex="-1"></a><span class="in">  indices_inner &lt;- 1:nrow(datos_entrenamiento_outer)</span></span>
<span id="cb168-1815"><a href="#cb168-1815" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_auc_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-1816"><a href="#cb168-1816" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_sensibilidad_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-1817"><a href="#cb168-1817" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_accuracy_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-1818"><a href="#cb168-1818" aria-hidden="true" tabindex="-1"></a><span class="in">  for (i_inner in 1:k_inner) {</span></span>
<span id="cb168-1819"><a href="#cb168-1819" aria-hidden="true" tabindex="-1"></a><span class="in">    ###############################</span></span>
<span id="cb168-1820"><a href="#cb168-1820" aria-hidden="true" tabindex="-1"></a><span class="in">    #### Aqui el filtrado##########</span></span>
<span id="cb168-1821"><a href="#cb168-1821" aria-hidden="true" tabindex="-1"></a><span class="in">    ###############################</span></span>
<span id="cb168-1822"><a href="#cb168-1822" aria-hidden="true" tabindex="-1"></a><span class="in">    filter_data &lt;- filter_dependency(datos_entrenamiento_outer,"ESTADO_ACTUAL",colnames(datos_entrenamiento_outer),0.05)</span></span>
<span id="cb168-1823"><a href="#cb168-1823" aria-hidden="true" tabindex="-1"></a><span class="in">    if ("ESTADO_ACTUAL.1" %in% colnames(filter_data)) {</span></span>
<span id="cb168-1824"><a href="#cb168-1824" aria-hidden="true" tabindex="-1"></a><span class="in">      filter_data &lt;- filter_data[, !colnames(filter_data) %in% "ESTADO_ACTUAL.1", drop = FALSE]</span></span>
<span id="cb168-1825"><a href="#cb168-1825" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb168-1826"><a href="#cb168-1826" aria-hidden="true" tabindex="-1"></a><span class="in">#con poca variables solo unaa la vez o filtrado o wrapper</span></span>
<span id="cb168-1827"><a href="#cb168-1827" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-1828"><a href="#cb168-1828" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-1829"><a href="#cb168-1829" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-1830"><a href="#cb168-1830" aria-hidden="true" tabindex="-1"></a><span class="in">    # Obtener los índices para el pliegue interno actual</span></span>
<span id="cb168-1831"><a href="#cb168-1831" aria-hidden="true" tabindex="-1"></a><span class="in">    test_indices_inner &lt;- indices_inner[folds_inner==i_inner]  # Índices correspondientes al pliegue interno de test</span></span>
<span id="cb168-1832"><a href="#cb168-1832" aria-hidden="true" tabindex="-1"></a><span class="in">    train_indices_inner &lt;- setdiff(1:nrow(datos_entrenamiento_outer), test_indices_inner)  # Índices correspondientes al conjunto de entrenamiento interno</span></span>
<span id="cb168-1833"><a href="#cb168-1833" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-1834"><a href="#cb168-1834" aria-hidden="true" tabindex="-1"></a><span class="in">    # Dividir datos en entrenamiento y test para el pliegue interno</span></span>
<span id="cb168-1835"><a href="#cb168-1835" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_entrenamiento_inner &lt;- datos_entrenamiento_outer[train_indices_inner, ]</span></span>
<span id="cb168-1836"><a href="#cb168-1836" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_validacion &lt;- datos_entrenamiento_outer[test_indices_inner, ]</span></span>
<span id="cb168-1837"><a href="#cb168-1837" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-1838"><a href="#cb168-1838" aria-hidden="true" tabindex="-1"></a><span class="in"> </span></span>
<span id="cb168-1839"><a href="#cb168-1839" aria-hidden="true" tabindex="-1"></a><span class="in">    # Aplicar oversampling en el conjunto de entrenamiento interno</span></span>
<span id="cb168-1840"><a href="#cb168-1840" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_entrenamiento_oversampled &lt;- ROSE(ESTADO_ACTUAL ~ .,</span></span>
<span id="cb168-1841"><a href="#cb168-1841" aria-hidden="true" tabindex="-1"></a><span class="in">                                            data = datos_entrenamiento_inner,</span></span>
<span id="cb168-1842"><a href="#cb168-1842" aria-hidden="true" tabindex="-1"></a><span class="in">                                            p = 0.28)$data</span></span>
<span id="cb168-1843"><a href="#cb168-1843" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-1844"><a href="#cb168-1844" aria-hidden="true" tabindex="-1"></a><span class="in">    # Inicializar variables para almacenar los resultados</span></span>
<span id="cb168-1845"><a href="#cb168-1845" aria-hidden="true" tabindex="-1"></a><span class="in">    mejor_auc &lt;- 0</span></span>
<span id="cb168-1846"><a href="#cb168-1846" aria-hidden="true" tabindex="-1"></a><span class="in">    mejor_modelo &lt;- NULL</span></span>
<span id="cb168-1847"><a href="#cb168-1847" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-1848"><a href="#cb168-1848" aria-hidden="true" tabindex="-1"></a><span class="in">    # Definir combinaciones de hiperparámetros</span></span>
<span id="cb168-1849"><a href="#cb168-1849" aria-hidden="true" tabindex="-1"></a><span class="in">    params &lt;- expand.grid(size = c(15), decay = c(0.01,0.5,0.001), maxit = c(225), skip = c(0, 1, 2))</span></span>
<span id="cb168-1850"><a href="#cb168-1850" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb168-1851"><a href="#cb168-1851" aria-hidden="true" tabindex="-1"></a><span class="in">    # Iterar sobre las combinaciones de hiperparámetros</span></span>
<span id="cb168-1852"><a href="#cb168-1852" aria-hidden="true" tabindex="-1"></a><span class="in">    for (param in 1:nrow(params)) {</span></span>
<span id="cb168-1853"><a href="#cb168-1853" aria-hidden="true" tabindex="-1"></a><span class="in">      size &lt;- params$size[param]</span></span>
<span id="cb168-1854"><a href="#cb168-1854" aria-hidden="true" tabindex="-1"></a><span class="in">      decay &lt;- params$decay[param]</span></span>
<span id="cb168-1855"><a href="#cb168-1855" aria-hidden="true" tabindex="-1"></a><span class="in">      maxit &lt;- params$maxit[param]</span></span>
<span id="cb168-1856"><a href="#cb168-1856" aria-hidden="true" tabindex="-1"></a><span class="in">      skip &lt;- params$skip[param]</span></span>
<span id="cb168-1857"><a href="#cb168-1857" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb168-1858"><a href="#cb168-1858" aria-hidden="true" tabindex="-1"></a><span class="in">      # Entrenar el modelo con la combinación de hiperparámetros actual</span></span>
<span id="cb168-1859"><a href="#cb168-1859" aria-hidden="true" tabindex="-1"></a><span class="in">      modelo &lt;- nnet(formula, data = datos_entrenamiento_oversampled, size = size, decay = decay, maxit = maxit, skip = skip, trace = FALSE)</span></span>
<span id="cb168-1860"><a href="#cb168-1860" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb168-1861"><a href="#cb168-1861" aria-hidden="true" tabindex="-1"></a><span class="in">      # Realizar predicciones en datos de validación</span></span>
<span id="cb168-1862"><a href="#cb168-1862" aria-hidden="true" tabindex="-1"></a><span class="in">      predicciones_validacion &lt;- predict(modelo, newdata = datos_validacion, type = "raw")</span></span>
<span id="cb168-1863"><a href="#cb168-1863" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb168-1864"><a href="#cb168-1864" aria-hidden="true" tabindex="-1"></a><span class="in">      # Calcular AUC para la combinación actual</span></span>
<span id="cb168-1865"><a href="#cb168-1865" aria-hidden="true" tabindex="-1"></a><span class="in">      roc_obj &lt;- roc(ifelse(datos_validacion$ESTADO_ACTUAL == "SI", 1, 0), ifelse(predicciones_validacion == "SI", 1, 0))</span></span>
<span id="cb168-1866"><a href="#cb168-1866" aria-hidden="true" tabindex="-1"></a><span class="in">      auc_actual &lt;- auc(roc_obj)</span></span>
<span id="cb168-1867"><a href="#cb168-1867" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb168-1868"><a href="#cb168-1868" aria-hidden="true" tabindex="-1"></a><span class="in">      # Actualizar el mejor modelo y su AUC si se encuentra un modelo mejor</span></span>
<span id="cb168-1869"><a href="#cb168-1869" aria-hidden="true" tabindex="-1"></a><span class="in">      if (auc_actual &gt; mejor_auc) {</span></span>
<span id="cb168-1870"><a href="#cb168-1870" aria-hidden="true" tabindex="-1"></a><span class="in">        mejor_auc &lt;- auc_actual</span></span>
<span id="cb168-1871"><a href="#cb168-1871" aria-hidden="true" tabindex="-1"></a><span class="in">        mejor_modelo &lt;- modelo</span></span>
<span id="cb168-1872"><a href="#cb168-1872" aria-hidden="true" tabindex="-1"></a><span class="in">      }</span></span>
<span id="cb168-1873"><a href="#cb168-1873" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb168-1874"><a href="#cb168-1874" aria-hidden="true" tabindex="-1"></a><span class="in">    ########################</span></span>
<span id="cb168-1875"><a href="#cb168-1875" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_test &lt;- predict(mejor_modelo, newdata = datos_validacion, type = "raw")</span></span>
<span id="cb168-1876"><a href="#cb168-1876" aria-hidden="true" tabindex="-1"></a><span class="in">    clases_predichas_test &lt;- ifelse(predicciones_test &gt;= 0.5, "SI", "NO")</span></span>
<span id="cb168-1877"><a href="#cb168-1877" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-1878"><a href="#cb168-1878" aria-hidden="true" tabindex="-1"></a><span class="in">    ###########################</span></span>
<span id="cb168-1879"><a href="#cb168-1879" aria-hidden="true" tabindex="-1"></a><span class="in">    # Realizar predicciones en el conjunto de entrenamiento externo para el AUC general</span></span>
<span id="cb168-1880"><a href="#cb168-1880" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_auc[test_indices_inner] &lt;- predict(mejor_modelo_auc, newdata = datos_validacion, type = "response")</span></span>
<span id="cb168-1881"><a href="#cb168-1881" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_clasificadas &lt;- ifelse(predicciones_auc[test_indices_inner] &gt;= 0.5, "SI", "NO")</span></span>
<span id="cb168-1882"><a href="#cb168-1882" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-1883"><a href="#cb168-1883" aria-hidden="true" tabindex="-1"></a><span class="in">    resultados_sensibilidad_inner[i_inner] &lt;- sum(clases_predichas_test == "SI" &amp; datos_validacion[["ESTADO_ACTUAL"]] == "SI") / sum(datos_validacion[["ESTADO_ACTUAL"]] == "SI")</span></span>
<span id="cb168-1884"><a href="#cb168-1884" aria-hidden="true" tabindex="-1"></a><span class="in">    resultados_accuracy_inner[i_inner] &lt;- mean(clases_predichas_test == datos_validacion[["ESTADO_ACTUAL"]])</span></span>
<span id="cb168-1885"><a href="#cb168-1885" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1886"><a href="#cb168-1886" aria-hidden="true" tabindex="-1"></a><span class="in">    targets_auc[test_indices_inner] &lt;- as.numeric(datos_validacion$ESTADO_ACTUAL) - 1</span></span>
<span id="cb168-1887"><a href="#cb168-1887" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1888"><a href="#cb168-1888" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb168-1889"><a href="#cb168-1889" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-1890"><a href="#cb168-1890" aria-hidden="true" tabindex="-1"></a><span class="in">  # Calcular el AUC final para este fold externo</span></span>
<span id="cb168-1891"><a href="#cb168-1891" aria-hidden="true" tabindex="-1"></a><span class="in">  auc_fold_externo &lt;- pROC::roc(targets_auc, predicciones_auc)$auc</span></span>
<span id="cb168-1892"><a href="#cb168-1892" aria-hidden="true" tabindex="-1"></a><span class="in">  accuracy_fold_externo &lt;- mean(resultados_accuracy_inner)</span></span>
<span id="cb168-1893"><a href="#cb168-1893" aria-hidden="true" tabindex="-1"></a><span class="in">  sensibilidad_fold_externo &lt;- mean(resultados_sensibilidad_inner)</span></span>
<span id="cb168-1894"><a href="#cb168-1894" aria-hidden="true" tabindex="-1"></a><span class="in"> </span></span>
<span id="cb168-1895"><a href="#cb168-1895" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-1896"><a href="#cb168-1896" aria-hidden="true" tabindex="-1"></a><span class="in">  # Almacenar el AUC del fold externo actual</span></span>
<span id="cb168-1897"><a href="#cb168-1897" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_auc[i_outer] &lt;- auc_fold_externo</span></span>
<span id="cb168-1898"><a href="#cb168-1898" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_accuracy[i_outer] &lt;- accuracy_fold_externo</span></span>
<span id="cb168-1899"><a href="#cb168-1899" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_sensibilidad[i_outer] &lt;- sensibilidad_fold_externo</span></span>
<span id="cb168-1900"><a href="#cb168-1900" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-1901"><a href="#cb168-1901" aria-hidden="true" tabindex="-1"></a><span class="in">  # Predecir en los datos de test para este pliegue externo y almacenar predicciones</span></span>
<span id="cb168-1902"><a href="#cb168-1902" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_test &lt;- predict(mejor_modelo_auc, newdata = datos_test_outer, type = "response")</span></span>
<span id="cb168-1903"><a href="#cb168-1903" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_totales[test_indices_outer, i_outer] &lt;- predicciones_test</span></span>
<span id="cb168-1904"><a href="#cb168-1904" aria-hidden="true" tabindex="-1"></a><span class="in">  targets_totales[test_indices_outer] &lt;- as.numeric(datos_test_outer$ESTADO_ACTUAL) - 1</span></span>
<span id="cb168-1905"><a href="#cb168-1905" aria-hidden="true" tabindex="-1"></a><span class="in"> </span></span>
<span id="cb168-1906"><a href="#cb168-1906" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb168-1907"><a href="#cb168-1907" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1908"><a href="#cb168-1908" aria-hidden="true" tabindex="-1"></a><span class="in"># Calcular AUC promedio</span></span>
<span id="cb168-1909"><a href="#cb168-1909" aria-hidden="true" tabindex="-1"></a><span class="in">auc_promedio &lt;- mean(resultados_auc)</span></span>
<span id="cb168-1910"><a href="#cb168-1910" aria-hidden="true" tabindex="-1"></a><span class="in">accuracy_promedio &lt;- mean(resultados_accuracy)</span></span>
<span id="cb168-1911"><a href="#cb168-1911" aria-hidden="true" tabindex="-1"></a><span class="in">sensibilidad_promedio &lt;- mean(resultados_sensibilidad)</span></span>
<span id="cb168-1912"><a href="#cb168-1912" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1913"><a href="#cb168-1913" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1914"><a href="#cb168-1914" aria-hidden="true" tabindex="-1"></a><span class="in"># Crear tabla con todas las métricas</span></span>
<span id="cb168-1915"><a href="#cb168-1915" aria-hidden="true" tabindex="-1"></a><span class="in">tabla_metricas &lt;- data.frame(</span></span>
<span id="cb168-1916"><a href="#cb168-1916" aria-hidden="true" tabindex="-1"></a><span class="in">  Pliegue = 1:k_outer,</span></span>
<span id="cb168-1917"><a href="#cb168-1917" aria-hidden="true" tabindex="-1"></a><span class="in">  AUC = sapply(resultados_auc, round, digits = 3),</span></span>
<span id="cb168-1918"><a href="#cb168-1918" aria-hidden="true" tabindex="-1"></a><span class="in">  Accuracy = sapply(resultados_accuracy, round, digits = 3),</span></span>
<span id="cb168-1919"><a href="#cb168-1919" aria-hidden="true" tabindex="-1"></a><span class="in">  Recall = sapply(resultados_sensibilidad, round, digits = 3)</span></span>
<span id="cb168-1920"><a href="#cb168-1920" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb168-1921"><a href="#cb168-1921" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1922"><a href="#cb168-1922" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1923"><a href="#cb168-1923" aria-hidden="true" tabindex="-1"></a><span class="in"># Agregar fila con promedio de métricas</span></span>
<span id="cb168-1924"><a href="#cb168-1924" aria-hidden="true" tabindex="-1"></a><span class="in">tabla_metricas_nnet_filter &lt;- rbind(tabla_metricas, c("Mean", round(auc_promedio,3), round(accuracy_promedio,3), round(sensibilidad_promedio,3)))</span></span>
<span id="cb168-1925"><a href="#cb168-1925" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1926"><a href="#cb168-1926" aria-hidden="true" tabindex="-1"></a><span class="in">end_time &lt;- Sys.time()</span></span>
<span id="cb168-1927"><a href="#cb168-1927" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time_nnet_filter &lt;- end_time - start_time</span></span>
<span id="cb168-1928"><a href="#cb168-1928" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time_nnet_filter &lt;- as.numeric(execution_time_nnet_filter, units = "secs")</span></span>
<span id="cb168-1929"><a href="#cb168-1929" aria-hidden="true" tabindex="-1"></a><span class="in">save(tabla_metricas_nnet_filter, file = "tabla_metricas_nnet_filter.RData")</span></span>
<span id="cb168-1930"><a href="#cb168-1930" aria-hidden="true" tabindex="-1"></a><span class="in">save(execution_time_nnet_filter, file = "execution_time_nnet_filter.RData")</span></span>
<span id="cb168-1931"><a href="#cb168-1931" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-1932"><a href="#cb168-1932" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1935"><a href="#cb168-1935" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-1936"><a href="#cb168-1936" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"tabla_metricas_nnet_filter.RData"</span>)</span>
<span id="cb168-1937"><a href="#cb168-1937" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"execution_time_nnet_filter.RData"</span>)</span>
<span id="cb168-1938"><a href="#cb168-1938" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time_nnet_filter,  <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb168-1939"><a href="#cb168-1939" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-1940"><a href="#cb168-1940" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1941"><a href="#cb168-1941" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1942"><a href="#cb168-1942" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb168-1943"><a href="#cb168-1943" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1944"><a href="#cb168-1944" aria-hidden="true" tabindex="-1"></a><span class="fu"># Metrics Table</span></span>
<span id="cb168-1947"><a href="#cb168-1947" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-1948"><a href="#cb168-1948" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir tabla formateada con kableExtra</span></span>
<span id="cb168-1949"><a href="#cb168-1949" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(tabla_metricas_nnet_filter, <span class="at">caption =</span> <span class="st">"Cross Validation Metrics"</span>, <span class="at">align =</span> <span class="st">"c"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb168-1950"><a href="#cb168-1950" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb168-1951"><a href="#cb168-1951" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-1952"><a href="#cb168-1952" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1953"><a href="#cb168-1953" aria-hidden="true" tabindex="-1"></a><span class="fu"># Metrics Plot</span></span>
<span id="cb168-1956"><a href="#cb168-1956" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-1957"><a href="#cb168-1957" aria-hidden="true" tabindex="-1"></a><span class="fu">crear_plot_metricas_per_fold</span>(tabla_metricas_nnet_filter)</span>
<span id="cb168-1958"><a href="#cb168-1958" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-1959"><a href="#cb168-1959" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1960"><a href="#cb168-1960" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb168-1961"><a href="#cb168-1961" aria-hidden="true" tabindex="-1"></a>The algorith is much more stable than the previous one.</span>
<span id="cb168-1962"><a href="#cb168-1962" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1963"><a href="#cb168-1963" aria-hidden="true" tabindex="-1"></a><span class="fu">## 5x2 Cross Validation Embedded</span></span>
<span id="cb168-1964"><a href="#cb168-1964" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1965"><a href="#cb168-1965" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1966"><a href="#cb168-1966" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=FALSE,message=FALSE, eval=FALSE}</span></span>
<span id="cb168-1967"><a href="#cb168-1967" aria-hidden="true" tabindex="-1"></a><span class="in">start_time &lt;- Sys.time()</span></span>
<span id="cb168-1968"><a href="#cb168-1968" aria-hidden="true" tabindex="-1"></a><span class="in"># Establecer la fórmula base para el modelo logístico</span></span>
<span id="cb168-1969"><a href="#cb168-1969" aria-hidden="true" tabindex="-1"></a><span class="in">formula_base &lt;- formula(ESTADO_ACTUAL ~ 1)  # Fórmula inicial sin predictoras</span></span>
<span id="cb168-1970"><a href="#cb168-1970" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1971"><a href="#cb168-1971" aria-hidden="true" tabindex="-1"></a><span class="in"># Obtener nombres de variables predictoras</span></span>
<span id="cb168-1972"><a href="#cb168-1972" aria-hidden="true" tabindex="-1"></a><span class="in">variables &lt;- names(data)[-which(names(data) == "ESTADO_ACTUAL")]</span></span>
<span id="cb168-1973"><a href="#cb168-1973" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1974"><a href="#cb168-1974" aria-hidden="true" tabindex="-1"></a><span class="in"># Obtener todas las combinaciones posibles de variables predictoras</span></span>
<span id="cb168-1975"><a href="#cb168-1975" aria-hidden="true" tabindex="-1"></a><span class="in">combinaciones_variables &lt;- unlist(lapply(1:length(variables), function(x) combn(variables, x, simplify = FALSE)), recursive = FALSE)</span></span>
<span id="cb168-1976"><a href="#cb168-1976" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1977"><a href="#cb168-1977" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1978"><a href="#cb168-1978" aria-hidden="true" tabindex="-1"></a><span class="in"># Configurar la validación cruzada 5x2</span></span>
<span id="cb168-1979"><a href="#cb168-1979" aria-hidden="true" tabindex="-1"></a><span class="in">k_outer &lt;- 5  # Número de pliegues externos</span></span>
<span id="cb168-1980"><a href="#cb168-1980" aria-hidden="true" tabindex="-1"></a><span class="in">k_inner &lt;- 2  # Número de pliegues internos</span></span>
<span id="cb168-1981"><a href="#cb168-1981" aria-hidden="true" tabindex="-1"></a><span class="in">folds_outer &lt;- createFolds(data$ESTADO_ACTUAL, k = k_outer, list = FALSE)  # Obtener índices de pliegues externos</span></span>
<span id="cb168-1982"><a href="#cb168-1982" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1983"><a href="#cb168-1983" aria-hidden="true" tabindex="-1"></a><span class="in"># Lista para almacenar resultados</span></span>
<span id="cb168-1984"><a href="#cb168-1984" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_auc &lt;- numeric(k_outer)</span></span>
<span id="cb168-1985"><a href="#cb168-1985" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_sensibilidad &lt;- numeric(k_outer)</span></span>
<span id="cb168-1986"><a href="#cb168-1986" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_accuracy &lt;- numeric(k_outer)</span></span>
<span id="cb168-1987"><a href="#cb168-1987" aria-hidden="true" tabindex="-1"></a><span class="in">indices &lt;- 1:nrow(data)</span></span>
<span id="cb168-1988"><a href="#cb168-1988" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1989"><a href="#cb168-1989" aria-hidden="true" tabindex="-1"></a><span class="in"># Inicializar matrices para almacenar predicciones y objetivos</span></span>
<span id="cb168-1990"><a href="#cb168-1990" aria-hidden="true" tabindex="-1"></a><span class="in">predicciones_totales &lt;- matrix(NA, nrow = nrow(data), ncol = k_outer)</span></span>
<span id="cb168-1991"><a href="#cb168-1991" aria-hidden="true" tabindex="-1"></a><span class="in">targets_totales &lt;- numeric(nrow(data))</span></span>
<span id="cb168-1992"><a href="#cb168-1992" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1993"><a href="#cb168-1993" aria-hidden="true" tabindex="-1"></a><span class="in"># Iterar sobre cada pliegue externo y realizar el proceso de modelado</span></span>
<span id="cb168-1994"><a href="#cb168-1994" aria-hidden="true" tabindex="-1"></a><span class="in">for (i_outer in 1:k_outer) {</span></span>
<span id="cb168-1995"><a href="#cb168-1995" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-1996"><a href="#cb168-1996" aria-hidden="true" tabindex="-1"></a><span class="in">  # Obtener los índices para el pliegue externo actual</span></span>
<span id="cb168-1997"><a href="#cb168-1997" aria-hidden="true" tabindex="-1"></a><span class="in">  test_indices_outer &lt;- indices[folds_outer==i_outer]  # Índices correspondientes al pliegue externo de test</span></span>
<span id="cb168-1998"><a href="#cb168-1998" aria-hidden="true" tabindex="-1"></a><span class="in">  train_indices_outer &lt;- setdiff(1:nrow(data), test_indices_outer)  # Índices correspondientes al conjunto de entrenamiento</span></span>
<span id="cb168-1999"><a href="#cb168-1999" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-2000"><a href="#cb168-2000" aria-hidden="true" tabindex="-1"></a><span class="in">  # Dividir datos en entrenamiento y test para el pliegue externo</span></span>
<span id="cb168-2001"><a href="#cb168-2001" aria-hidden="true" tabindex="-1"></a><span class="in">  datos_entrenamiento_outer &lt;- data[train_indices_outer, ]</span></span>
<span id="cb168-2002"><a href="#cb168-2002" aria-hidden="true" tabindex="-1"></a><span class="in">  datos_test_outer &lt;- data[test_indices_outer, ]</span></span>
<span id="cb168-2003"><a href="#cb168-2003" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-2004"><a href="#cb168-2004" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2005"><a href="#cb168-2005" aria-hidden="true" tabindex="-1"></a><span class="in">  # Configurar la validación cruzada interna</span></span>
<span id="cb168-2006"><a href="#cb168-2006" aria-hidden="true" tabindex="-1"></a><span class="in">  folds_inner &lt;- createFolds(datos_entrenamiento_outer$ESTADO_ACTUAL, k = k_inner, list = FALSE)  # Obtener índices de pliegues internos</span></span>
<span id="cb168-2007"><a href="#cb168-2007" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-2008"><a href="#cb168-2008" aria-hidden="true" tabindex="-1"></a><span class="in">  # Almacenar predicciones y test para formar una curva ROC general</span></span>
<span id="cb168-2009"><a href="#cb168-2009" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_auc &lt;- numeric(nrow(datos_entrenamiento_outer))</span></span>
<span id="cb168-2010"><a href="#cb168-2010" aria-hidden="true" tabindex="-1"></a><span class="in">  targets_auc &lt;- numeric(nrow(datos_entrenamiento_outer))</span></span>
<span id="cb168-2011"><a href="#cb168-2011" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-2012"><a href="#cb168-2012" aria-hidden="true" tabindex="-1"></a><span class="in">  # Iterar sobre cada pliegue interno para selección de modelo</span></span>
<span id="cb168-2013"><a href="#cb168-2013" aria-hidden="true" tabindex="-1"></a><span class="in">  indices_inner &lt;- 1:nrow(datos_entrenamiento_outer)</span></span>
<span id="cb168-2014"><a href="#cb168-2014" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_auc_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-2015"><a href="#cb168-2015" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_sensibilidad_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-2016"><a href="#cb168-2016" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_accuracy_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-2017"><a href="#cb168-2017" aria-hidden="true" tabindex="-1"></a><span class="in">  for (i_inner in 1:k_inner) {</span></span>
<span id="cb168-2018"><a href="#cb168-2018" aria-hidden="true" tabindex="-1"></a><span class="in">    ###############################</span></span>
<span id="cb168-2019"><a href="#cb168-2019" aria-hidden="true" tabindex="-1"></a><span class="in">    #### Aqui el filtrado##########</span></span>
<span id="cb168-2020"><a href="#cb168-2020" aria-hidden="true" tabindex="-1"></a><span class="in">    ###############################</span></span>
<span id="cb168-2021"><a href="#cb168-2021" aria-hidden="true" tabindex="-1"></a><span class="in">      variables_importantes &lt;- seleccionar_variables_importantes(datos_entrenamiento_outer,"ESTADO_ACTUAL",6)</span></span>
<span id="cb168-2022"><a href="#cb168-2022" aria-hidden="true" tabindex="-1"></a><span class="in">    filter_data &lt;- datos_entrenamiento_outer[,c("ESTADO_ACTUAL",variables_importantes)]</span></span>
<span id="cb168-2023"><a href="#cb168-2023" aria-hidden="true" tabindex="-1"></a><span class="in">    # Obtener los índices para el pliegue interno actual</span></span>
<span id="cb168-2024"><a href="#cb168-2024" aria-hidden="true" tabindex="-1"></a><span class="in">    test_indices_inner &lt;- indices_inner[folds_inner==i_inner]  # Índices correspondientes al pliegue interno de test</span></span>
<span id="cb168-2025"><a href="#cb168-2025" aria-hidden="true" tabindex="-1"></a><span class="in">    train_indices_inner &lt;- setdiff(1:nrow(filter_data), test_indices_inner)  # Índices correspondientes al conjunto de entrenamiento interno</span></span>
<span id="cb168-2026"><a href="#cb168-2026" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-2027"><a href="#cb168-2027" aria-hidden="true" tabindex="-1"></a><span class="in">    # Dividir datos en entrenamiento y test para el pliegue interno</span></span>
<span id="cb168-2028"><a href="#cb168-2028" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_entrenamiento_inner &lt;- filter_data[train_indices_inner, ]</span></span>
<span id="cb168-2029"><a href="#cb168-2029" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_validacion &lt;- filter_data[test_indices_inner, ]</span></span>
<span id="cb168-2030"><a href="#cb168-2030" aria-hidden="true" tabindex="-1"></a><span class="in"> </span></span>
<span id="cb168-2031"><a href="#cb168-2031" aria-hidden="true" tabindex="-1"></a><span class="in">    # Aplicar oversampling en el conjunto de entrenamiento interno</span></span>
<span id="cb168-2032"><a href="#cb168-2032" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_entrenamiento_oversampled &lt;- ROSE(ESTADO_ACTUAL ~ .,</span></span>
<span id="cb168-2033"><a href="#cb168-2033" aria-hidden="true" tabindex="-1"></a><span class="in">                                            data = datos_entrenamiento_inner,</span></span>
<span id="cb168-2034"><a href="#cb168-2034" aria-hidden="true" tabindex="-1"></a><span class="in">                                            p = 0.28)$data</span></span>
<span id="cb168-2035"><a href="#cb168-2035" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-2036"><a href="#cb168-2036" aria-hidden="true" tabindex="-1"></a><span class="in">    # Inicializar variables para almacenar los resultados</span></span>
<span id="cb168-2037"><a href="#cb168-2037" aria-hidden="true" tabindex="-1"></a><span class="in">    mejor_auc &lt;- 0</span></span>
<span id="cb168-2038"><a href="#cb168-2038" aria-hidden="true" tabindex="-1"></a><span class="in">    mejor_modelo &lt;- NULL</span></span>
<span id="cb168-2039"><a href="#cb168-2039" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-2040"><a href="#cb168-2040" aria-hidden="true" tabindex="-1"></a><span class="in">    # Definir combinaciones de hiperparámetros</span></span>
<span id="cb168-2041"><a href="#cb168-2041" aria-hidden="true" tabindex="-1"></a><span class="in">    params &lt;- expand.grid(size = c(15), decay = c(0.01,0.5,0.001), maxit = c(225), skip = c(0, 1, 2))</span></span>
<span id="cb168-2042"><a href="#cb168-2042" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb168-2043"><a href="#cb168-2043" aria-hidden="true" tabindex="-1"></a><span class="in">    # Iterar sobre las combinaciones de hiperparámetros</span></span>
<span id="cb168-2044"><a href="#cb168-2044" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2045"><a href="#cb168-2045" aria-hidden="true" tabindex="-1"></a><span class="in">    for (param in 1:nrow(params)) {</span></span>
<span id="cb168-2046"><a href="#cb168-2046" aria-hidden="true" tabindex="-1"></a><span class="in">      size &lt;- params$size[param]</span></span>
<span id="cb168-2047"><a href="#cb168-2047" aria-hidden="true" tabindex="-1"></a><span class="in">      decay &lt;- params$decay[param]</span></span>
<span id="cb168-2048"><a href="#cb168-2048" aria-hidden="true" tabindex="-1"></a><span class="in">      maxit &lt;- params$maxit[param]</span></span>
<span id="cb168-2049"><a href="#cb168-2049" aria-hidden="true" tabindex="-1"></a><span class="in">      skip &lt;- params$skip[param]</span></span>
<span id="cb168-2050"><a href="#cb168-2050" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb168-2051"><a href="#cb168-2051" aria-hidden="true" tabindex="-1"></a><span class="in">      # Entrenar el modelo con la combinación de hiperparámetros actual</span></span>
<span id="cb168-2052"><a href="#cb168-2052" aria-hidden="true" tabindex="-1"></a><span class="in">      modelo &lt;- nnet(formula, data = datos_entrenamiento_oversampled, size = size, decay = decay, maxit = maxit, skip = skip, trace = FALSE)</span></span>
<span id="cb168-2053"><a href="#cb168-2053" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb168-2054"><a href="#cb168-2054" aria-hidden="true" tabindex="-1"></a><span class="in">      # Realizar predicciones en datos de validación</span></span>
<span id="cb168-2055"><a href="#cb168-2055" aria-hidden="true" tabindex="-1"></a><span class="in">      predicciones_validacion &lt;- predict(modelo, newdata = datos_validacion, type = "raw")</span></span>
<span id="cb168-2056"><a href="#cb168-2056" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb168-2057"><a href="#cb168-2057" aria-hidden="true" tabindex="-1"></a><span class="in">      # Calcular AUC para la combinación actual</span></span>
<span id="cb168-2058"><a href="#cb168-2058" aria-hidden="true" tabindex="-1"></a><span class="in">      roc_obj &lt;- roc(ifelse(datos_validacion$ESTADO_ACTUAL == "SI", 1, 0), ifelse(predicciones_validacion == "SI", 1, 0))</span></span>
<span id="cb168-2059"><a href="#cb168-2059" aria-hidden="true" tabindex="-1"></a><span class="in">      auc_actual &lt;- auc(roc_obj)</span></span>
<span id="cb168-2060"><a href="#cb168-2060" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb168-2061"><a href="#cb168-2061" aria-hidden="true" tabindex="-1"></a><span class="in">      # Actualizar el mejor modelo y su AUC si se encuentra un modelo mejor</span></span>
<span id="cb168-2062"><a href="#cb168-2062" aria-hidden="true" tabindex="-1"></a><span class="in">      if (auc_actual &gt; mejor_auc) {</span></span>
<span id="cb168-2063"><a href="#cb168-2063" aria-hidden="true" tabindex="-1"></a><span class="in">        mejor_auc &lt;- auc_actual</span></span>
<span id="cb168-2064"><a href="#cb168-2064" aria-hidden="true" tabindex="-1"></a><span class="in">        mejor_modelo &lt;- modelo</span></span>
<span id="cb168-2065"><a href="#cb168-2065" aria-hidden="true" tabindex="-1"></a><span class="in">      }</span></span>
<span id="cb168-2066"><a href="#cb168-2066" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb168-2067"><a href="#cb168-2067" aria-hidden="true" tabindex="-1"></a><span class="in">     </span></span>
<span id="cb168-2068"><a href="#cb168-2068" aria-hidden="true" tabindex="-1"></a><span class="in">    ########################</span></span>
<span id="cb168-2069"><a href="#cb168-2069" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_test &lt;- predict(mejor_modelo, newdata = datos_validacion, type = "raw")</span></span>
<span id="cb168-2070"><a href="#cb168-2070" aria-hidden="true" tabindex="-1"></a><span class="in">    clases_predichas_test &lt;- ifelse(predicciones_test &gt;= 0.5, "SI", "NO")</span></span>
<span id="cb168-2071"><a href="#cb168-2071" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-2072"><a href="#cb168-2072" aria-hidden="true" tabindex="-1"></a><span class="in">    ###########################</span></span>
<span id="cb168-2073"><a href="#cb168-2073" aria-hidden="true" tabindex="-1"></a><span class="in">    # Realizar predicciones en el conjunto de entrenamiento externo para el AUC general</span></span>
<span id="cb168-2074"><a href="#cb168-2074" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_auc[test_indices_inner] &lt;- predict(mejor_modelo_auc, newdata = datos_validacion, type = "response")</span></span>
<span id="cb168-2075"><a href="#cb168-2075" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_clasificadas &lt;- ifelse(predicciones_auc[test_indices_inner] &gt;= 0.5, "SI", "NO")</span></span>
<span id="cb168-2076"><a href="#cb168-2076" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-2077"><a href="#cb168-2077" aria-hidden="true" tabindex="-1"></a><span class="in">    resultados_sensibilidad_inner[i_inner] &lt;- sum(clases_predichas_test == "SI" &amp; datos_validacion[["ESTADO_ACTUAL"]] == "SI") / sum(datos_validacion[["ESTADO_ACTUAL"]] == "SI")</span></span>
<span id="cb168-2078"><a href="#cb168-2078" aria-hidden="true" tabindex="-1"></a><span class="in">    resultados_accuracy_inner[i_inner] &lt;- mean(clases_predichas_test == datos_validacion[["ESTADO_ACTUAL"]])</span></span>
<span id="cb168-2079"><a href="#cb168-2079" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2080"><a href="#cb168-2080" aria-hidden="true" tabindex="-1"></a><span class="in">    targets_auc[test_indices_inner] &lt;- as.numeric(datos_validacion$ESTADO_ACTUAL) - 1</span></span>
<span id="cb168-2081"><a href="#cb168-2081" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2082"><a href="#cb168-2082" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb168-2083"><a href="#cb168-2083" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-2084"><a href="#cb168-2084" aria-hidden="true" tabindex="-1"></a><span class="in">  # Calcular el AUC final para este fold externo</span></span>
<span id="cb168-2085"><a href="#cb168-2085" aria-hidden="true" tabindex="-1"></a><span class="in">  auc_fold_externo &lt;- pROC::roc(targets_auc, predicciones_auc)$auc</span></span>
<span id="cb168-2086"><a href="#cb168-2086" aria-hidden="true" tabindex="-1"></a><span class="in">  accuracy_fold_externo &lt;- mean(resultados_accuracy_inner)</span></span>
<span id="cb168-2087"><a href="#cb168-2087" aria-hidden="true" tabindex="-1"></a><span class="in">  sensibilidad_fold_externo &lt;- mean(resultados_sensibilidad_inner)</span></span>
<span id="cb168-2088"><a href="#cb168-2088" aria-hidden="true" tabindex="-1"></a><span class="in"> </span></span>
<span id="cb168-2089"><a href="#cb168-2089" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-2090"><a href="#cb168-2090" aria-hidden="true" tabindex="-1"></a><span class="in">  # Almacenar el AUC del fold externo actual</span></span>
<span id="cb168-2091"><a href="#cb168-2091" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_auc[i_outer] &lt;- auc_fold_externo</span></span>
<span id="cb168-2092"><a href="#cb168-2092" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_accuracy[i_outer] &lt;- accuracy_fold_externo</span></span>
<span id="cb168-2093"><a href="#cb168-2093" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_sensibilidad[i_outer] &lt;- sensibilidad_fold_externo</span></span>
<span id="cb168-2094"><a href="#cb168-2094" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-2095"><a href="#cb168-2095" aria-hidden="true" tabindex="-1"></a><span class="in">  # Predecir en los datos de test para este pliegue externo y almacenar predicciones</span></span>
<span id="cb168-2096"><a href="#cb168-2096" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_test &lt;- predict(mejor_modelo_auc, newdata = datos_test_outer, type = "response")</span></span>
<span id="cb168-2097"><a href="#cb168-2097" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_totales[test_indices_outer, i_outer] &lt;- predicciones_test</span></span>
<span id="cb168-2098"><a href="#cb168-2098" aria-hidden="true" tabindex="-1"></a><span class="in">  targets_totales[test_indices_outer] &lt;- as.numeric(datos_test_outer$ESTADO_ACTUAL) - 1</span></span>
<span id="cb168-2099"><a href="#cb168-2099" aria-hidden="true" tabindex="-1"></a><span class="in"> </span></span>
<span id="cb168-2100"><a href="#cb168-2100" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb168-2101"><a href="#cb168-2101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2102"><a href="#cb168-2102" aria-hidden="true" tabindex="-1"></a><span class="in"># Calcular AUC promedio</span></span>
<span id="cb168-2103"><a href="#cb168-2103" aria-hidden="true" tabindex="-1"></a><span class="in">auc_promedio &lt;- mean(resultados_auc)</span></span>
<span id="cb168-2104"><a href="#cb168-2104" aria-hidden="true" tabindex="-1"></a><span class="in">accuracy_promedio &lt;- mean(resultados_accuracy)</span></span>
<span id="cb168-2105"><a href="#cb168-2105" aria-hidden="true" tabindex="-1"></a><span class="in">sensibilidad_promedio &lt;- mean(resultados_sensibilidad)</span></span>
<span id="cb168-2106"><a href="#cb168-2106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2107"><a href="#cb168-2107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2108"><a href="#cb168-2108" aria-hidden="true" tabindex="-1"></a><span class="in"># Crear tabla con todas las métricas</span></span>
<span id="cb168-2109"><a href="#cb168-2109" aria-hidden="true" tabindex="-1"></a><span class="in">tabla_metricas &lt;- data.frame(</span></span>
<span id="cb168-2110"><a href="#cb168-2110" aria-hidden="true" tabindex="-1"></a><span class="in">  Pliegue = 1:k_outer,</span></span>
<span id="cb168-2111"><a href="#cb168-2111" aria-hidden="true" tabindex="-1"></a><span class="in">  AUC = sapply(resultados_auc, round, digits = 3),</span></span>
<span id="cb168-2112"><a href="#cb168-2112" aria-hidden="true" tabindex="-1"></a><span class="in">  Accuracy = sapply(resultados_accuracy, round, digits = 3),</span></span>
<span id="cb168-2113"><a href="#cb168-2113" aria-hidden="true" tabindex="-1"></a><span class="in">  Recall = sapply(resultados_sensibilidad, round, digits = 3)</span></span>
<span id="cb168-2114"><a href="#cb168-2114" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb168-2115"><a href="#cb168-2115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2116"><a href="#cb168-2116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2117"><a href="#cb168-2117" aria-hidden="true" tabindex="-1"></a><span class="in"># Agregar fila con promedio de métricas</span></span>
<span id="cb168-2118"><a href="#cb168-2118" aria-hidden="true" tabindex="-1"></a><span class="in">tabla_metricas_nnet_embeded &lt;- rbind(tabla_metricas, c("Mean", round(auc_promedio,3), round(accuracy_promedio,3), round(sensibilidad_promedio,3)))</span></span>
<span id="cb168-2119"><a href="#cb168-2119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2120"><a href="#cb168-2120" aria-hidden="true" tabindex="-1"></a><span class="in">end_time &lt;- Sys.time()</span></span>
<span id="cb168-2121"><a href="#cb168-2121" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time_nnet_embeded &lt;- end_time - start_time</span></span>
<span id="cb168-2122"><a href="#cb168-2122" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time_nnet_embeded &lt;- as.numeric(execution_time_nnet_embeded, units = "secs")</span></span>
<span id="cb168-2123"><a href="#cb168-2123" aria-hidden="true" tabindex="-1"></a><span class="in">save(tabla_metricas_nnet_embeded, file = "tabla_metricas_nnet_embeded.RData")</span></span>
<span id="cb168-2124"><a href="#cb168-2124" aria-hidden="true" tabindex="-1"></a><span class="in">save(execution_time_nnet_embeded, file = "execution_time_nnet_embeded.RData")</span></span>
<span id="cb168-2125"><a href="#cb168-2125" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-2126"><a href="#cb168-2126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2129"><a href="#cb168-2129" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-2130"><a href="#cb168-2130" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"tabla_metricas_nnet_embeded.RData"</span>)</span>
<span id="cb168-2131"><a href="#cb168-2131" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"execution_time_nnet_embeded.RData"</span>)</span>
<span id="cb168-2132"><a href="#cb168-2132" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time_nnet_embeded,  <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb168-2133"><a href="#cb168-2133" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-2134"><a href="#cb168-2134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2135"><a href="#cb168-2135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2136"><a href="#cb168-2136" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb168-2137"><a href="#cb168-2137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2138"><a href="#cb168-2138" aria-hidden="true" tabindex="-1"></a><span class="fu"># Metrics Table</span></span>
<span id="cb168-2141"><a href="#cb168-2141" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-2142"><a href="#cb168-2142" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir tabla formateada con kableExtra</span></span>
<span id="cb168-2143"><a href="#cb168-2143" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(tabla_metricas_nnet_embeded, <span class="at">caption =</span> <span class="st">"Cross Validation Metrics"</span>, <span class="at">align =</span> <span class="st">"c"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb168-2144"><a href="#cb168-2144" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb168-2145"><a href="#cb168-2145" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-2146"><a href="#cb168-2146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2147"><a href="#cb168-2147" aria-hidden="true" tabindex="-1"></a><span class="fu"># Metrics Plot</span></span>
<span id="cb168-2150"><a href="#cb168-2150" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-2151"><a href="#cb168-2151" aria-hidden="true" tabindex="-1"></a><span class="fu">crear_plot_metricas_per_fold</span>(tabla_metricas_nnet_embeded)</span>
<span id="cb168-2152"><a href="#cb168-2152" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-2153"><a href="#cb168-2153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2154"><a href="#cb168-2154" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb168-2155"><a href="#cb168-2155" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb168-2156"><a href="#cb168-2156" aria-hidden="true" tabindex="-1"></a>It seems that there are not a lot of redundant variables, so it works better with more variables.</span>
<span id="cb168-2157"><a href="#cb168-2157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2158"><a href="#cb168-2158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2159"><a href="#cb168-2159" aria-hidden="true" tabindex="-1"></a><span class="fu">## 5x2 Cross Validation Wrapper</span></span>
<span id="cb168-2160"><a href="#cb168-2160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2161"><a href="#cb168-2161" aria-hidden="true" tabindex="-1"></a>Specially in this case, it is important to limit the hyperparameters due to the high computational cost of the wrapper method.</span>
<span id="cb168-2162"><a href="#cb168-2162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2163"><a href="#cb168-2163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2164"><a href="#cb168-2164" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=FALSE,message=FALSE, eval=FALSE}</span></span>
<span id="cb168-2165"><a href="#cb168-2165" aria-hidden="true" tabindex="-1"></a><span class="in">start_time &lt;- Sys.time()</span></span>
<span id="cb168-2166"><a href="#cb168-2166" aria-hidden="true" tabindex="-1"></a><span class="in"># Establecer la fórmula base para el modelo logístico</span></span>
<span id="cb168-2167"><a href="#cb168-2167" aria-hidden="true" tabindex="-1"></a><span class="in">formula_base &lt;- formula(ESTADO_ACTUAL ~ 1)  # Fórmula inicial sin predictoras</span></span>
<span id="cb168-2168"><a href="#cb168-2168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2169"><a href="#cb168-2169" aria-hidden="true" tabindex="-1"></a><span class="in"># Obtener nombres de variables predictoras</span></span>
<span id="cb168-2170"><a href="#cb168-2170" aria-hidden="true" tabindex="-1"></a><span class="in">variables &lt;- names(data)[-which(names(data) == "ESTADO_ACTUAL")]</span></span>
<span id="cb168-2171"><a href="#cb168-2171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2172"><a href="#cb168-2172" aria-hidden="true" tabindex="-1"></a><span class="in"># Obtener todas las combinaciones posibles de variables predictoras</span></span>
<span id="cb168-2173"><a href="#cb168-2173" aria-hidden="true" tabindex="-1"></a><span class="in">combinaciones_variables &lt;- unlist(lapply(1:length(variables), function(x) combn(variables, x, simplify = FALSE)), recursive = FALSE)</span></span>
<span id="cb168-2174"><a href="#cb168-2174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2175"><a href="#cb168-2175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2176"><a href="#cb168-2176" aria-hidden="true" tabindex="-1"></a><span class="in"># Configurar la validación cruzada 5x2</span></span>
<span id="cb168-2177"><a href="#cb168-2177" aria-hidden="true" tabindex="-1"></a><span class="in">k_outer &lt;- 5  # Número de pliegues externos</span></span>
<span id="cb168-2178"><a href="#cb168-2178" aria-hidden="true" tabindex="-1"></a><span class="in">k_inner &lt;- 2  # Número de pliegues internos</span></span>
<span id="cb168-2179"><a href="#cb168-2179" aria-hidden="true" tabindex="-1"></a><span class="in">folds_outer &lt;- createFolds(data$ESTADO_ACTUAL, k = k_outer, list = FALSE)  # Obtener índices de pliegues externos</span></span>
<span id="cb168-2180"><a href="#cb168-2180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2181"><a href="#cb168-2181" aria-hidden="true" tabindex="-1"></a><span class="in"># Lista para almacenar resultados</span></span>
<span id="cb168-2182"><a href="#cb168-2182" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_auc &lt;- numeric(k_outer)</span></span>
<span id="cb168-2183"><a href="#cb168-2183" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_sensibilidad &lt;- numeric(k_outer)</span></span>
<span id="cb168-2184"><a href="#cb168-2184" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_accuracy &lt;- numeric(k_outer)</span></span>
<span id="cb168-2185"><a href="#cb168-2185" aria-hidden="true" tabindex="-1"></a><span class="in">indices &lt;- 1:nrow(data)</span></span>
<span id="cb168-2186"><a href="#cb168-2186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2187"><a href="#cb168-2187" aria-hidden="true" tabindex="-1"></a><span class="in"># Inicializar matrices para almacenar predicciones y objetivos</span></span>
<span id="cb168-2188"><a href="#cb168-2188" aria-hidden="true" tabindex="-1"></a><span class="in">predicciones_totales &lt;- matrix(NA, nrow = nrow(data), ncol = k_outer)</span></span>
<span id="cb168-2189"><a href="#cb168-2189" aria-hidden="true" tabindex="-1"></a><span class="in">targets_totales &lt;- numeric(nrow(data))</span></span>
<span id="cb168-2190"><a href="#cb168-2190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2191"><a href="#cb168-2191" aria-hidden="true" tabindex="-1"></a><span class="in"># Iterar sobre cada pliegue externo y realizar el proceso de modelado</span></span>
<span id="cb168-2192"><a href="#cb168-2192" aria-hidden="true" tabindex="-1"></a><span class="in">for (i_outer in 1:k_outer) {</span></span>
<span id="cb168-2193"><a href="#cb168-2193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2194"><a href="#cb168-2194" aria-hidden="true" tabindex="-1"></a><span class="in">  # Obtener los índices para el pliegue externo actual</span></span>
<span id="cb168-2195"><a href="#cb168-2195" aria-hidden="true" tabindex="-1"></a><span class="in">  test_indices_outer &lt;- indices[folds_outer==i_outer]  # Índices correspondientes al pliegue externo de test</span></span>
<span id="cb168-2196"><a href="#cb168-2196" aria-hidden="true" tabindex="-1"></a><span class="in">  train_indices_outer &lt;- setdiff(1:nrow(data), test_indices_outer)  # Índices correspondientes al conjunto de entrenamiento</span></span>
<span id="cb168-2197"><a href="#cb168-2197" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-2198"><a href="#cb168-2198" aria-hidden="true" tabindex="-1"></a><span class="in">  # Dividir datos en entrenamiento y test para el pliegue externo</span></span>
<span id="cb168-2199"><a href="#cb168-2199" aria-hidden="true" tabindex="-1"></a><span class="in">  datos_entrenamiento_outer &lt;- data[train_indices_outer, ]</span></span>
<span id="cb168-2200"><a href="#cb168-2200" aria-hidden="true" tabindex="-1"></a><span class="in">  datos_test_outer &lt;- data[test_indices_outer, ]</span></span>
<span id="cb168-2201"><a href="#cb168-2201" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-2202"><a href="#cb168-2202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2203"><a href="#cb168-2203" aria-hidden="true" tabindex="-1"></a><span class="in">  # Configurar la validación cruzada interna</span></span>
<span id="cb168-2204"><a href="#cb168-2204" aria-hidden="true" tabindex="-1"></a><span class="in">  folds_inner &lt;- createFolds(datos_entrenamiento_outer$ESTADO_ACTUAL, k = k_inner, list = FALSE)  # Obtener índices de pliegues internos</span></span>
<span id="cb168-2205"><a href="#cb168-2205" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-2206"><a href="#cb168-2206" aria-hidden="true" tabindex="-1"></a><span class="in">  # Almacenar predicciones y test para formar una curva ROC general</span></span>
<span id="cb168-2207"><a href="#cb168-2207" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_auc &lt;- numeric(nrow(datos_entrenamiento_outer))</span></span>
<span id="cb168-2208"><a href="#cb168-2208" aria-hidden="true" tabindex="-1"></a><span class="in">  targets_auc &lt;- numeric(nrow(datos_entrenamiento_outer))</span></span>
<span id="cb168-2209"><a href="#cb168-2209" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-2210"><a href="#cb168-2210" aria-hidden="true" tabindex="-1"></a><span class="in">  # Iterar sobre cada pliegue interno para selección de modelo</span></span>
<span id="cb168-2211"><a href="#cb168-2211" aria-hidden="true" tabindex="-1"></a><span class="in">  indices_inner &lt;- 1:nrow(datos_entrenamiento_outer)</span></span>
<span id="cb168-2212"><a href="#cb168-2212" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_auc_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-2213"><a href="#cb168-2213" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_sensibilidad_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-2214"><a href="#cb168-2214" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_accuracy_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-2215"><a href="#cb168-2215" aria-hidden="true" tabindex="-1"></a><span class="in">  for (i_inner in 1:k_inner) {</span></span>
<span id="cb168-2216"><a href="#cb168-2216" aria-hidden="true" tabindex="-1"></a><span class="in">   ###############################</span></span>
<span id="cb168-2217"><a href="#cb168-2217" aria-hidden="true" tabindex="-1"></a><span class="in">    #### Aqui el filtrado##########</span></span>
<span id="cb168-2218"><a href="#cb168-2218" aria-hidden="true" tabindex="-1"></a><span class="in">    ###############################</span></span>
<span id="cb168-2219"><a href="#cb168-2219" aria-hidden="true" tabindex="-1"></a><span class="in">#con poca variables solo unaa la vez o filtrado o wrapper</span></span>
<span id="cb168-2220"><a href="#cb168-2220" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-2221"><a href="#cb168-2221" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-2222"><a href="#cb168-2222" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-2223"><a href="#cb168-2223" aria-hidden="true" tabindex="-1"></a><span class="in">    # Obtener los índices para el pliegue interno actual</span></span>
<span id="cb168-2224"><a href="#cb168-2224" aria-hidden="true" tabindex="-1"></a><span class="in">    test_indices_inner &lt;- indices_inner[folds_inner==i_inner]  # Índices correspondientes al pliegue interno de test</span></span>
<span id="cb168-2225"><a href="#cb168-2225" aria-hidden="true" tabindex="-1"></a><span class="in">    train_indices_inner &lt;- setdiff(1:nrow(datos_entrenamiento_outer), test_indices_inner)  # Índices correspondientes al conjunto de entrenamiento interno</span></span>
<span id="cb168-2226"><a href="#cb168-2226" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-2227"><a href="#cb168-2227" aria-hidden="true" tabindex="-1"></a><span class="in">    # Dividir datos en entrenamiento y test para el pliegue interno</span></span>
<span id="cb168-2228"><a href="#cb168-2228" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_entrenamiento_inner &lt;- datos_entrenamiento_outer[train_indices_inner, ]</span></span>
<span id="cb168-2229"><a href="#cb168-2229" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_validacion &lt;- datos_entrenamiento_outer[test_indices_inner, ]</span></span>
<span id="cb168-2230"><a href="#cb168-2230" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-2231"><a href="#cb168-2231" aria-hidden="true" tabindex="-1"></a><span class="in"> </span></span>
<span id="cb168-2232"><a href="#cb168-2232" aria-hidden="true" tabindex="-1"></a><span class="in">    # Aplicar oversampling en el conjunto de entrenamiento interno</span></span>
<span id="cb168-2233"><a href="#cb168-2233" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_entrenamiento_oversampled &lt;- ROSE(ESTADO_ACTUAL ~ .,</span></span>
<span id="cb168-2234"><a href="#cb168-2234" aria-hidden="true" tabindex="-1"></a><span class="in">                                            data = datos_entrenamiento_inner,</span></span>
<span id="cb168-2235"><a href="#cb168-2235" aria-hidden="true" tabindex="-1"></a><span class="in">                                            p = 0.28)$data</span></span>
<span id="cb168-2236"><a href="#cb168-2236" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-2237"><a href="#cb168-2237" aria-hidden="true" tabindex="-1"></a><span class="in">    # Inicializar variables para almacenar los resultados</span></span>
<span id="cb168-2238"><a href="#cb168-2238" aria-hidden="true" tabindex="-1"></a><span class="in">    mejor_auc &lt;- 0</span></span>
<span id="cb168-2239"><a href="#cb168-2239" aria-hidden="true" tabindex="-1"></a><span class="in">    mejor_modelo &lt;- NULL</span></span>
<span id="cb168-2240"><a href="#cb168-2240" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-2241"><a href="#cb168-2241" aria-hidden="true" tabindex="-1"></a><span class="in">    # Definir combinaciones de hiperparámetros</span></span>
<span id="cb168-2242"><a href="#cb168-2242" aria-hidden="true" tabindex="-1"></a><span class="in">    params &lt;- expand.grid(size = c(15), decay = c(0.01,0.5,0.001), maxit = c(225), skip = c(0, 1, 2))</span></span>
<span id="cb168-2243"><a href="#cb168-2243" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-2244"><a href="#cb168-2244" aria-hidden="true" tabindex="-1"></a><span class="in">    for (combinacion in combinaciones_variables) {</span></span>
<span id="cb168-2245"><a href="#cb168-2245" aria-hidden="true" tabindex="-1"></a><span class="in">      # Construir la fórmula con las variables actuales</span></span>
<span id="cb168-2246"><a href="#cb168-2246" aria-hidden="true" tabindex="-1"></a><span class="in">      formula_actual &lt;- as.formula(paste("ESTADO_ACTUAL", "~", paste(combinacion, collapse = "+")))</span></span>
<span id="cb168-2247"><a href="#cb168-2247" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-2248"><a href="#cb168-2248" aria-hidden="true" tabindex="-1"></a><span class="in">      # Iterar sobre las combinaciones de hiperparámetros</span></span>
<span id="cb168-2249"><a href="#cb168-2249" aria-hidden="true" tabindex="-1"></a><span class="in">      for (param in 1:nrow(params)) {</span></span>
<span id="cb168-2250"><a href="#cb168-2250" aria-hidden="true" tabindex="-1"></a><span class="in">        size &lt;- params$size[param]</span></span>
<span id="cb168-2251"><a href="#cb168-2251" aria-hidden="true" tabindex="-1"></a><span class="in">        decay &lt;- params$decay[param]</span></span>
<span id="cb168-2252"><a href="#cb168-2252" aria-hidden="true" tabindex="-1"></a><span class="in">        maxit &lt;- params$maxit[param]</span></span>
<span id="cb168-2253"><a href="#cb168-2253" aria-hidden="true" tabindex="-1"></a><span class="in">        skip &lt;- params$skip[param]</span></span>
<span id="cb168-2254"><a href="#cb168-2254" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb168-2255"><a href="#cb168-2255" aria-hidden="true" tabindex="-1"></a><span class="in">        # Entrenar el modelo con la combinación de hiperparámetros actual</span></span>
<span id="cb168-2256"><a href="#cb168-2256" aria-hidden="true" tabindex="-1"></a><span class="in">        modelo &lt;- nnet(formula, data = datos_entrenamiento_oversampled, size = size, decay = decay, maxit = maxit, skip = skip, trace = FALSE)</span></span>
<span id="cb168-2257"><a href="#cb168-2257" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb168-2258"><a href="#cb168-2258" aria-hidden="true" tabindex="-1"></a><span class="in">        # Realizar predicciones en datos de validación</span></span>
<span id="cb168-2259"><a href="#cb168-2259" aria-hidden="true" tabindex="-1"></a><span class="in">        predicciones_validacion &lt;- predict(modelo, newdata = datos_validacion, type = "raw")</span></span>
<span id="cb168-2260"><a href="#cb168-2260" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb168-2261"><a href="#cb168-2261" aria-hidden="true" tabindex="-1"></a><span class="in">        # Calcular AUC para la combinación actual</span></span>
<span id="cb168-2262"><a href="#cb168-2262" aria-hidden="true" tabindex="-1"></a><span class="in">        roc_obj &lt;- roc(ifelse(datos_validacion$ESTADO_ACTUAL == "SI", 1, 0), ifelse(predicciones_validacion == "SI", 1, 0))</span></span>
<span id="cb168-2263"><a href="#cb168-2263" aria-hidden="true" tabindex="-1"></a><span class="in">        auc_actual &lt;- auc(roc_obj)</span></span>
<span id="cb168-2264"><a href="#cb168-2264" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb168-2265"><a href="#cb168-2265" aria-hidden="true" tabindex="-1"></a><span class="in">        # Actualizar el mejor modelo y su AUC si se encuentra un modelo mejor</span></span>
<span id="cb168-2266"><a href="#cb168-2266" aria-hidden="true" tabindex="-1"></a><span class="in">        if (auc_actual &gt; mejor_auc) {</span></span>
<span id="cb168-2267"><a href="#cb168-2267" aria-hidden="true" tabindex="-1"></a><span class="in">          mejor_auc &lt;- auc_actual</span></span>
<span id="cb168-2268"><a href="#cb168-2268" aria-hidden="true" tabindex="-1"></a><span class="in">          mejor_modelo &lt;- modelo</span></span>
<span id="cb168-2269"><a href="#cb168-2269" aria-hidden="true" tabindex="-1"></a><span class="in">        }</span></span>
<span id="cb168-2270"><a href="#cb168-2270" aria-hidden="true" tabindex="-1"></a><span class="in">      }</span></span>
<span id="cb168-2271"><a href="#cb168-2271" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb168-2272"><a href="#cb168-2272" aria-hidden="true" tabindex="-1"></a><span class="in">    ########################</span></span>
<span id="cb168-2273"><a href="#cb168-2273" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_test &lt;- predict(mejor_modelo, newdata = datos_validacion, type = "raw")</span></span>
<span id="cb168-2274"><a href="#cb168-2274" aria-hidden="true" tabindex="-1"></a><span class="in">    clases_predichas_test &lt;- ifelse(predicciones_test &gt;= 0.5, "SI", "NO")</span></span>
<span id="cb168-2275"><a href="#cb168-2275" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-2276"><a href="#cb168-2276" aria-hidden="true" tabindex="-1"></a><span class="in">    ###########################</span></span>
<span id="cb168-2277"><a href="#cb168-2277" aria-hidden="true" tabindex="-1"></a><span class="in">    # Realizar predicciones en el conjunto de entrenamiento externo para el AUC general</span></span>
<span id="cb168-2278"><a href="#cb168-2278" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_auc[test_indices_inner] &lt;- predict(mejor_modelo_auc, newdata = datos_validacion, type = "response")</span></span>
<span id="cb168-2279"><a href="#cb168-2279" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_clasificadas &lt;- ifelse(predicciones_auc[test_indices_inner] &gt;= 0.5, "SI", "NO")</span></span>
<span id="cb168-2280"><a href="#cb168-2280" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-2281"><a href="#cb168-2281" aria-hidden="true" tabindex="-1"></a><span class="in">    resultados_sensibilidad_inner[i_inner] &lt;- sum(clases_predichas_test == "SI" &amp; datos_validacion[["ESTADO_ACTUAL"]] == "SI") / sum(datos_validacion[["ESTADO_ACTUAL"]] == "SI")</span></span>
<span id="cb168-2282"><a href="#cb168-2282" aria-hidden="true" tabindex="-1"></a><span class="in">    resultados_accuracy_inner[i_inner] &lt;- mean(clases_predichas_test == datos_validacion[["ESTADO_ACTUAL"]])</span></span>
<span id="cb168-2283"><a href="#cb168-2283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2284"><a href="#cb168-2284" aria-hidden="true" tabindex="-1"></a><span class="in">    targets_auc[test_indices_inner] &lt;- as.numeric(datos_validacion$ESTADO_ACTUAL) - 1</span></span>
<span id="cb168-2285"><a href="#cb168-2285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2286"><a href="#cb168-2286" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb168-2287"><a href="#cb168-2287" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-2288"><a href="#cb168-2288" aria-hidden="true" tabindex="-1"></a><span class="in">  # Calcular el AUC final para este fold externo</span></span>
<span id="cb168-2289"><a href="#cb168-2289" aria-hidden="true" tabindex="-1"></a><span class="in">  auc_fold_externo &lt;- pROC::roc(targets_auc, predicciones_auc)$auc</span></span>
<span id="cb168-2290"><a href="#cb168-2290" aria-hidden="true" tabindex="-1"></a><span class="in">  accuracy_fold_externo &lt;- mean(resultados_accuracy_inner)</span></span>
<span id="cb168-2291"><a href="#cb168-2291" aria-hidden="true" tabindex="-1"></a><span class="in">  sensibilidad_fold_externo &lt;- mean(resultados_sensibilidad_inner)</span></span>
<span id="cb168-2292"><a href="#cb168-2292" aria-hidden="true" tabindex="-1"></a><span class="in"> </span></span>
<span id="cb168-2293"><a href="#cb168-2293" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-2294"><a href="#cb168-2294" aria-hidden="true" tabindex="-1"></a><span class="in">  # Almacenar el AUC del fold externo actual</span></span>
<span id="cb168-2295"><a href="#cb168-2295" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_auc[i_outer] &lt;- auc_fold_externo</span></span>
<span id="cb168-2296"><a href="#cb168-2296" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_accuracy[i_outer] &lt;- accuracy_fold_externo</span></span>
<span id="cb168-2297"><a href="#cb168-2297" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_sensibilidad[i_outer] &lt;- sensibilidad_fold_externo</span></span>
<span id="cb168-2298"><a href="#cb168-2298" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-2299"><a href="#cb168-2299" aria-hidden="true" tabindex="-1"></a><span class="in">  # Predecir en los datos de test para este pliegue externo y almacenar predicciones</span></span>
<span id="cb168-2300"><a href="#cb168-2300" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_test &lt;- predict(mejor_modelo_auc, newdata = datos_test_outer, type = "response")</span></span>
<span id="cb168-2301"><a href="#cb168-2301" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_totales[test_indices_outer, i_outer] &lt;- predicciones_test</span></span>
<span id="cb168-2302"><a href="#cb168-2302" aria-hidden="true" tabindex="-1"></a><span class="in">  targets_totales[test_indices_outer] &lt;- as.numeric(datos_test_outer$ESTADO_ACTUAL) - 1</span></span>
<span id="cb168-2303"><a href="#cb168-2303" aria-hidden="true" tabindex="-1"></a><span class="in"> </span></span>
<span id="cb168-2304"><a href="#cb168-2304" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb168-2305"><a href="#cb168-2305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2306"><a href="#cb168-2306" aria-hidden="true" tabindex="-1"></a><span class="in"># Calcular AUC promedio</span></span>
<span id="cb168-2307"><a href="#cb168-2307" aria-hidden="true" tabindex="-1"></a><span class="in">auc_promedio &lt;- mean(resultados_auc)</span></span>
<span id="cb168-2308"><a href="#cb168-2308" aria-hidden="true" tabindex="-1"></a><span class="in">accuracy_promedio &lt;- mean(resultados_accuracy)</span></span>
<span id="cb168-2309"><a href="#cb168-2309" aria-hidden="true" tabindex="-1"></a><span class="in">sensibilidad_promedio &lt;- mean(resultados_sensibilidad)</span></span>
<span id="cb168-2310"><a href="#cb168-2310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2311"><a href="#cb168-2311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2312"><a href="#cb168-2312" aria-hidden="true" tabindex="-1"></a><span class="in"># Crear tabla con todas las métricas</span></span>
<span id="cb168-2313"><a href="#cb168-2313" aria-hidden="true" tabindex="-1"></a><span class="in">tabla_metricas &lt;- data.frame(</span></span>
<span id="cb168-2314"><a href="#cb168-2314" aria-hidden="true" tabindex="-1"></a><span class="in">  Pliegue = 1:k_outer,</span></span>
<span id="cb168-2315"><a href="#cb168-2315" aria-hidden="true" tabindex="-1"></a><span class="in">  AUC = sapply(resultados_auc, round, digits = 3),</span></span>
<span id="cb168-2316"><a href="#cb168-2316" aria-hidden="true" tabindex="-1"></a><span class="in">  Accuracy = sapply(resultados_accuracy, round, digits = 3),</span></span>
<span id="cb168-2317"><a href="#cb168-2317" aria-hidden="true" tabindex="-1"></a><span class="in">  Recall = sapply(resultados_sensibilidad, round, digits = 3)</span></span>
<span id="cb168-2318"><a href="#cb168-2318" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb168-2319"><a href="#cb168-2319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2320"><a href="#cb168-2320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2321"><a href="#cb168-2321" aria-hidden="true" tabindex="-1"></a><span class="in"># Agregar fila con promedio de métricas</span></span>
<span id="cb168-2322"><a href="#cb168-2322" aria-hidden="true" tabindex="-1"></a><span class="in">tabla_metricas_nnet_wrapper &lt;- rbind(tabla_metricas, c("Mean", round(auc_promedio,3), round(accuracy_promedio,3), round(sensibilidad_promedio,3)))</span></span>
<span id="cb168-2323"><a href="#cb168-2323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2324"><a href="#cb168-2324" aria-hidden="true" tabindex="-1"></a><span class="in">end_time &lt;- Sys.time()</span></span>
<span id="cb168-2325"><a href="#cb168-2325" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time_nnet_wrapper &lt;- end_time - start_time</span></span>
<span id="cb168-2326"><a href="#cb168-2326" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time_nnet_wrapper &lt;- as.numeric(execution_time_nnet_wrapper, units = "secs")</span></span>
<span id="cb168-2327"><a href="#cb168-2327" aria-hidden="true" tabindex="-1"></a><span class="in">save(tabla_metricas_nnet_wrapper, file = "tabla_metricas_nnet_wrapper.RData")</span></span>
<span id="cb168-2328"><a href="#cb168-2328" aria-hidden="true" tabindex="-1"></a><span class="in">save(execution_time_nnet_wrapper, file = "execution_time_nnet_wrapper.RData")</span></span>
<span id="cb168-2329"><a href="#cb168-2329" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-2330"><a href="#cb168-2330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2333"><a href="#cb168-2333" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-2334"><a href="#cb168-2334" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"tabla_metricas_nnet_wrapper.RData"</span>)</span>
<span id="cb168-2335"><a href="#cb168-2335" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"execution_time_nnet_wrapper.RData"</span>)</span>
<span id="cb168-2336"><a href="#cb168-2336" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time_nnet_wrapper,  <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb168-2337"><a href="#cb168-2337" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-2338"><a href="#cb168-2338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2339"><a href="#cb168-2339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2340"><a href="#cb168-2340" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb168-2341"><a href="#cb168-2341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2342"><a href="#cb168-2342" aria-hidden="true" tabindex="-1"></a><span class="fu"># Metrics Table</span></span>
<span id="cb168-2345"><a href="#cb168-2345" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-2346"><a href="#cb168-2346" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir tabla formateada con kableExtra</span></span>
<span id="cb168-2347"><a href="#cb168-2347" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(tabla_metricas_nnet_wrapper, <span class="at">caption =</span> <span class="st">"Cross Validation Metrics"</span>, <span class="at">align =</span> <span class="st">"c"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb168-2348"><a href="#cb168-2348" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb168-2349"><a href="#cb168-2349" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-2350"><a href="#cb168-2350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2351"><a href="#cb168-2351" aria-hidden="true" tabindex="-1"></a><span class="fu"># Metrics Plot</span></span>
<span id="cb168-2354"><a href="#cb168-2354" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-2355"><a href="#cb168-2355" aria-hidden="true" tabindex="-1"></a><span class="fu">crear_plot_metricas_per_fold</span>(tabla_metricas_nnet_wrapper)</span>
<span id="cb168-2356"><a href="#cb168-2356" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-2357"><a href="#cb168-2357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2358"><a href="#cb168-2358" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb168-2359"><a href="#cb168-2359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2360"><a href="#cb168-2360" aria-hidden="true" tabindex="-1"></a>The performance and constancy of the model are good.</span>
<span id="cb168-2361"><a href="#cb168-2361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2362"><a href="#cb168-2362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2363"><a href="#cb168-2363" aria-hidden="true" tabindex="-1"></a><span class="fu">## Hyperparameters Resume</span></span>
<span id="cb168-2364"><a href="#cb168-2364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2365"><a href="#cb168-2365" aria-hidden="true" tabindex="-1"></a>This is a resume of the model performance with every hyperparameters combination. The next table shows the top 10 and bottom 10 models by AUC.</span>
<span id="cb168-2366"><a href="#cb168-2366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2367"><a href="#cb168-2367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2368"><a href="#cb168-2368" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,message=FALSE,warning=FALSE}</span></span>
<span id="cb168-2369"><a href="#cb168-2369" aria-hidden="true" tabindex="-1"></a><span class="in">start_time &lt;- Sys.time()</span></span>
<span id="cb168-2370"><a href="#cb168-2370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2371"><a href="#cb168-2371" aria-hidden="true" tabindex="-1"></a><span class="in"># Dividir el conjunto de datos en entrenamiento y test</span></span>
<span id="cb168-2372"><a href="#cb168-2372" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(123)  # Establecer una semilla para reproducibilidad</span></span>
<span id="cb168-2373"><a href="#cb168-2373" aria-hidden="true" tabindex="-1"></a><span class="in">indices_entrenamiento &lt;- sample(nrow(data), 0.75 * nrow(data))  # 75% para entrenamiento</span></span>
<span id="cb168-2374"><a href="#cb168-2374" aria-hidden="true" tabindex="-1"></a><span class="in">datos_entrenamiento &lt;- data[indices_entrenamiento, ]</span></span>
<span id="cb168-2375"><a href="#cb168-2375" aria-hidden="true" tabindex="-1"></a><span class="in">datos_test &lt;- data[-indices_entrenamiento, ]</span></span>
<span id="cb168-2376"><a href="#cb168-2376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2377"><a href="#cb168-2377" aria-hidden="true" tabindex="-1"></a><span class="in"># Dividir datos de entrenamiento en entrenamiento y validación</span></span>
<span id="cb168-2378"><a href="#cb168-2378" aria-hidden="true" tabindex="-1"></a><span class="in">train_indices &lt;- sample(nrow(datos_entrenamiento), 0.8 * nrow(datos_entrenamiento))  # 80% para entrenamiento</span></span>
<span id="cb168-2379"><a href="#cb168-2379" aria-hidden="true" tabindex="-1"></a><span class="in">datos_entrenamiento_split &lt;- datos_entrenamiento[train_indices, ]</span></span>
<span id="cb168-2380"><a href="#cb168-2380" aria-hidden="true" tabindex="-1"></a><span class="in">datos_validacion &lt;- datos_entrenamiento[-train_indices, ]</span></span>
<span id="cb168-2381"><a href="#cb168-2381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2382"><a href="#cb168-2382" aria-hidden="true" tabindex="-1"></a><span class="in"># Oversampling</span></span>
<span id="cb168-2383"><a href="#cb168-2383" aria-hidden="true" tabindex="-1"></a><span class="in">proportion &lt;- 0.28</span></span>
<span id="cb168-2384"><a href="#cb168-2384" aria-hidden="true" tabindex="-1"></a><span class="in">datos_entrenamiento_oversampled &lt;- ROSE(ESTADO_ACTUAL ~ ., data = datos_entrenamiento_split, p = proportion, seed = 123)$data</span></span>
<span id="cb168-2385"><a href="#cb168-2385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2386"><a href="#cb168-2386" aria-hidden="true" tabindex="-1"></a><span class="in"># Inicializar variables para almacenar los resultados</span></span>
<span id="cb168-2387"><a href="#cb168-2387" aria-hidden="true" tabindex="-1"></a><span class="in">mejor_auc &lt;- 0</span></span>
<span id="cb168-2388"><a href="#cb168-2388" aria-hidden="true" tabindex="-1"></a><span class="in">mejor_modelo &lt;- NULL</span></span>
<span id="cb168-2389"><a href="#cb168-2389" aria-hidden="true" tabindex="-1"></a><span class="in">resultados &lt;- data.frame(size = integer(), decay = numeric(), maxit = integer(), skip = integer(), auc = numeric(), stringsAsFactors = FALSE)</span></span>
<span id="cb168-2390"><a href="#cb168-2390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2391"><a href="#cb168-2391" aria-hidden="true" tabindex="-1"></a><span class="in"># Definir combinaciones de hiperparámetros</span></span>
<span id="cb168-2392"><a href="#cb168-2392" aria-hidden="true" tabindex="-1"></a><span class="in">params &lt;- expand.grid(size = c(15, 40), decay = c(0.01, 0.5, 0.001), maxit = c(225, 1000, 5), skip = c(0, 1, 2))</span></span>
<span id="cb168-2393"><a href="#cb168-2393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2394"><a href="#cb168-2394" aria-hidden="true" tabindex="-1"></a><span class="in"># Fórmula con todas las variables predictoras</span></span>
<span id="cb168-2395"><a href="#cb168-2395" aria-hidden="true" tabindex="-1"></a><span class="in">formula &lt;- ESTADO_ACTUAL ~ .</span></span>
<span id="cb168-2396"><a href="#cb168-2396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2397"><a href="#cb168-2397" aria-hidden="true" tabindex="-1"></a><span class="in"># Iterar sobre las combinaciones de hiperparámetros</span></span>
<span id="cb168-2398"><a href="#cb168-2398" aria-hidden="true" tabindex="-1"></a><span class="in">for (param in 1:nrow(params)) {</span></span>
<span id="cb168-2399"><a href="#cb168-2399" aria-hidden="true" tabindex="-1"></a><span class="in">  size &lt;- params$size[param]</span></span>
<span id="cb168-2400"><a href="#cb168-2400" aria-hidden="true" tabindex="-1"></a><span class="in">  decay &lt;- params$decay[param]</span></span>
<span id="cb168-2401"><a href="#cb168-2401" aria-hidden="true" tabindex="-1"></a><span class="in">  maxit &lt;- params$maxit[param]</span></span>
<span id="cb168-2402"><a href="#cb168-2402" aria-hidden="true" tabindex="-1"></a><span class="in">  skip &lt;- params$skip[param]</span></span>
<span id="cb168-2403"><a href="#cb168-2403" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-2404"><a href="#cb168-2404" aria-hidden="true" tabindex="-1"></a><span class="in">  # Entrenar el modelo con la combinación de hiperparámetros actual</span></span>
<span id="cb168-2405"><a href="#cb168-2405" aria-hidden="true" tabindex="-1"></a><span class="in">  modelo &lt;- nnet(formula, data = datos_entrenamiento_oversampled, size = size, decay = decay, maxit = maxit, skip = skip, trace = FALSE)</span></span>
<span id="cb168-2406"><a href="#cb168-2406" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-2407"><a href="#cb168-2407" aria-hidden="true" tabindex="-1"></a><span class="in">  # Realizar predicciones en datos de prueba</span></span>
<span id="cb168-2408"><a href="#cb168-2408" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_test &lt;- predict(modelo, newdata = datos_test, type = "raw")</span></span>
<span id="cb168-2409"><a href="#cb168-2409" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-2410"><a href="#cb168-2410" aria-hidden="true" tabindex="-1"></a><span class="in">  # Calcular AUC para la combinación actual en datos de prueba</span></span>
<span id="cb168-2411"><a href="#cb168-2411" aria-hidden="true" tabindex="-1"></a><span class="in">  roc_obj &lt;- roc(ifelse(datos_test$ESTADO_ACTUAL == "SI", 1, 0), predicciones_test)</span></span>
<span id="cb168-2412"><a href="#cb168-2412" aria-hidden="true" tabindex="-1"></a><span class="in">  auc_actual &lt;- as.numeric(auc(roc_obj))  # Extraer el valor numérico del AUC</span></span>
<span id="cb168-2413"><a href="#cb168-2413" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-2414"><a href="#cb168-2414" aria-hidden="true" tabindex="-1"></a><span class="in">  # Guardar los resultados en la tabla</span></span>
<span id="cb168-2415"><a href="#cb168-2415" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados &lt;- resultados %&gt;%</span></span>
<span id="cb168-2416"><a href="#cb168-2416" aria-hidden="true" tabindex="-1"></a><span class="in">    add_row(size = size, decay = decay, maxit = maxit, skip = skip, auc = auc_actual)</span></span>
<span id="cb168-2417"><a href="#cb168-2417" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-2418"><a href="#cb168-2418" aria-hidden="true" tabindex="-1"></a><span class="in">  # Actualizar el mejor modelo y su AUC si se encuentra un modelo mejor</span></span>
<span id="cb168-2419"><a href="#cb168-2419" aria-hidden="true" tabindex="-1"></a><span class="in">  if (auc_actual &gt; mejor_auc) {</span></span>
<span id="cb168-2420"><a href="#cb168-2420" aria-hidden="true" tabindex="-1"></a><span class="in">    mejor_auc &lt;- auc_actual</span></span>
<span id="cb168-2421"><a href="#cb168-2421" aria-hidden="true" tabindex="-1"></a><span class="in">    mejor_modelo &lt;- modelo</span></span>
<span id="cb168-2422"><a href="#cb168-2422" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb168-2423"><a href="#cb168-2423" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb168-2424"><a href="#cb168-2424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2425"><a href="#cb168-2425" aria-hidden="true" tabindex="-1"></a><span class="in"># Ordenar los resultados por AUC en orden descendente</span></span>
<span id="cb168-2426"><a href="#cb168-2426" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_ordenados &lt;- resultados %&gt;% arrange(desc(auc))</span></span>
<span id="cb168-2427"><a href="#cb168-2427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2428"><a href="#cb168-2428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2429"><a href="#cb168-2429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2430"><a href="#cb168-2430" aria-hidden="true" tabindex="-1"></a><span class="in"># Mostrar la tabla con los resultados de todas las combinaciones de hiperparámetros</span></span>
<span id="cb168-2431"><a href="#cb168-2431" aria-hidden="true" tabindex="-1"></a><span class="in">save(resultados_ordenados, file = "resultados_ordenados.RData")</span></span>
<span id="cb168-2432"><a href="#cb168-2432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2433"><a href="#cb168-2433" aria-hidden="true" tabindex="-1"></a><span class="in">end_time &lt;- Sys.time()</span></span>
<span id="cb168-2434"><a href="#cb168-2434" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time &lt;- end_time - start_time</span></span>
<span id="cb168-2435"><a href="#cb168-2435" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time &lt;- as.numeric(execution_time, units = "secs")</span></span>
<span id="cb168-2436"><a href="#cb168-2436" aria-hidden="true" tabindex="-1"></a><span class="in">save(execution_time, file = "execution_time_nnet.RData")</span></span>
<span id="cb168-2437"><a href="#cb168-2437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2438"><a href="#cb168-2438" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-2439"><a href="#cb168-2439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2442"><a href="#cb168-2442" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-2443"><a href="#cb168-2443" aria-hidden="true" tabindex="-1"></a><span class="co"># Cargar los datos guardados y mostrar las tablas</span></span>
<span id="cb168-2444"><a href="#cb168-2444" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"resultados_ordenados.RData"</span>)</span>
<span id="cb168-2445"><a href="#cb168-2445" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"execution_time_nnet.RData"</span>)</span>
<span id="cb168-2446"><a href="#cb168-2446" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time, <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb168-2447"><a href="#cb168-2447" aria-hidden="true" tabindex="-1"></a><span class="co"># Seleccionar los mejores 10 modelos</span></span>
<span id="cb168-2448"><a href="#cb168-2448" aria-hidden="true" tabindex="-1"></a>mejores_10 <span class="ot">&lt;-</span> resultados_ordenados <span class="sc">%&gt;%</span> <span class="fu">head</span>(<span class="dv">10</span>)</span>
<span id="cb168-2449"><a href="#cb168-2449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2450"><a href="#cb168-2450" aria-hidden="true" tabindex="-1"></a><span class="co"># Seleccionar los peores 10 modelos</span></span>
<span id="cb168-2451"><a href="#cb168-2451" aria-hidden="true" tabindex="-1"></a>peores_10 <span class="ot">&lt;-</span> resultados_ordenados <span class="sc">%&gt;%</span> <span class="fu">tail</span>(<span class="dv">10</span>)</span>
<span id="cb168-2452"><a href="#cb168-2452" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir los mejores y peores modelos en tablas bonitas</span></span>
<span id="cb168-2453"><a href="#cb168-2453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2454"><a href="#cb168-2454" aria-hidden="true" tabindex="-1"></a>mejores_10 <span class="sc">%&gt;%</span></span>
<span id="cb168-2455"><a href="#cb168-2455" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">caption =</span> <span class="st">"Top 10 Models by AUC"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb168-2456"><a href="#cb168-2456" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>, <span class="st">"condensed"</span>, <span class="st">"responsive"</span>))</span>
<span id="cb168-2457"><a href="#cb168-2457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2458"><a href="#cb168-2458" aria-hidden="true" tabindex="-1"></a>peores_10 <span class="sc">%&gt;%</span></span>
<span id="cb168-2459"><a href="#cb168-2459" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">caption =</span> <span class="st">"Bottom 10 Models by AUC"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb168-2460"><a href="#cb168-2460" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>, <span class="st">"condensed"</span>, <span class="st">"responsive"</span>))</span>
<span id="cb168-2461"><a href="#cb168-2461" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-2464"><a href="#cb168-2464" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-2465"><a href="#cb168-2465" aria-hidden="true" tabindex="-1"></a> <span class="co"># Instalar y cargar la librería plotly si no está instalada</span></span>
<span id="cb168-2466"><a href="#cb168-2466" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(plotly)) {</span>
<span id="cb168-2467"><a href="#cb168-2467" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">"plotly"</span>)</span>
<span id="cb168-2468"><a href="#cb168-2468" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb168-2469"><a href="#cb168-2469" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(plotly)</span>
<span id="cb168-2470"><a href="#cb168-2470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2471"><a href="#cb168-2471" aria-hidden="true" tabindex="-1"></a><span class="co"># Cargar los resultados</span></span>
<span id="cb168-2472"><a href="#cb168-2472" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"resultados_ordenados.RData"</span>)</span>
<span id="cb168-2473"><a href="#cb168-2473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2474"><a href="#cb168-2474" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear la gráfica 3D con plotly</span></span>
<span id="cb168-2475"><a href="#cb168-2475" aria-hidden="true" tabindex="-1"></a>fig <span class="ot">&lt;-</span> <span class="fu">plot_ly</span>(</span>
<span id="cb168-2476"><a href="#cb168-2476" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> resultados_ordenados,</span>
<span id="cb168-2477"><a href="#cb168-2477" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> <span class="sc">~</span>size,</span>
<span id="cb168-2478"><a href="#cb168-2478" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> <span class="sc">~</span>decay,</span>
<span id="cb168-2479"><a href="#cb168-2479" aria-hidden="true" tabindex="-1"></a>  <span class="at">z =</span> <span class="sc">~</span>auc,</span>
<span id="cb168-2480"><a href="#cb168-2480" aria-hidden="true" tabindex="-1"></a>  <span class="at">color =</span> <span class="sc">~</span><span class="fu">factor</span>(maxit),</span>
<span id="cb168-2481"><a href="#cb168-2481" aria-hidden="true" tabindex="-1"></a>  <span class="at">colors =</span> <span class="fu">c</span>(<span class="st">"#3C5B6F"</span>, <span class="st">"steelblue"</span>, <span class="st">"lightblue"</span>),</span>
<span id="cb168-2482"><a href="#cb168-2482" aria-hidden="true" tabindex="-1"></a>  <span class="at">symbol =</span> <span class="sc">~</span><span class="fu">factor</span>(skip),</span>
<span id="cb168-2483"><a href="#cb168-2483" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"scatter3d"</span>,</span>
<span id="cb168-2484"><a href="#cb168-2484" aria-hidden="true" tabindex="-1"></a>  <span class="at">mode =</span> <span class="st">"markers"</span>,</span>
<span id="cb168-2485"><a href="#cb168-2485" aria-hidden="true" tabindex="-1"></a>  <span class="at">marker =</span> <span class="fu">list</span>(<span class="at">size =</span> <span class="dv">5</span>)</span>
<span id="cb168-2486"><a href="#cb168-2486" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb168-2487"><a href="#cb168-2487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2488"><a href="#cb168-2488" aria-hidden="true" tabindex="-1"></a>fig <span class="ot">&lt;-</span> fig <span class="sc">%&gt;%</span></span>
<span id="cb168-2489"><a href="#cb168-2489" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layout</span>(</span>
<span id="cb168-2490"><a href="#cb168-2490" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"AUC for each combination of hyperparameters"</span>,</span>
<span id="cb168-2491"><a href="#cb168-2491" aria-hidden="true" tabindex="-1"></a>    <span class="at">scene =</span> <span class="fu">list</span>(</span>
<span id="cb168-2492"><a href="#cb168-2492" aria-hidden="true" tabindex="-1"></a>      <span class="at">xaxis =</span> <span class="fu">list</span>(<span class="at">title =</span> <span class="st">"Size"</span>),</span>
<span id="cb168-2493"><a href="#cb168-2493" aria-hidden="true" tabindex="-1"></a>      <span class="at">yaxis =</span> <span class="fu">list</span>(<span class="at">title =</span> <span class="st">"Decay"</span>),</span>
<span id="cb168-2494"><a href="#cb168-2494" aria-hidden="true" tabindex="-1"></a>      <span class="at">zaxis =</span> <span class="fu">list</span>(<span class="at">title =</span> <span class="st">"AUC"</span>)</span>
<span id="cb168-2495"><a href="#cb168-2495" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb168-2496"><a href="#cb168-2496" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb168-2497"><a href="#cb168-2497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2498"><a href="#cb168-2498" aria-hidden="true" tabindex="-1"></a><span class="co"># Mostrar la gráfica</span></span>
<span id="cb168-2499"><a href="#cb168-2499" aria-hidden="true" tabindex="-1"></a>fig</span>
<span id="cb168-2500"><a href="#cb168-2500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2501"><a href="#cb168-2501" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-2502"><a href="#cb168-2502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2503"><a href="#cb168-2503" aria-hidden="true" tabindex="-1"></a>It seem that the best models have a size of 15 and a decay of 0.01. The skip parameter does not seem to have a big impact on the model performance. These perrormance measuraments are extremely optimistic and do not correspond to the real performance of the model but it can help us to understand the hyperparameters impact on the model.</span>
<span id="cb168-2504"><a href="#cb168-2504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2505"><a href="#cb168-2505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2506"><a href="#cb168-2506" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb168-2507"><a href="#cb168-2507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2508"><a href="#cb168-2508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2509"><a href="#cb168-2509" aria-hidden="true" tabindex="-1"></a><span class="fu"># Support Vectors Machine {#suport-vectors-machine}</span></span>
<span id="cb168-2510"><a href="#cb168-2510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2511"><a href="#cb168-2511" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset style="background-color: #f0f0f0;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;"}</span>
<span id="cb168-2512"><a href="#cb168-2512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2513"><a href="#cb168-2513" aria-hidden="true" tabindex="-1"></a><span class="fu">## Hold out</span></span>
<span id="cb168-2514"><a href="#cb168-2514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2515"><a href="#cb168-2515" aria-hidden="true" tabindex="-1"></a>In this section we are going to build a SVM model using different hyperparameters and evaluate it using a hold out validation.</span>
<span id="cb168-2516"><a href="#cb168-2516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2517"><a href="#cb168-2517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2518"><a href="#cb168-2518" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=FALSE,message=FALSE, eval=FALSE}</span></span>
<span id="cb168-2519"><a href="#cb168-2519" aria-hidden="true" tabindex="-1"></a><span class="in">start_time &lt;- Sys.time()</span></span>
<span id="cb168-2520"><a href="#cb168-2520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2521"><a href="#cb168-2521" aria-hidden="true" tabindex="-1"></a><span class="in"># Parámetros a cambiar:</span></span>
<span id="cb168-2522"><a href="#cb168-2522" aria-hidden="true" tabindex="-1"></a><span class="in">proportion &lt;- 0.28</span></span>
<span id="cb168-2523"><a href="#cb168-2523" aria-hidden="true" tabindex="-1"></a><span class="in">sensitivity_weight &lt;- 0.8</span></span>
<span id="cb168-2524"><a href="#cb168-2524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2525"><a href="#cb168-2525" aria-hidden="true" tabindex="-1"></a><span class="in"># Dividir el conjunto de datos en entrenamiento y test</span></span>
<span id="cb168-2526"><a href="#cb168-2526" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(123)  # Establecer una semilla para reproducibilidad</span></span>
<span id="cb168-2527"><a href="#cb168-2527" aria-hidden="true" tabindex="-1"></a><span class="in">indices_entrenamiento &lt;- sample(nrow(data), 0.75 * nrow(data))  # 75% para entrenamiento</span></span>
<span id="cb168-2528"><a href="#cb168-2528" aria-hidden="true" tabindex="-1"></a><span class="in">datos_entrenamiento &lt;- data[indices_entrenamiento, ]</span></span>
<span id="cb168-2529"><a href="#cb168-2529" aria-hidden="true" tabindex="-1"></a><span class="in">datos_test &lt;- data[-indices_entrenamiento, ]</span></span>
<span id="cb168-2530"><a href="#cb168-2530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2531"><a href="#cb168-2531" aria-hidden="true" tabindex="-1"></a><span class="in"># Dividir datos de entrenamiento en entrenamiento y validación</span></span>
<span id="cb168-2532"><a href="#cb168-2532" aria-hidden="true" tabindex="-1"></a><span class="in">train_indices &lt;- sample(nrow(datos_entrenamiento), 0.8 * nrow(datos_entrenamiento))  # 80% para entrenamiento</span></span>
<span id="cb168-2533"><a href="#cb168-2533" aria-hidden="true" tabindex="-1"></a><span class="in">datos_entrenamiento_split &lt;- datos_entrenamiento[train_indices, ]</span></span>
<span id="cb168-2534"><a href="#cb168-2534" aria-hidden="true" tabindex="-1"></a><span class="in">datos_validacion &lt;- datos_entrenamiento[-train_indices, ]</span></span>
<span id="cb168-2535"><a href="#cb168-2535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2536"><a href="#cb168-2536" aria-hidden="true" tabindex="-1"></a><span class="in"># Realizar oversampling</span></span>
<span id="cb168-2537"><a href="#cb168-2537" aria-hidden="true" tabindex="-1"></a><span class="in">datos_entrenamiento_oversampled &lt;- ROSE(ESTADO_ACTUAL ~ ., data = datos_entrenamiento_split, seed = 123, p = proportion)$data</span></span>
<span id="cb168-2538"><a href="#cb168-2538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2539"><a href="#cb168-2539" aria-hidden="true" tabindex="-1"></a><span class="in"># Definir la fórmula para el modelo</span></span>
<span id="cb168-2540"><a href="#cb168-2540" aria-hidden="true" tabindex="-1"></a><span class="in">formula &lt;- ESTADO_ACTUAL ~ .</span></span>
<span id="cb168-2541"><a href="#cb168-2541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2542"><a href="#cb168-2542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2543"><a href="#cb168-2543" aria-hidden="true" tabindex="-1"></a><span class="in"># Inicializar variables para almacenar los resultados</span></span>
<span id="cb168-2544"><a href="#cb168-2544" aria-hidden="true" tabindex="-1"></a><span class="in">mejor_auc &lt;- 0</span></span>
<span id="cb168-2545"><a href="#cb168-2545" aria-hidden="true" tabindex="-1"></a><span class="in">mejor_modelo &lt;- NULL</span></span>
<span id="cb168-2546"><a href="#cb168-2546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2547"><a href="#cb168-2547" aria-hidden="true" tabindex="-1"></a><span class="in"># Definir hiperparámetros a probar</span></span>
<span id="cb168-2548"><a href="#cb168-2548" aria-hidden="true" tabindex="-1"></a><span class="in">params &lt;- expand.grid(cost = c(100, 1000, 10000, 50000, 1000000),</span></span>
<span id="cb168-2549"><a href="#cb168-2549" aria-hidden="true" tabindex="-1"></a><span class="in">                      gamma = c(0.1, 1, 10),</span></span>
<span id="cb168-2550"><a href="#cb168-2550" aria-hidden="true" tabindex="-1"></a><span class="in">                      kernel = c("linear", "radial", "sigmoid"))</span></span>
<span id="cb168-2551"><a href="#cb168-2551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2552"><a href="#cb168-2552" aria-hidden="true" tabindex="-1"></a><span class="in"># Bucle para probar diferentes combinaciones de hiperparámetros</span></span>
<span id="cb168-2553"><a href="#cb168-2553" aria-hidden="true" tabindex="-1"></a><span class="in">for (i in 1:nrow(params)) {</span></span>
<span id="cb168-2554"><a href="#cb168-2554" aria-hidden="true" tabindex="-1"></a><span class="in">  cost &lt;- params$cost[i]</span></span>
<span id="cb168-2555"><a href="#cb168-2555" aria-hidden="true" tabindex="-1"></a><span class="in">  gamma &lt;- params$gamma[i]</span></span>
<span id="cb168-2556"><a href="#cb168-2556" aria-hidden="true" tabindex="-1"></a><span class="in">  kernel &lt;- params$kernel[i]</span></span>
<span id="cb168-2557"><a href="#cb168-2557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2558"><a href="#cb168-2558" aria-hidden="true" tabindex="-1"></a><span class="in">  # Entrenar el modelo SVM con la combinación de hiperparámetros actual</span></span>
<span id="cb168-2559"><a href="#cb168-2559" aria-hidden="true" tabindex="-1"></a><span class="in">  modelo &lt;- svm(formula, data = datos_entrenamiento_oversampled, type = "C-classification", kernel = kernel, cost = cost, gamma = gamma, probability = TRUE)</span></span>
<span id="cb168-2560"><a href="#cb168-2560" aria-hidden="true" tabindex="-1"></a><span class="in">  ##############################</span></span>
<span id="cb168-2561"><a href="#cb168-2561" aria-hidden="true" tabindex="-1"></a><span class="in">  # Realizar predicciones con probabilidades en datos de validación</span></span>
<span id="cb168-2562"><a href="#cb168-2562" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_validacion &lt;- predict(modelo, newdata = datos_validacion, probability = TRUE)</span></span>
<span id="cb168-2563"><a href="#cb168-2563" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_validacion_prob &lt;- attr(predicciones_validacion, "probabilities")[, "SI"]  # Asumiendo que "SI" es la clase positiva</span></span>
<span id="cb168-2564"><a href="#cb168-2564" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-2565"><a href="#cb168-2565" aria-hidden="true" tabindex="-1"></a><span class="in">  # Calcular las predicciones finales basadas en probabilidades</span></span>
<span id="cb168-2566"><a href="#cb168-2566" aria-hidden="true" tabindex="-1"></a><span class="in">  umbral &lt;- 0.5</span></span>
<span id="cb168-2567"><a href="#cb168-2567" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_finales &lt;- ifelse(predicciones_validacion_prob &gt;= umbral, "SI", "NO")</span></span>
<span id="cb168-2568"><a href="#cb168-2568" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-2569"><a href="#cb168-2569" aria-hidden="true" tabindex="-1"></a><span class="in">  # Calcular la sensibilidad y la precisión</span></span>
<span id="cb168-2570"><a href="#cb168-2570" aria-hidden="true" tabindex="-1"></a><span class="in">  TP &lt;- sum(predicciones_finales == "SI" &amp; datos_validacion[["ESTADO_ACTUAL"]] == "SI")</span></span>
<span id="cb168-2571"><a href="#cb168-2571" aria-hidden="true" tabindex="-1"></a><span class="in">  FN &lt;- sum(predicciones_finales == "NO" &amp; datos_validacion[["ESTADO_ACTUAL"]] == "SI")</span></span>
<span id="cb168-2572"><a href="#cb168-2572" aria-hidden="true" tabindex="-1"></a><span class="in">  FP &lt;- sum(predicciones_finales == "SI" &amp; datos_validacion[["ESTADO_ACTUAL"]] == "NO")</span></span>
<span id="cb168-2573"><a href="#cb168-2573" aria-hidden="true" tabindex="-1"></a><span class="in">  TN &lt;- sum(predicciones_finales == "NO" &amp; datos_validacion[["ESTADO_ACTUAL"]] == "NO")</span></span>
<span id="cb168-2574"><a href="#cb168-2574" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-2575"><a href="#cb168-2575" aria-hidden="true" tabindex="-1"></a><span class="in">  recall_actual &lt;- TP / (TP + FN)</span></span>
<span id="cb168-2576"><a href="#cb168-2576" aria-hidden="true" tabindex="-1"></a><span class="in">  accuracy_actual &lt;- (TP + TN) / (TP + FN + FP + TN)</span></span>
<span id="cb168-2577"><a href="#cb168-2577" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-2578"><a href="#cb168-2578" aria-hidden="true" tabindex="-1"></a><span class="in">  # Calcular el custom metric para la combinación actual</span></span>
<span id="cb168-2579"><a href="#cb168-2579" aria-hidden="true" tabindex="-1"></a><span class="in">  custom_metric_actual &lt;- compute_custom_metric(recall_actual, accuracy_actual, sensitivity_weight)</span></span>
<span id="cb168-2580"><a href="#cb168-2580" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-2581"><a href="#cb168-2581" aria-hidden="true" tabindex="-1"></a><span class="in">  # Actualizar el mejor modelo y su rendimiento si se encuentra un modelo mejor</span></span>
<span id="cb168-2582"><a href="#cb168-2582" aria-hidden="true" tabindex="-1"></a><span class="in">  if (auc_actual &gt; mejor_auc) {</span></span>
<span id="cb168-2583"><a href="#cb168-2583" aria-hidden="true" tabindex="-1"></a><span class="in">    mejor_auc &lt;- auc_actual</span></span>
<span id="cb168-2584"><a href="#cb168-2584" aria-hidden="true" tabindex="-1"></a><span class="in">    mejor_modelo &lt;- modelo</span></span>
<span id="cb168-2585"><a href="#cb168-2585" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb168-2586"><a href="#cb168-2586" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb168-2587"><a href="#cb168-2587" aria-hidden="true" tabindex="-1"></a><span class="in">#########################33</span></span>
<span id="cb168-2588"><a href="#cb168-2588" aria-hidden="true" tabindex="-1"></a><span class="in">mejor_modelo_svm &lt;- mejor_modelo</span></span>
<span id="cb168-2589"><a href="#cb168-2589" aria-hidden="true" tabindex="-1"></a><span class="in">end_time &lt;- Sys.time()</span></span>
<span id="cb168-2590"><a href="#cb168-2590" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time_svm &lt;- end_time - start_time</span></span>
<span id="cb168-2591"><a href="#cb168-2591" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time_svm &lt;- as.numeric(execution_time_svm, units = "secs")</span></span>
<span id="cb168-2592"><a href="#cb168-2592" aria-hidden="true" tabindex="-1"></a><span class="in">save(mejor_modelo_svm, file = "mejor_modelo_svm.RData")</span></span>
<span id="cb168-2593"><a href="#cb168-2593" aria-hidden="true" tabindex="-1"></a><span class="in">save(execution_time_svm, file = "execution_time_svm.RData")</span></span>
<span id="cb168-2594"><a href="#cb168-2594" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-2595"><a href="#cb168-2595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2598"><a href="#cb168-2598" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-2599"><a href="#cb168-2599" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"mejor_modelo_svm.RData"</span>)</span>
<span id="cb168-2600"><a href="#cb168-2600" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"execution_time_svm.RData"</span>)</span>
<span id="cb168-2601"><a href="#cb168-2601" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mejor_modelo_svm)</span>
<span id="cb168-2602"><a href="#cb168-2602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2603"><a href="#cb168-2603" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time_svm,  <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb168-2604"><a href="#cb168-2604" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-2605"><a href="#cb168-2605" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb168-2606"><a href="#cb168-2606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2607"><a href="#cb168-2607" aria-hidden="true" tabindex="-1"></a><span class="fu">### Predictions</span></span>
<span id="cb168-2608"><a href="#cb168-2608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2609"><a href="#cb168-2609" aria-hidden="true" tabindex="-1"></a>We are going to predict on test in order to get a estimation of the performance of the model.</span>
<span id="cb168-2610"><a href="#cb168-2610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2613"><a href="#cb168-2613" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-2614"><a href="#cb168-2614" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular las predicciones para el conjunto de test</span></span>
<span id="cb168-2615"><a href="#cb168-2615" aria-hidden="true" tabindex="-1"></a>predicciones_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(mejor_modelo_svm, <span class="at">newdata =</span> datos_test, <span class="at">probability =</span> <span class="cn">TRUE</span>)</span>
<span id="cb168-2616"><a href="#cb168-2616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2617"><a href="#cb168-2617" aria-hidden="true" tabindex="-1"></a>predicciones_test <span class="ot">&lt;-</span> <span class="fu">attr</span>(predicciones_test, <span class="st">"probabilities"</span>)[, <span class="st">"SI"</span>]  <span class="co"># Asumiendo que "SI" es la clase positiva</span></span>
<span id="cb168-2618"><a href="#cb168-2618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2619"><a href="#cb168-2619" aria-hidden="true" tabindex="-1"></a>clases_predichas_test <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predicciones_test <span class="sc">&gt;=</span> <span class="fl">0.5</span>, <span class="st">"SI"</span>, <span class="st">"NO"</span>)</span>
<span id="cb168-2620"><a href="#cb168-2620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2621"><a href="#cb168-2621" aria-hidden="true" tabindex="-1"></a><span class="fu">mostrar_metricas</span>(datos_test<span class="sc">$</span>ESTADO_ACTUAL,clases_predichas_test)</span>
<span id="cb168-2622"><a href="#cb168-2622" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-2623"><a href="#cb168-2623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2624"><a href="#cb168-2624" aria-hidden="true" tabindex="-1"></a>Even though the model has a good auc, the recall is not good enough. This is because the model is not able to detect the positive cases. This is unacceptable in a medical context, we are going to see if the metrics are robust using a 5x2 cross validation and if it is not we are going to try to improve the model with variable selection techniques.</span>
<span id="cb168-2625"><a href="#cb168-2625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2626"><a href="#cb168-2626" aria-hidden="true" tabindex="-1"></a><span class="fu">### Roc curve and auc</span></span>
<span id="cb168-2627"><a href="#cb168-2627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2630"><a href="#cb168-2630" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-2631"><a href="#cb168-2631" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular la curva ROC y el AUC para el conjunto de test</span></span>
<span id="cb168-2632"><a href="#cb168-2632" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_roc_curve</span>(predicciones_test,datos_test<span class="sc">$</span>ESTADO_ACTUAL)</span>
<span id="cb168-2633"><a href="#cb168-2633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2634"><a href="#cb168-2634" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-2635"><a href="#cb168-2635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2636"><a href="#cb168-2636" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb168-2637"><a href="#cb168-2637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2638"><a href="#cb168-2638" aria-hidden="true" tabindex="-1"></a><span class="fu">## 5x2 Cross Validation Filter</span></span>
<span id="cb168-2639"><a href="#cb168-2639" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2640"><a href="#cb168-2640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2641"><a href="#cb168-2641" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=FALSE,message=FALSE, eval=FALSE}</span></span>
<span id="cb168-2642"><a href="#cb168-2642" aria-hidden="true" tabindex="-1"></a><span class="in">start_time &lt;- Sys.time()</span></span>
<span id="cb168-2643"><a href="#cb168-2643" aria-hidden="true" tabindex="-1"></a><span class="in"># Establecer la fórmula base para el modelo logístico</span></span>
<span id="cb168-2644"><a href="#cb168-2644" aria-hidden="true" tabindex="-1"></a><span class="in">formula_base &lt;- formula(ESTADO_ACTUAL ~ 1)  # Fórmula inicial sin predictoras</span></span>
<span id="cb168-2645"><a href="#cb168-2645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2646"><a href="#cb168-2646" aria-hidden="true" tabindex="-1"></a><span class="in"># Obtener nombres de variables predictoras</span></span>
<span id="cb168-2647"><a href="#cb168-2647" aria-hidden="true" tabindex="-1"></a><span class="in">variables &lt;- names(data)[-which(names(data) == "ESTADO_ACTUAL")]</span></span>
<span id="cb168-2648"><a href="#cb168-2648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2649"><a href="#cb168-2649" aria-hidden="true" tabindex="-1"></a><span class="in"># Obtener todas las combinaciones posibles de variables predictoras</span></span>
<span id="cb168-2650"><a href="#cb168-2650" aria-hidden="true" tabindex="-1"></a><span class="in">combinaciones_variables &lt;- unlist(lapply(1:length(variables), function(x) combn(variables, x, simplify = FALSE)), recursive = FALSE)</span></span>
<span id="cb168-2651"><a href="#cb168-2651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2652"><a href="#cb168-2652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2653"><a href="#cb168-2653" aria-hidden="true" tabindex="-1"></a><span class="in"># Configurar la validación cruzada 5x2</span></span>
<span id="cb168-2654"><a href="#cb168-2654" aria-hidden="true" tabindex="-1"></a><span class="in">k_outer &lt;- 5  # Número de pliegues externos</span></span>
<span id="cb168-2655"><a href="#cb168-2655" aria-hidden="true" tabindex="-1"></a><span class="in">k_inner &lt;- 2  # Número de pliegues internos</span></span>
<span id="cb168-2656"><a href="#cb168-2656" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(123)  # Establecer semilla para reproducibilidad</span></span>
<span id="cb168-2657"><a href="#cb168-2657" aria-hidden="true" tabindex="-1"></a><span class="in">folds_outer &lt;- createFolds(data$ESTADO_ACTUAL, k = k_outer, list = FALSE)  # Obtener índices de pliegues externos</span></span>
<span id="cb168-2658"><a href="#cb168-2658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2659"><a href="#cb168-2659" aria-hidden="true" tabindex="-1"></a><span class="in"># Lista para almacenar resultados</span></span>
<span id="cb168-2660"><a href="#cb168-2660" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_auc &lt;- numeric(k_outer)</span></span>
<span id="cb168-2661"><a href="#cb168-2661" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_sensibilidad &lt;- numeric(k_outer)</span></span>
<span id="cb168-2662"><a href="#cb168-2662" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_accuracy &lt;- numeric(k_outer)</span></span>
<span id="cb168-2663"><a href="#cb168-2663" aria-hidden="true" tabindex="-1"></a><span class="in">indices &lt;- 1:nrow(data)</span></span>
<span id="cb168-2664"><a href="#cb168-2664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2665"><a href="#cb168-2665" aria-hidden="true" tabindex="-1"></a><span class="in"># Inicializar matrices para almacenar predicciones y objetivos</span></span>
<span id="cb168-2666"><a href="#cb168-2666" aria-hidden="true" tabindex="-1"></a><span class="in">predicciones_totales &lt;- matrix(NA, nrow = nrow(data), ncol = k_outer)</span></span>
<span id="cb168-2667"><a href="#cb168-2667" aria-hidden="true" tabindex="-1"></a><span class="in">targets_totales &lt;- numeric(nrow(data))</span></span>
<span id="cb168-2668"><a href="#cb168-2668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2669"><a href="#cb168-2669" aria-hidden="true" tabindex="-1"></a><span class="in"># Iterar sobre cada pliegue externo y realizar el proceso de modelado</span></span>
<span id="cb168-2670"><a href="#cb168-2670" aria-hidden="true" tabindex="-1"></a><span class="in">for (i_outer in 1:k_outer) {</span></span>
<span id="cb168-2671"><a href="#cb168-2671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2672"><a href="#cb168-2672" aria-hidden="true" tabindex="-1"></a><span class="in">  # Obtener los índices para el pliegue externo actual</span></span>
<span id="cb168-2673"><a href="#cb168-2673" aria-hidden="true" tabindex="-1"></a><span class="in">  test_indices_outer &lt;- indices[folds_outer==i_outer]  # Índices correspondientes al pliegue externo de test</span></span>
<span id="cb168-2674"><a href="#cb168-2674" aria-hidden="true" tabindex="-1"></a><span class="in">  train_indices_outer &lt;- setdiff(1:nrow(data), test_indices_outer)  # Índices correspondientes al conjunto de entrenamiento</span></span>
<span id="cb168-2675"><a href="#cb168-2675" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-2676"><a href="#cb168-2676" aria-hidden="true" tabindex="-1"></a><span class="in">  # Dividir datos en entrenamiento y test para el pliegue externo</span></span>
<span id="cb168-2677"><a href="#cb168-2677" aria-hidden="true" tabindex="-1"></a><span class="in">  datos_entrenamiento_outer &lt;- data[train_indices_outer, ]</span></span>
<span id="cb168-2678"><a href="#cb168-2678" aria-hidden="true" tabindex="-1"></a><span class="in">  datos_test_outer &lt;- data[test_indices_outer, ]</span></span>
<span id="cb168-2679"><a href="#cb168-2679" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-2680"><a href="#cb168-2680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2681"><a href="#cb168-2681" aria-hidden="true" tabindex="-1"></a><span class="in">  # Configurar la validación cruzada interna</span></span>
<span id="cb168-2682"><a href="#cb168-2682" aria-hidden="true" tabindex="-1"></a><span class="in">  folds_inner &lt;- createFolds(datos_entrenamiento_outer$ESTADO_ACTUAL, k = k_inner, list = FALSE)  # Obtener índices de pliegues internos</span></span>
<span id="cb168-2683"><a href="#cb168-2683" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-2684"><a href="#cb168-2684" aria-hidden="true" tabindex="-1"></a><span class="in">  # Almacenar predicciones y test para formar una curva ROC general</span></span>
<span id="cb168-2685"><a href="#cb168-2685" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_auc &lt;- numeric(nrow(datos_entrenamiento_outer))</span></span>
<span id="cb168-2686"><a href="#cb168-2686" aria-hidden="true" tabindex="-1"></a><span class="in">  targets_auc &lt;- numeric(nrow(datos_entrenamiento_outer))</span></span>
<span id="cb168-2687"><a href="#cb168-2687" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-2688"><a href="#cb168-2688" aria-hidden="true" tabindex="-1"></a><span class="in">  # Iterar sobre cada pliegue interno para selección de modelo</span></span>
<span id="cb168-2689"><a href="#cb168-2689" aria-hidden="true" tabindex="-1"></a><span class="in">  indices_inner &lt;- 1:nrow(datos_entrenamiento_outer)</span></span>
<span id="cb168-2690"><a href="#cb168-2690" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_auc_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-2691"><a href="#cb168-2691" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_sensibilidad_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-2692"><a href="#cb168-2692" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_accuracy_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-2693"><a href="#cb168-2693" aria-hidden="true" tabindex="-1"></a><span class="in">  for (i_inner in 1:k_inner) {</span></span>
<span id="cb168-2694"><a href="#cb168-2694" aria-hidden="true" tabindex="-1"></a><span class="in">    ###############################</span></span>
<span id="cb168-2695"><a href="#cb168-2695" aria-hidden="true" tabindex="-1"></a><span class="in">    #### Aqui el filtrado##########</span></span>
<span id="cb168-2696"><a href="#cb168-2696" aria-hidden="true" tabindex="-1"></a><span class="in">    ###############################</span></span>
<span id="cb168-2697"><a href="#cb168-2697" aria-hidden="true" tabindex="-1"></a><span class="in">    filter_data &lt;- filter_dependency(datos_entrenamiento_outer,"ESTADO_ACTUAL",colnames(datos_entrenamiento_outer),0.05)</span></span>
<span id="cb168-2698"><a href="#cb168-2698" aria-hidden="true" tabindex="-1"></a><span class="in">    if ("ESTADO_ACTUAL.1" %in% colnames(filter_data)) {</span></span>
<span id="cb168-2699"><a href="#cb168-2699" aria-hidden="true" tabindex="-1"></a><span class="in">      filter_data &lt;- filter_data[, !colnames(filter_data) %in% "ESTADO_ACTUAL.1", drop = FALSE]</span></span>
<span id="cb168-2700"><a href="#cb168-2700" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb168-2701"><a href="#cb168-2701" aria-hidden="true" tabindex="-1"></a><span class="in">#con poca variables solo unaa la vez o filtrado o wrapper</span></span>
<span id="cb168-2702"><a href="#cb168-2702" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-2703"><a href="#cb168-2703" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-2704"><a href="#cb168-2704" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-2705"><a href="#cb168-2705" aria-hidden="true" tabindex="-1"></a><span class="in">    # Obtener los índices para el pliegue interno actual</span></span>
<span id="cb168-2706"><a href="#cb168-2706" aria-hidden="true" tabindex="-1"></a><span class="in">    test_indices_inner &lt;- indices_inner[folds_inner==i_inner]  # Índices correspondientes al pliegue interno de test</span></span>
<span id="cb168-2707"><a href="#cb168-2707" aria-hidden="true" tabindex="-1"></a><span class="in">    train_indices_inner &lt;- setdiff(1:nrow(filter_data), test_indices_inner)  # Índices correspondientes al conjunto de entrenamiento interno</span></span>
<span id="cb168-2708"><a href="#cb168-2708" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-2709"><a href="#cb168-2709" aria-hidden="true" tabindex="-1"></a><span class="in">    # Dividir datos en entrenamiento y test para el pliegue interno</span></span>
<span id="cb168-2710"><a href="#cb168-2710" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_entrenamiento_inner &lt;- filter_data[train_indices_inner, ]</span></span>
<span id="cb168-2711"><a href="#cb168-2711" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_validacion &lt;- filter_data[test_indices_inner, ]</span></span>
<span id="cb168-2712"><a href="#cb168-2712" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-2713"><a href="#cb168-2713" aria-hidden="true" tabindex="-1"></a><span class="in"> </span></span>
<span id="cb168-2714"><a href="#cb168-2714" aria-hidden="true" tabindex="-1"></a><span class="in">    # Aplicar oversampling en el conjunto de entrenamiento interno</span></span>
<span id="cb168-2715"><a href="#cb168-2715" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_entrenamiento_oversampled &lt;- ROSE(ESTADO_ACTUAL ~ .,</span></span>
<span id="cb168-2716"><a href="#cb168-2716" aria-hidden="true" tabindex="-1"></a><span class="in">                                            data = datos_entrenamiento_inner,</span></span>
<span id="cb168-2717"><a href="#cb168-2717" aria-hidden="true" tabindex="-1"></a><span class="in">                                            seed = 123,</span></span>
<span id="cb168-2718"><a href="#cb168-2718" aria-hidden="true" tabindex="-1"></a><span class="in">                                            p = 0.28)$data</span></span>
<span id="cb168-2719"><a href="#cb168-2719" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-2720"><a href="#cb168-2720" aria-hidden="true" tabindex="-1"></a><span class="in">        # Definir la fórmula para el modelo</span></span>
<span id="cb168-2721"><a href="#cb168-2721" aria-hidden="true" tabindex="-1"></a><span class="in">    formula &lt;- ESTADO_ACTUAL ~ .</span></span>
<span id="cb168-2722"><a href="#cb168-2722" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-2723"><a href="#cb168-2723" aria-hidden="true" tabindex="-1"></a><span class="in">    # Definir la función para calcular el custom metric</span></span>
<span id="cb168-2724"><a href="#cb168-2724" aria-hidden="true" tabindex="-1"></a><span class="in">    compute_custom_metric &lt;- function(recall, accuracy, sensitivity_weight = 0.8) {</span></span>
<span id="cb168-2725"><a href="#cb168-2725" aria-hidden="true" tabindex="-1"></a><span class="in">      custom_metric &lt;- (sensitivity_weight * recall) + ((1 - sensitivity_weight) * accuracy)</span></span>
<span id="cb168-2726"><a href="#cb168-2726" aria-hidden="true" tabindex="-1"></a><span class="in">      return(custom_metric)</span></span>
<span id="cb168-2727"><a href="#cb168-2727" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb168-2728"><a href="#cb168-2728" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-2729"><a href="#cb168-2729" aria-hidden="true" tabindex="-1"></a><span class="in">    # Inicializar variables para almacenar los resultados</span></span>
<span id="cb168-2730"><a href="#cb168-2730" aria-hidden="true" tabindex="-1"></a><span class="in">    mejor_custom_metric &lt;- 0</span></span>
<span id="cb168-2731"><a href="#cb168-2731" aria-hidden="true" tabindex="-1"></a><span class="in">    mejor_modelo &lt;- NULL</span></span>
<span id="cb168-2732"><a href="#cb168-2732" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-2733"><a href="#cb168-2733" aria-hidden="true" tabindex="-1"></a><span class="in">    # Definir hiperparámetros a probar</span></span>
<span id="cb168-2734"><a href="#cb168-2734" aria-hidden="true" tabindex="-1"></a><span class="in">    params &lt;- expand.grid(cost = c(100, 1000, 10000, 50000, 1000000),</span></span>
<span id="cb168-2735"><a href="#cb168-2735" aria-hidden="true" tabindex="-1"></a><span class="in">                          gamma = c(0.1, 1, 10),</span></span>
<span id="cb168-2736"><a href="#cb168-2736" aria-hidden="true" tabindex="-1"></a><span class="in">                          kernel = c("linear", "radial", "sigmoid"))</span></span>
<span id="cb168-2737"><a href="#cb168-2737" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-2738"><a href="#cb168-2738" aria-hidden="true" tabindex="-1"></a><span class="in">    # Bucle para probar diferentes combinaciones de hiperparámetros</span></span>
<span id="cb168-2739"><a href="#cb168-2739" aria-hidden="true" tabindex="-1"></a><span class="in">    for (i in 1:nrow(params)) {</span></span>
<span id="cb168-2740"><a href="#cb168-2740" aria-hidden="true" tabindex="-1"></a><span class="in">      cost &lt;- params$cost[i]</span></span>
<span id="cb168-2741"><a href="#cb168-2741" aria-hidden="true" tabindex="-1"></a><span class="in">      gamma &lt;- params$gamma[i]</span></span>
<span id="cb168-2742"><a href="#cb168-2742" aria-hidden="true" tabindex="-1"></a><span class="in">      kernel &lt;- params$kernel[i]</span></span>
<span id="cb168-2743"><a href="#cb168-2743" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-2744"><a href="#cb168-2744" aria-hidden="true" tabindex="-1"></a><span class="in">      # Entrenar el modelo SVM con la combinación de hiperparámetros actual</span></span>
<span id="cb168-2745"><a href="#cb168-2745" aria-hidden="true" tabindex="-1"></a><span class="in">      modelo &lt;- svm(formula, data = datos_entrenamiento_oversampled, type = "C-classification", kernel = kernel, cost = cost, gamma = gamma, probability = TRUE)</span></span>
<span id="cb168-2746"><a href="#cb168-2746" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb168-2747"><a href="#cb168-2747" aria-hidden="true" tabindex="-1"></a><span class="in">      # Realizar predicciones con probabilidades en datos de validación</span></span>
<span id="cb168-2748"><a href="#cb168-2748" aria-hidden="true" tabindex="-1"></a><span class="in">      predicciones_validacion &lt;- predict(modelo, newdata = datos_validacion, probability = TRUE)</span></span>
<span id="cb168-2749"><a href="#cb168-2749" aria-hidden="true" tabindex="-1"></a><span class="in">      predicciones_validacion_prob &lt;- attr(predicciones_validacion, "probabilities")[, "SI"]  # Asumiendo que "SI" es la clase positiva</span></span>
<span id="cb168-2750"><a href="#cb168-2750" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb168-2751"><a href="#cb168-2751" aria-hidden="true" tabindex="-1"></a><span class="in">      # Calcular las predicciones finales basadas en probabilidades</span></span>
<span id="cb168-2752"><a href="#cb168-2752" aria-hidden="true" tabindex="-1"></a><span class="in">      umbral &lt;- 0.5</span></span>
<span id="cb168-2753"><a href="#cb168-2753" aria-hidden="true" tabindex="-1"></a><span class="in">      predicciones_finales &lt;- ifelse(predicciones_validacion_prob &gt;= umbral, "SI", "NO")</span></span>
<span id="cb168-2754"><a href="#cb168-2754" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb168-2755"><a href="#cb168-2755" aria-hidden="true" tabindex="-1"></a><span class="in">      # Calcular la sensibilidad y la precisión</span></span>
<span id="cb168-2756"><a href="#cb168-2756" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- sum(predicciones_finales == "SI" &amp; datos_validacion[["ESTADO_ACTUAL"]] == "SI")</span></span>
<span id="cb168-2757"><a href="#cb168-2757" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- sum(predicciones_finales == "NO" &amp; datos_validacion[["ESTADO_ACTUAL"]] == "SI")</span></span>
<span id="cb168-2758"><a href="#cb168-2758" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- sum(predicciones_finales == "SI" &amp; datos_validacion[["ESTADO_ACTUAL"]] == "NO")</span></span>
<span id="cb168-2759"><a href="#cb168-2759" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- sum(predicciones_finales == "NO" &amp; datos_validacion[["ESTADO_ACTUAL"]] == "NO")</span></span>
<span id="cb168-2760"><a href="#cb168-2760" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb168-2761"><a href="#cb168-2761" aria-hidden="true" tabindex="-1"></a><span class="in">      recall_actual &lt;- TP / (TP + FN)</span></span>
<span id="cb168-2762"><a href="#cb168-2762" aria-hidden="true" tabindex="-1"></a><span class="in">      accuracy_actual &lt;- (TP + TN) / (TP + FN + FP + TN)</span></span>
<span id="cb168-2763"><a href="#cb168-2763" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb168-2764"><a href="#cb168-2764" aria-hidden="true" tabindex="-1"></a><span class="in">      # Calcular el custom metric para la combinación actual</span></span>
<span id="cb168-2765"><a href="#cb168-2765" aria-hidden="true" tabindex="-1"></a><span class="in">      custom_metric_actual &lt;- compute_custom_metric(recall_actual, accuracy_actual, sensitivity_weight)</span></span>
<span id="cb168-2766"><a href="#cb168-2766" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb168-2767"><a href="#cb168-2767" aria-hidden="true" tabindex="-1"></a><span class="in">      # Actualizar el mejor modelo y su rendimiento si se encuentra un modelo mejor</span></span>
<span id="cb168-2768"><a href="#cb168-2768" aria-hidden="true" tabindex="-1"></a><span class="in">      if (custom_metric_actual &gt; mejor_custom_metric) {</span></span>
<span id="cb168-2769"><a href="#cb168-2769" aria-hidden="true" tabindex="-1"></a><span class="in">        mejor_custom_metric &lt;- custom_metric_actual</span></span>
<span id="cb168-2770"><a href="#cb168-2770" aria-hidden="true" tabindex="-1"></a><span class="in">        mejor_modelo &lt;- modelo</span></span>
<span id="cb168-2771"><a href="#cb168-2771" aria-hidden="true" tabindex="-1"></a><span class="in">      }</span></span>
<span id="cb168-2772"><a href="#cb168-2772" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb168-2773"><a href="#cb168-2773" aria-hidden="true" tabindex="-1"></a><span class="in">    ########################</span></span>
<span id="cb168-2774"><a href="#cb168-2774" aria-hidden="true" tabindex="-1"></a><span class="in">    # Calcular las predicciones para el conjunto de test</span></span>
<span id="cb168-2775"><a href="#cb168-2775" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_test &lt;- predict(mejor_modelo, newdata = datos_test, probability = TRUE)</span></span>
<span id="cb168-2776"><a href="#cb168-2776" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_test &lt;- attr(predicciones_test, "probabilities")[, "SI"]  # Asumiendo que "SI" es la clase positiva</span></span>
<span id="cb168-2777"><a href="#cb168-2777" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-2778"><a href="#cb168-2778" aria-hidden="true" tabindex="-1"></a><span class="in">    ###########################</span></span>
<span id="cb168-2779"><a href="#cb168-2779" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-2780"><a href="#cb168-2780" aria-hidden="true" tabindex="-1"></a><span class="in">    # Realizar predicciones en el conjunto de entrenamiento externo para el AUC general</span></span>
<span id="cb168-2781"><a href="#cb168-2781" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_auc[test_indices_inner] &lt;- predicciones_test</span></span>
<span id="cb168-2782"><a href="#cb168-2782" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_clasificadas &lt;- ifelse(predicciones_auc[test_indices_inner] &gt;= 0.5, "SI", "NO")</span></span>
<span id="cb168-2783"><a href="#cb168-2783" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-2784"><a href="#cb168-2784" aria-hidden="true" tabindex="-1"></a><span class="in">    resultados_sensibilidad_inner[i_inner] &lt;- sum(clases_predichas_test == "SI" &amp; datos_validacion[["ESTADO_ACTUAL"]] == "SI") / sum(datos_validacion[["ESTADO_ACTUAL"]] == "SI")</span></span>
<span id="cb168-2785"><a href="#cb168-2785" aria-hidden="true" tabindex="-1"></a><span class="in">    resultados_accuracy_inner[i_inner] &lt;- mean(clases_predichas_test == datos_validacion[["ESTADO_ACTUAL"]])</span></span>
<span id="cb168-2786"><a href="#cb168-2786" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2787"><a href="#cb168-2787" aria-hidden="true" tabindex="-1"></a><span class="in">    targets_auc[test_indices_inner] &lt;- as.numeric(datos_validacion$ESTADO_ACTUAL) - 1</span></span>
<span id="cb168-2788"><a href="#cb168-2788" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2789"><a href="#cb168-2789" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb168-2790"><a href="#cb168-2790" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-2791"><a href="#cb168-2791" aria-hidden="true" tabindex="-1"></a><span class="in">  # Calcular el AUC final para este fold externo</span></span>
<span id="cb168-2792"><a href="#cb168-2792" aria-hidden="true" tabindex="-1"></a><span class="in">  auc_fold_externo &lt;- pROC::roc(targets_auc, predicciones_auc)$auc</span></span>
<span id="cb168-2793"><a href="#cb168-2793" aria-hidden="true" tabindex="-1"></a><span class="in">  accuracy_fold_externo &lt;- mean(resultados_accuracy_inner)</span></span>
<span id="cb168-2794"><a href="#cb168-2794" aria-hidden="true" tabindex="-1"></a><span class="in">  sensibilidad_fold_externo &lt;- mean(resultados_sensibilidad_inner)</span></span>
<span id="cb168-2795"><a href="#cb168-2795" aria-hidden="true" tabindex="-1"></a><span class="in"> </span></span>
<span id="cb168-2796"><a href="#cb168-2796" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-2797"><a href="#cb168-2797" aria-hidden="true" tabindex="-1"></a><span class="in">  # Almacenar el AUC del fold externo actual</span></span>
<span id="cb168-2798"><a href="#cb168-2798" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_auc[i_outer] &lt;- auc_fold_externo</span></span>
<span id="cb168-2799"><a href="#cb168-2799" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_accuracy[i_outer] &lt;- accuracy_fold_externo</span></span>
<span id="cb168-2800"><a href="#cb168-2800" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_sensibilidad[i_outer] &lt;- sensibilidad_fold_externo</span></span>
<span id="cb168-2801"><a href="#cb168-2801" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-2802"><a href="#cb168-2802" aria-hidden="true" tabindex="-1"></a><span class="in">  # Predecir en los datos de test para este pliegue externo y almacenar predicciones</span></span>
<span id="cb168-2803"><a href="#cb168-2803" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_test &lt;- predict(mejor_modelo, newdata = datos_test_outer, probability = TRUE)</span></span>
<span id="cb168-2804"><a href="#cb168-2804" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_totales[test_indices_outer, i_outer] &lt;- predicciones_test</span></span>
<span id="cb168-2805"><a href="#cb168-2805" aria-hidden="true" tabindex="-1"></a><span class="in">  targets_totales[test_indices_outer] &lt;- as.numeric(datos_test_outer$ESTADO_ACTUAL) - 1</span></span>
<span id="cb168-2806"><a href="#cb168-2806" aria-hidden="true" tabindex="-1"></a><span class="in"> </span></span>
<span id="cb168-2807"><a href="#cb168-2807" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb168-2808"><a href="#cb168-2808" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2809"><a href="#cb168-2809" aria-hidden="true" tabindex="-1"></a><span class="in"># Calcular AUC promedio</span></span>
<span id="cb168-2810"><a href="#cb168-2810" aria-hidden="true" tabindex="-1"></a><span class="in">auc_promedio &lt;- mean(resultados_auc)</span></span>
<span id="cb168-2811"><a href="#cb168-2811" aria-hidden="true" tabindex="-1"></a><span class="in">accuracy_promedio &lt;- mean(resultados_accuracy)</span></span>
<span id="cb168-2812"><a href="#cb168-2812" aria-hidden="true" tabindex="-1"></a><span class="in">sensibilidad_promedio &lt;- mean(resultados_sensibilidad)</span></span>
<span id="cb168-2813"><a href="#cb168-2813" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2814"><a href="#cb168-2814" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2815"><a href="#cb168-2815" aria-hidden="true" tabindex="-1"></a><span class="in"># Crear tabla con todas las métricas</span></span>
<span id="cb168-2816"><a href="#cb168-2816" aria-hidden="true" tabindex="-1"></a><span class="in">tabla_metricas &lt;- data.frame(</span></span>
<span id="cb168-2817"><a href="#cb168-2817" aria-hidden="true" tabindex="-1"></a><span class="in">  Pliegue = 1:k_outer,</span></span>
<span id="cb168-2818"><a href="#cb168-2818" aria-hidden="true" tabindex="-1"></a><span class="in">  AUC = sapply(resultados_auc, round, digits = 3),</span></span>
<span id="cb168-2819"><a href="#cb168-2819" aria-hidden="true" tabindex="-1"></a><span class="in">  Accuracy = sapply(resultados_accuracy, round, digits = 3),</span></span>
<span id="cb168-2820"><a href="#cb168-2820" aria-hidden="true" tabindex="-1"></a><span class="in">  Recall = sapply(resultados_sensibilidad, round, digits = 3)</span></span>
<span id="cb168-2821"><a href="#cb168-2821" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb168-2822"><a href="#cb168-2822" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2823"><a href="#cb168-2823" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2824"><a href="#cb168-2824" aria-hidden="true" tabindex="-1"></a><span class="in"># Agregar fila con promedio de métricas</span></span>
<span id="cb168-2825"><a href="#cb168-2825" aria-hidden="true" tabindex="-1"></a><span class="in">tabla_metricas_svm_filter &lt;- rbind(tabla_metricas, c("Mean", round(auc_promedio,3), round(accuracy_promedio,3), round(sensibilidad_promedio,3)))</span></span>
<span id="cb168-2826"><a href="#cb168-2826" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2827"><a href="#cb168-2827" aria-hidden="true" tabindex="-1"></a><span class="in">end_time &lt;- Sys.time()</span></span>
<span id="cb168-2828"><a href="#cb168-2828" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time_svm_filter &lt;- end_time - start_time</span></span>
<span id="cb168-2829"><a href="#cb168-2829" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time_svm_filter &lt;- as.numeric(execution_time_svm_filter, units = "secs")</span></span>
<span id="cb168-2830"><a href="#cb168-2830" aria-hidden="true" tabindex="-1"></a><span class="in">save(tabla_metricas_svm_filter, file = "tabla_metricas_svm_filter.RData")</span></span>
<span id="cb168-2831"><a href="#cb168-2831" aria-hidden="true" tabindex="-1"></a><span class="in">save(execution_time_svm_filter, file = "execution_time_svm_filter.RData")</span></span>
<span id="cb168-2832"><a href="#cb168-2832" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-2833"><a href="#cb168-2833" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2836"><a href="#cb168-2836" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-2837"><a href="#cb168-2837" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"tabla_metricas_svm_filter.RData"</span>)</span>
<span id="cb168-2838"><a href="#cb168-2838" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"execution_time_svm_filter.RData"</span>)</span>
<span id="cb168-2839"><a href="#cb168-2839" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2840"><a href="#cb168-2840" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time_svm_filter,  <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb168-2841"><a href="#cb168-2841" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-2842"><a href="#cb168-2842" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2843"><a href="#cb168-2843" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb168-2844"><a href="#cb168-2844" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2845"><a href="#cb168-2845" aria-hidden="true" tabindex="-1"></a><span class="fu"># Metrics Table</span></span>
<span id="cb168-2848"><a href="#cb168-2848" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-2849"><a href="#cb168-2849" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir tabla formateada con kableExtra</span></span>
<span id="cb168-2850"><a href="#cb168-2850" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(tabla_metricas_svm_filter, <span class="at">caption =</span> <span class="st">"Cross Validation Metrics"</span>, <span class="at">align =</span> <span class="st">"c"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb168-2851"><a href="#cb168-2851" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb168-2852"><a href="#cb168-2852" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-2853"><a href="#cb168-2853" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2854"><a href="#cb168-2854" aria-hidden="true" tabindex="-1"></a><span class="fu"># Metrics Plot</span></span>
<span id="cb168-2857"><a href="#cb168-2857" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-2858"><a href="#cb168-2858" aria-hidden="true" tabindex="-1"></a><span class="fu">crear_plot_metricas_per_fold</span>(tabla_metricas_svm_filter)</span>
<span id="cb168-2859"><a href="#cb168-2859" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2860"><a href="#cb168-2860" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-2861"><a href="#cb168-2861" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb168-2862"><a href="#cb168-2862" aria-hidden="true" tabindex="-1"></a>As we suspected the model is not robust and the metrics are not good. To avoid unnecesary complexity we are not going to implement any variable selection technique since the model does not have a good performance.</span>
<span id="cb168-2863"><a href="#cb168-2863" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2864"><a href="#cb168-2864" aria-hidden="true" tabindex="-1"></a><span class="fu">## Hyperparameters Resume</span></span>
<span id="cb168-2865"><a href="#cb168-2865" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2866"><a href="#cb168-2866" aria-hidden="true" tabindex="-1"></a>This is a resume of the model performance with every hyperparameters combination. The next table shows the top 10 and bottom 10 models by AUC.</span>
<span id="cb168-2867"><a href="#cb168-2867" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2868"><a href="#cb168-2868" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,message=FALSE,warning=FALSE,eval=FALSE}</span></span>
<span id="cb168-2869"><a href="#cb168-2869" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2870"><a href="#cb168-2870" aria-hidden="true" tabindex="-1"></a><span class="in">start_time &lt;- Sys.time()</span></span>
<span id="cb168-2871"><a href="#cb168-2871" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2872"><a href="#cb168-2872" aria-hidden="true" tabindex="-1"></a><span class="in"># Dividir el conjunto de datos en entrenamiento y test</span></span>
<span id="cb168-2873"><a href="#cb168-2873" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(123)  # Establecer una semilla para reproducibilidad</span></span>
<span id="cb168-2874"><a href="#cb168-2874" aria-hidden="true" tabindex="-1"></a><span class="in">indices_entrenamiento &lt;- sample(nrow(data), 0.75 * nrow(data))  # 75% para entrenamiento</span></span>
<span id="cb168-2875"><a href="#cb168-2875" aria-hidden="true" tabindex="-1"></a><span class="in">datos_entrenamiento &lt;- data[indices_entrenamiento, ]</span></span>
<span id="cb168-2876"><a href="#cb168-2876" aria-hidden="true" tabindex="-1"></a><span class="in">datos_test &lt;- data[-indices_entrenamiento, ]</span></span>
<span id="cb168-2877"><a href="#cb168-2877" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2878"><a href="#cb168-2878" aria-hidden="true" tabindex="-1"></a><span class="in"># Dividir datos de entrenamiento en entrenamiento y validación</span></span>
<span id="cb168-2879"><a href="#cb168-2879" aria-hidden="true" tabindex="-1"></a><span class="in">train_indices &lt;- sample(nrow(datos_entrenamiento), 0.8 * nrow(datos_entrenamiento))  # 80% para entrenamiento</span></span>
<span id="cb168-2880"><a href="#cb168-2880" aria-hidden="true" tabindex="-1"></a><span class="in">datos_entrenamiento_split &lt;- datos_entrenamiento[train_indices, ]</span></span>
<span id="cb168-2881"><a href="#cb168-2881" aria-hidden="true" tabindex="-1"></a><span class="in">datos_validacion &lt;- datos_entrenamiento[-train_indices, ]</span></span>
<span id="cb168-2882"><a href="#cb168-2882" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2883"><a href="#cb168-2883" aria-hidden="true" tabindex="-1"></a><span class="in"># Oversampling</span></span>
<span id="cb168-2884"><a href="#cb168-2884" aria-hidden="true" tabindex="-1"></a><span class="in">proportion &lt;- 0.28</span></span>
<span id="cb168-2885"><a href="#cb168-2885" aria-hidden="true" tabindex="-1"></a><span class="in">datos_entrenamiento_oversampled &lt;- ROSE(ESTADO_ACTUAL ~ ., data = datos_entrenamiento_split, p = proportion, seed = 123)$data</span></span>
<span id="cb168-2886"><a href="#cb168-2886" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2887"><a href="#cb168-2887" aria-hidden="true" tabindex="-1"></a><span class="in"># Inicializar variables para almacenar los resultados</span></span>
<span id="cb168-2888"><a href="#cb168-2888" aria-hidden="true" tabindex="-1"></a><span class="in">mejor_auc &lt;- 0</span></span>
<span id="cb168-2889"><a href="#cb168-2889" aria-hidden="true" tabindex="-1"></a><span class="in">mejor_modelo &lt;- NULL</span></span>
<span id="cb168-2890"><a href="#cb168-2890" aria-hidden="true" tabindex="-1"></a><span class="in">resultados &lt;- data.frame(kernel = character(), cost = numeric(), gamma = numeric(), auc = numeric(), stringsAsFactors = FALSE)</span></span>
<span id="cb168-2891"><a href="#cb168-2891" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2892"><a href="#cb168-2892" aria-hidden="true" tabindex="-1"></a><span class="in"># Definir hiperparámetros a probar</span></span>
<span id="cb168-2893"><a href="#cb168-2893" aria-hidden="true" tabindex="-1"></a><span class="in">params &lt;- expand.grid(cost = c(100, 1000, 10000, 50000, 1000000),</span></span>
<span id="cb168-2894"><a href="#cb168-2894" aria-hidden="true" tabindex="-1"></a><span class="in">                      gamma = c(0.1, 1, 10),</span></span>
<span id="cb168-2895"><a href="#cb168-2895" aria-hidden="true" tabindex="-1"></a><span class="in">                      kernel = c("linear", "radial", "sigmoid"))</span></span>
<span id="cb168-2896"><a href="#cb168-2896" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2897"><a href="#cb168-2897" aria-hidden="true" tabindex="-1"></a><span class="in"># Bucle para probar diferentes combinaciones de hiperparámetros</span></span>
<span id="cb168-2898"><a href="#cb168-2898" aria-hidden="true" tabindex="-1"></a><span class="in">for (i in 1:nrow(params)) {</span></span>
<span id="cb168-2899"><a href="#cb168-2899" aria-hidden="true" tabindex="-1"></a><span class="in">  cost &lt;- params$cost[i]</span></span>
<span id="cb168-2900"><a href="#cb168-2900" aria-hidden="true" tabindex="-1"></a><span class="in">  gamma &lt;- params$gamma[i]</span></span>
<span id="cb168-2901"><a href="#cb168-2901" aria-hidden="true" tabindex="-1"></a><span class="in">  kernel &lt;- params$kernel[i]</span></span>
<span id="cb168-2902"><a href="#cb168-2902" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2903"><a href="#cb168-2903" aria-hidden="true" tabindex="-1"></a><span class="in">  # Entrenar el modelo SVM con la combinación de hiperparámetros actual</span></span>
<span id="cb168-2904"><a href="#cb168-2904" aria-hidden="true" tabindex="-1"></a><span class="in">  modelo &lt;- svm(ESTADO_ACTUAL ~ ., data = datos_entrenamiento_oversampled, type = "C-classification", kernel = kernel, cost = cost, gamma = gamma, probability = TRUE)</span></span>
<span id="cb168-2905"><a href="#cb168-2905" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2906"><a href="#cb168-2906" aria-hidden="true" tabindex="-1"></a><span class="in">  # Realizar predicciones en datos de prueba</span></span>
<span id="cb168-2907"><a href="#cb168-2907" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_test &lt;- predict(modelo, newdata = datos_test, probability = TRUE)</span></span>
<span id="cb168-2908"><a href="#cb168-2908" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-2909"><a href="#cb168-2909" aria-hidden="true" tabindex="-1"></a><span class="in">  # Calcular AUC para la combinación actual en datos de prueba</span></span>
<span id="cb168-2910"><a href="#cb168-2910" aria-hidden="true" tabindex="-1"></a><span class="in">  roc_obj &lt;- roc(ifelse(datos_test$ESTADO_ACTUAL == "SI", 1, 0), attr(predicciones_test, "probabilities")[, 2])</span></span>
<span id="cb168-2911"><a href="#cb168-2911" aria-hidden="true" tabindex="-1"></a><span class="in">  auc_actual &lt;- as.numeric(auc(roc_obj))  # Extraer el valor numérico del AUC</span></span>
<span id="cb168-2912"><a href="#cb168-2912" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-2913"><a href="#cb168-2913" aria-hidden="true" tabindex="-1"></a><span class="in">  # Guardar los resultados en la tabla</span></span>
<span id="cb168-2914"><a href="#cb168-2914" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados &lt;- resultados %&gt;%</span></span>
<span id="cb168-2915"><a href="#cb168-2915" aria-hidden="true" tabindex="-1"></a><span class="in">    add_row(kernel = kernel, cost = cost, gamma = gamma, auc = auc_actual)</span></span>
<span id="cb168-2916"><a href="#cb168-2916" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-2917"><a href="#cb168-2917" aria-hidden="true" tabindex="-1"></a><span class="in">  # Actualizar el mejor modelo y su AUC si se encuentra un modelo mejor</span></span>
<span id="cb168-2918"><a href="#cb168-2918" aria-hidden="true" tabindex="-1"></a><span class="in">  if (auc_actual &gt; mejor_auc) {</span></span>
<span id="cb168-2919"><a href="#cb168-2919" aria-hidden="true" tabindex="-1"></a><span class="in">    mejor_auc &lt;- auc_actual</span></span>
<span id="cb168-2920"><a href="#cb168-2920" aria-hidden="true" tabindex="-1"></a><span class="in">    mejor_modelo &lt;- modelo</span></span>
<span id="cb168-2921"><a href="#cb168-2921" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb168-2922"><a href="#cb168-2922" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb168-2923"><a href="#cb168-2923" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2924"><a href="#cb168-2924" aria-hidden="true" tabindex="-1"></a><span class="in"># Ordenar los resultados por AUC en orden descendente</span></span>
<span id="cb168-2925"><a href="#cb168-2925" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_ordenados_svm &lt;- resultados %&gt;% arrange(desc(auc))</span></span>
<span id="cb168-2926"><a href="#cb168-2926" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2927"><a href="#cb168-2927" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2928"><a href="#cb168-2928" aria-hidden="true" tabindex="-1"></a><span class="in"># Mostrar la tabla con los resultados de todas las combinaciones de hiperparámetros</span></span>
<span id="cb168-2929"><a href="#cb168-2929" aria-hidden="true" tabindex="-1"></a><span class="in">save(resultados_ordenados_svm, file = "resultados_ordenados_svm.RData")</span></span>
<span id="cb168-2930"><a href="#cb168-2930" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2931"><a href="#cb168-2931" aria-hidden="true" tabindex="-1"></a><span class="in">end_time &lt;- Sys.time()</span></span>
<span id="cb168-2932"><a href="#cb168-2932" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2933"><a href="#cb168-2933" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-2934"><a href="#cb168-2934" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2937"><a href="#cb168-2937" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-2938"><a href="#cb168-2938" aria-hidden="true" tabindex="-1"></a><span class="co"># Cargar los datos guardados y mostrar las tablas</span></span>
<span id="cb168-2939"><a href="#cb168-2939" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"resultados_ordenados_svm.RData"</span>)</span>
<span id="cb168-2940"><a href="#cb168-2940" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2941"><a href="#cb168-2941" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2942"><a href="#cb168-2942" aria-hidden="true" tabindex="-1"></a><span class="co"># Seleccionar los mejores 10 modelos</span></span>
<span id="cb168-2943"><a href="#cb168-2943" aria-hidden="true" tabindex="-1"></a>mejores_10 <span class="ot">&lt;-</span> resultados_ordenados_svm <span class="sc">%&gt;%</span> <span class="fu">head</span>(<span class="dv">10</span>)</span>
<span id="cb168-2944"><a href="#cb168-2944" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2945"><a href="#cb168-2945" aria-hidden="true" tabindex="-1"></a><span class="co"># Seleccionar los peores 10 modelos</span></span>
<span id="cb168-2946"><a href="#cb168-2946" aria-hidden="true" tabindex="-1"></a>peores_10 <span class="ot">&lt;-</span> resultados_ordenados_svm <span class="sc">%&gt;%</span> <span class="fu">tail</span>(<span class="dv">10</span>)</span>
<span id="cb168-2947"><a href="#cb168-2947" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2948"><a href="#cb168-2948" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir los mejores y peores modelos en tablas bonitas</span></span>
<span id="cb168-2949"><a href="#cb168-2949" aria-hidden="true" tabindex="-1"></a>mejores_10 <span class="sc">%&gt;%</span></span>
<span id="cb168-2950"><a href="#cb168-2950" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">caption =</span> <span class="st">"Top 10 Models by AUC"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb168-2951"><a href="#cb168-2951" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>, <span class="st">"condensed"</span>, <span class="st">"responsive"</span>))</span>
<span id="cb168-2952"><a href="#cb168-2952" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2953"><a href="#cb168-2953" aria-hidden="true" tabindex="-1"></a>peores_10 <span class="sc">%&gt;%</span></span>
<span id="cb168-2954"><a href="#cb168-2954" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">caption =</span> <span class="st">"Bottom 10 Models by AUC"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb168-2955"><a href="#cb168-2955" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>, <span class="st">"condensed"</span>, <span class="st">"responsive"</span>))</span>
<span id="cb168-2956"><a href="#cb168-2956" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2957"><a href="#cb168-2957" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-2958"><a href="#cb168-2958" aria-hidden="true" tabindex="-1"></a>It seem that the best models have a cost of 100 and a gamma of 0.1. But the most importatnt hyperparameter is linear kernel. These performance measuraments are extremely optimistic and do not correspond to the real performance of the model but it can help us to understand the hyperparameters impact on the model. We have to ve careful with some hyperparameters that can lead to overfitting.</span>
<span id="cb168-2959"><a href="#cb168-2959" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2962"><a href="#cb168-2962" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-2963"><a href="#cb168-2963" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(plotly)</span>
<span id="cb168-2964"><a href="#cb168-2964" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2965"><a href="#cb168-2965" aria-hidden="true" tabindex="-1"></a><span class="co"># Cargar los resultados</span></span>
<span id="cb168-2966"><a href="#cb168-2966" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"resultados_ordenados_svm.RData"</span>)</span>
<span id="cb168-2967"><a href="#cb168-2967" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2968"><a href="#cb168-2968" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear la gráfica 3D con plotly</span></span>
<span id="cb168-2969"><a href="#cb168-2969" aria-hidden="true" tabindex="-1"></a>fig <span class="ot">&lt;-</span> <span class="fu">plot_ly</span>(</span>
<span id="cb168-2970"><a href="#cb168-2970" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> resultados_ordenados_svm,</span>
<span id="cb168-2971"><a href="#cb168-2971" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> <span class="sc">~</span>cost,</span>
<span id="cb168-2972"><a href="#cb168-2972" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> <span class="sc">~</span>gamma,</span>
<span id="cb168-2973"><a href="#cb168-2973" aria-hidden="true" tabindex="-1"></a>  <span class="at">z =</span> <span class="sc">~</span>auc,</span>
<span id="cb168-2974"><a href="#cb168-2974" aria-hidden="true" tabindex="-1"></a>  <span class="at">color =</span> <span class="sc">~</span>kernel,</span>
<span id="cb168-2975"><a href="#cb168-2975" aria-hidden="true" tabindex="-1"></a>  <span class="at">colors =</span> <span class="fu">c</span>(<span class="st">"#3C5B6F"</span>, <span class="st">"steelblue"</span>, <span class="st">"lightblue"</span>),</span>
<span id="cb168-2976"><a href="#cb168-2976" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"scatter3d"</span>,</span>
<span id="cb168-2977"><a href="#cb168-2977" aria-hidden="true" tabindex="-1"></a>  <span class="at">mode =</span> <span class="st">"markers"</span>,</span>
<span id="cb168-2978"><a href="#cb168-2978" aria-hidden="true" tabindex="-1"></a>  <span class="at">marker =</span> <span class="fu">list</span>(<span class="at">size =</span> <span class="dv">5</span>)</span>
<span id="cb168-2979"><a href="#cb168-2979" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb168-2980"><a href="#cb168-2980" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2981"><a href="#cb168-2981" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2982"><a href="#cb168-2982" aria-hidden="true" tabindex="-1"></a>fig <span class="ot">&lt;-</span> fig <span class="sc">%&gt;%</span></span>
<span id="cb168-2983"><a href="#cb168-2983" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layout</span>(</span>
<span id="cb168-2984"><a href="#cb168-2984" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"AUC for every combination of hyperparameters"</span>,</span>
<span id="cb168-2985"><a href="#cb168-2985" aria-hidden="true" tabindex="-1"></a>    <span class="at">scene =</span> <span class="fu">list</span>(</span>
<span id="cb168-2986"><a href="#cb168-2986" aria-hidden="true" tabindex="-1"></a>      <span class="at">xaxis =</span> <span class="fu">list</span>(<span class="at">title =</span> <span class="st">"Cost"</span>, <span class="at">type =</span> <span class="st">"log"</span>),</span>
<span id="cb168-2987"><a href="#cb168-2987" aria-hidden="true" tabindex="-1"></a>      <span class="at">yaxis =</span> <span class="fu">list</span>(<span class="at">title =</span> <span class="st">"Gamma"</span>, <span class="at">type =</span> <span class="st">"log"</span>),</span>
<span id="cb168-2988"><a href="#cb168-2988" aria-hidden="true" tabindex="-1"></a>      <span class="at">zaxis =</span> <span class="fu">list</span>(<span class="at">title =</span> <span class="st">"AUC"</span>)</span>
<span id="cb168-2989"><a href="#cb168-2989" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb168-2990"><a href="#cb168-2990" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb168-2991"><a href="#cb168-2991" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2992"><a href="#cb168-2992" aria-hidden="true" tabindex="-1"></a><span class="co"># Mostrar la gráfica</span></span>
<span id="cb168-2993"><a href="#cb168-2993" aria-hidden="true" tabindex="-1"></a>fig</span>
<span id="cb168-2994"><a href="#cb168-2994" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2995"><a href="#cb168-2995" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-2996"><a href="#cb168-2996" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2997"><a href="#cb168-2997" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb168-2998"><a href="#cb168-2998" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-2999"><a href="#cb168-2999" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3000"><a href="#cb168-3000" aria-hidden="true" tabindex="-1"></a><span class="fu"># Decision tree {#decision-tree}</span></span>
<span id="cb168-3001"><a href="#cb168-3001" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3002"><a href="#cb168-3002" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset style="background-color: #f0f0f0;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;"}</span>
<span id="cb168-3003"><a href="#cb168-3003" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3004"><a href="#cb168-3004" aria-hidden="true" tabindex="-1"></a><span class="fu">## Hold out</span></span>
<span id="cb168-3005"><a href="#cb168-3005" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3006"><a href="#cb168-3006" aria-hidden="true" tabindex="-1"></a>In this section we are going to build a decision tree model using different hyperparameters like cp, minsplit and minbucket and evaluate it using a hold out validation.</span>
<span id="cb168-3007"><a href="#cb168-3007" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3010"><a href="#cb168-3010" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-3011"><a href="#cb168-3011" aria-hidden="true" tabindex="-1"></a><span class="co"># Iniciar tiempo de ejecución</span></span>
<span id="cb168-3012"><a href="#cb168-3012" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb168-3013"><a href="#cb168-3013" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3014"><a href="#cb168-3014" aria-hidden="true" tabindex="-1"></a><span class="co"># Parámetros a cambiar</span></span>
<span id="cb168-3015"><a href="#cb168-3015" aria-hidden="true" tabindex="-1"></a>proportion <span class="ot">&lt;-</span> <span class="fl">0.28</span></span>
<span id="cb168-3016"><a href="#cb168-3016" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3017"><a href="#cb168-3017" aria-hidden="true" tabindex="-1"></a><span class="co"># Dividir el conjunto de datos en entrenamiento y test</span></span>
<span id="cb168-3018"><a href="#cb168-3018" aria-hidden="true" tabindex="-1"></a>indices_entrenamiento <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(data), <span class="fl">0.75</span> <span class="sc">*</span> <span class="fu">nrow</span>(data))  <span class="co"># 75% para entrenamiento</span></span>
<span id="cb168-3019"><a href="#cb168-3019" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento <span class="ot">&lt;-</span> data[indices_entrenamiento, ]</span>
<span id="cb168-3020"><a href="#cb168-3020" aria-hidden="true" tabindex="-1"></a>datos_test <span class="ot">&lt;-</span> data[<span class="sc">-</span>indices_entrenamiento, ]</span>
<span id="cb168-3021"><a href="#cb168-3021" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3022"><a href="#cb168-3022" aria-hidden="true" tabindex="-1"></a><span class="co"># Dividir datos de entrenamiento en entrenamiento y validación</span></span>
<span id="cb168-3023"><a href="#cb168-3023" aria-hidden="true" tabindex="-1"></a>train_indices <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(datos_entrenamiento), <span class="fl">0.8</span> <span class="sc">*</span> <span class="fu">nrow</span>(datos_entrenamiento))  <span class="co"># 80% para entrenamiento</span></span>
<span id="cb168-3024"><a href="#cb168-3024" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento_split <span class="ot">&lt;-</span> datos_entrenamiento[train_indices, ]</span>
<span id="cb168-3025"><a href="#cb168-3025" aria-hidden="true" tabindex="-1"></a>datos_validacion <span class="ot">&lt;-</span> datos_entrenamiento[<span class="sc">-</span>train_indices, ]</span>
<span id="cb168-3026"><a href="#cb168-3026" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3027"><a href="#cb168-3027" aria-hidden="true" tabindex="-1"></a><span class="co"># Sobremuestrear los datos de entrenamiento</span></span>
<span id="cb168-3028"><a href="#cb168-3028" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento_oversampled <span class="ot">&lt;-</span> <span class="fu">ROSE</span>(ESTADO_ACTUAL <span class="sc">~</span> ., <span class="at">data =</span> datos_entrenamiento_split, <span class="at">p =</span> proportion)<span class="sc">$</span>data</span>
<span id="cb168-3029"><a href="#cb168-3029" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3030"><a href="#cb168-3030" aria-hidden="true" tabindex="-1"></a><span class="co"># Definir la fórmula para el modelo</span></span>
<span id="cb168-3031"><a href="#cb168-3031" aria-hidden="true" tabindex="-1"></a>formula <span class="ot">&lt;-</span> ESTADO_ACTUAL <span class="sc">~</span> .</span>
<span id="cb168-3032"><a href="#cb168-3032" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3033"><a href="#cb168-3033" aria-hidden="true" tabindex="-1"></a><span class="co"># Inicializar variables para almacenar los resultados</span></span>
<span id="cb168-3034"><a href="#cb168-3034" aria-hidden="true" tabindex="-1"></a>mejor_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb168-3035"><a href="#cb168-3035" aria-hidden="true" tabindex="-1"></a>mejor_modelo <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb168-3036"><a href="#cb168-3036" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3037"><a href="#cb168-3037" aria-hidden="true" tabindex="-1"></a><span class="co"># Definir combinaciones de hiperparámetros a probar</span></span>
<span id="cb168-3038"><a href="#cb168-3038" aria-hidden="true" tabindex="-1"></a>param_grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">cp =</span> <span class="fu">c</span>(<span class="fl">0.01</span>, <span class="fl">0.05</span>, <span class="fl">0.1</span>), </span>
<span id="cb168-3039"><a href="#cb168-3039" aria-hidden="true" tabindex="-1"></a>                          <span class="at">minsplit =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">20</span>), </span>
<span id="cb168-3040"><a href="#cb168-3040" aria-hidden="true" tabindex="-1"></a>                          <span class="at">minbucket =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">20</span>))</span>
<span id="cb168-3041"><a href="#cb168-3041" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3042"><a href="#cb168-3042" aria-hidden="true" tabindex="-1"></a><span class="co"># Bucle para probar diferentes combinaciones de hiperparámetros</span></span>
<span id="cb168-3043"><a href="#cb168-3043" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (params <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(param_grid)) {</span>
<span id="cb168-3044"><a href="#cb168-3044" aria-hidden="true" tabindex="-1"></a>  cp <span class="ot">&lt;-</span> param_grid<span class="sc">$</span>cp[params]</span>
<span id="cb168-3045"><a href="#cb168-3045" aria-hidden="true" tabindex="-1"></a>  minsplit <span class="ot">&lt;-</span> param_grid<span class="sc">$</span>minsplit[params]</span>
<span id="cb168-3046"><a href="#cb168-3046" aria-hidden="true" tabindex="-1"></a>  minbucket <span class="ot">&lt;-</span> param_grid<span class="sc">$</span>minbucket[params]</span>
<span id="cb168-3047"><a href="#cb168-3047" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-3048"><a href="#cb168-3048" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Entrenar el modelo de árbol de decisión con la combinación de hiperparámetros actual</span></span>
<span id="cb168-3049"><a href="#cb168-3049" aria-hidden="true" tabindex="-1"></a>  modelo <span class="ot">&lt;-</span> <span class="fu">rpart</span>(formula, <span class="at">data =</span> datos_entrenamiento_oversampled, </span>
<span id="cb168-3050"><a href="#cb168-3050" aria-hidden="true" tabindex="-1"></a>                  <span class="at">control =</span> <span class="fu">rpart.control</span>(<span class="at">cp =</span> cp, <span class="at">minsplit =</span> minsplit, <span class="at">minbucket =</span> minbucket), </span>
<span id="cb168-3051"><a href="#cb168-3051" aria-hidden="true" tabindex="-1"></a>                  <span class="at">method =</span> <span class="st">"class"</span>)</span>
<span id="cb168-3052"><a href="#cb168-3052" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-3053"><a href="#cb168-3053" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Realizar predicciones en datos de validación</span></span>
<span id="cb168-3054"><a href="#cb168-3054" aria-hidden="true" tabindex="-1"></a>  prob_pred_validacion <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelo, <span class="at">newdata =</span> datos_validacion, <span class="at">type =</span> <span class="st">"prob"</span>)[,<span class="dv">2</span>]</span>
<span id="cb168-3055"><a href="#cb168-3055" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-3056"><a href="#cb168-3056" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular el AUC</span></span>
<span id="cb168-3057"><a href="#cb168-3057" aria-hidden="true" tabindex="-1"></a>  roc_obj <span class="ot">&lt;-</span> <span class="fu">roc</span>(datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]], prob_pred_validacion, <span class="at">levels =</span> <span class="fu">rev</span>(<span class="fu">levels</span>(datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]])))</span>
<span id="cb168-3058"><a href="#cb168-3058" aria-hidden="true" tabindex="-1"></a>  auc_actual <span class="ot">&lt;-</span> <span class="fu">auc</span>(roc_obj)</span>
<span id="cb168-3059"><a href="#cb168-3059" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-3060"><a href="#cb168-3060" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Actualizar el mejor modelo y su rendimiento si se encuentra un modelo mejor</span></span>
<span id="cb168-3061"><a href="#cb168-3061" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (auc_actual <span class="sc">&gt;</span> mejor_auc) {</span>
<span id="cb168-3062"><a href="#cb168-3062" aria-hidden="true" tabindex="-1"></a>    mejor_auc <span class="ot">&lt;-</span> auc_actual</span>
<span id="cb168-3063"><a href="#cb168-3063" aria-hidden="true" tabindex="-1"></a>    mejor_modelo <span class="ot">&lt;-</span> modelo</span>
<span id="cb168-3064"><a href="#cb168-3064" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb168-3065"><a href="#cb168-3065" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb168-3066"><a href="#cb168-3066" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3067"><a href="#cb168-3067" aria-hidden="true" tabindex="-1"></a><span class="co"># Graficar el mejor modelo</span></span>
<span id="cb168-3068"><a href="#cb168-3068" aria-hidden="true" tabindex="-1"></a><span class="fu">rpart.plot</span>(mejor_modelo)</span>
<span id="cb168-3069"><a href="#cb168-3069" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3070"><a href="#cb168-3070" aria-hidden="true" tabindex="-1"></a><span class="co"># Detener el tiempo de ejecución</span></span>
<span id="cb168-3071"><a href="#cb168-3071" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb168-3072"><a href="#cb168-3072" aria-hidden="true" tabindex="-1"></a>execution_time <span class="ot">&lt;-</span> end_time <span class="sc">-</span> start_time</span>
<span id="cb168-3073"><a href="#cb168-3073" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3074"><a href="#cb168-3074" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir el tiempo de ejecución y el mejor AUC</span></span>
<span id="cb168-3075"><a href="#cb168-3075" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time,  <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb168-3076"><a href="#cb168-3076" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3077"><a href="#cb168-3077" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-3078"><a href="#cb168-3078" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb168-3079"><a href="#cb168-3079" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3080"><a href="#cb168-3080" aria-hidden="true" tabindex="-1"></a><span class="fu">### Predictions</span></span>
<span id="cb168-3081"><a href="#cb168-3081" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3082"><a href="#cb168-3082" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3083"><a href="#cb168-3083" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3086"><a href="#cb168-3086" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-3087"><a href="#cb168-3087" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular las predicciones para el conjunto de test</span></span>
<span id="cb168-3088"><a href="#cb168-3088" aria-hidden="true" tabindex="-1"></a>predicciones_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(mejor_modelo, <span class="at">newdata =</span> datos_test, <span class="at">probability =</span> <span class="cn">TRUE</span>)</span>
<span id="cb168-3089"><a href="#cb168-3089" aria-hidden="true" tabindex="-1"></a>predicciones_test <span class="ot">&lt;-</span> predicciones_test[, <span class="st">"SI"</span>]  <span class="co"># Asumiendo que "SI" es la clase positiva</span></span>
<span id="cb168-3090"><a href="#cb168-3090" aria-hidden="true" tabindex="-1"></a>clases_predichas_test <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predicciones_test <span class="sc">&gt;=</span> <span class="fl">0.5</span>, <span class="st">"SI"</span>, <span class="st">"NO"</span>)</span>
<span id="cb168-3091"><a href="#cb168-3091" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3092"><a href="#cb168-3092" aria-hidden="true" tabindex="-1"></a><span class="fu">mostrar_metricas</span>(datos_test<span class="sc">$</span>ESTADO_ACTUAL,clases_predichas_test)</span>
<span id="cb168-3093"><a href="#cb168-3093" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3094"><a href="#cb168-3094" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-3095"><a href="#cb168-3095" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3096"><a href="#cb168-3096" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3097"><a href="#cb168-3097" aria-hidden="true" tabindex="-1"></a><span class="fu">### Roc curve and auc</span></span>
<span id="cb168-3098"><a href="#cb168-3098" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3101"><a href="#cb168-3101" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-3102"><a href="#cb168-3102" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular la curva ROC y el AUC para el conjunto de test</span></span>
<span id="cb168-3103"><a href="#cb168-3103" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_roc_curve</span>(predicciones_test,datos_test<span class="sc">$</span>ESTADO_ACTUAL)</span>
<span id="cb168-3104"><a href="#cb168-3104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3105"><a href="#cb168-3105" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-3106"><a href="#cb168-3106" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb168-3107"><a href="#cb168-3107" aria-hidden="true" tabindex="-1"></a>The performance is bad compared to the previous models. We are going to see if the metrics are robust using a 5x2 cross validation.</span>
<span id="cb168-3108"><a href="#cb168-3108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3109"><a href="#cb168-3109" aria-hidden="true" tabindex="-1"></a><span class="fu">## 5x2 Cross Validation Filter</span></span>
<span id="cb168-3110"><a href="#cb168-3110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3111"><a href="#cb168-3111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3112"><a href="#cb168-3112" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=FALSE,message=FALSE, eval=FALSE}</span></span>
<span id="cb168-3113"><a href="#cb168-3113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3114"><a href="#cb168-3114" aria-hidden="true" tabindex="-1"></a><span class="in"># Iniciar tiempo de ejecución</span></span>
<span id="cb168-3115"><a href="#cb168-3115" aria-hidden="true" tabindex="-1"></a><span class="in">start_time &lt;- Sys.time()</span></span>
<span id="cb168-3116"><a href="#cb168-3116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3117"><a href="#cb168-3117" aria-hidden="true" tabindex="-1"></a><span class="in"># Parámetros a cambiar</span></span>
<span id="cb168-3118"><a href="#cb168-3118" aria-hidden="true" tabindex="-1"></a><span class="in">proportion &lt;- 0.28</span></span>
<span id="cb168-3119"><a href="#cb168-3119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3120"><a href="#cb168-3120" aria-hidden="true" tabindex="-1"></a><span class="in"># Configurar la validación cruzada 5x3</span></span>
<span id="cb168-3121"><a href="#cb168-3121" aria-hidden="true" tabindex="-1"></a><span class="in">k_outer &lt;- 5  # Número de pliegues externos</span></span>
<span id="cb168-3122"><a href="#cb168-3122" aria-hidden="true" tabindex="-1"></a><span class="in">k_inner &lt;- 3  # Número de pliegues internos</span></span>
<span id="cb168-3123"><a href="#cb168-3123" aria-hidden="true" tabindex="-1"></a><span class="in">folds_outer &lt;- createFolds(data$ESTADO_ACTUAL, k = k_outer, list = FALSE)  # Obtener índices de pliegues externos</span></span>
<span id="cb168-3124"><a href="#cb168-3124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3125"><a href="#cb168-3125" aria-hidden="true" tabindex="-1"></a><span class="in"># Lista para almacenar resultados</span></span>
<span id="cb168-3126"><a href="#cb168-3126" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_auc &lt;- numeric(k_outer)</span></span>
<span id="cb168-3127"><a href="#cb168-3127" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_accuracy &lt;- numeric(k_outer)</span></span>
<span id="cb168-3128"><a href="#cb168-3128" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_sensibilidad &lt;- numeric(k_outer)</span></span>
<span id="cb168-3129"><a href="#cb168-3129" aria-hidden="true" tabindex="-1"></a><span class="in">indices &lt;- 1:nrow(data)</span></span>
<span id="cb168-3130"><a href="#cb168-3130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3131"><a href="#cb168-3131" aria-hidden="true" tabindex="-1"></a><span class="in"># Inicializar matrices para almacenar predicciones y objetivos</span></span>
<span id="cb168-3132"><a href="#cb168-3132" aria-hidden="true" tabindex="-1"></a><span class="in">predicciones_totales &lt;- matrix(NA, nrow = nrow(data), ncol = k_outer)</span></span>
<span id="cb168-3133"><a href="#cb168-3133" aria-hidden="true" tabindex="-1"></a><span class="in">targets_totales &lt;- numeric(nrow(data))</span></span>
<span id="cb168-3134"><a href="#cb168-3134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3135"><a href="#cb168-3135" aria-hidden="true" tabindex="-1"></a><span class="in"># Iterar sobre cada pliegue externo y realizar el proceso de modelado</span></span>
<span id="cb168-3136"><a href="#cb168-3136" aria-hidden="true" tabindex="-1"></a><span class="in">for (i_outer in 1:k_outer) {</span></span>
<span id="cb168-3137"><a href="#cb168-3137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3138"><a href="#cb168-3138" aria-hidden="true" tabindex="-1"></a><span class="in">  # Obtener los índices para el pliegue externo actual</span></span>
<span id="cb168-3139"><a href="#cb168-3139" aria-hidden="true" tabindex="-1"></a><span class="in">  test_indices_outer &lt;- indices[folds_outer == i_outer]  # Índices correspondientes al pliegue externo de test</span></span>
<span id="cb168-3140"><a href="#cb168-3140" aria-hidden="true" tabindex="-1"></a><span class="in">  train_indices_outer &lt;- setdiff(1:nrow(data), test_indices_outer)  # Índices correspondientes al conjunto de entrenamiento</span></span>
<span id="cb168-3141"><a href="#cb168-3141" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-3142"><a href="#cb168-3142" aria-hidden="true" tabindex="-1"></a><span class="in">  # Dividir datos en entrenamiento y test para el pliegue externo</span></span>
<span id="cb168-3143"><a href="#cb168-3143" aria-hidden="true" tabindex="-1"></a><span class="in">  datos_entrenamiento_outer &lt;- data[train_indices_outer, ]</span></span>
<span id="cb168-3144"><a href="#cb168-3144" aria-hidden="true" tabindex="-1"></a><span class="in">  datos_test_outer &lt;- data[test_indices_outer, ]</span></span>
<span id="cb168-3145"><a href="#cb168-3145" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-3146"><a href="#cb168-3146" aria-hidden="true" tabindex="-1"></a><span class="in">  # Configurar la validación cruzada interna</span></span>
<span id="cb168-3147"><a href="#cb168-3147" aria-hidden="true" tabindex="-1"></a><span class="in">  folds_inner &lt;- createFolds(datos_entrenamiento_outer$ESTADO_ACTUAL, k = k_inner, list = FALSE)  # Obtener índices de pliegues internos</span></span>
<span id="cb168-3148"><a href="#cb168-3148" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-3149"><a href="#cb168-3149" aria-hidden="true" tabindex="-1"></a><span class="in">  # Almacenar predicciones y objetivos para el AUC general</span></span>
<span id="cb168-3150"><a href="#cb168-3150" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_auc &lt;- numeric(nrow(datos_entrenamiento_outer))</span></span>
<span id="cb168-3151"><a href="#cb168-3151" aria-hidden="true" tabindex="-1"></a><span class="in">  targets_auc &lt;- numeric(nrow(datos_entrenamiento_outer))</span></span>
<span id="cb168-3152"><a href="#cb168-3152" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-3153"><a href="#cb168-3153" aria-hidden="true" tabindex="-1"></a><span class="in">  # Inicializar variables para almacenar resultados internos</span></span>
<span id="cb168-3154"><a href="#cb168-3154" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_auc_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-3155"><a href="#cb168-3155" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_accuracy_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-3156"><a href="#cb168-3156" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_sensibilidad_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-3157"><a href="#cb168-3157" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-3158"><a href="#cb168-3158" aria-hidden="true" tabindex="-1"></a><span class="in">  # Iterar sobre cada pliegue interno para selección de modelo</span></span>
<span id="cb168-3159"><a href="#cb168-3159" aria-hidden="true" tabindex="-1"></a><span class="in">  indices_inner &lt;- 1:nrow(datos_entrenamiento_outer)</span></span>
<span id="cb168-3160"><a href="#cb168-3160" aria-hidden="true" tabindex="-1"></a><span class="in">  for (i_inner in 1:k_inner) {</span></span>
<span id="cb168-3161"><a href="#cb168-3161" aria-hidden="true" tabindex="-1"></a><span class="in">    ###############################</span></span>
<span id="cb168-3162"><a href="#cb168-3162" aria-hidden="true" tabindex="-1"></a><span class="in">    #### Aqui el filtrado##########</span></span>
<span id="cb168-3163"><a href="#cb168-3163" aria-hidden="true" tabindex="-1"></a><span class="in">    filter_data &lt;- filter_dependency(datos_entrenamiento_outer,"ESTADO_ACTUAL",colnames(datos_entrenamiento_outer),0.05)</span></span>
<span id="cb168-3164"><a href="#cb168-3164" aria-hidden="true" tabindex="-1"></a><span class="in">    if ("ESTADO_ACTUAL.1" %in% colnames(filter_data)) {</span></span>
<span id="cb168-3165"><a href="#cb168-3165" aria-hidden="true" tabindex="-1"></a><span class="in">      filter_data &lt;- filter_data[, !colnames(filter_data) %in% "ESTADO_ACTUAL.1", drop = FALSE]</span></span>
<span id="cb168-3166"><a href="#cb168-3166" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb168-3167"><a href="#cb168-3167" aria-hidden="true" tabindex="-1"></a><span class="in">#con poca variables solo unaa la vez o filtrado o wrapper</span></span>
<span id="cb168-3168"><a href="#cb168-3168" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-3169"><a href="#cb168-3169" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-3170"><a href="#cb168-3170" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-3171"><a href="#cb168-3171" aria-hidden="true" tabindex="-1"></a><span class="in">    # Obtener los índices para el pliegue interno actual</span></span>
<span id="cb168-3172"><a href="#cb168-3172" aria-hidden="true" tabindex="-1"></a><span class="in">    test_indices_inner &lt;- indices_inner[folds_inner==i_inner]  # Índices correspondientes al pliegue interno de test</span></span>
<span id="cb168-3173"><a href="#cb168-3173" aria-hidden="true" tabindex="-1"></a><span class="in">    train_indices_inner &lt;- setdiff(1:nrow(filter_data), test_indices_inner)  # Índices correspondientes al conjunto de entrenamiento interno</span></span>
<span id="cb168-3174"><a href="#cb168-3174" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-3175"><a href="#cb168-3175" aria-hidden="true" tabindex="-1"></a><span class="in">    # Dividir datos en entrenamiento y test para el pliegue interno</span></span>
<span id="cb168-3176"><a href="#cb168-3176" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_entrenamiento_inner &lt;- filter_data[train_indices_inner, ]</span></span>
<span id="cb168-3177"><a href="#cb168-3177" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_validacion &lt;- filter_data[test_indices_inner, ]</span></span>
<span id="cb168-3178"><a href="#cb168-3178" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-3179"><a href="#cb168-3179" aria-hidden="true" tabindex="-1"></a><span class="in">    # Aplicar oversampling en el conjunto de entrenamiento interno</span></span>
<span id="cb168-3180"><a href="#cb168-3180" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_entrenamiento_oversampled &lt;- ROSE(ESTADO_ACTUAL ~ ., data = datos_entrenamiento_inner, p = proportion)$data</span></span>
<span id="cb168-3181"><a href="#cb168-3181" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-3182"><a href="#cb168-3182" aria-hidden="true" tabindex="-1"></a><span class="in">    # Definir la fórmula para el modelo</span></span>
<span id="cb168-3183"><a href="#cb168-3183" aria-hidden="true" tabindex="-1"></a><span class="in">    formula &lt;- ESTADO_ACTUAL ~ .</span></span>
<span id="cb168-3184"><a href="#cb168-3184" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-3185"><a href="#cb168-3185" aria-hidden="true" tabindex="-1"></a><span class="in">    # Inicializar variables para almacenar el mejor modelo y su AUC</span></span>
<span id="cb168-3186"><a href="#cb168-3186" aria-hidden="true" tabindex="-1"></a><span class="in">    mejor_auc &lt;- 0</span></span>
<span id="cb168-3187"><a href="#cb168-3187" aria-hidden="true" tabindex="-1"></a><span class="in">    mejor_modelo &lt;- NULL</span></span>
<span id="cb168-3188"><a href="#cb168-3188" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-3189"><a href="#cb168-3189" aria-hidden="true" tabindex="-1"></a><span class="in">    # Definir combinaciones de hiperparámetros a probar</span></span>
<span id="cb168-3190"><a href="#cb168-3190" aria-hidden="true" tabindex="-1"></a><span class="in">    param_grid &lt;- expand.grid(cp = c(0.01, 0.05, 0.1), </span></span>
<span id="cb168-3191"><a href="#cb168-3191" aria-hidden="true" tabindex="-1"></a><span class="in">                              minsplit = c(5, 10, 20), </span></span>
<span id="cb168-3192"><a href="#cb168-3192" aria-hidden="true" tabindex="-1"></a><span class="in">                              minbucket = c(5, 10, 20))</span></span>
<span id="cb168-3193"><a href="#cb168-3193" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-3194"><a href="#cb168-3194" aria-hidden="true" tabindex="-1"></a><span class="in">    # Bucle para probar diferentes combinaciones de hiperparámetros</span></span>
<span id="cb168-3195"><a href="#cb168-3195" aria-hidden="true" tabindex="-1"></a><span class="in">    for (params in 1:nrow(param_grid)) {</span></span>
<span id="cb168-3196"><a href="#cb168-3196" aria-hidden="true" tabindex="-1"></a><span class="in">      cp &lt;- param_grid$cp[params]</span></span>
<span id="cb168-3197"><a href="#cb168-3197" aria-hidden="true" tabindex="-1"></a><span class="in">      minsplit &lt;- param_grid$minsplit[params]</span></span>
<span id="cb168-3198"><a href="#cb168-3198" aria-hidden="true" tabindex="-1"></a><span class="in">      minbucket &lt;- param_grid$minbucket[params]</span></span>
<span id="cb168-3199"><a href="#cb168-3199" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb168-3200"><a href="#cb168-3200" aria-hidden="true" tabindex="-1"></a><span class="in">      # Entrenar el modelo de árbol de decisión con la combinación de hiperparámetros actual</span></span>
<span id="cb168-3201"><a href="#cb168-3201" aria-hidden="true" tabindex="-1"></a><span class="in">      modelo &lt;- rpart(formula, data = datos_entrenamiento_oversampled, </span></span>
<span id="cb168-3202"><a href="#cb168-3202" aria-hidden="true" tabindex="-1"></a><span class="in">                      control = rpart.control(cp = cp, minsplit = minsplit, minbucket = minbucket), </span></span>
<span id="cb168-3203"><a href="#cb168-3203" aria-hidden="true" tabindex="-1"></a><span class="in">                      method = "class")</span></span>
<span id="cb168-3204"><a href="#cb168-3204" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb168-3205"><a href="#cb168-3205" aria-hidden="true" tabindex="-1"></a><span class="in">      # Realizar predicciones con probabilidades en datos de validación</span></span>
<span id="cb168-3206"><a href="#cb168-3206" aria-hidden="true" tabindex="-1"></a><span class="in">      predicciones_validacion_prob &lt;- predict(modelo, newdata = datos_validacion, type = "prob")[,2]</span></span>
<span id="cb168-3207"><a href="#cb168-3207" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb168-3208"><a href="#cb168-3208" aria-hidden="true" tabindex="-1"></a><span class="in">      # Calcular el AUC</span></span>
<span id="cb168-3209"><a href="#cb168-3209" aria-hidden="true" tabindex="-1"></a><span class="in">      roc_obj &lt;- roc(datos_validacion[["ESTADO_ACTUAL"]], predicciones_validacion_prob, levels = rev(levels(datos_validacion[["ESTADO_ACTUAL"]])))</span></span>
<span id="cb168-3210"><a href="#cb168-3210" aria-hidden="true" tabindex="-1"></a><span class="in">      auc_actual &lt;- auc(roc_obj)</span></span>
<span id="cb168-3211"><a href="#cb168-3211" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb168-3212"><a href="#cb168-3212" aria-hidden="true" tabindex="-1"></a><span class="in">      # Actualizar el mejor modelo y su rendimiento si se encuentra un modelo mejor</span></span>
<span id="cb168-3213"><a href="#cb168-3213" aria-hidden="true" tabindex="-1"></a><span class="in">      if (auc_actual &gt; mejor_auc) {</span></span>
<span id="cb168-3214"><a href="#cb168-3214" aria-hidden="true" tabindex="-1"></a><span class="in">        mejor_auc &lt;- auc_actual</span></span>
<span id="cb168-3215"><a href="#cb168-3215" aria-hidden="true" tabindex="-1"></a><span class="in">        mejor_modelo &lt;- modelo</span></span>
<span id="cb168-3216"><a href="#cb168-3216" aria-hidden="true" tabindex="-1"></a><span class="in">      }</span></span>
<span id="cb168-3217"><a href="#cb168-3217" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb168-3218"><a href="#cb168-3218" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-3219"><a href="#cb168-3219" aria-hidden="true" tabindex="-1"></a><span class="in">    # Calcular las predicciones para el conjunto de validación interno</span></span>
<span id="cb168-3220"><a href="#cb168-3220" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_validacion_prob &lt;- predict(mejor_modelo, newdata = datos_validacion, type = "prob")[,2]</span></span>
<span id="cb168-3221"><a href="#cb168-3221" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-3222"><a href="#cb168-3222" aria-hidden="true" tabindex="-1"></a><span class="in">    # Almacenar las predicciones y objetivos</span></span>
<span id="cb168-3223"><a href="#cb168-3223" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_auc[test_indices_inner] &lt;- predicciones_validacion_prob</span></span>
<span id="cb168-3224"><a href="#cb168-3224" aria-hidden="true" tabindex="-1"></a><span class="in">    targets_auc[test_indices_inner] &lt;- as.numeric(datos_validacion$ESTADO_ACTUAL) - 1</span></span>
<span id="cb168-3225"><a href="#cb168-3225" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-3226"><a href="#cb168-3226" aria-hidden="true" tabindex="-1"></a><span class="in">    # Calcular la sensibilidad y la precisión</span></span>
<span id="cb168-3227"><a href="#cb168-3227" aria-hidden="true" tabindex="-1"></a><span class="in">    umbral &lt;- 0.5</span></span>
<span id="cb168-3228"><a href="#cb168-3228" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_finales &lt;- ifelse(predicciones_validacion_prob &gt;= umbral, "SI", "NO")</span></span>
<span id="cb168-3229"><a href="#cb168-3229" aria-hidden="true" tabindex="-1"></a><span class="in">    TP &lt;- sum(predicciones_finales == "SI" &amp; datos_validacion[["ESTADO_ACTUAL"]] == "SI")</span></span>
<span id="cb168-3230"><a href="#cb168-3230" aria-hidden="true" tabindex="-1"></a><span class="in">    FN &lt;- sum(predicciones_finales == "NO" &amp; datos_validacion[["ESTADO_ACTUAL"]] == "SI")</span></span>
<span id="cb168-3231"><a href="#cb168-3231" aria-hidden="true" tabindex="-1"></a><span class="in">    FP &lt;- sum(predicciones_finales == "SI" &amp; datos_validacion[["ESTADO_ACTUAL"]] == "NO")</span></span>
<span id="cb168-3232"><a href="#cb168-3232" aria-hidden="true" tabindex="-1"></a><span class="in">    TN &lt;- sum(predicciones_finales == "NO" &amp; datos_validacion[["ESTADO_ACTUAL"]] == "NO")</span></span>
<span id="cb168-3233"><a href="#cb168-3233" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-3234"><a href="#cb168-3234" aria-hidden="true" tabindex="-1"></a><span class="in">    recall_actual &lt;- TP / (TP + FN)</span></span>
<span id="cb168-3235"><a href="#cb168-3235" aria-hidden="true" tabindex="-1"></a><span class="in">    accuracy_actual &lt;- (TP + TN) / (TP + FN + FP + TN)</span></span>
<span id="cb168-3236"><a href="#cb168-3236" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-3237"><a href="#cb168-3237" aria-hidden="true" tabindex="-1"></a><span class="in">    # Almacenar resultados internos</span></span>
<span id="cb168-3238"><a href="#cb168-3238" aria-hidden="true" tabindex="-1"></a><span class="in">    resultados_sensibilidad_inner[i_inner] &lt;- recall_actual</span></span>
<span id="cb168-3239"><a href="#cb168-3239" aria-hidden="true" tabindex="-1"></a><span class="in">    resultados_accuracy_inner[i_inner] &lt;- accuracy_actual</span></span>
<span id="cb168-3240"><a href="#cb168-3240" aria-hidden="true" tabindex="-1"></a><span class="in">    resultados_auc_inner[i_inner] &lt;- auc_actual</span></span>
<span id="cb168-3241"><a href="#cb168-3241" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb168-3242"><a href="#cb168-3242" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-3243"><a href="#cb168-3243" aria-hidden="true" tabindex="-1"></a><span class="in">  # Calcular el AUC final para este pliegue externo</span></span>
<span id="cb168-3244"><a href="#cb168-3244" aria-hidden="true" tabindex="-1"></a><span class="in">  auc_fold_externo &lt;- mean(resultados_auc_inner)</span></span>
<span id="cb168-3245"><a href="#cb168-3245" aria-hidden="true" tabindex="-1"></a><span class="in">  accuracy_fold_externo &lt;- mean(resultados_accuracy_inner)</span></span>
<span id="cb168-3246"><a href="#cb168-3246" aria-hidden="true" tabindex="-1"></a><span class="in">  sensibilidad_fold_externo &lt;- mean(resultados_sensibilidad_inner)</span></span>
<span id="cb168-3247"><a href="#cb168-3247" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-3248"><a href="#cb168-3248" aria-hidden="true" tabindex="-1"></a><span class="in">  # Almacenar el AUC del fold externo actual</span></span>
<span id="cb168-3249"><a href="#cb168-3249" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_auc[i_outer] &lt;- auc_fold_externo</span></span>
<span id="cb168-3250"><a href="#cb168-3250" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_accuracy[i_outer] &lt;- accuracy_fold_externo</span></span>
<span id="cb168-3251"><a href="#cb168-3251" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_sensibilidad[i_outer] &lt;- sensibilidad_fold_externo</span></span>
<span id="cb168-3252"><a href="#cb168-3252" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-3253"><a href="#cb168-3253" aria-hidden="true" tabindex="-1"></a><span class="in">  # Predecir en los datos de test para este pliegue externo y almacenar predicciones</span></span>
<span id="cb168-3254"><a href="#cb168-3254" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_test_outer_prob &lt;- predict(mejor_modelo, newdata = datos_test_outer, type = "prob")[,2]</span></span>
<span id="cb168-3255"><a href="#cb168-3255" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_totales[test_indices_outer, i_outer] &lt;- predicciones_test_outer_prob</span></span>
<span id="cb168-3256"><a href="#cb168-3256" aria-hidden="true" tabindex="-1"></a><span class="in">  targets_totales[test_indices_outer] &lt;- as.numeric(datos_test_outer$ESTADO_ACTUAL) - 1</span></span>
<span id="cb168-3257"><a href="#cb168-3257" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb168-3258"><a href="#cb168-3258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3259"><a href="#cb168-3259" aria-hidden="true" tabindex="-1"></a><span class="in"># Calcular AUC promedio</span></span>
<span id="cb168-3260"><a href="#cb168-3260" aria-hidden="true" tabindex="-1"></a><span class="in">auc_promedio &lt;- mean(resultados_auc)</span></span>
<span id="cb168-3261"><a href="#cb168-3261" aria-hidden="true" tabindex="-1"></a><span class="in">accuracy_promedio &lt;- mean(resultados_accuracy)</span></span>
<span id="cb168-3262"><a href="#cb168-3262" aria-hidden="true" tabindex="-1"></a><span class="in">sensibilidad_promedio &lt;- mean(resultados_sensibilidad)</span></span>
<span id="cb168-3263"><a href="#cb168-3263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3264"><a href="#cb168-3264" aria-hidden="true" tabindex="-1"></a><span class="in"># Crear tabla con todas las métricas</span></span>
<span id="cb168-3265"><a href="#cb168-3265" aria-hidden="true" tabindex="-1"></a><span class="in">tabla_metricas &lt;- data.frame(</span></span>
<span id="cb168-3266"><a href="#cb168-3266" aria-hidden="true" tabindex="-1"></a><span class="in">  Pliegue = 1:k_outer,</span></span>
<span id="cb168-3267"><a href="#cb168-3267" aria-hidden="true" tabindex="-1"></a><span class="in">  AUC = sapply(resultados_auc, round, digits = 3),</span></span>
<span id="cb168-3268"><a href="#cb168-3268" aria-hidden="true" tabindex="-1"></a><span class="in">  Accuracy = sapply(resultados_accuracy, round, digits = 3),</span></span>
<span id="cb168-3269"><a href="#cb168-3269" aria-hidden="true" tabindex="-1"></a><span class="in">  Recall = sapply(resultados_sensibilidad, round, digits = 3)</span></span>
<span id="cb168-3270"><a href="#cb168-3270" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb168-3271"><a href="#cb168-3271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3272"><a href="#cb168-3272" aria-hidden="true" tabindex="-1"></a><span class="in"># Agregar fila con promedio de métricas</span></span>
<span id="cb168-3273"><a href="#cb168-3273" aria-hidden="true" tabindex="-1"></a><span class="in">tabla_metricas_dtree_filter &lt;- rbind(tabla_metricas, c("Mean", round(auc_promedio, 3), round(accuracy_promedio, 3), round(sensibilidad_promedio, 3)))</span></span>
<span id="cb168-3274"><a href="#cb168-3274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3275"><a href="#cb168-3275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3276"><a href="#cb168-3276" aria-hidden="true" tabindex="-1"></a><span class="in"># Detener el tiempo de ejecución</span></span>
<span id="cb168-3277"><a href="#cb168-3277" aria-hidden="true" tabindex="-1"></a><span class="in">end_time &lt;- Sys.time()</span></span>
<span id="cb168-3278"><a href="#cb168-3278" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time_dtree_filter &lt;- end_time - start_time</span></span>
<span id="cb168-3279"><a href="#cb168-3279" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time_dtree_filter &lt;- as.numeric(execution_time_dtree_filter, units = "secs")</span></span>
<span id="cb168-3280"><a href="#cb168-3280" aria-hidden="true" tabindex="-1"></a><span class="in">save(tabla_metricas_dtree_filter, file = "tabla_metricas_dtree_filter.RData")</span></span>
<span id="cb168-3281"><a href="#cb168-3281" aria-hidden="true" tabindex="-1"></a><span class="in">save(execution_time_dtree_filter, file = "execution_time_dtree_filter.RData")</span></span>
<span id="cb168-3282"><a href="#cb168-3282" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-3283"><a href="#cb168-3283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3286"><a href="#cb168-3286" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-3287"><a href="#cb168-3287" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"tabla_metricas_dtree_filter.RData"</span>)</span>
<span id="cb168-3288"><a href="#cb168-3288" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"execution_time_dtree_filter.RData"</span>)</span>
<span id="cb168-3289"><a href="#cb168-3289" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir el tiempo de ejecución</span></span>
<span id="cb168-3290"><a href="#cb168-3290" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time_dtree_filter,  <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb168-3291"><a href="#cb168-3291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3292"><a href="#cb168-3292" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-3293"><a href="#cb168-3293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3294"><a href="#cb168-3294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3295"><a href="#cb168-3295" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb168-3296"><a href="#cb168-3296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3297"><a href="#cb168-3297" aria-hidden="true" tabindex="-1"></a><span class="fu"># Metrics Table</span></span>
<span id="cb168-3300"><a href="#cb168-3300" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-3301"><a href="#cb168-3301" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir tabla formateada con kableExtra</span></span>
<span id="cb168-3302"><a href="#cb168-3302" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(tabla_metricas_dtree_filter, <span class="at">caption =</span> <span class="st">"Cross Validation Metrics"</span>, <span class="at">align =</span> <span class="st">"c"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb168-3303"><a href="#cb168-3303" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb168-3304"><a href="#cb168-3304" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-3305"><a href="#cb168-3305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3306"><a href="#cb168-3306" aria-hidden="true" tabindex="-1"></a><span class="fu"># Metrics Plot</span></span>
<span id="cb168-3309"><a href="#cb168-3309" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-3310"><a href="#cb168-3310" aria-hidden="true" tabindex="-1"></a><span class="fu">crear_plot_metricas_per_fold</span>(tabla_metricas_dtree_filter)</span>
<span id="cb168-3311"><a href="#cb168-3311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3312"><a href="#cb168-3312" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-3313"><a href="#cb168-3313" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb168-3314"><a href="#cb168-3314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3315"><a href="#cb168-3315" aria-hidden="true" tabindex="-1"></a>The model is instable and the performance metrics are not good. In the next section we are going to implement a random forest model to see if we can improve the performance.</span>
<span id="cb168-3316"><a href="#cb168-3316" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb168-3317"><a href="#cb168-3317" aria-hidden="true" tabindex="-1"></a><span class="fu"># Random Forest {#random-forest}</span></span>
<span id="cb168-3318"><a href="#cb168-3318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3319"><a href="#cb168-3319" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset style="background-color: #f0f0f0;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;"}</span>
<span id="cb168-3320"><a href="#cb168-3320" aria-hidden="true" tabindex="-1"></a><span class="fu">## Hold out</span></span>
<span id="cb168-3321"><a href="#cb168-3321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3322"><a href="#cb168-3322" aria-hidden="true" tabindex="-1"></a>The objetive of this section is to better the decision tree model using a random forest model. We are going to use the same hyperparameters as the decision tree model and evaluate it using a hold out validation. The hyperparameters are cp, minsplit and minbucket.</span>
<span id="cb168-3323"><a href="#cb168-3323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3324"><a href="#cb168-3324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3327"><a href="#cb168-3327" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-3328"><a href="#cb168-3328" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb168-3329"><a href="#cb168-3329" aria-hidden="true" tabindex="-1"></a><span class="co"># Parámetros a cambiar</span></span>
<span id="cb168-3330"><a href="#cb168-3330" aria-hidden="true" tabindex="-1"></a>proportion <span class="ot">&lt;-</span> <span class="fl">0.28</span></span>
<span id="cb168-3331"><a href="#cb168-3331" aria-hidden="true" tabindex="-1"></a>sensitivity_weight <span class="ot">&lt;-</span> <span class="fl">0.8</span></span>
<span id="cb168-3332"><a href="#cb168-3332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3333"><a href="#cb168-3333" aria-hidden="true" tabindex="-1"></a><span class="co"># Dividir el conjunto de datos en entrenamiento y test</span></span>
<span id="cb168-3334"><a href="#cb168-3334" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)  <span class="co"># Establecer una semilla para reproducibilidad</span></span>
<span id="cb168-3335"><a href="#cb168-3335" aria-hidden="true" tabindex="-1"></a>indices_entrenamiento <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(data), <span class="fl">0.75</span> <span class="sc">*</span> <span class="fu">nrow</span>(data))  <span class="co"># 75% para entrenamiento</span></span>
<span id="cb168-3336"><a href="#cb168-3336" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento <span class="ot">&lt;-</span> data[indices_entrenamiento, ]</span>
<span id="cb168-3337"><a href="#cb168-3337" aria-hidden="true" tabindex="-1"></a>datos_test <span class="ot">&lt;-</span> data[<span class="sc">-</span>indices_entrenamiento, ]</span>
<span id="cb168-3338"><a href="#cb168-3338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3339"><a href="#cb168-3339" aria-hidden="true" tabindex="-1"></a><span class="co"># Dividir datos de entrenamiento en entrenamiento y validación</span></span>
<span id="cb168-3340"><a href="#cb168-3340" aria-hidden="true" tabindex="-1"></a>train_indices <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(datos_entrenamiento), <span class="fl">0.8</span> <span class="sc">*</span> <span class="fu">nrow</span>(datos_entrenamiento))  <span class="co"># 80% para entrenamiento</span></span>
<span id="cb168-3341"><a href="#cb168-3341" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento_split <span class="ot">&lt;-</span> datos_entrenamiento[train_indices, ]</span>
<span id="cb168-3342"><a href="#cb168-3342" aria-hidden="true" tabindex="-1"></a>datos_validacion <span class="ot">&lt;-</span> datos_entrenamiento[<span class="sc">-</span>train_indices, ]</span>
<span id="cb168-3343"><a href="#cb168-3343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3344"><a href="#cb168-3344" aria-hidden="true" tabindex="-1"></a><span class="co"># Realizar sobremuestreo en los datos de entrenamiento</span></span>
<span id="cb168-3345"><a href="#cb168-3345" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento_oversampled <span class="ot">&lt;-</span> <span class="fu">ROSE</span>(ESTADO_ACTUAL <span class="sc">~</span> ., <span class="at">data =</span> datos_entrenamiento_split, <span class="at">seed =</span> <span class="dv">123</span>, <span class="at">p =</span> proportion)<span class="sc">$</span>data</span>
<span id="cb168-3346"><a href="#cb168-3346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3347"><a href="#cb168-3347" aria-hidden="true" tabindex="-1"></a><span class="co"># Definir la función para calcular el métrico personalizado</span></span>
<span id="cb168-3348"><a href="#cb168-3348" aria-hidden="true" tabindex="-1"></a>compute_custom_metric <span class="ot">&lt;-</span> <span class="cf">function</span>(recall, accuracy, <span class="at">sensitivity_weight =</span> <span class="dv">1</span>) {</span>
<span id="cb168-3349"><a href="#cb168-3349" aria-hidden="true" tabindex="-1"></a>  custom_metric <span class="ot">&lt;-</span> (sensitivity_weight <span class="sc">*</span> recall) <span class="sc">+</span> ((<span class="dv">1</span> <span class="sc">-</span> sensitivity_weight) <span class="sc">*</span> accuracy)</span>
<span id="cb168-3350"><a href="#cb168-3350" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(custom_metric)</span>
<span id="cb168-3351"><a href="#cb168-3351" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb168-3352"><a href="#cb168-3352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3353"><a href="#cb168-3353" aria-hidden="true" tabindex="-1"></a><span class="co"># Definir la fórmula para el modelo</span></span>
<span id="cb168-3354"><a href="#cb168-3354" aria-hidden="true" tabindex="-1"></a>formula <span class="ot">&lt;-</span> ESTADO_ACTUAL <span class="sc">~</span> .</span>
<span id="cb168-3355"><a href="#cb168-3355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3356"><a href="#cb168-3356" aria-hidden="true" tabindex="-1"></a><span class="co"># Inicializar variables para almacenar los resultados</span></span>
<span id="cb168-3357"><a href="#cb168-3357" aria-hidden="true" tabindex="-1"></a>mejor_custom_metric <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb168-3358"><a href="#cb168-3358" aria-hidden="true" tabindex="-1"></a>mejor_modelo <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb168-3359"><a href="#cb168-3359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3360"><a href="#cb168-3360" aria-hidden="true" tabindex="-1"></a><span class="co"># Definir combinaciones de hiperparámetros a probar</span></span>
<span id="cb168-3361"><a href="#cb168-3361" aria-hidden="true" tabindex="-1"></a>param_grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">mtry =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>), </span>
<span id="cb168-3362"><a href="#cb168-3362" aria-hidden="true" tabindex="-1"></a>                          <span class="at">ntree =</span> <span class="fu">c</span>(<span class="dv">100</span>, <span class="dv">200</span>, <span class="dv">300</span>),</span>
<span id="cb168-3363"><a href="#cb168-3363" aria-hidden="true" tabindex="-1"></a>                          <span class="at">nodesize =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">15</span>))</span>
<span id="cb168-3364"><a href="#cb168-3364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3365"><a href="#cb168-3365" aria-hidden="true" tabindex="-1"></a><span class="co"># Bucle para probar diferentes combinaciones de hiperparámetros</span></span>
<span id="cb168-3366"><a href="#cb168-3366" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (params <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(param_grid)) {</span>
<span id="cb168-3367"><a href="#cb168-3367" aria-hidden="true" tabindex="-1"></a>  mtry <span class="ot">&lt;-</span> param_grid<span class="sc">$</span>mtry[params]</span>
<span id="cb168-3368"><a href="#cb168-3368" aria-hidden="true" tabindex="-1"></a>  ntree <span class="ot">&lt;-</span> param_grid<span class="sc">$</span>ntree[params]</span>
<span id="cb168-3369"><a href="#cb168-3369" aria-hidden="true" tabindex="-1"></a>  nodesize <span class="ot">&lt;-</span> param_grid<span class="sc">$</span>nodesize[params]</span>
<span id="cb168-3370"><a href="#cb168-3370" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-3371"><a href="#cb168-3371" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Entrenar el modelo Random Forest con la combinación de hiperparámetros actual</span></span>
<span id="cb168-3372"><a href="#cb168-3372" aria-hidden="true" tabindex="-1"></a>  modelo <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(formula, <span class="at">data =</span> datos_entrenamiento_oversampled,</span>
<span id="cb168-3373"><a href="#cb168-3373" aria-hidden="true" tabindex="-1"></a>                         <span class="at">mtry =</span> mtry, <span class="at">ntree =</span> ntree, <span class="at">nodesize =</span> nodesize)</span>
<span id="cb168-3374"><a href="#cb168-3374" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-3375"><a href="#cb168-3375" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Realizar predicciones en datos de validación</span></span>
<span id="cb168-3376"><a href="#cb168-3376" aria-hidden="true" tabindex="-1"></a>  predicciones_validacion <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelo, <span class="at">newdata =</span> datos_validacion, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb168-3377"><a href="#cb168-3377" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-3378"><a href="#cb168-3378" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular la sensibilidad y la precisión</span></span>
<span id="cb168-3379"><a href="#cb168-3379" aria-hidden="true" tabindex="-1"></a>  TP <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_validacion <span class="sc">==</span> <span class="st">"SI"</span> <span class="sc">&amp;</span> datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]] <span class="sc">==</span> <span class="st">"SI"</span>)</span>
<span id="cb168-3380"><a href="#cb168-3380" aria-hidden="true" tabindex="-1"></a>  FN <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_validacion <span class="sc">==</span> <span class="st">"NO"</span> <span class="sc">&amp;</span> datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]] <span class="sc">==</span> <span class="st">"SI"</span>)</span>
<span id="cb168-3381"><a href="#cb168-3381" aria-hidden="true" tabindex="-1"></a>  FP <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_validacion <span class="sc">==</span> <span class="st">"SI"</span> <span class="sc">&amp;</span> datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]] <span class="sc">==</span> <span class="st">"NO"</span>)</span>
<span id="cb168-3382"><a href="#cb168-3382" aria-hidden="true" tabindex="-1"></a>  TN <span class="ot">&lt;-</span> <span class="fu">sum</span>(predicciones_validacion <span class="sc">==</span> <span class="st">"NO"</span> <span class="sc">&amp;</span> datos_validacion[[<span class="st">"ESTADO_ACTUAL"</span>]] <span class="sc">==</span> <span class="st">"NO"</span>)</span>
<span id="cb168-3383"><a href="#cb168-3383" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-3384"><a href="#cb168-3384" aria-hidden="true" tabindex="-1"></a>  recall_actual <span class="ot">&lt;-</span> TP <span class="sc">/</span> (TP <span class="sc">+</span> FN)</span>
<span id="cb168-3385"><a href="#cb168-3385" aria-hidden="true" tabindex="-1"></a>  accuracy_actual <span class="ot">&lt;-</span> (TP <span class="sc">+</span> TN) <span class="sc">/</span> (TP <span class="sc">+</span> FN <span class="sc">+</span> FP <span class="sc">+</span> TN)</span>
<span id="cb168-3386"><a href="#cb168-3386" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-3387"><a href="#cb168-3387" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular el métrico personalizado para la combinación actual</span></span>
<span id="cb168-3388"><a href="#cb168-3388" aria-hidden="true" tabindex="-1"></a>  custom_metric_actual <span class="ot">&lt;-</span> <span class="fu">compute_custom_metric</span>(recall_actual, accuracy_actual, sensitivity_weight)</span>
<span id="cb168-3389"><a href="#cb168-3389" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-3390"><a href="#cb168-3390" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Actualizar el mejor modelo y su rendimiento si se encuentra un modelo mejor</span></span>
<span id="cb168-3391"><a href="#cb168-3391" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (custom_metric_actual <span class="sc">&gt;</span> mejor_custom_metric) {</span>
<span id="cb168-3392"><a href="#cb168-3392" aria-hidden="true" tabindex="-1"></a>    mejor_custom_metric <span class="ot">&lt;-</span> custom_metric_actual</span>
<span id="cb168-3393"><a href="#cb168-3393" aria-hidden="true" tabindex="-1"></a>    mejor_modelo <span class="ot">&lt;-</span> modelo</span>
<span id="cb168-3394"><a href="#cb168-3394" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb168-3395"><a href="#cb168-3395" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb168-3396"><a href="#cb168-3396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3397"><a href="#cb168-3397" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluar el mejor modelo en el conjunto de prueba</span></span>
<span id="cb168-3398"><a href="#cb168-3398" aria-hidden="true" tabindex="-1"></a>predicciones_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(mejor_modelo, <span class="at">newdata =</span> datos_test, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb168-3399"><a href="#cb168-3399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3400"><a href="#cb168-3400" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mejor_modelo)</span>
<span id="cb168-3401"><a href="#cb168-3401" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb168-3402"><a href="#cb168-3402" aria-hidden="true" tabindex="-1"></a>execution_time <span class="ot">&lt;-</span> end_time <span class="sc">-</span> start_time</span>
<span id="cb168-3403"><a href="#cb168-3403" aria-hidden="true" tabindex="-1"></a>execution_time <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(execution_time, <span class="at">units =</span> <span class="st">"secs"</span>)</span>
<span id="cb168-3404"><a href="#cb168-3404" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time,  <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb168-3405"><a href="#cb168-3405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3406"><a href="#cb168-3406" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-3407"><a href="#cb168-3407" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb168-3408"><a href="#cb168-3408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3409"><a href="#cb168-3409" aria-hidden="true" tabindex="-1"></a><span class="fu">### Predictions</span></span>
<span id="cb168-3410"><a href="#cb168-3410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3411"><a href="#cb168-3411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3414"><a href="#cb168-3414" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-3415"><a href="#cb168-3415" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular las predicciones para el conjunto de test</span></span>
<span id="cb168-3416"><a href="#cb168-3416" aria-hidden="true" tabindex="-1"></a>predicciones_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(mejor_modelo, <span class="at">newdata =</span> datos_test, <span class="at">type =</span> <span class="st">"prob"</span>)</span>
<span id="cb168-3417"><a href="#cb168-3417" aria-hidden="true" tabindex="-1"></a>predicciones_test <span class="ot">&lt;-</span> predicciones_test[, <span class="st">"SI"</span>]  <span class="co"># Asumiendo que "SI" es la clase positiva</span></span>
<span id="cb168-3418"><a href="#cb168-3418" aria-hidden="true" tabindex="-1"></a>clases_predichas_test <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predicciones_test <span class="sc">&gt;=</span> <span class="fl">0.5</span>, <span class="st">"SI"</span>, <span class="st">"NO"</span>)</span>
<span id="cb168-3419"><a href="#cb168-3419" aria-hidden="true" tabindex="-1"></a><span class="fu">mostrar_metricas</span>(datos_test<span class="sc">$</span>ESTADO_ACTUAL,clases_predichas_test)</span>
<span id="cb168-3420"><a href="#cb168-3420" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-3421"><a href="#cb168-3421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3422"><a href="#cb168-3422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3423"><a href="#cb168-3423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3424"><a href="#cb168-3424" aria-hidden="true" tabindex="-1"></a><span class="fu">### Roc curve and auc</span></span>
<span id="cb168-3425"><a href="#cb168-3425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3428"><a href="#cb168-3428" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-3429"><a href="#cb168-3429" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular la curva ROC y el AUC para el conjunto de test</span></span>
<span id="cb168-3430"><a href="#cb168-3430" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_roc_curve</span>(predicciones_test,datos_test<span class="sc">$</span>ESTADO_ACTUAL)</span>
<span id="cb168-3431"><a href="#cb168-3431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3432"><a href="#cb168-3432" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-3433"><a href="#cb168-3433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3434"><a href="#cb168-3434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3435"><a href="#cb168-3435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3436"><a href="#cb168-3436" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb168-3437"><a href="#cb168-3437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3438"><a href="#cb168-3438" aria-hidden="true" tabindex="-1"></a>We obtain much better results than the decision tree model. The next step is to ensure that the model is robust using a 5x2 cross validation.</span>
<span id="cb168-3439"><a href="#cb168-3439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3440"><a href="#cb168-3440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3441"><a href="#cb168-3441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3442"><a href="#cb168-3442" aria-hidden="true" tabindex="-1"></a><span class="fu">## 5x2 Cross Validation Filter</span></span>
<span id="cb168-3443"><a href="#cb168-3443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3444"><a href="#cb168-3444" aria-hidden="true" tabindex="-1"></a>We are going to perform a 5x2 cross validation to ensure the robustness of the model.</span>
<span id="cb168-3445"><a href="#cb168-3445" aria-hidden="true" tabindex="-1"></a>First, we create the outer folds and then we iterate over them to create the inner folds and perform the model selection process.</span>
<span id="cb168-3446"><a href="#cb168-3446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3447"><a href="#cb168-3447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3448"><a href="#cb168-3448" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=FALSE,message=FALSE, eval=FALSE}</span></span>
<span id="cb168-3449"><a href="#cb168-3449" aria-hidden="true" tabindex="-1"></a><span class="in"># Iniciar tiempo de ejecución</span></span>
<span id="cb168-3450"><a href="#cb168-3450" aria-hidden="true" tabindex="-1"></a><span class="in">start_time &lt;- Sys.time()</span></span>
<span id="cb168-3451"><a href="#cb168-3451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3452"><a href="#cb168-3452" aria-hidden="true" tabindex="-1"></a><span class="in"># Parámetros a cambiar</span></span>
<span id="cb168-3453"><a href="#cb168-3453" aria-hidden="true" tabindex="-1"></a><span class="in">proportion &lt;- 0.28</span></span>
<span id="cb168-3454"><a href="#cb168-3454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3455"><a href="#cb168-3455" aria-hidden="true" tabindex="-1"></a><span class="in"># Configurar la validación cruzada 5x3</span></span>
<span id="cb168-3456"><a href="#cb168-3456" aria-hidden="true" tabindex="-1"></a><span class="in">k_outer &lt;- 5  # Número de pliegues externos</span></span>
<span id="cb168-3457"><a href="#cb168-3457" aria-hidden="true" tabindex="-1"></a><span class="in">k_inner &lt;- 3  # Número de pliegues internos</span></span>
<span id="cb168-3458"><a href="#cb168-3458" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(123)  # Establecer semilla para reproducibilidad</span></span>
<span id="cb168-3459"><a href="#cb168-3459" aria-hidden="true" tabindex="-1"></a><span class="in">folds_outer &lt;- createFolds(data$ESTADO_ACTUAL, k = k_outer, list = FALSE)  # Obtener índices de pliegues externos</span></span>
<span id="cb168-3460"><a href="#cb168-3460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3461"><a href="#cb168-3461" aria-hidden="true" tabindex="-1"></a><span class="in"># Lista para almacenar resultados</span></span>
<span id="cb168-3462"><a href="#cb168-3462" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_auc &lt;- numeric(k_outer)</span></span>
<span id="cb168-3463"><a href="#cb168-3463" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_accuracy &lt;- numeric(k_outer)</span></span>
<span id="cb168-3464"><a href="#cb168-3464" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_sensibilidad &lt;- numeric(k_outer)</span></span>
<span id="cb168-3465"><a href="#cb168-3465" aria-hidden="true" tabindex="-1"></a><span class="in">indices &lt;- 1:nrow(data)</span></span>
<span id="cb168-3466"><a href="#cb168-3466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3467"><a href="#cb168-3467" aria-hidden="true" tabindex="-1"></a><span class="in"># Inicializar matrices para almacenar predicciones y objetivos</span></span>
<span id="cb168-3468"><a href="#cb168-3468" aria-hidden="true" tabindex="-1"></a><span class="in">predicciones_totales &lt;- matrix(NA, nrow = nrow(data), ncol = k_outer)</span></span>
<span id="cb168-3469"><a href="#cb168-3469" aria-hidden="true" tabindex="-1"></a><span class="in">targets_totales &lt;- numeric(nrow(data))</span></span>
<span id="cb168-3470"><a href="#cb168-3470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3471"><a href="#cb168-3471" aria-hidden="true" tabindex="-1"></a><span class="in"># Iterar sobre cada pliegue externo y realizar el proceso de modelado</span></span>
<span id="cb168-3472"><a href="#cb168-3472" aria-hidden="true" tabindex="-1"></a><span class="in">for (i_outer in 1:k_outer) {</span></span>
<span id="cb168-3473"><a href="#cb168-3473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3474"><a href="#cb168-3474" aria-hidden="true" tabindex="-1"></a><span class="in">  # Obtener los índices para el pliegue externo actual</span></span>
<span id="cb168-3475"><a href="#cb168-3475" aria-hidden="true" tabindex="-1"></a><span class="in">  test_indices_outer &lt;- indices[folds_outer == i_outer]  # Índices correspondientes al pliegue externo de test</span></span>
<span id="cb168-3476"><a href="#cb168-3476" aria-hidden="true" tabindex="-1"></a><span class="in">  train_indices_outer &lt;- setdiff(1:nrow(data), test_indices_outer)  # Índices correspondientes al conjunto de entrenamiento</span></span>
<span id="cb168-3477"><a href="#cb168-3477" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-3478"><a href="#cb168-3478" aria-hidden="true" tabindex="-1"></a><span class="in">  # Dividir datos en entrenamiento y test para el pliegue externo</span></span>
<span id="cb168-3479"><a href="#cb168-3479" aria-hidden="true" tabindex="-1"></a><span class="in">  datos_entrenamiento_outer &lt;- data[train_indices_outer, ]</span></span>
<span id="cb168-3480"><a href="#cb168-3480" aria-hidden="true" tabindex="-1"></a><span class="in">  datos_test_outer &lt;- data[test_indices_outer, ]</span></span>
<span id="cb168-3481"><a href="#cb168-3481" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-3482"><a href="#cb168-3482" aria-hidden="true" tabindex="-1"></a><span class="in">  # Configurar la validación cruzada interna</span></span>
<span id="cb168-3483"><a href="#cb168-3483" aria-hidden="true" tabindex="-1"></a><span class="in">  folds_inner &lt;- createFolds(datos_entrenamiento_outer$ESTADO_ACTUAL, k = k_inner, list = FALSE)  # Obtener índices de pliegues internos</span></span>
<span id="cb168-3484"><a href="#cb168-3484" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-3485"><a href="#cb168-3485" aria-hidden="true" tabindex="-1"></a><span class="in">  # Almacenar predicciones y objetivos para el AUC general</span></span>
<span id="cb168-3486"><a href="#cb168-3486" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_auc &lt;- numeric(nrow(datos_entrenamiento_outer))</span></span>
<span id="cb168-3487"><a href="#cb168-3487" aria-hidden="true" tabindex="-1"></a><span class="in">  targets_auc &lt;- numeric(nrow(datos_entrenamiento_outer))</span></span>
<span id="cb168-3488"><a href="#cb168-3488" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-3489"><a href="#cb168-3489" aria-hidden="true" tabindex="-1"></a><span class="in">  # Inicializar variables para almacenar resultados internos</span></span>
<span id="cb168-3490"><a href="#cb168-3490" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_auc_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-3491"><a href="#cb168-3491" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_accuracy_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-3492"><a href="#cb168-3492" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_sensibilidad_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-3493"><a href="#cb168-3493" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-3494"><a href="#cb168-3494" aria-hidden="true" tabindex="-1"></a><span class="in">  # Iterar sobre cada pliegue interno para selección de modelo</span></span>
<span id="cb168-3495"><a href="#cb168-3495" aria-hidden="true" tabindex="-1"></a><span class="in">  indices_inner &lt;- 1:nrow(datos_entrenamiento_outer)</span></span>
<span id="cb168-3496"><a href="#cb168-3496" aria-hidden="true" tabindex="-1"></a><span class="in">  for (i_inner in 1:k_inner) {</span></span>
<span id="cb168-3497"><a href="#cb168-3497" aria-hidden="true" tabindex="-1"></a><span class="in">    # Obtener los índices para el pliegue interno actual</span></span>
<span id="cb168-3498"><a href="#cb168-3498" aria-hidden="true" tabindex="-1"></a><span class="in">    test_indices_inner &lt;- indices_inner[folds_inner == i_inner]  # Índices correspondientes al pliegue interno de test</span></span>
<span id="cb168-3499"><a href="#cb168-3499" aria-hidden="true" tabindex="-1"></a><span class="in">    train_indices_inner &lt;- setdiff(1:nrow(datos_entrenamiento_outer), test_indices_inner)  # Índices correspondientes al conjunto de entrenamiento interno</span></span>
<span id="cb168-3500"><a href="#cb168-3500" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-3501"><a href="#cb168-3501" aria-hidden="true" tabindex="-1"></a><span class="in">    # Dividir datos en entrenamiento y test para el pliegue interno</span></span>
<span id="cb168-3502"><a href="#cb168-3502" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_entrenamiento_inner &lt;- datos_entrenamiento_outer[train_indices_inner, ]</span></span>
<span id="cb168-3503"><a href="#cb168-3503" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_validacion &lt;- datos_entrenamiento_outer[test_indices_inner, ]</span></span>
<span id="cb168-3504"><a href="#cb168-3504" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-3505"><a href="#cb168-3505" aria-hidden="true" tabindex="-1"></a><span class="in">    # Aplicar oversampling en el conjunto de entrenamiento interno</span></span>
<span id="cb168-3506"><a href="#cb168-3506" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_entrenamiento_oversampled &lt;- ROSE(ESTADO_ACTUAL ~ ., data = datos_entrenamiento_inner, seed = 123, p = proportion)$data</span></span>
<span id="cb168-3507"><a href="#cb168-3507" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-3508"><a href="#cb168-3508" aria-hidden="true" tabindex="-1"></a><span class="in">    # Definir la fórmula para el modelo</span></span>
<span id="cb168-3509"><a href="#cb168-3509" aria-hidden="true" tabindex="-1"></a><span class="in">    formula &lt;- ESTADO_ACTUAL ~ .</span></span>
<span id="cb168-3510"><a href="#cb168-3510" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-3511"><a href="#cb168-3511" aria-hidden="true" tabindex="-1"></a><span class="in">    # Inicializar variables para almacenar el mejor modelo y su AUC</span></span>
<span id="cb168-3512"><a href="#cb168-3512" aria-hidden="true" tabindex="-1"></a><span class="in">    mejor_auc &lt;- 0</span></span>
<span id="cb168-3513"><a href="#cb168-3513" aria-hidden="true" tabindex="-1"></a><span class="in">    mejor_modelo &lt;- NULL</span></span>
<span id="cb168-3514"><a href="#cb168-3514" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-3515"><a href="#cb168-3515" aria-hidden="true" tabindex="-1"></a><span class="in">    # Definir combinaciones de hiperparámetros a probar</span></span>
<span id="cb168-3516"><a href="#cb168-3516" aria-hidden="true" tabindex="-1"></a><span class="in">    param_grid &lt;- expand.grid(mtry = c(2, 3, 4), </span></span>
<span id="cb168-3517"><a href="#cb168-3517" aria-hidden="true" tabindex="-1"></a><span class="in">                              ntree = c(100, 200, 500),</span></span>
<span id="cb168-3518"><a href="#cb168-3518" aria-hidden="true" tabindex="-1"></a><span class="in">                              maxnodes = c(10, 15, 20))</span></span>
<span id="cb168-3519"><a href="#cb168-3519" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-3520"><a href="#cb168-3520" aria-hidden="true" tabindex="-1"></a><span class="in">    # Bucle para probar diferentes combinaciones de hiperparámetros</span></span>
<span id="cb168-3521"><a href="#cb168-3521" aria-hidden="true" tabindex="-1"></a><span class="in">    for (params in 1:nrow(param_grid)) {</span></span>
<span id="cb168-3522"><a href="#cb168-3522" aria-hidden="true" tabindex="-1"></a><span class="in">      mtry &lt;- param_grid$mtry[params]</span></span>
<span id="cb168-3523"><a href="#cb168-3523" aria-hidden="true" tabindex="-1"></a><span class="in">      ntree &lt;- param_grid$ntree[params]</span></span>
<span id="cb168-3524"><a href="#cb168-3524" aria-hidden="true" tabindex="-1"></a><span class="in">      maxnodes &lt;- param_grid$maxnodes[params]</span></span>
<span id="cb168-3525"><a href="#cb168-3525" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb168-3526"><a href="#cb168-3526" aria-hidden="true" tabindex="-1"></a><span class="in">      # Entrenar el modelo de bosque aleatorio con la combinación de hiperparámetros actual</span></span>
<span id="cb168-3527"><a href="#cb168-3527" aria-hidden="true" tabindex="-1"></a><span class="in">      modelo &lt;- randomForest(formula, data = datos_entrenamiento_oversampled, </span></span>
<span id="cb168-3528"><a href="#cb168-3528" aria-hidden="true" tabindex="-1"></a><span class="in">                             mtry = mtry, ntree = ntree, maxnodes = maxnodes)</span></span>
<span id="cb168-3529"><a href="#cb168-3529" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb168-3530"><a href="#cb168-3530" aria-hidden="true" tabindex="-1"></a><span class="in">      # Realizar predicciones con probabilidades en datos de validación</span></span>
<span id="cb168-3531"><a href="#cb168-3531" aria-hidden="true" tabindex="-1"></a><span class="in">      predicciones_validacion_prob &lt;- predict(modelo, newdata = datos_validacion, type = "prob")[,2]</span></span>
<span id="cb168-3532"><a href="#cb168-3532" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb168-3533"><a href="#cb168-3533" aria-hidden="true" tabindex="-1"></a><span class="in">      # Calcular el AUC</span></span>
<span id="cb168-3534"><a href="#cb168-3534" aria-hidden="true" tabindex="-1"></a><span class="in">      roc_obj &lt;- roc(datos_validacion[["ESTADO_ACTUAL"]], predicciones_validacion_prob, levels = rev(levels(datos_validacion[["ESTADO_ACTUAL"]])))</span></span>
<span id="cb168-3535"><a href="#cb168-3535" aria-hidden="true" tabindex="-1"></a><span class="in">      auc_actual &lt;- auc(roc_obj)</span></span>
<span id="cb168-3536"><a href="#cb168-3536" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb168-3537"><a href="#cb168-3537" aria-hidden="true" tabindex="-1"></a><span class="in">      # Actualizar el mejor modelo y su rendimiento si se encuentra un modelo mejor</span></span>
<span id="cb168-3538"><a href="#cb168-3538" aria-hidden="true" tabindex="-1"></a><span class="in">      if (auc_actual &gt; mejor_auc) {</span></span>
<span id="cb168-3539"><a href="#cb168-3539" aria-hidden="true" tabindex="-1"></a><span class="in">        mejor_auc &lt;- auc_actual</span></span>
<span id="cb168-3540"><a href="#cb168-3540" aria-hidden="true" tabindex="-1"></a><span class="in">        mejor_modelo &lt;- modelo</span></span>
<span id="cb168-3541"><a href="#cb168-3541" aria-hidden="true" tabindex="-1"></a><span class="in">      }</span></span>
<span id="cb168-3542"><a href="#cb168-3542" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb168-3543"><a href="#cb168-3543" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-3544"><a href="#cb168-3544" aria-hidden="true" tabindex="-1"></a><span class="in">    # Calcular las predicciones para el conjunto de validación interno</span></span>
<span id="cb168-3545"><a href="#cb168-3545" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_validacion_prob &lt;- predict(mejor_modelo, newdata = datos_validacion, type = "prob")[,2]</span></span>
<span id="cb168-3546"><a href="#cb168-3546" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-3547"><a href="#cb168-3547" aria-hidden="true" tabindex="-1"></a><span class="in">    # Almacenar las predicciones y objetivos</span></span>
<span id="cb168-3548"><a href="#cb168-3548" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_auc[test_indices_inner] &lt;- predicciones_validacion_prob</span></span>
<span id="cb168-3549"><a href="#cb168-3549" aria-hidden="true" tabindex="-1"></a><span class="in">    targets_auc[test_indices_inner] &lt;- as.numeric(datos_validacion$ESTADO_ACTUAL) - 1</span></span>
<span id="cb168-3550"><a href="#cb168-3550" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-3551"><a href="#cb168-3551" aria-hidden="true" tabindex="-1"></a><span class="in">    # Calcular la sensibilidad y la precisión</span></span>
<span id="cb168-3552"><a href="#cb168-3552" aria-hidden="true" tabindex="-1"></a><span class="in">    umbral &lt;- 0.5</span></span>
<span id="cb168-3553"><a href="#cb168-3553" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_finales &lt;- ifelse(predicciones_validacion_prob &gt;= umbral, "SI", "NO")</span></span>
<span id="cb168-3554"><a href="#cb168-3554" aria-hidden="true" tabindex="-1"></a><span class="in">    TP &lt;- sum(predicciones_finales == "SI" &amp; datos_validacion[["ESTADO_ACTUAL"]] == "SI")</span></span>
<span id="cb168-3555"><a href="#cb168-3555" aria-hidden="true" tabindex="-1"></a><span class="in">    FN &lt;- sum(predicciones_finales == "NO" &amp; datos_validacion[["ESTADO_ACTUAL"]] == "SI")</span></span>
<span id="cb168-3556"><a href="#cb168-3556" aria-hidden="true" tabindex="-1"></a><span class="in">    FP &lt;- sum(predicciones_finales == "SI" &amp; datos_validacion[["ESTADO_ACTUAL"]] == "NO")</span></span>
<span id="cb168-3557"><a href="#cb168-3557" aria-hidden="true" tabindex="-1"></a><span class="in">    TN &lt;- sum(predicciones_finales == "NO" &amp; datos_validacion[["ESTADO_ACTUAL"]] == "NO")</span></span>
<span id="cb168-3558"><a href="#cb168-3558" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-3559"><a href="#cb168-3559" aria-hidden="true" tabindex="-1"></a><span class="in">    recall_actual &lt;- TP / (TP + FN)</span></span>
<span id="cb168-3560"><a href="#cb168-3560" aria-hidden="true" tabindex="-1"></a><span class="in">    accuracy_actual &lt;- (TP + TN) / (TP + FN + FP + TN)</span></span>
<span id="cb168-3561"><a href="#cb168-3561" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-3562"><a href="#cb168-3562" aria-hidden="true" tabindex="-1"></a><span class="in">    # Almacenar resultados internos</span></span>
<span id="cb168-3563"><a href="#cb168-3563" aria-hidden="true" tabindex="-1"></a><span class="in">    resultados_sensibilidad_inner[i_inner] &lt;- recall_actual</span></span>
<span id="cb168-3564"><a href="#cb168-3564" aria-hidden="true" tabindex="-1"></a><span class="in">    resultados_accuracy_inner[i_inner] &lt;- accuracy_actual</span></span>
<span id="cb168-3565"><a href="#cb168-3565" aria-hidden="true" tabindex="-1"></a><span class="in">    resultados_auc_inner[i_inner] &lt;- auc_actual</span></span>
<span id="cb168-3566"><a href="#cb168-3566" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb168-3567"><a href="#cb168-3567" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-3568"><a href="#cb168-3568" aria-hidden="true" tabindex="-1"></a><span class="in">  # Calcular el AUC final para este pliegue externo</span></span>
<span id="cb168-3569"><a href="#cb168-3569" aria-hidden="true" tabindex="-1"></a><span class="in">  auc_fold_externo &lt;- mean(resultados_auc_inner)</span></span>
<span id="cb168-3570"><a href="#cb168-3570" aria-hidden="true" tabindex="-1"></a><span class="in">  accuracy_fold_externo &lt;- mean(resultados_accuracy_inner)</span></span>
<span id="cb168-3571"><a href="#cb168-3571" aria-hidden="true" tabindex="-1"></a><span class="in">  sensibilidad_fold_externo &lt;- mean(resultados_sensibilidad_inner)</span></span>
<span id="cb168-3572"><a href="#cb168-3572" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-3573"><a href="#cb168-3573" aria-hidden="true" tabindex="-1"></a><span class="in">  # Almacenar el AUC del fold externo actual</span></span>
<span id="cb168-3574"><a href="#cb168-3574" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_auc[i_outer] &lt;- auc_fold_externo</span></span>
<span id="cb168-3575"><a href="#cb168-3575" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_accuracy[i_outer] &lt;- accuracy_fold_externo</span></span>
<span id="cb168-3576"><a href="#cb168-3576" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_sensibilidad[i_outer] &lt;- sensibilidad_fold_externo</span></span>
<span id="cb168-3577"><a href="#cb168-3577" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-3578"><a href="#cb168-3578" aria-hidden="true" tabindex="-1"></a><span class="in">  # Predecir en los datos de test para este pliegue externo y almacenar predicciones</span></span>
<span id="cb168-3579"><a href="#cb168-3579" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_test_outer_prob &lt;- predict(mejor_modelo, newdata = datos_test_outer, type = "prob")[,2]</span></span>
<span id="cb168-3580"><a href="#cb168-3580" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_totales[test_indices_outer, i_outer] &lt;- predicciones_test_outer_prob</span></span>
<span id="cb168-3581"><a href="#cb168-3581" aria-hidden="true" tabindex="-1"></a><span class="in">  targets_totales[test_indices_outer] &lt;- as.numeric(datos_test_outer$ESTADO_ACTUAL) - 1</span></span>
<span id="cb168-3582"><a href="#cb168-3582" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb168-3583"><a href="#cb168-3583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3584"><a href="#cb168-3584" aria-hidden="true" tabindex="-1"></a><span class="in"># Calcular AUC promedio</span></span>
<span id="cb168-3585"><a href="#cb168-3585" aria-hidden="true" tabindex="-1"></a><span class="in">auc_promedio &lt;- mean(resultados_auc)</span></span>
<span id="cb168-3586"><a href="#cb168-3586" aria-hidden="true" tabindex="-1"></a><span class="in">accuracy_promedio &lt;- mean(resultados_accuracy)</span></span>
<span id="cb168-3587"><a href="#cb168-3587" aria-hidden="true" tabindex="-1"></a><span class="in">sensibilidad_promedio &lt;- mean(resultados_sensibilidad)</span></span>
<span id="cb168-3588"><a href="#cb168-3588" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3589"><a href="#cb168-3589" aria-hidden="true" tabindex="-1"></a><span class="in"># Crear tabla con todas las métricas</span></span>
<span id="cb168-3590"><a href="#cb168-3590" aria-hidden="true" tabindex="-1"></a><span class="in">tabla_metricas &lt;- data.frame(</span></span>
<span id="cb168-3591"><a href="#cb168-3591" aria-hidden="true" tabindex="-1"></a><span class="in">  Pliegue = 1:k_outer,</span></span>
<span id="cb168-3592"><a href="#cb168-3592" aria-hidden="true" tabindex="-1"></a><span class="in">  AUC = sapply(resultados_auc, round, digits = 3),</span></span>
<span id="cb168-3593"><a href="#cb168-3593" aria-hidden="true" tabindex="-1"></a><span class="in">  Accuracy = sapply(resultados_accuracy, round, digits = 3),</span></span>
<span id="cb168-3594"><a href="#cb168-3594" aria-hidden="true" tabindex="-1"></a><span class="in">  Recall = sapply(resultados_sensibilidad, round, digits = 3)</span></span>
<span id="cb168-3595"><a href="#cb168-3595" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb168-3596"><a href="#cb168-3596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3597"><a href="#cb168-3597" aria-hidden="true" tabindex="-1"></a><span class="in"># Agregar fila con promedio de métricas</span></span>
<span id="cb168-3598"><a href="#cb168-3598" aria-hidden="true" tabindex="-1"></a><span class="in">tabla_metricas_random_forest &lt;- rbind(tabla_metricas, c("Mean", round(auc_promedio, 3), round(accuracy_promedio, 3), round(sensibilidad_promedio, 3)))</span></span>
<span id="cb168-3599"><a href="#cb168-3599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3600"><a href="#cb168-3600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3601"><a href="#cb168-3601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3602"><a href="#cb168-3602" aria-hidden="true" tabindex="-1"></a><span class="in"># Detener el tiempo de ejecución</span></span>
<span id="cb168-3603"><a href="#cb168-3603" aria-hidden="true" tabindex="-1"></a><span class="in">end_time &lt;- Sys.time()</span></span>
<span id="cb168-3604"><a href="#cb168-3604" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time_random_forest &lt;- end_time - start_time</span></span>
<span id="cb168-3605"><a href="#cb168-3605" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time_random_forest &lt;- as.numeric(execution_time_random_forest, units = "secs")</span></span>
<span id="cb168-3606"><a href="#cb168-3606" aria-hidden="true" tabindex="-1"></a><span class="in">save(tabla_metricas_random_forest, file = "tabla_metricas_random_forest.RData")</span></span>
<span id="cb168-3607"><a href="#cb168-3607" aria-hidden="true" tabindex="-1"></a><span class="in">save(execution_time_random_forest, file = "execution_time_random_forest.RData")</span></span>
<span id="cb168-3608"><a href="#cb168-3608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3609"><a href="#cb168-3609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3610"><a href="#cb168-3610" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-3611"><a href="#cb168-3611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3614"><a href="#cb168-3614" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-3615"><a href="#cb168-3615" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"tabla_metricas_random_forest.RData"</span>)</span>
<span id="cb168-3616"><a href="#cb168-3616" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"execution_time_random_forest.RData"</span>)</span>
<span id="cb168-3617"><a href="#cb168-3617" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir el tiempo de ejecución</span></span>
<span id="cb168-3618"><a href="#cb168-3618" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time_random_forest,  <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb168-3619"><a href="#cb168-3619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3620"><a href="#cb168-3620" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-3621"><a href="#cb168-3621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3622"><a href="#cb168-3622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3623"><a href="#cb168-3623" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb168-3624"><a href="#cb168-3624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3625"><a href="#cb168-3625" aria-hidden="true" tabindex="-1"></a><span class="fu"># Metrics Table</span></span>
<span id="cb168-3628"><a href="#cb168-3628" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-3629"><a href="#cb168-3629" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir tabla formateada con kableExtra</span></span>
<span id="cb168-3630"><a href="#cb168-3630" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(tabla_metricas_random_forest, <span class="at">caption =</span> <span class="st">"Cross Validation Metrics"</span>, <span class="at">align =</span> <span class="st">"c"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb168-3631"><a href="#cb168-3631" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb168-3632"><a href="#cb168-3632" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-3633"><a href="#cb168-3633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3634"><a href="#cb168-3634" aria-hidden="true" tabindex="-1"></a><span class="fu"># Metrics Plot</span></span>
<span id="cb168-3637"><a href="#cb168-3637" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-3638"><a href="#cb168-3638" aria-hidden="true" tabindex="-1"></a><span class="fu">crear_plot_metricas_per_fold</span>(tabla_metricas_random_forest)</span>
<span id="cb168-3639"><a href="#cb168-3639" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3640"><a href="#cb168-3640" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-3641"><a href="#cb168-3641" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb168-3642"><a href="#cb168-3642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3643"><a href="#cb168-3643" aria-hidden="true" tabindex="-1"></a>The model is robust and the performance metrics are good. But there there is no hope to surpass the performance of neural network so we are not going to use variable selection in the random forest model.</span>
<span id="cb168-3644"><a href="#cb168-3644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3645"><a href="#cb168-3645" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb168-3646"><a href="#cb168-3646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3647"><a href="#cb168-3647" aria-hidden="true" tabindex="-1"></a><span class="fu"># Naive Bayes {#naive-bayes}</span></span>
<span id="cb168-3648"><a href="#cb168-3648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3649"><a href="#cb168-3649" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset style="background-color: #f0f0f0;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;"}</span>
<span id="cb168-3650"><a href="#cb168-3650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3651"><a href="#cb168-3651" aria-hidden="true" tabindex="-1"></a><span class="fu">## Hold out</span></span>
<span id="cb168-3652"><a href="#cb168-3652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3653"><a href="#cb168-3653" aria-hidden="true" tabindex="-1"></a>In this section we are going to implement a Naive Bayes model. The hyperparameters to optimize are usekernel and laplace.</span>
<span id="cb168-3654"><a href="#cb168-3654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3657"><a href="#cb168-3657" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-3658"><a href="#cb168-3658" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb168-3659"><a href="#cb168-3659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3660"><a href="#cb168-3660" aria-hidden="true" tabindex="-1"></a><span class="co"># Parámetros a cambiar</span></span>
<span id="cb168-3661"><a href="#cb168-3661" aria-hidden="true" tabindex="-1"></a>proportion <span class="ot">&lt;-</span> <span class="fl">0.28</span></span>
<span id="cb168-3662"><a href="#cb168-3662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3663"><a href="#cb168-3663" aria-hidden="true" tabindex="-1"></a><span class="co"># Dividir el conjunto de datos en entrenamiento y test</span></span>
<span id="cb168-3664"><a href="#cb168-3664" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)  <span class="co"># Establecer una semilla para reproducibilidad</span></span>
<span id="cb168-3665"><a href="#cb168-3665" aria-hidden="true" tabindex="-1"></a>indices_entrenamiento <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(data), <span class="fl">0.75</span> <span class="sc">*</span> <span class="fu">nrow</span>(data))  <span class="co"># 75% para entrenamiento</span></span>
<span id="cb168-3666"><a href="#cb168-3666" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento <span class="ot">&lt;-</span> data[indices_entrenamiento, ]</span>
<span id="cb168-3667"><a href="#cb168-3667" aria-hidden="true" tabindex="-1"></a>datos_test <span class="ot">&lt;-</span> data[<span class="sc">-</span>indices_entrenamiento, ]</span>
<span id="cb168-3668"><a href="#cb168-3668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3669"><a href="#cb168-3669" aria-hidden="true" tabindex="-1"></a><span class="co"># Dividir datos de entrenamiento en entrenamiento y validación</span></span>
<span id="cb168-3670"><a href="#cb168-3670" aria-hidden="true" tabindex="-1"></a>train_indices <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(datos_entrenamiento), <span class="fl">0.8</span> <span class="sc">*</span> <span class="fu">nrow</span>(datos_entrenamiento))  <span class="co"># 80% para entrenamiento</span></span>
<span id="cb168-3671"><a href="#cb168-3671" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento_split <span class="ot">&lt;-</span> datos_entrenamiento[train_indices, ]</span>
<span id="cb168-3672"><a href="#cb168-3672" aria-hidden="true" tabindex="-1"></a>datos_validacion <span class="ot">&lt;-</span> datos_entrenamiento[<span class="sc">-</span>train_indices, ]</span>
<span id="cb168-3673"><a href="#cb168-3673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3674"><a href="#cb168-3674" aria-hidden="true" tabindex="-1"></a><span class="co"># Realizar sobremuestreo en los datos de entrenamiento</span></span>
<span id="cb168-3675"><a href="#cb168-3675" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento_oversampled <span class="ot">&lt;-</span> <span class="fu">ROSE</span>(ESTADO_ACTUAL <span class="sc">~</span> ., <span class="at">data =</span> datos_entrenamiento_split, <span class="at">seed =</span> <span class="dv">123</span>, <span class="at">p =</span> proportion)<span class="sc">$</span>data</span>
<span id="cb168-3676"><a href="#cb168-3676" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3677"><a href="#cb168-3677" aria-hidden="true" tabindex="-1"></a><span class="co"># Definir la fórmula para el modelo</span></span>
<span id="cb168-3678"><a href="#cb168-3678" aria-hidden="true" tabindex="-1"></a>formula <span class="ot">&lt;-</span> ESTADO_ACTUAL <span class="sc">~</span> .</span>
<span id="cb168-3679"><a href="#cb168-3679" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3680"><a href="#cb168-3680" aria-hidden="true" tabindex="-1"></a><span class="co"># Inicializar variables para almacenar los resultados</span></span>
<span id="cb168-3681"><a href="#cb168-3681" aria-hidden="true" tabindex="-1"></a>mejor_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb168-3682"><a href="#cb168-3682" aria-hidden="true" tabindex="-1"></a>mejor_modelo <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb168-3683"><a href="#cb168-3683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3684"><a href="#cb168-3684" aria-hidden="true" tabindex="-1"></a><span class="co"># Definir combinaciones de hiperparámetros a probar</span></span>
<span id="cb168-3685"><a href="#cb168-3685" aria-hidden="true" tabindex="-1"></a>param_grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">usekernel =</span> <span class="fu">c</span>(<span class="cn">FALSE</span>, <span class="cn">TRUE</span>), </span>
<span id="cb168-3686"><a href="#cb168-3686" aria-hidden="true" tabindex="-1"></a>                          <span class="at">laplace =</span> <span class="fu">c</span>(<span class="cn">FALSE</span>, <span class="cn">TRUE</span>))</span>
<span id="cb168-3687"><a href="#cb168-3687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3688"><a href="#cb168-3688" aria-hidden="true" tabindex="-1"></a><span class="co"># Bucle para probar diferentes combinaciones de hiperparámetros</span></span>
<span id="cb168-3689"><a href="#cb168-3689" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (params <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(param_grid)) {</span>
<span id="cb168-3690"><a href="#cb168-3690" aria-hidden="true" tabindex="-1"></a>  usekernel <span class="ot">&lt;-</span> param_grid<span class="sc">$</span>usekernel[params]</span>
<span id="cb168-3691"><a href="#cb168-3691" aria-hidden="true" tabindex="-1"></a>  laplace <span class="ot">&lt;-</span> param_grid<span class="sc">$</span>laplace[params]</span>
<span id="cb168-3692"><a href="#cb168-3692" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-3693"><a href="#cb168-3693" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Entrenar el modelo Naive Bayes con la combinación de hiperparámetros actual</span></span>
<span id="cb168-3694"><a href="#cb168-3694" aria-hidden="true" tabindex="-1"></a>  modelo <span class="ot">&lt;-</span> <span class="fu">naiveBayes</span>(formula, <span class="at">data =</span> datos_entrenamiento_oversampled, <span class="at">kernel =</span> usekernel, <span class="at">laplace =</span> laplace)</span>
<span id="cb168-3695"><a href="#cb168-3695" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-3696"><a href="#cb168-3696" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Realizar predicciones en datos de validación</span></span>
<span id="cb168-3697"><a href="#cb168-3697" aria-hidden="true" tabindex="-1"></a>  predicciones_validacion <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelo, <span class="at">newdata =</span> datos_validacion, <span class="at">type =</span> <span class="st">"raw"</span>)</span>
<span id="cb168-3698"><a href="#cb168-3698" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-3699"><a href="#cb168-3699" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular AUC para la combinación actual</span></span>
<span id="cb168-3700"><a href="#cb168-3700" aria-hidden="true" tabindex="-1"></a>  roc_obj <span class="ot">&lt;-</span> <span class="fu">roc</span>(<span class="fu">ifelse</span>(datos_validacion<span class="sc">$</span>ESTADO_ACTUAL <span class="sc">==</span> <span class="st">"SI"</span>, <span class="dv">1</span>, <span class="dv">0</span>), predicciones_validacion[, <span class="st">"SI"</span>])</span>
<span id="cb168-3701"><a href="#cb168-3701" aria-hidden="true" tabindex="-1"></a>  auc_actual <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">auc</span>(roc_obj))  <span class="co"># Extraer el valor numérico del AUC</span></span>
<span id="cb168-3702"><a href="#cb168-3702" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-3703"><a href="#cb168-3703" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Actualizar el mejor modelo y su AUC si se encuentra un modelo mejor</span></span>
<span id="cb168-3704"><a href="#cb168-3704" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (auc_actual <span class="sc">&gt;</span> mejor_auc) {</span>
<span id="cb168-3705"><a href="#cb168-3705" aria-hidden="true" tabindex="-1"></a>    mejor_auc <span class="ot">&lt;-</span> auc_actual</span>
<span id="cb168-3706"><a href="#cb168-3706" aria-hidden="true" tabindex="-1"></a>    mejor_modelo <span class="ot">&lt;-</span> modelo</span>
<span id="cb168-3707"><a href="#cb168-3707" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb168-3708"><a href="#cb168-3708" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb168-3709"><a href="#cb168-3709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3710"><a href="#cb168-3710" aria-hidden="true" tabindex="-1"></a><span class="co"># Resumen del mejor modelo</span></span>
<span id="cb168-3711"><a href="#cb168-3711" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mejor_modelo)</span>
<span id="cb168-3712"><a href="#cb168-3712" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3713"><a href="#cb168-3713" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb168-3714"><a href="#cb168-3714" aria-hidden="true" tabindex="-1"></a>execution_time <span class="ot">&lt;-</span> end_time <span class="sc">-</span> start_time</span>
<span id="cb168-3715"><a href="#cb168-3715" aria-hidden="true" tabindex="-1"></a>execution_time <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(execution_time, <span class="at">units =</span> <span class="st">"secs"</span>)</span>
<span id="cb168-3716"><a href="#cb168-3716" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time, <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb168-3717"><a href="#cb168-3717" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3718"><a href="#cb168-3718" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-3719"><a href="#cb168-3719" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb168-3720"><a href="#cb168-3720" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3721"><a href="#cb168-3721" aria-hidden="true" tabindex="-1"></a><span class="fu">### Predictions</span></span>
<span id="cb168-3722"><a href="#cb168-3722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3723"><a href="#cb168-3723" aria-hidden="true" tabindex="-1"></a>We are going to predict on test in order to get a estimation of the performance of the model.</span>
<span id="cb168-3724"><a href="#cb168-3724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3727"><a href="#cb168-3727" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-3728"><a href="#cb168-3728" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular las predicciones para el conjunto de test</span></span>
<span id="cb168-3729"><a href="#cb168-3729" aria-hidden="true" tabindex="-1"></a>predicciones_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(mejor_modelo, <span class="at">newdata =</span> datos_test, <span class="at">type =</span> <span class="st">"raw"</span>)</span>
<span id="cb168-3730"><a href="#cb168-3730" aria-hidden="true" tabindex="-1"></a>predicciones_test <span class="ot">&lt;-</span> predicciones_test[, <span class="st">"SI"</span>]  <span class="co"># Asumiendo que "SI" es la clase positiva</span></span>
<span id="cb168-3731"><a href="#cb168-3731" aria-hidden="true" tabindex="-1"></a>clases_predichas_test <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predicciones_test <span class="sc">&gt;=</span> <span class="fl">0.5</span>, <span class="st">"SI"</span>, <span class="st">"NO"</span>)</span>
<span id="cb168-3732"><a href="#cb168-3732" aria-hidden="true" tabindex="-1"></a><span class="fu">mostrar_metricas</span>(datos_test<span class="sc">$</span>ESTADO_ACTUAL,clases_predichas_test)</span>
<span id="cb168-3733"><a href="#cb168-3733" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-3734"><a href="#cb168-3734" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3735"><a href="#cb168-3735" aria-hidden="true" tabindex="-1"></a>The performance of the model is definitively acceptable.</span>
<span id="cb168-3736"><a href="#cb168-3736" aria-hidden="true" tabindex="-1"></a>The last step is to ensure that the performance measurements are robust.</span>
<span id="cb168-3737"><a href="#cb168-3737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3738"><a href="#cb168-3738" aria-hidden="true" tabindex="-1"></a><span class="fu">### Roc curve and auc</span></span>
<span id="cb168-3739"><a href="#cb168-3739" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3742"><a href="#cb168-3742" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-3743"><a href="#cb168-3743" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular la curva ROC y el AUC para el conjunto de test</span></span>
<span id="cb168-3744"><a href="#cb168-3744" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_roc_curve</span>(predicciones_test,datos_test<span class="sc">$</span>ESTADO_ACTUAL)</span>
<span id="cb168-3745"><a href="#cb168-3745" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3746"><a href="#cb168-3746" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-3747"><a href="#cb168-3747" aria-hidden="true" tabindex="-1"></a>The model is good in first instance. The next step is to ensure that the model is robust using a 5x2 cross validation.</span>
<span id="cb168-3748"><a href="#cb168-3748" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb168-3749"><a href="#cb168-3749" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3750"><a href="#cb168-3750" aria-hidden="true" tabindex="-1"></a><span class="fu">## 5x2 Cross Validation Filter</span></span>
<span id="cb168-3751"><a href="#cb168-3751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3752"><a href="#cb168-3752" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3753"><a href="#cb168-3753" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=FALSE,message=FALSE, eval=FALSE}</span></span>
<span id="cb168-3754"><a href="#cb168-3754" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3755"><a href="#cb168-3755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3756"><a href="#cb168-3756" aria-hidden="true" tabindex="-1"></a><span class="in"># Iniciar tiempo de ejecución</span></span>
<span id="cb168-3757"><a href="#cb168-3757" aria-hidden="true" tabindex="-1"></a><span class="in">start_time &lt;- Sys.time()</span></span>
<span id="cb168-3758"><a href="#cb168-3758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3759"><a href="#cb168-3759" aria-hidden="true" tabindex="-1"></a><span class="in"># Parámetros a cambiar</span></span>
<span id="cb168-3760"><a href="#cb168-3760" aria-hidden="true" tabindex="-1"></a><span class="in">proportion &lt;- 0.28</span></span>
<span id="cb168-3761"><a href="#cb168-3761" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3762"><a href="#cb168-3762" aria-hidden="true" tabindex="-1"></a><span class="in"># Configurar la validación cruzada 5x3</span></span>
<span id="cb168-3763"><a href="#cb168-3763" aria-hidden="true" tabindex="-1"></a><span class="in">k_outer &lt;- 5  # Número de pliegues externos</span></span>
<span id="cb168-3764"><a href="#cb168-3764" aria-hidden="true" tabindex="-1"></a><span class="in">k_inner &lt;- 3  # Número de pliegues internos</span></span>
<span id="cb168-3765"><a href="#cb168-3765" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(123)  # Establecer semilla para reproducibilidad</span></span>
<span id="cb168-3766"><a href="#cb168-3766" aria-hidden="true" tabindex="-1"></a><span class="in">folds_outer &lt;- createFolds(data$ESTADO_ACTUAL, k = k_outer, list = FALSE)  # Obtener índices de pliegues externos</span></span>
<span id="cb168-3767"><a href="#cb168-3767" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3768"><a href="#cb168-3768" aria-hidden="true" tabindex="-1"></a><span class="in"># Lista para almacenar resultados</span></span>
<span id="cb168-3769"><a href="#cb168-3769" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_auc &lt;- numeric(k_outer)</span></span>
<span id="cb168-3770"><a href="#cb168-3770" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_accuracy &lt;- numeric(k_outer)</span></span>
<span id="cb168-3771"><a href="#cb168-3771" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_sensibilidad &lt;- numeric(k_outer)</span></span>
<span id="cb168-3772"><a href="#cb168-3772" aria-hidden="true" tabindex="-1"></a><span class="in">indices &lt;- 1:nrow(data)</span></span>
<span id="cb168-3773"><a href="#cb168-3773" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3774"><a href="#cb168-3774" aria-hidden="true" tabindex="-1"></a><span class="in"># Inicializar matrices para almacenar predicciones y objetivos</span></span>
<span id="cb168-3775"><a href="#cb168-3775" aria-hidden="true" tabindex="-1"></a><span class="in">predicciones_totales &lt;- matrix(NA, nrow = nrow(data), ncol = k_outer)</span></span>
<span id="cb168-3776"><a href="#cb168-3776" aria-hidden="true" tabindex="-1"></a><span class="in">targets_totales &lt;- numeric(nrow(data))</span></span>
<span id="cb168-3777"><a href="#cb168-3777" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3778"><a href="#cb168-3778" aria-hidden="true" tabindex="-1"></a><span class="in"># Iterar sobre cada pliegue externo y realizar el proceso de modelado</span></span>
<span id="cb168-3779"><a href="#cb168-3779" aria-hidden="true" tabindex="-1"></a><span class="in">for (i_outer in 1:k_outer) {</span></span>
<span id="cb168-3780"><a href="#cb168-3780" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3781"><a href="#cb168-3781" aria-hidden="true" tabindex="-1"></a><span class="in">  # Obtener los índices para el pliegue externo actual</span></span>
<span id="cb168-3782"><a href="#cb168-3782" aria-hidden="true" tabindex="-1"></a><span class="in">  test_indices_outer &lt;- indices[folds_outer == i_outer]  # Índices correspondientes al pliegue externo de test</span></span>
<span id="cb168-3783"><a href="#cb168-3783" aria-hidden="true" tabindex="-1"></a><span class="in">  train_indices_outer &lt;- setdiff(1:nrow(data), test_indices_outer)  # Índices correspondientes al conjunto de entrenamiento</span></span>
<span id="cb168-3784"><a href="#cb168-3784" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-3785"><a href="#cb168-3785" aria-hidden="true" tabindex="-1"></a><span class="in">  # Dividir datos en entrenamiento y test para el pliegue externo</span></span>
<span id="cb168-3786"><a href="#cb168-3786" aria-hidden="true" tabindex="-1"></a><span class="in">  datos_entrenamiento_outer &lt;- data[train_indices_outer, ]</span></span>
<span id="cb168-3787"><a href="#cb168-3787" aria-hidden="true" tabindex="-1"></a><span class="in">  datos_test_outer &lt;- data[test_indices_outer, ]</span></span>
<span id="cb168-3788"><a href="#cb168-3788" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-3789"><a href="#cb168-3789" aria-hidden="true" tabindex="-1"></a><span class="in">  # Configurar la validación cruzada interna</span></span>
<span id="cb168-3790"><a href="#cb168-3790" aria-hidden="true" tabindex="-1"></a><span class="in">  folds_inner &lt;- createFolds(datos_entrenamiento_outer$ESTADO_ACTUAL, k = k_inner, list = FALSE)  # Obtener índices de pliegues internos</span></span>
<span id="cb168-3791"><a href="#cb168-3791" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-3792"><a href="#cb168-3792" aria-hidden="true" tabindex="-1"></a><span class="in">  # Almacenar predicciones y objetivos para el AUC general</span></span>
<span id="cb168-3793"><a href="#cb168-3793" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_auc &lt;- numeric(nrow(datos_entrenamiento_outer))</span></span>
<span id="cb168-3794"><a href="#cb168-3794" aria-hidden="true" tabindex="-1"></a><span class="in">  targets_auc &lt;- numeric(nrow(datos_entrenamiento_outer))</span></span>
<span id="cb168-3795"><a href="#cb168-3795" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-3796"><a href="#cb168-3796" aria-hidden="true" tabindex="-1"></a><span class="in">  # Inicializar variables para almacenar resultados internos</span></span>
<span id="cb168-3797"><a href="#cb168-3797" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_auc_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-3798"><a href="#cb168-3798" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_accuracy_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-3799"><a href="#cb168-3799" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_sensibilidad_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-3800"><a href="#cb168-3800" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-3801"><a href="#cb168-3801" aria-hidden="true" tabindex="-1"></a><span class="in">  # Iterar sobre cada pliegue interno para selección de modelo</span></span>
<span id="cb168-3802"><a href="#cb168-3802" aria-hidden="true" tabindex="-1"></a><span class="in">  indices_inner &lt;- 1:nrow(datos_entrenamiento_outer)</span></span>
<span id="cb168-3803"><a href="#cb168-3803" aria-hidden="true" tabindex="-1"></a><span class="in">  for (i_inner in 1:k_inner) {</span></span>
<span id="cb168-3804"><a href="#cb168-3804" aria-hidden="true" tabindex="-1"></a><span class="in">    # Obtener los índices para el pliegue interno actual</span></span>
<span id="cb168-3805"><a href="#cb168-3805" aria-hidden="true" tabindex="-1"></a><span class="in">    test_indices_inner &lt;- indices_inner[folds_inner == i_inner]  # Índices correspondientes al pliegue interno de test</span></span>
<span id="cb168-3806"><a href="#cb168-3806" aria-hidden="true" tabindex="-1"></a><span class="in">    train_indices_inner &lt;- setdiff(1:nrow(datos_entrenamiento_outer), test_indices_inner)  # Índices correspondientes al conjunto de entrenamiento interno</span></span>
<span id="cb168-3807"><a href="#cb168-3807" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-3808"><a href="#cb168-3808" aria-hidden="true" tabindex="-1"></a><span class="in">    # Dividir datos en entrenamiento y test para el pliegue interno</span></span>
<span id="cb168-3809"><a href="#cb168-3809" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_entrenamiento_inner &lt;- datos_entrenamiento_outer[train_indices_inner, ]</span></span>
<span id="cb168-3810"><a href="#cb168-3810" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_validacion &lt;- datos_entrenamiento_outer[test_indices_inner, ]</span></span>
<span id="cb168-3811"><a href="#cb168-3811" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-3812"><a href="#cb168-3812" aria-hidden="true" tabindex="-1"></a><span class="in">    # Aplicar oversampling en el conjunto de entrenamiento interno</span></span>
<span id="cb168-3813"><a href="#cb168-3813" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_entrenamiento_oversampled &lt;- ROSE(ESTADO_ACTUAL ~ ., data = datos_entrenamiento_inner, seed = 123, p = proportion)$data</span></span>
<span id="cb168-3814"><a href="#cb168-3814" aria-hidden="true" tabindex="-1"></a><span class="in">    for (params in 1:nrow(param_grid)) {</span></span>
<span id="cb168-3815"><a href="#cb168-3815" aria-hidden="true" tabindex="-1"></a><span class="in">      usekernel &lt;- param_grid$usekernel[params]</span></span>
<span id="cb168-3816"><a href="#cb168-3816" aria-hidden="true" tabindex="-1"></a><span class="in">      laplace &lt;- param_grid$laplace[params]</span></span>
<span id="cb168-3817"><a href="#cb168-3817" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb168-3818"><a href="#cb168-3818" aria-hidden="true" tabindex="-1"></a><span class="in">      # Entrenar el modelo Naive Bayes con la combinación de hiperparámetros actual</span></span>
<span id="cb168-3819"><a href="#cb168-3819" aria-hidden="true" tabindex="-1"></a><span class="in">      modelo &lt;- naiveBayes(formula, data = datos_entrenamiento_oversampled, kernel = usekernel, laplace = laplace)</span></span>
<span id="cb168-3820"><a href="#cb168-3820" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb168-3821"><a href="#cb168-3821" aria-hidden="true" tabindex="-1"></a><span class="in">      # Realizar predicciones en datos de validación</span></span>
<span id="cb168-3822"><a href="#cb168-3822" aria-hidden="true" tabindex="-1"></a><span class="in">      predicciones_validacion &lt;- predict(modelo, newdata = datos_validacion, type = "raw")</span></span>
<span id="cb168-3823"><a href="#cb168-3823" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb168-3824"><a href="#cb168-3824" aria-hidden="true" tabindex="-1"></a><span class="in">      # Calcular AUC para la combinación actual</span></span>
<span id="cb168-3825"><a href="#cb168-3825" aria-hidden="true" tabindex="-1"></a><span class="in">      roc_obj &lt;- roc(ifelse(datos_validacion$ESTADO_ACTUAL == "SI", 1, 0), predicciones_validacion[, "SI"])</span></span>
<span id="cb168-3826"><a href="#cb168-3826" aria-hidden="true" tabindex="-1"></a><span class="in">      auc_actual &lt;- as.numeric(auc(roc_obj))  # Extraer el valor numérico del AUC</span></span>
<span id="cb168-3827"><a href="#cb168-3827" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb168-3828"><a href="#cb168-3828" aria-hidden="true" tabindex="-1"></a><span class="in">      # Actualizar el mejor modelo y su AUC si se encuentra un modelo mejor</span></span>
<span id="cb168-3829"><a href="#cb168-3829" aria-hidden="true" tabindex="-1"></a><span class="in">      if (auc_actual &gt; mejor_auc) {</span></span>
<span id="cb168-3830"><a href="#cb168-3830" aria-hidden="true" tabindex="-1"></a><span class="in">        mejor_auc &lt;- auc_actual</span></span>
<span id="cb168-3831"><a href="#cb168-3831" aria-hidden="true" tabindex="-1"></a><span class="in">        mejor_modelo &lt;- modelo</span></span>
<span id="cb168-3832"><a href="#cb168-3832" aria-hidden="true" tabindex="-1"></a><span class="in">      }</span></span>
<span id="cb168-3833"><a href="#cb168-3833" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb168-3834"><a href="#cb168-3834" aria-hidden="true" tabindex="-1"></a><span class="in">    # Almacenar las predicciones y objetivos</span></span>
<span id="cb168-3835"><a href="#cb168-3835" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_auc[test_indices_inner] &lt;- predicciones_validacion_prob</span></span>
<span id="cb168-3836"><a href="#cb168-3836" aria-hidden="true" tabindex="-1"></a><span class="in">    targets_auc[test_indices_inner] &lt;- as.numeric(datos_validacion$ESTADO_ACTUAL) - 1</span></span>
<span id="cb168-3837"><a href="#cb168-3837" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-3838"><a href="#cb168-3838" aria-hidden="true" tabindex="-1"></a><span class="in">    # Calcular la sensibilidad y la precisión</span></span>
<span id="cb168-3839"><a href="#cb168-3839" aria-hidden="true" tabindex="-1"></a><span class="in">    umbral &lt;- 0.5</span></span>
<span id="cb168-3840"><a href="#cb168-3840" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_finales &lt;- ifelse(predicciones_validacion_prob &gt;= umbral, "SI", "NO")</span></span>
<span id="cb168-3841"><a href="#cb168-3841" aria-hidden="true" tabindex="-1"></a><span class="in">    TP &lt;- sum(predicciones_finales == "SI" &amp; datos_validacion[["ESTADO_ACTUAL"]] == "SI")</span></span>
<span id="cb168-3842"><a href="#cb168-3842" aria-hidden="true" tabindex="-1"></a><span class="in">    FN &lt;- sum(predicciones_finales == "NO" &amp; datos_validacion[["ESTADO_ACTUAL"]] == "SI")</span></span>
<span id="cb168-3843"><a href="#cb168-3843" aria-hidden="true" tabindex="-1"></a><span class="in">    FP &lt;- sum(predicciones_finales == "SI" &amp; datos_validacion[["ESTADO_ACTUAL"]] == "NO")</span></span>
<span id="cb168-3844"><a href="#cb168-3844" aria-hidden="true" tabindex="-1"></a><span class="in">    TN &lt;- sum(predicciones_finales == "NO" &amp; datos_validacion[["ESTADO_ACTUAL"]] == "NO")</span></span>
<span id="cb168-3845"><a href="#cb168-3845" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-3846"><a href="#cb168-3846" aria-hidden="true" tabindex="-1"></a><span class="in">    recall_actual &lt;- TP / (TP + FN)</span></span>
<span id="cb168-3847"><a href="#cb168-3847" aria-hidden="true" tabindex="-1"></a><span class="in">    accuracy_actual &lt;- (TP + TN) / (TP + FN + FP + TN)</span></span>
<span id="cb168-3848"><a href="#cb168-3848" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-3849"><a href="#cb168-3849" aria-hidden="true" tabindex="-1"></a><span class="in">    # Almacenar resultados internos</span></span>
<span id="cb168-3850"><a href="#cb168-3850" aria-hidden="true" tabindex="-1"></a><span class="in">    resultados_sensibilidad_inner[i_inner] &lt;- recall_actual</span></span>
<span id="cb168-3851"><a href="#cb168-3851" aria-hidden="true" tabindex="-1"></a><span class="in">    resultados_accuracy_inner[i_inner] &lt;- accuracy_actual</span></span>
<span id="cb168-3852"><a href="#cb168-3852" aria-hidden="true" tabindex="-1"></a><span class="in">    resultados_auc_inner[i_inner] &lt;- auc_actual</span></span>
<span id="cb168-3853"><a href="#cb168-3853" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb168-3854"><a href="#cb168-3854" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-3855"><a href="#cb168-3855" aria-hidden="true" tabindex="-1"></a><span class="in">  # Calcular el AUC final para este pliegue externo</span></span>
<span id="cb168-3856"><a href="#cb168-3856" aria-hidden="true" tabindex="-1"></a><span class="in">  auc_fold_externo &lt;- mean(resultados_auc_inner)</span></span>
<span id="cb168-3857"><a href="#cb168-3857" aria-hidden="true" tabindex="-1"></a><span class="in">  accuracy_fold_externo &lt;- mean(resultados_accuracy_inner)</span></span>
<span id="cb168-3858"><a href="#cb168-3858" aria-hidden="true" tabindex="-1"></a><span class="in">  sensibilidad_fold_externo &lt;- mean(resultados_sensibilidad_inner)</span></span>
<span id="cb168-3859"><a href="#cb168-3859" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-3860"><a href="#cb168-3860" aria-hidden="true" tabindex="-1"></a><span class="in">  # Almacenar el AUC del fold externo actual</span></span>
<span id="cb168-3861"><a href="#cb168-3861" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_auc[i_outer] &lt;- auc_fold_externo</span></span>
<span id="cb168-3862"><a href="#cb168-3862" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_accuracy[i_outer] &lt;- accuracy_fold_externo</span></span>
<span id="cb168-3863"><a href="#cb168-3863" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_sensibilidad[i_outer] &lt;- sensibilidad_fold_externo</span></span>
<span id="cb168-3864"><a href="#cb168-3864" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-3865"><a href="#cb168-3865" aria-hidden="true" tabindex="-1"></a><span class="in">  # Predecir en los datos de test para este pliegue externo y almacenar predicciones</span></span>
<span id="cb168-3866"><a href="#cb168-3866" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_test_outer_prob &lt;- predict(modelo, newdata = datos_test_outer, type = "raw")[,2]</span></span>
<span id="cb168-3867"><a href="#cb168-3867" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_totales[test_indices_outer, i_outer] &lt;- predicciones_test_outer_prob</span></span>
<span id="cb168-3868"><a href="#cb168-3868" aria-hidden="true" tabindex="-1"></a><span class="in">  targets_totales[test_indices_outer] &lt;- as.numeric(datos_test_outer$ESTADO_ACTUAL) - 1</span></span>
<span id="cb168-3869"><a href="#cb168-3869" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb168-3870"><a href="#cb168-3870" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3871"><a href="#cb168-3871" aria-hidden="true" tabindex="-1"></a><span class="in"># Calcular AUC promedio</span></span>
<span id="cb168-3872"><a href="#cb168-3872" aria-hidden="true" tabindex="-1"></a><span class="in">auc_promedio &lt;- mean(resultados_auc)</span></span>
<span id="cb168-3873"><a href="#cb168-3873" aria-hidden="true" tabindex="-1"></a><span class="in">accuracy_promedio &lt;- mean(resultados_accuracy)</span></span>
<span id="cb168-3874"><a href="#cb168-3874" aria-hidden="true" tabindex="-1"></a><span class="in">sensibilidad_promedio &lt;- mean(resultados_sensibilidad)</span></span>
<span id="cb168-3875"><a href="#cb168-3875" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3876"><a href="#cb168-3876" aria-hidden="true" tabindex="-1"></a><span class="in"># Crear tabla con todas las métricas</span></span>
<span id="cb168-3877"><a href="#cb168-3877" aria-hidden="true" tabindex="-1"></a><span class="in">tabla_metricas &lt;- data.frame(</span></span>
<span id="cb168-3878"><a href="#cb168-3878" aria-hidden="true" tabindex="-1"></a><span class="in">  Pliegue = 1:k_outer,</span></span>
<span id="cb168-3879"><a href="#cb168-3879" aria-hidden="true" tabindex="-1"></a><span class="in">  AUC = sapply(resultados_auc, round, digits = 3),</span></span>
<span id="cb168-3880"><a href="#cb168-3880" aria-hidden="true" tabindex="-1"></a><span class="in">  Accuracy = sapply(resultados_accuracy, round, digits = 3),</span></span>
<span id="cb168-3881"><a href="#cb168-3881" aria-hidden="true" tabindex="-1"></a><span class="in">  Recall = sapply(resultados_sensibilidad, round, digits = 3)</span></span>
<span id="cb168-3882"><a href="#cb168-3882" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb168-3883"><a href="#cb168-3883" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3884"><a href="#cb168-3884" aria-hidden="true" tabindex="-1"></a><span class="in"># Agregar fila con promedio de métricas</span></span>
<span id="cb168-3885"><a href="#cb168-3885" aria-hidden="true" tabindex="-1"></a><span class="in">tabla_metricas_naive &lt;- rbind(tabla_metricas, c("Mean", round(auc_promedio, 3), round(accuracy_promedio, 3), round(sensibilidad_promedio, 3)))</span></span>
<span id="cb168-3886"><a href="#cb168-3886" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3887"><a href="#cb168-3887" aria-hidden="true" tabindex="-1"></a><span class="in"># Detener el tiempo de ejecución</span></span>
<span id="cb168-3888"><a href="#cb168-3888" aria-hidden="true" tabindex="-1"></a><span class="in">end_time &lt;- Sys.time()</span></span>
<span id="cb168-3889"><a href="#cb168-3889" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time_naive &lt;- end_time - start_time</span></span>
<span id="cb168-3890"><a href="#cb168-3890" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time_naive &lt;- as.numeric(execution_time_naive, units = "secs")</span></span>
<span id="cb168-3891"><a href="#cb168-3891" aria-hidden="true" tabindex="-1"></a><span class="in">save(tabla_metricas_naive, file = "tabla_metricas_naive_filter.RData")</span></span>
<span id="cb168-3892"><a href="#cb168-3892" aria-hidden="true" tabindex="-1"></a><span class="in">save(execution_time_naive, file = "execution_time_naive_filter.RData")</span></span>
<span id="cb168-3893"><a href="#cb168-3893" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3894"><a href="#cb168-3894" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-3895"><a href="#cb168-3895" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3898"><a href="#cb168-3898" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-3899"><a href="#cb168-3899" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"tabla_metricas_naive_filter.RData"</span>)</span>
<span id="cb168-3900"><a href="#cb168-3900" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"execution_time_naive_filter.RData"</span>)</span>
<span id="cb168-3901"><a href="#cb168-3901" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir el tiempo de ejecución</span></span>
<span id="cb168-3902"><a href="#cb168-3902" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time_naive,  <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb168-3903"><a href="#cb168-3903" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3904"><a href="#cb168-3904" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3905"><a href="#cb168-3905" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3906"><a href="#cb168-3906" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-3907"><a href="#cb168-3907" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3908"><a href="#cb168-3908" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb168-3909"><a href="#cb168-3909" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3910"><a href="#cb168-3910" aria-hidden="true" tabindex="-1"></a><span class="fu"># Metrics Table</span></span>
<span id="cb168-3913"><a href="#cb168-3913" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-3914"><a href="#cb168-3914" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir tabla formateada con kableExtra</span></span>
<span id="cb168-3915"><a href="#cb168-3915" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(tabla_metricas_naive, <span class="at">caption =</span> <span class="st">"Cross Validation Metrics"</span>, <span class="at">align =</span> <span class="st">"c"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb168-3916"><a href="#cb168-3916" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb168-3917"><a href="#cb168-3917" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-3918"><a href="#cb168-3918" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3919"><a href="#cb168-3919" aria-hidden="true" tabindex="-1"></a><span class="fu"># Metrics Plot</span></span>
<span id="cb168-3922"><a href="#cb168-3922" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-3923"><a href="#cb168-3923" aria-hidden="true" tabindex="-1"></a><span class="fu">crear_plot_metricas_per_fold</span>(tabla_metricas_naive)</span>
<span id="cb168-3924"><a href="#cb168-3924" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3925"><a href="#cb168-3925" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-3926"><a href="#cb168-3926" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb168-3927"><a href="#cb168-3927" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3928"><a href="#cb168-3928" aria-hidden="true" tabindex="-1"></a>The model is one of the best so far. The performance metrics are good and the model is robust. The next step is to use a variable selection method to improve the model. We are going to use brute force wrapper to select the best variables.</span>
<span id="cb168-3929"><a href="#cb168-3929" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3930"><a href="#cb168-3930" aria-hidden="true" tabindex="-1"></a><span class="fu">## 5x2 Cross Validation Wrapper</span></span>
<span id="cb168-3931"><a href="#cb168-3931" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3932"><a href="#cb168-3932" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=FALSE,message=FALSE, eval=FALSE}</span></span>
<span id="cb168-3933"><a href="#cb168-3933" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3934"><a href="#cb168-3934" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3935"><a href="#cb168-3935" aria-hidden="true" tabindex="-1"></a><span class="in"># Iniciar tiempo de ejecución</span></span>
<span id="cb168-3936"><a href="#cb168-3936" aria-hidden="true" tabindex="-1"></a><span class="in">start_time &lt;- Sys.time()</span></span>
<span id="cb168-3937"><a href="#cb168-3937" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3938"><a href="#cb168-3938" aria-hidden="true" tabindex="-1"></a><span class="in"># Parámetros a cambiar</span></span>
<span id="cb168-3939"><a href="#cb168-3939" aria-hidden="true" tabindex="-1"></a><span class="in">proportion &lt;- 0.28</span></span>
<span id="cb168-3940"><a href="#cb168-3940" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3941"><a href="#cb168-3941" aria-hidden="true" tabindex="-1"></a><span class="in"># Configurar la validación cruzada 5x2</span></span>
<span id="cb168-3942"><a href="#cb168-3942" aria-hidden="true" tabindex="-1"></a><span class="in">k_outer &lt;- 5  # Número de pliegues externos</span></span>
<span id="cb168-3943"><a href="#cb168-3943" aria-hidden="true" tabindex="-1"></a><span class="in">k_inner &lt;- 2  # Número de pliegues internos</span></span>
<span id="cb168-3944"><a href="#cb168-3944" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3945"><a href="#cb168-3945" aria-hidden="true" tabindex="-1"></a><span class="in"># Lista para almacenar resultados</span></span>
<span id="cb168-3946"><a href="#cb168-3946" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_auc &lt;- numeric(k_outer)</span></span>
<span id="cb168-3947"><a href="#cb168-3947" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_accuracy &lt;- numeric(k_outer)</span></span>
<span id="cb168-3948"><a href="#cb168-3948" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_sensibilidad &lt;- numeric(k_outer)</span></span>
<span id="cb168-3949"><a href="#cb168-3949" aria-hidden="true" tabindex="-1"></a><span class="in">indices &lt;- 1:nrow(data)</span></span>
<span id="cb168-3950"><a href="#cb168-3950" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3951"><a href="#cb168-3951" aria-hidden="true" tabindex="-1"></a><span class="in"># Inicializar matrices para almacenar predicciones y objetivos</span></span>
<span id="cb168-3952"><a href="#cb168-3952" aria-hidden="true" tabindex="-1"></a><span class="in">predicciones_totales &lt;- matrix(NA, nrow = nrow(data), ncol = k_outer)</span></span>
<span id="cb168-3953"><a href="#cb168-3953" aria-hidden="true" tabindex="-1"></a><span class="in">targets_totales &lt;- numeric(nrow(data))</span></span>
<span id="cb168-3954"><a href="#cb168-3954" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3955"><a href="#cb168-3955" aria-hidden="true" tabindex="-1"></a><span class="in"># Iterar sobre cada pliegue externo y realizar el proceso de modelado</span></span>
<span id="cb168-3956"><a href="#cb168-3956" aria-hidden="true" tabindex="-1"></a><span class="in">for (i_outer in 1:k_outer) {</span></span>
<span id="cb168-3957"><a href="#cb168-3957" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-3958"><a href="#cb168-3958" aria-hidden="true" tabindex="-1"></a><span class="in">  # Obtener los índices para el pliegue externo actual</span></span>
<span id="cb168-3959"><a href="#cb168-3959" aria-hidden="true" tabindex="-1"></a><span class="in">  test_indices_outer &lt;- indices[folds_outer == i_outer]  # Índices correspondientes al pliegue externo de test</span></span>
<span id="cb168-3960"><a href="#cb168-3960" aria-hidden="true" tabindex="-1"></a><span class="in">  train_indices_outer &lt;- setdiff(1:nrow(data), test_indices_outer)  # Índices correspondientes al conjunto de entrenamiento</span></span>
<span id="cb168-3961"><a href="#cb168-3961" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-3962"><a href="#cb168-3962" aria-hidden="true" tabindex="-1"></a><span class="in">  # Dividir datos en entrenamiento y test para el pliegue externo</span></span>
<span id="cb168-3963"><a href="#cb168-3963" aria-hidden="true" tabindex="-1"></a><span class="in">  datos_entrenamiento_outer &lt;- data[train_indices_outer, ]</span></span>
<span id="cb168-3964"><a href="#cb168-3964" aria-hidden="true" tabindex="-1"></a><span class="in">  datos_test_outer &lt;- data[test_indices_outer, ]</span></span>
<span id="cb168-3965"><a href="#cb168-3965" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-3966"><a href="#cb168-3966" aria-hidden="true" tabindex="-1"></a><span class="in">  # Configurar la validación cruzada interna</span></span>
<span id="cb168-3967"><a href="#cb168-3967" aria-hidden="true" tabindex="-1"></a><span class="in">  folds_inner &lt;- createFolds(datos_entrenamiento_outer$ESTADO_ACTUAL, k = k_inner, list = FALSE)  # Obtener índices de pliegues internos</span></span>
<span id="cb168-3968"><a href="#cb168-3968" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-3969"><a href="#cb168-3969" aria-hidden="true" tabindex="-1"></a><span class="in">  # Almacenar predicciones y objetivos para el AUC general</span></span>
<span id="cb168-3970"><a href="#cb168-3970" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_auc &lt;- numeric(nrow(datos_entrenamiento_outer))</span></span>
<span id="cb168-3971"><a href="#cb168-3971" aria-hidden="true" tabindex="-1"></a><span class="in">  targets_auc &lt;- numeric(nrow(datos_entrenamiento_outer))</span></span>
<span id="cb168-3972"><a href="#cb168-3972" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-3973"><a href="#cb168-3973" aria-hidden="true" tabindex="-1"></a><span class="in">  # Inicializar variables para almacenar resultados internos</span></span>
<span id="cb168-3974"><a href="#cb168-3974" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_auc_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-3975"><a href="#cb168-3975" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_accuracy_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-3976"><a href="#cb168-3976" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_sensibilidad_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-3977"><a href="#cb168-3977" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-3978"><a href="#cb168-3978" aria-hidden="true" tabindex="-1"></a><span class="in">  # Iterar sobre cada pliegue interno para selección de modelo</span></span>
<span id="cb168-3979"><a href="#cb168-3979" aria-hidden="true" tabindex="-1"></a><span class="in">  indices_inner &lt;- 1:nrow(datos_entrenamiento_outer)</span></span>
<span id="cb168-3980"><a href="#cb168-3980" aria-hidden="true" tabindex="-1"></a><span class="in">  for (i_inner in 1:k_inner) {</span></span>
<span id="cb168-3981"><a href="#cb168-3981" aria-hidden="true" tabindex="-1"></a><span class="in">    # Obtener los índices para el pliegue interno actual</span></span>
<span id="cb168-3982"><a href="#cb168-3982" aria-hidden="true" tabindex="-1"></a><span class="in">    test_indices_inner &lt;- indices_inner[folds_inner == i_inner]  # Índices correspondientes al pliegue interno de test</span></span>
<span id="cb168-3983"><a href="#cb168-3983" aria-hidden="true" tabindex="-1"></a><span class="in">    train_indices_inner &lt;- setdiff(1:nrow(datos_entrenamiento_outer), test_indices_inner)  # Índices correspondientes al conjunto de entrenamiento interno</span></span>
<span id="cb168-3984"><a href="#cb168-3984" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-3985"><a href="#cb168-3985" aria-hidden="true" tabindex="-1"></a><span class="in">    # Dividir datos en entrenamiento y test para el pliegue interno</span></span>
<span id="cb168-3986"><a href="#cb168-3986" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_entrenamiento_inner &lt;- datos_entrenamiento_outer[train_indices_inner, ]</span></span>
<span id="cb168-3987"><a href="#cb168-3987" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_validacion &lt;- datos_entrenamiento_outer[test_indices_inner, ]</span></span>
<span id="cb168-3988"><a href="#cb168-3988" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-3989"><a href="#cb168-3989" aria-hidden="true" tabindex="-1"></a><span class="in">    # Almacenar predicciones y objetivos para el AUC interno</span></span>
<span id="cb168-3990"><a href="#cb168-3990" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_auc &lt;- numeric(nrow(datos_validacion))</span></span>
<span id="cb168-3991"><a href="#cb168-3991" aria-hidden="true" tabindex="-1"></a><span class="in">    targets_auc &lt;- numeric(nrow(datos_validacion))</span></span>
<span id="cb168-3992"><a href="#cb168-3992" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-3993"><a href="#cb168-3993" aria-hidden="true" tabindex="-1"></a><span class="in">    # Definir todas las combinaciones de variables (sustituye esto por tus combinaciones reales)</span></span>
<span id="cb168-3994"><a href="#cb168-3994" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3995"><a href="#cb168-3995" aria-hidden="true" tabindex="-1"></a><span class="in">    # Iterar sobre cada combinación de variables para selección de modelo</span></span>
<span id="cb168-3996"><a href="#cb168-3996" aria-hidden="true" tabindex="-1"></a><span class="in">    for (combinacion in combinaciones_variables) {</span></span>
<span id="cb168-3997"><a href="#cb168-3997" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb168-3998"><a href="#cb168-3998" aria-hidden="true" tabindex="-1"></a><span class="in">      # Aplicar oversampling en el conjunto de entrenamiento interno</span></span>
<span id="cb168-3999"><a href="#cb168-3999" aria-hidden="true" tabindex="-1"></a><span class="in">      datos_entrenamiento_oversampled &lt;- ROSE(ESTADO_ACTUAL ~ ., data = datos_entrenamiento_inner, p = proportion)$data</span></span>
<span id="cb168-4000"><a href="#cb168-4000" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb168-4001"><a href="#cb168-4001" aria-hidden="true" tabindex="-1"></a><span class="in">      # Definir la fórmula para el modelo</span></span>
<span id="cb168-4002"><a href="#cb168-4002" aria-hidden="true" tabindex="-1"></a><span class="in">      formula_actual &lt;- as.formula(paste("ESTADO_ACTUAL", "~", paste(combinacion, collapse = "+")))</span></span>
<span id="cb168-4003"><a href="#cb168-4003" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb168-4004"><a href="#cb168-4004" aria-hidden="true" tabindex="-1"></a><span class="in">      # Entrenar el modelo Naive Bayes</span></span>
<span id="cb168-4005"><a href="#cb168-4005" aria-hidden="true" tabindex="-1"></a><span class="in">      modelo &lt;- naiveBayes(formula_actual, data = datos_entrenamiento_oversampled)</span></span>
<span id="cb168-4006"><a href="#cb168-4006" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb168-4007"><a href="#cb168-4007" aria-hidden="true" tabindex="-1"></a><span class="in">      # Realizar predicciones con probabilidades en datos de validación</span></span>
<span id="cb168-4008"><a href="#cb168-4008" aria-hidden="true" tabindex="-1"></a><span class="in">      predicciones_validacion_prob &lt;- predict(modelo, newdata = datos_validacion, type = "raw")[,2]</span></span>
<span id="cb168-4009"><a href="#cb168-4009" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb168-4010"><a href="#cb168-4010" aria-hidden="true" tabindex="-1"></a><span class="in">      # Calcular el AUC</span></span>
<span id="cb168-4011"><a href="#cb168-4011" aria-hidden="true" tabindex="-1"></a><span class="in">      roc_obj &lt;- roc(datos_validacion$ESTADO_ACTUAL, predicciones_validacion_prob, levels = rev(levels(datos_validacion$ESTADO_ACTUAL)))</span></span>
<span id="cb168-4012"><a href="#cb168-4012" aria-hidden="true" tabindex="-1"></a><span class="in">      auc_actual &lt;- auc(roc_obj)</span></span>
<span id="cb168-4013"><a href="#cb168-4013" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb168-4014"><a href="#cb168-4014" aria-hidden="true" tabindex="-1"></a><span class="in">      # Almacenar las predicciones y objetivos</span></span>
<span id="cb168-4015"><a href="#cb168-4015" aria-hidden="true" tabindex="-1"></a><span class="in">      predicciones_auc[test_indices_inner] &lt;- predicciones_validacion_prob</span></span>
<span id="cb168-4016"><a href="#cb168-4016" aria-hidden="true" tabindex="-1"></a><span class="in">      targets_auc[test_indices_inner] &lt;- as.numeric(datos_validacion$ESTADO_ACTUAL) - 1</span></span>
<span id="cb168-4017"><a href="#cb168-4017" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb168-4018"><a href="#cb168-4018" aria-hidden="true" tabindex="-1"></a><span class="in">      # Calcular la sensibilidad y la precisión</span></span>
<span id="cb168-4019"><a href="#cb168-4019" aria-hidden="true" tabindex="-1"></a><span class="in">      umbral &lt;- 0.5</span></span>
<span id="cb168-4020"><a href="#cb168-4020" aria-hidden="true" tabindex="-1"></a><span class="in">      predicciones_finales &lt;- ifelse(predicciones_validacion_prob &gt;= umbral, "SI", "NO")</span></span>
<span id="cb168-4021"><a href="#cb168-4021" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- sum(predicciones_finales == "SI" &amp; datos_validacion$ESTADO_ACTUAL == "SI")</span></span>
<span id="cb168-4022"><a href="#cb168-4022" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- sum(predicciones_finales == "NO" &amp; datos_validacion$ESTADO_ACTUAL == "SI")</span></span>
<span id="cb168-4023"><a href="#cb168-4023" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- sum(predicciones_finales == "SI" &amp; datos_validacion$ESTADO_ACTUAL == "NO")</span></span>
<span id="cb168-4024"><a href="#cb168-4024" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- sum(predicciones_finales == "NO" &amp; datos_validacion$ESTADO_ACTUAL == "NO")</span></span>
<span id="cb168-4025"><a href="#cb168-4025" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb168-4026"><a href="#cb168-4026" aria-hidden="true" tabindex="-1"></a><span class="in">      recall_actual &lt;- TP / (TP + FN)</span></span>
<span id="cb168-4027"><a href="#cb168-4027" aria-hidden="true" tabindex="-1"></a><span class="in">      accuracy_actual &lt;- (TP + TN) / (TP + FN + FP + TN)</span></span>
<span id="cb168-4028"><a href="#cb168-4028" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb168-4029"><a href="#cb168-4029" aria-hidden="true" tabindex="-1"></a><span class="in">      # Almacenar resultados internos</span></span>
<span id="cb168-4030"><a href="#cb168-4030" aria-hidden="true" tabindex="-1"></a><span class="in">      resultados_sensibilidad_inner[i_inner] &lt;- recall_actual</span></span>
<span id="cb168-4031"><a href="#cb168-4031" aria-hidden="true" tabindex="-1"></a><span class="in">      resultados_accuracy_inner[i_inner] &lt;- accuracy_actual</span></span>
<span id="cb168-4032"><a href="#cb168-4032" aria-hidden="true" tabindex="-1"></a><span class="in">      resultados_auc_inner[i_inner] &lt;- auc_actual</span></span>
<span id="cb168-4033"><a href="#cb168-4033" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb168-4034"><a href="#cb168-4034" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb168-4035"><a href="#cb168-4035" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-4036"><a href="#cb168-4036" aria-hidden="true" tabindex="-1"></a><span class="in">  # Calcular el AUC final para este pliegue externo</span></span>
<span id="cb168-4037"><a href="#cb168-4037" aria-hidden="true" tabindex="-1"></a><span class="in">  auc_fold_externo &lt;- mean(resultados_auc_inner)</span></span>
<span id="cb168-4038"><a href="#cb168-4038" aria-hidden="true" tabindex="-1"></a><span class="in">  accuracy_fold_externo &lt;- mean(resultados_accuracy_inner)</span></span>
<span id="cb168-4039"><a href="#cb168-4039" aria-hidden="true" tabindex="-1"></a><span class="in">  sensibilidad_fold_externo &lt;- mean(resultados_sensibilidad_inner)</span></span>
<span id="cb168-4040"><a href="#cb168-4040" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-4041"><a href="#cb168-4041" aria-hidden="true" tabindex="-1"></a><span class="in">  # Almacenar el AUC del fold externo actual</span></span>
<span id="cb168-4042"><a href="#cb168-4042" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_auc[i_outer] &lt;- auc_fold_externo</span></span>
<span id="cb168-4043"><a href="#cb168-4043" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_accuracy[i_outer] &lt;- accuracy_fold_externo</span></span>
<span id="cb168-4044"><a href="#cb168-4044" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_sensibilidad[i_outer] &lt;- sensibilidad_fold_externo</span></span>
<span id="cb168-4045"><a href="#cb168-4045" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-4046"><a href="#cb168-4046" aria-hidden="true" tabindex="-1"></a><span class="in">  # Predecir en los datos de test para este pliegue externo y almacenar predicciones</span></span>
<span id="cb168-4047"><a href="#cb168-4047" aria-hidden="true" tabindex="-1"></a><span class="in">  # (Aquí deberías hacer la predicción usando el mejor modelo encontrado en el bucle interno)</span></span>
<span id="cb168-4048"><a href="#cb168-4048" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb168-4049"><a href="#cb168-4049" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4050"><a href="#cb168-4050" aria-hidden="true" tabindex="-1"></a><span class="in"># Calcular AUC promedio</span></span>
<span id="cb168-4051"><a href="#cb168-4051" aria-hidden="true" tabindex="-1"></a><span class="in">auc_promedio &lt;- mean(resultados_auc)</span></span>
<span id="cb168-4052"><a href="#cb168-4052" aria-hidden="true" tabindex="-1"></a><span class="in">accuracy_promedio &lt;- mean(resultados_accuracy)</span></span>
<span id="cb168-4053"><a href="#cb168-4053" aria-hidden="true" tabindex="-1"></a><span class="in">sensibilidad_promedio &lt;- mean(resultados_sensibilidad)</span></span>
<span id="cb168-4054"><a href="#cb168-4054" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4055"><a href="#cb168-4055" aria-hidden="true" tabindex="-1"></a><span class="in">tabla_metricas &lt;- data.frame(</span></span>
<span id="cb168-4056"><a href="#cb168-4056" aria-hidden="true" tabindex="-1"></a><span class="in">  Pliegue = 1:k_outer,</span></span>
<span id="cb168-4057"><a href="#cb168-4057" aria-hidden="true" tabindex="-1"></a><span class="in">  AUC = sapply(resultados_auc, round, digits = 3),</span></span>
<span id="cb168-4058"><a href="#cb168-4058" aria-hidden="true" tabindex="-1"></a><span class="in">  Accuracy = sapply(resultados_accuracy, round, digits = 3),</span></span>
<span id="cb168-4059"><a href="#cb168-4059" aria-hidden="true" tabindex="-1"></a><span class="in">  Recall = sapply(resultados_sensibilidad, round, digits = 3)</span></span>
<span id="cb168-4060"><a href="#cb168-4060" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb168-4061"><a href="#cb168-4061" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4062"><a href="#cb168-4062" aria-hidden="true" tabindex="-1"></a><span class="in"># Agregar fila con promedio de métricas</span></span>
<span id="cb168-4063"><a href="#cb168-4063" aria-hidden="true" tabindex="-1"></a><span class="in">tabla_metricas_naive_wrapper &lt;- rbind(tabla_metricas, c("Mean", round(auc_promedio, 3), round(accuracy_promedio, 3), round(sensibilidad_promedio, 3)))</span></span>
<span id="cb168-4064"><a href="#cb168-4064" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4065"><a href="#cb168-4065" aria-hidden="true" tabindex="-1"></a><span class="in"># Detener el tiempo de ejecución</span></span>
<span id="cb168-4066"><a href="#cb168-4066" aria-hidden="true" tabindex="-1"></a><span class="in">end_time &lt;- Sys.time()</span></span>
<span id="cb168-4067"><a href="#cb168-4067" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time_naive &lt;- end_time - start_time</span></span>
<span id="cb168-4068"><a href="#cb168-4068" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time_naive_wrapper &lt;- as.numeric(execution_time_naive, units = "secs")</span></span>
<span id="cb168-4069"><a href="#cb168-4069" aria-hidden="true" tabindex="-1"></a><span class="in">save(tabla_metricas_naive_wrapper, file = "tabla_metricas_naive_wrapper.RData")</span></span>
<span id="cb168-4070"><a href="#cb168-4070" aria-hidden="true" tabindex="-1"></a><span class="in">save(execution_time_naive_wrapper, file = "execution_time_naive_wrapper.RData")</span></span>
<span id="cb168-4071"><a href="#cb168-4071" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4072"><a href="#cb168-4072" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-4073"><a href="#cb168-4073" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4076"><a href="#cb168-4076" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-4077"><a href="#cb168-4077" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"tabla_metricas_naive_wrapper.RData"</span>)</span>
<span id="cb168-4078"><a href="#cb168-4078" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"execution_time_naive_wrapper.RData"</span>)</span>
<span id="cb168-4079"><a href="#cb168-4079" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir el tiempo de ejecución</span></span>
<span id="cb168-4080"><a href="#cb168-4080" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time_naive_wrapper,  <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb168-4081"><a href="#cb168-4081" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4082"><a href="#cb168-4082" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4083"><a href="#cb168-4083" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4084"><a href="#cb168-4084" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-4085"><a href="#cb168-4085" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4086"><a href="#cb168-4086" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb168-4087"><a href="#cb168-4087" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4088"><a href="#cb168-4088" aria-hidden="true" tabindex="-1"></a><span class="fu"># Metrics Table</span></span>
<span id="cb168-4091"><a href="#cb168-4091" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-4092"><a href="#cb168-4092" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir tabla formateada con kableExtra</span></span>
<span id="cb168-4093"><a href="#cb168-4093" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(tabla_metricas_naive_wrapper, <span class="at">caption =</span> <span class="st">"Cross Validation Metrics"</span>, <span class="at">align =</span> <span class="st">"c"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb168-4094"><a href="#cb168-4094" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb168-4095"><a href="#cb168-4095" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-4096"><a href="#cb168-4096" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4097"><a href="#cb168-4097" aria-hidden="true" tabindex="-1"></a><span class="fu"># Metrics Plot</span></span>
<span id="cb168-4100"><a href="#cb168-4100" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-4101"><a href="#cb168-4101" aria-hidden="true" tabindex="-1"></a><span class="fu">crear_plot_metricas_per_fold</span>(tabla_metricas_naive_wrapper)</span>
<span id="cb168-4102"><a href="#cb168-4102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4103"><a href="#cb168-4103" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-4104"><a href="#cb168-4104" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb168-4105"><a href="#cb168-4105" aria-hidden="true" tabindex="-1"></a>The naive bayes model with wrapper variable selection is the best model so far. The performance metrics are good and the model is robust.</span>
<span id="cb168-4106"><a href="#cb168-4106" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb168-4107"><a href="#cb168-4107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4108"><a href="#cb168-4108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4109"><a href="#cb168-4109" aria-hidden="true" tabindex="-1"></a><span class="fu"># K-Nearest Neighbors {#k-nearest-neighbors}</span></span>
<span id="cb168-4110"><a href="#cb168-4110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4111"><a href="#cb168-4111" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset style="background-color: #f0f0f0;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;"}</span>
<span id="cb168-4112"><a href="#cb168-4112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4113"><a href="#cb168-4113" aria-hidden="true" tabindex="-1"></a><span class="fu">## Hold out</span></span>
<span id="cb168-4114"><a href="#cb168-4114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4115"><a href="#cb168-4115" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=FALSE,message=FALSE}</span></span>
<span id="cb168-4116"><a href="#cb168-4116" aria-hidden="true" tabindex="-1"></a><span class="in">start_time &lt;- Sys.time()</span></span>
<span id="cb168-4117"><a href="#cb168-4117" aria-hidden="true" tabindex="-1"></a><span class="in"># Parámetros a cambiar</span></span>
<span id="cb168-4118"><a href="#cb168-4118" aria-hidden="true" tabindex="-1"></a><span class="in">proportion &lt;- 0.28</span></span>
<span id="cb168-4119"><a href="#cb168-4119" aria-hidden="true" tabindex="-1"></a><span class="in">sensitivity_weight &lt;- 0.8</span></span>
<span id="cb168-4120"><a href="#cb168-4120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4121"><a href="#cb168-4121" aria-hidden="true" tabindex="-1"></a><span class="in"># Dividir el conjunto de datos en entrenamiento y test</span></span>
<span id="cb168-4122"><a href="#cb168-4122" aria-hidden="true" tabindex="-1"></a><span class="in">indices_entrenamiento &lt;- sample(nrow(data), 0.75 * nrow(data))  # 75% para entrenamiento</span></span>
<span id="cb168-4123"><a href="#cb168-4123" aria-hidden="true" tabindex="-1"></a><span class="in">datos_entrenamiento &lt;- data[indices_entrenamiento, ]</span></span>
<span id="cb168-4124"><a href="#cb168-4124" aria-hidden="true" tabindex="-1"></a><span class="in">datos_test &lt;- data[-indices_entrenamiento, ]</span></span>
<span id="cb168-4125"><a href="#cb168-4125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4126"><a href="#cb168-4126" aria-hidden="true" tabindex="-1"></a><span class="in"># Dividir datos de entrenamiento en entrenamiento y validación</span></span>
<span id="cb168-4127"><a href="#cb168-4127" aria-hidden="true" tabindex="-1"></a><span class="in">train_indices &lt;- sample(nrow(datos_entrenamiento), 0.8 * nrow(datos_entrenamiento))  # 80% para entrenamiento</span></span>
<span id="cb168-4128"><a href="#cb168-4128" aria-hidden="true" tabindex="-1"></a><span class="in">datos_entrenamiento_split &lt;- datos_entrenamiento[train_indices, ]</span></span>
<span id="cb168-4129"><a href="#cb168-4129" aria-hidden="true" tabindex="-1"></a><span class="in">datos_validacion &lt;- datos_entrenamiento[-train_indices, ]</span></span>
<span id="cb168-4130"><a href="#cb168-4130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4131"><a href="#cb168-4131" aria-hidden="true" tabindex="-1"></a><span class="in"># Realizar sobremuestreo en los datos de entrenamiento</span></span>
<span id="cb168-4132"><a href="#cb168-4132" aria-hidden="true" tabindex="-1"></a><span class="in">datos_entrenamiento_oversampled &lt;- ROSE(ESTADO_ACTUAL ~ ., data = datos_entrenamiento_split, p = proportion)$data</span></span>
<span id="cb168-4133"><a href="#cb168-4133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4134"><a href="#cb168-4134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4135"><a href="#cb168-4135" aria-hidden="true" tabindex="-1"></a><span class="in"># Inicializar variables para almacenar los resultados</span></span>
<span id="cb168-4136"><a href="#cb168-4136" aria-hidden="true" tabindex="-1"></a><span class="in">mejor_auc &lt;- 0</span></span>
<span id="cb168-4137"><a href="#cb168-4137" aria-hidden="true" tabindex="-1"></a><span class="in">mejor_k &lt;- NULL</span></span>
<span id="cb168-4138"><a href="#cb168-4138" aria-hidden="true" tabindex="-1"></a><span class="in">mejor_l &lt;- NULL</span></span>
<span id="cb168-4139"><a href="#cb168-4139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4140"><a href="#cb168-4140" aria-hidden="true" tabindex="-1"></a><span class="in"># Codificación One-Hot Encoding para variables categóricas</span></span>
<span id="cb168-4141"><a href="#cb168-4141" aria-hidden="true" tabindex="-1"></a><span class="in">encoded_data_entrenamiento &lt;- as.data.frame(model.matrix(~.-1, datos_entrenamiento_oversampled[, -which(names(datos_entrenamiento_oversampled) == "ESTADO_ACTUAL")]))</span></span>
<span id="cb168-4142"><a href="#cb168-4142" aria-hidden="true" tabindex="-1"></a><span class="in">encoded_data_test &lt;- as.data.frame(model.matrix(~.-1, datos_test[, -which(names(datos_test) == "ESTADO_ACTUAL")]))</span></span>
<span id="cb168-4143"><a href="#cb168-4143" aria-hidden="true" tabindex="-1"></a><span class="in">#Este código realiza la codificación One-Hot Encoding para las variables categóricas en los conjuntos de datos datos_entrenamiento_oversampled y datos_test. Primero, identifica la columna que contiene la variable objetivo "ESTADO_ACTUAL" y la excluye del proceso. Luego, utiliza la función model.matrix para crear una matriz de diseño que representa las variables categóricas codificadas en forma binaria. Finalmente, convierte esta matriz en un data frame.</span></span>
<span id="cb168-4144"><a href="#cb168-4144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4145"><a href="#cb168-4145" aria-hidden="true" tabindex="-1"></a><span class="in">param_grid &lt;- expand.grid(k = seq(1, 20, by = 1),</span></span>
<span id="cb168-4146"><a href="#cb168-4146" aria-hidden="true" tabindex="-1"></a><span class="in">                           l = seq(1, 10, by = 1))</span></span>
<span id="cb168-4147"><a href="#cb168-4147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4148"><a href="#cb168-4148" aria-hidden="true" tabindex="-1"></a><span class="in"># Bucle para probar diferentes combinaciones de hiperparámetros</span></span>
<span id="cb168-4149"><a href="#cb168-4149" aria-hidden="true" tabindex="-1"></a><span class="in">for (i in 1:nrow(param_grid)) {</span></span>
<span id="cb168-4150"><a href="#cb168-4150" aria-hidden="true" tabindex="-1"></a><span class="in">  k &lt;- param_grid$k[i]</span></span>
<span id="cb168-4151"><a href="#cb168-4151" aria-hidden="true" tabindex="-1"></a><span class="in">  l &lt;- param_grid$l[i]</span></span>
<span id="cb168-4152"><a href="#cb168-4152" aria-hidden="true" tabindex="-1"></a><span class="in">  # Realizar predicciones en datos de validación</span></span>
<span id="cb168-4153"><a href="#cb168-4153" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_validacion &lt;- knn(train = encoded_data_entrenamiento, </span></span>
<span id="cb168-4154"><a href="#cb168-4154" aria-hidden="true" tabindex="-1"></a><span class="in">                                  test = encoded_data_test, </span></span>
<span id="cb168-4155"><a href="#cb168-4155" aria-hidden="true" tabindex="-1"></a><span class="in">                                  cl = datos_entrenamiento_oversampled$ESTADO_ACTUAL, </span></span>
<span id="cb168-4156"><a href="#cb168-4156" aria-hidden="true" tabindex="-1"></a><span class="in">                                  k = k, </span></span>
<span id="cb168-4157"><a href="#cb168-4157" aria-hidden="true" tabindex="-1"></a><span class="in">                                  use.all = TRUE,</span></span>
<span id="cb168-4158"><a href="#cb168-4158" aria-hidden="true" tabindex="-1"></a><span class="in">                                  prob = TRUE,</span></span>
<span id="cb168-4159"><a href="#cb168-4159" aria-hidden="true" tabindex="-1"></a><span class="in">                                  l = l)</span></span>
<span id="cb168-4160"><a href="#cb168-4160" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-4161"><a href="#cb168-4161" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_validacion &lt;- attr(predicciones_validacion, "prob")  # Asumiendo que "SI" es la clase positiva</span></span>
<span id="cb168-4162"><a href="#cb168-4162" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-4163"><a href="#cb168-4163" aria-hidden="true" tabindex="-1"></a><span class="in">  # Calcular AUC para la combinación actual</span></span>
<span id="cb168-4164"><a href="#cb168-4164" aria-hidden="true" tabindex="-1"></a><span class="in">  roc_obj &lt;- roc(ifelse(datos_test$ESTADO_ACTUAL == "SI", 1, 0), predicciones_validacion)</span></span>
<span id="cb168-4165"><a href="#cb168-4165" aria-hidden="true" tabindex="-1"></a><span class="in">  auc_actual &lt;- as.numeric(auc(roc_obj))  # Extraer el valor numérico del AUC</span></span>
<span id="cb168-4166"><a href="#cb168-4166" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-4167"><a href="#cb168-4167" aria-hidden="true" tabindex="-1"></a><span class="in">  # Actualizar el mejor modelo y su rendimiento si se encuentra un modelo mejor</span></span>
<span id="cb168-4168"><a href="#cb168-4168" aria-hidden="true" tabindex="-1"></a><span class="in">  if (auc_actual &gt; mejor_auc) {</span></span>
<span id="cb168-4169"><a href="#cb168-4169" aria-hidden="true" tabindex="-1"></a><span class="in">    mejor_auc &lt;- auc_actual</span></span>
<span id="cb168-4170"><a href="#cb168-4170" aria-hidden="true" tabindex="-1"></a><span class="in">    mejor_k &lt;- k</span></span>
<span id="cb168-4171"><a href="#cb168-4171" aria-hidden="true" tabindex="-1"></a><span class="in">    mejor_l &lt;- l</span></span>
<span id="cb168-4172"><a href="#cb168-4172" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb168-4173"><a href="#cb168-4173" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb168-4174"><a href="#cb168-4174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4175"><a href="#cb168-4175" aria-hidden="true" tabindex="-1"></a><span class="in">end_time &lt;- Sys.time()</span></span>
<span id="cb168-4176"><a href="#cb168-4176" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time &lt;- end_time - start_time</span></span>
<span id="cb168-4177"><a href="#cb168-4177" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time &lt;- as.numeric(execution_time, units = "secs")</span></span>
<span id="cb168-4178"><a href="#cb168-4178" aria-hidden="true" tabindex="-1"></a><span class="in">cat("Execution time:", execution_time,  "seconds \n")</span></span>
<span id="cb168-4179"><a href="#cb168-4179" aria-hidden="true" tabindex="-1"></a><span class="in">cat("Best k:", mejor_k, "\n")</span></span>
<span id="cb168-4180"><a href="#cb168-4180" aria-hidden="true" tabindex="-1"></a><span class="in">cat("Best l:", mejor_l, "\n")</span></span>
<span id="cb168-4181"><a href="#cb168-4181" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-4182"><a href="#cb168-4182" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb168-4183"><a href="#cb168-4183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4184"><a href="#cb168-4184" aria-hidden="true" tabindex="-1"></a><span class="fu">### Predictions</span></span>
<span id="cb168-4185"><a href="#cb168-4185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4186"><a href="#cb168-4186" aria-hidden="true" tabindex="-1"></a>We are going to predict on test in order to get a estimation of the performance of the model.</span>
<span id="cb168-4187"><a href="#cb168-4187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4190"><a href="#cb168-4190" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-4191"><a href="#cb168-4191" aria-hidden="true" tabindex="-1"></a><span class="co"># Ejecutar la parte del código que involucra la función knn</span></span>
<span id="cb168-4192"><a href="#cb168-4192" aria-hidden="true" tabindex="-1"></a>predicciones_test <span class="ot">&lt;-</span> <span class="fu">knn</span>(<span class="at">train =</span> encoded_data_entrenamiento, </span>
<span id="cb168-4193"><a href="#cb168-4193" aria-hidden="true" tabindex="-1"></a>                         <span class="at">test =</span> encoded_data_test, </span>
<span id="cb168-4194"><a href="#cb168-4194" aria-hidden="true" tabindex="-1"></a>                         <span class="at">cl =</span> datos_entrenamiento_oversampled<span class="sc">$</span>ESTADO_ACTUAL, </span>
<span id="cb168-4195"><a href="#cb168-4195" aria-hidden="true" tabindex="-1"></a>                         <span class="at">k =</span> mejor_k, </span>
<span id="cb168-4196"><a href="#cb168-4196" aria-hidden="true" tabindex="-1"></a>                         <span class="at">use.all =</span> <span class="cn">TRUE</span>,</span>
<span id="cb168-4197"><a href="#cb168-4197" aria-hidden="true" tabindex="-1"></a>                         <span class="at">prob =</span> <span class="cn">TRUE</span>)</span>
<span id="cb168-4198"><a href="#cb168-4198" aria-hidden="true" tabindex="-1"></a>predicciones_test <span class="ot">&lt;-</span> <span class="fu">attr</span>(predicciones_test, <span class="st">"prob"</span>)  <span class="co"># Asumiendo que "SI" es la clase positiva</span></span>
<span id="cb168-4199"><a href="#cb168-4199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4200"><a href="#cb168-4200" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular las predicciones para el conjunto de test</span></span>
<span id="cb168-4201"><a href="#cb168-4201" aria-hidden="true" tabindex="-1"></a>clases_predichas_test <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predicciones_test <span class="sc">&gt;=</span> <span class="fl">0.5</span>, <span class="st">"SI"</span>, <span class="st">"NO"</span>)</span>
<span id="cb168-4202"><a href="#cb168-4202" aria-hidden="true" tabindex="-1"></a><span class="fu">mostrar_metricas</span>(datos_test<span class="sc">$</span>ESTADO_ACTUAL,clases_predichas_test)</span>
<span id="cb168-4203"><a href="#cb168-4203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4204"><a href="#cb168-4204" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-4205"><a href="#cb168-4205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4206"><a href="#cb168-4206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4207"><a href="#cb168-4207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4208"><a href="#cb168-4208" aria-hidden="true" tabindex="-1"></a><span class="fu">### Roc curve and auc</span></span>
<span id="cb168-4209"><a href="#cb168-4209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4212"><a href="#cb168-4212" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-4213"><a href="#cb168-4213" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular la curva ROC y el AUC para el conjunto de test</span></span>
<span id="cb168-4214"><a href="#cb168-4214" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_roc_curve</span>(predicciones_test,datos_test<span class="sc">$</span>ESTADO_ACTUAL)</span>
<span id="cb168-4215"><a href="#cb168-4215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4216"><a href="#cb168-4216" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-4217"><a href="#cb168-4217" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb168-4218"><a href="#cb168-4218" aria-hidden="true" tabindex="-1"></a>The algorithm performance is really bad for this problem.</span>
<span id="cb168-4219"><a href="#cb168-4219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4220"><a href="#cb168-4220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4221"><a href="#cb168-4221" aria-hidden="true" tabindex="-1"></a><span class="fu">## 5x2 Cross Validation Filter</span></span>
<span id="cb168-4222"><a href="#cb168-4222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4223"><a href="#cb168-4223" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=FALSE,message=FALSE, eval=FALSE}</span></span>
<span id="cb168-4224"><a href="#cb168-4224" aria-hidden="true" tabindex="-1"></a><span class="in">start_time &lt;- Sys.time()</span></span>
<span id="cb168-4225"><a href="#cb168-4225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4226"><a href="#cb168-4226" aria-hidden="true" tabindex="-1"></a><span class="in"># Configurar la validación cruzada 5x2</span></span>
<span id="cb168-4227"><a href="#cb168-4227" aria-hidden="true" tabindex="-1"></a><span class="in">k_outer &lt;- 5  # Número de pliegues externos</span></span>
<span id="cb168-4228"><a href="#cb168-4228" aria-hidden="true" tabindex="-1"></a><span class="in">k_inner &lt;- 2  # Número de pliegues internos</span></span>
<span id="cb168-4229"><a href="#cb168-4229" aria-hidden="true" tabindex="-1"></a><span class="in">folds_outer &lt;- createFolds(data$ESTADO_ACTUAL, k = k_outer, list = FALSE)  # Obtener índices de pliegues externos</span></span>
<span id="cb168-4230"><a href="#cb168-4230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4231"><a href="#cb168-4231" aria-hidden="true" tabindex="-1"></a><span class="in"># Lista para almacenar resultados</span></span>
<span id="cb168-4232"><a href="#cb168-4232" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_auc &lt;- numeric(k_outer)</span></span>
<span id="cb168-4233"><a href="#cb168-4233" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_sensibilidad &lt;- numeric(k_outer)</span></span>
<span id="cb168-4234"><a href="#cb168-4234" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_accuracy &lt;- numeric(k_outer)</span></span>
<span id="cb168-4235"><a href="#cb168-4235" aria-hidden="true" tabindex="-1"></a><span class="in">indices &lt;- 1:nrow(data)</span></span>
<span id="cb168-4236"><a href="#cb168-4236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4237"><a href="#cb168-4237" aria-hidden="true" tabindex="-1"></a><span class="in"># Inicializar matrices para almacenar predicciones y objetivos</span></span>
<span id="cb168-4238"><a href="#cb168-4238" aria-hidden="true" tabindex="-1"></a><span class="in">predicciones_totales &lt;- matrix(NA, nrow = nrow(data), ncol = k_outer)</span></span>
<span id="cb168-4239"><a href="#cb168-4239" aria-hidden="true" tabindex="-1"></a><span class="in">targets_totales &lt;- numeric(nrow(data))</span></span>
<span id="cb168-4240"><a href="#cb168-4240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4241"><a href="#cb168-4241" aria-hidden="true" tabindex="-1"></a><span class="in"># Iterar sobre cada pliegue externo y realizar el proceso de modelado</span></span>
<span id="cb168-4242"><a href="#cb168-4242" aria-hidden="true" tabindex="-1"></a><span class="in">for (i_outer in 1:k_outer) {</span></span>
<span id="cb168-4243"><a href="#cb168-4243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4244"><a href="#cb168-4244" aria-hidden="true" tabindex="-1"></a><span class="in">  # Obtener los índices para el pliegue externo actual</span></span>
<span id="cb168-4245"><a href="#cb168-4245" aria-hidden="true" tabindex="-1"></a><span class="in">  test_indices_outer &lt;- indices[folds_outer == i_outer]  # Índices correspondientes al pliegue externo de test</span></span>
<span id="cb168-4246"><a href="#cb168-4246" aria-hidden="true" tabindex="-1"></a><span class="in">  train_indices_outer &lt;- setdiff(1:nrow(data), test_indices_outer)  # Índices correspondientes al conjunto de entrenamiento</span></span>
<span id="cb168-4247"><a href="#cb168-4247" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-4248"><a href="#cb168-4248" aria-hidden="true" tabindex="-1"></a><span class="in">  # Dividir datos en entrenamiento y test para el pliegue externo</span></span>
<span id="cb168-4249"><a href="#cb168-4249" aria-hidden="true" tabindex="-1"></a><span class="in">  datos_entrenamiento_outer &lt;- data[train_indices_outer, ]</span></span>
<span id="cb168-4250"><a href="#cb168-4250" aria-hidden="true" tabindex="-1"></a><span class="in">  datos_test_outer &lt;- data[test_indices_outer, ]</span></span>
<span id="cb168-4251"><a href="#cb168-4251" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-4252"><a href="#cb168-4252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4253"><a href="#cb168-4253" aria-hidden="true" tabindex="-1"></a><span class="in">  # Configurar la validación cruzada interna</span></span>
<span id="cb168-4254"><a href="#cb168-4254" aria-hidden="true" tabindex="-1"></a><span class="in">  folds_inner &lt;- createFolds(datos_entrenamiento_outer$ESTADO_ACTUAL, k = k_inner, list = FALSE)  # Obtener índices de pliegues internos</span></span>
<span id="cb168-4255"><a href="#cb168-4255" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-4256"><a href="#cb168-4256" aria-hidden="true" tabindex="-1"></a><span class="in">  # Almacenar predicciones y test para formar una curva ROC general</span></span>
<span id="cb168-4257"><a href="#cb168-4257" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_auc &lt;- numeric(nrow(datos_entrenamiento_outer))</span></span>
<span id="cb168-4258"><a href="#cb168-4258" aria-hidden="true" tabindex="-1"></a><span class="in">  targets_auc &lt;- numeric(nrow(datos_entrenamiento_outer))</span></span>
<span id="cb168-4259"><a href="#cb168-4259" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-4260"><a href="#cb168-4260" aria-hidden="true" tabindex="-1"></a><span class="in">  # Iterar sobre cada pliegue interno para selección de modelo</span></span>
<span id="cb168-4261"><a href="#cb168-4261" aria-hidden="true" tabindex="-1"></a><span class="in">  indices_inner &lt;- 1:nrow(datos_entrenamiento_outer)</span></span>
<span id="cb168-4262"><a href="#cb168-4262" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_auc_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-4263"><a href="#cb168-4263" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_sensibilidad_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-4264"><a href="#cb168-4264" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_accuracy_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-4265"><a href="#cb168-4265" aria-hidden="true" tabindex="-1"></a><span class="in">  for (i_inner in 1:k_inner) {</span></span>
<span id="cb168-4266"><a href="#cb168-4266" aria-hidden="true" tabindex="-1"></a><span class="in">    ###############################</span></span>
<span id="cb168-4267"><a href="#cb168-4267" aria-hidden="true" tabindex="-1"></a><span class="in">    #### Aquí el filtrado #########</span></span>
<span id="cb168-4268"><a href="#cb168-4268" aria-hidden="true" tabindex="-1"></a><span class="in">    ###############################</span></span>
<span id="cb168-4269"><a href="#cb168-4269" aria-hidden="true" tabindex="-1"></a><span class="in">    filter_data &lt;- filter_dependency(datos_entrenamiento_outer, "ESTADO_ACTUAL", colnames(datos_entrenamiento_outer), 0.05)</span></span>
<span id="cb168-4270"><a href="#cb168-4270" aria-hidden="true" tabindex="-1"></a><span class="in">    if ("ESTADO_ACTUAL.1" %in% colnames(filter_data)) {</span></span>
<span id="cb168-4271"><a href="#cb168-4271" aria-hidden="true" tabindex="-1"></a><span class="in">      filter_data &lt;- filter_data[, !colnames(filter_data) %in% "ESTADO_ACTUAL.1", drop = FALSE]</span></span>
<span id="cb168-4272"><a href="#cb168-4272" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb168-4273"><a href="#cb168-4273" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-4274"><a href="#cb168-4274" aria-hidden="true" tabindex="-1"></a><span class="in">    # Obtener los índices para el pliegue interno actual</span></span>
<span id="cb168-4275"><a href="#cb168-4275" aria-hidden="true" tabindex="-1"></a><span class="in">    test_indices_inner &lt;- indices_inner[folds_inner == i_inner]  # Índices correspondientes al pliegue interno de test</span></span>
<span id="cb168-4276"><a href="#cb168-4276" aria-hidden="true" tabindex="-1"></a><span class="in">    train_indices_inner &lt;- setdiff(1:nrow(datos_entrenamiento_outer), test_indices_inner)  # Índices correspondientes al conjunto de entrenamiento interno</span></span>
<span id="cb168-4277"><a href="#cb168-4277" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-4278"><a href="#cb168-4278" aria-hidden="true" tabindex="-1"></a><span class="in">    # Dividir datos en entrenamiento y test para el pliegue interno</span></span>
<span id="cb168-4279"><a href="#cb168-4279" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_entrenamiento_inner &lt;- datos_entrenamiento_outer[train_indices_inner, ]</span></span>
<span id="cb168-4280"><a href="#cb168-4280" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_validacion &lt;- datos_entrenamiento_outer[test_indices_inner, ]</span></span>
<span id="cb168-4281"><a href="#cb168-4281" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-4282"><a href="#cb168-4282" aria-hidden="true" tabindex="-1"></a><span class="in">    # Aplicar oversampling en el conjunto de entrenamiento interno</span></span>
<span id="cb168-4283"><a href="#cb168-4283" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_entrenamiento_oversampled &lt;- ROSE(ESTADO_ACTUAL ~ .,</span></span>
<span id="cb168-4284"><a href="#cb168-4284" aria-hidden="true" tabindex="-1"></a><span class="in">                                            data = datos_entrenamiento_inner,</span></span>
<span id="cb168-4285"><a href="#cb168-4285" aria-hidden="true" tabindex="-1"></a><span class="in">                                            p = 0.28)$data</span></span>
<span id="cb168-4286"><a href="#cb168-4286" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-4287"><a href="#cb168-4287" aria-hidden="true" tabindex="-1"></a><span class="in">    # Inicializar variables para almacenar los resultados</span></span>
<span id="cb168-4288"><a href="#cb168-4288" aria-hidden="true" tabindex="-1"></a><span class="in">    mejor_auc &lt;- 0</span></span>
<span id="cb168-4289"><a href="#cb168-4289" aria-hidden="true" tabindex="-1"></a><span class="in">    mejor_k &lt;- NULL</span></span>
<span id="cb168-4290"><a href="#cb168-4290" aria-hidden="true" tabindex="-1"></a><span class="in">    mejor_l &lt;- NULL</span></span>
<span id="cb168-4291"><a href="#cb168-4291" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-4292"><a href="#cb168-4292" aria-hidden="true" tabindex="-1"></a><span class="in">    # Codificación One-Hot Encoding para variables categóricas</span></span>
<span id="cb168-4293"><a href="#cb168-4293" aria-hidden="true" tabindex="-1"></a><span class="in">    encoded_data_entrenamiento &lt;- as.data.frame(model.matrix(~.-1, datos_entrenamiento_oversampled[, -which(names(datos_entrenamiento_oversampled) == "ESTADO_ACTUAL")]))</span></span>
<span id="cb168-4294"><a href="#cb168-4294" aria-hidden="true" tabindex="-1"></a><span class="in">    encoded_data_validacion &lt;- as.data.frame(model.matrix(~.-1, datos_validacion[, -which(names(datos_validacion) == "ESTADO_ACTUAL")]))</span></span>
<span id="cb168-4295"><a href="#cb168-4295" aria-hidden="true" tabindex="-1"></a><span class="in">   </span></span>
<span id="cb168-4296"><a href="#cb168-4296" aria-hidden="true" tabindex="-1"></a><span class="in">    param_grid &lt;- expand.grid(k = seq(1, 20, by = 1),</span></span>
<span id="cb168-4297"><a href="#cb168-4297" aria-hidden="true" tabindex="-1"></a><span class="in">                               l = seq(1, 10, by = 1))</span></span>
<span id="cb168-4298"><a href="#cb168-4298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4299"><a href="#cb168-4299" aria-hidden="true" tabindex="-1"></a><span class="in">    # Iterar sobre las combinaciones de hiperparámetros</span></span>
<span id="cb168-4300"><a href="#cb168-4300" aria-hidden="true" tabindex="-1"></a><span class="in">    for (i in 1:nrow(param_grid)) {</span></span>
<span id="cb168-4301"><a href="#cb168-4301" aria-hidden="true" tabindex="-1"></a><span class="in">      k &lt;- param_grid$k[i]</span></span>
<span id="cb168-4302"><a href="#cb168-4302" aria-hidden="true" tabindex="-1"></a><span class="in">      l &lt;- param_grid$l[i]</span></span>
<span id="cb168-4303"><a href="#cb168-4303" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb168-4304"><a href="#cb168-4304" aria-hidden="true" tabindex="-1"></a><span class="in">      # Realizar predicciones en datos de validación</span></span>
<span id="cb168-4305"><a href="#cb168-4305" aria-hidden="true" tabindex="-1"></a><span class="in">      predicciones_validacion &lt;- knn(train = encoded_data_entrenamiento, </span></span>
<span id="cb168-4306"><a href="#cb168-4306" aria-hidden="true" tabindex="-1"></a><span class="in">                                     test = encoded_data_validacion, </span></span>
<span id="cb168-4307"><a href="#cb168-4307" aria-hidden="true" tabindex="-1"></a><span class="in">                                     cl = datos_entrenamiento_oversampled$ESTADO_ACTUAL, </span></span>
<span id="cb168-4308"><a href="#cb168-4308" aria-hidden="true" tabindex="-1"></a><span class="in">                                     k = k, </span></span>
<span id="cb168-4309"><a href="#cb168-4309" aria-hidden="true" tabindex="-1"></a><span class="in">                                     use.all = TRUE,</span></span>
<span id="cb168-4310"><a href="#cb168-4310" aria-hidden="true" tabindex="-1"></a><span class="in">                                     prob = TRUE,</span></span>
<span id="cb168-4311"><a href="#cb168-4311" aria-hidden="true" tabindex="-1"></a><span class="in">                                     l = l)</span></span>
<span id="cb168-4312"><a href="#cb168-4312" aria-hidden="true" tabindex="-1"></a><span class="in">      predicciones_validacion &lt;- attr(predicciones_validacion, "prob")  # Asumiendo que "SI" es la clase positiva</span></span>
<span id="cb168-4313"><a href="#cb168-4313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4314"><a href="#cb168-4314" aria-hidden="true" tabindex="-1"></a><span class="in">      # Calcular AUC para la combinación actual</span></span>
<span id="cb168-4315"><a href="#cb168-4315" aria-hidden="true" tabindex="-1"></a><span class="in">      roc_obj &lt;- roc(ifelse(datos_validacion$ESTADO_ACTUAL == "SI", 1, 0), predicciones_validacion)</span></span>
<span id="cb168-4316"><a href="#cb168-4316" aria-hidden="true" tabindex="-1"></a><span class="in">      auc_actual &lt;- as.numeric(auc(roc_obj))  # Extraer el valor numérico del AUC</span></span>
<span id="cb168-4317"><a href="#cb168-4317" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb168-4318"><a href="#cb168-4318" aria-hidden="true" tabindex="-1"></a><span class="in">      # Actualizar el mejor modelo y su rendimiento si se encuentra un modelo mejor</span></span>
<span id="cb168-4319"><a href="#cb168-4319" aria-hidden="true" tabindex="-1"></a><span class="in">      if (auc_actual &gt; mejor_auc) {</span></span>
<span id="cb168-4320"><a href="#cb168-4320" aria-hidden="true" tabindex="-1"></a><span class="in">        mejor_auc &lt;- auc_actual</span></span>
<span id="cb168-4321"><a href="#cb168-4321" aria-hidden="true" tabindex="-1"></a><span class="in">        mejor_k &lt;- k</span></span>
<span id="cb168-4322"><a href="#cb168-4322" aria-hidden="true" tabindex="-1"></a><span class="in">        mejor_l &lt;- l</span></span>
<span id="cb168-4323"><a href="#cb168-4323" aria-hidden="true" tabindex="-1"></a><span class="in">      }</span></span>
<span id="cb168-4324"><a href="#cb168-4324" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb168-4325"><a href="#cb168-4325" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-4326"><a href="#cb168-4326" aria-hidden="true" tabindex="-1"></a><span class="in">    ########################</span></span>
<span id="cb168-4327"><a href="#cb168-4327" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-4328"><a href="#cb168-4328" aria-hidden="true" tabindex="-1"></a><span class="in">    encoded_data_test &lt;- as.data.frame(model.matrix(~.-1, datos_test_outer[, -which(names(datos_test_outer) == "ESTADO_ACTUAL")]))</span></span>
<span id="cb168-4329"><a href="#cb168-4329" aria-hidden="true" tabindex="-1"></a><span class="in">    # Realizar predicciones en datos de test</span></span>
<span id="cb168-4330"><a href="#cb168-4330" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_test &lt;- knn(train = encoded_data_entrenamiento, </span></span>
<span id="cb168-4331"><a href="#cb168-4331" aria-hidden="true" tabindex="-1"></a><span class="in">                             test = encoded_data_test, </span></span>
<span id="cb168-4332"><a href="#cb168-4332" aria-hidden="true" tabindex="-1"></a><span class="in">                             cl = datos_entrenamiento_oversampled$ESTADO_ACTUAL, </span></span>
<span id="cb168-4333"><a href="#cb168-4333" aria-hidden="true" tabindex="-1"></a><span class="in">                             k = mejor_k, </span></span>
<span id="cb168-4334"><a href="#cb168-4334" aria-hidden="true" tabindex="-1"></a><span class="in">                             use.all = TRUE,</span></span>
<span id="cb168-4335"><a href="#cb168-4335" aria-hidden="true" tabindex="-1"></a><span class="in">                             prob = TRUE,</span></span>
<span id="cb168-4336"><a href="#cb168-4336" aria-hidden="true" tabindex="-1"></a><span class="in">                             l = mejor_l)</span></span>
<span id="cb168-4337"><a href="#cb168-4337" aria-hidden="true" tabindex="-1"></a><span class="in">   </span></span>
<span id="cb168-4338"><a href="#cb168-4338" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-4339"><a href="#cb168-4339" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_test &lt;- attr(predicciones_test, "prob")  # Asumiendo que "SI" es la clase positiva</span></span>
<span id="cb168-4340"><a href="#cb168-4340" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-4341"><a href="#cb168-4341" aria-hidden="true" tabindex="-1"></a><span class="in">    clases_predichas_test &lt;- ifelse(predicciones_test &gt;= 0.5, "SI", "NO")</span></span>
<span id="cb168-4342"><a href="#cb168-4342" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-4343"><a href="#cb168-4343" aria-hidden="true" tabindex="-1"></a><span class="in">    ###########################</span></span>
<span id="cb168-4344"><a href="#cb168-4344" aria-hidden="true" tabindex="-1"></a><span class="in">    # Realizar predicciones en el conjunto de entrenamiento externo para el AUC general</span></span>
<span id="cb168-4345"><a href="#cb168-4345" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_auc[test_indices_inner] &lt;- predicciones_test</span></span>
<span id="cb168-4346"><a href="#cb168-4346" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_clasificadas &lt;- clases_predichas_test</span></span>
<span id="cb168-4347"><a href="#cb168-4347" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-4348"><a href="#cb168-4348" aria-hidden="true" tabindex="-1"></a><span class="in">    resultados_sensibilidad_inner[i_inner] &lt;- sum(clases_predichas_test == "SI" &amp; datos_validacion[["ESTADO_ACTUAL"]] == "SI") / sum(datos_validacion[["ESTADO_ACTUAL"]] == "SI")</span></span>
<span id="cb168-4349"><a href="#cb168-4349" aria-hidden="true" tabindex="-1"></a><span class="in">    resultados_accuracy_inner[i_inner] &lt;- mean(clases_predichas_test == datos_validacion[["ESTADO_ACTUAL"]])</span></span>
<span id="cb168-4350"><a href="#cb168-4350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4351"><a href="#cb168-4351" aria-hidden="true" tabindex="-1"></a><span class="in">    targets_auc[test_indices_inner] &lt;- as.numeric(datos_validacion$ESTADO_ACTUAL) - 1</span></span>
<span id="cb168-4352"><a href="#cb168-4352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4353"><a href="#cb168-4353" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb168-4354"><a href="#cb168-4354" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-4355"><a href="#cb168-4355" aria-hidden="true" tabindex="-1"></a><span class="in">  # Calcular el AUC final para este fold externo</span></span>
<span id="cb168-4356"><a href="#cb168-4356" aria-hidden="true" tabindex="-1"></a><span class="in">  auc_fold_externo &lt;- pROC::roc(targets_auc, predicciones_auc)$auc</span></span>
<span id="cb168-4357"><a href="#cb168-4357" aria-hidden="true" tabindex="-1"></a><span class="in">  accuracy_fold_externo &lt;- mean(resultados_accuracy_inner)</span></span>
<span id="cb168-4358"><a href="#cb168-4358" aria-hidden="true" tabindex="-1"></a><span class="in">  sensibilidad_fold_externo &lt;- mean(resultados_sensibilidad_inner)</span></span>
<span id="cb168-4359"><a href="#cb168-4359" aria-hidden="true" tabindex="-1"></a><span class="in"> </span></span>
<span id="cb168-4360"><a href="#cb168-4360" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-4361"><a href="#cb168-4361" aria-hidden="true" tabindex="-1"></a><span class="in">  # Almacenar el AUC del fold externo actual</span></span>
<span id="cb168-4362"><a href="#cb168-4362" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_auc[i_outer] &lt;- auc_fold_externo</span></span>
<span id="cb168-4363"><a href="#cb168-4363" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_accuracy[i_outer] &lt;- accuracy_fold_externo</span></span>
<span id="cb168-4364"><a href="#cb168-4364" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_sensibilidad[i_outer] &lt;- sensibilidad_fold_externo</span></span>
<span id="cb168-4365"><a href="#cb168-4365" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-4366"><a href="#cb168-4366" aria-hidden="true" tabindex="-1"></a><span class="in">  # Predecir en los datos de test para este pliegue externo y almacenar predicciones</span></span>
<span id="cb168-4367"><a href="#cb168-4367" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_test &lt;- knn(train = encoded_data_entrenamiento, </span></span>
<span id="cb168-4368"><a href="#cb168-4368" aria-hidden="true" tabindex="-1"></a><span class="in">                           test = encoded_data_test, </span></span>
<span id="cb168-4369"><a href="#cb168-4369" aria-hidden="true" tabindex="-1"></a><span class="in">                           cl = datos_entrenamiento_oversampled$ESTADO_ACTUAL, </span></span>
<span id="cb168-4370"><a href="#cb168-4370" aria-hidden="true" tabindex="-1"></a><span class="in">                           k = mejor_k, </span></span>
<span id="cb168-4371"><a href="#cb168-4371" aria-hidden="true" tabindex="-1"></a><span class="in">                           use.all = TRUE,</span></span>
<span id="cb168-4372"><a href="#cb168-4372" aria-hidden="true" tabindex="-1"></a><span class="in">                           prob = TRUE,</span></span>
<span id="cb168-4373"><a href="#cb168-4373" aria-hidden="true" tabindex="-1"></a><span class="in">                           l = mejor_l)</span></span>
<span id="cb168-4374"><a href="#cb168-4374" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-4375"><a href="#cb168-4375" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_test &lt;- attr(predicciones_test, "prob")  # Asumiendo que "SI" es la clase positiva</span></span>
<span id="cb168-4376"><a href="#cb168-4376" aria-hidden="true" tabindex="-1"></a><span class="in">  clases_predichas_test &lt;- ifelse(predicciones_test &gt;= 0.5, "SI", "NO")</span></span>
<span id="cb168-4377"><a href="#cb168-4377" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-4378"><a href="#cb168-4378" aria-hidden="true" tabindex="-1"></a><span class="in">  # Almacenar predicciones de este fold externo</span></span>
<span id="cb168-4379"><a href="#cb168-4379" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_totales[test_indices_outer, i_outer] &lt;- predicciones_test</span></span>
<span id="cb168-4380"><a href="#cb168-4380" aria-hidden="true" tabindex="-1"></a><span class="in">  targets_totales[test_indices_outer] &lt;- as.numeric(datos_test_outer$ESTADO_ACTUAL) - 1</span></span>
<span id="cb168-4381"><a href="#cb168-4381" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb168-4382"><a href="#cb168-4382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4383"><a href="#cb168-4383" aria-hidden="true" tabindex="-1"></a><span class="in"># Calcular AUC promedio</span></span>
<span id="cb168-4384"><a href="#cb168-4384" aria-hidden="true" tabindex="-1"></a><span class="in">auc_promedio &lt;- mean(resultados_auc)</span></span>
<span id="cb168-4385"><a href="#cb168-4385" aria-hidden="true" tabindex="-1"></a><span class="in">accuracy_promedio &lt;- mean(resultados_accuracy)</span></span>
<span id="cb168-4386"><a href="#cb168-4386" aria-hidden="true" tabindex="-1"></a><span class="in">sensibilidad_promedio &lt;- mean(resultados_sensibilidad)</span></span>
<span id="cb168-4387"><a href="#cb168-4387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4388"><a href="#cb168-4388" aria-hidden="true" tabindex="-1"></a><span class="in"># Crear tabla con todas las métricas</span></span>
<span id="cb168-4389"><a href="#cb168-4389" aria-hidden="true" tabindex="-1"></a><span class="in">tabla_metricas &lt;- data.frame(</span></span>
<span id="cb168-4390"><a href="#cb168-4390" aria-hidden="true" tabindex="-1"></a><span class="in">  Pliegue = 1:k_outer,</span></span>
<span id="cb168-4391"><a href="#cb168-4391" aria-hidden="true" tabindex="-1"></a><span class="in">  AUC = sapply(resultados_auc, round, digits = 3),</span></span>
<span id="cb168-4392"><a href="#cb168-4392" aria-hidden="true" tabindex="-1"></a><span class="in">  Accuracy = sapply(resultados_accuracy, round, digits = 3),</span></span>
<span id="cb168-4393"><a href="#cb168-4393" aria-hidden="true" tabindex="-1"></a><span class="in">  Recall = sapply(resultados_sensibilidad, round, digits = 3)</span></span>
<span id="cb168-4394"><a href="#cb168-4394" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb168-4395"><a href="#cb168-4395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4396"><a href="#cb168-4396" aria-hidden="true" tabindex="-1"></a><span class="in"># Agregar fila con promedio de métricas</span></span>
<span id="cb168-4397"><a href="#cb168-4397" aria-hidden="true" tabindex="-1"></a><span class="in">tabla_metricas_knn &lt;- rbind(tabla_metricas, c("Mean", round(auc_promedio, 3), round(accuracy_promedio, 3), round(sensibilidad_promedio, 3)))</span></span>
<span id="cb168-4398"><a href="#cb168-4398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4399"><a href="#cb168-4399" aria-hidden="true" tabindex="-1"></a><span class="in">end_time &lt;- Sys.time()</span></span>
<span id="cb168-4400"><a href="#cb168-4400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4401"><a href="#cb168-4401" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time_knn &lt;- end_time - start_time</span></span>
<span id="cb168-4402"><a href="#cb168-4402" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time_knn &lt;- as.numeric(execution_time_knn, units = "secs")</span></span>
<span id="cb168-4403"><a href="#cb168-4403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4404"><a href="#cb168-4404" aria-hidden="true" tabindex="-1"></a><span class="in"># Guardar resultados</span></span>
<span id="cb168-4405"><a href="#cb168-4405" aria-hidden="true" tabindex="-1"></a><span class="in">save(tabla_metricas_knn, file = "tabla_metricas_knn.RData")</span></span>
<span id="cb168-4406"><a href="#cb168-4406" aria-hidden="true" tabindex="-1"></a><span class="in">save(execution_time_knn, file = "execution_time_knn.RData")</span></span>
<span id="cb168-4407"><a href="#cb168-4407" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-4408"><a href="#cb168-4408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4411"><a href="#cb168-4411" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-4412"><a href="#cb168-4412" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"tabla_metricas_knn.RData"</span>)</span>
<span id="cb168-4413"><a href="#cb168-4413" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"execution_time_knn.RData"</span>)</span>
<span id="cb168-4414"><a href="#cb168-4414" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir el tiempo de ejecución</span></span>
<span id="cb168-4415"><a href="#cb168-4415" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time_knn,  <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb168-4416"><a href="#cb168-4416" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-4417"><a href="#cb168-4417" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb168-4418"><a href="#cb168-4418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4419"><a href="#cb168-4419" aria-hidden="true" tabindex="-1"></a><span class="fu"># Metrics Table</span></span>
<span id="cb168-4422"><a href="#cb168-4422" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-4423"><a href="#cb168-4423" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir tabla formateada con kableExtra</span></span>
<span id="cb168-4424"><a href="#cb168-4424" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(tabla_metricas_knn, <span class="at">caption =</span> <span class="st">"Cross Validation Metrics"</span>, <span class="at">align =</span> <span class="st">"c"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb168-4425"><a href="#cb168-4425" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb168-4426"><a href="#cb168-4426" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-4427"><a href="#cb168-4427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4428"><a href="#cb168-4428" aria-hidden="true" tabindex="-1"></a><span class="fu"># Metrics Plot</span></span>
<span id="cb168-4431"><a href="#cb168-4431" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-4432"><a href="#cb168-4432" aria-hidden="true" tabindex="-1"></a><span class="fu">crear_plot_metricas_per_fold</span>(tabla_metricas_knn)</span>
<span id="cb168-4433"><a href="#cb168-4433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4434"><a href="#cb168-4434" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-4435"><a href="#cb168-4435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4436"><a href="#cb168-4436" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb168-4437"><a href="#cb168-4437" aria-hidden="true" tabindex="-1"></a>The model does not have a good performance, in fact, it only predicts True Methastasis.</span>
<span id="cb168-4438"><a href="#cb168-4438" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb168-4439"><a href="#cb168-4439" aria-hidden="true" tabindex="-1"></a><span class="fu"># AdaBoost {#adaboost}</span></span>
<span id="cb168-4440"><a href="#cb168-4440" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset style="background-color: #f0f0f0;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;"}</span>
<span id="cb168-4441"><a href="#cb168-4441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4442"><a href="#cb168-4442" aria-hidden="true" tabindex="-1"></a><span class="fu">## Hold out</span></span>
<span id="cb168-4445"><a href="#cb168-4445" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-4446"><a href="#cb168-4446" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb168-4447"><a href="#cb168-4447" aria-hidden="true" tabindex="-1"></a><span class="co"># Parámetros a cambiar</span></span>
<span id="cb168-4448"><a href="#cb168-4448" aria-hidden="true" tabindex="-1"></a>proportion <span class="ot">&lt;-</span> <span class="fl">0.28</span></span>
<span id="cb168-4449"><a href="#cb168-4449" aria-hidden="true" tabindex="-1"></a>sensitivity_weight <span class="ot">&lt;-</span> <span class="fl">0.8</span></span>
<span id="cb168-4450"><a href="#cb168-4450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4451"><a href="#cb168-4451" aria-hidden="true" tabindex="-1"></a><span class="co"># Dividir el conjunto de datos en entrenamiento y test</span></span>
<span id="cb168-4452"><a href="#cb168-4452" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)  <span class="co"># Establecer una semilla para reproducibilidad</span></span>
<span id="cb168-4453"><a href="#cb168-4453" aria-hidden="true" tabindex="-1"></a>indices_entrenamiento <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(data), <span class="fl">0.75</span> <span class="sc">*</span> <span class="fu">nrow</span>(data))  <span class="co"># 75% para entrenamiento</span></span>
<span id="cb168-4454"><a href="#cb168-4454" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento <span class="ot">&lt;-</span> data[indices_entrenamiento, ]</span>
<span id="cb168-4455"><a href="#cb168-4455" aria-hidden="true" tabindex="-1"></a>datos_test <span class="ot">&lt;-</span> data[<span class="sc">-</span>indices_entrenamiento, ]</span>
<span id="cb168-4456"><a href="#cb168-4456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4457"><a href="#cb168-4457" aria-hidden="true" tabindex="-1"></a><span class="co"># Dividir datos de entrenamiento en entrenamiento y validación</span></span>
<span id="cb168-4458"><a href="#cb168-4458" aria-hidden="true" tabindex="-1"></a>train_indices <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(datos_entrenamiento), <span class="fl">0.8</span> <span class="sc">*</span> <span class="fu">nrow</span>(datos_entrenamiento))  <span class="co"># 80% para entrenamiento</span></span>
<span id="cb168-4459"><a href="#cb168-4459" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento_split <span class="ot">&lt;-</span> datos_entrenamiento[train_indices, ]</span>
<span id="cb168-4460"><a href="#cb168-4460" aria-hidden="true" tabindex="-1"></a>datos_validacion <span class="ot">&lt;-</span> datos_entrenamiento[<span class="sc">-</span>train_indices, ]</span>
<span id="cb168-4461"><a href="#cb168-4461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4462"><a href="#cb168-4462" aria-hidden="true" tabindex="-1"></a><span class="co"># Realizar sobremuestreo en los datos de entrenamiento</span></span>
<span id="cb168-4463"><a href="#cb168-4463" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento_oversampled <span class="ot">&lt;-</span> <span class="fu">ROSE</span>(ESTADO_ACTUAL <span class="sc">~</span> ., <span class="at">data =</span> datos_entrenamiento_split, <span class="at">seed =</span> <span class="dv">123</span>, <span class="at">p =</span> proportion)<span class="sc">$</span>data</span>
<span id="cb168-4464"><a href="#cb168-4464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4465"><a href="#cb168-4465" aria-hidden="true" tabindex="-1"></a><span class="co"># Definir la función para calcular el métrico personalizado</span></span>
<span id="cb168-4466"><a href="#cb168-4466" aria-hidden="true" tabindex="-1"></a>compute_custom_metric <span class="ot">&lt;-</span> <span class="cf">function</span>(recall, accuracy, <span class="at">sensitivity_weight =</span> <span class="dv">1</span>) {</span>
<span id="cb168-4467"><a href="#cb168-4467" aria-hidden="true" tabindex="-1"></a>  custom_metric <span class="ot">&lt;-</span> (sensitivity_weight <span class="sc">*</span> recall) <span class="sc">+</span> ((<span class="dv">1</span> <span class="sc">-</span> sensitivity_weight) <span class="sc">*</span> accuracy)</span>
<span id="cb168-4468"><a href="#cb168-4468" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(custom_metric)</span>
<span id="cb168-4469"><a href="#cb168-4469" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb168-4470"><a href="#cb168-4470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4471"><a href="#cb168-4471" aria-hidden="true" tabindex="-1"></a><span class="co"># Inicializar variables para almacenar los resultados</span></span>
<span id="cb168-4472"><a href="#cb168-4472" aria-hidden="true" tabindex="-1"></a>mejor_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb168-4473"><a href="#cb168-4473" aria-hidden="true" tabindex="-1"></a>mejor_modelo <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb168-4474"><a href="#cb168-4474" aria-hidden="true" tabindex="-1"></a>mejores_iteraciones <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb168-4475"><a href="#cb168-4475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4476"><a href="#cb168-4476" aria-hidden="true" tabindex="-1"></a><span class="co"># Bucle para probar diferentes combinaciones de hiperparámetros</span></span>
<span id="cb168-4477"><a href="#cb168-4477" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (iteraciones <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">50</span>, <span class="dv">500</span>, <span class="dv">50</span>)) {</span>
<span id="cb168-4478"><a href="#cb168-4478" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Entrenar el modelo glmboost</span></span>
<span id="cb168-4479"><a href="#cb168-4479" aria-hidden="true" tabindex="-1"></a>  modelo <span class="ot">&lt;-</span> <span class="fu">glmboost</span>(ESTADO_ACTUAL <span class="sc">~</span> ., <span class="at">data =</span> datos_entrenamiento_oversampled, <span class="at">family =</span> <span class="fu">Binomial</span>(), <span class="at">control =</span> <span class="fu">boost_control</span>(<span class="at">mstop =</span> iteraciones))</span>
<span id="cb168-4480"><a href="#cb168-4480" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-4481"><a href="#cb168-4481" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Realizar predicciones en datos de validación</span></span>
<span id="cb168-4482"><a href="#cb168-4482" aria-hidden="true" tabindex="-1"></a>  predicciones_validacion <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelo, <span class="at">newdata =</span> datos_validacion, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb168-4483"><a href="#cb168-4483" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-4484"><a href="#cb168-4484" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular el AUC</span></span>
<span id="cb168-4485"><a href="#cb168-4485" aria-hidden="true" tabindex="-1"></a>  pred <span class="ot">&lt;-</span> <span class="fu">prediction</span>(predicciones_validacion, datos_validacion<span class="sc">$</span>ESTADO_ACTUAL)</span>
<span id="cb168-4486"><a href="#cb168-4486" aria-hidden="true" tabindex="-1"></a>  perf <span class="ot">&lt;-</span> <span class="fu">performance</span>(pred, <span class="at">measure =</span> <span class="st">"auc"</span>)</span>
<span id="cb168-4487"><a href="#cb168-4487" aria-hidden="true" tabindex="-1"></a>  auc_actual <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(perf<span class="sc">@</span>y.values)</span>
<span id="cb168-4488"><a href="#cb168-4488" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-4489"><a href="#cb168-4489" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Actualizar el mejor modelo y su rendimiento si se encuentra un modelo mejor</span></span>
<span id="cb168-4490"><a href="#cb168-4490" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (auc_actual <span class="sc">&gt;</span> mejor_auc) {</span>
<span id="cb168-4491"><a href="#cb168-4491" aria-hidden="true" tabindex="-1"></a>    mejor_auc <span class="ot">&lt;-</span> auc_actual</span>
<span id="cb168-4492"><a href="#cb168-4492" aria-hidden="true" tabindex="-1"></a>    mejor_modelo <span class="ot">&lt;-</span> modelo</span>
<span id="cb168-4493"><a href="#cb168-4493" aria-hidden="true" tabindex="-1"></a>    mejores_iteraciones <span class="ot">&lt;-</span> iteraciones</span>
<span id="cb168-4494"><a href="#cb168-4494" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb168-4495"><a href="#cb168-4495" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb168-4496"><a href="#cb168-4496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4497"><a href="#cb168-4497" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mejor_modelo)</span>
<span id="cb168-4498"><a href="#cb168-4498" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb168-4499"><a href="#cb168-4499" aria-hidden="true" tabindex="-1"></a>execution_time <span class="ot">&lt;-</span> end_time <span class="sc">-</span> start_time</span>
<span id="cb168-4500"><a href="#cb168-4500" aria-hidden="true" tabindex="-1"></a>execution_time <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(execution_time, <span class="at">units =</span> <span class="st">"secs"</span>)</span>
<span id="cb168-4501"><a href="#cb168-4501" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time,  <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb168-4502"><a href="#cb168-4502" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-4503"><a href="#cb168-4503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4504"><a href="#cb168-4504" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb168-4505"><a href="#cb168-4505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4506"><a href="#cb168-4506" aria-hidden="true" tabindex="-1"></a><span class="fu">### Predictions</span></span>
<span id="cb168-4507"><a href="#cb168-4507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4508"><a href="#cb168-4508" aria-hidden="true" tabindex="-1"></a>We are going to predict on test in order to get a estimation of the performance of the model.</span>
<span id="cb168-4509"><a href="#cb168-4509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4512"><a href="#cb168-4512" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-4513"><a href="#cb168-4513" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluar el mejor modelo en el conjunto de prueba</span></span>
<span id="cb168-4514"><a href="#cb168-4514" aria-hidden="true" tabindex="-1"></a>predicciones_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(mejor_modelo, <span class="at">newdata =</span> datos_test, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb168-4515"><a href="#cb168-4515" aria-hidden="true" tabindex="-1"></a>clases_predichas_test <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predicciones_test <span class="sc">&gt;</span> <span class="fl">0.5</span>, <span class="st">"SI"</span>, <span class="st">"NO"</span>)</span>
<span id="cb168-4516"><a href="#cb168-4516" aria-hidden="true" tabindex="-1"></a><span class="fu">mostrar_metricas</span>(datos_test<span class="sc">$</span>ESTADO_ACTUAL,clases_predichas_test)</span>
<span id="cb168-4517"><a href="#cb168-4517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4518"><a href="#cb168-4518" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-4519"><a href="#cb168-4519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4520"><a href="#cb168-4520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4521"><a href="#cb168-4521" aria-hidden="true" tabindex="-1"></a><span class="fu">### Roc curve and auc</span></span>
<span id="cb168-4522"><a href="#cb168-4522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4525"><a href="#cb168-4525" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-4526"><a href="#cb168-4526" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_roc_curve</span>(predicciones_test,datos_test<span class="sc">$</span>ESTADO_ACTUAL)</span>
<span id="cb168-4527"><a href="#cb168-4527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4528"><a href="#cb168-4528" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-4529"><a href="#cb168-4529" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb168-4530"><a href="#cb168-4530" aria-hidden="true" tabindex="-1"></a>The performance of the model is encouraging. The model has a good performance in the test set.</span>
<span id="cb168-4531"><a href="#cb168-4531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4532"><a href="#cb168-4532" aria-hidden="true" tabindex="-1"></a><span class="fu">## 5x2 Cross Validation Filter</span></span>
<span id="cb168-4533"><a href="#cb168-4533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4534"><a href="#cb168-4534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4535"><a href="#cb168-4535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4536"><a href="#cb168-4536" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=FALSE,message=FALSE, eval=FALSE}</span></span>
<span id="cb168-4537"><a href="#cb168-4537" aria-hidden="true" tabindex="-1"></a><span class="in">start_time &lt;- Sys.time()</span></span>
<span id="cb168-4538"><a href="#cb168-4538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4539"><a href="#cb168-4539" aria-hidden="true" tabindex="-1"></a><span class="in"># Configurar la validación cruzada 5x2</span></span>
<span id="cb168-4540"><a href="#cb168-4540" aria-hidden="true" tabindex="-1"></a><span class="in">k_outer &lt;- 5  # Número de pliegues externos</span></span>
<span id="cb168-4541"><a href="#cb168-4541" aria-hidden="true" tabindex="-1"></a><span class="in">k_inner &lt;- 2  # Número de pliegues internos</span></span>
<span id="cb168-4542"><a href="#cb168-4542" aria-hidden="true" tabindex="-1"></a><span class="in">folds_outer &lt;- createFolds(data$ESTADO_ACTUAL, k = k_outer, list = FALSE)  # Obtener índices de pliegues externos</span></span>
<span id="cb168-4543"><a href="#cb168-4543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4544"><a href="#cb168-4544" aria-hidden="true" tabindex="-1"></a><span class="in"># Lista para almacenar resultados</span></span>
<span id="cb168-4545"><a href="#cb168-4545" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_auc &lt;- numeric(k_outer)</span></span>
<span id="cb168-4546"><a href="#cb168-4546" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_sensibilidad &lt;- numeric(k_outer)</span></span>
<span id="cb168-4547"><a href="#cb168-4547" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_accuracy &lt;- numeric(k_outer)</span></span>
<span id="cb168-4548"><a href="#cb168-4548" aria-hidden="true" tabindex="-1"></a><span class="in">indices &lt;- 1:nrow(data)</span></span>
<span id="cb168-4549"><a href="#cb168-4549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4550"><a href="#cb168-4550" aria-hidden="true" tabindex="-1"></a><span class="in"># Inicializar matrices para almacenar predicciones y objetivos</span></span>
<span id="cb168-4551"><a href="#cb168-4551" aria-hidden="true" tabindex="-1"></a><span class="in">predicciones_totales &lt;- matrix(NA, nrow = nrow(data), ncol = k_outer)</span></span>
<span id="cb168-4552"><a href="#cb168-4552" aria-hidden="true" tabindex="-1"></a><span class="in">targets_totales &lt;- numeric(nrow(data))</span></span>
<span id="cb168-4553"><a href="#cb168-4553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4554"><a href="#cb168-4554" aria-hidden="true" tabindex="-1"></a><span class="in"># Iterar sobre cada pliegue externo y realizar el proceso de modelado</span></span>
<span id="cb168-4555"><a href="#cb168-4555" aria-hidden="true" tabindex="-1"></a><span class="in">for (i_outer in 1:k_outer) {</span></span>
<span id="cb168-4556"><a href="#cb168-4556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4557"><a href="#cb168-4557" aria-hidden="true" tabindex="-1"></a><span class="in">  # Obtener los índices para el pliegue externo actual</span></span>
<span id="cb168-4558"><a href="#cb168-4558" aria-hidden="true" tabindex="-1"></a><span class="in">  test_indices_outer &lt;- indices[folds_outer==i_outer]  # Índices correspondientes al pliegue externo de test</span></span>
<span id="cb168-4559"><a href="#cb168-4559" aria-hidden="true" tabindex="-1"></a><span class="in">  train_indices_outer &lt;- setdiff(1:nrow(data), test_indices_outer)  # Índices correspondientes al conjunto de entrenamiento</span></span>
<span id="cb168-4560"><a href="#cb168-4560" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-4561"><a href="#cb168-4561" aria-hidden="true" tabindex="-1"></a><span class="in">  # Dividir datos en entrenamiento y test para el pliegue externo</span></span>
<span id="cb168-4562"><a href="#cb168-4562" aria-hidden="true" tabindex="-1"></a><span class="in">  datos_entrenamiento_outer &lt;- data[train_indices_outer, ]</span></span>
<span id="cb168-4563"><a href="#cb168-4563" aria-hidden="true" tabindex="-1"></a><span class="in">  datos_test_outer &lt;- data[test_indices_outer, ]</span></span>
<span id="cb168-4564"><a href="#cb168-4564" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-4565"><a href="#cb168-4565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4566"><a href="#cb168-4566" aria-hidden="true" tabindex="-1"></a><span class="in">  # Configurar la validación cruzada interna</span></span>
<span id="cb168-4567"><a href="#cb168-4567" aria-hidden="true" tabindex="-1"></a><span class="in">  folds_inner &lt;- createFolds(datos_entrenamiento_outer$ESTADO_ACTUAL, k = k_inner, list = FALSE)  # Obtener índices de pliegues internos</span></span>
<span id="cb168-4568"><a href="#cb168-4568" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-4569"><a href="#cb168-4569" aria-hidden="true" tabindex="-1"></a><span class="in">  # Almacenar predicciones y test para formar una curva ROC general</span></span>
<span id="cb168-4570"><a href="#cb168-4570" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_auc &lt;- numeric(nrow(datos_entrenamiento_outer))</span></span>
<span id="cb168-4571"><a href="#cb168-4571" aria-hidden="true" tabindex="-1"></a><span class="in">  targets_auc &lt;- numeric(nrow(datos_entrenamiento_outer))</span></span>
<span id="cb168-4572"><a href="#cb168-4572" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-4573"><a href="#cb168-4573" aria-hidden="true" tabindex="-1"></a><span class="in">  # Iterar sobre cada pliegue interno para selección de modelo</span></span>
<span id="cb168-4574"><a href="#cb168-4574" aria-hidden="true" tabindex="-1"></a><span class="in">  indices_inner &lt;- 1:nrow(datos_entrenamiento_outer)</span></span>
<span id="cb168-4575"><a href="#cb168-4575" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_auc_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-4576"><a href="#cb168-4576" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_sensibilidad_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-4577"><a href="#cb168-4577" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_accuracy_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-4578"><a href="#cb168-4578" aria-hidden="true" tabindex="-1"></a><span class="in">  for (i_inner in 1:k_inner) {</span></span>
<span id="cb168-4579"><a href="#cb168-4579" aria-hidden="true" tabindex="-1"></a><span class="in">    ###############################</span></span>
<span id="cb168-4580"><a href="#cb168-4580" aria-hidden="true" tabindex="-1"></a><span class="in">    #### Aqui el filtrado##########</span></span>
<span id="cb168-4581"><a href="#cb168-4581" aria-hidden="true" tabindex="-1"></a><span class="in">    ###############################</span></span>
<span id="cb168-4582"><a href="#cb168-4582" aria-hidden="true" tabindex="-1"></a><span class="in">    filter_data &lt;- filter_dependency(datos_entrenamiento_outer,"ESTADO_ACTUAL",colnames(datos_entrenamiento_outer),0.05)</span></span>
<span id="cb168-4583"><a href="#cb168-4583" aria-hidden="true" tabindex="-1"></a><span class="in">    if ("ESTADO_ACTUAL.1" %in% colnames(filter_data)) {</span></span>
<span id="cb168-4584"><a href="#cb168-4584" aria-hidden="true" tabindex="-1"></a><span class="in">      filter_data &lt;- filter_data[, !colnames(filter_data) %in% "ESTADO_ACTUAL.1", drop = FALSE]</span></span>
<span id="cb168-4585"><a href="#cb168-4585" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb168-4586"><a href="#cb168-4586" aria-hidden="true" tabindex="-1"></a><span class="in">#con poca variables solo unaa la vez o filtrado o wrapper</span></span>
<span id="cb168-4587"><a href="#cb168-4587" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-4588"><a href="#cb168-4588" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-4589"><a href="#cb168-4589" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-4590"><a href="#cb168-4590" aria-hidden="true" tabindex="-1"></a><span class="in">    # Obtener los índices para el pliegue interno actual</span></span>
<span id="cb168-4591"><a href="#cb168-4591" aria-hidden="true" tabindex="-1"></a><span class="in">    test_indices_inner &lt;- indices_inner[folds_inner==i_inner]  # Índices correspondientes al pliegue interno de test</span></span>
<span id="cb168-4592"><a href="#cb168-4592" aria-hidden="true" tabindex="-1"></a><span class="in">    train_indices_inner &lt;- setdiff(1:nrow(datos_entrenamiento_outer), test_indices_inner)  # Índices correspondientes al conjunto de entrenamiento interno</span></span>
<span id="cb168-4593"><a href="#cb168-4593" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-4594"><a href="#cb168-4594" aria-hidden="true" tabindex="-1"></a><span class="in">    # Dividir datos en entrenamiento y test para el pliegue interno</span></span>
<span id="cb168-4595"><a href="#cb168-4595" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_entrenamiento_inner &lt;- datos_entrenamiento_outer[train_indices_inner, ]</span></span>
<span id="cb168-4596"><a href="#cb168-4596" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_validacion &lt;- datos_entrenamiento_outer[test_indices_inner, ]</span></span>
<span id="cb168-4597"><a href="#cb168-4597" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-4598"><a href="#cb168-4598" aria-hidden="true" tabindex="-1"></a><span class="in"> </span></span>
<span id="cb168-4599"><a href="#cb168-4599" aria-hidden="true" tabindex="-1"></a><span class="in">    # Aplicar oversampling en el conjunto de entrenamiento interno</span></span>
<span id="cb168-4600"><a href="#cb168-4600" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_entrenamiento_oversampled &lt;- ROSE(ESTADO_ACTUAL ~ .,</span></span>
<span id="cb168-4601"><a href="#cb168-4601" aria-hidden="true" tabindex="-1"></a><span class="in">                                            data = datos_entrenamiento_inner,</span></span>
<span id="cb168-4602"><a href="#cb168-4602" aria-hidden="true" tabindex="-1"></a><span class="in">                                            p = 0.28)$data</span></span>
<span id="cb168-4603"><a href="#cb168-4603" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-4604"><a href="#cb168-4604" aria-hidden="true" tabindex="-1"></a><span class="in">    # Inicializar variables para almacenar los resultados</span></span>
<span id="cb168-4605"><a href="#cb168-4605" aria-hidden="true" tabindex="-1"></a><span class="in">    mejor_auc &lt;- 0</span></span>
<span id="cb168-4606"><a href="#cb168-4606" aria-hidden="true" tabindex="-1"></a><span class="in">    mejor_modelo &lt;- NULL</span></span>
<span id="cb168-4607"><a href="#cb168-4607" aria-hidden="true" tabindex="-1"></a><span class="in">    mejores_iteraciones &lt;- 0</span></span>
<span id="cb168-4608"><a href="#cb168-4608" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb168-4609"><a href="#cb168-4609" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-4610"><a href="#cb168-4610" aria-hidden="true" tabindex="-1"></a><span class="in">    # Iterar sobre las combinaciones de hiperparámetros</span></span>
<span id="cb168-4611"><a href="#cb168-4611" aria-hidden="true" tabindex="-1"></a><span class="in">    for (iteraciones in seq(50, 500, 50)) {</span></span>
<span id="cb168-4612"><a href="#cb168-4612" aria-hidden="true" tabindex="-1"></a><span class="in">      # Entrenar el modelo glmboost</span></span>
<span id="cb168-4613"><a href="#cb168-4613" aria-hidden="true" tabindex="-1"></a><span class="in">      modelo &lt;- glmboost(ESTADO_ACTUAL ~ ., data = datos_entrenamiento_oversampled, family = Binomial(), control = boost_control(mstop = iteraciones))</span></span>
<span id="cb168-4614"><a href="#cb168-4614" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-4615"><a href="#cb168-4615" aria-hidden="true" tabindex="-1"></a><span class="in">      predicciones_validacion &lt;- predict(modelo, newdata = datos_validacion, type = "response")</span></span>
<span id="cb168-4616"><a href="#cb168-4616" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-4617"><a href="#cb168-4617" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-4618"><a href="#cb168-4618" aria-hidden="true" tabindex="-1"></a><span class="in">      # Calcular el AUC</span></span>
<span id="cb168-4619"><a href="#cb168-4619" aria-hidden="true" tabindex="-1"></a><span class="in">      pred &lt;- prediction(predicciones_validacion, datos_validacion$ESTADO_ACTUAL)</span></span>
<span id="cb168-4620"><a href="#cb168-4620" aria-hidden="true" tabindex="-1"></a><span class="in">      perf &lt;- performance(pred, measure = "auc")</span></span>
<span id="cb168-4621"><a href="#cb168-4621" aria-hidden="true" tabindex="-1"></a><span class="in">      auc_actual &lt;- as.numeric(perf@y.values)</span></span>
<span id="cb168-4622"><a href="#cb168-4622" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb168-4623"><a href="#cb168-4623" aria-hidden="true" tabindex="-1"></a><span class="in">      # Actualizar el mejor modelo y su AUC si se encuentra un modelo mejor</span></span>
<span id="cb168-4624"><a href="#cb168-4624" aria-hidden="true" tabindex="-1"></a><span class="in">      if (auc_actual &gt; mejor_auc) {</span></span>
<span id="cb168-4625"><a href="#cb168-4625" aria-hidden="true" tabindex="-1"></a><span class="in">          mejor_auc &lt;- auc_actual</span></span>
<span id="cb168-4626"><a href="#cb168-4626" aria-hidden="true" tabindex="-1"></a><span class="in">          mejor_modelo &lt;- modelo</span></span>
<span id="cb168-4627"><a href="#cb168-4627" aria-hidden="true" tabindex="-1"></a><span class="in">          mejores_iteraciones &lt;- iteraciones</span></span>
<span id="cb168-4628"><a href="#cb168-4628" aria-hidden="true" tabindex="-1"></a><span class="in">        }</span></span>
<span id="cb168-4629"><a href="#cb168-4629" aria-hidden="true" tabindex="-1"></a><span class="in">      }</span></span>
<span id="cb168-4630"><a href="#cb168-4630" aria-hidden="true" tabindex="-1"></a><span class="in">    ########################</span></span>
<span id="cb168-4631"><a href="#cb168-4631" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-4632"><a href="#cb168-4632" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_test &lt;- predict(mejor_modelo, newdata = datos_validacion, type = "response")</span></span>
<span id="cb168-4633"><a href="#cb168-4633" aria-hidden="true" tabindex="-1"></a><span class="in">    clases_predichas_test &lt;- ifelse(predicciones_test &gt;= 0.5, "SI", "NO")</span></span>
<span id="cb168-4634"><a href="#cb168-4634" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-4635"><a href="#cb168-4635" aria-hidden="true" tabindex="-1"></a><span class="in">    ###########################</span></span>
<span id="cb168-4636"><a href="#cb168-4636" aria-hidden="true" tabindex="-1"></a><span class="in">    # Realizar predicciones en el conjunto de entrenamiento externo para el AUC general</span></span>
<span id="cb168-4637"><a href="#cb168-4637" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_auc[test_indices_inner] &lt;- predicciones_test</span></span>
<span id="cb168-4638"><a href="#cb168-4638" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_clasificadas &lt;- clases_predichas_test</span></span>
<span id="cb168-4639"><a href="#cb168-4639" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-4640"><a href="#cb168-4640" aria-hidden="true" tabindex="-1"></a><span class="in">    resultados_sensibilidad_inner[i_inner] &lt;- sum(clases_predichas_test == "SI" &amp; datos_validacion[["ESTADO_ACTUAL"]] == "SI") / sum(datos_validacion[["ESTADO_ACTUAL"]] == "SI")</span></span>
<span id="cb168-4641"><a href="#cb168-4641" aria-hidden="true" tabindex="-1"></a><span class="in">    resultados_accuracy_inner[i_inner] &lt;- mean(clases_predichas_test == datos_validacion[["ESTADO_ACTUAL"]])</span></span>
<span id="cb168-4642"><a href="#cb168-4642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4643"><a href="#cb168-4643" aria-hidden="true" tabindex="-1"></a><span class="in">    targets_auc[test_indices_inner] &lt;- as.numeric(datos_validacion$ESTADO_ACTUAL) - 1</span></span>
<span id="cb168-4644"><a href="#cb168-4644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4645"><a href="#cb168-4645" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb168-4646"><a href="#cb168-4646" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-4647"><a href="#cb168-4647" aria-hidden="true" tabindex="-1"></a><span class="in">  # Calcular el AUC final para este fold externo</span></span>
<span id="cb168-4648"><a href="#cb168-4648" aria-hidden="true" tabindex="-1"></a><span class="in">  auc_fold_externo &lt;- pROC::roc(targets_auc, predicciones_auc)$auc</span></span>
<span id="cb168-4649"><a href="#cb168-4649" aria-hidden="true" tabindex="-1"></a><span class="in">  accuracy_fold_externo &lt;- mean(resultados_accuracy_inner)</span></span>
<span id="cb168-4650"><a href="#cb168-4650" aria-hidden="true" tabindex="-1"></a><span class="in">  sensibilidad_fold_externo &lt;- mean(resultados_sensibilidad_inner)</span></span>
<span id="cb168-4651"><a href="#cb168-4651" aria-hidden="true" tabindex="-1"></a><span class="in"> </span></span>
<span id="cb168-4652"><a href="#cb168-4652" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-4653"><a href="#cb168-4653" aria-hidden="true" tabindex="-1"></a><span class="in">  # Almacenar el AUC del fold externo actual</span></span>
<span id="cb168-4654"><a href="#cb168-4654" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_auc[i_outer] &lt;- auc_fold_externo</span></span>
<span id="cb168-4655"><a href="#cb168-4655" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_accuracy[i_outer] &lt;- accuracy_fold_externo</span></span>
<span id="cb168-4656"><a href="#cb168-4656" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_sensibilidad[i_outer] &lt;- sensibilidad_fold_externo</span></span>
<span id="cb168-4657"><a href="#cb168-4657" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-4658"><a href="#cb168-4658" aria-hidden="true" tabindex="-1"></a><span class="in">  # Predecir en los datos de test para este pliegue externo y almacenar predicciones</span></span>
<span id="cb168-4659"><a href="#cb168-4659" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_test &lt;- predict(mejor_modelo, newdata = datos_test_outer, type = "response")</span></span>
<span id="cb168-4660"><a href="#cb168-4660" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_totales[test_indices_outer, i_outer] &lt;- predicciones_test</span></span>
<span id="cb168-4661"><a href="#cb168-4661" aria-hidden="true" tabindex="-1"></a><span class="in">  targets_totales[test_indices_outer] &lt;- as.numeric(datos_test_outer$ESTADO_ACTUAL) - 1</span></span>
<span id="cb168-4662"><a href="#cb168-4662" aria-hidden="true" tabindex="-1"></a><span class="in"> </span></span>
<span id="cb168-4663"><a href="#cb168-4663" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb168-4664"><a href="#cb168-4664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4665"><a href="#cb168-4665" aria-hidden="true" tabindex="-1"></a><span class="in"># Calcular AUC promedio</span></span>
<span id="cb168-4666"><a href="#cb168-4666" aria-hidden="true" tabindex="-1"></a><span class="in">auc_promedio &lt;- mean(resultados_auc)</span></span>
<span id="cb168-4667"><a href="#cb168-4667" aria-hidden="true" tabindex="-1"></a><span class="in">accuracy_promedio &lt;- mean(resultados_accuracy)</span></span>
<span id="cb168-4668"><a href="#cb168-4668" aria-hidden="true" tabindex="-1"></a><span class="in">sensibilidad_promedio &lt;- mean(resultados_sensibilidad)</span></span>
<span id="cb168-4669"><a href="#cb168-4669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4670"><a href="#cb168-4670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4671"><a href="#cb168-4671" aria-hidden="true" tabindex="-1"></a><span class="in"># Crear tabla con todas las métricas</span></span>
<span id="cb168-4672"><a href="#cb168-4672" aria-hidden="true" tabindex="-1"></a><span class="in">tabla_metricas &lt;- data.frame(</span></span>
<span id="cb168-4673"><a href="#cb168-4673" aria-hidden="true" tabindex="-1"></a><span class="in">  Pliegue = 1:k_outer,</span></span>
<span id="cb168-4674"><a href="#cb168-4674" aria-hidden="true" tabindex="-1"></a><span class="in">  AUC = sapply(resultados_auc, round, digits = 3),</span></span>
<span id="cb168-4675"><a href="#cb168-4675" aria-hidden="true" tabindex="-1"></a><span class="in">  Accuracy = sapply(resultados_accuracy, round, digits = 3),</span></span>
<span id="cb168-4676"><a href="#cb168-4676" aria-hidden="true" tabindex="-1"></a><span class="in">  Recall = sapply(resultados_sensibilidad, round, digits = 3)</span></span>
<span id="cb168-4677"><a href="#cb168-4677" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb168-4678"><a href="#cb168-4678" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4679"><a href="#cb168-4679" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4680"><a href="#cb168-4680" aria-hidden="true" tabindex="-1"></a><span class="in"># Agregar fila con promedio de métricas</span></span>
<span id="cb168-4681"><a href="#cb168-4681" aria-hidden="true" tabindex="-1"></a><span class="in">tabla_metricas_ada &lt;- rbind(tabla_metricas, c("Mean", round(auc_promedio,3), round(accuracy_promedio,3), round(sensibilidad_promedio,3)))</span></span>
<span id="cb168-4682"><a href="#cb168-4682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4683"><a href="#cb168-4683" aria-hidden="true" tabindex="-1"></a><span class="in">end_time &lt;- Sys.time()</span></span>
<span id="cb168-4684"><a href="#cb168-4684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4685"><a href="#cb168-4685" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time_ada &lt;- end_time - start_time</span></span>
<span id="cb168-4686"><a href="#cb168-4686" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time_ada &lt;- as.numeric(execution_time_ada, units = "secs")</span></span>
<span id="cb168-4687"><a href="#cb168-4687" aria-hidden="true" tabindex="-1"></a><span class="in">save(tabla_metricas_ada, file = "tabla_metricas_ada_filter.RData")</span></span>
<span id="cb168-4688"><a href="#cb168-4688" aria-hidden="true" tabindex="-1"></a><span class="in">save(execution_time_ada, file = "execution_time_ada_filter.RData")</span></span>
<span id="cb168-4689"><a href="#cb168-4689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4690"><a href="#cb168-4690" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-4691"><a href="#cb168-4691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4694"><a href="#cb168-4694" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-4695"><a href="#cb168-4695" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"tabla_metricas_ada_filter.RData"</span>)</span>
<span id="cb168-4696"><a href="#cb168-4696" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"execution_time_ada_filter.RData"</span>)</span>
<span id="cb168-4697"><a href="#cb168-4697" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir el tiempo de ejecución</span></span>
<span id="cb168-4698"><a href="#cb168-4698" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time_ada,  <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb168-4699"><a href="#cb168-4699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4700"><a href="#cb168-4700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4701"><a href="#cb168-4701" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-4702"><a href="#cb168-4702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4703"><a href="#cb168-4703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4704"><a href="#cb168-4704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4705"><a href="#cb168-4705" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb168-4706"><a href="#cb168-4706" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4707"><a href="#cb168-4707" aria-hidden="true" tabindex="-1"></a><span class="fu"># Metrics Table</span></span>
<span id="cb168-4710"><a href="#cb168-4710" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-4711"><a href="#cb168-4711" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir tabla formateada con kableExtra</span></span>
<span id="cb168-4712"><a href="#cb168-4712" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(tabla_metricas_ada, <span class="at">caption =</span> <span class="st">"Cross Validation Metrics"</span>, <span class="at">align =</span> <span class="st">"c"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb168-4713"><a href="#cb168-4713" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb168-4714"><a href="#cb168-4714" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-4715"><a href="#cb168-4715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4716"><a href="#cb168-4716" aria-hidden="true" tabindex="-1"></a><span class="fu"># Metrics Plot</span></span>
<span id="cb168-4719"><a href="#cb168-4719" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-4720"><a href="#cb168-4720" aria-hidden="true" tabindex="-1"></a><span class="fu">crear_plot_metricas_per_fold</span>(tabla_metricas_ada)</span>
<span id="cb168-4721"><a href="#cb168-4721" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4722"><a href="#cb168-4722" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-4723"><a href="#cb168-4723" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4724"><a href="#cb168-4724" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb168-4725"><a href="#cb168-4725" aria-hidden="true" tabindex="-1"></a>The performance is good but not the best and it is so instable.</span>
<span id="cb168-4726"><a href="#cb168-4726" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb168-4727"><a href="#cb168-4727" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb168-4728"><a href="#cb168-4728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4729"><a href="#cb168-4729" aria-hidden="true" tabindex="-1"></a><span class="fu"># Models Comparison {#models-comparison}</span></span>
<span id="cb168-4730"><a href="#cb168-4730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4731"><a href="#cb168-4731" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset style="background-color: #f0f0f0;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;"}</span>
<span id="cb168-4732"><a href="#cb168-4732" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb168-4733"><a href="#cb168-4733" aria-hidden="true" tabindex="-1"></a><span class="fu">## Metrics Comparison</span></span>
<span id="cb168-4734"><a href="#cb168-4734" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4735"><a href="#cb168-4735" aria-hidden="true" tabindex="-1"></a>For the comparison of the models, we are going to plot the metrics of each model in a bar plot. Specifically, we are going to compare the AUC, Accuracy, and Recall metrics of the best variables selected for each model.</span>
<span id="cb168-4738"><a href="#cb168-4738" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-4739"><a href="#cb168-4739" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb168-4740"><a href="#cb168-4740" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4741"><a href="#cb168-4741" aria-hidden="true" tabindex="-1"></a>crear_comparacion_metricas <span class="ot">&lt;-</span> <span class="cf">function</span>(lista_tablas_metricas, nombres_tablas) {</span>
<span id="cb168-4742"><a href="#cb168-4742" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Verificar que la longitud de la lista de tablas y los nombres coincida</span></span>
<span id="cb168-4743"><a href="#cb168-4743" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(lista_tablas_metricas) <span class="sc">!=</span> <span class="fu">length</span>(nombres_tablas)) {</span>
<span id="cb168-4744"><a href="#cb168-4744" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"La cantidad de tablas y de nombres debe ser la misma."</span>)</span>
<span id="cb168-4745"><a href="#cb168-4745" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb168-4746"><a href="#cb168-4746" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-4747"><a href="#cb168-4747" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Añadir una columna con el nombre del modelo a cada tabla y combinarlas</span></span>
<span id="cb168-4748"><a href="#cb168-4748" aria-hidden="true" tabindex="-1"></a>  lista_tablas_metricas <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">seq_along</span>(lista_tablas_metricas), <span class="cf">function</span>(i) {</span>
<span id="cb168-4749"><a href="#cb168-4749" aria-hidden="true" tabindex="-1"></a>    tabla <span class="ot">&lt;-</span> lista_tablas_metricas[[i]]</span>
<span id="cb168-4750"><a href="#cb168-4750" aria-hidden="true" tabindex="-1"></a>    tabla <span class="ot">&lt;-</span> tabla <span class="sc">%&gt;%</span></span>
<span id="cb168-4751"><a href="#cb168-4751" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(Pliegue <span class="sc">!=</span> <span class="st">"Mean"</span>) <span class="sc">%&gt;%</span>  <span class="co"># Filtrar las filas de medias si no deseas incluirlas</span></span>
<span id="cb168-4752"><a href="#cb168-4752" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">Modelo =</span> nombres_tablas[i])</span>
<span id="cb168-4753"><a href="#cb168-4753" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convertir las columnas de métricas a numéricas</span></span>
<span id="cb168-4754"><a href="#cb168-4754" aria-hidden="true" tabindex="-1"></a>    tabla <span class="ot">&lt;-</span> tabla <span class="sc">%&gt;%</span></span>
<span id="cb168-4755"><a href="#cb168-4755" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(AUC, Accuracy, Recall), as.numeric))</span>
<span id="cb168-4756"><a href="#cb168-4756" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(tabla)</span>
<span id="cb168-4757"><a href="#cb168-4757" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb168-4758"><a href="#cb168-4758" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-4759"><a href="#cb168-4759" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Combinar todas las tablas en una sola</span></span>
<span id="cb168-4760"><a href="#cb168-4760" aria-hidden="true" tabindex="-1"></a>  tabla_metricas_combinada <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(lista_tablas_metricas)</span>
<span id="cb168-4761"><a href="#cb168-4761" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-4762"><a href="#cb168-4762" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Transformar la tabla a un formato largo</span></span>
<span id="cb168-4763"><a href="#cb168-4763" aria-hidden="true" tabindex="-1"></a>  tabla_metricas_long <span class="ot">&lt;-</span> <span class="fu">pivot_longer</span>(tabla_metricas_combinada, </span>
<span id="cb168-4764"><a href="#cb168-4764" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">cols =</span> <span class="fu">c</span>(AUC, Accuracy, Recall), </span>
<span id="cb168-4765"><a href="#cb168-4765" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">names_to =</span> <span class="st">"Metrica"</span>, </span>
<span id="cb168-4766"><a href="#cb168-4766" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">values_to =</span> <span class="st">"Valor"</span>)</span>
<span id="cb168-4767"><a href="#cb168-4767" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-4768"><a href="#cb168-4768" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Crear el gráfico</span></span>
<span id="cb168-4769"><a href="#cb168-4769" aria-hidden="true" tabindex="-1"></a>  plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(tabla_metricas_long, <span class="fu">aes</span>(<span class="at">x =</span> Modelo, <span class="at">y =</span> Valor, <span class="at">fill =</span> Metrica)) <span class="sc">+</span></span>
<span id="cb168-4770"><a href="#cb168-4770" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">position =</span> <span class="st">"dodge"</span>) <span class="sc">+</span></span>
<span id="cb168-4771"><a href="#cb168-4771" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Metrics comparison between models"</span>, <span class="at">x =</span> <span class="st">"Model"</span>, <span class="at">y =</span> <span class="st">"Value"</span>) <span class="sc">+</span></span>
<span id="cb168-4772"><a href="#cb168-4772" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb168-4773"><a href="#cb168-4773" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"AUC"</span> <span class="ot">=</span> <span class="st">"steelblue"</span>, <span class="st">"Accuracy"</span> <span class="ot">=</span> <span class="st">"lightblue"</span>, <span class="st">"Recall"</span> <span class="ot">=</span> <span class="st">"#3C5B6F"</span>), <span class="at">name =</span> <span class="st">"Metric"</span>) <span class="sc">+</span></span>
<span id="cb168-4774"><a href="#cb168-4774" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">color =</span> <span class="fu">rgb</span>(<span class="dv">226</span>, <span class="dv">231</span>, <span class="dv">236</span>, <span class="at">maxColorValue =</span> <span class="dv">255</span>), <span class="at">size =</span> <span class="fl">1.5</span>)) <span class="sc">+</span></span>
<span id="cb168-4775"><a href="#cb168-4775" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>))  <span class="co"># Ajustar el eje y de 0 a 1 y sin espacio adicional</span></span>
<span id="cb168-4776"><a href="#cb168-4776" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-4777"><a href="#cb168-4777" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(plot)</span>
<span id="cb168-4778"><a href="#cb168-4778" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb168-4779"><a href="#cb168-4779" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4780"><a href="#cb168-4780" aria-hidden="true" tabindex="-1"></a>lista_tablas_metricas <span class="ot">&lt;-</span> <span class="fu">list</span>(tabla_metricas_logistic_wrapper, tabla_metricas_nnet_wrapper,tabla_metricas_svm_filter,tabla_metricas_dtree_filter,tabla_metricas_random_forest,tabla_metricas_naive_wrapper,tabla_metricas_ada,tabla_metricas_knn)</span>
<span id="cb168-4781"><a href="#cb168-4781" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4782"><a href="#cb168-4782" aria-hidden="true" tabindex="-1"></a><span class="co"># Nombres de las tablas</span></span>
<span id="cb168-4783"><a href="#cb168-4783" aria-hidden="true" tabindex="-1"></a>nombres_tablas <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Logistic"</span>, <span class="st">"NN"</span>,<span class="st">"SVM"</span>, <span class="st">"D.Tree"</span>, <span class="st">"R.Forest"</span>, <span class="st">"N.Bayes"</span>,<span class="st">"AdaBoost"</span>,<span class="st">"KNN"</span>)</span>
<span id="cb168-4784"><a href="#cb168-4784" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4785"><a href="#cb168-4785" aria-hidden="true" tabindex="-1"></a><span class="co"># Llamar a la función</span></span>
<span id="cb168-4786"><a href="#cb168-4786" aria-hidden="true" tabindex="-1"></a>plot <span class="ot">&lt;-</span> <span class="fu">crear_comparacion_metricas</span>(lista_tablas_metricas, nombres_tablas)</span>
<span id="cb168-4787"><a href="#cb168-4787" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(plot)</span>
<span id="cb168-4788"><a href="#cb168-4788" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4789"><a href="#cb168-4789" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4790"><a href="#cb168-4790" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-4791"><a href="#cb168-4791" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4792"><a href="#cb168-4792" aria-hidden="true" tabindex="-1"></a><span class="fu">## Execution Time Comparison</span></span>
<span id="cb168-4793"><a href="#cb168-4793" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4794"><a href="#cb168-4794" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4797"><a href="#cb168-4797" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-4798"><a href="#cb168-4798" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear el vector de tiempos de entrenamiento</span></span>
<span id="cb168-4799"><a href="#cb168-4799" aria-hidden="true" tabindex="-1"></a>modelos_tiempos <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">Logistic =</span> execution_time_logistic_wrapper, </span>
<span id="cb168-4800"><a href="#cb168-4800" aria-hidden="true" tabindex="-1"></a>                     <span class="at">Neural_Network =</span> execution_time_nnet_wrapper,</span>
<span id="cb168-4801"><a href="#cb168-4801" aria-hidden="true" tabindex="-1"></a>                     <span class="at">Decision_Tree =</span> execution_time_dtree_filter,</span>
<span id="cb168-4802"><a href="#cb168-4802" aria-hidden="true" tabindex="-1"></a>                     <span class="at">Random_Forest =</span> execution_time_random_forest,</span>
<span id="cb168-4803"><a href="#cb168-4803" aria-hidden="true" tabindex="-1"></a>                     <span class="at">Naive_Bayes =</span> execution_time_naive_wrapper,</span>
<span id="cb168-4804"><a href="#cb168-4804" aria-hidden="true" tabindex="-1"></a>                     <span class="at">SVM =</span> execution_time_svm_filter,</span>
<span id="cb168-4805"><a href="#cb168-4805" aria-hidden="true" tabindex="-1"></a>                     <span class="at">AdaBoost =</span> execution_time_ada,</span>
<span id="cb168-4806"><a href="#cb168-4806" aria-hidden="true" tabindex="-1"></a>                     <span class="at">KNN =</span> execution_time_knn)</span>
<span id="cb168-4807"><a href="#cb168-4807" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4808"><a href="#cb168-4808" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4809"><a href="#cb168-4809" aria-hidden="true" tabindex="-1"></a><span class="co"># Definir la función para comparar tiempos de entrenamiento</span></span>
<span id="cb168-4810"><a href="#cb168-4810" aria-hidden="true" tabindex="-1"></a>comparar_tiempos_entrenamiento <span class="ot">&lt;-</span> <span class="cf">function</span>(modelos_tiempos) {</span>
<span id="cb168-4811"><a href="#cb168-4811" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Verificar que los tiempos estén en un vector numérico</span></span>
<span id="cb168-4812"><a href="#cb168-4812" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.numeric</span>(modelos_tiempos)) {</span>
<span id="cb168-4813"><a href="#cb168-4813" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Los tiempos de entrenamiento deben ser un vector numérico."</span>)</span>
<span id="cb168-4814"><a href="#cb168-4814" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb168-4815"><a href="#cb168-4815" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-4816"><a href="#cb168-4816" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Crear un dataframe con los nombres de los modelos y sus tiempos de entrenamiento</span></span>
<span id="cb168-4817"><a href="#cb168-4817" aria-hidden="true" tabindex="-1"></a>  modelos_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb168-4818"><a href="#cb168-4818" aria-hidden="true" tabindex="-1"></a>    <span class="at">modelo =</span> <span class="fu">names</span>(modelos_tiempos),</span>
<span id="cb168-4819"><a href="#cb168-4819" aria-hidden="true" tabindex="-1"></a>    <span class="at">tiempo =</span> modelos_tiempos</span>
<span id="cb168-4820"><a href="#cb168-4820" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb168-4821"><a href="#cb168-4821" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-4822"><a href="#cb168-4822" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ordenar el dataframe por tiempo de entrenamiento</span></span>
<span id="cb168-4823"><a href="#cb168-4823" aria-hidden="true" tabindex="-1"></a>  modelos_df <span class="ot">&lt;-</span> modelos_df[<span class="fu">order</span>(modelos_df<span class="sc">$</span>tiempo, <span class="at">decreasing =</span> <span class="cn">TRUE</span>), ]</span>
<span id="cb168-4824"><a href="#cb168-4824" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-4825"><a href="#cb168-4825" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Crear el gráfico de barras con etiquetas de texto dentro de cada barra</span></span>
<span id="cb168-4826"><a href="#cb168-4826" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(modelos_df, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(modelo, tiempo), <span class="at">y =</span> tiempo, <span class="at">fill =</span> tiempo)) <span class="sc">+</span></span>
<span id="cb168-4827"><a href="#cb168-4827" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb168-4828"><a href="#cb168-4828" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">round</span>(tiempo, <span class="dv">1</span>)), <span class="at">hjust =</span> <span class="fl">1.2</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span> <span class="co"># Ajustar etiquetas dentro de las barras</span></span>
<span id="cb168-4829"><a href="#cb168-4829" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_flip</span>() <span class="sc">+</span> <span class="co"># Girar el gráfico para que los modelos se vean en el eje y</span></span>
<span id="cb168-4830"><a href="#cb168-4830" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_gradientn</span>(<span class="at">colors =</span> <span class="fu">c</span>(<span class="st">"lightblue"</span>, <span class="st">"steelblue"</span>, <span class="st">"#3C5B6F"</span>,<span class="st">"purple"</span>)) <span class="sc">+</span> <span class="co"># Gradiente de azul a rojo pasando por naranja</span></span>
<span id="cb168-4831"><a href="#cb168-4831" aria-hidden="true" tabindex="-1"></a>        <span class="fu">labs</span>(</span>
<span id="cb168-4832"><a href="#cb168-4832" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Execution Time Comparison between Models"</span>,</span>
<span id="cb168-4833"><a href="#cb168-4833" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Models"</span>,</span>
<span id="cb168-4834"><a href="#cb168-4834" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Execution time (seconds)"</span></span>
<span id="cb168-4835"><a href="#cb168-4835" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb168-4836"><a href="#cb168-4836" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb168-4837"><a href="#cb168-4837" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)) <span class="sc">+</span><span class="co"># Centrar el título</span></span>
<span id="cb168-4838"><a href="#cb168-4838" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">color =</span> <span class="fu">rgb</span>(<span class="dv">226</span>, <span class="dv">231</span>, <span class="dv">236</span>, <span class="at">maxColorValue =</span> <span class="dv">255</span>), <span class="at">size =</span> <span class="fl">1.5</span>)) </span>
<span id="cb168-4839"><a href="#cb168-4839" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4840"><a href="#cb168-4840" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb168-4841"><a href="#cb168-4841" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4842"><a href="#cb168-4842" aria-hidden="true" tabindex="-1"></a><span class="co"># Usar la función para comparar los tiempos de entrenamiento</span></span>
<span id="cb168-4843"><a href="#cb168-4843" aria-hidden="true" tabindex="-1"></a><span class="fu">comparar_tiempos_entrenamiento</span>(modelos_tiempos)</span>
<span id="cb168-4844"><a href="#cb168-4844" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4845"><a href="#cb168-4845" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-4846"><a href="#cb168-4846" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4847"><a href="#cb168-4847" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb168-4848"><a href="#cb168-4848" aria-hidden="true" tabindex="-1"></a>Results show that the best model for this problem is the naive bayes model. It has high AUC, accuracy and recall. Also, it is very stable regarding the hyperparameters. We can trust that the performance of the model is going to be very similar in the future.</span>
<span id="cb168-4849"><a href="#cb168-4849" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4850"><a href="#cb168-4850" aria-hidden="true" tabindex="-1"></a><span class="fu"># Final Model {#final-model}</span></span>
<span id="cb168-4851"><a href="#cb168-4851" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4852"><a href="#cb168-4852" aria-hidden="true" tabindex="-1"></a>The objetive of this section is to find the best hyperparameters and variable combiantion for the naive bayes model. The hyperparameter that we are going to tune is the Laplace smoothing, a technique used to avoid zero probabilities in the model. We are not going to tune the usekernel hyperparameter because our variables are not normally distributed(the function of usekernel is to asume that the variables are normally distributed or not).</span>
<span id="cb168-4853"><a href="#cb168-4853" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4854"><a href="#cb168-4854" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4855"><a href="#cb168-4855" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4856"><a href="#cb168-4856" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset style="background-color: #f0f0f0;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;"}</span>
<span id="cb168-4857"><a href="#cb168-4857" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4858"><a href="#cb168-4858" aria-hidden="true" tabindex="-1"></a><span class="fu">## Best Hyperparameters</span></span>
<span id="cb168-4861"><a href="#cb168-4861" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-4862"><a href="#cb168-4862" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb168-4863"><a href="#cb168-4863" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4864"><a href="#cb168-4864" aria-hidden="true" tabindex="-1"></a><span class="co"># Dividir el conjunto de datos en entrenamiento y test</span></span>
<span id="cb168-4865"><a href="#cb168-4865" aria-hidden="true" tabindex="-1"></a>indices_entrenamiento <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(data), <span class="fl">0.75</span> <span class="sc">*</span> <span class="fu">nrow</span>(data))  <span class="co"># 75% para entrenamiento</span></span>
<span id="cb168-4866"><a href="#cb168-4866" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento <span class="ot">&lt;-</span> data[indices_entrenamiento, ]</span>
<span id="cb168-4867"><a href="#cb168-4867" aria-hidden="true" tabindex="-1"></a>datos_test <span class="ot">&lt;-</span> data[<span class="sc">-</span>indices_entrenamiento, ]</span>
<span id="cb168-4868"><a href="#cb168-4868" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4869"><a href="#cb168-4869" aria-hidden="true" tabindex="-1"></a><span class="co"># Dividir datos de entrenamiento en entrenamiento y validación</span></span>
<span id="cb168-4870"><a href="#cb168-4870" aria-hidden="true" tabindex="-1"></a>train_indices <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(datos_entrenamiento), <span class="fl">0.8</span> <span class="sc">*</span> <span class="fu">nrow</span>(datos_entrenamiento))  <span class="co"># 80% para entrenamiento</span></span>
<span id="cb168-4871"><a href="#cb168-4871" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento_split <span class="ot">&lt;-</span> datos_entrenamiento[train_indices, ]</span>
<span id="cb168-4872"><a href="#cb168-4872" aria-hidden="true" tabindex="-1"></a>datos_validacion <span class="ot">&lt;-</span> datos_entrenamiento[<span class="sc">-</span>train_indices, ]</span>
<span id="cb168-4873"><a href="#cb168-4873" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4874"><a href="#cb168-4874" aria-hidden="true" tabindex="-1"></a><span class="co"># Oversampling</span></span>
<span id="cb168-4875"><a href="#cb168-4875" aria-hidden="true" tabindex="-1"></a>proportion <span class="ot">&lt;-</span> <span class="fl">0.28</span></span>
<span id="cb168-4876"><a href="#cb168-4876" aria-hidden="true" tabindex="-1"></a>datos_entrenamiento_oversampled <span class="ot">&lt;-</span> <span class="fu">ROSE</span>(ESTADO_ACTUAL <span class="sc">~</span> ., <span class="at">data =</span> datos_entrenamiento_split, <span class="at">p =</span> proportion)<span class="sc">$</span>data</span>
<span id="cb168-4877"><a href="#cb168-4877" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4878"><a href="#cb168-4878" aria-hidden="true" tabindex="-1"></a><span class="co"># Inicializar variables para almacenar los resultados</span></span>
<span id="cb168-4879"><a href="#cb168-4879" aria-hidden="true" tabindex="-1"></a>mejor_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb168-4880"><a href="#cb168-4880" aria-hidden="true" tabindex="-1"></a>mejor_modelo <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb168-4881"><a href="#cb168-4881" aria-hidden="true" tabindex="-1"></a>resultados <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">fL =</span> <span class="fu">numeric</span>(), <span class="at">auc =</span> <span class="fu">numeric</span>(), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb168-4882"><a href="#cb168-4882" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4883"><a href="#cb168-4883" aria-hidden="true" tabindex="-1"></a><span class="co"># Definir hiperparámetros a probar</span></span>
<span id="cb168-4884"><a href="#cb168-4884" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">fL =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>))</span>
<span id="cb168-4885"><a href="#cb168-4885" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4886"><a href="#cb168-4886" aria-hidden="true" tabindex="-1"></a><span class="co"># Bucle para probar diferentes combinaciones de hiperparámetros</span></span>
<span id="cb168-4887"><a href="#cb168-4887" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(params)) {</span>
<span id="cb168-4888"><a href="#cb168-4888" aria-hidden="true" tabindex="-1"></a>  fL <span class="ot">&lt;-</span> params<span class="sc">$</span>fL[i]</span>
<span id="cb168-4889"><a href="#cb168-4889" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-4890"><a href="#cb168-4890" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-4891"><a href="#cb168-4891" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Entrenar el modelo Naive Bayes con la combinación de hiperparámetros actual</span></span>
<span id="cb168-4892"><a href="#cb168-4892" aria-hidden="true" tabindex="-1"></a>  modelo <span class="ot">&lt;-</span> <span class="fu">naiveBayes</span>(ESTADO_ACTUAL <span class="sc">~</span> ., <span class="at">data =</span> datos_entrenamiento_oversampled, <span class="at">fL =</span> fL)</span>
<span id="cb168-4893"><a href="#cb168-4893" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-4894"><a href="#cb168-4894" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Realizar predicciones en datos de prueba</span></span>
<span id="cb168-4895"><a href="#cb168-4895" aria-hidden="true" tabindex="-1"></a>  predicciones_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelo, <span class="at">newdata =</span> datos_test, <span class="at">type =</span> <span class="st">"raw"</span>)</span>
<span id="cb168-4896"><a href="#cb168-4896" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-4897"><a href="#cb168-4897" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular AUC para la combinación actual en datos de prueba</span></span>
<span id="cb168-4898"><a href="#cb168-4898" aria-hidden="true" tabindex="-1"></a>  roc_obj <span class="ot">&lt;-</span> <span class="fu">roc</span>(<span class="fu">ifelse</span>(datos_test<span class="sc">$</span>ESTADO_ACTUAL <span class="sc">==</span> <span class="st">"SI"</span>, <span class="dv">1</span>, <span class="dv">0</span>), predicciones_test[, <span class="dv">2</span>])</span>
<span id="cb168-4899"><a href="#cb168-4899" aria-hidden="true" tabindex="-1"></a>  auc_actual <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">auc</span>(roc_obj))  <span class="co"># Extraer el valor numérico del AUC</span></span>
<span id="cb168-4900"><a href="#cb168-4900" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-4901"><a href="#cb168-4901" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Guardar los resultados en la tabla</span></span>
<span id="cb168-4902"><a href="#cb168-4902" aria-hidden="true" tabindex="-1"></a>  resultados <span class="ot">&lt;-</span> resultados <span class="sc">%&gt;%</span></span>
<span id="cb168-4903"><a href="#cb168-4903" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_row</span>(<span class="at">fL =</span> fL, <span class="at">auc =</span> auc_actual)</span>
<span id="cb168-4904"><a href="#cb168-4904" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-4905"><a href="#cb168-4905" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Actualizar el mejor modelo y su AUC si se encuentra un modelo mejor</span></span>
<span id="cb168-4906"><a href="#cb168-4906" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (auc_actual <span class="sc">&gt;</span> mejor_auc) {</span>
<span id="cb168-4907"><a href="#cb168-4907" aria-hidden="true" tabindex="-1"></a>    mejor_auc <span class="ot">&lt;-</span> auc_actual</span>
<span id="cb168-4908"><a href="#cb168-4908" aria-hidden="true" tabindex="-1"></a>    mejor_modelo <span class="ot">&lt;-</span> modelo</span>
<span id="cb168-4909"><a href="#cb168-4909" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb168-4910"><a href="#cb168-4910" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb168-4911"><a href="#cb168-4911" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4912"><a href="#cb168-4912" aria-hidden="true" tabindex="-1"></a><span class="co"># Ordenar los resultados por AUC en orden descendente</span></span>
<span id="cb168-4913"><a href="#cb168-4913" aria-hidden="true" tabindex="-1"></a>resultados_ordenados_nb <span class="ot">&lt;-</span> resultados <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(<span class="fu">desc</span>(auc))</span>
<span id="cb168-4914"><a href="#cb168-4914" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4915"><a href="#cb168-4915" aria-hidden="true" tabindex="-1"></a><span class="co"># Mostrar la tabla con los resultados de todas las combinaciones de hiperparámetros</span></span>
<span id="cb168-4916"><a href="#cb168-4916" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(resultados_ordenados_nb, <span class="at">file =</span> <span class="st">"resultados_ordenados_nb.RData"</span>)</span>
<span id="cb168-4917"><a href="#cb168-4917" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4918"><a href="#cb168-4918" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb168-4919"><a href="#cb168-4919" aria-hidden="true" tabindex="-1"></a><span class="co"># Cargar los datos guardados y mostrar las tablas</span></span>
<span id="cb168-4920"><a href="#cb168-4920" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"resultados_ordenados_nb.RData"</span>)</span>
<span id="cb168-4921"><a href="#cb168-4921" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4922"><a href="#cb168-4922" aria-hidden="true" tabindex="-1"></a><span class="co"># Seleccionar los mejores 10 modelos</span></span>
<span id="cb168-4923"><a href="#cb168-4923" aria-hidden="true" tabindex="-1"></a>mejores_10 <span class="ot">&lt;-</span> resultados_ordenados_nb <span class="sc">%&gt;%</span> <span class="fu">head</span>(<span class="dv">10</span>)</span>
<span id="cb168-4924"><a href="#cb168-4924" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4925"><a href="#cb168-4925" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4926"><a href="#cb168-4926" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir los mejores y peores modelos en tablas bonitas</span></span>
<span id="cb168-4927"><a href="#cb168-4927" aria-hidden="true" tabindex="-1"></a>mejores_10 <span class="sc">%&gt;%</span></span>
<span id="cb168-4928"><a href="#cb168-4928" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">caption =</span> <span class="st">"Top 10 Models by AUC"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb168-4929"><a href="#cb168-4929" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>, <span class="st">"condensed"</span>, <span class="st">"responsive"</span>))</span>
<span id="cb168-4930"><a href="#cb168-4930" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4931"><a href="#cb168-4931" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4932"><a href="#cb168-4932" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-4933"><a href="#cb168-4933" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4934"><a href="#cb168-4934" aria-hidden="true" tabindex="-1"></a><span class="fu">## Visualization</span></span>
<span id="cb168-4937"><a href="#cb168-4937" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-4938"><a href="#cb168-4938" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mejores_10, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(fL), <span class="at">y =</span> auc)) <span class="sc">+</span></span>
<span id="cb168-4939"><a href="#cb168-4939" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">fill =</span> <span class="st">"#3C5B6F"</span>) <span class="sc">+</span></span>
<span id="cb168-4940"><a href="#cb168-4940" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"AUC for each Laplace smoothing value"</span>,</span>
<span id="cb168-4941"><a href="#cb168-4941" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"fL"</span>,</span>
<span id="cb168-4942"><a href="#cb168-4942" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"AUC"</span>) <span class="sc">+</span></span>
<span id="cb168-4943"><a href="#cb168-4943" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="dv">1</span>) <span class="sc">+</span>             <span class="co"># Establecer el límite del eje y</span></span>
<span id="cb168-4944"><a href="#cb168-4944" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() </span>
<span id="cb168-4945"><a href="#cb168-4945" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-4946"><a href="#cb168-4946" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb168-4947"><a href="#cb168-4947" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4948"><a href="#cb168-4948" aria-hidden="true" tabindex="-1"></a>There is no difference between the hyperparameters because Laplace smoothing is only necessary when the data is very sparse. </span>
<span id="cb168-4949"><a href="#cb168-4949" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4950"><a href="#cb168-4950" aria-hidden="true" tabindex="-1"></a><span class="fu">## Variable Selection for the Final Model</span></span>
<span id="cb168-4951"><a href="#cb168-4951" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4952"><a href="#cb168-4952" aria-hidden="true" tabindex="-1"></a>The objetive of this section is to find the best variables for the final model. We are going to obtain the performance of every combination of variables in a repeated hold out and then we are going to select variables that are more frequent in the combinations with high AUC(threshold of 0.75).</span>
<span id="cb168-4953"><a href="#cb168-4953" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4954"><a href="#cb168-4954" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset style="background-color: #f0f0f0;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;"}</span>
<span id="cb168-4955"><a href="#cb168-4955" aria-hidden="true" tabindex="-1"></a><span class="fu">### Variables cominations and auc</span></span>
<span id="cb168-4956"><a href="#cb168-4956" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,results='asis',warning=FALSE,message=FALSE, eval=FALSE}</span></span>
<span id="cb168-4957"><a href="#cb168-4957" aria-hidden="true" tabindex="-1"></a><span class="in">library(caret)</span></span>
<span id="cb168-4958"><a href="#cb168-4958" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4959"><a href="#cb168-4959" aria-hidden="true" tabindex="-1"></a><span class="in"># Definir el número de repeticiones para el repeated holdout</span></span>
<span id="cb168-4960"><a href="#cb168-4960" aria-hidden="true" tabindex="-1"></a><span class="in">n_repeats &lt;- 50</span></span>
<span id="cb168-4961"><a href="#cb168-4961" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4962"><a href="#cb168-4962" aria-hidden="true" tabindex="-1"></a><span class="in"># Crear particiones de datos</span></span>
<span id="cb168-4963"><a href="#cb168-4963" aria-hidden="true" tabindex="-1"></a><span class="in">index &lt;- createDataPartition(data$ESTADO_ACTUAL, times = n_repeats, p = 0.75, list = TRUE)</span></span>
<span id="cb168-4964"><a href="#cb168-4964" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4965"><a href="#cb168-4965" aria-hidden="true" tabindex="-1"></a><span class="in"># Inicializar variables para almacenar los resultados</span></span>
<span id="cb168-4966"><a href="#cb168-4966" aria-hidden="true" tabindex="-1"></a><span class="in">resultados &lt;- data.frame(Variables = character(), auc = numeric(), stringsAsFactors = FALSE)</span></span>
<span id="cb168-4967"><a href="#cb168-4967" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4968"><a href="#cb168-4968" aria-hidden="true" tabindex="-1"></a><span class="in">start_time &lt;- Sys.time()</span></span>
<span id="cb168-4969"><a href="#cb168-4969" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4970"><a href="#cb168-4970" aria-hidden="true" tabindex="-1"></a><span class="in">for (r in seq_along(index)) {</span></span>
<span id="cb168-4971"><a href="#cb168-4971" aria-hidden="true" tabindex="-1"></a><span class="in">  # Obtener índices de entrenamiento y prueba para esta repetición</span></span>
<span id="cb168-4972"><a href="#cb168-4972" aria-hidden="true" tabindex="-1"></a><span class="in">  train_indices &lt;- unlist(index[-r])</span></span>
<span id="cb168-4973"><a href="#cb168-4973" aria-hidden="true" tabindex="-1"></a><span class="in">  test_indices &lt;- index[[r]]</span></span>
<span id="cb168-4974"><a href="#cb168-4974" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4975"><a href="#cb168-4975" aria-hidden="true" tabindex="-1"></a><span class="in">  # Dividir el conjunto de datos en entrenamiento y test</span></span>
<span id="cb168-4976"><a href="#cb168-4976" aria-hidden="true" tabindex="-1"></a><span class="in">  datos_entrenamiento &lt;- data[train_indices, ]</span></span>
<span id="cb168-4977"><a href="#cb168-4977" aria-hidden="true" tabindex="-1"></a><span class="in">  datos_test &lt;- data[test_indices, ]</span></span>
<span id="cb168-4978"><a href="#cb168-4978" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4979"><a href="#cb168-4979" aria-hidden="true" tabindex="-1"></a><span class="in">  # Oversampling</span></span>
<span id="cb168-4980"><a href="#cb168-4980" aria-hidden="true" tabindex="-1"></a><span class="in">  proportion &lt;- 0.28</span></span>
<span id="cb168-4981"><a href="#cb168-4981" aria-hidden="true" tabindex="-1"></a><span class="in">  datos_entrenamiento_oversampled &lt;- ROSE(ESTADO_ACTUAL ~ ., data = datos_entrenamiento, p = proportion)$data</span></span>
<span id="cb168-4982"><a href="#cb168-4982" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4983"><a href="#cb168-4983" aria-hidden="true" tabindex="-1"></a><span class="in">  for (comb in combinaciones_variables) {</span></span>
<span id="cb168-4984"><a href="#cb168-4984" aria-hidden="true" tabindex="-1"></a><span class="in">    # Entrenar el modelo Naive Bayes con la combinación de variables actual</span></span>
<span id="cb168-4985"><a href="#cb168-4985" aria-hidden="true" tabindex="-1"></a><span class="in">    modelo &lt;- naiveBayes(ESTADO_ACTUAL ~ ., data = datos_entrenamiento_oversampled[, c(comb, "ESTADO_ACTUAL")])</span></span>
<span id="cb168-4986"><a href="#cb168-4986" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4987"><a href="#cb168-4987" aria-hidden="true" tabindex="-1"></a><span class="in">    # Realizar predicciones en datos de prueba</span></span>
<span id="cb168-4988"><a href="#cb168-4988" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_test &lt;- predict(modelo, newdata = datos_test, type = "raw")</span></span>
<span id="cb168-4989"><a href="#cb168-4989" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4990"><a href="#cb168-4990" aria-hidden="true" tabindex="-1"></a><span class="in">    # Calcular AUC para la combinación actual en datos de prueba</span></span>
<span id="cb168-4991"><a href="#cb168-4991" aria-hidden="true" tabindex="-1"></a><span class="in">    roc_obj &lt;- roc(ifelse(datos_test$ESTADO_ACTUAL == "SI", 1, 0), predicciones_test[, 2])</span></span>
<span id="cb168-4992"><a href="#cb168-4992" aria-hidden="true" tabindex="-1"></a><span class="in">    auc_actual &lt;- as.numeric(auc(roc_obj))  # Extraer el valor numérico del AUC</span></span>
<span id="cb168-4993"><a href="#cb168-4993" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4994"><a href="#cb168-4994" aria-hidden="true" tabindex="-1"></a><span class="in">    # Convertir la combinación en una cadena única</span></span>
<span id="cb168-4995"><a href="#cb168-4995" aria-hidden="true" tabindex="-1"></a><span class="in">    comb_str &lt;- paste(comb, collapse = ",")</span></span>
<span id="cb168-4996"><a href="#cb168-4996" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4997"><a href="#cb168-4997" aria-hidden="true" tabindex="-1"></a><span class="in">    # Guardar los resultados en la tabla</span></span>
<span id="cb168-4998"><a href="#cb168-4998" aria-hidden="true" tabindex="-1"></a><span class="in">    resultados &lt;- resultados %&gt;%</span></span>
<span id="cb168-4999"><a href="#cb168-4999" aria-hidden="true" tabindex="-1"></a><span class="in">      add_row(Variables = comb_str, auc = auc_actual)</span></span>
<span id="cb168-5000"><a href="#cb168-5000" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb168-5001"><a href="#cb168-5001" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb168-5002"><a href="#cb168-5002" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5003"><a href="#cb168-5003" aria-hidden="true" tabindex="-1"></a><span class="in"># Calcular el AUC promedio para cada combinación de variables</span></span>
<span id="cb168-5004"><a href="#cb168-5004" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_promedio &lt;- resultados %&gt;%</span></span>
<span id="cb168-5005"><a href="#cb168-5005" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(Variables) %&gt;%</span></span>
<span id="cb168-5006"><a href="#cb168-5006" aria-hidden="true" tabindex="-1"></a><span class="in">  summarise(auc_promedio = mean(auc))</span></span>
<span id="cb168-5007"><a href="#cb168-5007" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5008"><a href="#cb168-5008" aria-hidden="true" tabindex="-1"></a><span class="in"># Ordenar los resultados por AUC promedio en orden descendente</span></span>
<span id="cb168-5009"><a href="#cb168-5009" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_ordenados_variables &lt;- resultados_promedio %&gt;% arrange(desc(auc_promedio))</span></span>
<span id="cb168-5010"><a href="#cb168-5010" aria-hidden="true" tabindex="-1"></a><span class="in">save(resultados_ordenados_variables, file = "resultados_ordenados_variables.RData")</span></span>
<span id="cb168-5011"><a href="#cb168-5011" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5012"><a href="#cb168-5012" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5013"><a href="#cb168-5013" aria-hidden="true" tabindex="-1"></a><span class="in">end_time &lt;- Sys.time()</span></span>
<span id="cb168-5014"><a href="#cb168-5014" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time &lt;- end_time - start_time</span></span>
<span id="cb168-5015"><a href="#cb168-5015" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5016"><a href="#cb168-5016" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time_30 &lt;- as.numeric(execution_time, units = "secs")</span></span>
<span id="cb168-5017"><a href="#cb168-5017" aria-hidden="true" tabindex="-1"></a><span class="in">save(execution_time_30, file = "execution_time_30.RData")</span></span>
<span id="cb168-5018"><a href="#cb168-5018" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5019"><a href="#cb168-5019" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-5020"><a href="#cb168-5020" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5021"><a href="#cb168-5021" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5022"><a href="#cb168-5022" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5023"><a href="#cb168-5023" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,results='asis'}</span></span>
<span id="cb168-5024"><a href="#cb168-5024" aria-hidden="true" tabindex="-1"></a><span class="in">load("resultados_ordenados_variables.RData")</span></span>
<span id="cb168-5025"><a href="#cb168-5025" aria-hidden="true" tabindex="-1"></a><span class="in">load("execution_time_30.RData")</span></span>
<span id="cb168-5026"><a href="#cb168-5026" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5027"><a href="#cb168-5027" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5028"><a href="#cb168-5028" aria-hidden="true" tabindex="-1"></a><span class="in"># Mostrar la tabla con los resultados de todas las combinaciones de variables</span></span>
<span id="cb168-5029"><a href="#cb168-5029" aria-hidden="true" tabindex="-1"></a><span class="in">tabla &lt;- kable(resultados_ordenados_variables, format = "html", align = "ccc", caption = "Tabla de Resultados", row.names = FALSE, booktabs = TRUE) %&gt;%</span></span>
<span id="cb168-5030"><a href="#cb168-5030" aria-hidden="true" tabindex="-1"></a><span class="in">  kable_styling(bootstrap_options = "striped")</span></span>
<span id="cb168-5031"><a href="#cb168-5031" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5032"><a href="#cb168-5032" aria-hidden="true" tabindex="-1"></a><span class="in"># Mostrar la tabla con scroll</span></span>
<span id="cb168-5033"><a href="#cb168-5033" aria-hidden="true" tabindex="-1"></a><span class="in">tabla_con_scroll &lt;- scroll_box(tabla, width = "100%", height = "400px")</span></span>
<span id="cb168-5034"><a href="#cb168-5034" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5035"><a href="#cb168-5035" aria-hidden="true" tabindex="-1"></a><span class="in"># Mostrar la tabla</span></span>
<span id="cb168-5036"><a href="#cb168-5036" aria-hidden="true" tabindex="-1"></a><span class="in">print(tabla_con_scroll)</span></span>
<span id="cb168-5037"><a href="#cb168-5037" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5038"><a href="#cb168-5038" aria-hidden="true" tabindex="-1"></a><span class="in">end_time &lt;- Sys.time()</span></span>
<span id="cb168-5039"><a href="#cb168-5039" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5040"><a href="#cb168-5040" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-5041"><a href="#cb168-5041" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5042"><a href="#cb168-5042" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5043"><a href="#cb168-5043" aria-hidden="true" tabindex="-1"></a><span class="fu">### Variable frequency in better combinations </span></span>
<span id="cb168-5046"><a href="#cb168-5046" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-5047"><a href="#cb168-5047" aria-hidden="true" tabindex="-1"></a><span class="co"># Definir el umbral para el AUC</span></span>
<span id="cb168-5048"><a href="#cb168-5048" aria-hidden="true" tabindex="-1"></a>umbral_auc <span class="ot">&lt;-</span> <span class="fl">0.75</span></span>
<span id="cb168-5049"><a href="#cb168-5049" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5050"><a href="#cb168-5050" aria-hidden="true" tabindex="-1"></a><span class="co"># Filtrar combinaciones con AUC mayor que el umbral</span></span>
<span id="cb168-5051"><a href="#cb168-5051" aria-hidden="true" tabindex="-1"></a>combinaciones_altas <span class="ot">&lt;-</span> resultados_ordenados_variables[resultados_ordenados_variables<span class="sc">$</span>auc_promedio <span class="sc">&gt;</span> umbral_auc, ]</span>
<span id="cb168-5052"><a href="#cb168-5052" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5053"><a href="#cb168-5053" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear un vector para almacenar las variables individuales</span></span>
<span id="cb168-5054"><a href="#cb168-5054" aria-hidden="true" tabindex="-1"></a>variables_individuales <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">strsplit</span>(combinaciones_altas<span class="sc">$</span>Variables, <span class="st">","</span>))</span>
<span id="cb168-5055"><a href="#cb168-5055" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5056"><a href="#cb168-5056" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular la frecuencia de cada variable</span></span>
<span id="cb168-5057"><a href="#cb168-5057" aria-hidden="true" tabindex="-1"></a>frecuencia_variables <span class="ot">&lt;-</span> <span class="fu">table</span>(variables_individuales)</span>
<span id="cb168-5058"><a href="#cb168-5058" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5059"><a href="#cb168-5059" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear la tabla de frecuencia de variables</span></span>
<span id="cb168-5060"><a href="#cb168-5060" aria-hidden="true" tabindex="-1"></a>tabla_frecuencia_variables <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Variable =</span> <span class="fu">names</span>(frecuencia_variables), <span class="at">Frecuencia =</span> <span class="fu">as.numeric</span>(frecuencia_variables))</span>
<span id="cb168-5061"><a href="#cb168-5061" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5062"><a href="#cb168-5062" aria-hidden="true" tabindex="-1"></a><span class="co"># Ordenar la tabla por frecuencia en orden descendente</span></span>
<span id="cb168-5063"><a href="#cb168-5063" aria-hidden="true" tabindex="-1"></a>tabla_frecuencia_variables <span class="ot">&lt;-</span> tabla_frecuencia_variables[<span class="fu">order</span>(<span class="sc">-</span>tabla_frecuencia_variables<span class="sc">$</span>Frecuencia), ]</span>
<span id="cb168-5064"><a href="#cb168-5064" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5065"><a href="#cb168-5065" aria-hidden="true" tabindex="-1"></a><span class="co"># Mostrar la tabla de frecuencia de variables</span></span>
<span id="cb168-5066"><a href="#cb168-5066" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(tabla_frecuencia_variables, <span class="at">format =</span> <span class="st">"html"</span>, <span class="at">align =</span> <span class="st">"ccc"</span>, <span class="at">caption =</span> <span class="st">"Variable Frequency in Best Combinations"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>, <span class="at">booktabs =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb168-5067"><a href="#cb168-5067" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="st">"striped"</span>)</span>
<span id="cb168-5068"><a href="#cb168-5068" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5069"><a href="#cb168-5069" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5070"><a href="#cb168-5070" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5071"><a href="#cb168-5071" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5072"><a href="#cb168-5072" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-5073"><a href="#cb168-5073" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb168-5074"><a href="#cb168-5074" aria-hidden="true" tabindex="-1"></a>The variables that are more frequent in the best combinations are ESTADO_ACTUAL, REst, Fenotipo, Grado and Edad. We are going to use these variables for the final model.</span>
<span id="cb168-5075"><a href="#cb168-5075" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5076"><a href="#cb168-5076" aria-hidden="true" tabindex="-1"></a><span class="fu">## Final model</span></span>
<span id="cb168-5077"><a href="#cb168-5077" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5078"><a href="#cb168-5078" aria-hidden="true" tabindex="-1"></a>Final model summary:</span>
<span id="cb168-5081"><a href="#cb168-5081" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-5082"><a href="#cb168-5082" aria-hidden="true" tabindex="-1"></a><span class="co"># Modelo para producción</span></span>
<span id="cb168-5083"><a href="#cb168-5083" aria-hidden="true" tabindex="-1"></a>datafinal <span class="ot">&lt;-</span> data[<span class="fu">c</span>(<span class="st">"ESTADO_ACTUAL"</span>, <span class="st">"REst"</span>, <span class="st">"Fenotipo"</span>, <span class="st">"Grado"</span>, <span class="st">"Edad"</span>)]</span>
<span id="cb168-5084"><a href="#cb168-5084" aria-hidden="true" tabindex="-1"></a>modelo_final <span class="ot">&lt;-</span> <span class="fu">naiveBayes</span>(ESTADO_ACTUAL <span class="sc">~</span> ., <span class="at">data =</span> datafinal)</span>
<span id="cb168-5085"><a href="#cb168-5085" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(modelo_final, <span class="at">file =</span> <span class="st">"modelo_final.RData"</span>)</span>
<span id="cb168-5086"><a href="#cb168-5086" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(modelo_final)</span>
<span id="cb168-5087"><a href="#cb168-5087" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5088"><a href="#cb168-5088" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5089"><a href="#cb168-5089" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-5090"><a href="#cb168-5090" aria-hidden="true" tabindex="-1"></a><span class="fu">## Cross validation comparation</span></span>
<span id="cb168-5091"><a href="#cb168-5091" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5092"><a href="#cb168-5092" aria-hidden="true" tabindex="-1"></a>The objetive of this section is to validate the final model with a cross validation.</span>
<span id="cb168-5093"><a href="#cb168-5093" aria-hidden="true" tabindex="-1"></a>We are going to compare different numbers of folds in the cross validation to see how this can affect the performance of the model.</span>
<span id="cb168-5094"><a href="#cb168-5094" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5095"><a href="#cb168-5095" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset style="background-color: #f0f0f0;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);border-radius: 5px;"}</span>
<span id="cb168-5096"><a href="#cb168-5096" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5097"><a href="#cb168-5097" aria-hidden="true" tabindex="-1"></a><span class="fu">### 5x2 Cross Validation</span></span>
<span id="cb168-5098"><a href="#cb168-5098" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=FALSE,message=FALSE, eval=FALSE}</span></span>
<span id="cb168-5099"><a href="#cb168-5099" aria-hidden="true" tabindex="-1"></a><span class="in"># Iniciar tiempo de ejecución</span></span>
<span id="cb168-5100"><a href="#cb168-5100" aria-hidden="true" tabindex="-1"></a><span class="in">start_time &lt;- Sys.time()</span></span>
<span id="cb168-5101"><a href="#cb168-5101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5102"><a href="#cb168-5102" aria-hidden="true" tabindex="-1"></a><span class="in"># Parámetros a cambiar</span></span>
<span id="cb168-5103"><a href="#cb168-5103" aria-hidden="true" tabindex="-1"></a><span class="in">proportion &lt;- 0.28</span></span>
<span id="cb168-5104"><a href="#cb168-5104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5105"><a href="#cb168-5105" aria-hidden="true" tabindex="-1"></a><span class="in"># Configurar la validación cruzada 5x2</span></span>
<span id="cb168-5106"><a href="#cb168-5106" aria-hidden="true" tabindex="-1"></a><span class="in">k_outer &lt;- 5  # Número de pliegues externos</span></span>
<span id="cb168-5107"><a href="#cb168-5107" aria-hidden="true" tabindex="-1"></a><span class="in">k_inner &lt;- 2  # Número de pliegues internos</span></span>
<span id="cb168-5108"><a href="#cb168-5108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5109"><a href="#cb168-5109" aria-hidden="true" tabindex="-1"></a><span class="in"># Lista para almacenar resultados</span></span>
<span id="cb168-5110"><a href="#cb168-5110" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_auc &lt;- numeric(k_outer)</span></span>
<span id="cb168-5111"><a href="#cb168-5111" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_accuracy &lt;- numeric(k_outer)</span></span>
<span id="cb168-5112"><a href="#cb168-5112" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_sensibilidad &lt;- numeric(k_outer)</span></span>
<span id="cb168-5113"><a href="#cb168-5113" aria-hidden="true" tabindex="-1"></a><span class="in">indices &lt;- 1:nrow(data)</span></span>
<span id="cb168-5114"><a href="#cb168-5114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5115"><a href="#cb168-5115" aria-hidden="true" tabindex="-1"></a><span class="in"># Inicializar matrices para almacenar predicciones y objetivos</span></span>
<span id="cb168-5116"><a href="#cb168-5116" aria-hidden="true" tabindex="-1"></a><span class="in">predicciones_totales &lt;- matrix(NA, nrow = nrow(data), ncol = k_outer)</span></span>
<span id="cb168-5117"><a href="#cb168-5117" aria-hidden="true" tabindex="-1"></a><span class="in">targets_totales &lt;- numeric(nrow(data))</span></span>
<span id="cb168-5118"><a href="#cb168-5118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5119"><a href="#cb168-5119" aria-hidden="true" tabindex="-1"></a><span class="in"># Iterar sobre cada pliegue externo y realizar el proceso de modelado</span></span>
<span id="cb168-5120"><a href="#cb168-5120" aria-hidden="true" tabindex="-1"></a><span class="in">for (i_outer in 1:k_outer) {</span></span>
<span id="cb168-5121"><a href="#cb168-5121" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-5122"><a href="#cb168-5122" aria-hidden="true" tabindex="-1"></a><span class="in">  # Obtener los índices para el pliegue externo actual</span></span>
<span id="cb168-5123"><a href="#cb168-5123" aria-hidden="true" tabindex="-1"></a><span class="in">  test_indices_outer &lt;- indices[folds_outer == i_outer]  # Índices correspondientes al pliegue externo de test</span></span>
<span id="cb168-5124"><a href="#cb168-5124" aria-hidden="true" tabindex="-1"></a><span class="in">  train_indices_outer &lt;- setdiff(1:nrow(data), test_indices_outer)  # Índices correspondientes al conjunto de entrenamiento</span></span>
<span id="cb168-5125"><a href="#cb168-5125" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-5126"><a href="#cb168-5126" aria-hidden="true" tabindex="-1"></a><span class="in">  # Dividir datos en entrenamiento y test para el pliegue externo</span></span>
<span id="cb168-5127"><a href="#cb168-5127" aria-hidden="true" tabindex="-1"></a><span class="in">  datos_entrenamiento_outer &lt;- datafinal[train_indices_outer, ]</span></span>
<span id="cb168-5128"><a href="#cb168-5128" aria-hidden="true" tabindex="-1"></a><span class="in">  datos_test_outer &lt;- datafinal[test_indices_outer, ]</span></span>
<span id="cb168-5129"><a href="#cb168-5129" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-5130"><a href="#cb168-5130" aria-hidden="true" tabindex="-1"></a><span class="in">  # Configurar la validación cruzada interna</span></span>
<span id="cb168-5131"><a href="#cb168-5131" aria-hidden="true" tabindex="-1"></a><span class="in">  folds_inner &lt;- createFolds(datos_entrenamiento_outer$ESTADO_ACTUAL, k = k_inner, list = FALSE)  # Obtener índices de pliegues internos</span></span>
<span id="cb168-5132"><a href="#cb168-5132" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-5133"><a href="#cb168-5133" aria-hidden="true" tabindex="-1"></a><span class="in">  # Almacenar predicciones y objetivos para el AUC general</span></span>
<span id="cb168-5134"><a href="#cb168-5134" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_auc &lt;- numeric(nrow(datos_entrenamiento_outer))</span></span>
<span id="cb168-5135"><a href="#cb168-5135" aria-hidden="true" tabindex="-1"></a><span class="in">  targets_auc &lt;- numeric(nrow(datos_entrenamiento_outer))</span></span>
<span id="cb168-5136"><a href="#cb168-5136" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-5137"><a href="#cb168-5137" aria-hidden="true" tabindex="-1"></a><span class="in">  # Inicializar variables para almacenar resultados internos</span></span>
<span id="cb168-5138"><a href="#cb168-5138" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_auc_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-5139"><a href="#cb168-5139" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_accuracy_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-5140"><a href="#cb168-5140" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_sensibilidad_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-5141"><a href="#cb168-5141" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-5142"><a href="#cb168-5142" aria-hidden="true" tabindex="-1"></a><span class="in">  # Iterar sobre cada pliegue interno para selección de modelo</span></span>
<span id="cb168-5143"><a href="#cb168-5143" aria-hidden="true" tabindex="-1"></a><span class="in">  indices_inner &lt;- 1:nrow(datos_entrenamiento_outer)</span></span>
<span id="cb168-5144"><a href="#cb168-5144" aria-hidden="true" tabindex="-1"></a><span class="in">  for (i_inner in 1:k_inner) {</span></span>
<span id="cb168-5145"><a href="#cb168-5145" aria-hidden="true" tabindex="-1"></a><span class="in">    # Obtener los índices para el pliegue interno actual</span></span>
<span id="cb168-5146"><a href="#cb168-5146" aria-hidden="true" tabindex="-1"></a><span class="in">    test_indices_inner &lt;- indices_inner[folds_inner == i_inner]  # Índices correspondientes al pliegue interno de test</span></span>
<span id="cb168-5147"><a href="#cb168-5147" aria-hidden="true" tabindex="-1"></a><span class="in">    train_indices_inner &lt;- setdiff(1:nrow(datos_entrenamiento_outer), test_indices_inner)  # Índices correspondientes al conjunto de entrenamiento interno</span></span>
<span id="cb168-5148"><a href="#cb168-5148" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5149"><a href="#cb168-5149" aria-hidden="true" tabindex="-1"></a><span class="in">    # Dividir datos en entrenamiento y test para el pliegue interno</span></span>
<span id="cb168-5150"><a href="#cb168-5150" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_entrenamiento_inner &lt;- datos_entrenamiento_outer[train_indices_inner, ]</span></span>
<span id="cb168-5151"><a href="#cb168-5151" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_validacion &lt;- datos_entrenamiento_outer[test_indices_inner, ]</span></span>
<span id="cb168-5152"><a href="#cb168-5152" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5153"><a href="#cb168-5153" aria-hidden="true" tabindex="-1"></a><span class="in">    # Almacenar predicciones y objetivos para el AUC interno</span></span>
<span id="cb168-5154"><a href="#cb168-5154" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_auc &lt;- numeric(nrow(datos_validacion))</span></span>
<span id="cb168-5155"><a href="#cb168-5155" aria-hidden="true" tabindex="-1"></a><span class="in">    targets_auc &lt;- numeric(nrow(datos_validacion))</span></span>
<span id="cb168-5156"><a href="#cb168-5156" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5157"><a href="#cb168-5157" aria-hidden="true" tabindex="-1"></a><span class="in">    # Definir todas las combinaciones de variables (sustituye esto por tus combinaciones reales)</span></span>
<span id="cb168-5158"><a href="#cb168-5158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5159"><a href="#cb168-5159" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5160"><a href="#cb168-5160" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5161"><a href="#cb168-5161" aria-hidden="true" tabindex="-1"></a><span class="in">    # Aplicar oversampling en el conjunto de entrenamiento interno</span></span>
<span id="cb168-5162"><a href="#cb168-5162" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_entrenamiento_oversampled &lt;- ROSE(ESTADO_ACTUAL ~ ., data = datos_entrenamiento_inner, p = proportion)$data</span></span>
<span id="cb168-5163"><a href="#cb168-5163" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5164"><a href="#cb168-5164" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5165"><a href="#cb168-5165" aria-hidden="true" tabindex="-1"></a><span class="in">    # Entrenar el modelo Naive Bayes</span></span>
<span id="cb168-5166"><a href="#cb168-5166" aria-hidden="true" tabindex="-1"></a><span class="in">    modelo &lt;- naiveBayes(ESTADO_ACTUAL ~ ., data = datos_entrenamiento_oversampled)</span></span>
<span id="cb168-5167"><a href="#cb168-5167" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5168"><a href="#cb168-5168" aria-hidden="true" tabindex="-1"></a><span class="in">    # Realizar predicciones con probabilidades en datos de validación</span></span>
<span id="cb168-5169"><a href="#cb168-5169" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_validacion_prob &lt;- predict(modelo, newdata = datos_validacion, type = "raw")[,2]</span></span>
<span id="cb168-5170"><a href="#cb168-5170" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5171"><a href="#cb168-5171" aria-hidden="true" tabindex="-1"></a><span class="in">    # Calcular el AUC</span></span>
<span id="cb168-5172"><a href="#cb168-5172" aria-hidden="true" tabindex="-1"></a><span class="in">    roc_obj &lt;- roc(datos_validacion$ESTADO_ACTUAL, predicciones_validacion_prob, levels = rev(levels(datos_validacion$ESTADO_ACTUAL)))</span></span>
<span id="cb168-5173"><a href="#cb168-5173" aria-hidden="true" tabindex="-1"></a><span class="in">    auc_actual &lt;- auc(roc_obj)</span></span>
<span id="cb168-5174"><a href="#cb168-5174" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5175"><a href="#cb168-5175" aria-hidden="true" tabindex="-1"></a><span class="in">    # Almacenar las predicciones y objetivos</span></span>
<span id="cb168-5176"><a href="#cb168-5176" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_auc[test_indices_inner] &lt;- predicciones_validacion_prob</span></span>
<span id="cb168-5177"><a href="#cb168-5177" aria-hidden="true" tabindex="-1"></a><span class="in">    targets_auc[test_indices_inner] &lt;- as.numeric(datos_validacion$ESTADO_ACTUAL) - 1</span></span>
<span id="cb168-5178"><a href="#cb168-5178" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5179"><a href="#cb168-5179" aria-hidden="true" tabindex="-1"></a><span class="in">    # Calcular la sensibilidad y la precisión</span></span>
<span id="cb168-5180"><a href="#cb168-5180" aria-hidden="true" tabindex="-1"></a><span class="in">    umbral &lt;- 0.5</span></span>
<span id="cb168-5181"><a href="#cb168-5181" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_finales &lt;- ifelse(predicciones_validacion_prob &gt;= umbral, "SI", "NO")</span></span>
<span id="cb168-5182"><a href="#cb168-5182" aria-hidden="true" tabindex="-1"></a><span class="in">    TP &lt;- sum(predicciones_finales == "SI" &amp; datos_validacion$ESTADO_ACTUAL == "SI")</span></span>
<span id="cb168-5183"><a href="#cb168-5183" aria-hidden="true" tabindex="-1"></a><span class="in">    FN &lt;- sum(predicciones_finales == "NO" &amp; datos_validacion$ESTADO_ACTUAL == "SI")</span></span>
<span id="cb168-5184"><a href="#cb168-5184" aria-hidden="true" tabindex="-1"></a><span class="in">    FP &lt;- sum(predicciones_finales == "SI" &amp; datos_validacion$ESTADO_ACTUAL == "NO")</span></span>
<span id="cb168-5185"><a href="#cb168-5185" aria-hidden="true" tabindex="-1"></a><span class="in">    TN &lt;- sum(predicciones_finales == "NO" &amp; datos_validacion$ESTADO_ACTUAL == "NO")</span></span>
<span id="cb168-5186"><a href="#cb168-5186" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5187"><a href="#cb168-5187" aria-hidden="true" tabindex="-1"></a><span class="in">    recall_actual &lt;- TP / (TP + FN)</span></span>
<span id="cb168-5188"><a href="#cb168-5188" aria-hidden="true" tabindex="-1"></a><span class="in">    accuracy_actual &lt;- (TP + TN) / (TP + FN + FP + TN)</span></span>
<span id="cb168-5189"><a href="#cb168-5189" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5190"><a href="#cb168-5190" aria-hidden="true" tabindex="-1"></a><span class="in">    # Almacenar resultados internos</span></span>
<span id="cb168-5191"><a href="#cb168-5191" aria-hidden="true" tabindex="-1"></a><span class="in">    resultados_sensibilidad_inner[i_inner] &lt;- recall_actual</span></span>
<span id="cb168-5192"><a href="#cb168-5192" aria-hidden="true" tabindex="-1"></a><span class="in">    resultados_accuracy_inner[i_inner] &lt;- accuracy_actual</span></span>
<span id="cb168-5193"><a href="#cb168-5193" aria-hidden="true" tabindex="-1"></a><span class="in">    resultados_auc_inner[i_inner] &lt;- auc_actual</span></span>
<span id="cb168-5194"><a href="#cb168-5194" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-5195"><a href="#cb168-5195" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb168-5196"><a href="#cb168-5196" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-5197"><a href="#cb168-5197" aria-hidden="true" tabindex="-1"></a><span class="in">  # Calcular el AUC final para este pliegue externo</span></span>
<span id="cb168-5198"><a href="#cb168-5198" aria-hidden="true" tabindex="-1"></a><span class="in">  auc_fold_externo &lt;- mean(resultados_auc_inner)</span></span>
<span id="cb168-5199"><a href="#cb168-5199" aria-hidden="true" tabindex="-1"></a><span class="in">  accuracy_fold_externo &lt;- mean(resultados_accuracy_inner)</span></span>
<span id="cb168-5200"><a href="#cb168-5200" aria-hidden="true" tabindex="-1"></a><span class="in">  sensibilidad_fold_externo &lt;- mean(resultados_sensibilidad_inner)</span></span>
<span id="cb168-5201"><a href="#cb168-5201" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-5202"><a href="#cb168-5202" aria-hidden="true" tabindex="-1"></a><span class="in">  # Almacenar el AUC del fold externo actual</span></span>
<span id="cb168-5203"><a href="#cb168-5203" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_auc[i_outer] &lt;- auc_fold_externo</span></span>
<span id="cb168-5204"><a href="#cb168-5204" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_accuracy[i_outer] &lt;- accuracy_fold_externo</span></span>
<span id="cb168-5205"><a href="#cb168-5205" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_sensibilidad[i_outer] &lt;- sensibilidad_fold_externo</span></span>
<span id="cb168-5206"><a href="#cb168-5206" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-5207"><a href="#cb168-5207" aria-hidden="true" tabindex="-1"></a><span class="in">  # Predecir en los datos de test para este pliegue externo y almacenar predicciones</span></span>
<span id="cb168-5208"><a href="#cb168-5208" aria-hidden="true" tabindex="-1"></a><span class="in">  # (Aquí deberías hacer la predicción usando el mejor modelo encontrado en el bucle interno)</span></span>
<span id="cb168-5209"><a href="#cb168-5209" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb168-5210"><a href="#cb168-5210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5211"><a href="#cb168-5211" aria-hidden="true" tabindex="-1"></a><span class="in"># Calcular AUC promedio</span></span>
<span id="cb168-5212"><a href="#cb168-5212" aria-hidden="true" tabindex="-1"></a><span class="in">auc_promedio &lt;- mean(resultados_auc)</span></span>
<span id="cb168-5213"><a href="#cb168-5213" aria-hidden="true" tabindex="-1"></a><span class="in">accuracy_promedio &lt;- mean(resultados_accuracy)</span></span>
<span id="cb168-5214"><a href="#cb168-5214" aria-hidden="true" tabindex="-1"></a><span class="in">sensibilidad_promedio &lt;- mean(resultados_sensibilidad)</span></span>
<span id="cb168-5215"><a href="#cb168-5215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5216"><a href="#cb168-5216" aria-hidden="true" tabindex="-1"></a><span class="in">tabla_metricas &lt;- data.frame(</span></span>
<span id="cb168-5217"><a href="#cb168-5217" aria-hidden="true" tabindex="-1"></a><span class="in">  Pliegue = 1:k_outer,</span></span>
<span id="cb168-5218"><a href="#cb168-5218" aria-hidden="true" tabindex="-1"></a><span class="in">  AUC = sapply(resultados_auc, round, digits = 3),</span></span>
<span id="cb168-5219"><a href="#cb168-5219" aria-hidden="true" tabindex="-1"></a><span class="in">  Accuracy = sapply(resultados_accuracy, round, digits = 3),</span></span>
<span id="cb168-5220"><a href="#cb168-5220" aria-hidden="true" tabindex="-1"></a><span class="in">  Recall = sapply(resultados_sensibilidad, round, digits = 3)</span></span>
<span id="cb168-5221"><a href="#cb168-5221" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb168-5222"><a href="#cb168-5222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5223"><a href="#cb168-5223" aria-hidden="true" tabindex="-1"></a><span class="in"># Agregar fila con promedio de métricas</span></span>
<span id="cb168-5224"><a href="#cb168-5224" aria-hidden="true" tabindex="-1"></a><span class="in">tabla_metricas_naive_52 &lt;- rbind(tabla_metricas, c("Mean", round(auc_promedio, 3), round(accuracy_promedio, 3), round(sensibilidad_promedio, 3)))</span></span>
<span id="cb168-5225"><a href="#cb168-5225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5226"><a href="#cb168-5226" aria-hidden="true" tabindex="-1"></a><span class="in"># Detener el tiempo de ejecución</span></span>
<span id="cb168-5227"><a href="#cb168-5227" aria-hidden="true" tabindex="-1"></a><span class="in">end_time &lt;- Sys.time()</span></span>
<span id="cb168-5228"><a href="#cb168-5228" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time_naive &lt;- end_time - start_time</span></span>
<span id="cb168-5229"><a href="#cb168-5229" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time_naive52 &lt;- as.numeric(execution_time_naive, units = "secs")</span></span>
<span id="cb168-5230"><a href="#cb168-5230" aria-hidden="true" tabindex="-1"></a><span class="in">save(tabla_metricas_naive_52, file = "tabla_metricas_naive_52.RData")</span></span>
<span id="cb168-5231"><a href="#cb168-5231" aria-hidden="true" tabindex="-1"></a><span class="in">save(execution_time_naive52, file = "execution_time_naive_filter52.RData")</span></span>
<span id="cb168-5232"><a href="#cb168-5232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5233"><a href="#cb168-5233" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-5234"><a href="#cb168-5234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5237"><a href="#cb168-5237" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-5238"><a href="#cb168-5238" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"tabla_metricas_naive_52.RData"</span>)</span>
<span id="cb168-5239"><a href="#cb168-5239" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"execution_time_naive_filter52.RData"</span>)</span>
<span id="cb168-5240"><a href="#cb168-5240" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir el tiempo de ejecución</span></span>
<span id="cb168-5241"><a href="#cb168-5241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5242"><a href="#cb168-5242" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time_naive52,  <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb168-5243"><a href="#cb168-5243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5244"><a href="#cb168-5244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5245"><a href="#cb168-5245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5246"><a href="#cb168-5246" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-5247"><a href="#cb168-5247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5248"><a href="#cb168-5248" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb168-5249"><a href="#cb168-5249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5250"><a href="#cb168-5250" aria-hidden="true" tabindex="-1"></a><span class="fu"># Metrics Table</span></span>
<span id="cb168-5253"><a href="#cb168-5253" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-5254"><a href="#cb168-5254" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir tabla formateada con kableExtra</span></span>
<span id="cb168-5255"><a href="#cb168-5255" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(tabla_metricas_naive_52, <span class="at">caption =</span> <span class="st">"Cross Validation Metrics"</span>, <span class="at">align =</span> <span class="st">"c"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb168-5256"><a href="#cb168-5256" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb168-5257"><a href="#cb168-5257" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-5258"><a href="#cb168-5258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5259"><a href="#cb168-5259" aria-hidden="true" tabindex="-1"></a><span class="fu"># Metrics Plot</span></span>
<span id="cb168-5262"><a href="#cb168-5262" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-5263"><a href="#cb168-5263" aria-hidden="true" tabindex="-1"></a><span class="fu">crear_plot_metricas_per_fold</span>(tabla_metricas_naive_52)</span>
<span id="cb168-5264"><a href="#cb168-5264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5265"><a href="#cb168-5265" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-5266"><a href="#cb168-5266" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb168-5267"><a href="#cb168-5267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5268"><a href="#cb168-5268" aria-hidden="true" tabindex="-1"></a><span class="fu">### 10x2 Cross Validation</span></span>
<span id="cb168-5269"><a href="#cb168-5269" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=FALSE,message=FALSE, eval=FALSE}</span></span>
<span id="cb168-5270"><a href="#cb168-5270" aria-hidden="true" tabindex="-1"></a><span class="in"># Iniciar tiempo de ejecución</span></span>
<span id="cb168-5271"><a href="#cb168-5271" aria-hidden="true" tabindex="-1"></a><span class="in">start_time &lt;- Sys.time()</span></span>
<span id="cb168-5272"><a href="#cb168-5272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5273"><a href="#cb168-5273" aria-hidden="true" tabindex="-1"></a><span class="in"># Parámetros a cambiar</span></span>
<span id="cb168-5274"><a href="#cb168-5274" aria-hidden="true" tabindex="-1"></a><span class="in">proportion &lt;- 0.28</span></span>
<span id="cb168-5275"><a href="#cb168-5275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5276"><a href="#cb168-5276" aria-hidden="true" tabindex="-1"></a><span class="in"># Configurar la validación cruzada 5x2</span></span>
<span id="cb168-5277"><a href="#cb168-5277" aria-hidden="true" tabindex="-1"></a><span class="in">k_outer &lt;- 10  # Número de pliegues externos</span></span>
<span id="cb168-5278"><a href="#cb168-5278" aria-hidden="true" tabindex="-1"></a><span class="in">k_inner &lt;- 2  # Número de pliegues internos</span></span>
<span id="cb168-5279"><a href="#cb168-5279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5280"><a href="#cb168-5280" aria-hidden="true" tabindex="-1"></a><span class="in"># Lista para almacenar resultados</span></span>
<span id="cb168-5281"><a href="#cb168-5281" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_auc &lt;- numeric(k_outer)</span></span>
<span id="cb168-5282"><a href="#cb168-5282" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_accuracy &lt;- numeric(k_outer)</span></span>
<span id="cb168-5283"><a href="#cb168-5283" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_sensibilidad &lt;- numeric(k_outer)</span></span>
<span id="cb168-5284"><a href="#cb168-5284" aria-hidden="true" tabindex="-1"></a><span class="in">indices &lt;- 1:nrow(data)</span></span>
<span id="cb168-5285"><a href="#cb168-5285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5286"><a href="#cb168-5286" aria-hidden="true" tabindex="-1"></a><span class="in"># Inicializar matrices para almacenar predicciones y objetivos</span></span>
<span id="cb168-5287"><a href="#cb168-5287" aria-hidden="true" tabindex="-1"></a><span class="in">predicciones_totales &lt;- matrix(NA, nrow = nrow(data), ncol = k_outer)</span></span>
<span id="cb168-5288"><a href="#cb168-5288" aria-hidden="true" tabindex="-1"></a><span class="in">targets_totales &lt;- numeric(nrow(data))</span></span>
<span id="cb168-5289"><a href="#cb168-5289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5290"><a href="#cb168-5290" aria-hidden="true" tabindex="-1"></a><span class="in"># Iterar sobre cada pliegue externo y realizar el proceso de modelado</span></span>
<span id="cb168-5291"><a href="#cb168-5291" aria-hidden="true" tabindex="-1"></a><span class="in">for (i_outer in 1:k_outer) {</span></span>
<span id="cb168-5292"><a href="#cb168-5292" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-5293"><a href="#cb168-5293" aria-hidden="true" tabindex="-1"></a><span class="in">  # Obtener los índices para el pliegue externo actual</span></span>
<span id="cb168-5294"><a href="#cb168-5294" aria-hidden="true" tabindex="-1"></a><span class="in">  test_indices_outer &lt;- indices[folds_outer == i_outer]  # Índices correspondientes al pliegue externo de test</span></span>
<span id="cb168-5295"><a href="#cb168-5295" aria-hidden="true" tabindex="-1"></a><span class="in">  train_indices_outer &lt;- setdiff(1:nrow(data), test_indices_outer)  # Índices correspondientes al conjunto de entrenamiento</span></span>
<span id="cb168-5296"><a href="#cb168-5296" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-5297"><a href="#cb168-5297" aria-hidden="true" tabindex="-1"></a><span class="in">  # Dividir datos en entrenamiento y test para el pliegue externo</span></span>
<span id="cb168-5298"><a href="#cb168-5298" aria-hidden="true" tabindex="-1"></a><span class="in">  datos_entrenamiento_outer &lt;- datafinal[train_indices_outer, ]</span></span>
<span id="cb168-5299"><a href="#cb168-5299" aria-hidden="true" tabindex="-1"></a><span class="in">  datos_test_outer &lt;- datafinal[test_indices_outer, ]</span></span>
<span id="cb168-5300"><a href="#cb168-5300" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-5301"><a href="#cb168-5301" aria-hidden="true" tabindex="-1"></a><span class="in">  # Configurar la validación cruzada interna</span></span>
<span id="cb168-5302"><a href="#cb168-5302" aria-hidden="true" tabindex="-1"></a><span class="in">  folds_inner &lt;- createFolds(datos_entrenamiento_outer$ESTADO_ACTUAL, k = k_inner, list = FALSE)  # Obtener índices de pliegues internos</span></span>
<span id="cb168-5303"><a href="#cb168-5303" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-5304"><a href="#cb168-5304" aria-hidden="true" tabindex="-1"></a><span class="in">  # Almacenar predicciones y objetivos para el AUC general</span></span>
<span id="cb168-5305"><a href="#cb168-5305" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_auc &lt;- numeric(nrow(datos_entrenamiento_outer))</span></span>
<span id="cb168-5306"><a href="#cb168-5306" aria-hidden="true" tabindex="-1"></a><span class="in">  targets_auc &lt;- numeric(nrow(datos_entrenamiento_outer))</span></span>
<span id="cb168-5307"><a href="#cb168-5307" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-5308"><a href="#cb168-5308" aria-hidden="true" tabindex="-1"></a><span class="in">  # Inicializar variables para almacenar resultados internos</span></span>
<span id="cb168-5309"><a href="#cb168-5309" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_auc_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-5310"><a href="#cb168-5310" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_accuracy_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-5311"><a href="#cb168-5311" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_sensibilidad_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-5312"><a href="#cb168-5312" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-5313"><a href="#cb168-5313" aria-hidden="true" tabindex="-1"></a><span class="in">  # Iterar sobre cada pliegue interno para selección de modelo</span></span>
<span id="cb168-5314"><a href="#cb168-5314" aria-hidden="true" tabindex="-1"></a><span class="in">  indices_inner &lt;- 1:nrow(datos_entrenamiento_outer)</span></span>
<span id="cb168-5315"><a href="#cb168-5315" aria-hidden="true" tabindex="-1"></a><span class="in">  for (i_inner in 1:k_inner) {</span></span>
<span id="cb168-5316"><a href="#cb168-5316" aria-hidden="true" tabindex="-1"></a><span class="in">    # Obtener los índices para el pliegue interno actual</span></span>
<span id="cb168-5317"><a href="#cb168-5317" aria-hidden="true" tabindex="-1"></a><span class="in">    test_indices_inner &lt;- indices_inner[folds_inner == i_inner]  # Índices correspondientes al pliegue interno de test</span></span>
<span id="cb168-5318"><a href="#cb168-5318" aria-hidden="true" tabindex="-1"></a><span class="in">    train_indices_inner &lt;- setdiff(1:nrow(datos_entrenamiento_outer), test_indices_inner)  # Índices correspondientes al conjunto de entrenamiento interno</span></span>
<span id="cb168-5319"><a href="#cb168-5319" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5320"><a href="#cb168-5320" aria-hidden="true" tabindex="-1"></a><span class="in">    # Dividir datos en entrenamiento y test para el pliegue interno</span></span>
<span id="cb168-5321"><a href="#cb168-5321" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_entrenamiento_inner &lt;- datos_entrenamiento_outer[train_indices_inner, ]</span></span>
<span id="cb168-5322"><a href="#cb168-5322" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_validacion &lt;- datos_entrenamiento_outer[test_indices_inner, ]</span></span>
<span id="cb168-5323"><a href="#cb168-5323" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5324"><a href="#cb168-5324" aria-hidden="true" tabindex="-1"></a><span class="in">    # Almacenar predicciones y objetivos para el AUC interno</span></span>
<span id="cb168-5325"><a href="#cb168-5325" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_auc &lt;- numeric(nrow(datos_validacion))</span></span>
<span id="cb168-5326"><a href="#cb168-5326" aria-hidden="true" tabindex="-1"></a><span class="in">    targets_auc &lt;- numeric(nrow(datos_validacion))</span></span>
<span id="cb168-5327"><a href="#cb168-5327" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5328"><a href="#cb168-5328" aria-hidden="true" tabindex="-1"></a><span class="in">    # Definir todas las combinaciones de variables (sustituye esto por tus combinaciones reales)</span></span>
<span id="cb168-5329"><a href="#cb168-5329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5330"><a href="#cb168-5330" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5331"><a href="#cb168-5331" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5332"><a href="#cb168-5332" aria-hidden="true" tabindex="-1"></a><span class="in">    # Aplicar oversampling en el conjunto de entrenamiento interno</span></span>
<span id="cb168-5333"><a href="#cb168-5333" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_entrenamiento_oversampled &lt;- ROSE(ESTADO_ACTUAL ~ ., data = datos_entrenamiento_inner, p = proportion)$data</span></span>
<span id="cb168-5334"><a href="#cb168-5334" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5335"><a href="#cb168-5335" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5336"><a href="#cb168-5336" aria-hidden="true" tabindex="-1"></a><span class="in">    # Entrenar el modelo Naive Bayes</span></span>
<span id="cb168-5337"><a href="#cb168-5337" aria-hidden="true" tabindex="-1"></a><span class="in">    modelo &lt;- naiveBayes(ESTADO_ACTUAL ~ ., data = datos_entrenamiento_oversampled)</span></span>
<span id="cb168-5338"><a href="#cb168-5338" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5339"><a href="#cb168-5339" aria-hidden="true" tabindex="-1"></a><span class="in">    # Realizar predicciones con probabilidades en datos de validación</span></span>
<span id="cb168-5340"><a href="#cb168-5340" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_validacion_prob &lt;- predict(modelo, newdata = datos_validacion, type = "raw")[,2]</span></span>
<span id="cb168-5341"><a href="#cb168-5341" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5342"><a href="#cb168-5342" aria-hidden="true" tabindex="-1"></a><span class="in">    # Calcular el AUC</span></span>
<span id="cb168-5343"><a href="#cb168-5343" aria-hidden="true" tabindex="-1"></a><span class="in">    roc_obj &lt;- roc(datos_validacion$ESTADO_ACTUAL, predicciones_validacion_prob, levels = rev(levels(datos_validacion$ESTADO_ACTUAL)))</span></span>
<span id="cb168-5344"><a href="#cb168-5344" aria-hidden="true" tabindex="-1"></a><span class="in">    auc_actual &lt;- auc(roc_obj)</span></span>
<span id="cb168-5345"><a href="#cb168-5345" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5346"><a href="#cb168-5346" aria-hidden="true" tabindex="-1"></a><span class="in">    # Almacenar las predicciones y objetivos</span></span>
<span id="cb168-5347"><a href="#cb168-5347" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_auc[test_indices_inner] &lt;- predicciones_validacion_prob</span></span>
<span id="cb168-5348"><a href="#cb168-5348" aria-hidden="true" tabindex="-1"></a><span class="in">    targets_auc[test_indices_inner] &lt;- as.numeric(datos_validacion$ESTADO_ACTUAL) - 1</span></span>
<span id="cb168-5349"><a href="#cb168-5349" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5350"><a href="#cb168-5350" aria-hidden="true" tabindex="-1"></a><span class="in">    # Calcular la sensibilidad y la precisión</span></span>
<span id="cb168-5351"><a href="#cb168-5351" aria-hidden="true" tabindex="-1"></a><span class="in">    umbral &lt;- 0.5</span></span>
<span id="cb168-5352"><a href="#cb168-5352" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_finales &lt;- ifelse(predicciones_validacion_prob &gt;= umbral, "SI", "NO")</span></span>
<span id="cb168-5353"><a href="#cb168-5353" aria-hidden="true" tabindex="-1"></a><span class="in">    TP &lt;- sum(predicciones_finales == "SI" &amp; datos_validacion$ESTADO_ACTUAL == "SI")</span></span>
<span id="cb168-5354"><a href="#cb168-5354" aria-hidden="true" tabindex="-1"></a><span class="in">    FN &lt;- sum(predicciones_finales == "NO" &amp; datos_validacion$ESTADO_ACTUAL == "SI")</span></span>
<span id="cb168-5355"><a href="#cb168-5355" aria-hidden="true" tabindex="-1"></a><span class="in">    FP &lt;- sum(predicciones_finales == "SI" &amp; datos_validacion$ESTADO_ACTUAL == "NO")</span></span>
<span id="cb168-5356"><a href="#cb168-5356" aria-hidden="true" tabindex="-1"></a><span class="in">    TN &lt;- sum(predicciones_finales == "NO" &amp; datos_validacion$ESTADO_ACTUAL == "NO")</span></span>
<span id="cb168-5357"><a href="#cb168-5357" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5358"><a href="#cb168-5358" aria-hidden="true" tabindex="-1"></a><span class="in">    recall_actual &lt;- TP / (TP + FN)</span></span>
<span id="cb168-5359"><a href="#cb168-5359" aria-hidden="true" tabindex="-1"></a><span class="in">    accuracy_actual &lt;- (TP + TN) / (TP + FN + FP + TN)</span></span>
<span id="cb168-5360"><a href="#cb168-5360" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5361"><a href="#cb168-5361" aria-hidden="true" tabindex="-1"></a><span class="in">    # Almacenar resultados internos</span></span>
<span id="cb168-5362"><a href="#cb168-5362" aria-hidden="true" tabindex="-1"></a><span class="in">    resultados_sensibilidad_inner[i_inner] &lt;- recall_actual</span></span>
<span id="cb168-5363"><a href="#cb168-5363" aria-hidden="true" tabindex="-1"></a><span class="in">    resultados_accuracy_inner[i_inner] &lt;- accuracy_actual</span></span>
<span id="cb168-5364"><a href="#cb168-5364" aria-hidden="true" tabindex="-1"></a><span class="in">    resultados_auc_inner[i_inner] &lt;- auc_actual</span></span>
<span id="cb168-5365"><a href="#cb168-5365" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-5366"><a href="#cb168-5366" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb168-5367"><a href="#cb168-5367" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-5368"><a href="#cb168-5368" aria-hidden="true" tabindex="-1"></a><span class="in">  # Calcular el AUC final para este pliegue externo</span></span>
<span id="cb168-5369"><a href="#cb168-5369" aria-hidden="true" tabindex="-1"></a><span class="in">  auc_fold_externo &lt;- mean(resultados_auc_inner)</span></span>
<span id="cb168-5370"><a href="#cb168-5370" aria-hidden="true" tabindex="-1"></a><span class="in">  accuracy_fold_externo &lt;- mean(resultados_accuracy_inner)</span></span>
<span id="cb168-5371"><a href="#cb168-5371" aria-hidden="true" tabindex="-1"></a><span class="in">  sensibilidad_fold_externo &lt;- mean(resultados_sensibilidad_inner)</span></span>
<span id="cb168-5372"><a href="#cb168-5372" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-5373"><a href="#cb168-5373" aria-hidden="true" tabindex="-1"></a><span class="in">  # Almacenar el AUC del fold externo actual</span></span>
<span id="cb168-5374"><a href="#cb168-5374" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_auc[i_outer] &lt;- auc_fold_externo</span></span>
<span id="cb168-5375"><a href="#cb168-5375" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_accuracy[i_outer] &lt;- accuracy_fold_externo</span></span>
<span id="cb168-5376"><a href="#cb168-5376" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_sensibilidad[i_outer] &lt;- sensibilidad_fold_externo</span></span>
<span id="cb168-5377"><a href="#cb168-5377" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-5378"><a href="#cb168-5378" aria-hidden="true" tabindex="-1"></a><span class="in">  # Predecir en los datos de test para este pliegue externo y almacenar predicciones</span></span>
<span id="cb168-5379"><a href="#cb168-5379" aria-hidden="true" tabindex="-1"></a><span class="in">  # (Aquí deberías hacer la predicción usando el mejor modelo encontrado en el bucle interno)</span></span>
<span id="cb168-5380"><a href="#cb168-5380" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb168-5381"><a href="#cb168-5381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5382"><a href="#cb168-5382" aria-hidden="true" tabindex="-1"></a><span class="in"># Calcular AUC promedio</span></span>
<span id="cb168-5383"><a href="#cb168-5383" aria-hidden="true" tabindex="-1"></a><span class="in">auc_promedio &lt;- mean(resultados_auc)</span></span>
<span id="cb168-5384"><a href="#cb168-5384" aria-hidden="true" tabindex="-1"></a><span class="in">accuracy_promedio &lt;- mean(resultados_accuracy)</span></span>
<span id="cb168-5385"><a href="#cb168-5385" aria-hidden="true" tabindex="-1"></a><span class="in">sensibilidad_promedio &lt;- mean(resultados_sensibilidad)</span></span>
<span id="cb168-5386"><a href="#cb168-5386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5387"><a href="#cb168-5387" aria-hidden="true" tabindex="-1"></a><span class="in">tabla_metricas &lt;- data.frame(</span></span>
<span id="cb168-5388"><a href="#cb168-5388" aria-hidden="true" tabindex="-1"></a><span class="in">  Pliegue = 1:k_outer,</span></span>
<span id="cb168-5389"><a href="#cb168-5389" aria-hidden="true" tabindex="-1"></a><span class="in">  AUC = sapply(resultados_auc, round, digits = 3),</span></span>
<span id="cb168-5390"><a href="#cb168-5390" aria-hidden="true" tabindex="-1"></a><span class="in">  Accuracy = sapply(resultados_accuracy, round, digits = 3),</span></span>
<span id="cb168-5391"><a href="#cb168-5391" aria-hidden="true" tabindex="-1"></a><span class="in">  Recall = sapply(resultados_sensibilidad, round, digits = 3)</span></span>
<span id="cb168-5392"><a href="#cb168-5392" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb168-5393"><a href="#cb168-5393" aria-hidden="true" tabindex="-1"></a><span class="in"># Agregar fila con promedio de métricas</span></span>
<span id="cb168-5394"><a href="#cb168-5394" aria-hidden="true" tabindex="-1"></a><span class="in">tabla_metricas_naive12 &lt;- rbind(tabla_metricas, c("Mean", round(auc_promedio, 3), round(accuracy_promedio, 3), round(sensibilidad_promedio, 3)))</span></span>
<span id="cb168-5395"><a href="#cb168-5395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5396"><a href="#cb168-5396" aria-hidden="true" tabindex="-1"></a><span class="in"># Detener el tiempo de ejecución</span></span>
<span id="cb168-5397"><a href="#cb168-5397" aria-hidden="true" tabindex="-1"></a><span class="in">end_time &lt;- Sys.time()</span></span>
<span id="cb168-5398"><a href="#cb168-5398" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time_naive &lt;- end_time - start_time</span></span>
<span id="cb168-5399"><a href="#cb168-5399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5400"><a href="#cb168-5400" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time_naive12 &lt;- as.numeric(execution_time_naive, units = "secs")</span></span>
<span id="cb168-5401"><a href="#cb168-5401" aria-hidden="true" tabindex="-1"></a><span class="in">save(tabla_metricas_naive12, file = "tabla_metricas_naive_filter12.RData")</span></span>
<span id="cb168-5402"><a href="#cb168-5402" aria-hidden="true" tabindex="-1"></a><span class="in">save(execution_time_naive12, file = "execution_time_naive_filter12.RData")</span></span>
<span id="cb168-5403"><a href="#cb168-5403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5404"><a href="#cb168-5404" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-5405"><a href="#cb168-5405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5408"><a href="#cb168-5408" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-5409"><a href="#cb168-5409" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"tabla_metricas_naive_filter12.RData"</span>)</span>
<span id="cb168-5410"><a href="#cb168-5410" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"execution_time_naive_filter12.RData"</span>)</span>
<span id="cb168-5411"><a href="#cb168-5411" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir el tiempo de ejecución</span></span>
<span id="cb168-5412"><a href="#cb168-5412" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time_naive12,  <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb168-5413"><a href="#cb168-5413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5414"><a href="#cb168-5414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5415"><a href="#cb168-5415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5416"><a href="#cb168-5416" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-5417"><a href="#cb168-5417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5418"><a href="#cb168-5418" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb168-5419"><a href="#cb168-5419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5420"><a href="#cb168-5420" aria-hidden="true" tabindex="-1"></a><span class="fu"># Metrics Table</span></span>
<span id="cb168-5423"><a href="#cb168-5423" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-5424"><a href="#cb168-5424" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir tabla formateada con kableExtra</span></span>
<span id="cb168-5425"><a href="#cb168-5425" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(tabla_metricas_naive12, <span class="at">caption =</span> <span class="st">"Cross Validation Metrics"</span>, <span class="at">align =</span> <span class="st">"c"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb168-5426"><a href="#cb168-5426" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb168-5427"><a href="#cb168-5427" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-5428"><a href="#cb168-5428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5429"><a href="#cb168-5429" aria-hidden="true" tabindex="-1"></a><span class="fu"># Metrics Plot</span></span>
<span id="cb168-5432"><a href="#cb168-5432" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-5433"><a href="#cb168-5433" aria-hidden="true" tabindex="-1"></a><span class="fu">crear_plot_metricas_per_fold</span>(tabla_metricas_naive12)</span>
<span id="cb168-5434"><a href="#cb168-5434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5435"><a href="#cb168-5435" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-5436"><a href="#cb168-5436" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb168-5437"><a href="#cb168-5437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5438"><a href="#cb168-5438" aria-hidden="true" tabindex="-1"></a><span class="fu">### 10x5 Cross Validation</span></span>
<span id="cb168-5439"><a href="#cb168-5439" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=FALSE,message=FALSE, eval=FALSE}</span></span>
<span id="cb168-5440"><a href="#cb168-5440" aria-hidden="true" tabindex="-1"></a><span class="in"># Iniciar tiempo de ejecución</span></span>
<span id="cb168-5441"><a href="#cb168-5441" aria-hidden="true" tabindex="-1"></a><span class="in">start_time &lt;- Sys.time()</span></span>
<span id="cb168-5442"><a href="#cb168-5442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5443"><a href="#cb168-5443" aria-hidden="true" tabindex="-1"></a><span class="in"># Parámetros a cambiar</span></span>
<span id="cb168-5444"><a href="#cb168-5444" aria-hidden="true" tabindex="-1"></a><span class="in">proportion &lt;- 0.28</span></span>
<span id="cb168-5445"><a href="#cb168-5445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5446"><a href="#cb168-5446" aria-hidden="true" tabindex="-1"></a><span class="in"># Configurar la validación cruzada 5x2</span></span>
<span id="cb168-5447"><a href="#cb168-5447" aria-hidden="true" tabindex="-1"></a><span class="in">k_outer &lt;- 10  # Número de pliegues externos</span></span>
<span id="cb168-5448"><a href="#cb168-5448" aria-hidden="true" tabindex="-1"></a><span class="in">k_inner &lt;- 5  # Número de pliegues internos</span></span>
<span id="cb168-5449"><a href="#cb168-5449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5450"><a href="#cb168-5450" aria-hidden="true" tabindex="-1"></a><span class="in"># Lista para almacenar resultados</span></span>
<span id="cb168-5451"><a href="#cb168-5451" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_auc &lt;- numeric(k_outer)</span></span>
<span id="cb168-5452"><a href="#cb168-5452" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_accuracy &lt;- numeric(k_outer)</span></span>
<span id="cb168-5453"><a href="#cb168-5453" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_sensibilidad &lt;- numeric(k_outer)</span></span>
<span id="cb168-5454"><a href="#cb168-5454" aria-hidden="true" tabindex="-1"></a><span class="in">indices &lt;- 1:nrow(data)</span></span>
<span id="cb168-5455"><a href="#cb168-5455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5456"><a href="#cb168-5456" aria-hidden="true" tabindex="-1"></a><span class="in"># Inicializar matrices para almacenar predicciones y objetivos</span></span>
<span id="cb168-5457"><a href="#cb168-5457" aria-hidden="true" tabindex="-1"></a><span class="in">predicciones_totales &lt;- matrix(NA, nrow = nrow(data), ncol = k_outer)</span></span>
<span id="cb168-5458"><a href="#cb168-5458" aria-hidden="true" tabindex="-1"></a><span class="in">targets_totales &lt;- numeric(nrow(data))</span></span>
<span id="cb168-5459"><a href="#cb168-5459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5460"><a href="#cb168-5460" aria-hidden="true" tabindex="-1"></a><span class="in"># Iterar sobre cada pliegue externo y realizar el proceso de modelado</span></span>
<span id="cb168-5461"><a href="#cb168-5461" aria-hidden="true" tabindex="-1"></a><span class="in">for (i_outer in 1:k_outer) {</span></span>
<span id="cb168-5462"><a href="#cb168-5462" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-5463"><a href="#cb168-5463" aria-hidden="true" tabindex="-1"></a><span class="in">  # Obtener los índices para el pliegue externo actual</span></span>
<span id="cb168-5464"><a href="#cb168-5464" aria-hidden="true" tabindex="-1"></a><span class="in">  test_indices_outer &lt;- indices[folds_outer == i_outer]  # Índices correspondientes al pliegue externo de test</span></span>
<span id="cb168-5465"><a href="#cb168-5465" aria-hidden="true" tabindex="-1"></a><span class="in">  train_indices_outer &lt;- setdiff(1:nrow(data), test_indices_outer)  # Índices correspondientes al conjunto de entrenamiento</span></span>
<span id="cb168-5466"><a href="#cb168-5466" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-5467"><a href="#cb168-5467" aria-hidden="true" tabindex="-1"></a><span class="in">  # Dividir datos en entrenamiento y test para el pliegue externo</span></span>
<span id="cb168-5468"><a href="#cb168-5468" aria-hidden="true" tabindex="-1"></a><span class="in">  datos_entrenamiento_outer &lt;- datafinal[train_indices_outer, ]</span></span>
<span id="cb168-5469"><a href="#cb168-5469" aria-hidden="true" tabindex="-1"></a><span class="in">  datos_test_outer &lt;- datafinal[test_indices_outer, ]</span></span>
<span id="cb168-5470"><a href="#cb168-5470" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-5471"><a href="#cb168-5471" aria-hidden="true" tabindex="-1"></a><span class="in">  # Configurar la validación cruzada interna</span></span>
<span id="cb168-5472"><a href="#cb168-5472" aria-hidden="true" tabindex="-1"></a><span class="in">  folds_inner &lt;- createFolds(datos_entrenamiento_outer$ESTADO_ACTUAL, k = k_inner, list = FALSE)  # Obtener índices de pliegues internos</span></span>
<span id="cb168-5473"><a href="#cb168-5473" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-5474"><a href="#cb168-5474" aria-hidden="true" tabindex="-1"></a><span class="in">  # Almacenar predicciones y objetivos para el AUC general</span></span>
<span id="cb168-5475"><a href="#cb168-5475" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_auc &lt;- numeric(nrow(datos_entrenamiento_outer))</span></span>
<span id="cb168-5476"><a href="#cb168-5476" aria-hidden="true" tabindex="-1"></a><span class="in">  targets_auc &lt;- numeric(nrow(datos_entrenamiento_outer))</span></span>
<span id="cb168-5477"><a href="#cb168-5477" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-5478"><a href="#cb168-5478" aria-hidden="true" tabindex="-1"></a><span class="in">  # Inicializar variables para almacenar resultados internos</span></span>
<span id="cb168-5479"><a href="#cb168-5479" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_auc_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-5480"><a href="#cb168-5480" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_accuracy_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-5481"><a href="#cb168-5481" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_sensibilidad_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-5482"><a href="#cb168-5482" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-5483"><a href="#cb168-5483" aria-hidden="true" tabindex="-1"></a><span class="in">  # Iterar sobre cada pliegue interno para selección de modelo</span></span>
<span id="cb168-5484"><a href="#cb168-5484" aria-hidden="true" tabindex="-1"></a><span class="in">  indices_inner &lt;- 1:nrow(datos_entrenamiento_outer)</span></span>
<span id="cb168-5485"><a href="#cb168-5485" aria-hidden="true" tabindex="-1"></a><span class="in">  for (i_inner in 1:k_inner) {</span></span>
<span id="cb168-5486"><a href="#cb168-5486" aria-hidden="true" tabindex="-1"></a><span class="in">    # Obtener los índices para el pliegue interno actual</span></span>
<span id="cb168-5487"><a href="#cb168-5487" aria-hidden="true" tabindex="-1"></a><span class="in">    test_indices_inner &lt;- indices_inner[folds_inner == i_inner]  # Índices correspondientes al pliegue interno de test</span></span>
<span id="cb168-5488"><a href="#cb168-5488" aria-hidden="true" tabindex="-1"></a><span class="in">    train_indices_inner &lt;- setdiff(1:nrow(datos_entrenamiento_outer), test_indices_inner)  # Índices correspondientes al conjunto de entrenamiento interno</span></span>
<span id="cb168-5489"><a href="#cb168-5489" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5490"><a href="#cb168-5490" aria-hidden="true" tabindex="-1"></a><span class="in">    # Dividir datos en entrenamiento y test para el pliegue interno</span></span>
<span id="cb168-5491"><a href="#cb168-5491" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_entrenamiento_inner &lt;- datos_entrenamiento_outer[train_indices_inner, ]</span></span>
<span id="cb168-5492"><a href="#cb168-5492" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_validacion &lt;- datos_entrenamiento_outer[test_indices_inner, ]</span></span>
<span id="cb168-5493"><a href="#cb168-5493" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5494"><a href="#cb168-5494" aria-hidden="true" tabindex="-1"></a><span class="in">    # Almacenar predicciones y objetivos para el AUC interno</span></span>
<span id="cb168-5495"><a href="#cb168-5495" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_auc &lt;- numeric(nrow(datos_validacion))</span></span>
<span id="cb168-5496"><a href="#cb168-5496" aria-hidden="true" tabindex="-1"></a><span class="in">    targets_auc &lt;- numeric(nrow(datos_validacion))</span></span>
<span id="cb168-5497"><a href="#cb168-5497" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5498"><a href="#cb168-5498" aria-hidden="true" tabindex="-1"></a><span class="in">    # Definir todas las combinaciones de variables (sustituye esto por tus combinaciones reales)</span></span>
<span id="cb168-5499"><a href="#cb168-5499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5500"><a href="#cb168-5500" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5501"><a href="#cb168-5501" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5502"><a href="#cb168-5502" aria-hidden="true" tabindex="-1"></a><span class="in">    # Aplicar oversampling en el conjunto de entrenamiento interno</span></span>
<span id="cb168-5503"><a href="#cb168-5503" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_entrenamiento_oversampled &lt;- ROSE(ESTADO_ACTUAL ~ ., data = datos_entrenamiento_inner, p = proportion)$data</span></span>
<span id="cb168-5504"><a href="#cb168-5504" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5505"><a href="#cb168-5505" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5506"><a href="#cb168-5506" aria-hidden="true" tabindex="-1"></a><span class="in">    # Entrenar el modelo Naive Bayes</span></span>
<span id="cb168-5507"><a href="#cb168-5507" aria-hidden="true" tabindex="-1"></a><span class="in">    modelo &lt;- naiveBayes(ESTADO_ACTUAL ~ ., data = datos_entrenamiento_oversampled)</span></span>
<span id="cb168-5508"><a href="#cb168-5508" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5509"><a href="#cb168-5509" aria-hidden="true" tabindex="-1"></a><span class="in">    # Realizar predicciones con probabilidades en datos de validación</span></span>
<span id="cb168-5510"><a href="#cb168-5510" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_validacion_prob &lt;- predict(modelo, newdata = datos_validacion, type = "raw")[,2]</span></span>
<span id="cb168-5511"><a href="#cb168-5511" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5512"><a href="#cb168-5512" aria-hidden="true" tabindex="-1"></a><span class="in">    # Calcular el AUC</span></span>
<span id="cb168-5513"><a href="#cb168-5513" aria-hidden="true" tabindex="-1"></a><span class="in">    roc_obj &lt;- roc(datos_validacion$ESTADO_ACTUAL, predicciones_validacion_prob, levels = rev(levels(datos_validacion$ESTADO_ACTUAL)))</span></span>
<span id="cb168-5514"><a href="#cb168-5514" aria-hidden="true" tabindex="-1"></a><span class="in">    auc_actual &lt;- auc(roc_obj)</span></span>
<span id="cb168-5515"><a href="#cb168-5515" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5516"><a href="#cb168-5516" aria-hidden="true" tabindex="-1"></a><span class="in">    # Almacenar las predicciones y objetivos</span></span>
<span id="cb168-5517"><a href="#cb168-5517" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_auc[test_indices_inner] &lt;- predicciones_validacion_prob</span></span>
<span id="cb168-5518"><a href="#cb168-5518" aria-hidden="true" tabindex="-1"></a><span class="in">    targets_auc[test_indices_inner] &lt;- as.numeric(datos_validacion$ESTADO_ACTUAL) - 1</span></span>
<span id="cb168-5519"><a href="#cb168-5519" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5520"><a href="#cb168-5520" aria-hidden="true" tabindex="-1"></a><span class="in">    # Calcular la sensibilidad y la precisión</span></span>
<span id="cb168-5521"><a href="#cb168-5521" aria-hidden="true" tabindex="-1"></a><span class="in">    umbral &lt;- 0.5</span></span>
<span id="cb168-5522"><a href="#cb168-5522" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_finales &lt;- ifelse(predicciones_validacion_prob &gt;= umbral, "SI", "NO")</span></span>
<span id="cb168-5523"><a href="#cb168-5523" aria-hidden="true" tabindex="-1"></a><span class="in">    TP &lt;- sum(predicciones_finales == "SI" &amp; datos_validacion$ESTADO_ACTUAL == "SI")</span></span>
<span id="cb168-5524"><a href="#cb168-5524" aria-hidden="true" tabindex="-1"></a><span class="in">    FN &lt;- sum(predicciones_finales == "NO" &amp; datos_validacion$ESTADO_ACTUAL == "SI")</span></span>
<span id="cb168-5525"><a href="#cb168-5525" aria-hidden="true" tabindex="-1"></a><span class="in">    FP &lt;- sum(predicciones_finales == "SI" &amp; datos_validacion$ESTADO_ACTUAL == "NO")</span></span>
<span id="cb168-5526"><a href="#cb168-5526" aria-hidden="true" tabindex="-1"></a><span class="in">    TN &lt;- sum(predicciones_finales == "NO" &amp; datos_validacion$ESTADO_ACTUAL == "NO")</span></span>
<span id="cb168-5527"><a href="#cb168-5527" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5528"><a href="#cb168-5528" aria-hidden="true" tabindex="-1"></a><span class="in">    recall_actual &lt;- TP / (TP + FN)</span></span>
<span id="cb168-5529"><a href="#cb168-5529" aria-hidden="true" tabindex="-1"></a><span class="in">    accuracy_actual &lt;- (TP + TN) / (TP + FN + FP + TN)</span></span>
<span id="cb168-5530"><a href="#cb168-5530" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5531"><a href="#cb168-5531" aria-hidden="true" tabindex="-1"></a><span class="in">    # Almacenar resultados internos</span></span>
<span id="cb168-5532"><a href="#cb168-5532" aria-hidden="true" tabindex="-1"></a><span class="in">    resultados_sensibilidad_inner[i_inner] &lt;- recall_actual</span></span>
<span id="cb168-5533"><a href="#cb168-5533" aria-hidden="true" tabindex="-1"></a><span class="in">    resultados_accuracy_inner[i_inner] &lt;- accuracy_actual</span></span>
<span id="cb168-5534"><a href="#cb168-5534" aria-hidden="true" tabindex="-1"></a><span class="in">    resultados_auc_inner[i_inner] &lt;- auc_actual</span></span>
<span id="cb168-5535"><a href="#cb168-5535" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-5536"><a href="#cb168-5536" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb168-5537"><a href="#cb168-5537" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-5538"><a href="#cb168-5538" aria-hidden="true" tabindex="-1"></a><span class="in">  # Calcular el AUC final para este pliegue externo</span></span>
<span id="cb168-5539"><a href="#cb168-5539" aria-hidden="true" tabindex="-1"></a><span class="in">  auc_fold_externo &lt;- mean(resultados_auc_inner)</span></span>
<span id="cb168-5540"><a href="#cb168-5540" aria-hidden="true" tabindex="-1"></a><span class="in">  accuracy_fold_externo &lt;- mean(resultados_accuracy_inner)</span></span>
<span id="cb168-5541"><a href="#cb168-5541" aria-hidden="true" tabindex="-1"></a><span class="in">  sensibilidad_fold_externo &lt;- mean(resultados_sensibilidad_inner)</span></span>
<span id="cb168-5542"><a href="#cb168-5542" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-5543"><a href="#cb168-5543" aria-hidden="true" tabindex="-1"></a><span class="in">  # Almacenar el AUC del fold externo actual</span></span>
<span id="cb168-5544"><a href="#cb168-5544" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_auc[i_outer] &lt;- auc_fold_externo</span></span>
<span id="cb168-5545"><a href="#cb168-5545" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_accuracy[i_outer] &lt;- accuracy_fold_externo</span></span>
<span id="cb168-5546"><a href="#cb168-5546" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_sensibilidad[i_outer] &lt;- sensibilidad_fold_externo</span></span>
<span id="cb168-5547"><a href="#cb168-5547" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-5548"><a href="#cb168-5548" aria-hidden="true" tabindex="-1"></a><span class="in">  # Predecir en los datos de test para este pliegue externo y almacenar predicciones</span></span>
<span id="cb168-5549"><a href="#cb168-5549" aria-hidden="true" tabindex="-1"></a><span class="in">  # (Aquí deberías hacer la predicción usando el mejor modelo encontrado en el bucle interno)</span></span>
<span id="cb168-5550"><a href="#cb168-5550" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb168-5551"><a href="#cb168-5551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5552"><a href="#cb168-5552" aria-hidden="true" tabindex="-1"></a><span class="in"># Calcular AUC promedio</span></span>
<span id="cb168-5553"><a href="#cb168-5553" aria-hidden="true" tabindex="-1"></a><span class="in">auc_promedio &lt;- mean(resultados_auc)</span></span>
<span id="cb168-5554"><a href="#cb168-5554" aria-hidden="true" tabindex="-1"></a><span class="in">accuracy_promedio &lt;- mean(resultados_accuracy)</span></span>
<span id="cb168-5555"><a href="#cb168-5555" aria-hidden="true" tabindex="-1"></a><span class="in">sensibilidad_promedio &lt;- mean(resultados_sensibilidad)</span></span>
<span id="cb168-5556"><a href="#cb168-5556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5557"><a href="#cb168-5557" aria-hidden="true" tabindex="-1"></a><span class="in">tabla_metricas &lt;- data.frame(</span></span>
<span id="cb168-5558"><a href="#cb168-5558" aria-hidden="true" tabindex="-1"></a><span class="in">  Pliegue = 1:k_outer,</span></span>
<span id="cb168-5559"><a href="#cb168-5559" aria-hidden="true" tabindex="-1"></a><span class="in">  AUC = sapply(resultados_auc, round, digits = 3),</span></span>
<span id="cb168-5560"><a href="#cb168-5560" aria-hidden="true" tabindex="-1"></a><span class="in">  Accuracy = sapply(resultados_accuracy, round, digits = 3),</span></span>
<span id="cb168-5561"><a href="#cb168-5561" aria-hidden="true" tabindex="-1"></a><span class="in">  Recall = sapply(resultados_sensibilidad, round, digits = 3)</span></span>
<span id="cb168-5562"><a href="#cb168-5562" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb168-5563"><a href="#cb168-5563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5564"><a href="#cb168-5564" aria-hidden="true" tabindex="-1"></a><span class="in"># Agregar fila con promedio de métricas</span></span>
<span id="cb168-5565"><a href="#cb168-5565" aria-hidden="true" tabindex="-1"></a><span class="in">tabla_metricas_naive15 &lt;- rbind(tabla_metricas, c("Mean", round(auc_promedio, 3), round(accuracy_promedio, 3), round(sensibilidad_promedio, 3)))</span></span>
<span id="cb168-5566"><a href="#cb168-5566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5567"><a href="#cb168-5567" aria-hidden="true" tabindex="-1"></a><span class="in"># Detener el tiempo de ejecución</span></span>
<span id="cb168-5568"><a href="#cb168-5568" aria-hidden="true" tabindex="-1"></a><span class="in">end_time &lt;- Sys.time()</span></span>
<span id="cb168-5569"><a href="#cb168-5569" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time_naive &lt;- end_time - start_time</span></span>
<span id="cb168-5570"><a href="#cb168-5570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5571"><a href="#cb168-5571" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time_naive15 &lt;- as.numeric(execution_time_naive, units = "secs")</span></span>
<span id="cb168-5572"><a href="#cb168-5572" aria-hidden="true" tabindex="-1"></a><span class="in">save(tabla_metricas_naive15, file = "tabla_metricas_naive_filter15.RData")</span></span>
<span id="cb168-5573"><a href="#cb168-5573" aria-hidden="true" tabindex="-1"></a><span class="in">save(execution_time_naive15, file = "execution_time_naive_filter15.RData")</span></span>
<span id="cb168-5574"><a href="#cb168-5574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5575"><a href="#cb168-5575" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-5576"><a href="#cb168-5576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5579"><a href="#cb168-5579" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-5580"><a href="#cb168-5580" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"tabla_metricas_naive_filter15.RData"</span>)</span>
<span id="cb168-5581"><a href="#cb168-5581" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"execution_time_naive_filter15.RData"</span>)</span>
<span id="cb168-5582"><a href="#cb168-5582" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir el tiempo de ejecución</span></span>
<span id="cb168-5583"><a href="#cb168-5583" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time_naive15,  <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb168-5584"><a href="#cb168-5584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5585"><a href="#cb168-5585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5586"><a href="#cb168-5586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5587"><a href="#cb168-5587" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-5588"><a href="#cb168-5588" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5589"><a href="#cb168-5589" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb168-5590"><a href="#cb168-5590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5591"><a href="#cb168-5591" aria-hidden="true" tabindex="-1"></a><span class="fu"># Metrics Table</span></span>
<span id="cb168-5594"><a href="#cb168-5594" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-5595"><a href="#cb168-5595" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir tabla formateada con kableExtra</span></span>
<span id="cb168-5596"><a href="#cb168-5596" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(tabla_metricas_naive15, <span class="at">caption =</span> <span class="st">"Cross Validation Metrics"</span>, <span class="at">align =</span> <span class="st">"c"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb168-5597"><a href="#cb168-5597" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb168-5598"><a href="#cb168-5598" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-5599"><a href="#cb168-5599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5600"><a href="#cb168-5600" aria-hidden="true" tabindex="-1"></a><span class="fu"># Metrics Plot</span></span>
<span id="cb168-5603"><a href="#cb168-5603" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-5604"><a href="#cb168-5604" aria-hidden="true" tabindex="-1"></a><span class="fu">crear_plot_metricas_per_fold</span>(tabla_metricas_naive15)</span>
<span id="cb168-5605"><a href="#cb168-5605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5606"><a href="#cb168-5606" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-5607"><a href="#cb168-5607" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb168-5608"><a href="#cb168-5608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5609"><a href="#cb168-5609" aria-hidden="true" tabindex="-1"></a><span class="fu">### 20x10 Cross Validation</span></span>
<span id="cb168-5610"><a href="#cb168-5610" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=FALSE,message=FALSE, eval=FALSE}</span></span>
<span id="cb168-5611"><a href="#cb168-5611" aria-hidden="true" tabindex="-1"></a><span class="in"># Iniciar tiempo de ejecución</span></span>
<span id="cb168-5612"><a href="#cb168-5612" aria-hidden="true" tabindex="-1"></a><span class="in">start_time &lt;- Sys.time()</span></span>
<span id="cb168-5613"><a href="#cb168-5613" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5614"><a href="#cb168-5614" aria-hidden="true" tabindex="-1"></a><span class="in"># Parámetros a cambiar</span></span>
<span id="cb168-5615"><a href="#cb168-5615" aria-hidden="true" tabindex="-1"></a><span class="in">proportion &lt;- 0.28</span></span>
<span id="cb168-5616"><a href="#cb168-5616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5617"><a href="#cb168-5617" aria-hidden="true" tabindex="-1"></a><span class="in"># Configurar la validación cruzada 5x2</span></span>
<span id="cb168-5618"><a href="#cb168-5618" aria-hidden="true" tabindex="-1"></a><span class="in">k_outer &lt;- 20  # Número de pliegues externos</span></span>
<span id="cb168-5619"><a href="#cb168-5619" aria-hidden="true" tabindex="-1"></a><span class="in">k_inner &lt;- 10  # Número de pliegues internos</span></span>
<span id="cb168-5620"><a href="#cb168-5620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5621"><a href="#cb168-5621" aria-hidden="true" tabindex="-1"></a><span class="in"># Lista para almacenar resultados</span></span>
<span id="cb168-5622"><a href="#cb168-5622" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_auc &lt;- numeric(k_outer)</span></span>
<span id="cb168-5623"><a href="#cb168-5623" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_accuracy &lt;- numeric(k_outer)</span></span>
<span id="cb168-5624"><a href="#cb168-5624" aria-hidden="true" tabindex="-1"></a><span class="in">resultados_sensibilidad &lt;- numeric(k_outer)</span></span>
<span id="cb168-5625"><a href="#cb168-5625" aria-hidden="true" tabindex="-1"></a><span class="in">indices &lt;- 1:nrow(data)</span></span>
<span id="cb168-5626"><a href="#cb168-5626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5627"><a href="#cb168-5627" aria-hidden="true" tabindex="-1"></a><span class="in"># Inicializar matrices para almacenar predicciones y objetivos</span></span>
<span id="cb168-5628"><a href="#cb168-5628" aria-hidden="true" tabindex="-1"></a><span class="in">predicciones_totales &lt;- matrix(NA, nrow = nrow(data), ncol = k_outer)</span></span>
<span id="cb168-5629"><a href="#cb168-5629" aria-hidden="true" tabindex="-1"></a><span class="in">targets_totales &lt;- numeric(nrow(data))</span></span>
<span id="cb168-5630"><a href="#cb168-5630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5631"><a href="#cb168-5631" aria-hidden="true" tabindex="-1"></a><span class="in"># Iterar sobre cada pliegue externo y realizar el proceso de modelado</span></span>
<span id="cb168-5632"><a href="#cb168-5632" aria-hidden="true" tabindex="-1"></a><span class="in">for (i_outer in 1:k_outer) {</span></span>
<span id="cb168-5633"><a href="#cb168-5633" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-5634"><a href="#cb168-5634" aria-hidden="true" tabindex="-1"></a><span class="in">  # Obtener los índices para el pliegue externo actual</span></span>
<span id="cb168-5635"><a href="#cb168-5635" aria-hidden="true" tabindex="-1"></a><span class="in">  test_indices_outer &lt;- indices[folds_outer == i_outer]  # Índices correspondientes al pliegue externo de test</span></span>
<span id="cb168-5636"><a href="#cb168-5636" aria-hidden="true" tabindex="-1"></a><span class="in">  train_indices_outer &lt;- setdiff(1:nrow(data), test_indices_outer)  # Índices correspondientes al conjunto de entrenamiento</span></span>
<span id="cb168-5637"><a href="#cb168-5637" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-5638"><a href="#cb168-5638" aria-hidden="true" tabindex="-1"></a><span class="in">  # Dividir datos en entrenamiento y test para el pliegue externo</span></span>
<span id="cb168-5639"><a href="#cb168-5639" aria-hidden="true" tabindex="-1"></a><span class="in">  datos_entrenamiento_outer &lt;- datafinal[train_indices_outer, ]</span></span>
<span id="cb168-5640"><a href="#cb168-5640" aria-hidden="true" tabindex="-1"></a><span class="in">  datos_test_outer &lt;- datafinal[test_indices_outer, ]</span></span>
<span id="cb168-5641"><a href="#cb168-5641" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-5642"><a href="#cb168-5642" aria-hidden="true" tabindex="-1"></a><span class="in">  # Configurar la validación cruzada interna</span></span>
<span id="cb168-5643"><a href="#cb168-5643" aria-hidden="true" tabindex="-1"></a><span class="in">  folds_inner &lt;- createFolds(datos_entrenamiento_outer$ESTADO_ACTUAL, k = k_inner, list = FALSE)  # Obtener índices de pliegues internos</span></span>
<span id="cb168-5644"><a href="#cb168-5644" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-5645"><a href="#cb168-5645" aria-hidden="true" tabindex="-1"></a><span class="in">  # Almacenar predicciones y objetivos para el AUC general</span></span>
<span id="cb168-5646"><a href="#cb168-5646" aria-hidden="true" tabindex="-1"></a><span class="in">  predicciones_auc &lt;- numeric(nrow(datos_entrenamiento_outer))</span></span>
<span id="cb168-5647"><a href="#cb168-5647" aria-hidden="true" tabindex="-1"></a><span class="in">  targets_auc &lt;- numeric(nrow(datos_entrenamiento_outer))</span></span>
<span id="cb168-5648"><a href="#cb168-5648" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-5649"><a href="#cb168-5649" aria-hidden="true" tabindex="-1"></a><span class="in">  # Inicializar variables para almacenar resultados internos</span></span>
<span id="cb168-5650"><a href="#cb168-5650" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_auc_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-5651"><a href="#cb168-5651" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_accuracy_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-5652"><a href="#cb168-5652" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_sensibilidad_inner &lt;- numeric(k_inner)</span></span>
<span id="cb168-5653"><a href="#cb168-5653" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-5654"><a href="#cb168-5654" aria-hidden="true" tabindex="-1"></a><span class="in">  # Iterar sobre cada pliegue interno para selección de modelo</span></span>
<span id="cb168-5655"><a href="#cb168-5655" aria-hidden="true" tabindex="-1"></a><span class="in">  indices_inner &lt;- 1:nrow(datos_entrenamiento_outer)</span></span>
<span id="cb168-5656"><a href="#cb168-5656" aria-hidden="true" tabindex="-1"></a><span class="in">  for (i_inner in 1:k_inner) {</span></span>
<span id="cb168-5657"><a href="#cb168-5657" aria-hidden="true" tabindex="-1"></a><span class="in">    # Obtener los índices para el pliegue interno actual</span></span>
<span id="cb168-5658"><a href="#cb168-5658" aria-hidden="true" tabindex="-1"></a><span class="in">    test_indices_inner &lt;- indices_inner[folds_inner == i_inner]  # Índices correspondientes al pliegue interno de test</span></span>
<span id="cb168-5659"><a href="#cb168-5659" aria-hidden="true" tabindex="-1"></a><span class="in">    train_indices_inner &lt;- setdiff(1:nrow(datos_entrenamiento_outer), test_indices_inner)  # Índices correspondientes al conjunto de entrenamiento interno</span></span>
<span id="cb168-5660"><a href="#cb168-5660" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5661"><a href="#cb168-5661" aria-hidden="true" tabindex="-1"></a><span class="in">    # Dividir datos en entrenamiento y test para el pliegue interno</span></span>
<span id="cb168-5662"><a href="#cb168-5662" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_entrenamiento_inner &lt;- datos_entrenamiento_outer[train_indices_inner, ]</span></span>
<span id="cb168-5663"><a href="#cb168-5663" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_validacion &lt;- datos_entrenamiento_outer[test_indices_inner, ]</span></span>
<span id="cb168-5664"><a href="#cb168-5664" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5665"><a href="#cb168-5665" aria-hidden="true" tabindex="-1"></a><span class="in">    # Almacenar predicciones y objetivos para el AUC interno</span></span>
<span id="cb168-5666"><a href="#cb168-5666" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_auc &lt;- numeric(nrow(datos_validacion))</span></span>
<span id="cb168-5667"><a href="#cb168-5667" aria-hidden="true" tabindex="-1"></a><span class="in">    targets_auc &lt;- numeric(nrow(datos_validacion))</span></span>
<span id="cb168-5668"><a href="#cb168-5668" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5669"><a href="#cb168-5669" aria-hidden="true" tabindex="-1"></a><span class="in">    # Definir todas las combinaciones de variables (sustituye esto por tus combinaciones reales)</span></span>
<span id="cb168-5670"><a href="#cb168-5670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5671"><a href="#cb168-5671" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5672"><a href="#cb168-5672" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5673"><a href="#cb168-5673" aria-hidden="true" tabindex="-1"></a><span class="in">    # Aplicar oversampling en el conjunto de entrenamiento interno</span></span>
<span id="cb168-5674"><a href="#cb168-5674" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_entrenamiento_oversampled &lt;- ROSE(ESTADO_ACTUAL ~ ., data = datos_entrenamiento_inner, p = proportion)$data</span></span>
<span id="cb168-5675"><a href="#cb168-5675" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5676"><a href="#cb168-5676" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5677"><a href="#cb168-5677" aria-hidden="true" tabindex="-1"></a><span class="in">    # Entrenar el modelo Naive Bayes</span></span>
<span id="cb168-5678"><a href="#cb168-5678" aria-hidden="true" tabindex="-1"></a><span class="in">    modelo &lt;- naiveBayes(ESTADO_ACTUAL ~ ., data = datos_entrenamiento_oversampled)</span></span>
<span id="cb168-5679"><a href="#cb168-5679" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5680"><a href="#cb168-5680" aria-hidden="true" tabindex="-1"></a><span class="in">    # Realizar predicciones con probabilidades en datos de validación</span></span>
<span id="cb168-5681"><a href="#cb168-5681" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_validacion_prob &lt;- predict(modelo, newdata = datos_validacion, type = "raw")[,2]</span></span>
<span id="cb168-5682"><a href="#cb168-5682" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5683"><a href="#cb168-5683" aria-hidden="true" tabindex="-1"></a><span class="in">    # Calcular el AUC</span></span>
<span id="cb168-5684"><a href="#cb168-5684" aria-hidden="true" tabindex="-1"></a><span class="in">    roc_obj &lt;- roc(datos_validacion$ESTADO_ACTUAL, predicciones_validacion_prob, levels = rev(levels(datos_validacion$ESTADO_ACTUAL)))</span></span>
<span id="cb168-5685"><a href="#cb168-5685" aria-hidden="true" tabindex="-1"></a><span class="in">    auc_actual &lt;- auc(roc_obj)</span></span>
<span id="cb168-5686"><a href="#cb168-5686" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5687"><a href="#cb168-5687" aria-hidden="true" tabindex="-1"></a><span class="in">    # Almacenar las predicciones y objetivos</span></span>
<span id="cb168-5688"><a href="#cb168-5688" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_auc[test_indices_inner] &lt;- predicciones_validacion_prob</span></span>
<span id="cb168-5689"><a href="#cb168-5689" aria-hidden="true" tabindex="-1"></a><span class="in">    targets_auc[test_indices_inner] &lt;- as.numeric(datos_validacion$ESTADO_ACTUAL) - 1</span></span>
<span id="cb168-5690"><a href="#cb168-5690" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5691"><a href="#cb168-5691" aria-hidden="true" tabindex="-1"></a><span class="in">    # Calcular la sensibilidad y la precisión</span></span>
<span id="cb168-5692"><a href="#cb168-5692" aria-hidden="true" tabindex="-1"></a><span class="in">    umbral &lt;- 0.5</span></span>
<span id="cb168-5693"><a href="#cb168-5693" aria-hidden="true" tabindex="-1"></a><span class="in">    predicciones_finales &lt;- ifelse(predicciones_validacion_prob &gt;= umbral, "SI", "NO")</span></span>
<span id="cb168-5694"><a href="#cb168-5694" aria-hidden="true" tabindex="-1"></a><span class="in">    TP &lt;- sum(predicciones_finales == "SI" &amp; datos_validacion$ESTADO_ACTUAL == "SI")</span></span>
<span id="cb168-5695"><a href="#cb168-5695" aria-hidden="true" tabindex="-1"></a><span class="in">    FN &lt;- sum(predicciones_finales == "NO" &amp; datos_validacion$ESTADO_ACTUAL == "SI")</span></span>
<span id="cb168-5696"><a href="#cb168-5696" aria-hidden="true" tabindex="-1"></a><span class="in">    FP &lt;- sum(predicciones_finales == "SI" &amp; datos_validacion$ESTADO_ACTUAL == "NO")</span></span>
<span id="cb168-5697"><a href="#cb168-5697" aria-hidden="true" tabindex="-1"></a><span class="in">    TN &lt;- sum(predicciones_finales == "NO" &amp; datos_validacion$ESTADO_ACTUAL == "NO")</span></span>
<span id="cb168-5698"><a href="#cb168-5698" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5699"><a href="#cb168-5699" aria-hidden="true" tabindex="-1"></a><span class="in">    recall_actual &lt;- TP / (TP + FN)</span></span>
<span id="cb168-5700"><a href="#cb168-5700" aria-hidden="true" tabindex="-1"></a><span class="in">    accuracy_actual &lt;- (TP + TN) / (TP + FN + FP + TN)</span></span>
<span id="cb168-5701"><a href="#cb168-5701" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5702"><a href="#cb168-5702" aria-hidden="true" tabindex="-1"></a><span class="in">    # Almacenar resultados internos</span></span>
<span id="cb168-5703"><a href="#cb168-5703" aria-hidden="true" tabindex="-1"></a><span class="in">    resultados_sensibilidad_inner[i_inner] &lt;- recall_actual</span></span>
<span id="cb168-5704"><a href="#cb168-5704" aria-hidden="true" tabindex="-1"></a><span class="in">    resultados_accuracy_inner[i_inner] &lt;- accuracy_actual</span></span>
<span id="cb168-5705"><a href="#cb168-5705" aria-hidden="true" tabindex="-1"></a><span class="in">    resultados_auc_inner[i_inner] &lt;- auc_actual</span></span>
<span id="cb168-5706"><a href="#cb168-5706" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-5707"><a href="#cb168-5707" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb168-5708"><a href="#cb168-5708" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-5709"><a href="#cb168-5709" aria-hidden="true" tabindex="-1"></a><span class="in">  # Calcular el AUC final para este pliegue externo</span></span>
<span id="cb168-5710"><a href="#cb168-5710" aria-hidden="true" tabindex="-1"></a><span class="in">  auc_fold_externo &lt;- mean(resultados_auc_inner)</span></span>
<span id="cb168-5711"><a href="#cb168-5711" aria-hidden="true" tabindex="-1"></a><span class="in">  accuracy_fold_externo &lt;- mean(resultados_accuracy_inner)</span></span>
<span id="cb168-5712"><a href="#cb168-5712" aria-hidden="true" tabindex="-1"></a><span class="in">  sensibilidad_fold_externo &lt;- mean(resultados_sensibilidad_inner)</span></span>
<span id="cb168-5713"><a href="#cb168-5713" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-5714"><a href="#cb168-5714" aria-hidden="true" tabindex="-1"></a><span class="in">  # Almacenar el AUC del fold externo actual</span></span>
<span id="cb168-5715"><a href="#cb168-5715" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_auc[i_outer] &lt;- auc_fold_externo</span></span>
<span id="cb168-5716"><a href="#cb168-5716" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_accuracy[i_outer] &lt;- accuracy_fold_externo</span></span>
<span id="cb168-5717"><a href="#cb168-5717" aria-hidden="true" tabindex="-1"></a><span class="in">  resultados_sensibilidad[i_outer] &lt;- sensibilidad_fold_externo</span></span>
<span id="cb168-5718"><a href="#cb168-5718" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-5719"><a href="#cb168-5719" aria-hidden="true" tabindex="-1"></a><span class="in">  # Predecir en los datos de test para este pliegue externo y almacenar predicciones</span></span>
<span id="cb168-5720"><a href="#cb168-5720" aria-hidden="true" tabindex="-1"></a><span class="in">  # (Aquí deberías hacer la predicción usando el mejor modelo encontrado en el bucle interno)</span></span>
<span id="cb168-5721"><a href="#cb168-5721" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb168-5722"><a href="#cb168-5722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5723"><a href="#cb168-5723" aria-hidden="true" tabindex="-1"></a><span class="in"># Calcular AUC promedio</span></span>
<span id="cb168-5724"><a href="#cb168-5724" aria-hidden="true" tabindex="-1"></a><span class="in">auc_promedio &lt;- mean(resultados_auc)</span></span>
<span id="cb168-5725"><a href="#cb168-5725" aria-hidden="true" tabindex="-1"></a><span class="in">accuracy_promedio &lt;- mean(resultados_accuracy)</span></span>
<span id="cb168-5726"><a href="#cb168-5726" aria-hidden="true" tabindex="-1"></a><span class="in">sensibilidad_promedio &lt;- mean(resultados_sensibilidad)</span></span>
<span id="cb168-5727"><a href="#cb168-5727" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5728"><a href="#cb168-5728" aria-hidden="true" tabindex="-1"></a><span class="in">tabla_metricas &lt;- data.frame(</span></span>
<span id="cb168-5729"><a href="#cb168-5729" aria-hidden="true" tabindex="-1"></a><span class="in">  Pliegue = 1:k_outer,</span></span>
<span id="cb168-5730"><a href="#cb168-5730" aria-hidden="true" tabindex="-1"></a><span class="in">  AUC = sapply(resultados_auc, round, digits = 3),</span></span>
<span id="cb168-5731"><a href="#cb168-5731" aria-hidden="true" tabindex="-1"></a><span class="in">  Accuracy = sapply(resultados_accuracy, round, digits = 3),</span></span>
<span id="cb168-5732"><a href="#cb168-5732" aria-hidden="true" tabindex="-1"></a><span class="in">  Recall = sapply(resultados_sensibilidad, round, digits = 3)</span></span>
<span id="cb168-5733"><a href="#cb168-5733" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb168-5734"><a href="#cb168-5734" aria-hidden="true" tabindex="-1"></a><span class="in"># Agregar fila con promedio de métricas</span></span>
<span id="cb168-5735"><a href="#cb168-5735" aria-hidden="true" tabindex="-1"></a><span class="in">tabla_metricas_naive21 &lt;- rbind(tabla_metricas, c("Mean", round(auc_promedio, 3), round(accuracy_promedio, 3), round(sensibilidad_promedio, 3)))</span></span>
<span id="cb168-5736"><a href="#cb168-5736" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5737"><a href="#cb168-5737" aria-hidden="true" tabindex="-1"></a><span class="in"># Detener el tiempo de ejecución</span></span>
<span id="cb168-5738"><a href="#cb168-5738" aria-hidden="true" tabindex="-1"></a><span class="in">end_time &lt;- Sys.time()</span></span>
<span id="cb168-5739"><a href="#cb168-5739" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time_naive &lt;- end_time - start_time</span></span>
<span id="cb168-5740"><a href="#cb168-5740" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5741"><a href="#cb168-5741" aria-hidden="true" tabindex="-1"></a><span class="in">execution_time_naive21 &lt;- as.numeric(execution_time_naive, units = "secs")</span></span>
<span id="cb168-5742"><a href="#cb168-5742" aria-hidden="true" tabindex="-1"></a><span class="in">save(tabla_metricas_naive21, file = "tabla_metricas_naive_filter21.RData")</span></span>
<span id="cb168-5743"><a href="#cb168-5743" aria-hidden="true" tabindex="-1"></a><span class="in">save(execution_time_naive21, file = "execution_time_naive_filter21.RData")</span></span>
<span id="cb168-5744"><a href="#cb168-5744" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5745"><a href="#cb168-5745" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-5746"><a href="#cb168-5746" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5749"><a href="#cb168-5749" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-5750"><a href="#cb168-5750" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"tabla_metricas_naive_filter21.RData"</span>)</span>
<span id="cb168-5751"><a href="#cb168-5751" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"execution_time_naive_filter21.RData"</span>)</span>
<span id="cb168-5752"><a href="#cb168-5752" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir el tiempo de ejecución</span></span>
<span id="cb168-5753"><a href="#cb168-5753" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Execution time:"</span>, execution_time_naive21,  <span class="st">"seconds </span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb168-5754"><a href="#cb168-5754" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5755"><a href="#cb168-5755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5756"><a href="#cb168-5756" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5757"><a href="#cb168-5757" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-5758"><a href="#cb168-5758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5759"><a href="#cb168-5759" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb168-5760"><a href="#cb168-5760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5761"><a href="#cb168-5761" aria-hidden="true" tabindex="-1"></a><span class="fu"># Metrics Table</span></span>
<span id="cb168-5764"><a href="#cb168-5764" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-5765"><a href="#cb168-5765" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir tabla formateada con kableExtra</span></span>
<span id="cb168-5766"><a href="#cb168-5766" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(tabla_metricas_naive21, <span class="at">caption =</span> <span class="st">"Cross Validation Metrics"</span>, <span class="at">align =</span> <span class="st">"c"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb168-5767"><a href="#cb168-5767" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb168-5768"><a href="#cb168-5768" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-5769"><a href="#cb168-5769" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5770"><a href="#cb168-5770" aria-hidden="true" tabindex="-1"></a><span class="fu"># Metrics Plot</span></span>
<span id="cb168-5773"><a href="#cb168-5773" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb168-5774"><a href="#cb168-5774" aria-hidden="true" tabindex="-1"></a><span class="fu">crear_plot_metricas_per_fold</span>(tabla_metricas_naive21)</span>
<span id="cb168-5775"><a href="#cb168-5775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5776"><a href="#cb168-5776" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-5777"><a href="#cb168-5777" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb168-5778"><a href="#cb168-5778" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5779"><a href="#cb168-5779" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb168-5780"><a href="#cb168-5780" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5781"><a href="#cb168-5781" aria-hidden="true" tabindex="-1"></a>The model performance is more stable with a higher number of inner folds. On top of that, if we increase the number of outer folds, the model performance is more consistent. However, the execution time increases significantly with a higher number of folds. </span>
<span id="cb168-5782"><a href="#cb168-5782" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5783"><a href="#cb168-5783" aria-hidden="true" tabindex="-1"></a><span class="fu"># Deployment {#deployment}</span></span>
<span id="cb168-5784"><a href="#cb168-5784" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5785"><a href="#cb168-5785" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5786"><a href="#cb168-5786" aria-hidden="true" tabindex="-1"></a>In this section, we will deploy the model using the Shiny framework. </span>
<span id="cb168-5787"><a href="#cb168-5787" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5788"><a href="#cb168-5788" aria-hidden="true" tabindex="-1"></a>Source code of the Shiny app:</span>
<span id="cb168-5789"><a href="#cb168-5789" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5790"><a href="#cb168-5790" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5791"><a href="#cb168-5791" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,eval=FALSE}</span></span>
<span id="cb168-5792"><a href="#cb168-5792" aria-hidden="true" tabindex="-1"></a><span class="in">library(shiny)</span></span>
<span id="cb168-5793"><a href="#cb168-5793" aria-hidden="true" tabindex="-1"></a><span class="in">library(e1071)</span></span>
<span id="cb168-5794"><a href="#cb168-5794" aria-hidden="true" tabindex="-1"></a><span class="in">library(shinyjs)</span></span>
<span id="cb168-5795"><a href="#cb168-5795" aria-hidden="true" tabindex="-1"></a><span class="in">#| </span></span>
<span id="cb168-5796"><a href="#cb168-5796" aria-hidden="true" tabindex="-1"></a><span class="in"># Load the trained Naive Bayes model</span></span>
<span id="cb168-5797"><a href="#cb168-5797" aria-hidden="true" tabindex="-1"></a><span class="in">load("modelo_final.RData")</span></span>
<span id="cb168-5798"><a href="#cb168-5798" aria-hidden="true" tabindex="-1"></a><span class="in">modelo &lt;- modelo_final</span></span>
<span id="cb168-5799"><a href="#cb168-5799" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5800"><a href="#cb168-5800" aria-hidden="true" tabindex="-1"></a><span class="in"># Definir niveles para cada variable</span></span>
<span id="cb168-5801"><a href="#cb168-5801" aria-hidden="true" tabindex="-1"></a><span class="in">niveles_edad &lt;- c("0-30", "31-40", "41-50", "51-60", "61-70", "+70")</span></span>
<span id="cb168-5802"><a href="#cb168-5802" aria-hidden="true" tabindex="-1"></a><span class="in">niveles_rest &lt;- c("N", "P")</span></span>
<span id="cb168-5803"><a href="#cb168-5803" aria-hidden="true" tabindex="-1"></a><span class="in">niveles_grado &lt;- c("1", "2", "3")</span></span>
<span id="cb168-5804"><a href="#cb168-5804" aria-hidden="true" tabindex="-1"></a><span class="in">niveles_fenotipo &lt;- c("Basal", "Her2", "LumA", "LumB", "Normal")</span></span>
<span id="cb168-5805"><a href="#cb168-5805" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5806"><a href="#cb168-5806" aria-hidden="true" tabindex="-1"></a><span class="in"># Define the UI with a modern theme</span></span>
<span id="cb168-5807"><a href="#cb168-5807" aria-hidden="true" tabindex="-1"></a><span class="in">ui &lt;- fluidPage(</span></span>
<span id="cb168-5808"><a href="#cb168-5808" aria-hidden="true" tabindex="-1"></a><span class="in">  includeCSS("bootstrap.css"), # Apply a modern theme</span></span>
<span id="cb168-5809"><a href="#cb168-5809" aria-hidden="true" tabindex="-1"></a><span class="in">  useShinyjs(), # Include shinyjs for JavaScript manipulation</span></span>
<span id="cb168-5810"><a href="#cb168-5810" aria-hidden="true" tabindex="-1"></a><span class="in">  tags$head(</span></span>
<span id="cb168-5811"><a href="#cb168-5811" aria-hidden="true" tabindex="-1"></a><span class="in">    tags$style(</span></span>
<span id="cb168-5812"><a href="#cb168-5812" aria-hidden="true" tabindex="-1"></a><span class="in">      HTML("</span></span>
<span id="cb168-5813"><a href="#cb168-5813" aria-hidden="true" tabindex="-1"></a><span class="in">            .prediction-text {</span></span>
<span id="cb168-5814"><a href="#cb168-5814" aria-hidden="true" tabindex="-1"></a><span class="in">              font-size: 15px;</span></span>
<span id="cb168-5815"><a href="#cb168-5815" aria-hidden="true" tabindex="-1"></a><span class="in">            }</span></span>
<span id="cb168-5816"><a href="#cb168-5816" aria-hidden="true" tabindex="-1"></a><span class="in">          ")</span></span>
<span id="cb168-5817"><a href="#cb168-5817" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb168-5818"><a href="#cb168-5818" aria-hidden="true" tabindex="-1"></a><span class="in">  ),</span></span>
<span id="cb168-5819"><a href="#cb168-5819" aria-hidden="true" tabindex="-1"></a><span class="in">  div(style = "padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 30px;",</span></span>
<span id="cb168-5820"><a href="#cb168-5820" aria-hidden="true" tabindex="-1"></a><span class="in">      tags$h1("Breast Cancer Prediction App", style = "font-size: 30px;")),</span></span>
<span id="cb168-5821"><a href="#cb168-5821" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-5822"><a href="#cb168-5822" aria-hidden="true" tabindex="-1"></a><span class="in">  div(class = "container",</span></span>
<span id="cb168-5823"><a href="#cb168-5823" aria-hidden="true" tabindex="-1"></a><span class="in">      h3("Enter the variables:"),</span></span>
<span id="cb168-5824"><a href="#cb168-5824" aria-hidden="true" tabindex="-1"></a><span class="in">      fluidRow(</span></span>
<span id="cb168-5825"><a href="#cb168-5825" aria-hidden="true" tabindex="-1"></a><span class="in">        column(6, selectInput("input_edad", "Age:", choices = niveles_edad, selected = "0-30")),</span></span>
<span id="cb168-5826"><a href="#cb168-5826" aria-hidden="true" tabindex="-1"></a><span class="in">        column(6, selectInput("input_rest", "REst:", choices = niveles_rest, selected = "N"))</span></span>
<span id="cb168-5827"><a href="#cb168-5827" aria-hidden="true" tabindex="-1"></a><span class="in">      ),</span></span>
<span id="cb168-5828"><a href="#cb168-5828" aria-hidden="true" tabindex="-1"></a><span class="in">      fluidRow(</span></span>
<span id="cb168-5829"><a href="#cb168-5829" aria-hidden="true" tabindex="-1"></a><span class="in">        column(6, selectInput("input_grado", "Grade:", choices = niveles_grado, selected = "1")),</span></span>
<span id="cb168-5830"><a href="#cb168-5830" aria-hidden="true" tabindex="-1"></a><span class="in">        column(6, selectInput("input_fenotipo", "Phenotype:", choices = niveles_fenotipo, selected = "Basal"))</span></span>
<span id="cb168-5831"><a href="#cb168-5831" aria-hidden="true" tabindex="-1"></a><span class="in">      ),</span></span>
<span id="cb168-5832"><a href="#cb168-5832" aria-hidden="true" tabindex="-1"></a><span class="in">      fluidRow(</span></span>
<span id="cb168-5833"><a href="#cb168-5833" aria-hidden="true" tabindex="-1"></a><span class="in">        column(6, actionButton("submit_button", "Make Prediction", class = "btn-primary")),</span></span>
<span id="cb168-5834"><a href="#cb168-5834" aria-hidden="true" tabindex="-1"></a><span class="in">        column(6, actionButton("help_button", "Need help with oncological variables?", class = "btn-info"))</span></span>
<span id="cb168-5835"><a href="#cb168-5835" aria-hidden="true" tabindex="-1"></a><span class="in">      ),</span></span>
<span id="cb168-5836"><a href="#cb168-5836" aria-hidden="true" tabindex="-1"></a><span class="in">      div(style = "height: 20px;"), # Add space below buttons</span></span>
<span id="cb168-5837"><a href="#cb168-5837" aria-hidden="true" tabindex="-1"></a><span class="in">      div(style = "border-bottom: 2px solid #ccc; margin-bottom: 20px;"), # Border for separation</span></span>
<span id="cb168-5838"><a href="#cb168-5838" aria-hidden="true" tabindex="-1"></a><span class="in">      div(id = "resultado_container", style = "display: none;",</span></span>
<span id="cb168-5839"><a href="#cb168-5839" aria-hidden="true" tabindex="-1"></a><span class="in">          h3("Prediction Result:"),</span></span>
<span id="cb168-5840"><a href="#cb168-5840" aria-hidden="true" tabindex="-1"></a><span class="in">          div(class = "alert alert-dismissible alert-light prediction-text",</span></span>
<span id="cb168-5841"><a href="#cb168-5841" aria-hidden="true" tabindex="-1"></a><span class="in">              strong("Prediction: "), </span></span>
<span id="cb168-5842"><a href="#cb168-5842" aria-hidden="true" tabindex="-1"></a><span class="in">              textOutput("resultado_prediccion")</span></span>
<span id="cb168-5843"><a href="#cb168-5843" aria-hidden="true" tabindex="-1"></a><span class="in">          )</span></span>
<span id="cb168-5844"><a href="#cb168-5844" aria-hidden="true" tabindex="-1"></a><span class="in">      ),</span></span>
<span id="cb168-5845"><a href="#cb168-5845" aria-hidden="true" tabindex="-1"></a><span class="in">      br(),</span></span>
<span id="cb168-5846"><a href="#cb168-5846" aria-hidden="true" tabindex="-1"></a><span class="in">      div(id = "help_container", style = "display: none;",</span></span>
<span id="cb168-5847"><a href="#cb168-5847" aria-hidden="true" tabindex="-1"></a><span class="in">          div(class = "alert alert-dismissible alert-info",</span></span>
<span id="cb168-5848"><a href="#cb168-5848" aria-hidden="true" tabindex="-1"></a><span class="in">              strong("Help: "), </span></span>
<span id="cb168-5849"><a href="#cb168-5849" aria-hidden="true" tabindex="-1"></a><span class="in">              "This alert provides information about the oncological variables used in the prediction:",</span></span>
<span id="cb168-5850"><a href="#cb168-5850" aria-hidden="true" tabindex="-1"></a><span class="in">              br(),</span></span>
<span id="cb168-5851"><a href="#cb168-5851" aria-hidden="true" tabindex="-1"></a><span class="in">              p("- Age: The age of the patient."),</span></span>
<span id="cb168-5852"><a href="#cb168-5852" aria-hidden="true" tabindex="-1"></a><span class="in">              p("- REst: Hormone receptor status (N: Negative, P: Positive)."),</span></span>
<span id="cb168-5853"><a href="#cb168-5853" aria-hidden="true" tabindex="-1"></a><span class="in">              p("- Grade: Histological grade of the tumor (1, 2, or 3)."),</span></span>
<span id="cb168-5854"><a href="#cb168-5854" aria-hidden="true" tabindex="-1"></a><span class="in">              p("- Phenotype: Tumor phenotype (Basal, Her2, LumA, LumB, or Normal)."),</span></span>
<span id="cb168-5855"><a href="#cb168-5855" aria-hidden="true" tabindex="-1"></a><span class="in">              br(),</span></span>
<span id="cb168-5856"><a href="#cb168-5856" aria-hidden="true" tabindex="-1"></a><span class="in">              "It's important to note that this prediction is based on statistical modeling and should not replace personalized medical advice. Please consult with your healthcare provider for any concerns or questions regarding breast cancer diagnosis or treatment.",</span></span>
<span id="cb168-5857"><a href="#cb168-5857" aria-hidden="true" tabindex="-1"></a><span class="in">              tags$button(type = "button", class = "btn-close", onclick = "shinyjs.hide('help_container');")</span></span>
<span id="cb168-5858"><a href="#cb168-5858" aria-hidden="true" tabindex="-1"></a><span class="in">          )</span></span>
<span id="cb168-5859"><a href="#cb168-5859" aria-hidden="true" tabindex="-1"></a><span class="in">      ),</span></span>
<span id="cb168-5860"><a href="#cb168-5860" aria-hidden="true" tabindex="-1"></a><span class="in">      br(),</span></span>
<span id="cb168-5861"><a href="#cb168-5861" aria-hidden="true" tabindex="-1"></a><span class="in">      div(id = "progress_container", style = "display: none;",</span></span>
<span id="cb168-5862"><a href="#cb168-5862" aria-hidden="true" tabindex="-1"></a><span class="in">          div(class = "progress",</span></span>
<span id="cb168-5863"><a href="#cb168-5863" aria-hidden="true" tabindex="-1"></a><span class="in">              div(class = "progress-bar", role = "progressbar", </span></span>
<span id="cb168-5864"><a href="#cb168-5864" aria-hidden="true" tabindex="-1"></a><span class="in">                  style = "width: 0%;", aria_valuenow = "0", aria_valuemin = "0", aria_valuemax = "100")</span></span>
<span id="cb168-5865"><a href="#cb168-5865" aria-hidden="true" tabindex="-1"></a><span class="in">          )</span></span>
<span id="cb168-5866"><a href="#cb168-5866" aria-hidden="true" tabindex="-1"></a><span class="in">      )</span></span>
<span id="cb168-5867"><a href="#cb168-5867" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb168-5868"><a href="#cb168-5868" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb168-5869"><a href="#cb168-5869" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5870"><a href="#cb168-5870" aria-hidden="true" tabindex="-1"></a><span class="in"># Define the server logic</span></span>
<span id="cb168-5871"><a href="#cb168-5871" aria-hidden="true" tabindex="-1"></a><span class="in">server &lt;- function(input, output, session) {</span></span>
<span id="cb168-5872"><a href="#cb168-5872" aria-hidden="true" tabindex="-1"></a><span class="in">  # Perform prediction when the button is clicked</span></span>
<span id="cb168-5873"><a href="#cb168-5873" aria-hidden="true" tabindex="-1"></a><span class="in">  observeEvent(input$submit_button, {</span></span>
<span id="cb168-5874"><a href="#cb168-5874" aria-hidden="true" tabindex="-1"></a><span class="in">    # Collect user input data</span></span>
<span id="cb168-5875"><a href="#cb168-5875" aria-hidden="true" tabindex="-1"></a><span class="in">    datos_usuario &lt;- data.frame(</span></span>
<span id="cb168-5876"><a href="#cb168-5876" aria-hidden="true" tabindex="-1"></a><span class="in">      Edad = factor(input$input_edad, levels = niveles_edad),</span></span>
<span id="cb168-5877"><a href="#cb168-5877" aria-hidden="true" tabindex="-1"></a><span class="in">      REst = factor(input$input_rest, levels = niveles_rest),</span></span>
<span id="cb168-5878"><a href="#cb168-5878" aria-hidden="true" tabindex="-1"></a><span class="in">      Grado = factor(input$input_grado, levels = niveles_grado),</span></span>
<span id="cb168-5879"><a href="#cb168-5879" aria-hidden="true" tabindex="-1"></a><span class="in">      Fenotipo = factor(input$input_fenotipo, levels = niveles_fenotipo)</span></span>
<span id="cb168-5880"><a href="#cb168-5880" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb168-5881"><a href="#cb168-5881" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5882"><a href="#cb168-5882" aria-hidden="true" tabindex="-1"></a><span class="in">    # Show progress bar</span></span>
<span id="cb168-5883"><a href="#cb168-5883" aria-hidden="true" tabindex="-1"></a><span class="in">    shinyjs::show("progress_container")</span></span>
<span id="cb168-5884"><a href="#cb168-5884" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5885"><a href="#cb168-5885" aria-hidden="true" tabindex="-1"></a><span class="in">    # Update the progress bar</span></span>
<span id="cb168-5886"><a href="#cb168-5886" aria-hidden="true" tabindex="-1"></a><span class="in">    for (i in seq(0, 100, by = 25)) {</span></span>
<span id="cb168-5887"><a href="#cb168-5887" aria-hidden="true" tabindex="-1"></a><span class="in">      shinyjs::runjs(paste0("$('.progress-bar').css('width', '", i, "%').attr('aria-valuenow', '", i, "');"))</span></span>
<span id="cb168-5888"><a href="#cb168-5888" aria-hidden="true" tabindex="-1"></a><span class="in">      Sys.sleep(0.25)  # Shortened to 0.25 seconds to match 1 second total duration</span></span>
<span id="cb168-5889"><a href="#cb168-5889" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb168-5890"><a href="#cb168-5890" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5891"><a href="#cb168-5891" aria-hidden="true" tabindex="-1"></a><span class="in">    # Perform prediction using the loaded model</span></span>
<span id="cb168-5892"><a href="#cb168-5892" aria-hidden="true" tabindex="-1"></a><span class="in">    prediccion &lt;- predict(modelo, newdata = datos_usuario, type = "raw")</span></span>
<span id="cb168-5893"><a href="#cb168-5893" aria-hidden="true" tabindex="-1"></a><span class="in">    probabilidad &lt;- prediccion[2]</span></span>
<span id="cb168-5894"><a href="#cb168-5894" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5895"><a href="#cb168-5895" aria-hidden="true" tabindex="-1"></a><span class="in">    # Display the prediction to the user</span></span>
<span id="cb168-5896"><a href="#cb168-5896" aria-hidden="true" tabindex="-1"></a><span class="in">    output$resultado_prediccion &lt;- renderText({</span></span>
<span id="cb168-5897"><a href="#cb168-5897" aria-hidden="true" tabindex="-1"></a><span class="in">      paste("The probability that the result is 'YES' is:", round(probabilidad, 2))</span></span>
<span id="cb168-5898"><a href="#cb168-5898" aria-hidden="true" tabindex="-1"></a><span class="in">    })</span></span>
<span id="cb168-5899"><a href="#cb168-5899" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb168-5900"><a href="#cb168-5900" aria-hidden="true" tabindex="-1"></a><span class="in">    # Hide the progress bar after completing the prediction</span></span>
<span id="cb168-5901"><a href="#cb168-5901" aria-hidden="true" tabindex="-1"></a><span class="in">    shinyjs::hide("progress_container")</span></span>
<span id="cb168-5902"><a href="#cb168-5902" aria-hidden="true" tabindex="-1"></a><span class="in">    shinyjs::show("resultado_container")</span></span>
<span id="cb168-5903"><a href="#cb168-5903" aria-hidden="true" tabindex="-1"></a><span class="in">  })</span></span>
<span id="cb168-5904"><a href="#cb168-5904" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb168-5905"><a href="#cb168-5905" aria-hidden="true" tabindex="-1"></a><span class="in">  # Display help alert if requested</span></span>
<span id="cb168-5906"><a href="#cb168-5906" aria-hidden="true" tabindex="-1"></a><span class="in">  observeEvent(input$help_button, {</span></span>
<span id="cb168-5907"><a href="#cb168-5907" aria-hidden="true" tabindex="-1"></a><span class="in">    shinyjs::show("help_container")</span></span>
<span id="cb168-5908"><a href="#cb168-5908" aria-hidden="true" tabindex="-1"></a><span class="in">  })</span></span>
<span id="cb168-5909"><a href="#cb168-5909" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb168-5910"><a href="#cb168-5910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5911"><a href="#cb168-5911" aria-hidden="true" tabindex="-1"></a><span class="in"># Run the Shiny app</span></span>
<span id="cb168-5912"><a href="#cb168-5912" aria-hidden="true" tabindex="-1"></a><span class="in">shinyApp(ui, server)</span></span>
<span id="cb168-5913"><a href="#cb168-5913" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-5914"><a href="#cb168-5914" aria-hidden="true" tabindex="-1"></a>To deploy the app we are going to use the rsconnect package. First, we have to set our account information and deploy the app using the following code:</span>
<span id="cb168-5915"><a href="#cb168-5915" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5916"><a href="#cb168-5916" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5917"><a href="#cb168-5917" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,eval=FALSE}</span></span>
<span id="cb168-5918"><a href="#cb168-5918" aria-hidden="true" tabindex="-1"></a><span class="in">#subir la app</span></span>
<span id="cb168-5919"><a href="#cb168-5919" aria-hidden="true" tabindex="-1"></a><span class="in">library(rsconnect)</span></span>
<span id="cb168-5920"><a href="#cb168-5920" aria-hidden="true" tabindex="-1"></a><span class="in">rsconnect::setAccountInfo(name='nombre_de_usuario', token='TU_TOKEN', secret='TU_SECRET')</span></span>
<span id="cb168-5921"><a href="#cb168-5921" aria-hidden="true" tabindex="-1"></a><span class="in">rsconnect::deployApp('ruta_de_la_app')</span></span>
<span id="cb168-5922"><a href="#cb168-5922" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-5923"><a href="#cb168-5923" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5924"><a href="#cb168-5924" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5925"><a href="#cb168-5925" aria-hidden="true" tabindex="-1"></a>&lt;style&gt;</span>
<span id="cb168-5926"><a href="#cb168-5926" aria-hidden="true" tabindex="-1"></a> <span class="fu">.iframe-container</span> {</span>
<span id="cb168-5927"><a href="#cb168-5927" aria-hidden="true" tabindex="-1"></a>            <span class="kw">width</span><span class="ch">:</span> <span class="dv">80</span><span class="dt">%</span><span class="op">;</span></span>
<span id="cb168-5928"><a href="#cb168-5928" aria-hidden="true" tabindex="-1"></a>            <span class="kw">margin</span><span class="ch">:</span> <span class="bu">auto</span><span class="op">;</span></span>
<span id="cb168-5929"><a href="#cb168-5929" aria-hidden="true" tabindex="-1"></a>            <span class="kw">border</span><span class="ch">:</span> <span class="dv">1</span><span class="dt">px</span> <span class="dv">solid</span> <span class="cn">#555</span><span class="op">;</span></span>
<span id="cb168-5930"><a href="#cb168-5930" aria-hidden="true" tabindex="-1"></a>            <span class="kw">border-radius</span><span class="ch">:</span> <span class="dv">8</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb168-5931"><a href="#cb168-5931" aria-hidden="true" tabindex="-1"></a>            <span class="kw">overflow</span><span class="ch">:</span> <span class="dv">hidden</span><span class="op">;</span></span>
<span id="cb168-5932"><a href="#cb168-5932" aria-hidden="true" tabindex="-1"></a>            <span class="kw">box-shadow</span><span class="ch">:</span> <span class="dv">0</span> <span class="dv">4</span><span class="dt">px</span> <span class="dv">8</span><span class="dt">px</span> <span class="fu">rgba(</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0.2</span><span class="fu">)</span><span class="op">;</span></span>
<span id="cb168-5933"><a href="#cb168-5933" aria-hidden="true" tabindex="-1"></a>            <span class="kw">position</span><span class="ch">:</span> <span class="dv">relative</span><span class="op">;</span></span>
<span id="cb168-5934"><a href="#cb168-5934" aria-hidden="true" tabindex="-1"></a>            <span class="kw">background-color</span><span class="ch">:</span> <span class="cn">#3b3b3b</span><span class="op">;</span></span>
<span id="cb168-5935"><a href="#cb168-5935" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb168-5936"><a href="#cb168-5936" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5937"><a href="#cb168-5937" aria-hidden="true" tabindex="-1"></a>        <span class="fu">.iframe-tab</span> {</span>
<span id="cb168-5938"><a href="#cb168-5938" aria-hidden="true" tabindex="-1"></a>            <span class="kw">display</span><span class="ch">:</span> <span class="dv">flex</span><span class="op">;</span></span>
<span id="cb168-5939"><a href="#cb168-5939" aria-hidden="true" tabindex="-1"></a>            <span class="kw">justify-content</span><span class="ch">:</span> <span class="dv">flex-end</span><span class="op">;</span></span>
<span id="cb168-5940"><a href="#cb168-5940" aria-hidden="true" tabindex="-1"></a>            <span class="kw">align-items</span><span class="ch">:</span> <span class="dv">center</span><span class="op">;</span></span>
<span id="cb168-5941"><a href="#cb168-5941" aria-hidden="true" tabindex="-1"></a>            <span class="kw">padding</span><span class="ch">:</span> <span class="dv">8</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb168-5942"><a href="#cb168-5942" aria-hidden="true" tabindex="-1"></a>            <span class="kw">background-color</span><span class="ch">:</span> <span class="cn">#4a4a4a</span><span class="op">;</span></span>
<span id="cb168-5943"><a href="#cb168-5943" aria-hidden="true" tabindex="-1"></a>            <span class="kw">border-bottom</span><span class="ch">:</span> <span class="dv">1</span><span class="dt">px</span> <span class="dv">solid</span> <span class="cn">#555</span><span class="op">;</span></span>
<span id="cb168-5944"><a href="#cb168-5944" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb168-5945"><a href="#cb168-5945" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5946"><a href="#cb168-5946" aria-hidden="true" tabindex="-1"></a>        <span class="fu">.iframe-tab-buttons</span> {</span>
<span id="cb168-5947"><a href="#cb168-5947" aria-hidden="true" tabindex="-1"></a>            <span class="kw">display</span><span class="ch">:</span> <span class="dv">flex</span><span class="op">;</span></span>
<span id="cb168-5948"><a href="#cb168-5948" aria-hidden="true" tabindex="-1"></a>            <span class="kw">align-items</span><span class="ch">:</span> <span class="dv">center</span><span class="op">;</span></span>
<span id="cb168-5949"><a href="#cb168-5949" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb168-5950"><a href="#cb168-5950" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5951"><a href="#cb168-5951" aria-hidden="true" tabindex="-1"></a>        <span class="fu">.iframe-tab-buttons</span> button {</span>
<span id="cb168-5952"><a href="#cb168-5952" aria-hidden="true" tabindex="-1"></a>            <span class="kw">width</span><span class="ch">:</span> <span class="dv">20</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb168-5953"><a href="#cb168-5953" aria-hidden="true" tabindex="-1"></a>            <span class="kw">height</span><span class="ch">:</span> <span class="dv">20</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb168-5954"><a href="#cb168-5954" aria-hidden="true" tabindex="-1"></a>            <span class="kw">margin-left</span><span class="ch">:</span> <span class="dv">4</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb168-5955"><a href="#cb168-5955" aria-hidden="true" tabindex="-1"></a>            <span class="kw">background-color</span><span class="ch">:</span> <span class="cn">#666</span><span class="op">;</span></span>
<span id="cb168-5956"><a href="#cb168-5956" aria-hidden="true" tabindex="-1"></a>            <span class="kw">border</span><span class="ch">:</span> <span class="dv">none</span><span class="op">;</span></span>
<span id="cb168-5957"><a href="#cb168-5957" aria-hidden="true" tabindex="-1"></a>            <span class="kw">border-radius</span><span class="ch">:</span> <span class="dv">2</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb168-5958"><a href="#cb168-5958" aria-hidden="true" tabindex="-1"></a>            <span class="kw">display</span><span class="ch">:</span> <span class="dv">flex</span><span class="op">;</span></span>
<span id="cb168-5959"><a href="#cb168-5959" aria-hidden="true" tabindex="-1"></a>            <span class="kw">justify-content</span><span class="ch">:</span> <span class="dv">center</span><span class="op">;</span></span>
<span id="cb168-5960"><a href="#cb168-5960" aria-hidden="true" tabindex="-1"></a>            <span class="kw">align-items</span><span class="ch">:</span> <span class="dv">center</span><span class="op">;</span></span>
<span id="cb168-5961"><a href="#cb168-5961" aria-hidden="true" tabindex="-1"></a>            <span class="kw">cursor</span><span class="ch">:</span> <span class="dv">not-allowed</span><span class="op">;</span> <span class="co">/* Indica que no son funcionales */</span></span>
<span id="cb168-5962"><a href="#cb168-5962" aria-hidden="true" tabindex="-1"></a>            <span class="kw">position</span><span class="ch">:</span> <span class="dv">relative</span><span class="op">;</span></span>
<span id="cb168-5963"><a href="#cb168-5963" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb168-5964"><a href="#cb168-5964" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5965"><a href="#cb168-5965" aria-hidden="true" tabindex="-1"></a>        <span class="fu">.iframe-tab-buttons</span> button span {</span>
<span id="cb168-5966"><a href="#cb168-5966" aria-hidden="true" tabindex="-1"></a>            <span class="kw">display</span><span class="ch">:</span> <span class="dv">block</span><span class="op">;</span></span>
<span id="cb168-5967"><a href="#cb168-5967" aria-hidden="true" tabindex="-1"></a>            <span class="kw">background-color</span><span class="ch">:</span> <span class="cn">#ccc</span><span class="op">;</span></span>
<span id="cb168-5968"><a href="#cb168-5968" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb168-5969"><a href="#cb168-5969" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5970"><a href="#cb168-5970" aria-hidden="true" tabindex="-1"></a>        <span class="fu">.iframe-tab-buttons</span> button<span class="fu">.minimize</span> span {</span>
<span id="cb168-5971"><a href="#cb168-5971" aria-hidden="true" tabindex="-1"></a>            <span class="kw">width</span><span class="ch">:</span> <span class="dv">12</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb168-5972"><a href="#cb168-5972" aria-hidden="true" tabindex="-1"></a>            <span class="kw">height</span><span class="ch">:</span> <span class="dv">2</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb168-5973"><a href="#cb168-5973" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb168-5974"><a href="#cb168-5974" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5975"><a href="#cb168-5975" aria-hidden="true" tabindex="-1"></a>        <span class="fu">.iframe-tab-buttons</span> button<span class="fu">.maximize</span> span {</span>
<span id="cb168-5976"><a href="#cb168-5976" aria-hidden="true" tabindex="-1"></a>            <span class="kw">width</span><span class="ch">:</span> <span class="dv">10</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb168-5977"><a href="#cb168-5977" aria-hidden="true" tabindex="-1"></a>            <span class="kw">height</span><span class="ch">:</span> <span class="dv">10</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb168-5978"><a href="#cb168-5978" aria-hidden="true" tabindex="-1"></a>            <span class="kw">border</span><span class="ch">:</span> <span class="dv">2</span><span class="dt">px</span> <span class="dv">solid</span> <span class="cn">#ccc</span><span class="op">;</span></span>
<span id="cb168-5979"><a href="#cb168-5979" aria-hidden="true" tabindex="-1"></a>            <span class="kw">box-sizing</span><span class="ch">:</span> <span class="dv">border-box</span><span class="op">;</span></span>
<span id="cb168-5980"><a href="#cb168-5980" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb168-5981"><a href="#cb168-5981" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5982"><a href="#cb168-5982" aria-hidden="true" tabindex="-1"></a>        <span class="fu">.iframe-tab-buttons</span> button<span class="fu">.close</span> span {</span>
<span id="cb168-5983"><a href="#cb168-5983" aria-hidden="true" tabindex="-1"></a>            <span class="kw">width</span><span class="ch">:</span> <span class="dv">12</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb168-5984"><a href="#cb168-5984" aria-hidden="true" tabindex="-1"></a>            <span class="kw">height</span><span class="ch">:</span> <span class="dv">12</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb168-5985"><a href="#cb168-5985" aria-hidden="true" tabindex="-1"></a>            <span class="kw">position</span><span class="ch">:</span> <span class="dv">relative</span><span class="op">;</span></span>
<span id="cb168-5986"><a href="#cb168-5986" aria-hidden="true" tabindex="-1"></a>            <span class="kw">display</span><span class="ch">:</span> <span class="dv">flex</span><span class="op">;</span></span>
<span id="cb168-5987"><a href="#cb168-5987" aria-hidden="true" tabindex="-1"></a>            <span class="kw">justify-content</span><span class="ch">:</span> <span class="dv">center</span><span class="op">;</span></span>
<span id="cb168-5988"><a href="#cb168-5988" aria-hidden="true" tabindex="-1"></a>            <span class="kw">align-items</span><span class="ch">:</span> <span class="dv">center</span><span class="op">;</span></span>
<span id="cb168-5989"><a href="#cb168-5989" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb168-5990"><a href="#cb168-5990" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5991"><a href="#cb168-5991" aria-hidden="true" tabindex="-1"></a>        <span class="fu">.iframe-tab-buttons</span> button<span class="fu">.close</span> span<span class="in">:before</span><span class="op">,</span></span>
<span id="cb168-5992"><a href="#cb168-5992" aria-hidden="true" tabindex="-1"></a>        <span class="fu">.iframe-tab-buttons</span> button<span class="fu">.close</span> span<span class="in">:after</span> {</span>
<span id="cb168-5993"><a href="#cb168-5993" aria-hidden="true" tabindex="-1"></a>            <span class="kw">content</span><span class="ch">:</span> <span class="st">''</span><span class="op">;</span></span>
<span id="cb168-5994"><a href="#cb168-5994" aria-hidden="true" tabindex="-1"></a>            <span class="kw">position</span><span class="ch">:</span> <span class="dv">absolute</span><span class="op">;</span></span>
<span id="cb168-5995"><a href="#cb168-5995" aria-hidden="true" tabindex="-1"></a>            <span class="kw">width</span><span class="ch">:</span> <span class="dv">6</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb168-5996"><a href="#cb168-5996" aria-hidden="true" tabindex="-1"></a>            <span class="kw">height</span><span class="ch">:</span> <span class="dv">2</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb168-5997"><a href="#cb168-5997" aria-hidden="true" tabindex="-1"></a>            <span class="kw">background-color</span><span class="ch">:</span> <span class="cn">#ccc</span><span class="op">;</span></span>
<span id="cb168-5998"><a href="#cb168-5998" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb168-5999"><a href="#cb168-5999" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-6000"><a href="#cb168-6000" aria-hidden="true" tabindex="-1"></a>        <span class="fu">.iframe-tab-buttons</span> button<span class="fu">.close</span> span<span class="in">:before</span> {</span>
<span id="cb168-6001"><a href="#cb168-6001" aria-hidden="true" tabindex="-1"></a>            <span class="kw">transform</span><span class="ch">:</span> <span class="fu">rotate(</span><span class="dv">45</span><span class="dt">deg</span><span class="fu">)</span><span class="op">;</span></span>
<span id="cb168-6002"><a href="#cb168-6002" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb168-6003"><a href="#cb168-6003" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-6004"><a href="#cb168-6004" aria-hidden="true" tabindex="-1"></a>        <span class="fu">.iframe-tab-buttons</span> button<span class="fu">.close</span> span<span class="in">:after</span> {</span>
<span id="cb168-6005"><a href="#cb168-6005" aria-hidden="true" tabindex="-1"></a>            <span class="kw">transform</span><span class="ch">:</span> <span class="fu">rotate(</span><span class="dv">-45</span><span class="dt">deg</span><span class="fu">)</span><span class="op">;</span></span>
<span id="cb168-6006"><a href="#cb168-6006" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb168-6007"><a href="#cb168-6007" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-6008"><a href="#cb168-6008" aria-hidden="true" tabindex="-1"></a>        <span class="fu">.iframe-content</span> {</span>
<span id="cb168-6009"><a href="#cb168-6009" aria-hidden="true" tabindex="-1"></a>            <span class="kw">width</span><span class="ch">:</span> <span class="dv">100</span><span class="dt">%</span><span class="op">;</span></span>
<span id="cb168-6010"><a href="#cb168-6010" aria-hidden="true" tabindex="-1"></a>            <span class="kw">height</span><span class="ch">:</span> <span class="dv">500</span><span class="dt">px</span><span class="op">;</span> <span class="co">/* Ajusta la altura según tus necesidades */</span></span>
<span id="cb168-6011"><a href="#cb168-6011" aria-hidden="true" tabindex="-1"></a>            <span class="kw">border</span><span class="ch">:</span> <span class="dv">none</span><span class="op">;</span></span>
<span id="cb168-6012"><a href="#cb168-6012" aria-hidden="true" tabindex="-1"></a>            <span class="kw">display</span><span class="ch">:</span> <span class="dv">block</span><span class="op">;</span></span>
<span id="cb168-6013"><a href="#cb168-6013" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb168-6014"><a href="#cb168-6014" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb168-6015"><a href="#cb168-6015" aria-hidden="true" tabindex="-1"></a>&lt;/style&gt;</span>
<span id="cb168-6016"><a href="#cb168-6016" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-6017"><a href="#cb168-6017" aria-hidden="true" tabindex="-1"></a><span class="in">```{=html}</span></span>
<span id="cb168-6018"><a href="#cb168-6018" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;div class="iframe-container"&gt;</span></span>
<span id="cb168-6019"><a href="#cb168-6019" aria-hidden="true" tabindex="-1"></a><span class="in">        &lt;div class="iframe-tab"&gt;</span></span>
<span id="cb168-6020"><a href="#cb168-6020" aria-hidden="true" tabindex="-1"></a><span class="in">            &lt;div class="iframe-tab-buttons"&gt;</span></span>
<span id="cb168-6021"><a href="#cb168-6021" aria-hidden="true" tabindex="-1"></a><span class="in">                &lt;button class="minimize" title="Minimizar"&gt;&lt;span&gt;&lt;/span&gt;&lt;/button&gt;</span></span>
<span id="cb168-6022"><a href="#cb168-6022" aria-hidden="true" tabindex="-1"></a><span class="in">                &lt;button class="maximize" title="Maximizar"&gt;&lt;span&gt;&lt;/span&gt;&lt;/button&gt;</span></span>
<span id="cb168-6023"><a href="#cb168-6023" aria-hidden="true" tabindex="-1"></a><span class="in">                &lt;button class="close" title="Cerrar"&gt;&lt;span&gt;&lt;/span&gt;&lt;/button&gt;</span></span>
<span id="cb168-6024"><a href="#cb168-6024" aria-hidden="true" tabindex="-1"></a><span class="in">            &lt;/div&gt;</span></span>
<span id="cb168-6025"><a href="#cb168-6025" aria-hidden="true" tabindex="-1"></a><span class="in">        &lt;/div&gt;</span></span>
<span id="cb168-6026"><a href="#cb168-6026" aria-hidden="true" tabindex="-1"></a><span class="in">        &lt;iframe src="https://g9bjvd-alex0silva.shinyapps.io/cancerapp/" class="iframe-content"&gt;&lt;/iframe&gt;</span></span>
<span id="cb168-6027"><a href="#cb168-6027" aria-hidden="true" tabindex="-1"></a><span class="in">    &lt;/div&gt;</span></span>
<span id="cb168-6028"><a href="#cb168-6028" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-6029"><a href="#cb168-6029" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-6030"><a href="#cb168-6030" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-6031"><a href="#cb168-6031" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-6032"><a href="#cb168-6032" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-6033"><a href="#cb168-6033" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-6034"><a href="#cb168-6034" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-6035"><a href="#cb168-6035" aria-hidden="true" tabindex="-1"></a><span class="fu"># Conclusions {#conclusions}</span></span>
<span id="cb168-6036"><a href="#cb168-6036" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-6037"><a href="#cb168-6037" aria-hidden="true" tabindex="-1"></a>In this project, we have compared the performance of many machine learning algorithms for predicting methastasis in breast cancer. We have adapted the validation process and the hyperparameters selection to our computational resources. </span>
<span id="cb168-6038"><a href="#cb168-6038" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-6039"><a href="#cb168-6039" aria-hidden="true" tabindex="-1"></a>&lt;br&gt;</span>
<span id="cb168-6040"><a href="#cb168-6040" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-6041"><a href="#cb168-6041" aria-hidden="true" tabindex="-1"></a>In the variable selection process, we have found that the most performant technique is the wrapper method, but it is computationally expensive. The filter method is less computationally expensive, but it does not have in concern the interaction between variables. Embedded methods are a good compromise between the two previous methods but are not as performant as the wrapper method.</span>
<span id="cb168-6042"><a href="#cb168-6042" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-6043"><a href="#cb168-6043" aria-hidden="true" tabindex="-1"></a>&lt;br&gt;</span>
<span id="cb168-6044"><a href="#cb168-6044" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-6045"><a href="#cb168-6045" aria-hidden="true" tabindex="-1"></a>The final model uses the Naive Bayes algorithm. The model achieved an AUC of 0.75 in the cross-validation process. The model is deployed in a Shiny app that allows users to predict the probability of methastasis in breast cancer based on four variables: age, hormone receptor status, histological grade, and tumor phenotype.</span>
<span id="cb168-6046"><a href="#cb168-6046" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-6047"><a href="#cb168-6047" aria-hidden="true" tabindex="-1"></a>&lt;br&gt;</span>
<span id="cb168-6048"><a href="#cb168-6048" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-6049"><a href="#cb168-6049" aria-hidden="true" tabindex="-1"></a>The next step is to carry out a external validation of the model. This process will allow us to evaluate the model's performance in new data.</span>
<span id="cb168-6050"><a href="#cb168-6050" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-6051"><a href="#cb168-6051" aria-hidden="true" tabindex="-1"></a><span class="fu"># References {#references}</span></span>
<span id="cb168-6052"><a href="#cb168-6052" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-6053"><a href="#cb168-6053" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Renan Gomes do Nascimento, Kaléu Mormino Otoni. (2020).Histological and molecular classification of breast cancer: what do we know?</span>
<span id="cb168-6054"><a href="#cb168-6054" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-6055"><a href="#cb168-6055" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Predict breast cancer (2024). </span>
<span id="cb168-6056"><a href="#cb168-6056" aria-hidden="true" tabindex="-1"></a>URL: https://breast.predict.cam/tool</span>
<span id="cb168-6057"><a href="#cb168-6057" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-6058"><a href="#cb168-6058" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Gepac. Etapas y grado histológico(2024)</span>
<span id="cb168-6059"><a href="#cb168-6059" aria-hidden="true" tabindex="-1"></a>URL:http://ascama.gepac.es/informacion-medica/etapas-y-grado-histologico/</span>
<span id="cb168-6060"><a href="#cb168-6060" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-6061"><a href="#cb168-6061" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Jackson, E. B., Gondara, L., Speers, C., Diocee, R., Nichol, A. M., Lohrisch, C., &amp; Gelmon, K. A. (2023). Does age affect outcome with breast cancer?</span>
<span id="cb168-6062"><a href="#cb168-6062" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-6063"><a href="#cb168-6063" aria-hidden="true" tabindex="-1"></a><span class="in">```{=html}</span></span>
<span id="cb168-6064"><a href="#cb168-6064" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;div id="scrollToTopContainer" style="position: fixed; bottom: 20px; right: 20px; display: none;"&gt;</span></span>
<span id="cb168-6065"><a href="#cb168-6065" aria-hidden="true" tabindex="-1"></a><span class="in">  &lt;button onclick="goToTop()" id="btnScrollToTop" type="button" class="btn btn-primary btn-lg"&gt;</span></span>
<span id="cb168-6066"><a href="#cb168-6066" aria-hidden="true" tabindex="-1"></a><span class="in">    ↑</span></span>
<span id="cb168-6067"><a href="#cb168-6067" aria-hidden="true" tabindex="-1"></a><span class="in">  &lt;/button&gt;</span></span>
<span id="cb168-6068"><a href="#cb168-6068" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;/div&gt;</span></span>
<span id="cb168-6069"><a href="#cb168-6069" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb168-6070"><a href="#cb168-6070" aria-hidden="true" tabindex="-1"></a>importante quitar cellnoseq de los statistic analisis</span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>